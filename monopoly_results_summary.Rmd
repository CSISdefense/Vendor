---
title: "Monopoly Results Summary"
date: "Wednesday, February 8, 2017"
output: 
  html_document: 
    keep_md: yes
    toc: yes

---

#Setup
```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(arm)
library(R2WinBUGS)
library(knitr)
library(foreign)
library(stargazer)
source("DIIGstat.r")

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40


```


Contracts are classified using a mix of numerical and categorical variables. While the changes in numerical variables are easy to grasp and summarize, a contract may have one line item that is competed and another that is not. As is detailed in the exploration on R&D, we are only considering information available prior to contract start. The percentage of contract obligations that were competed is a valuable benchmark, but is highly influenced by factors that occured after contract start..

## Contract Terminations

Contract terminations and the number of change orders can be calculated for the entire sample.  Contract termination is determined using the *Reason for Modification* field in FPDS.  A contract is considered to be terminated if it has at least one modification with the following values:

* "Terminate for Default (complete or partial)"
* "Terminate for Convenience (complete or partial)"
* "Terminate for Cause"
* "Legal Contract Cancellation"

These four catetegories and the "Close Out" category are used to mark a contract as closed.  Many contracts in FPDS and in the sample are never marked closed.  


##Prepare Data
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from   FPDS.


###Data Transformations and Summary



```{r ReadInData, echo = TRUE}
#   load(file="Data/defense_contract_CSIScontractID_detail.Rdata")
# # head(def)
# def<-transform_contract(def)
# 
# 
# 
# save(file="Data/transformed_def.Rdata", def)
 load(file="Data/transformed_def.Rdata")

```



## Dependent Variables

NA_stats(def,"b_Term")
* b_Term is a binary variable that has a value of 1 for any contracts that have experienced a partial or complete termination, 0 otherwise. (`r summary(def$b_Term);
sum(def$Action.Obligation[def$b_Term==1],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)`
* b_CBre is a binary variable that has a value of 1 for any contracts that have experienced a partial or complete termination, 0 otherwise. (`r summary(def$b_CBre);
sum(def$Action.Obligation[def$b_CBre==1],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
NA_stats(def,"b_CBre")`)

## Independent Variables

### Study Variables

* b_Comp is a binary variable based on competition. It has a value of 0 for uncompeted contracts and a value of 1 for competition, regardless of number of offers. `r  summary(def$Comp);
NA_stats(def,"Comp") `
* n_Comp is a binary variable based on competition. It has a value of 0 for uncompeted contracts and a value of 1 for competition, regardless of number of offers. `r  summary(def$EffComp);
NA_stats(def,"EffComp")
sum(def$Action.Obligation[def$EffComp=="No Comp."],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
sum(def$Action.Obligation[def$EffComp=="1 Offer"],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
sum(def$Action.Obligation[def$EffComp=="2+ Offers"],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)`
)

* c_HHI_lag1 is a numeric variable based on competition and number of offers. It has a value of 0 for uncompeted contracts and a value of 1 for single-offer competition, and a value of 2 for multi-offer competition. `r summary(def$c_HHI_lag1);
summary(def$cl_HHI_lag1);
centered_description(def$HHI_lag1,"days")
centered_log_description(def$l_HHI_lag1,"days")

NA_stats(def,"c_HHI_lag1")

### Initial Contract Scope
* cl_Ceil is the natural log of the initial contract cost ceiling, in then-year dollars. `r centered_log_description(def$l_Ceil,"dollars");
NA_stats(def,"l_Ceil")`
* cl_Days is the natural log of the initial maximum duration of the contract, in days. The variable is centered, by subtracting its mean (`r centered_log_description(def$l_Days,"days");
NA_stats(def,"l_Days")` 

### Contract Vehicle
* SIDV, MIDV, and OIDV are dummy variables based on the contract vehicle. They correspond to Single-Award IDVs, Multi-Award IDVs, and Other IDVs, respectively, having a value of 1 when the task order has that vehicle type, and having a 0 other. The remaining types, definitive contracts and purchase orders, are intentionally left out. (`r 
summary(def$Veh);
summary(def$SIDV);
summary(def$MIDV);
summary(def$OIDV);
nrow(def[def$Veh =="SINGLE AWARD IDC",])/nrow(def)
nrow(def[def$Veh =="MULTIPLE AWARD IDC",])/nrow(def)
nrow(def[def$Veh =="FSS/GWAC",])/nrow(def)
nrow(def[def$Veh =="BPA/BOA",])/nrow(def)
NA_stats(def,"Veh")`
* n_Fixed is a numeric variable based on contract pricing. It has a value of 0 for cost-based, 0.5 or "combination or other", 1 for any fixed price (excluding fixed-price level of effort which is classified as cost-based). (`r summary(def$n_Fixed);
NA_stats(def,"n_Fixed")
sum(def$Action.Obligation[def$n_Fixed==0],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
sum(def$Action.Obligation[def$n_Fixed==0.5],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
sum(def$Action.Obligation[def$n_Fixed==1],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
nrow(def[def$n_Fixed==0,])/nrow(def)
nrow(def[def$n_Fixed==0.5,])/nrow(def)
nrow(def[def$n_Fixed==1,])/nrow(def)

`)
* n_Incent is a numeric variable based on fee type. Ig has a value. 1 for incentive fee or cost sharing, 0.5 or "combination or other", 0 for all remaining types. (`r summary(def$n_Incent);
summary(def$Fee)
NA_stats(def,"n_Incent")`)
* b_UCA is a binary variable with a value of 1 for contracts/task orders that begin as letter contracts or undefinitized contract awards (UCA) and a value of 0 otherwise. `r summary(def$b_UCA);
sum(def$Action.Obligation[def$b_UCA==1],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
length(def[def$b_UCA==1,])/sum(def$Action.Obligation,na.rm=TRUE)
NA_stats(def,"b_UCA")`
* b_Intl is a binary variable with a value of 1 for contracts/task orders with any transactions performed internationally and a value of 0 otherwise. `r summary(def$b_Intl);
sum(def$Action.Obligation[def$b_Intl==1],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
NA_stats(def,"b_Intl")`
* NAICS is a factor reporting the top North American Industrial Classification Code of each contract. 
`r summary(def$NAICS);
NA_stats(def,"NAICS")`
* Agency is a factor reporting the top Contracting Agency of each contract. 
`r summary(def$Agency);
NA_stats(def,"Agency")`
* Office is a factor reporting the top Contracting office of each contract. 
`r summary(def$Office);
NA_stats(def,"Office")`

### NAICS examination
```{r Summary}

# Add NAICS title

def$NAICS_Code<-create_naics2(def$NAICS)

 def<-csis360::read_and_join(def,
                        lookup_file = "Lookup_NAICS_code.csv",
                        path="",
                        dir="Lookup\\",
                        by="NAICS_Code",
                        skip_check_var="NAICS_DESCRIPTION"
               )

def$NAICS_label<-paste(def$NAICS_Code,
                             def$NAICS_DESCRIPTION)

def$NAICS_label[
  def$NAICS_label==
    "56 Administrative and Support and Waste Management and Remediation Services"
  ]<-"56 Admin./Support/Waste Management and Remediation"
def$NAICS_label[def$NAICS_label==
                                    "NA NA"]<-"Unlabeled"

def$NAICS_label<-factor(def$NAICS_label)
order<-  rev(levels(def$NAICS_label))


NAICS2digit<-ggplot(def,
       aes(x=NAICS_label))+
  geom_bar()+coord_flip()+
  scale_y_continuous(label=scales::comma)+scale_x_discrete(limits=order)+
  labs(x="2-Digit NAICS Code",y="Number of Contracts and Task Orders in Unfiltered Dataset")
ggsave(NAICS2digit,file="NAICS2digitCount.png",width=10,height=6,dpi=600)

NAICS_summary<-def %>% group_by(NAICS,StartFY,HHI_lag1) %>%
  dplyr::summarise(annual_action_obligation=sum(Action.Obligation),
                   annual_count=length(StartFY)) 

top_NAICS <- NAICS_summary %>% group_by(NAICS) %>% 
  dplyr::summarise(naics_action_obligation=sum(annual_action_obligation),
                   naics_count=sum(annual_count)) 
top_NAICS$naics_dollar_rank<-rank(-top_NAICS$naics_action_obligation)
top_NAICS$naics_count_rank<-rank(-top_NAICS$naics_count)


NAICS_summary<-left_join(NAICS_summary,top_NAICS, by="NAICS")

colnames(NAICS_summary)[colnames(NAICS_summary)=="NAICS"]<-"principalnaicscode"

NAICS_summary$principalnaicscode<-as.character(NAICS_summary$principalnaicscode)
NAICS_summary<-as.data.frame(NAICS_summary)
NAICS_summary<-csis360::read_and_join(NAICS_summary,
                        lookup_file = "Lookup_PrincipalNAICScode.csv",
                        path="",
                        dir="Lookup\\",
                        by="principalnaicscode",
                        skip_check_var=c("principalnaicscodeText",
"NAICS_shorthand")
               )

# https://stackoverflow.com/questions/37174316/how-to-fit-long-text-into-ggplot2-facet-titles



# Helper function for string wrapping. 
# Default 20 character target width.
swr <- function(string, nwrap=20) {
  paste(strwrap(string, width=nwrap), collapse="\n")
}
swr <- Vectorize(swr)
summary(NAICS_summary$NAICS_shorthand)

# View(NAICS_summary)
NAICS_summary$NAICS_shorthand<-swr(NAICS_summary$NAICS_shorthand,nwrap = 25)
NAICS_summary$FY<-NAICS_summary$StartFY-1
NAICStop<-ggplot(subset(NAICS_summary,naics_dollar_rank<=4 |
                          naics_count_rank<=4),
       aes(x=FY,y=HHI_lag1))+#color=NAICS_Code
  geom_line()+
  scale_y_continuous(label=scales::comma)+ 
  scale_x_continuous(breaks=c(2006,2009,2011,2014))+
  labs(x="Fiscal Year",y="Herfindahl-Herschman Index")+ 
  geom_hline(yintercept=c(1500,2500),linetype="dotted")

NAICStop_paper<-NAICStop+ facet_wrap(~NAICS_shorthand,ncol=2)
NAICStop_paper
ggsave(NAICStop_paper,file="NAICStop.png",width=4,height=8,dpi=600)

NAICStop_pp<-NAICStop+ facet_wrap(~NAICS_shorthand,ncol=4)
NAICStop_pp
ggsave(NAICStop_pp,file="NAICStop_pp.png",width=10.5,height=5.5,dpi=600)

summary(NAICS_summary$naics_count_rank)



```

### Variable examination
```{r VarGraph}


HH1plot<-freq_continuous_plot(def,"HHI_lag1",bins=50)
HH1plot<-HH1plot+geom_vline(xintercept=c(1500,2500))+labs(x="Annual Herfindahl-Hirschman Index (HHI) for NAICS-6 Sector",y="Contract or Task Order Count")
ggsave(HH1plot,file="HH1freq.png",width=5.5,height=5.5,dpi=600)

sum(def$Action.Obligation[def$EffComp=="No Comp."],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
sum(def$Action.Obligation[def$EffComp=="1 Offer"],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
sum(def$Action.Obligation[def$EffComp=="2+ Offers"],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
nrow(def[def$EffComp=="No Comp.",])/nrow(def)

sum(def$Action.Obligation[is.na(def$EffComp)],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)


# Effplot<-freq_discrete_plot(subset(def,"EffComp"))
# Effplot<-Effplot+labs(x="Effective Competition",y="Contract or Task Order Count")

# ggsave(Effplot,file="EffFreq.png",width=5.5,height=5.5,dpi=600)

```

### Computational Sample Creation
```{r Sample}
 load(file="data//def_sample.Rdata")
# save(smp,smp1m,file="def_sample.Rdata")



# complete<-!is.na(def$b_Term)&
#   !is.na(def$b_CBre)&
#   !is.na(def$n_Comp)&
#   !is.na(def$l_Ceil)&
#   !is.na(def$l_Days)&
#   !is.na(def$Veh) &
#   !is.na(def$n_Fixed)&
#   !is.na(def$b_Intl)&
#   !is.na(def$b_UCA)&
#   !is.na(def$NAICS)&
#   !is.na(def$NAICS2)&
#   !is.na(def$cl_HHI_lag1)
# 
# smp<-def[complete,]
# #8818392  to 8818392
# nrow(def[!complete,])/nrow(def)
# sum(def[!complete,]$Action.Obligation,na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
# 
# smp1m<-smp[sample(nrow(smp),1000000),]
# smp<-smp[sample(nrow(smp),250000),]
# save(file="def_sample.Rdata",smp,smp1m)
write.foreign(df=smp,
              datafile="Data//def_sample250k.dat",
              codefile="Data//def_sample250k_code.do",
              package = "Stata")
write.foreign(df=smp1m,
              datafile="Data//def_sample1m.dat",
              codefile="Data//def_sample1m_code.do",
              package = "Stata")

# levels(smp$Intl)<- list("Just U.S."=c("Just U.S."), 
#                                 "Any Intl."=c("Any International"))
# levels(smp1m$Intl)<- list("Just U.S."=c("Just U.S."), 
#                                 "Any Intl."=c("Any International"))


```
# Models

## Consolidation and Termination
```{r Term-Cons}
load("data//Term_Cons.RData")


Term_Cons_05A <- glm(data=smp,
                       b_Term ~cl_HHI_lag1 +
                         cl_Ceil + cl_Days+
                         Veh+
                         # c_HHI_lag1:cl_Ceil  + cl_Ceil:cl_Days  +# c_HHI_lag1:cl_Days +
                         n_Fixed + b_UCA +
                         # b_Intl +
                         # Veh:cl_Days
                         # Veh:c_HHI_lag1+
                         b_UCA:c_HHI_lag1
                         # (1 | NAICS2)
                       , family=binomial(link="logit"))
display(Term_Cons_05A)
glmer_examine(Term_Cons_05A)

display(Term_Cons_08A)
glmer_examine(Term_Cons_08A)

display(Term_Cons_08A2)
glmer_examine(Term_Cons_08A2)


# Term_Cons_08A3 <- glmer(data=smp1m,
#                         b_Term ~c_HHI_lag1 +
#                           cl_Ceil + cl_Days+
#                           Veh+
#                           # c_HHI_lag1:cl_Ceil  + cl_Ceil:cl_Days  +
#                           # c_HHI_lag1:cl_Days +
#                           n_Fixed + b_UCA +
#                           # b_Intl +
#                           # Veh:cl_Days
#                           Veh:c_HHI_lag1+
#                           b_UCA:c_HHI_lag1 +
#                           (1 | NAICS2)
#                         , family=binomial(link="logit"))
display(Term_Cons_08A3)
glmer_examine(Term_Cons_08A3)


# Term_Cons_08B <- glmer(data=smp1m,
#                        b_Term ~cl_HHI_lag1 +
#                          cl_Ceil + cl_Days+
#                          Veh+
#                          c_HHI_lag1:cl_Ceil  + cl_Ceil:cl_Days  +# c_HHI_lag1:cl_Days +
#                          n_Fixed + b_UCA +
#                          b_Intl +
#                          Veh:cl_Days+
#                          Veh:c_HHI_lag1+
#                          b_UCA:c_HHI_lag1 +
#                          (1 | NAICS2)
#                        , family=binomial(link="logit"))
display(Term_Cons_08B)
glmer_examine(Term_Cons_08B)

# Term_Cons_08B2 <- glmer(data=smp1m,
#                        b_Term ~cl_HHI_lag1 +
#                          cl_Ceil + cl_Days+
#                          Veh+
#                          c_HHI_lag1:cl_Ceil  + 
#                          # cl_Ceil:cl_Days  +# c_HHI_lag1:cl_Days +
#                          n_Fixed + b_UCA +
#                          b_Intl +
#                          Veh:cl_Days+
#                          Veh:c_HHI_lag1+
#                          b_UCA:c_HHI_lag1 +
#                          (1 | NAICS2)
#                        , family=binomial(link="logit"))
# Missing
# display(Term_Cons_08B2)
# glmer_examine(Term_Cons_08B2)


Term_Cons_08C <- glm(data=smp1m,
                       b_Term ~cl_HHI_lag1 + 
                         cl_Ceil + cl_Days+ 
                         Veh+
                         c_HHI_lag1:cl_Ceil  +
                         cl_Ceil:cl_Days  +
                         c_HHI_lag1:cl_Days +
                         n_Fixed + b_UCA +
                         b_Intl +
                         Veh:cl_Days+
                         Veh:c_HHI_lag1+
                         b_UCA:c_HHI_lag1 +
                         NAICS2
                       , family=binomial(link="logit"))
display(Term_Cons_08C)
glmer_examine(Term_Cons_08C)

# save(file="Term_Cons.RData",Term_Cons_08A,Term_Cons_08A2,Term_Cons_08A3,
#      Term_Cons_08B,Term_Cons_08B2,Term_Cons_08C)

# Term_Cons_08D <- glmer(data=smp1m,
#                        b_Term ~cl_HHI_lag1 + 
#                          cl_Ceil + cl_Days+ 
#                          Veh+
#                          c_HHI_lag1:cl_Ceil  +
#                          # cl_Ceil:cl_Days  +
#                          # c_HHI_lag1:cl_Days +
#                          n_Fixed + b_UCA +
#                          b_Intl +
#                          Veh:cl_Days+
#                          Veh:c_HHI_lag1+
#                          b_UCA:c_HHI_lag1 +
#                          (1 | NAICS2) + (1 | NAICS)
#                        , family=binomial(link="logit"))
display(Term_Cons_08D)
glmer_examine(Term_Cons_08D)

# save(file="Term_Cons.RData",Term_Cons_08A,Term_Cons_08A2,Term_Cons_08A3,Term_Cons_08B,Term_Cons_08B2,Term_Cons_08C)
summary_residual_compare(CBre_Cons_05A,CBre_Cons_05A2,Term_Cons_08A3,Term_Cons_08B)
summary_residual_compare(CBre_Cons_05A,CBre_Cons_05A2,Term_Cons_08A3,Term_Cons_08C)
summary_residual_compare(CBre_Cons_05A,CBre_Cons_05A2,Term_Cons_08A3,Term_Cons_08B2)
```





## Consolidation and Ceiling Breach
```{r CONS-CBre}
load("data//CBre_Cons.RData")

CBre_Cons_05A <- glm(data=smp,
                       b_CBre ~ c_HHI_lag1 + 
                      cl_Ceil + cl_Days+ 
                      Veh+
                      n_Fixed + b_UCA +
                      c_HHI_lag1:cl_Ceil  + 
                      b_Intl +
                      Veh:cl_Ceil+
                      b_UCA:cl_Ceil+
                      b_UCA:c_HHI_lag1
                       , family=binomial(link="logit"))
display(CBre_Cons_05A)
glmer_examine(CBre_Cons_05A)

CBre_Cons_05A2 <- glm(data=smp,
                       b_CBre ~ c_HHI_lag1 + 
                      cl_Ceil + cl_Days+ 
                      Veh+
                      n_Fixed + b_UCA +
                      # c_HHI_lag1:cl_Ceil  + 
                      b_Intl +
                      Veh:cl_Ceil+
                      b_UCA:cl_Ceil+
                      b_UCA:c_HHI_lag1
                       , family=binomial(link="logit"))
display(CBre_Cons_05A2)
glmer_examine(CBre_Cons_05A2)



# CBre_Cons_08A <- glmer(data=smp1m,
#                        b_CBre ~ c_HHI_lag1 +
#                       cl_Ceil + cl_Days+
#                       Veh+
#                       n_Fixed + b_UCA +
#                       c_HHI_lag1:cl_Ceil  +
#                       b_Intl +
#                       Veh:cl_Ceil+
#                       b_UCA:cl_Ceil+
#                       b_UCA:c_HHI_lag1+
#                          (1 | NAICS2)
#                        , family=binomial(link="logit"))

display(CBre_Cons_08A)
glmer_examine(CBre_Cons_08A)

CBre_Cons_08B <- glm(data=smp1m,
                       b_CBre ~ cl_HHI_lag1 +
                      cl_Ceil + cl_Days+
                      Veh+
                      n_Fixed + b_UCA +
                      c_HHI_lag1:cl_Ceil  +
                      b_Intl +
                      Veh:cl_Ceil+
                      b_UCA:cl_Ceil+
                      b_UCA:c_HHI_lag1+
                         NAICS2
                       , family=binomial(link="logit"))
display(CBre_Cons_08B)
glmer_examine(CBre_Cons_08B)


# CBre_Cons_08C <- glmer(data=smp1m,
#                        b_CBre ~ c_HHI_lag1 +
#                       cl_Ceil + cl_Days+
#                       Veh+
#                       n_Fixed + b_UCA +
#                       c_HHI_lag1:cl_Ceil  +
#                       b_Intl +
#                       Veh:cl_Ceil+
#                       b_UCA:cl_Ceil+
#                       b_UCA:c_HHI_lag1+
#                          (1 | NAICS2)+(1 | NAICS3)
#                        , family=binomial(link="logit"))

display(CBre_Cons_08C)
glmer_examine(CBre_Cons_08C)

# CBre_Cons_08D <- glmer(data=smp1m,
#                        b_CBre ~ c_HHI_lag1 +
#                       cl_Ceil + cl_Days+
#                       Veh+
#                       n_Fixed + b_UCA +
#                       c_HHI_lag1:cl_Ceil  +
#                       b_Intl +
#                       Veh:cl_Ceil+
#                       b_UCA:cl_Ceil+
#                       b_UCA:c_HHI_lag1+
#                          (1 | NAICS2)+(1 | NAICS4)
#                        , family=binomial(link="logit"))

display(CBre_Cons_08D)
glmer_examine(CBre_Cons_08D)


summary_residual_compare(CBre_Cons_08A,CBre_Cons_08A2,Term_Cons_08B,Term_Cons_08B2)
summary_residual_compare(CBre_Cons_05A,CBre_Cons_08A,Term_Cons_08B,Term_Cons_08B2)
summary_residual_compare(CBre_Cons_05A,CBre_Cons_08A,Term_Cons_08B,Term_Cons_08A7)


summary_residual_compare(CBre_Cons_08A,CBre_Cons_08B2,Term_Cons_08B,Term_Cons_08B)
summary_residual_compare(CBre_Cons_08A,CBre_Cons_08C,Term_Cons_08B,Term_Cons_08B)

summary_residual_compare(CBre_Cons_08C,CBre_Cons_08D,Term_Cons_08B,Term_Cons_08B)

# save(file="CBre_Cons.RData",CBre_Cons_05A,CBre_Cons_08A,CBre_Cons_08B)#,CBre_Cons_08B


```
VIF for cl_ceil:Veh is over 2, and for cl_Ceil is over 8, necessitating removal of a ceiling interaction.

## Competition and Terminations

```{r Comp_Term}

load(file="Comp_Term.Rdata")


#Create the model
Term_Comp_05A <- glm (data=smp1m,
                 b_Term ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh+
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  +# n_Comp:cl_Days +
                   n_Fixed + b_UCA +
                  # b_Intl + 
                   Veh:cl_Days+
                   Veh:n_Comp+
                   b_UCA:n_Comp
                    , family=binomial(link="logit"))
display(Term_Comp_05A)
glmer_examine(Term_Comp_05A)

Term_Comp_05A2 <- glm (data=smp1m,
                 b_Term ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh+
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days +
                   n_Fixed + b_UCA +
                   b_Intl +
                   Veh:cl_Days+
                   Veh:n_Comp+
                   b_UCA:n_Comp+
                     NAICS2, family=binomial(link="logit"))
display(Term_Comp_05A2)
glmer_examine(Term_Comp_05A2)

Term_Comp_05A3 <- glm (data=smp1m,
                 b_Term ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh+
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  +# n_Comp:cl_Days + 
                   n_Fixed + b_UCA +
                   b_Intl +
                   Veh:cl_Days+
                   Veh:n_Comp+
                   b_UCA:n_Comp+
                     NAICS2, family=binomial(link="logit"))
display(Term_Comp_05A3)
glmer_examine(Term_Comp_05A3)

Term_Comp_05A4 <- glm (data=smp1m,
                 b_Term ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh+
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  +# n_Comp:cl_Days + 
                   n_Fixed + b_UCA +
                   b_Intl +
                   Veh:cl_Days+
                   #Veh:n_Comp+ 2.5 glmer_examine
                   b_UCA:n_Comp+
                     NAICS2, family=binomial(link="logit"))
display(Term_Comp_05A4)

glmer_examine(Term_Comp_05A4)


Term_Comp_05A5 <- glm (data=smp1m,
                 b_Term ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh+
                   # n_Comp:cl_Ceil  + 
                   cl_Ceil:cl_Days  +# n_Comp:cl_Days + 
                   n_Fixed + b_UCA +
                   b_Intl +
                   Veh:cl_Days+#2.3 glmer_examine
                   #Veh:n_Comp+ 2.5 glmer_examine
                   b_UCA:n_Comp+
                     NAICS2, family=binomial(link="logit"))
display(Term_Comp_05A5)
glmer_examine(Term_Comp_05A5)


Term_Comp_05A6 <- glm (data=smp1m,
                 b_Term ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh+
                   n_Comp:cl_Ceil  + #cl_Ceil:cl_Days  +# n_Comp:cl_Days + 
                   n_Fixed + b_UCA +
                   b_Intl +
                   # Veh:cl_Days+ 2.3 glmer_examine
                   #Veh:n_Comp+ 2.5 glmer_examine
                   b_UCA:n_Comp+
                     NAICS2, family=binomial(link="logit"))
display(Term_Comp_05A6)

glmer_examine(Term_Comp_05A6)




#Plot the fitted values vs actual results
binned_fitted_versus_residuals(Term_Comp_05A)

#Plot residuals versus fittedO
residuals_term_plot(Term_Comp_05A)+
  labs(x="Estimated  Pr (Termination)")


smp$NAICS6<-smp$NAICS
smp$NAICS5<-substring(smp$NAICS6,1,5)
smp$NAICS4<-substring(smp$NAICS6,1,4)
smp$NAICS3<-substring(smp$NAICS6,1,3)
smp1m$NAICS6<-smp$NAICS
smp$NAICS5<-substring(smp$NAICS6,1,5)
smp$NAICS4<-substring(smp$NAICS6,1,4)
smp$NAICS3<-substring(smp$NAICS,1,3)
smp1m$NAICS4<-substring(smp1m$NAICS,1,4)

display(Term_Comp_08B)
glmer_examine(Term_Comp_08B)

display(Term_Comp_08C)
glmer_examine(Term_Comp_08C)

display(Term_Comp_08D)
glmer_examine(Term_Comp_08D)

display(Term_Comp_08E)
glmer_examine(Term_Comp_08E)

display(Term_Comp_08F)
glmer_examine(Term_Comp_08F)

display(Term_Comp_08F)
glmer_examine(Term_Comp_08F)


display(Term_Comp_08G)
glmer_examine(Term_Comp_08G)
# 
# Term_Comp_08H <- glmer(data=smp1m,
#                        b_Term ~n_Comp +
#                          cl_Ceil + cl_Days+
#                          Veh+
#                          # n_Comp:cl_Ceil  + cl_Ceil:cl_Days  +# n_Comp:cl_Days +
#                          n_Fixed + b_UCA +
#                          # b_Intl +
#                          # Veh:cl_Days +
#                          Veh:n_Comp
#                          b_UCA:n_Comp +
#                          (1 | NAICS2)
#                        , family=binomial(link="logit"))
display(Term_Comp_08H)
glmer_examine(Term_Comp_08H)


Term_Comp_08H2 <- glm(data=smp1m,
                       b_Term ~n_Comp +
                         cl_Ceil + cl_Days+
                         Veh+
                         # n_Comp:cl_Ceil  + cl_Ceil:cl_Days  +# n_Comp:cl_Days +
                         n_Fixed + b_UCA +
                         # b_Intl +
                         # Veh:cl_Days +
                         Veh:n_Comp+
                         b_UCA:n_Comp +
                         NAICS2, family=binomial(link="logit"))
display(Term_Comp_08H2)
glmer_examine(Term_Comp_08H2)

Term_Comp_08H3 <- glm(data=smp1m,
                       b_Term ~n_Comp +
                         cl_Ceil + cl_Days+
                         Veh+
                         n_Comp:cl_Ceil  + #cl_Ceil:cl_Days  +# n_Comp:cl_Days +
                         n_Fixed + b_UCA +
                         b_Intl +
                         # Veh:cl_Days+
                         # Veh:n_Comp+
                         b_UCA:n_Comp +
                         NAICS2, family=binomial(link="logit"))
display(Term_Comp_08H3)
glmer_examine(Term_Comp_08H3)

Term_Comp_08H3_25k <- glm(data=smp,
                       b_Term ~n_Comp +
                         cl_Ceil + cl_Days+
                         Veh+
                         n_Comp:cl_Ceil  + #cl_Ceil:cl_Days  +# n_Comp:cl_Days +
                         n_Fixed + b_UCA +
                         b_Intl +
                         # Veh:cl_Days+
                         # Veh:n_Comp+
                         b_UCA:n_Comp +
                         NAICS2, family=binomial(link="logit"))
display(Term_Comp_08H3_25k)
glmer_examine(Term_Comp_08H3_25k)

# Term_Comp_08I <- glmer(data=smp1m,
#                        b_Term ~n_Comp +
#                          cl_Ceil + cl_Days+
#                          Veh+
#                          n_Comp:cl_Ceil  + cl_Ceil:cl_Days  +# n_Comp:cl_Days +
#                          n_Fixed + b_UCA +
#                          b_Intl +
#                          Veh:cl_Days +
#                          Veh:n_Comp +
#                          b_UCA:n_Comp +
#                          (1 | NAICS2)
#                        , family=binomial(link="logit"))
display(Term_Comp_08I)
glmer_examine(Term_Comp_08I)


#Plot the fitted values vs actual results
binned_fitted_versus_residuals(Term_Comp_08H)

#Plot residuals versus fittedO
residuals_term_plot(Term_Comp_08H)+
  labs(x="Estimated  Pr (Termination)")

# save(file="Term_Comp.rdata",Term_Comp_05A,Term_Comp_08B,Term_Comp_08C,Term_Comp_08D,Term_Comp_08E,Term_Comp_08F,Term_Comp_08G,Term_Comp_08I)#Term_Comp_08H,


```

## Competition and Ceiling Breaches

```{r CompCBre}
#Create the model
  load("data//Comp_CBre.Rdata")

Comp_CBre_05A <- glm (data=smp,
                   b_CBre ~n_Comp + 
                     cl_Ceil + cl_Days+ 
                     Veh+
                     n_Fixed + b_UCA +
                     n_Comp:cl_Ceil  + 
                     b_Intl+
                     # Veh:cl_Days+
                     # Veh:n_Comp+
                     Veh:cl_Ceil+
                     b_UCA:cl_Ceil+
                     b_UCA:n_Comp
                   , family=binomial(link="logit"))
display(Comp_CBre_05A)
glmer_examine(Comp_CBre_05A)


Comp_CBre_05A2 <- glm (data=smp,
                   b_CBre ~n_Comp + 
                     cl_Ceil + cl_Days+ 
                     Veh+
                     n_Fixed + b_UCA +
                     # n_Comp:cl_Ceil  + 
                     b_Intl+
                     # Veh:cl_Days+
                     # Veh:n_Comp
                     Veh:cl_Ceil+
                     b_UCA:cl_Ceil+
                     b_UCA:n_Comp
                   , family=binomial(link="logit"))
display(Comp_CBre_05A2)
glmer_examine(Comp_CBre_05A2)

# Comp_CBre_08B<- glmer(data=smp1m,
#                     b_CBre ~n_Comp + 
#                       cl_Ceil + cl_Days+ 
#                       Veh+
#                       n_Fixed + b_UCA +
#                       n_Comp:cl_Ceil  + 
#                       b_Intl +
#                       Veh:cl_Ceil+
#                       b_UCA:cl_Ceil+
#                       b_UCA:n_Comp+
#                       (1 | NAICS2)
#                     , family=binomial(link="logit"))
display(Comp_CBre_08B)
glmer_examine(Comp_CBre_08B)


Comp_CBre_08B2<- glm(data=smp1m,
                    b_CBre ~n_Comp + 
                      cl_Ceil + cl_Days+ 
                      Veh+
                      n_Fixed + b_UCA +
                      # n_Comp:cl_Ceil  + 
                      b_Intl +
                      Veh:cl_Ceil+
                      b_UCA:cl_Ceil+
                      b_UCA:n_Comp+
                    NAICS2, family=binomial(link="logit"))
display(Comp_CBre_08B2)
glmer_examine(Comp_CBre_08B2)



?htmlreg
# 


glmer_examine(Comp_CBre_08B2)
summary_residual_compare(Comp_CBre_08A,Comp_CBre_08B2,Term_Comp_08G,Term_Comp_08H3)

stargazer(Comp_CBre_05A,Term_Cons_08A,type="html",out="Term_2.html")



# save(file="Comp_CBre.rdata",Comp_CBre_05A,Comp_CBre_08A,Comp_CBre_08B)
```

## Everything

```{r Everything}

# CBre_Cons_Comp_08B <- glmer(data=smp1m,
#                        b_CBre ~ c_HHI_lag1 + 
#                       cl_Ceil + cl_Days+ 
#                       Veh+
#                       n_Fixed + b_UCA +
#                       c_HHI_lag1:cl_Ceil  + 
#                       b_Intl +
#                       Veh:cl_Ceil+
#                       b_UCA:cl_Ceil+
#                       b_UCA:c_HHI_lag1+
#                          (1 | NAICS2)
#                        , family=binomial(link="logit"))
```


# Output 
```{r Output}

texreg::htmlreg(list(Term_Cons_08A3,
                     CBre_Cons_08B2),file="ConsModel.html",single.row = TRUE,
                custom.model.name=c("Termination",
                                    "Ceiling Breach"),
                        stars=c(0.05))


texreg::htmlreg(list(Term_Comp_08G,
                     Comp_CBre_08B2),file="CompModel.html",single.row = TRUE,
                custom.model.name=c("Termination",
                                    "Ceiling Breach"),
                        stars=c(0.05))

# texreg::htmlreg(list(Comp_CBre_08B,Term_Cons_08A),file="Hypothesis1.html")


# htmlreg(list(EuropeModel$fixed[[1]],EuropeModel$fixed[[2]],EuropeModel$fixed[[3]]),
#         file="Output\\Hypothesis1.html",
#         custom.model.name=c(as.character(EuropeModel$name[1:3])),
#         digits=3,
#         stars=c(0.001,0.01,0.05,0.1),
#         custom.coef.names = c("More Def. Spending",#Dlog(NGDPPC_eu2014)
#                               "Log(GDP), (2014 Euros)", #log(NGDP_eu2014)
#                               "EU27-wide Debt, (Percent of EU 27 GDP)",# EUdebt_NGDP
#                               "Deficit, (Percent of GDP)",# Dfc_NGDP
#                               "International Terrorism, (Number of Incidents)", #IntAt
#                               "Log(Global Civil War Battle-Related Deaths)", # log(GCivilWarBRD)
#                               "Cabinet Liberty/Authority, (GAL=0, TAN=10)", #Cab_liberty_authority
#                               "Liberty/Authority Polarization", #liberty_authority_ls_spread
#                               "Cabinet Anti/Pro EU, (Anti=0, Pro=10)"), #Cab_liberty_authority)
#         groups = list("Public Net Support for (year T-2)" = 1,"Macroeconomics (year T-1)" = 2:4,"Security (year T-1)" = 5:6,"Parliamentary (year T-1)" = 7:9),
#         custom.note="%stars.",
#             bold=0.05
# )


```