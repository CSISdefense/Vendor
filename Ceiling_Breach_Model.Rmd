---
title: "Contract Termination"
author: "Greg Sanders"
date: "Wednesday, February 8, 2017"
output:
  html_document:
    keep_md: yes
--- 

Modeling Likelihood of Contract Termination
============================================================================

#Setup
```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(arm)
library(R2WinBUGS)
source("DIIGstat.r")

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40


```

Contracts are classified using a mix of numerical and categorical variables. While the changes in numerical variables are easy to grasp and summarize, a contract may have one line item that is competed and another that is not. As is detailed in the exploration on R&D, we are only considering information available prior to contract start. The percentage of contract obligations that were competed is a valuable benchmark, but is highly influenced by factors that occured after contract start.

## Contract Terminations

Contract terminations and the number of change orders can be calculated for the entire sample.  Contract termination is determined using the *Reason for Modification* field in FPDS.  A contract is considered to be terminated if it has at least one modification with the following values:

* "Terminate for Default (complete or partial)"
* "Terminate for Convenience (complete or partial)"
* "Terminate for Cause"
* "Legal Contract Cancellation"

These four catetegories and the "Close Out" category are used to mark a contract as closed.  Many contracts in FPDS and in the sample are never marked closed.  


## Contract Ceiling Breaches

Contract Ceiling Breaches and the number of change orders can be calculated for the entire sample.  Cjamge prders are deter,omed using the *Reason for Modification* field in FPDS. 


##Prepare Data
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from   FPDS.


###Data Transformations and Summary



```{r ReadInData, echo = TRUE}

# head(def)
# # undebug(transform_contract)
# def<-transform_contract(def)
 load(file="Data/transformed_def.Rdata")


   smp1m$n_Comp<-smp1m$EffComp #Fix in Rdata, and add back comp
    levels(smp1m$n_Comp) <-
      list("0"="No Comp.",
           "0.5"="1 Offer",
           "1"="2+ Offers")
    smp1m$n_Comp<-as.numeric(as.character(smp1m$n_Comp))
summary(factor(smp1m$n_Comp ))
    
    
```


* b_Crai is a binary variable that has a value of 1 for a ceiling Breach of any size has occured, 0 otherwise. ('r summary(def$b_Crai)
NA_stats(def,"b_Crai"))
* b_Term is a binary variable that has a value of 1 for any contracts that have experienced a partial or complete termination, 0 otherwise. ('r summary(def$b_Term)
NA_stats(def,"b_Term"))
* b_Comp is a binary variable based on competition. It has a value of 0 for uncompeted contracts and a value of 1 for competition, regardless of number of offers. 'r  summary(def$b_Comp);
NA_stats(def,"b_Comp")'
* n_Comp is a numeric variable based on competition and number of offers. It has a value of 0 for uncompeted contracts and a value of 1 for single-offer competition, and a value of 2 for multi-offer competition. 'r summary(def$n_Comp);
NA_stats(def,"n_Comp")'
* n_Offr is a numeric variable based on competition and with more granularity on number offers. It has a value of 0 for uncompeted contracts and a value of 1 for single-offer competition, and a value of 2 for 2-offers, 3 for 3-4 offers, and 4 for 5+ offers. 'r summary(def$n_Offr);
NA_stats(def,"n_Offr")'
* l_Offr is the natural log of the number of offers received. Uncompeted contracts are classified as having received one offer. 'r summary(def$l_Offr);
NA_stats(def,"l_Offr")'
* cl_Ceil is the natural log of the initial contract cost ceiling, in then-year dollars. 'r centered_log_description(def$l_Ceil,"dollars");
NA_stats(def,"l_Ceil")'
* cl_Days is the natural log of the initial maximum duration of the contract, in days. The variable is centered, by subtracting its mean ('r centered_log_description(def$l_Days,"days");
NA_stats(def,"l_Days")' 
* SIDV, MIDV, and OIDV are dummy variables based on the contract vehicle. They correspond to Single-Award IDVs, Multi-Award IDVs, and Other IDVs, respectively, having a value of 1 when the task order has that vehicle type, and having a 0 other. The remaining types, definitive contracts and purchase orders, are intentionally left out. ('r summary(def$SIDV);
summary(def$MIDV);
summary(def$OIDV);
NA_stats(def,"Veh")'
* n_Fixed is a numeric variable based on contract pricing. It has a value of 0 for cost-based, 0.5 or "combination or other", 1 for any fixed price (excluding fixed-price level of effort which is classified as cost-based). ('r summary(def$n_Fixed);
NA_stats(def,"n_Fixed")')
* n_Incent is a numeric variable based on fee type. Ig has a value. 1 for incentive fee or cost sharing, 0.5 or "combination or other", 0 for all remaining types. ('r summary(def$n_Incent);
NA_stats(def,"n_Incent")')
* b_UCA is a binary variable with a value of 1 for contracts/task orders that begin as letter contracts or undefinitized contract awards (UCA) and a value of 0 otherwise. 'r
summary(def$b_UCA);
NA_stats(def,"b_UCA")'
* b_Intl is a binary variable with a value of 1 for contracts/task orders with any transactions performed internationally and a value of 0 otherwise. 'r
summary(def$b_Intl);
NA_stats(def,"b_Intl")'
* PSR is a factor reporting whether a contract is primarily for products/services/R&D. 'r
summary(def$PSR);
NA_stats(def,"PSR")'
* ProdServ is a factor reporting the top Product or Service Code of each contract. 'r
summary(def$ProdServ);
NA_stats(def,"ProdServ")'
* NAICS is a factor reporting the top North American Industrial Classification Code of each contract. 'r
summary(def$NAICS);
NA_stats(def,"NAICS")'
* Agency is a factor reporting the top Contracting Agency of each contract. 'r
summary(def$Agency);
NA_stats(def,"Agency")'
* Office is a factor reporting the top Contracting office of each contract. 'r
summary(def$Office);
NA_stats(def,"Office")'


In addition, l_Ceil and l_Days are rescaled to have an average value of 0 and a standard deviation of one. This standardizes interpretation and prevents a "very large eigen value" error later when l_Ceil:lDay is introduced.


Next, we eliminate missing data entries and then draw a sample. The final computation uses all of the data, but as a computation shortcut, only a subset of the data is needed to allow for processing of models in minutes rather than hours.

###Computational Sample Creation
```{r Sample}
 load(file="data//def_sample.Rdata")
# save(smp,smp1m,file="data//def_sample.Rdata")



# complete<-!is.na(def$b_Term)&
#   !is.na(def$b_CBre)&
#   !is.na(def$n_Comp)&
#   !is.na(def$l_Ceil)&
#   !is.na(def$l_Days)&
#   !is.na(def$Veh) &
#   !is.na(def$n_Fixed)&
#   !is.na(def$b_Intl)&
#   !is.na(def$b_UCA)&
#   !is.na(def$NAICS)&
#   !is.na(def$NAICS2)&
#   !is.na(def$cl_HHI_lag1)
# 
# smp<-def[complete,]
# #8818392  to 8818392
# nrow(def[!complete,])/nrow(def)
# sum(def[!complete,]$Action.Obligation,na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
# 
# smp1m<-smp[sample(nrow(smp),1000000),]
# smp<-smp[sample(nrow(smp),250000),]
# save(file="data//def_sample.Rdata",smp,smp1m)

# levels(smp$Intl)<- list("Just U.S."=c("Just U.S."), 
#                                 "Any Intl."=c("Any International"))
# levels(smp1m$Intl)<- list("Just U.S."=c("Just U.S."), 
#                                 "Any Intl."=c("Any International"))


```
###Examine Minimium Size
```{r MinimumSize}
# path<-"https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/"
#   directory="economic/"
#   deflator_file <- "Lookup_Deflators.csv"
#   
#  deflators_retrieved <- readr::read_csv(paste0(path, directory,deflator_file))
# deflators_retrieved$cutoff_3500<-3500*deflators_retrieved$Deflator.2016
# deflators_retrieved<-subset(deflators_retrieved,select=c(Fiscal.Year,cutoff_3500))
# colnames(deflators_retrieved)[1]<-"StartFY"
# def<-plyr::join(def,deflators_retrieved)
# #Frequency Plot for logged ceiling
# def$UnmodifiedContractBaseAndAllOptionsValue
# smp<-def[
#   !is.na(def$b_Term)&
#     !is.na(def$Comp)&
#     def$UnmodifiedContractBaseAndAllOptionsValue>=
#     def$cutoff_3500,]
# 
# smp<-smp[sample(nrow(smp),250000),]
# 
# 
# freq_continuous_term_plot(smp,"l_Ceil")
# exp(mean(smp$l_Ceil,na.rm=TRUE))
# 
# smp$StartFY
# 
# cutoff<-quantile(smp$l_Ceil,0.05,na.rm=TRUE)
# exp(cutoff)
# cutoff<-log(3500)
# 
# nrow(subset(smp,l_Ceil<cutoff,na.rm=TRUE))/nrow(smp)
# sum(subset(smp,l_Ceil<cutoff)$b_Term)/sum(smp$b_Term)
# 
# 
# sum(subset(smp,l_Ceil<cutoff,na.rm=TRUE)$Action.Obligation)/sum(smp$Action.Obligation)
# sum(subset(smp,l_Ceil>=cutoff,na.rm=TRUE)$Action.Obligation)/sum(smp$Action.Obligation)
# 
# sum(subset(smp,l_Ceil<cutoff)$b_Term)/nrow(subset(smp,l_Ceil<cutoff,na.rm=TRUE))
# 
# sum(subset(smp,l_Ceil>=cutoff)$b_Term)/nrow(subset(smp,l_Ceil<cutoff,na.rm=TRUE))
# 
# 
# exp(2)
```



#Initial Logit Model

##Study Variable: Competition
Competition has the potential to reduce terminations by giving the government more options in vendors and encouraging better behavior from the contractor that was chosen. 
###Model 01A: No Competition / Competition


```{r Model01A_CBre}

#Frequency Plot
summary_discrete_plot(smp,"Comp")

#Model
CBre_Comp_01A <- glm (data=smp,
                 b_CBre ~ cb_Comp, family=binomial(link="logit"))
display(CBre_Comp_01A)

#Plot the new variable and coefficients
# Add the fitted regression line
fitted_cbre_model(smp,"cb_Comp") +
  stat_function(fun = fit_curve, args=list(a=coef(CBre_Comp_01A)[1],                                                        b=coef(CBre_Comp_01A)[2]),color="blue")



```
Competition alone has a very slight, but significant, negative correlation with terminations. The next step is to check alternate formulations. There's not yet enough in this model for any meaningful residual models. The next step is to look at a more detailed model, where single offer competition is broken out as a middle option between competition and no competion.



###Model 01B: Effective Competition

```{r Model01B_CBre}

#Frequency Plot
summary_discrete_plot(smp,"EffComp")


#Model
CBre_Comp_01B <- glm (data=smp,
                 b_CBre ~ n_Comp, family=binomial(link="logit"))
display(CBre_Comp_01B)

#Plot the Fitted
#Add the fitted regression line
fitted_cbre_model(smp,"n_Comp") +
  stat_function(fun = fit_curve, args=list(a=coef(CBre_Comp_01B)[1],
                                           b=coef(CBre_Comp_01B)[2]),
                color="blue")




```


The correltion between the three categories of competition has a smaller coefficent, but is still signficant. In the next step, the multiple award competition is broken down in greater detail.



###Model 01C: No Competition / Number of Offer Categories 

```{r Model01C_CBre}

#Frequency Plot
summary_discrete_plot(smp,"CompOffr")

#Model
CBre_Comp_01C <- glm (data=smp,
                 b_CBre ~ cn_Offr, family=binomial(link="logit"))
display(CBre_Comp_01C)

#Plot the Fitted
#Add the fitted regression line
fitted_cbre_model(smp,"n_Comp") +
  stat_function(fun = fit_curve, args=list(a=coef(CBre_Comp_01C)[1],
                                           b=coef(CBre_Comp_01C)[2]),
                color="blue")



```

As measured by residual deviance, this variable has slightly less predictive power than random noise. That can likely be attributed to the fact that 5+ offers category has a higher termination rate than 2 and 3-4. In theory, this could be because of non-liner relationship, for example higher number of offers competition may be more vulnerable to aggressive bidding beavior. However, this explaination would likely be better captured by other hidden variables such as competition methods rather than having a direct relationship with an increased number of offers. As a result, we are not testing offers as a categorical variable with dummies. 

Instead, the last variant to be checked is the number of offers directly. This is handled logarithmicly because the differences between number of offers at the bottom end of the scale mtters much more than at the high end of the scale. In this method, contracts that were not open to competition are grouped with contracts that received only a single offer.


###Model 01D: Number of Offer Categories 

```{r Model01D_CBre}

#Frequency Plot
summary_continuous_plot(smp,"l_Offr")

#Percent Terminated Plot
summary_continuous_plot(smp,"l_Offr","FxCb")

#Percent Terminated Plot
summary_continuous_plot(smp,"l_Offr","PSR")

#Percent Terminated Plot
summary_continuous_plot(smp,"l_Offr","Veh")


#Model
CBre_Comp_01D <- glm (data=smp,
                 b_CBre ~ cl_Offr, family=binomial(link="logit"))
display(CBre_Comp_01D)

#Variant Model
smp$clsqr_Offer<-smp$cl_Offr^2
CBre_Comp_01E <- glm (data=smp,
                 b_CBre ~ cl_Offr +clsqr_Offer, family=binomial(link="logit"))
display(CBre_Comp_01E)

#Plot the data and fitted curve
CBre_Comp_01D_plot<-ggplot(data=smp,
       aes(y=j_Term,x=cl_Offr))+geom_jitter(alpha=0.01,height=0)+scale_y_sqrt() +
  labs(title="Fitted Linear Model", caption="Source: FPDS, CSIS Analysis")

#Plot the Fitted
#Add the fitted regression line
fitted_cbre_model(smp,"cl_Offr") +
  stat_function(fun = fit_curve, args=list(a=coef(CBre_Comp_01D)[1],
                                           b=coef(CBre_Comp_01D)[2]),
                             color="blue")

#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_Comp_01D)



#Plot residuals versus fitted
residuals_cbre_plot(CBre_Comp_01D,bins=3)+
  labs(x="Estimated  Pr (Ceiling Breach)")




```

Closer examination further undercuts the idea that more offers is associated with a lower termination risk. As measured by deviance, the number offers adds less to the model than random noise. A quick experiment also found that use of number of offer squared only made the model slightly better than noise.

A variety of binned percent terminated graphs found that in the middle range of the number of offers, there is often an increase in the percent terminated. The study team had expected that this phenomenon may prove isolated to a certain type of contracting mechanism or product/service, but that did not prove to be the case.

The difference between single-offer and effective competition is worth exploring, even if it lowers the significance of the starting model. Happily, this decision is supported by the fact that this three category variable offers the greatest reduction in residual deviance. However, lacking a specific theoretical argument for the importance of a greater number of offers, and given the results, the more detailed competition breakdowns will not be used. This may be an issue worth exploring more in a future work.

The greatest distinctiveness can be found in types of indefinite delivery vehicles. Definitive contracts and purchase orders show a higher termination rate as the number of offers increase. However, for single and multiple award IDVs, there's a decline in terminations rates correlated with low levels of competition, that often fades and even reverses as the number of offers increases. However, the results do not seem consistent with am exponential relationship.

### Model 01E: HHI_lag1
The expectation of the hypotheses is that consolidation will vary with consolidation, but does not predict a direction.

```{r Model01E_CBre}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(smp,"HHI_lag1")

#Model
CBre_Cons_01E <- glm (data=smp,
                 b_CBre ~cl_HHI_lag1, family=binomial(link="logit"))
display(CBre_Cons_01E)


#Plot the fitted model plot
CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}

#Competition curves
fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
                             args=list(Comp=0),color="blue")+
  stat_function(fun = CBre_Comp_02A_curve, 
                             args=list(Comp=2),color="blue")



#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_Comp_02A)

#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_01E,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_01E,CBre_Cons_01E,bins=20)


```
### Model 01F: l_HHI_lag1

Expectations are  unchanged.
```{r Model01E_CBre}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(smp,"l_HHI_lag1")

#Model
CBre_Cons_01F <- glm (data=smp,
                 b_CBre ~cl_HHI_lag1, family=binomial(link="logit"))
display(CBre_Cons_01F)


#Plot the fitted model plot
CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}

#Competition curves
fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
                             args=list(Comp=0),color="blue")+
  stat_function(fun = CBre_Comp_02A_curve, 
                             args=list(Comp=2),color="blue")



#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_Comp_02A)

#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_01E,CBre_Cons_01F,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_01E,CBre_Cons_01F,bins=20)


```
The use of log doesn't change the direction of finding, but it does reduce the magnitude of the residuals and smooths out the trend. 
##Scope Variables
###Model 02A: Cost Ceiling


```{r Model02A_CBre}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(smp,"UnmodifiedContractBaseAndAllOptionsValue",
               bins=1000)
summary_continuous_plot(subset(smp,UnmodifiedContractBaseAndAllOptionsValue<100000000),
               "UnmodifiedContractBaseAndAllOptionsValue",
               bins=1000)

#Frequency Plot for logged ceiling
summary_continuous_plot(smp,"l_Ceil")

#Model
CBre_Cons_02A <- glm (data=smp,
                 b_CBre ~cl_HHI_lag1 + 
                   cl_Ceil, family=binomial(link="logit"))
display(CBre_Cons_02C)

CBre_Comp_02A <- glm (data=smp,
                 b_CBre ~n_Comp + cl_Ceil, family=binomial(link="logit"))
display(CBre_Comp_02A)


#Plot the fitted model plot
CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}

#Competition curves
fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
                             args=list(Comp=0),color="blue")+
  stat_function(fun = CBre_Comp_02A_curve, 
                             args=list(Comp=2),color="blue")



#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_Comp_02A)

#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_01F, CBre_Cons_02A,CBre_Comp_01B,CBre_Comp_02A,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_01F,CBre_Cons_02A,CBre_Comp_01B,CBre_Comp_02A,bins=2)


```

Contract ceiling has a significant relationship.





###Model 02C: Cost Ceiling and Competition
Larger contracts may encourage bid to win strategies  that could raise ceiling breaches for competition. That is a more indirect effect in consolidated markets.

```{r Model02C_CBre}

#Frequency Plot
summary_continuous_plot(smp,"l_Ceil","EffComp")


#Create the model
CBre_Cons_02C <- glm (data=smp,
                 b_CBre ~cl_HHI_lag1 + 
                   cl_Ceil + 
                   cl_HHI_lag1:cl_Ceil, family=binomial(link="logit"))
display(CBre_Cons_02C)

CBre_Comp_02C <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + 
                   n_Comp:cl_Ceil, family=binomial(link="logit"))
display(CBre_Comp_02C)


CBre_Comp_02C_curve<-function(x, Comp){invlogit(cbind(1,Comp,x,Comp*x) %*%  coef(CBre_Comp_02C))}

#Competition Curves
fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02C_curve, 
                             args=list(Comp=0),color="blue")+
  stat_function(fun = CBre_Comp_02C_curve, 
                             args=list(Comp=2),color="blue")

#Plot the fitted values vs actual results
  stargazer::stargazer(CBre_Cons_02A,CBre_Cons_02C,CBre_Comp_02A,CBre_Comp_02C,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_02A,CBre_Cons_02C,CBre_Comp_02A,CBre_Comp_02C,bins=20)


```
The interaction went in the expected direction for competition, but is surprisingly powerful. Competition heightens the importance of contract ceiling, and larger contract ceilings mitigate the importance of competition. The other powerful part of this interaction was the dramatic increase in the coefficient for competition and the comparative reduction in the correlation of ceiling. However, the VIF exceeds 2 by  considerable margin, leaving it out.

The weaker expectation was not upheld with consolidation but is significant. Leaving that in for now. May reflect the efficiencies of more utility like sectors with large contracts.

###Model 02D: Maximum Duration


```{r Model02D_CBre}
#Frequency Plot for max duration
summary_continuous_plot(smp,"UnmodifiedDays",
               bins=1000)

#Frequency Plot for logged max duration
summary_continuous_plot(smp,"l_Days")



#Model
CBre_Cons_02D <- glm (data=smp,
                 b_CBre ~cl_HHI_lag1 + 
                   cl_Ceil + cl_Days + 
                   cl_HHI_lag1:cl_Ceil, family=binomial(link="logit"))
display(CBre_Cons_02D)

CBre_Comp_02D <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days , family=binomial(link="logit"))
display(CBre_Comp_02D)


CBre_Comp_02D_curve<-function(x, Comp,Ceil){invlogit(cbind(1,Comp,Ceil,x,Comp*Ceil) %*%  coef(CBre_Comp_02D))}

#Competition Curves
fitted_cbre_model(smp,"cl_Days") + stat_function(fun = CBre_Comp_02D_curve, 
                             args=list(Comp=0,Ceil=0),color="blue")+
  stat_function(fun = CBre_Comp_02D_curve, 
                             args=list(Comp=2,Ceil=0),color="blue")

#Ceiling Curves
fitted_cbre_model(smp,"cl_Days") +  stat_function(fun = CBre_Comp_02D_curve, 
                             args=list(Comp=0,Ceil=0),color="blue")+
  stat_function(fun = CBre_Comp_02D_curve, 
                             args=list(Comp=0,Ceil=1),color="blue")

#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_Comp_02D)


#Plot residuals versus fitted
residuals_cbre_plot(CBre_Comp_02D)+
  labs(x="Estimated  Pr (Ceiling Breach)")
# debug(binned.resids)
# residuals_cbre_plot(CBre_Comp_02D,"cl_Days")+
  # labs(x="Centered Log(Ceiling)")


  stargazer::stargazer(CBre_Cons_02D,CBre_Comp_02D,type="text",
                       digits=2)

summary_residual_compare(CBre_Cons_02C,CBre_Cons_02D,CBre_Comp_02A,CBre_Comp_02D,bins=20)

```
The initial model results are surprising as ceiling change direction, reducing and correlates with a lower risk of termiation now, although the interaction between competition and ceiling remains roughly the same. The graph of the fitted values shows that this model The next step will be to look at the interaction of ceiling and duration. The difference in deviance for residual difference has more than trippled, an indication of the correlative power of duration. However, the residuals do show a clear pattern that indicates another exponential variable may be necessary. However, the interaction between ceiling and duration is a more important analytical question and will be the next variable added.


###Model 02E: Ceiling and Duration
```{r Mode02E_CBre}

#First a quick scatter plot for terminations by duration and ceiling
ggplot(data=subset(smp,!is.na(l_Ceil)),
       aes(x=l_Days,y=l_Ceil))+geom_point(alpha=0.1)+facet_grid(Term~.)+
  labs(title="Frequency by Termination",
          caption="Source: FPDS, CSIS Analysis")


#Create the model
CBre_Cons_02E <- glm (data=smp,
                 b_CBre ~cl_HHI_lag1 + 
                   cl_Ceil + cl_Days + 
                   cl_HHI_lag1:cl_Ceil+
                    cl_Ceil:cl_Days, family=binomial(link="logit"))
display(CBre_Cons_02E)


CBre_Comp_02E <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+
                    cl_Ceil:cl_Days, family=binomial(link="logit"))
display(CBre_Comp_02E)

CBre_Comp_02E_curve<-function(x, Comp,Ceil){invlogit(
  cbind(1,Comp,Ceil,x,
        Comp*Ceil,x*Ceil) %*%  coef(CBre_Comp_02E))}



#Competition Curves
fitted_cbre_model(smp,"cl_Days") + stat_function(fun = CBre_Comp_02E_curve, 
                             args=list(Comp=0,Ceil=0),color="blue")+
  stat_function(fun = CBre_Comp_02E_curve, 
                             args=list(Comp=2,Ceil=0),color="blue")

#Ceiling Curves
fitted_cbre_model(smp,"cl_Days") +  stat_function(fun = CBre_Comp_02E_curve, 
                             args=list(Comp=0,Ceil=0),color="blue")+
  stat_function(fun = CBre_Comp_02E_curve, 
                             args=list(Comp=0,Ceil=1),color="blue")


  stargazer::stargazer(CBre_Cons_02D,CBre_Cons_02E,CBre_Comp_02D,CBre_Comp_02E,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_02D,CBre_Cons_02E,CBre_Comp_02D,CBre_Comp_02E,bins=20)

```

Excluded by VIF in both cases.The interaction of ceiling and duration has a minimal coefficient and is not significant. Leaving it out.


###Model 02H: Duration and Comp/Cons
Skipping duration^2 and removal of ceiling ^2

Greater duration may limit the influence of competition, at least under the policy guidance that encourages  regular recompeting. In theor this same logic could apply to consolidation as it locks in market conditions at a particular point.

```{r Mode02H_CBre}

#Frequency Plot
summary_continuous_plot(smp,"l_Days","EffComp")

#Create the model
CBre_Cons_02H <- glm (data=smp,
                 b_CBre ~cl_HHI_lag1 + 
                   cl_Ceil + cl_Days+
                   cl_HHI_lag1:cl_Ceil+
                   cl_HHI_lag1:cl_Days, family=binomial(link="logit"))
display(CBre_Cons_02H)

CBre_Comp_02H <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   n_Comp:cl_Days, family=binomial(link="logit"))
display(CBre_Comp_02H)

CBre_Comp_02H_curve<-function(x, Comp,Ceil){invlogit(
  cbind(1,Comp,Ceil,x,
        Comp*Ceil,x*Ceil,x*Comp) %*%  coef(CBre_Comp_02H))}

#Competition curves
fitted_cbre_model(smp,"cl_Days") + stat_function(fun = CBre_Comp_02H_curve, 
                             args=list(Comp=0,Ceil=0),color="blue")+
  stat_function(fun = CBre_Comp_02H_curve, 
                             args=list(Comp=2,Ceil=0),color="blue")

#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_Comp_02H)

#Plot residuals versus fitted
residuals_cbre_plot(CBre_Comp_02H)+
  labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot(CBre_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

stargazer::stargazer(CBre_Cons_02D,CBre_Cons_02H,CBre_Comp_02D,CBre_Comp_02H,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_02D,CBre_Cons_02H,CBre_Comp_02D,CBre_Comp_02H,bins=20)


```
The interaction of competition and duration is significant in itself and also has interesting consequences for other variables, notably boosting the negative cooeficient for competition and reducing the coefficient for duration. However,  VIF excludes this variable.

Contrary to expectation, consolidation matters more for greater duration contracts. Unfortunately the residuals still show questionable patterns that merit continued observation. 


##Contract Vehicle
Our dataset includes both stand alone contract awards and task orders that are under larger indefinite delivery vehilces (IDVs). 

###Model 03A: Single-Award, Multi-Award, and Other Indefinite Delivery Vehicles


```{r Model03A_CBre}
#Frequency Plot
summary_discrete_plot(smp,"Veh")


#Create the model
CBre_Cons_03A <- glm (data=smp,
                 b_CBre ~cl_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   cl_HHI_lag1:cl_Ceil  +
                   cl_HHI_lag1:cl_Days
                 , family=binomial(link="logit"))
display(CBre_Cons_03A)


CBre_Comp_03A <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh
                   # cl_HHI_lag1:cl_Ceil  +
                   #cl_HHI_lag1:cl_Days
                 , family=binomial(link="logit"))
display(CBre_Comp_03A)

#Plot the model and Vehicle for SIDV
CBre_Comp_03A_SIDV_curve<-function(x, Comp,Ceil,Days,MIDV,OIDV){invlogit(
  cbind(1,Comp,Ceil,Days,x,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp) %*%  coef(CBre_Comp_03A))}

#Competition curves
fitted_cbre_model(smp,"SIDV") +
  stat_function(fun = CBre_Comp_03A_SIDV_curve, 
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
  stat_function(fun = CBre_Comp_03A_SIDV_curve, 
                             args=list(Comp=2,Ceil=0,Days=0,
                                       MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")

CBre_Comp_03A_MIDV_curve<-function(x, Comp,Ceil,Days,SIDV,OIDV){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,x,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp) %*%  coef(CBre_Comp_03A))}

#Plot the model and Vehicle for MIDV
#Competition curves
fitted_cbre_model(smp,"MIDV") +
  stat_function(fun = CBre_Comp_03A_MIDV_curve, 
                             args=list(Comp=0,Ceil=0,Days=0,
                                       SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
  stat_function(fun = CBre_Comp_03A_MIDV_curve, 
                             args=list(Comp=2,Ceil=0,Days=0,
                                       SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")

CBre_Comp_03A_OIDV_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,x,
        Comp*Ceil,Days*Ceil,Days*Comp) %*%  coef(CBre_Comp_03A))}

#Plot the model and Vehicle for OIDV
#Competition curves
fitted_cbre_model(smp,"OIDV") +
  stat_function(fun = CBre_Comp_03A_OIDV_curve, 
                             args=list(Comp=0,Ceil=0,Days=0,
                                       SIDV=0,MIDV=0),color="blue")+
  stat_function(fun = CBre_Comp_03A_OIDV_curve, 
                             args=list(Comp=2,Ceil=0,Days=0,
                                       SIDV=0,MIDV=0),color="blue")



#Plot the fitted values vs actual results
stargazer::stargazer(CBre_Cons_02H,CBre_Cons_03A,CBre_Comp_02D,CBre_Comp_03A,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_02H,CBre_Cons_03A,CBre_Comp_02D,CBre_Comp_03A,bins=20)

```

The first check lumps looks at three categories of IDVs, each facing a notably lower a risk of termination. The largest negative coefficient is for single award IDCs, multiple award IDVs second, and other IDVs third. The deviation residual notably creeps up after this addition, though this is likely attributable to a missing data problem rather than the new information not being useful. Unfortunately, while the for both ceiling^2 and duration^2 were notably reduced in magnitude, the residuals show significant patterns, underestimating the risk of termination in the fitted range from around 0.005 to 0.01 and overestimating by 0.02. There's no exponential term that makes sense to add here, which leaves the hope that interactions may address this phenomenon.

This may reflect that the Ceiling and Days entries reflect only the task order and not the larger contract. The next step is to check the intersections with ceiling.

###Model 03B: Vehicle and Duration
Expectation, those vehicles that are prone towards particularly short task orders may estimate greater ceiling breaches when they interact with longer durations. This covers Single-Award IDCs and to a lesser extent the dual peaked BPA/BOAs.
```{r Model03B_CBre}

#Frequency Plot
summary_continuous_plot(smp,"l_Days","Veh")




#Create the model
CBre_Cons_03B <- glm (data=smp,
                 b_CBre ~cl_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   cl_HHI_lag1:cl_Ceil  +
                   cl_HHI_lag1:cl_Days +
                 Veh:cl_Days
                 , family=binomial(link="logit"))
display(CBre_Cons_03B)



CBre_Comp_03B <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_HHI_lag1:cl_Ceil  + 
                   #cl_HHI_lag1:cl_Days +
                 Veh:cl_Days, family=binomial(link="logit"))
display(CBre_Comp_03B)

# Plot the model and Vehicle for SIDV
# CBre_Comp_03B_SIDV_curve<-function(x, Comp,Ceil,Days,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,x,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*x,Days*MIDV,Days*OIDV) %*%  coef(CBre_Comp_03B))}
# 
# #Duration curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_03B_SIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=-1,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_03B_SIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=1,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# CBre_Comp_03B_MIDV_curve<-function(x, Comp,Ceil,Days,SIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,x,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*SIDV,Days*x,Days*OIDV) %*%  coef(CBre_Comp_03B))}
# 
# #Plot the model and Vehicle for MIDV
# #Duration Curves
# fitted_cbre_model(smp,"MIDV") +
#   stat_function(fun = CBre_Comp_03B_MIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=-1,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_03B_MIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=1,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# CBre_Comp_03B_OIDV_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,x,BPABOA,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*SIDV,Days*MIDV,Days*x) %*%  coef(CBre_Comp_03B))}
# 
# #Plot the model and Vehicle for FSSGWAC
# #Duration curves
# fitted_cbre_model(smp,"FSSGWAC") +
#   stat_function(fun = CBre_Comp_03B_OIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=-1,
#                                        SIDV=0,MIDV=0),color="blue")+
#   stat_function(fun = CBre_Comp_03B_OIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=1,
#                                        SIDV=0,MIDV=0),color="blue")


  
  stargazer::stargazer(CBre_Cons_03A,CBre_Cons_03B,CBre_Comp_03A,CBre_Comp_03B,type="text",
                         digits=2)
  
  
  summary_residual_compare(CBre_Cons_03A,CBre_Cons_03B,CBre_Comp_03A,CBre_Comp_03B,bins=20)

  
  CBre_Cons_03B2 <- glm (data=smp,
                 b_CBre ~cl_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   cl_HHI_lag1:cl_Ceil  +
                   # cl_HHI_lag1:cl_Days +
                 Veh:cl_Days
                 , family=binomial(link="logit"))
display(CBre_Cons_03B2)

  stargazer::stargazer(CBre_Cons_03A,CBre_Cons_03B2,type="text",
                         digits=2)
  
  summary_residual_compare(CBre_Cons_03A,CBre_Cons_03B2,bins=20)

  
```

The vast majority of very short duration contracts are IDVs. The distribution in each of the categories is typically not normal, Other IDVs in particularly being prone to two peaks. Interestingly enough, definitive contracts and purchase orders have the most consistent relationship with terminations, and single-award IDVs the most noisy. For the MIDVs and OIDVs, below l_days=2, or about the average point, there's almost no risk of termination, but that risk steadily rises above that level. 

Interactions:
* Single-Award IDVs have a large negative coefficient, but as the duration grows longer this affect is diminished and the importance of duration grows. 
* Multiple-Award IDVs now have the largest negative coefficient, but to an even greater degree than with Single-Award IDVs, as the duration grows longer this affect is diminished and the importance of duration grows. 
* Other IDVs now have a no longer signicant risk of termination, but the relationship with duration is the reverse of the other two, OIDVs dampen the rise in termination risk for longer contracts.

This variable necessitates the removal of cons::hhi_lag1. This is a difficult call, as consistency between the comp and cons model is important and the residuals are not improved by the veh:l_days interaction. However, leaving it for now, as at least on the Single-Award side, the theory is better understood here. This may be worth revisiting later.

###Model 03C: Vehicle and Competition
Competition occurs more regularly with definitive contracts, multiple award IDCs, GWACs/FSS, and some BPA/BOA. As a result we expect those vehicles that when interacting with competitive contracts to estiamte lower risk of ceiling breach. For consolidation, we expect single award IDCs and perhaps BPA/BOAs, which  are sometime single award, to be highly influenced by consolidation as competition  doesn't occur after initial selection but the overall market dynamic would instead influence whether contracting officers feel pressured to use that mechanism.


```{r Model03C_CBre}

#Frequency Plot
summary_discrete_plot(smp,"EffComp","Veh")
summary_continuous_plot(smp,"HHI_lag1","Veh")

#Create the model
CBre_Cons_03C <- glm (data=smp,
                 b_CBre ~cl_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   cl_HHI_lag1:cl_Ceil  + #cl_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_HHI_lag1, family=binomial(link="logit"))
display(CBre_Cons_03C)

CBre_Comp_03C <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                 Veh:cl_Days+
                   Veh:n_Comp, family=binomial(link="logit"))
display(CBre_Comp_03C)
# 
# # Plot the model and Vehicle for SIDV
# CBre_Comp_03C_SIDV_curve<-function(x, Comp,Ceil,Days,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,x,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(CBre_Comp_03C))}
# 
# #Competition curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_03C_SIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_03C_SIDV_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# CBre_Comp_03C_MIDV_curve<-function(x, Comp,Ceil,Days,SIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,x,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*SIDV,Days*x,Days*OIDV,
#         Comp*SIDV,Comp*x,Comp*OIDV) %*%  coef(CBre_Comp_03C))}
# 
# #Plot the model and Vehicle for MIDV
# #Competition Curves
# fitted_cbre_model(smp,"MIDV") +
#   stat_function(fun = CBre_Comp_03C_MIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_03C_MIDV_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# CBre_Comp_03C_OIDV_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,x,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*SIDV,Days*MIDV,Days*x,
#         Comp*SIDV,Comp*MIDV,Comp*x) %*%  coef(CBre_Comp_03C))}
# 
# #Plot the model and Vehicle for OIDV
# #Competition curves
# fitted_cbre_model(smp,"OIDV") +
#   stat_function(fun = CBre_Comp_03C_OIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=0),color="blue")+
#   stat_function(fun = CBre_Comp_03C_OIDV_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=0),color="blue")

  stargazer::stargazer(CBre_Cons_03B2,CBre_Cons_03C,CBre_Comp_03B,CBre_Comp_03C,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_03B2,CBre_Cons_03C,CBre_Comp_03B,CBre_Comp_03C,bins=20)

```
The average plots did show varying relationships and slopes between different types of vehicles. However, 
the coeficient for competition itself remains negative, though not significant, despite the baseline vehicle state, definitive/purchase, having higher termination rates among competed contracts. Given the other interactions, this suggests that this phenomenon is already captured by other inputs and interactions in the dataset. 

Interactions
* For single-award IDVs, competition magnifies the lower termination coeffient. This is somewhat surprising, as competition reflects the competed status of the IDV, not the individual task order. Nonetheless, that rate appears to very much matter, and suggests that uncompeted IDVs lose some of their termination reduction correlation.
* For multiple-award IDVs, competition also dampens the termination rate. This also magnificies the import of duration for multiple-award IDVs, which now can complete overcome the base termination coefficient of the vehicle.
* Competition dampens the termination reduction coefficient for other IDVs. It is not significant, I am tempted to leave it out, though it may be appropriate to always leave in the triples.

Unlike the existance of competition, having more offers does not have the same dramatic relationship with multi-award IDVs that it does with competition. This does raise the question as to whether the long tail of high numbers of offers might be undercutting the relationship. However, for now, we will stick with competition. 

VIF concompetition:vehicle exceeds 2, which necessitates removing it. HHI_lag1 results magnify residuals and run contrary to expectations. The deviation reduction at 30 is good, but not amazing. Leaving it out.


###Model 03D: Vehicle and Contract Ceiling
Based on a the descriptive statistics, it appears that the definitive vehicles, multi-award, and FSS/GWACs vary most based on  size. This woud be consistent with the idea that regular reward on these mechanisms might be an important  part of managmening them. By comparison breaking single-award IDCs and the sometimes single-award BPA/BOA into smaller chunks may just not matter to the same degree. Thus the expectation is that  M-IDV, FSS/GWAC, and definitive  (the baseline), will estimate higher risk of ceiling breaches for larger contracts.
```{r Model03D_Comp}

#Frequency Plot
summary_continuous_plot(smp,"l_Ceil","Veh")


#Create the model
CBre_Cons_03D <- glm (data=smp,
                 b_CBre ~cl_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   cl_HHI_lag1:cl_Ceil  + #cl_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_Ceil, family=binomial(link="logit"))
display(CBre_Cons_03D)

CBre_Comp_03D <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_HHI_lag1:cl_Ceil  +
                   #cl_HHI_lag1:cl_Days +
                 Veh:cl_Days  + 
                   Veh:cl_Ceil, family=binomial(link="logit"))
display(CBre_Comp_03D)
# 
# # Plot the model and Vehicle for SIDV
# CBre_Comp_03D_SIDV_curve<-function(x, Comp,Ceil,Days,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,x,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         Ceil*x,Ceil*MIDV,Ceil*OIDV) %*%  coef(CBre_Comp_03D))}
# 
# #Competition curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_03D_SIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_03D_SIDV_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# CBre_Comp_03D_MIDV_curve<-function(x, Comp,Ceil,Days,SIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,x,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*SIDV,Days*x,Days*OIDV,
#         Comp*SIDV,Comp*x,Comp*OIDV,
#         Ceil*SIDV,Ceil*x,Ceil*OIDV) %*%  coef(CBre_Comp_03D))}
# 
# #Plot the model and Vehicle for MIDV
# #Competition Curves
# fitted_cbre_model(smp,"MIDV") +
#   stat_function(fun = CBre_Comp_03D_MIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_03D_MIDV_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# CBre_Comp_03D_OIDV_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,x,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*SIDV,Days*MIDV,Days*x,
#         Comp*SIDV,Comp*MIDV,Comp*x,
#         Ceil*SIDV,Ceil*MIDV,Ceil*x) %*%  coef(CBre_Comp_03D))}
# 
# #Plot the model and Vehicle for OIDV
# #Competition curves
# fitted_cbre_model(smp,"OIDV") +
#   stat_function(fun = CBre_Comp_03D_OIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=0),color="blue")+
#   stat_function(fun = CBre_Comp_03D_OIDV_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=0),color="blue")
# 




stargazer::stargazer(CBre_Cons_03B2,CBre_Cons_03D,CBre_Comp_03B,CBre_Comp_03D,type="text",
                       digits=2)
summary_residual_compare(CBre_Cons_03B2,CBre_Cons_03D,CBre_Comp_03B,CBre_Comp_03D,bins=20)

  
CBre_Cons_03D2 <- glm (data=smp,
                 b_CBre ~cl_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   # cl_HHI_lag1:cl_Ceil  + #cl_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_Ceil, family=binomial(link="logit"))
display(CBre_Cons_03D2)


stargazer::stargazer(CBre_Cons_03B2,CBre_Cons_03D2,type="text",
                       digits=2)
summary_residual_compare(CBre_Cons_03B2,CBre_Cons_03D2,bins=20)

```

The results are interesting, upholding expectations for definitive award contracts and to a lesser degree for FSS/GWACS, but not for multi-award IDCs. The addition Interestingly, risk for indefinite delivery vehicles seems to depend much more on  duration, whille for definitive contracts ceiling matters most.

VIF for ceiling exceeded 2 for consolidated, and we compared a model with  HHI_lag1:ceiling removed. That improved devinace and had a mixed effect on residuals, decreasing the magnitude of outliers though slighty throwing off the  highest risk predictions.





##Type of Contract

The next step adds a measure for whether the contract was cost-based or fixed-price. Prior CSIS research has found that fixed-price contracts do face a higher risk of termination across the board.


##Type of Contract

The next step adds a measure for whether the contract was cost-based or fixed-price. Prior CSIS research has found that fixed-price contracts do face a higher risk of termination across the board.

###Model 04A: Fixed-Price Numerical
```{r Model04A}

#Frequency Plot
summary_discrete_plot(smp,"FxCb")


#Create the model
CBre_Cons_03D <- glm (data=smp,
                 b_CBre ~cl_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   cl_HHI_lag1:cl_Ceil  + #cl_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_Ceil+
                FxCb, family=binomial(link="logit"))
display(CBre_Cons_03D)

CBre_Comp_04A <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   n_Fixed +
                   #cl_HHI_lag1:cl_Ceil  + 
                 Veh:cl_Days++
                   
                   Veh:cl_Ceil,
                 family=binomial(link="logit"))
display(CBre_Comp_04A)

# Plot the model and Vehicle 
CBre_Comp_04A_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(CBre_Comp_04A))}

#Competition curves
fitted_cbre_model(smp,"SIDV") +
  stat_function(fun = CBre_Comp_04A_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
  stat_function(fun = CBre_Comp_04A_curve,
                             args=list(Comp=2,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_Comp_04A)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_Comp_04A)+
  labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot(CBre_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```

And fixed price contracts do indeed have a significant coefficient that correlates with higher termination risk. In addition, the addition of this variable reduces the pattern in the residuals that in the middle range. 



###Model 04B: Fixed-Price
```{r Model04B}

#Frequency Plot
summary_discrete_plot(smp,"FxCb")


#Create the model
CBre_Cons_03D <- glm (data=smp,
                 b_CBre ~cl_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   cl_HHI_lag1:cl_Ceil  + #cl_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_Ceil+
                FxCb, family=binomial(link="logit"))
display(CBre_Cons_03D)

CBre_Comp_04B <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   n_Fixed +
                   #cl_HHI_lag1:cl_Ceil  + 
                 Veh:cl_Days++
                   
                   Veh:cl_Ceil,
                 family=binomial(link="logit"))
display(CBre_Comp_04B)

# Plot the model and Vehicle 
# CBre_Comp_04B_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(CBre_Comp_04A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_04A_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_04A_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_cbre_residuals(CBre_Comp_04A)
# 
# #Plot residuals versus fittedO
# residuals_cbre_plot(CBre_Comp_04A)+
#   labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot(CBre_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```

And fixed price contracts do indeed have a significant coefficient that correlates with higher termination risk. In addition, the addition of this variable reduces the pattern in the residuals that in the middle range. 


###Model 04B: Fixed-Price and Maximum Duration Intersection 
Past CSIS research has found that fixed-price contracts do appear to be at higher risk if they have a longer maximum duration. Fixed-price contracting does require upfront estimation of likely costs, and thus a longer duration means more opportunity for changed circumstance.

```{r Model04B_Term}

#Frequency Plot
freq_continuous_term_plot(smp,"l_Days","FxCb")

#Percent Terminated Plot 
binned_percent_term_plot(smp,"l_Days","FxCb")


#Create the model
Term_Comp_04B <- glm (data=smp,
                 b_Term ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh + 
                   #cl_HHI_lag1:cl_Ceil  + 
                   #cl_HHI_lag1:cl_Days +
                   n_Fixed +
                   Veh:cl_Days+
                   Veh:n_Comp +
                   cl_Days:n_Fixed , family=binomial(link="logit"))
display(Term_Comp_04B)

# Plot the model and Vehicle 
Term_Comp_04B_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV,
        Days*x) %*%  coef(Term_Comp_04B))}

#Days curves
discrete_fitted_term_model(smp,"SIDV") +
  stat_function(fun = Term_Comp_04B_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0),color="blue")+
  stat_function(fun = Term_Comp_04B_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,OIDV=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_residuals(Term_Comp_04B)

#Plot residuals versus fittedO
residuals_term_plot(Term_Comp_04B)+
  labs(x="Estimated  Pr (Termination)")

# residuals_term_plot(Term_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```

```{r Model04B_CBre}

#Frequency Plot
summary_continuous_plot(smp,"l_Days","FxCb")

#Create the model
CBre_Comp_04B <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   n_Fixed +
                   #cl_HHI_lag1:cl_Ceil  + 
                 Veh:cl_Days++
                   
                   Veh:cl_Ceil+
                   cl_Ceil:n_Fixed , 
                 family=binomial(link="logit"))
display(CBre_Comp_04B)

# Plot the model and Vehicle 
CBre_Comp_04B_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV,
        Days*x) %*%  coef(CBre_Comp_04B))}

#Days curves
fitted_cbre_model(smp,"SIDV") +
  stat_function(fun = CBre_Comp_04B_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
  stat_function(fun = CBre_Comp_04B_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_Comp_04B)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_Comp_04B)+
  labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot(CBre_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```
The probability of termination by duration chart is more clearcut with fixed price than with cost-based contracts. However, the variable does not appreciably decrease the deviation, is not significant, and undercuts the significance of other variables. It will not be added tto the model.


###Model 04C: Fixed-Price and Vehicle
```{r Model04C_Term}

#Frequency Plot
summary_discrete_plot(smp,"FxCb","Veh")

#Create the model
Term_Comp_04C <- glm (data=smp,
                 b_Term ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh + 
                   n_Fixed +
                   #cl_HHI_lag1:cl_Ceil  + 
                   #cl_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:n_Comp +
                   Veh:n_Fixed, family=binomial(link="logit"))
display(Term_Comp_04C)

# Plot the model and Vehicle for SIDV
Term_Comp_04C_curve<-function(x, Comp,Ceil,Days,MIDV,OIDV){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        n_Fixed,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Days*SIDV,Days*MIDV,Days*OIDV,
        Comp*SIDV,Comp*MIDV,Comp*OIDV,
        x*SIDV,x*MIDV,x*OIDV
        ) %*%  coef(Term_Comp_04C))}

#Vehicle curves
discrete_fitted_term_model(smp,"n_Fixed") +
  stat_function(fun = Term_Comp_04C_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       SIDV=1,MIDV=0,OIDV=0),color="blue")+
  stat_function(fun = Term_Comp_04C_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       SIDV=0,MIDV=1,OIDV=0),color="blue")+
  stat_function(fun = Term_Comp_04C_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       SIDV=0,MIDV=0,OIDV=1),color="blue")

#Plot the fitted values vs actual results
binned_fitted_versus_residuals(Term_Comp_04C)

#Plot residuals versus fittedO
residuals_term_plot(Term_Comp_04C)+
  labs(x="Estimated  Pr (Termination)")

# residuals_term_plot(Term_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```


```{r Model04C_Comp}

#Frequency Plot
summary_discrete_plot(smp,"FxCb","Veh")

#Create the model
CBre_Comp_04C <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   n_Fixed +
                   #cl_HHI_lag1:cl_Ceil  + 
                 Veh:cl_Days++
                   
                   Veh:cl_Ceil+
                   Veh:n_Fixed, family=binomial(link="logit"))
display(CBre_Comp_04C)

# Plot the model and Vehicle for SIDV
CBre_Comp_04C_curve<-function(x, Comp,Ceil,Days,MIDV,OIDV){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        n_Fixed,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Days*SIDV,Days*MIDV,Days*OIDV,
        Comp*SIDV,Comp*MIDV,Comp*OIDV,
        x*SIDV,x*MIDV,x*OIDV
        ) %*%  coef(CBre_Comp_04C))}

#Vehicle curves
fitted_cbre_model(smp,"n_Fixed") +
  stat_function(fun = CBre_Comp_04C_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       SIDV=1,MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
  stat_function(fun = CBre_Comp_04C_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       SIDV=0,MIDV=1,FSSGWAC=0,BPABOA=0),color="blue")+
  stat_function(fun = CBre_Comp_04C_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       SIDV=0,MIDV=0,OIDV=1),color="blue")

#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_Comp_04C)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_Comp_04C)+
  labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot(CBre_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```
The interactions are not significant and do little to reduce the residual deviance. They will not be added to the model.


###Model 04D: Incentive Fees

In the performance of the defense acquisition system report, the benefits found were reduced cost overruns. That could help avoid terminations, but it's an indirect connection at best. Unfortunately, incentive fees are incredibly rare, which makes them challenging to examine directly.


```{r Model04D_Term}

#Frequency Plot
summary_discrete_plot(smp,"Fee")



#Create the model
Term_Comp_04D <- glm (data=smp,
                 b_Term ~n_Comp + 
                   cl_Ceil + cl_Days+ clsqr_Ceil + clsqr_Days +
                   Veh + 
                   #cl_HHI_lag1:cl_Ceil  + 
                   #cl_HHI_lag1:cl_Days +
                   n_Fixed + n_Incent + n_NoFee +
                   Veh:cl_Days+
                   Veh:n_Comp 
                    , family=binomial(link="logit"))
display(Term_Comp_04D)

# Plot the model and Vehicle 
Term_Comp_04D_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(Term_Comp_04D))}

#Days curves
discrete_fitted_term_model(smp,"n_Incent") +
  stat_function(fun = Term_Comp_04D_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0,Fixed=1),color="blue")+
  stat_function(fun = Term_Comp_04D_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,OIDV=0,Fixed=1),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_residuals(Term_Comp_04D)

#Plot residuals versus fittedO
residuals_term_plot(Term_Comp_04D)+
  labs(x="Estimated  Pr (Termination)")

# residuals_term_plot(Term_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```

```{r Model04D_CBre}

#Frequency Plot
summary_discrete_plot(smp,"Fee")



#Create the model
CBre_Comp_04D <- glm (data=smp,
    b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   n_Fixed +
                   #cl_HHI_lag1:cl_Ceil  + 
      n_Fixed + n_Incent + n_NoFee +

                 Veh:cl_Days++
                   
                   Veh:cl_Ceil                                  
                    , family=binomial(link="logit"))
display(CBre_Comp_04D)

# Plot the model and Vehicle 
CBre_Comp_04D_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(CBre_Comp_04D))}

#Days curves
fitted_cbre_model(smp,"n_Incent") +
  stat_function(fun = CBre_Comp_04D_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,Fixed=1),color="blue")+
  stat_function(fun = CBre_Comp_04D_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,Fixed=1),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_Comp_04D)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_Comp_04D)+
  labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot(CBre_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```

The effect of incentive fees are not significant. They do have a noteworthy coefficient, however, given prior research on their ability to prevent cost overruns, their lowered heightened probably of terminations lacks an immdetiate explaintation. There's also a fair amount of unlabeled data, which reduces the samplle size. It's still worth checking the interaction with fixed price, as they are based on a common field in FPDS and the two are closely related in concept.


###Model 04E: Incentive Fees and Fixed-Price  

```{r Model04E_Term}

#Frequency Plot
summary_discrete_plot(smp,"Fee","FxCb")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))



#Create the model
Term_Comp_04E <- glm (data=smp,
                 b_Term ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh + 
                   #cl_HHI_lag1:cl_Ceil  +
                   #cl_HHI_lag1:cl_Days +
                   n_Fixed + n_Incent + 
                   Veh:cl_Days+
                   Veh:n_Comp +
                   n_Fixed:n_Incent
                    , family=binomial(link="logit"))
display(Term_Comp_04E)

# Plot the model and Vehicle 
Term_Comp_04E_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV,
        x*Fixed) %*%  coef(Term_Comp_04E))}

#Days curves
discrete_fitted_term_model(smp,"SIDV") +
  stat_function(fun = Term_Comp_04E_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=0),color="blue")+
  stat_function(fun = Term_Comp_04E_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_residuals(Term_Comp_04E)

#Plot residuals versus fittedO
residuals_term_plot(Term_Comp_04E)+
  labs(x="Estimated  Pr (Termination)")

# residuals_term_plot(Term_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```

```{r Model04E_CBre}

#Frequency Plot
summary_discrete_plot(smp,"Fee","FxCb")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))




#Create the model
CBre_Comp_04E <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_HHI_lag1:cl_Ceil  +
                   Veh:cl_Ceil +
                   n_Fixed + n_Incent + 
                   Veh:cl_Days++
                    Veh:cl_Ceil+
                   n_Fixed:n_Incent
                    , family=binomial(link="logit"))
display(CBre_Comp_04E)

# Plot the model and Vehicle 
CBre_Comp_04E_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV,
        x*Fixed) %*%  coef(CBre_Comp_04E))}

#Days curves
fitted_cbre_model(smp,"SIDV") +
  stat_function(fun = CBre_Comp_04E_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
                                       Fixed=0),color="blue")+
  stat_function(fun = CBre_Comp_04E_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
                                       Fixed=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_Comp_04E)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_Comp_04E)+
  labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot(CBre_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```
Looking at Incentive Fees and Fixed-Price interactions undercuts the significance of both base variables. Incentive will not be added to the model.

###Model 04F: Undefinitized Contract Awards
Undefinitized Contract Awards allow for quick action in situations where there is not time or information to establish all of a contracts properties at the time of signing. They have been found by the GAO and the Performance of the Defense Acquisition studies to contain notable risks, primarily relating to cost overruns and thus ceiling breaches. Will these risks also carry into terminations and ceiling breaches?


```{r Model04F_CBre}

#Frequency Plot
summary_discrete_plot(smp,"UCA")



#Create the model
CBre_Comp_04F <- glm (data=smp,
b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   n_Fixed + b_UCA +
                   #cl_HHI_lag1:cl_Ceil  + 
                 Veh:cl_Days+
                   
                   Veh:cl_Ceil+
, family=binomial(link="logit"))
display(CBre_Comp_04F)

# Plot the model and Vehicle 
CBre_Comp_04F_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(CBre_Comp_04F))}

#Days curves
fitted_cbre_model(smp,"SIDV") +
  stat_function(fun = CBre_Comp_04F_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
                                       Fixed=1),color="blue")+
  stat_function(fun = CBre_Comp_04F_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
                                       Fixed=1),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_Comp_04F)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_Comp_04F)+
  labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot(CBre_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```


###Model 04G: UCA and Competition
```{r Model04G_Comp}

#Frequency Plot
summary_discrete_plot(smp,"UCA","n_Comp")




#Create the model

CBre_Cons_04G <- glm (data=smp,
b_CBre ~cl_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   n_Fixed + b_UCA +
                   cl_HHI_lag1:cl_Ceil  +
                 Veh:cl_Days+
                   Veh:cl_HHI_lag1  +
                   Veh:cl_Ceil+
  # b_UCA:cl_Ceil+
                b_UCA:n_Comp
                    , family=binomial(link="logit"))
display(CBre_Cons_04G)

CBre_Comp_04G <- glm (data=smp,
b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   n_Fixed + b_UCA +
                 Veh:cl_Days+
                   
                   Veh:cl_Ceil+
  # b_UCA:cl_Ceil+
                b_UCA:n_Comp
                    , family=binomial(link="logit"))
display(CBre_Comp_04G)



# Plot the model and Vehicle 
CBre_Comp_04G_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(CBre_Comp_04G))}

#Days curves
fitted_cbre_model(smp,"SIDV") +
  stat_function(fun = CBre_Comp_04G_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
                                       Fixed=1),color="blue")+
  stat_function(fun = CBre_Comp_04G_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
                                       Fixed=1),color="blue")


summary_residual_compare(CBre_Cons_04G,CBre_Cons_04G,CBre_Comp_04G,CBre_Comp_04G,bins=20)

```
The interaction of UCA and Comp does align with the findings of the GAO as to the heightened risk of uncompeted UCA. However, the results are not significant. 






###Model 04H: UCA and Duration


```{r Model04H_Term}

#Frequency Plot
freq_continuous_term_plot(smp,"l_Days","UCA")

#Percent Terminated Plot 
binned_percent_term_plot(smp,"l_Days","UCA")


#Create the model
Term_Comp_04H <- glm (data=smp,
                 b_Term ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh + 
                   #cl_HHI_lag1:cl_Ceil  +
                   #cl_HHI_lag1:cl_Days +
                   n_Fixed + b_UCA + 
                   Veh:cl_Days+
                   Veh:n_Comp +
                   b_UCA:n_Comp + 
                  b_UCA:l_Days
                    , family=binomial(link="logit"))
display(Term_Comp_04H)

# Plot the model and Vehicle 
Term_Comp_04H_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV,
        Comp*x,Days*x) %*%  coef(Term_Comp_04H))}

#Days curves
discrete_fitted_term_model(smp,"SIDV") +
  stat_function(fun = Term_Comp_04H_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1),color="blue")+
  stat_function(fun = Term_Comp_04H_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_residuals(Term_Comp_04H)

#Plot residuals versus fittedO
residuals_term_plot(Term_Comp_04H)+
  labs(x="Estimated  Pr (Termination)")

# residuals_term_plot(Term_Comp_02F,"cl_days")+
  # labs(x="Centered Log(Days)")

```





##Place of Performance
###Model 05A: Any International


```{r Model05A_Comp}

#Frequency Plot
summary_discrete_plot(smp,"Intl")



#Create the model
CBre_Comp_05A <- glm (data=smp,
b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   n_Fixed + b_UCA +
                   #cl_HHI_lag1:cl_Ceil  + 
  b_Intl+
                 Veh:cl_Days++
                   
                   Veh:cl_Ceil+
  b_UCA:cl_Ceil+
                b_UCA:n_Comp
                    , family=binomial(link="logit"))
display(CBre_Comp_05A)

# Plot the model and Vehicle 
CBre_Comp_05A_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,UCA,x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV,
        UCA*Comp) %*%  coef(CBre_Comp_05A))}

#Days curves
fitted_cbre_model(smp,"SIDV") +
  stat_function(fun = CBre_Comp_05A_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
                                       Fixed=1,UCA=0),color="blue")+
  stat_function(fun = CBre_Comp_05A_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
                                       Fixed=1,UCA=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_Comp_05A)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_Comp_05A)+
  labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot(CBre_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```

International performance of contract unexpectedly had a negative coefficent. It is a variable of interest  to the study and will be left in.


###Model 05B: Fixed Price and Any International


###Model 05C: Vehicle and Any International

```{r Model05C}

#Frequency Plot
summary_discrete_plot(smp,"Intl","Veh")



#Create the model
Term_Comp_05C <- glm (data=smp,
                 b_Term ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh + 
                   #cl_HHI_lag1:cl_Ceil  + 
                   #cl_HHI_lag1:cl_Days +
                   n_Fixed + b_UCA + 
                   b_Intl + 
                   Veh:cl_Days+
                   Veh:n_Comp +
                   b_UCA:n_Comp+
                   Veh:b_Intl+
                    , family=binomial(link="logit"))
display(Term_Comp_05C)

# Plot the model and Vehicle 
Term_Comp_05C_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,UCA,x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV,
        UCA*Comp) %*%  coef(Term_Comp_05C))}

#Days curves
discrete_fitted_term_model(smp,"SIDV") +
  stat_function(fun = Term_Comp_05C_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0),color="blue")+
  stat_function(fun = Term_Comp_05C_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_residuals(Term_Comp_05C)

#Plot residuals versus fittedO
residuals_term_plot(Term_Comp_05C)+
  labs(x="Estimated  Pr (Termination)")

# residuals_term_plot(Term_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```


##Who
Adding who resulted in a range of models that failed to converge. The one exception was combining Product/Service/R&D alone and Who, which did require removing multiple interactions from the model before convergence could be reached, but did allow the continued inclusion of  the combination of Product/Service/R&D and competition. All other models have been commented out to allow for the Markdown file  to  be created in a manageable amount of time. The study team initially considered using start year or contracting office identity as additional non-nested levels. However, those models failed to converge or had eigenvalue related challenges. As a result, the study team chose to focus on the question of what is being acquired. Who is acquiring is instead being handled by individual dummy variables or group level summary variables where appropriate, but not by seperate intercepts or slopes. Start year is not included in the model because of the complicatitons related to durations. Namely longer duration contracts from recent years have not yet had the opportunity to live out their natural life span. This means  that recent years will have an artificially high termination rate for longer contracts, because we only know about those that ended before their maximum duration, often due to termination.


###Model 06A: Sub Customer 
Other DoD stands out for its sheer quantity of contracts and task orders and also its lower termination rate. It includes the DLA which specializes in logistic delivery, and may thus estimate a lower rate of ceiling breahces.
```{r Model06A}

smp$Who[smp$Who=="Uncategorized"]<-NA
#Frequency Plot
summary_discrete_plot(smp,"Who",rotate_text=TRUE)

smp$b_ODoD<-smp$Who
levels(smp$b_ODoD)<- list("1"=c("Other DoD"), 
                                "0"=c("Air Force","Army","Navy"))
smp$b_ODoD<-as.integer(as.character(smp$b_ODoD))
summary_discrete_plot(smp,"b_ODoD",rotate_text=TRUE)


# Plot the model and Vehicle 
Term_Comp_06A_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA,Intl){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,UCA,Intl,x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV,
        UCA*Comp) %*%  coef(Term_Comp_06A))}

#Days curves
discrete_fitted_term_model(smp,"b_ODoD") +
  stat_function(fun = Term_Comp_06A_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0,Intl=0),color="blue")+
  stat_function(fun = Term_Comp_06A_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0,Intl=0),color="blue")





CBre_Cons_06A <- glm(data=smp,
                 b_CBre ~cl_HHI_lag1 +
                   cl_Ceil + cl_Days+
                   Veh +
                   n_Fixed + b_UCA +
                   b_Intl +
                   Who
                  , family=binomial(link="logit"))
display(CBre_Cons_06A)
glmer_examine(CBre_Cons_06A)


CBre_Comp_06A <- glm(data=smp,
                 b_CBre ~n_Comp +
                   cl_Ceil + cl_Days+
                   Veh +
                   n_Fixed + b_UCA +
                   b_Intl +
                   Who
                  , family=binomial(link="logit"))
display(CBre_Comp_06A)
glmer_examine(CBre_Comp_06A)


  stargazer::stargazer(CBre_Cons_06A,CBre_Comp_06A,type="text",
                       digits=2)
  
summary_residual_compare(CBre_Cons_04G,CBre_Cons_06A,CBre_Comp_04G,CBre_Comp_06A,bins=20)



```

After inclusion of DLA, the Competition correlates significantly predicts a greater risk of termination. Studying that interaction will be our next step.

###Model 06B: Other DoD
```{r Model06A}


smp$ODoD<-smp$Who
levels(smp$ODoD)<- list("Military Departments"=c("Air Force","Army","Navy"),
                          "Other DoD"=c("Other DoD"))
summary_discrete_plot(smp,"ODoD",rotate_text=TRUE)


# Plot the model and Vehicle 
Term_Comp_06A_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA,Intl){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,UCA,Intl,x,
        Days*x,Days*MIDV,Days*OIDV,
        Comp*x,Comp*MIDV,Comp*OIDV,
        UCA*Comp) %*%  coef(Term_Comp_06A))}

#Days curves
discrete_fitted_term_model(smp,"b_ODoD") +
  stat_function(fun = Term_Comp_06A_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0,Intl=0),color="blue")+
  stat_function(fun = Term_Comp_06A_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0,Intl=0),color="blue")





CBre_Cons_06B <- glm(data=smp,
                 b_CBre ~cl_HHI_lag1 +
                   cl_Ceil + cl_Days+
                   Veh +
                   n_Fixed + b_UCA +
                   b_Intl +
                   ODoD
                  , family=binomial(link="logit"))
display(CBre_Cons_06B)
glmer_examine(CBre_Cons_06B)


CBre_Comp_06B <- glm(data=smp,
                 b_CBre ~n_Comp +
                   cl_Ceil + cl_Days+
                   Veh +
                   n_Fixed + b_UCA +
                   b_Intl +
                   ODoD
                  , family=binomial(link="logit"))
display(CBre_Comp_06B)
glmer_examine(CBre_Comp_06B)


  stargazer::stargazer(CBre_Cons_06A,CBre_Cons_06B,CBre_Comp_06A,CBre_Comp_06B,type="text",
                       digits=2)
  
summary_residual_compare(CBre_Cons_06A,CBre_Cons_06B,CBre_Comp_06A,CBre_Comp_06B,bins=20)



```

After inclusion of Other DoD, the Competition correlates significantly predicts a greater risk of termination. Studying that interaction will be our next step.


### Model 06C: Other DoD & Competition
Because DLA deals more in commodities, Other DoD estimates a lower rate of ceiling breaches.

```{r Model06C}

#Frequency Plot
summary_discrete_plot(smp,"EffComp","ODoD",rotate_text=TRUE)
summary_continuous_plot(smp,"cl_HHI_lag1","ODoD",rotate_text=TRUE)



CBre_Cons_06C <- glm(data=smp,
                 b_CBre ~cl_HHI_lag1 +
                   cl_Ceil + cl_Days+
                   Veh +
                   n_Fixed + b_UCA +
                   b_Intl +
                   ODoD + ODoD:cl_HHI_lag1
                  , family=binomial(link="logit"))
display(CBre_Cons_06C)
glmer_examine(CBre_Cons_06A)


CBre_Comp_06C <- glm(data=smp,
                 b_CBre ~n_Comp +
                   cl_Ceil + cl_Days+
                   Veh +
                   n_Fixed + b_UCA +
                   b_Intl +
                   ODoD + ODoD:n_Comp
                  , family=binomial(link="logit"))
display(CBre_Comp_06C)
glmer_examine(CBre_Comp_06C)


  stargazer::stargazer(CBre_Cons_06A,CBre_Cons_06B,CBre_Cons_06C,CBre_Comp_06A,CBre_Comp_06B,CBre_Comp_06C,type="text",
                       digits=2)
  
summary_residual_compare(CBre_Cons_06B,CBre_Cons_06C,CBre_Comp_06B,CBre_Comp_06C,bins=20)
summary_residual_compare(CBre_Cons_06A,CBre_Cons_06C,CBre_Comp_06A,CBre_Comp_06C,bins=20)
```
VIF is exceeded for competition but not consolidation. 

##What
### Model 10A: NAICS
```{r Model10A}
corrdisp<-Hmisc::rcorr(
  as.matrix(cbind(subset(crisis_smp, select=c(b_UCA,c_OffCri,cl_Ceil,
                                              cl_Days,n_Fixed,b_Intl)),
                  dummies::dummy(crisis_smp$Crisis),
                  dummies::dummy(crisis_smp$NoComp),
                  dummies::dummy(crisis_smp$Reach),
                  dummies::dummy(crisis_smp$Veh),
                  dummies::dummy(crisis_smp$Is.Defense),
                  dummies::dummy(crisis_smp$Simple))))
corrdisp[[1]]

#Sumamry plot
summary_discrete_plot(smp1m,"NAICS2",rotate_text=TRUE)

#Create the model
CBre_Cons_10A <- glm(data=smp,
                       b_CBre ~cl_HHI_lag1 + 
                         cl_Ceil + cl_Days+
                         Veh+
                         # cl_HHI_lag1:cl_Ceil  + cl_Ceil:cl_Days  +
                       # cl_HHI_lag1:cl_Days +
                         n_Fixed + b_UCA +
                         b_Intl +
                         # Veh:cl_Days +
                         # Veh:cl_HHI_lag1+
                         # b_UCA:cl_HHI_lag1+
                         NAICS2
                       , family=binomial(link="logit"))
display(CBre_Cons_10A)
glmer_examine(CBre_Cons_10A)
  
CBre_Comp_10A <- glm(data=smp,
                       b_CBre ~n_Comp + 
                         cl_Ceil + cl_Days+
                         Veh+
                         # n_Comp:cl_Ceil  + cl_Ceil:cl_Days  +
                       # n_Comp:cl_Days +
                         n_Fixed + b_UCA +
                         b_Intl +
                         # Veh:cl_Days +
                         # Veh:n_Comp+
                         # b_UCA:n_Comp+
                         NAICS2
                       , family=binomial(link="logit"))
display(CBre_Comp_10A)
glmer_examine(CBre_Comp_10A)

  stargazer::stargazer(CBre_Cons_10A,CBre_Comp_10A,type="text",
                       digits=2)
  
summary_residual_compare(CBre_Comp_10A,CBre_Comp_10A,CBre_Cons_10A,CBre_Cons_10A,bins=20)


```


### Model 10B: Comp:UCA
Starting with Competition and UCA. It's strong in both models and thus a natural starting point.
```{r Model10B}
#Sumamry plot
summary_continuous_plot(smp1m,"cl_HHI_lag1","UCA")
summary_discrete_plot(smp1m,"EffComp","UCA")

#Create the model
CBre_Cons_10B <- glm(data=smp,
                       b_CBre ~cl_HHI_lag1 + 
                         cl_Ceil + cl_Days+
                         Veh+
                         # cl_HHI_lag1:cl_Ceil  + cl_Ceil:cl_Days  +
                       # cl_HHI_lag1:cl_Days +
                         n_Fixed + b_UCA +
                         b_Intl +
                         # Veh:cl_Days +
                         # Veh:cl_HHI_lag1+
                         b_UCA:cl_HHI_lag1+
                         NAICS2
                       , family=binomial(link="logit"))
display(CBre_Cons_10B)
glmer_examine(CBre_Cons_10B)
  
CBre_Comp_10B<- glm(data=smp,
                       b_CBre ~n_Comp + 
                         cl_Ceil + cl_Days+
                         Veh+
                         # n_Comp:cl_Ceil  + cl_Ceil:cl_Days  +
                       # n_Comp:cl_Days +
                         n_Fixed + b_UCA +
                         b_Intl +
                         # Veh:cl_Days +
                         # Veh:n_Comp+
                         b_UCA:n_Comp+
                         NAICS2
                       , family=binomial(link="logit"))
display(CBre_Comp_10B)
glmer_examine(CBre_Comp_10B)

  stargazer::stargazer(CBre_Comp_10A,CBre_Comp_10B,CBre_Cons_10A,CBre_Cons_10B,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Comp_10A,CBre_Comp_10B,CBre_Cons_10A,CBre_Cons_10B,bins=20)


```
The interaction is significant and competion / low levels of consolidation estimates lower risks associated withUCAs. In diagnostic terms, the residuals for ceiling breaches get a little worse, but the change is marginal and the interaction is relevant to study questions. Keeping it.


### Model 10C: Comp/Cons:Days
The next reintroduction is competition/consolidation and days. The benefits of competition may reduce over time.
```{r Model10C}


#Sumamry plot
summary_continuous_plot(smp1m,"cl_Days","cl_HHI_lag1")
summary_continuous_plot(smp1m,"cl_Days","EffComp")

#Create the model
CBre_Cons_10C <- glm(data=smp,
                       b_CBre ~cl_HHI_lag1 + 
                         cl_Ceil + cl_Days+
                         Veh+
                         #cl_HHI_lag1:cl_Ceil  + #cl_Ceil:cl_Days  +
                       cl_HHI_lag1:cl_Days +
                         n_Fixed + b_UCA +
                         b_Intl +
                         # Veh:cl_Days +
                         # Veh:cl_HHI_lag1+
                         b_UCA:cl_HHI_lag1+
                         NAICS2
                       , family=binomial(link="logit"))
display(CBre_Cons_10C)
glmer_examine(CBre_Cons_10C)
  
CBre_Comp_10C<- glm(data=smp,
                       b_CBre ~n_Comp + 
                         cl_Ceil + cl_Days+
                         Veh+
                          #n_Comp:cl_Ceil  +# cl_Ceil:cl_Days  +
                        n_Comp:cl_Days +
                         n_Fixed + b_UCA +
                         b_Intl +
                         # Veh:cl_Days +
                         # Veh:n_Comp+
                         b_UCA:n_Comp+
                         NAICS2
                       , family=binomial(link="logit"))
display(CBre_Comp_10C)
glmer_examine(CBre_Comp_10C)

  stargazer::stargazer(CBre_Cons_10B,CBre_Cons_10C,CBre_Comp_10B,CBre_Comp_10C,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_10B,CBre_Cons_10C,CBre_Comp_10B,CBre_Comp_10C,bins=20)


```

This combination has a marginal affect on reducing deviance and encounters VIF problems for competition Leaving it out.


### Model 10D: Comp/Cons:Ceiling
The next reintroduction is competition and ceiling. Competition and ceiling might have a negative coefficient, because large contracts might encourage bid to win approaches. 
```{r Model10D}


#Sumamry plot
summary_continuous_plot(smp1m,"cl_Ceil","cl_HHI_lag1")
summary_continuous_plot(smp1m,"cl_Ceil","n_Comp")

#Create the model
CBre_Cons_10D <- glm(data=smp,
                       b_CBre ~cl_HHI_lag1 + 
                         cl_Ceil + cl_Days+
                         Veh+
                         cl_HHI_lag1:cl_Ceil  +
                         n_Fixed + b_UCA +
                         b_Intl +
                         # Veh:cl_Days +
                         # Veh:cl_HHI_lag1+
                         b_UCA:cl_HHI_lag1+
                         NAICS2
                       , family=binomial(link="logit"))
display(CBre_Cons_10D)
glmer_examine(CBre_Cons_10D)
  
CBre_Comp_10D<- glm(data=smp,
                       b_CBre ~n_Comp + 
                         cl_Ceil + cl_Days+
                         Veh+
                          n_Comp:cl_Ceil  +
                         n_Fixed + b_UCA +
                         b_Intl +
                         # Veh:cl_Days +
                         # Veh:n_Comp+
                         b_UCA:n_Comp+
                         NAICS2
                       , family=binomial(link="logit"))
display(CBre_Comp_10D)
glmer_examine(CBre_Comp_10D)

  stargazer::stargazer(CBre_Cons_10B,CBre_Cons_10D,CBre_Comp_10B,CBre_Comp_10D,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_10B,CBre_Cons_10D,CBre_Comp_10B,CBre_Comp_10D,bins=20)


```
This interaction runs afowl of the VIF test on the competition side. On the consolidation side, there is a significant reduction in deviance, and a reduction in outliers, though in general there remains a fairly strong pattern in the residuals. Leaving it in for consolidation


### Model 10E: Comp/Cons:Veh
The next reintroduction is competition and vehicle. Multi-award contracts in particular emphasize competition between the awardees which suggests that it may increase the benefits of competition.


```{r Model10E}


#Sumamry plot
summary_discrete_plot(smp1m,"Veh","cl_HHI_lag1")
summary_discrete_plot(smp1m,"Veh","n_Comp")

#Create the model
CBre_Cons_10E <- glm(data=smp,
                       b_CBre ~cl_HHI_lag1 + 
                         cl_Ceil + cl_Days+
                       cl_HHI_lag1:cl_Ceil+
                                                Veh:cl_HHI_lag1+
                         Veh+
                          #cl_Ceil:cl_Days  +
                         n_Fixed + b_UCA +
                                                b_UCA:cl_HHI_lag1+
                         b_Intl +
                         # Veh:cl_Days +
                         NAICS2
                       , family=binomial(link="logit"))
display(CBre_Cons_10E)
glmer_examine(CBre_Cons_10E)
  
CBre_Comp_10E<- glm(data=smp,
                       b_CBre ~n_Comp + 
                         cl_Ceil + cl_Days+
                         Veh+
                                               Veh:n_Comp+

                         # cl_Ceil:cl_Days  +
                         n_Fixed + b_UCA +
                                               b_UCA:n_Comp+

                         b_Intl +
                         # Veh:cl_Days +
                         NAICS2
                       , family=binomial(link="logit"))
display(CBre_Comp_10E)
glmer_examine(CBre_Comp_10E)

  stargazer::stargazer(CBre_Cons_10D,CBre_Cons_10E,CBre_Comp_10B,CBre_Comp_10E,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_10D,CBre_Cons_10E,CBre_Comp_10B,CBre_Comp_10E,bins=20)


```


Competition and vehicle results are interesting, but run afowl of VIF test. Consolidation doesn't add much and makes the residualsworse, leaving it  out.

### Model 10F: Veh:Days
IDVs lower the transaction costs of contracting.  This may lead to a diminishment of their  effects as their  duration grows.

```{r Model10F}


#Sumamry plot
summary_continuous_plot(smp1m,"l_Days","Veh")

#Create the model
CBre_Cons_10F <- glm(data=smp,
                       b_CBre ~cl_HHI_lag1 + 
                         cl_Ceil + cl_Days+
                       cl_HHI_lag1:cl_Ceil+
                                                # Veh:cl_HHI_lag1+
                         Veh+
                          #cl_Ceil:cl_Days  +
                         n_Fixed + b_UCA +
                                                b_UCA:cl_HHI_lag1+
                         b_Intl +
                         Veh:cl_Days +
                         NAICS2
                       , family=binomial(link="logit"))
display(CBre_Cons_10F)
glmer_examine(CBre_Cons_10F)
  
CBre_Comp_10F<- glm(data=smp,
                       b_CBre ~n_Comp + 
                         cl_Ceil + cl_Days+
                         Veh+
                         # cl_Ceil:cl_Days  +
                         n_Fixed + b_UCA +
                                               b_UCA:n_Comp+
                         b_Intl +
                         Veh:cl_Days +
                         NAICS2
                       , family=binomial(link="logit"))
display(CBre_Comp_10F)
glmer_examine(CBre_Comp_10F)

  stargazer::stargazer(CBre_Cons_10D,CBre_Cons_10F,CBre_Comp_10B,CBre_Comp_10F,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_10D,CBre_Cons_10F,CBre_Comp_10B,CBre_Comp_10F,bins=20)


```
The interaction adds fairly little to the model and makes residuals worse, leaving it out.

### Model 10F: Ceil:Days

There are two competing explainations. First, high base duration and ceiling contracts might estimate lower risks, because they give enouogh time to complete the contract. 
```{r Model10F}


#Sumamry plot
summary_continuous_plot(smp1m,"l_Days","l_Ceil")

#Create the model
CBre_Cons_10F <- glm(data=smp,
                       b_CBre ~cl_HHI_lag1 + 
                         cl_Ceil + cl_Days+
                       cl_HHI_lag1:cl_Ceil+
                       cl_Ceil:cl_Days  +
                         Veh+
                          
                         n_Fixed + b_UCA +
                        b_UCA:cl_HHI_lag1+
                         b_Intl +
                         NAICS2
                       , family=binomial(link="logit"))
display(CBre_Cons_10F)
glmer_examine(CBre_Cons_10F)
  
CBre_Comp_10F<- glm(data=smp,
                       b_CBre ~n_Comp + 
                         cl_Ceil + cl_Days+
                         Veh+
                         cl_Ceil:cl_Days  +
                         n_Fixed + b_UCA +
                        b_UCA:n_Comp+
                         b_Intl +
                         NAICS2
                       , family=binomial(link="logit"))
display(CBre_Comp_10F)
glmer_examine(CBre_Comp_10F)

  stargazer::stargazer(CBre_Cons_10D,CBre_Cons_10F,CBre_Comp_10B,CBre_Comp_10F,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_10D,CBre_Cons_10F,CBre_Comp_10B,CBre_Comp_10F,bins=20)


```
The results were significant though contrary to expectation. The reduction  in deviance is fairly minor and for consolidations makes the residuals worse. Perhaps this results happens because  contracts with a longer duration and higher base might indicate less complexity and more the delivery of something expensive.


#Multi-Level Model


###Model 08A: NAICS
The North American Industrial Classification system captures the sector of each contract, which are each given a seperate intercept in the model.
```{r Model08A}

#Frequency Plot
summary_discrete_plot(smp,"NAICS")


Term_Comp_08A <- glmer(data=smp,
                 b_Term ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh + 
                   n_Fixed + b_UCA + 
                   # b_Intl +
                   (1 | NAICS)
                  , family=binomial(link="logit"))
display(Term_Comp_08A)



#Create the model
# Term_Comp_08A <- glmer(data=smp,
#                  b_Term ~n_Comp + 
#                    cl_Ceil + cl_Days+ 
#                    Veh + 
#                    n_Fixed + b_UCA + 
#                    b_Intl + 
#                    n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days +
#                    Veh:cl_Days+
#                    Veh:n_Comp +
#                    b_UCA:n_Comp+
#                    (1 | NAICS)
#                     , family=binomial(link="logit"))
# display(Term_Comp_08A)
#Ran for two hours Model failed to converge with max|grad| = 0.186396 (tol = 0.001, component 1)
# Plot the model and Vehicle 
Term_Comp_08A_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,UCA,x,
        Days*x,Days*MIDV,Days*OIDV,
        UCA*Comp) %*%  coef(Term_Comp_08A))}

#Days curves
discrete_fitted_term_model(smp,"SIDV") +
  stat_function(fun = Term_Comp_08A_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0),color="blue")+
  stat_function(fun = Term_Comp_08A_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_residuals(Term_Comp_08A)

#Plot residuals versus fittedO
residuals_term_plot(Term_Comp_08A)+
  labs(x="Estimated  Pr (Termination)")

# residuals_term_plot(Term_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```

The initial attempt to include the pre-existing intercepts and all inputs resulted in a model that initially failed to converge. Conservatively the intercepts have been temporarily removed to be added back in a subsequent step.



Unfortunately, after including Start Fiscal Year, the model again failed to converge. The standard deviation of Who is 0 while it is notably higher for determining the slope of competition via PSR and for Start Fiscal Year. This suggests that who is adding little to the model and that it is time to go back to model 6C as a starter.


```{r Model08A}

#Frequency Plot
summary_discrete_plot(smp,"NAICS2")


CBre_Comp_08A <- glmer(data=smp,
b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   n_Fixed + b_UCA +
                   n_Comp:cl_Ceil  + 
                 Veh:cl_Days++
                   
                   Veh:cl_Ceil+
  b_UCA:cl_Ceil+
                b_UCA:n_Comp+
                   (1 | NAICS2)
                  , family=binomial(link="logit"))
display(CBre_Comp_08A)



#Create the model
# CBre_Comp_08A <- glmer(data=smp,
#                  b_CBre ~n_Comp + 
#                    cl_Ceil + cl_Days+ 
#                    Veh +
#                    n_Fixed + b_UCA + 
#                    b_Intl + 
#                    n_Comp:cl_Ceil  Veh:cl_Ceil +
#                    Veh:cl_Days++
#                    Veh:n_Comp+
#                    b_UCA:n_Comp+
#                    (1 | NAICS)
#                     , family=binomial(link="logit"))
# display(CBre_Comp_08A)
#Ran for two hours Model failed to converge with max|grad| = 0.186396 (tol = 0.001, component 1)
# Plot the model and Vehicle 
CBre_Comp_08A_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,UCA,x,
        Days*x,Days*MIDV,Days*OIDV,
        UCA*Comp) %*%  coef(CBre_Comp_08A))}

#Days curves
fitted_cbre_model(smp,"SIDV") +
  stat_function(fun = CBre_Comp_08A_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
                                       Fixed=1,UCA=0),color="blue")+
  stat_function(fun = CBre_Comp_08A_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
                                       Fixed=1,UCA=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_Comp_08A)

#Plot residuals versus fittedO
residuals_cbre_plot(CBre_Comp_08A)+
  labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot(CBre_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")
save("Comp_CBre.Rdata","")
```

The initial attempt to include the pre-existing intercepts and all inputs resulted in a model that initially failed to converge. Conservatively the intercepts have been temporarily removed to be added back in a subsequent step.



Unfortunately, after including Start Fiscal Year, the model again failed to converge. The standard deviation of Who is 0 while it is notably higher for determining the slope of competition via PSR and for Start Fiscal Year. This suggests that who is adding little to the model and that it is time to go back to model 6C as a starter.



###Model 08B: Product/Service/R&D and Platform
```{r Model08B}

#Frequency Plot
summary_discrete_plot(smp,"PSR_What",rotate_text=TRUE)



#Create the model
Term_Comp_08B <- glmer(data=Term_Comp_smp1m,
                 b_Term ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh + 
                   n_Fixed + b_UCA + 
                   Veh:cl_Days+
                   # Veh:n_Comp +
                   # b_Intl +
                  # n_Comp:cl_Ceil + #+ cl_Ceil:cl_Days  + n_Comp:cl_Days +
                   (1 | NAICS)
                  , family=binomial(link="logit"))
display(Term_Comp_08B)
#Model failed to converge with max|grad| = 0.00858407 (tol = 0.001, component 1)
# Term_Comp_08B <- glmer(data=smp,
#                  b_Term ~n_Comp + 
#                    cl_Ceil + cl_Days+ 
#                    Veh + 
#                    n_Comp:cl_Ceil  +
#                    # cl_Ceil:cl_Days  + 
#                    n_Comp:cl_Days +
#                    n_Fixed + b_UCA + 
#                    b_Intl + 
#                    Veh:cl_Days+
#                    Veh:n_Comp +
#                    b_UCA:n_Comp+
#                    (1 | PSR) + (1 | PSR_What)
#                     , family=binomial(link="logit"))
# display(Term_Comp_08B)

# Plot the model and Vehicle 
# Term_Comp_08B_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,UCA,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         UCA*Comp) %*%  coef(Term_Comp_08B))}
# save(Term_Comp_08B,file="Term08B.Rdata")
load("Term08B.Rdata")
#Days curves
discrete_fitted_term_model(smp,"SIDV") +
  stat_function(fun = Term_Comp_08B_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0),color="blue")+
  stat_function(fun = Term_Comp_08B_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0),color="blue")

#Plot the fitted values vs actual results
binned_fitted_versus_residuals(Term_Comp_08B)

#Plot residuals versus fittedO
residuals_term_plot(Term_Comp_08B)+
  labs(x="Estimated  Pr (Termination)")

# residuals_term_plot(Term_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")



```
After the incorporation of NAICS intercepts, ceiling related interactions had strange consequences (left out for speed of running RMD reasons). The interaction of Competition and Ceiling, even when introduced alone  had a positive coefficient and removed the effect of Ceiling by itself. When all three interactions were included,  Ceiling and Duration similarly had a notable negative coefficient, which seemed contrary to past literature that suggests greater risks when trying to do a large contract too fast. The interaction of competition and days had a positive coefficient, but was not significant. Single Award IDV does have a significant negative coefficient in interaction with Competition, but the other two types do not and the model fails to converge (with the 250k or 1m sample) and exhibit a peak at the lower end of the residuals.
###Model 08C: Interactions
```{r Model 6 Exploration}
#, fig.height = 10, fig.width = 6.5
#Effective Competition
#Frequency Plot
summary_discrete_plot(smp,"PSR_What","EffComp",rotate_text=TRUE)

#Percent Terminated Plot 
summary_discrete_plot(smp,"EffComp","PSR",rotate_text=TRUE)

summary_discrete_plot(smp,"EffComp","What",rotate_text=TRUE)

summary_discrete_plot(smp,"EffComp","PSR_What",rotate_text=TRUE)


#Effective Competition
#Frequency Plot
summary_discrete_plot(smp,"PSR_What","Veh",rotate_text=TRUE)

#Percent Terminated Plot 
summary_discrete_plot(smp,"Veh","PSR",rotate_text=TRUE)

summary_discrete_plot(smp,"Veh","What",rotate_text=TRUE)

summary_discrete_plot(smp,"Veh","PSR_What",rotate_text=TRUE)

#FxCb
#Frequency Plot
summary_discrete_plot(smp,"PSR_What","FxCb",rotate_text=TRUE)

#Percent Terminated Plot 
summary_discrete_plot(smp,"FxCb","PSR",rotate_text=TRUE)

summary_discrete_plot(smp,"FxCb","What",rotate_text=TRUE)

summary_discrete_plot(smp,"FxCb","PSR_What",rotate_text=TRUE)


Term_Comp_08C <- glmer(data=Term_Comp_smp1m,
                 b_Term ~n_Comp +
                   cl_Ceil + cl_Days+
                   Veh + 
                   # n_Comp:cl_Ceil  +
                   # cl_Ceil:cl_Days  +
                   # n_Comp:cl_Days +
                   n_Fixed + b_UCA +
                   # b_Intl +
                   # Veh:cl_Days+
                   # Veh:n_Comp +
                   b_UCA:n_Comp+
                   (1 | NAICS)
                    , family=binomial(link="logit"))
display(Term_Comp_08C)
save(Term_Comp_08C,file="Term08C.Rdata")

Term_Comp_08D <- glmer(data=smp,
                 b_Term ~ n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh + 
                   n_Comp:cl_Ceil  +
                   # cl_Ceil:cl_Days  + 
                   n_Comp:cl_Days +
                   n_Fixed + b_UCA + 
                   b_Intl + 
                   Veh:cl_Days+
                   Veh:n_Comp +
                   b_UCA:n_Comp+
                   (1  | PSR) + (1 + n_Comp| PSR_What)
                    , family=binomial(link="logit"))
display(Term_Comp_08D)

#Plot the fitted values vs actual results
binned_fitted_versus_residuals(Term_Comp_08C)


#Plot residuals versus fittedO
residuals_term_plot(Term_Comp_08C)+
  labs(x="Estimated  Pr (Termination)")


# Term_Comp_08E <- glmer(data=smp,
#                  b_Term ~ n_Comp + 
#                    cl_Ceil + cl_Days+ 
#                    Veh + 
#                    n_Comp:cl_Ceil  +
#                    # cl_Ceil:cl_Days  + 
#                    n_Comp:cl_Days +
#                    n_Fixed + b_UCA + 
#                    b_Intl + 
#                    Veh:cl_Days+
#                    Veh:n_Comp +
#                    b_UCA:n_Comp+
#                    (1+n_Comp  | PSR) + (1+ n_Comp | PSR_What)
#                     , family=binomial(link="logit"))
# display(Term_Comp_08E)
# failure to converge in 10000 evaluations

#Plot the fitted values vs actual results
binned_fitted_versus_residuals(Term_Comp_08C)


#Plot residuals versus fittedO
residuals_term_plot(Term_Comp_08C)+
  labs(x="Estimated  Pr (Termination)")


#Plot the fitted values vs actual results
binned_fitted_versus_residuals(Term_Comp_08D)


#Plot residuals versus fittedO
residuals_term_plot(Term_Comp_08D)+
  labs(x="Estimated  Pr (Termination)")

```
The use of Comp as 

```{r Model09A}

#Frequency Plot
summary_discrete_plot(smp,"NAICS")

#Model failed to converge with max|grad| = 0.00993991 (tol = 0.001, component 1)
Term_Comp_09A <- glmer(data=smp,
                 b_Term ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh + 
                   n_Fixed + b_UCA + 
                   b_Intl + 
                   (1 | Agency)
                  , family=binomial(link="logit"))
display(Term_Comp_09A)

#Create the model
# Term_Comp_08A <- glmer(data=smp,
#                  b_Term ~n_Comp + 
#                    cl_Ceil + cl_Days+ 
#                    Veh + 
#                    n_Fixed + b_UCA + 
#                    b_Intl + 
#                    n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days +
#                    Veh:cl_Days+
#                    Veh:n_Comp +
#                    b_UCA:n_Comp+
#                    (1 | NAICS)
#                     , family=binomial(link="logit"))
# display(Term_Comp_08A)
#Ran for two hours Model failed to converge with max|grad| = 0.186396 (tol = 0.001, component 1)
# Plot the model and Vehicle 
Term_Comp_08A_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
  cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
        Comp*Ceil,Days*Ceil,Days*Comp,
        Fixed,UCA,x,
        Days*x,Days*MIDV,Days*OIDV,
        UCA*Comp) %*%  coef(Term_Comp_08A))}

#Days curves
discrete_fitted_term_model(smp,"SIDV") +
  stat_function(fun = Term_Comp_08A_curve,
                             args=list(Comp=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0),color="blue")+
  stat_function(fun = Term_Comp_08A_curve,
                             args=list(Comp=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,OIDV=0,
                                       Fixed=1,UCA=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_residuals(Term_Comp_08A)

#Plot residuals versus fittedO
residuals_term_plot(Term_Comp_08A)+
  labs(x="Estimated  Pr (Termination)")

# residuals_term_plot(Term_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```