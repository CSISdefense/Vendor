---
title: "Contract Termination"
author: "Greg Sanders"
date: "Wednesday, February 8, 2017"
output:
  html_document:
    keep_md: yes
--- 

Modeling Likelihood of Contract Termination
============================================================================

#Setup
```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(arm)
library(R2WinBUGS)
library(Hmisc)
library(sjstats)
source("DIIGstat.r")
source("NAICS.r")

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40


```

Contracts are classified using a mix of numerical and categorical variables. While the changes in numerical variables are easy to grasp and summarize, a contract may have one line item that is competed and another that is not. As is detailed in the exploration on R&D, we are only considering information available prior to contract start. The percentage of contract obligations that were competed is a valuable benchmark, but is highly influenced by factors that occured after contract start.


## Contract Ceiling Breaches

Contract Ceiling Breaches and the number of change orders can be calculated for the entire sample.  Change orders are determined using the *Reason for Modification* field in FPDS. 


##Prepare Data
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from   FPDS.


###Data Transformations and Summary



```{r ReadInData, echo = TRUE}
 load(file="Data/defense_contract_complete.Rdata")
# head(def)
debug(transform_contract)
def<-transform_contract(def)
 # save(file="Data/transformed_def.Rdata",def)
load(file="Data/transformed_def.Rdata")
def$NAICS2<-factor(def$NAICS2)
def<-def[!colnames(def) %in% "cb_Comp"]
def<-def[!colnames(def) %in% "StartFY.1"]
```


* b_Crai is a binary variable that has a value of 1 for a ceiling Breach of any size has occured, 0 otherwise. ('r summary(def$b_Crai)
NA_stats(def,"b_Crai"))
* b_Term is a binary variable that has a value of 1 for any contracts that have experienced a partial or complete termination, 0 otherwise. ('r summary(def$b_Term)
NA_stats(def,"b_Term"))
* b_Comp is a binary variable based on competition. It has a value of 0 for uncompeted contracts and a value of 1 for competition, regardless of number of offers. 'r  summary(def$b_Comp);
NA_stats(def,"b_Comp")'
* n_Comp is a numeric variable based on competition and number of offers. It has a value of 0 for uncompeted contracts and a value of 1 for single-offer competition, and a value of 2 for multi-offer competition. 'r summary(def$n_Comp);
NA_stats(def,"n_Comp")'
* n_Offr is a numeric variable based on competition and with more granularity on number offers. It has a value of 0 for uncompeted contracts and a value of 1 for single-offer competition, and a value of 2 for 2-offers, 3 for 3-4 offers, and 4 for 5+ offers. 'r summary(def$n_Offr);
NA_stats(def,"n_Offr")'
* l_Offr is the natural log of the number of offers received. Uncompeted contracts are classified as having received one offer. 'r summary(def$l_Offr);
NA_stats(def,"l_Offr")'
* cl_Ceil is the natural log of the initial contract cost ceiling, in then-year dollars. 'r centered_log_description(def$l_Ceil,"dollars");
NA_stats(def,"l_Ceil")'
* cl_Days is the natural log of the initial maximum duration of the contract, in days. The variable is centered, by subtracting its mean ('r centered_log_description(def$l_Days,"days");
NA_stats(def,"l_Days")' 
* SIDV, MIDV, and OIDV are dummy variables based on the contract vehicle. They correspond to Single-Award IDVs, Multi-Award IDVs, and Other IDVs, respectively, having a value of 1 when the task order has that vehicle type, and having a 0 other. The remaining types, definitive contracts and purchase orders, are intentionally left out. ('r summary(def$SIDV);
summary(def$MIDV);
summary(def$OIDV);
NA_stats(def,"Veh")'
* n_Fixed is a numeric variable based on contract pricing. It has a value of 0 for cost-based, 0.5 or "combination or other", 1 for any fixed price (excluding fixed-price level of effort which is classified as cost-based). ('r summary(def$n_Fixed);
NA_stats(def,"n_Fixed")')
* n_Incent is a numeric variable based on fee type. Ig has a value. 1 for incentive fee or cost sharing, 0.5 or "combination or other", 0 for all remaining types. ('r summary(def$n_Incent);
NA_stats(def,"n_Incent")')
* b_UCA is a binary variable with a value of 1 for contracts/task orders that begin as letter contracts or undefinitized contract awards (UCA) and a value of 0 otherwise. 'r
summary(def$b_UCA);
NA_stats(def,"b_UCA")'
* b_Intl is a binary variable with a value of 1 for contracts/task orders with any transactions performed internationally and a value of 0 otherwise. 'r
summary(def$b_Intl);
NA_stats(def,"b_Intl")'
* PSR is a factor reporting whether a contract is primarily for products/services/R&D. 'r
summary(def$PSR);
NA_stats(def,"PSR")'
* ProdServ is a factor reporting the top Product or Service Code of each contract. 'r
summary(def$ProdServ);
NA_stats(def,"ProdServ")'
* NAICS is a factor reporting the top North American Industrial Classification Code of each contract. 'r
summary(def$NAICS);
NA_stats(def,"NAICS")'
* Agency is a factor reporting the top Contracting Agency of each contract. 'r
summary(def$Agency);
NA_stats(def,"Agency")'
* Office is a factor reporting the top Contracting office of each contract. 'r
summary(def$Office);
NA_stats(def,"Office")'


In addition, l_Ceil and l_Days are rescaled to have an average value of 0 and a standard deviation of one. This standardizes interpretation and prevents a "very large eigen value" error later when l_Ceil:lDay is introduced.


Next, we eliminate missing data entries and then draw a sample. The final computation uses all of the data, but as a computation shortcut, only a subset of the data is needed to allow for processing of models in minutes rather than hours.

###Computational Sample Creation
```{r Sample}
load(file="data//def_sample.Rdata")
save(smp,smp1m,file="data//def_sample.Rdata")
#Code to update sample w/o recreating.
smp<-smp["CSIScontractID"]
smp<-left_join(smp,def)
smp1m<-smp1m["CSIScontractID"]
smp1m<-left_join(smp1m,def)

  
  #Customer
  if(!"Is.Defense" %in% colnames(contract) & "Who" %in% colnames(contract)){
    contract$Is.Defense<-as.character(contract$Who)
    contract$Is.Defense[contract$Is.Defense %in%
                     c("Air Force","Army",
                       "Navy","Other DoD","Uncategorized"  )
                   ]<-"Defense"
    contract$Is.Defense<-factor(contract$Is.Defense)
    
    contract$Who[contract$Who=="Uncategorized"]<-NA
    
    #b_ODoD
    contract$b_ODoD<-contract$Who
    levels(contract$b_ODoD)<- list("1"=c("Other DoD"),
                              "0"=c("Air Force","Army","Navy"))
    
    contract$b_ODoD<-as.integer(as.character(contract$b_ODoD))
    
    contract$ODoD<-contract$Who
    levels(contract$ODoD)<- list("Military Departments"=c("Air Force","Army","Navy"),
                            "Other DoD"=c("Other DoD"))
    
    
    
    
    
  }
  contract
#}
debug(add_who)
smp<-add_who(smp)
smp1m<-add_who(smp1m)
# complete<-!is.na(def$b_Term)&
#   !is.na(def$b_CBre)&
#   !is.na(def$n_Comp)&
#   !is.na(def$l_Ceil)&
#   !is.na(def$l_Days)&
#   !is.na(def$Veh) &
#   !is.na(def$n_Fixed)&
#   !is.na(def$b_Intl)&
#   !is.na(def$b_UCA)&
#   !is.na(def$NAICS)&
#   !is.na(def$NAICS2)&
#   !is.na(def$cl_def6_HHI_lag1)&
#   !is.na(def$US6_avg_sal_lag1)
# # 
# smp<-def[complete,]
# #8818392  to 8818392
# 13057769 to 8335209
# nrow(def[!complete,])/nrow(def)
# sum(def[!complete,]$Action.Obligation,na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
# 
# smp1m<-smp[sample(nrow(smp),1000000),]
# smp<-smp[sample(nrow(smp),250000),]
# save(file="data//def_sample.Rdata",smp,smp1m)

# levels(smp$Intl)<- list("Just U.S."=c("Just U.S."), 
#                                 "Any Intl."=c("Any International"))
# levels(smp1m$Intl)<- list("Just U.S."=c("Just U.S."), 
#                                 "Any Intl."=c("Any International"))


```

#Initial Logit Model

##Study Variable: Competition
Competition has the potential to reduce terminations by giving the government more options in vendors and encouraging better behavior from the contractor that was chosen. 
###Model 01A: No Competition / Competition


```{r Model01A_CBre}

#Frequency Plot
summary_discrete_plot(smp,"Comp")

#Model
CBre_Comp_01A <- glm (data=smp,
                 b_CBre ~ cb_Comp, family=binomial(link="logit"))
glmer_examine(CBre_Comp_01A)

#Plot the new variable and coefficients
# Add the fitted regression line
fitted_cbre_model(smp,"cb_Comp") +
  stat_function(fun = fit_curve, args=list(a=coef(CBre_Comp_01A)[1],                                                        b=coef(CBre_Comp_01A)[2]),color="blue")



```
Competition alone has a very slight, but significant, negative correlation with terminations. The next step is to check alternate formulations. There's not yet enough in this model for any meaningful residual models. The next step is to look at a more detailed model, where single offer competition is broken out as a middle option between competition and no competion.



###Model 01B: Effective Competition

```{r Model01B_CBre}

#Frequency Plot
summary_discrete_plot(smp,"EffComp")


#Model
CBre_Comp_01B <- glm (data=smp,
                 b_CBre ~ n_Comp, family=binomial(link="logit"))
glmer_examine(CBre_Comp_01B)

#Plot the Fitted
#Add the fitted regression line
fitted_cbre_model(smp,"n_Comp") +
  stat_function(fun = fit_curve, args=list(a=coef(CBre_Comp_01B)[1],
                                           b=coef(CBre_Comp_01B)[2]),
                color="blue")




```


The correltion between the three categories of competition has a smaller coefficent, but is still signficant. In the next step, the multiple award competition is broken down in greater detail.



###Model 01C: No Competition / Number of Offer Categories 

```{r Model01C_CBre}

#Frequency Plot
summary_discrete_plot(smp,"CompOffr")

#Model
CBre_Comp_01C <- glm (data=smp,
                 b_CBre ~ cn_Offr, family=binomial(link="logit"))
glmer_examine(CBre_Comp_01C)

#Plot the Fitted
#Add the fitted regression line
fitted_cbre_model(smp,"n_Comp") +
  stat_function(fun = fit_curve, args=list(a=coef(CBre_Comp_01C)[1],
                                           b=coef(CBre_Comp_01C)[2]),
                color="blue")



```

As measured by residual deviance, this variable has slightly less predictive power than random noise. That can likely be attributed to the fact that 5+ offers category has a higher termination rate than 2 and 3-4. In theory, this could be because of non-liner relationship, for example higher number of offers competition may be more vulnerable to aggressive bidding beavior. However, this explaination would likely be better captured by other hidden variables such as competition methods rather than having a direct relationship with an increased number of offers. As a result, we are not testing offers as a categorical variable with dummies. 

Instead, the last variant to be checked is the number of offers directly. This is handled logarithmicly because the differences between number of offers at the bottom end of the scale mtters much more than at the high end of the scale. In this method, contracts that were not open to competition are grouped with contracts that received only a single offer.


###Model 01D: Number of Offer Categories 

```{r Model01D_CBre}

#Frequency Plot
summary_continuous_plot(smp,"l_Offr")

#Percent Terminated Plot
summary_continuous_plot(smp,"l_Offr","FxCb")

#Percent Terminated Plot
summary_continuous_plot(smp,"l_Offr","PSR")

#Percent Terminated Plot
summary_continuous_plot(smp,"l_Offr","Veh")


#Model
CBre_Comp_01D <- glm (data=smp,
                 b_CBre ~ cl_Offr, family=binomial(link="logit"))
glmer_examine(CBre_Comp_01D)

#Variant Model
smp$clsqr_Offer<-smp$cl_Offr^2
CBre_Comp_01E <- glm (data=smp,
                 b_CBre ~ cl_Offr +clsqr_Offer, family=binomial(link="logit"))
glmer_examine(CBre_Comp_01E)

#Plot the data and fitted curve
CBre_Comp_01D_plot<-ggplot(data=smp,
       aes(y=j_Term,x=cl_Offr))+geom_jitter(alpha=0.01,height=0)+scale_y_sqrt() +
  labs(title="Fitted Linear Model", caption="Source: FPDS, CSIS Analysis")

#Plot the Fitted
#Add the fitted regression line
fitted_cbre_model(smp,"cl_Offr") +
  stat_function(fun = fit_curve, args=list(a=coef(CBre_Comp_01D)[1],
                                           b=coef(CBre_Comp_01D)[2]),
                             color="blue")

#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_Comp_01D)



#Plot residuals versus fitted
residuals_cbre_plot(CBre_Comp_01D,bins=3)+
  labs(x="Estimated  Pr (Ceiling Breach)")




```

Closer examination further undercuts the idea that more offers is associated with a lower termination risk. As measured by deviance, the number offers adds less to the model than random noise. A quick experiment also found that use of number of offer squared only made the model slightly better than noise.

A variety of binned percent terminated graphs found that in the middle range of the number of offers, there is often an increase in the percent terminated. The study team had expected that this phenomenon may prove isolated to a certain type of contracting mechanism or product/service, but that did not prove to be the case.

The difference between single-offer and effective competition is worth exploring, even if it lowers the significance of the starting model. Happily, this decision is supported by the fact that this three category variable offers the greatest reduction in residual deviance. However, lacking a specific theoretical argument for the importance of a greater number of offers, and given the results, the more detailed competition breakdowns will not be used. This may be an issue worth exploring more in a future work.

The greatest distinctiveness can be found in types of indefinite delivery vehicles. Definitive contracts and purchase orders show a higher termination rate as the number of offers increase. However, for single and multiple award IDVs, there's a decline in terminations rates correlated with low levels of competition, that often fades and even reverses as the number of offers increases. However, the results do not seem consistent with am exponential relationship.

## Study Variable Consolidation

### Level 6
#### Model NCS6A: def6_HHI_lag1
The expectation of the hypotheses is that consolidation will vary with consolidation, but does not predict a direction.


```{r ModelNCS6A_CBre}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(smp,"def6_HHI_lag1")
# smp$l_def6_HHI_lag1<-log(smp$def6_HHI_lag1)
summary_continuous_plot(smp,"l_def6_HHI_lag1")
summary_continuous_plot(smp,"def5_HHI_lag1")
summary_continuous_plot(smp,"def4_HHI_lag1")
summary_continuous_plot(smp,"def3_HHI_lag1")
summary_continuous_plot(smp,"def2_HHI_lag1")

#Model
CBre_Cons_NCS6A <- glm (data=smp,
                 b_CBre ~c_def6_HHI_lag1, family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS6A)


# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")



#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_Comp_02A)

#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_NCS6A,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_NCS6A,CBre_Cons_NCS6A,bins=20)


```
#### Model NCS6B: l_def6_HHI_lag1

Expectations are  unchanged.
```{r ModelNCS6A_CBre}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(smp,"def6_HHI_lag1")
summary_continuous_plot(smp,"l_def6_HHI_lag1")
summary_continuous_plot(smp,"l_def5_HHI_lag1")
summary_continuous_plot(smp,"l_def4_HHI_lag1")
summary_continuous_plot(smp,"l_def3_HHI_lag1")
summary_continuous_plot(smp,"l_def2_HHI_lag1")


#Model
CBre_Cons_NCS6B <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1, family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS6B)


# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")
# 


#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_NCS6A,CBre_Cons_NCS6B,CBre_Cons_NCS6E,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_NCS6A,CBre_Cons_NCS6B,bins=20)


```
The use of log doesn't change the direction of finding, but it does reduce the magnitude of the residuals and smooths out the trend. 


#### Model NCS6C: Defense to Overall ratio
The higher the ratio of defense obligations to reciepts in the overall economy, the DoD holds a monosopy over a sector. Given the challenges of monosopy, the a higher ratio estimates a greater  risk of ceiling breaches.
```{r ModelNCS6C_CBre}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(contract,"capped_def6_ratio_lag1")
      summary_continuous_plot(contract,"l_def6_ratio_lag1")
      summary_continuous_plot(contract,"capped_def5_ratio_lag1")
      summary_continuous_plot(contract,"l_def5_ratio_lag1")
      
      summary_continuous_plot(contract,"capped_def4_ratio_lag1")
      summary_continuous_plot(contract,"l_def4_ratio_lag1")
      summary_continuous_plot(contract,"capped_def3_ratio_lag1")
      summary_continuous_plot(contract,"l_def3_ratio_lag1")
      summary_continuous_plot(contract,"capped_def2_ratio_lag1")
      summary_continuous_plot(contract,"l_def2_ratio_lag1")
      


#Model
CBre_Cons_NCS6C <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1+cl_def6_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS6C)

CBre_Comp_NCS6C <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def6_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS6C)
# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_NCS6B,CBre_Cons_NCS6C,
                       CBre_Comp_01B,CBre_Comp_NCS6C,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_NCS6B,CBre_Cons_NCS6C,bins=20)
summary_residual_compare(CBre_Comp_01B,CBre_Comp_NCS6C,bins=2)


```
The results align with the hypothesis and are significant, although the magnitude is minimal.


#### Model NCS6D: Defense to Overall ratio
When there is a larger market available, consolidation may matter less, for better or wrose. Thus interaction of consolidation and ratio will estimate greater magnitude than HHI index on its own. Per the hypothesis, this does not necessarily. 

For competition, the effects may be greatest outside of a monospy context, thus the competition will estimate a lower occurance of ceiling breaches but the interaction of competition and ratio will estimate a higher rate.

```{r ModelNCS6D_CBre}
#Frequency Plot for unlogged ceiling


#Model
CBre_Cons_NCS6D <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_HHI_lag1:cl_def6_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS6D)

CBre_Comp_NCS6D <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def6_ratio_lag1+n_Comp:cl_def6_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS6D)
# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_NCS6B,CBre_Cons_NCS6C,CBre_Cons_NCS6D,
                       CBre_Comp_01B,CBre_Comp_NCS6C,CBre_Comp_NCS6D,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_NCS6C,CBre_Cons_NCS6D,bins=20)
summary_residual_compare(CBre_Comp_NCS6C,CBre_Comp_NCS6D,bins=2)


```
Adding the interaction for consolidation does has minimal effect, contrary to expectation, although the results are significant. For competition, the results violate VIF and will not be included. The interaction will not be added.


#### Model NCS6E: cl_def6_obl_lag1
Defense sector obligations are added to better adjust for the fact that larger sectors tend to have lower HHI indices if only because they include a broader range of activities. In addition, Acting somewhat as a proxy for MDAP status, larger sectors may also have a greater risk of cascading problems. Thus greater defense obligations in a given sector are expected to estimate a greater likelihood over ceiling breaches,
Expectations are  unchanged.
```{r ModelNCS6E_CBre}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(smp,"def6_obl_lag1")


summary_continuous_plot(smp,"l_def6_obl_lag1")
summary_continuous_plot(smp,"def5_obl_lag1")

summary_continuous_plot(smp,"l_def5_obl_lag1")
summary_continuous_plot(smp,"def4_obl_lag1")

summary_continuous_plot(smp,"l_def4_obl_lag1")
summary_continuous_plot(smp,"def3_obl_lag1")

summary_continuous_plot(smp,"l_def4_obl_lag1")
summary_continuous_plot(smp,"def2_obl_lag1")

summary_continuous_plot(smp,"l_def2_obl_lag1")

#Model
CBre_Cons_NCS6E <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1, family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS6E)


CBre_Comp_NCS6E <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def6_ratio_lag1+cl_def6_obl_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS6E)

# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_NCS6C,CBre_Cons_NCS6E,
                       CBre_Comp_NCS6C,CBre_Comp_NCS6E,
                       type="text",digits=2)


summary_residual_compare(CBre_Cons_NCS6C,CBre_Cons_NCS6E,bins=20)
summary_residual_compare(CBre_Comp_NCS6C,CBre_Comp_NCS6E,bins=20)


```
Estimated results occur. Residuals increase in magnitude for consolidation but reduce for competition.

#### Model NCS6F: Interaction of HHI and size
Whether consolidation has positive or negative effets, these should be stronger for larger sectors, as size tends to dilute HHI. The interaction should estimate a significant change in the likelihood of breaches. While the hypothesis allows for both efficiencies and the downsides of monopoly to arrive from consolidation, the study team expects that the interaction with sector size will positively estimate ceiling breaches, as the efficiency may apply just as well in small sectors.
```{r ModelNCS6F_CBre}
#Frequency Plot for unlogged ceiling


#Model
CBre_Cons_NCS6F <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_def6_HHI_lag1:cl_def6_obl_lag1, family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS6F)


# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted

  stargazer::stargazer(CBre_Cons_NCS6C,CBre_Cons_NCS6E,CBre_Cons_NCS6F,
                       CBre_Comp_NCS6C,CBre_Comp_NCS6E,
                       type="text",digits=2)


summary_residual_compare(CBre_Cons_NCS6E,CBre_Cons_NCS6F,bins=20)



```
Expectations were not uphelped. That said relaxing the assumption that the interaction will result in a higher risk of breaches and just looking at whether it is an effective predictor of a greater magnitude of change, that holds.


#### Model NCS6G: Interaction of HHI and size
Similar to the interaction of spend and size, the interaction of ratio and size adjusts looks at whether the HHI measure is more meaningful in those instances where the sector is primarily defense-oriented, as it is more representative of the total universe of vendors. Greater HHI and ratio is expected to estimate a greater likelihood of ceiling breaches.

```{r ModelNCS6G_CBre}
#Frequency Plot for unlogged ceiling


#Model
CBre_Cons_NCS6G <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_def6_HHI_lag1:cl_def6_obl_lag1+cl_def6_HHI_lag1:cl_def6_ratio_lag1, family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS6G,display=TRUE)

# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted

  stargazer::stargazer(CBre_Cons_NCS6C,CBre_Cons_NCS6F,CBre_Cons_NCS6G,
                       CBre_Comp_NCS6C,CBre_Comp_NCS6E,
                       type="text",digits=2)


summary_residual_compare(CBre_Cons_NCS6F,CBre_Cons_NCS6G,bins=20)



```
This interaction adds little to the model and runs contrary to expectations. Leaving it out.

#### Model NCS6H: Average Salary
Average salary can be an proxy for unobserved skill requirements. We expect that a greater skill requirement will estimate a greater risk of ceiling breaches.
```{r ModelNCS6H_CBre}
#Frequency Plot for unlogged ceiling


summary_continuous_plot(smp,"US6_avg_sal_lag1")

summary_continuous_plot(smp,"l_US6_avg_sal_lag1")

summary_continuous_plot(smp,"US5_avg_sal_lag1")
summary_continuous_plot(smp,"US4_avg_sal_lag1")
summary_continuous_plot(smp,"US3_avg_sal_lag1")
summary_continuous_plot(smp,"US2_avg_sal_lag1")

#Model
#cl_def6_obl_lag1

CBre_Cons_NCS6H <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+cl_def6_HHI_lag1:cl_def6_obl_lag1 , family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS6H)


CBre_Comp_NCS6H <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS6H)


# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
 stargazer::stargazer(CBre_Cons_NCS6C,CBre_Cons_NCS6E,CBre_Cons_NCS6F,CBre_Cons_NCS6H,
                       CBre_Comp_NCS6C,CBre_Comp_NCS6E,CBre_Comp_NCS6H,
                       type="text",digits=2)



summary_residual_compare(CBre_Cons_NCS6F,CBre_Cons_NCS6H,bins=20)
summary_residual_compare(CBre_Comp_NCS6E,CBre_Comp_NCS6H,bins=20)



```
The results were significant but in the opposite direction expected. This also reverses the sign on ratio, contrary to hypothesis.

Expectations were not uphelped. That said relaxing the assumption that the interaction will result in a higher risk of breaches and just looking at whether it is an effective predictor of a greater magnitude of change, that holds.


### Level 5
#### Model NCS5A: cl_def5_HHI
```{r ModelNCS5A_CBre}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(smp,"l_def6_HHI_lag1")
summary_continuous_plot(smp,"l_def5_HHI_lag1")
summary_continuous_plot(smp,"l_def4_HHI_lag1")
summary_continuous_plot(smp,"l_def3_HHI_lag1")
summary_continuous_plot(smp,"l_def2_HHI_lag1")


#Model
CBre_Cons_NCS5A <- glm (data=smp,
                 b_CBre ~cl_def5_HHI_lag1, family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS5A)


# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")
# 


#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_NCS6B,CBre_Cons_NCS6E,CBre_Cons_NCS6F,CBre_Cons_NCS5A,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_NCS6B,CBre_Cons_NCS5A,bins=20)


```

#### Model NCS5B: Defense to Overall ratio
The higher the ratio of defense obligations to reciepts in the overall economy, the DoD holds a monosopy over a sector. Given the challenges of monosopy, the a higher ratio estimates a greater  risk of ceiling breaches.
```{r ModelNCS5B_CBre}
#Frequency Plot for unlogged ceiling




summary_continuous_plot(smp,"capped_def5_ratio_lag1")
summary_continuous_plot(smp,"l_def5_ratio_lag1")

#Model
CBre_Cons_NCS5B <- glm (data=smp,
                 b_CBre ~cl_def5_HHI_lag1+cl_def5_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS5B)

CBre_Comp_NCS5B <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def5_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS5B)
# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_NCS6D,CBre_Cons_NCS5A,CBre_Cons_NCS5B,
                       CBre_Comp_01B,CBre_Comp_NCS6D,CBre_Comp_NCS5B,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_NCS5A,CBre_Cons_NCS5B,bins=20)
summary_residual_compare(CBre_Cons_NCS6D,CBre_Cons_NCS5B,bins=20)
summary_residual_compare(CBre_Comp_01B,CBre_Comp_NCS5B,bins=2)
summary_residual_compare(CBre_Comp_NCS6D,CBre_Comp_NCS5B,bins=2)


```
The results align with the hypothesis, although the magnitude is minimal, if larger in magnitude than the level 6 version.

#### Model NCS5C: Defense to Overall ratio
When there is a larger market available, consolidation may matter less, for better or wrose. Thus interaction of consolidation and ratio will estimate greater magnitude than HHI index on its own. Per the hypothesis, this does not necessarily. 

For competition, the effects may be greatest outside of a monospy context, thus the competition will estimate a lower occurance of ceiling breaches but the interaction of competition and ratio will estimate a higher rate.

```{r ModelNCS5C_CBre}
#Frequency Plot for unlogged ceiling


#Model
CBre_Cons_NCS5C <- glm (data=smp,
                 b_CBre ~cl_def5_HHI_lag1+cl_def5_ratio_lag1+cl_def5_HHI_lag1:cl_def5_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS5C)

CBre_Comp_NCS5C <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def5_ratio_lag1+n_Comp:cl_def5_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS5C)
# 
# #Plot the fitted model plot
# CBre_Comp_05A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_05A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_05A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_05A_curve, 
#                              args=list(Comp=5),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_NCS5A,CBre_Cons_NCS5B,CBre_Cons_NCS5C,
                       CBre_Comp_01B,CBre_Comp_NCS5B,CBre_Comp_NCS5C,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_NCS5B,CBre_Cons_NCS5C,bins=10)
summary_residual_compare(CBre_Comp_NCS5B,CBre_Comp_NCS5C,bins=5)


```
Both exceed VIF of 2.
#### Model NCSD: cl_def5_obl_lag1
Defense sector obligations are added to better adjust for the fact that larger sectors tend to have lower HHI indices if only because they include a broader range of activities. In addition, Acting somewhat as a proxy for MDAP status, larger sectors may also have a greater risk of cascading problems. Thus greater defense obligations in a given sector are expected to estimate a greater likelihood over ceiling breaches,
Expectations are  unchanged.
```{r ModelNCSD_CBre}


#Model
CBre_Cons_NCS5D <- glm (data=smp,
                 b_CBre ~cl_def5_HHI_lag1+cl_def5_ratio_lag1+cl_def5_obl_lag1, family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS5D)


CBre_Comp_NCS5D <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def5_ratio_lag1+cl_def5_obl_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS5D)
# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_NCS5A,CBre_Cons_NCS5B,CBre_Cons_NCS5D,
                       CBre_Comp_01B,CBre_Comp_NCS5B,CBre_Comp_NCS5D,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_NCS5B,CBre_Cons_NCS5D,bins=10)
summary_residual_compare(CBre_Comp_NCS5B,CBre_Comp_NCS5D,bins=5)

```
Size seems to ad less to the model at level 5 than level 6.

#### Model NCS5E: Interaction of HHI and size
Whether consolidation has positive or negative effets, these should be stronger for larger sectors, as size tends to dilute HHI. The interaction should estimate a significant change in the likelihood of breaches. While the hypothesis allows for both efficiencies and the downsides of monopoly to arrive from consolidation, the study team expects that the interaction with sector size will positively estimate ceiling breaches, as the efficiency may apply just as well in small sectors.
```{r ModelNCS5E_CBre}
#Frequency Plot for unlogged ceiling

#Model
CBre_Cons_NCS5E <- glm (data=smp,
                 b_CBre ~cl_def5_HHI_lag1+cl_def5_ratio_lag1+cl_def5_obl_lag1+
                   cl_def5_HHI_lag1:cl_def5_obl_lag1, family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS5E)


# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_NCS5D,CBre_Cons_NCS5E,CBre_Cons_NCS6F,
                       CBre_Comp_NCS5D,CBre_Comp_NCS6E,type="text",
                       digits=2)

  #Compare to prior at same level
summary_residual_compare(CBre_Cons_NCS5D,CBre_Cons_NCS5E,bins=20)
summary_residual_compare(CBre_Cons_NCS6F,CBre_Cons_NCS5E,bins=20)


```
Expectations were not uphelped. The interaction appears to badly misjudge some contracts at the estimated low risk of the scale, although deviance for other estimates reduces. Level 5 seems on the whole to be less effective an estimator than level 6.

### Level 4
#### Model NCS4A: cl_def4_HHI
```{r ModelNCS4A_CBre}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(smp,"l_def4_HHI_lag1")


#Model
CBre_Cons_NCS4A <- glm (data=smp,
                 b_CBre ~cl_def4_HHI_lag1, family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS4A)


# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")
# 


#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_NCS6B,CBre_Cons_NCS6E,CBre_Cons_NCS6F,CBre_Cons_NCS4A,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_NCS6B,CBre_Cons_NCS4A,bins=20)


```

Level 4 HHI seems to slightly out perform level 6.



#### Model NCS4B: Defense to Overall ratio
The higher the ratio of defense obligations to reciepts in the overall economy, the DoD holds a monosopy over a sector. Given the challenges of monosopy, the a higher ratio estimates a greater  risk of ceiling breaches.
```{r ModelNCS4B_CBre}
#Frequency Plot for unlogged ceiling




summary_continuous_plot(smp,"capped_def4_ratio_lag1")
summary_continuous_plot(smp,"l_def4_ratio_lag1")

#Model
CBre_Cons_NCS4B <- glm (data=smp,
                 b_CBre ~cl_def4_HHI_lag1+cl_def4_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS4B)

CBre_Comp_NCS4B <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def4_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS4B)
# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_NCS5B,CBre_Cons_NCS4A,CBre_Cons_NCS4B,
                       CBre_Comp_01B,CBre_Comp_NCS5B,CBre_Comp_NCS4B,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_NCS4A,CBre_Cons_NCS4B,bins=20)
summary_residual_compare(CBre_Cons_NCS5B,CBre_Cons_NCS4B,bins=20)
summary_residual_compare(CBre_Comp_01B,CBre_Comp_NCS4B,bins=2)
summary_residual_compare(CBre_Comp_NCS5B,CBre_Comp_NCS4B,bins=2)


```
The results align with the hypothesis, although the magnitude is small, if larger in magnitude than the level 5 version.

#### Model NCS4C: Defense to Overall ratio
When there is a larger market available, consolidation may matter less, for better or wrose. Thus interaction of consolidation and ratio will estimate greater magnitude than HHI index on its own. Per the hypothesis, this does not necessarily. 

For competition, the effects may be greatest outside of a monospy context, thus the competition will estimate a lower occurance of ceiling breaches but the interaction of competition and ratio will estimate a higher rate.

```{r ModelNCS4C_CBre}
#Frequency Plot for unlogged ceiling


#Model
CBre_Cons_NCS4C <- glm (data=smp,
                 b_CBre ~cl_def4_HHI_lag1+cl_def4_ratio_lag1+cl_def4_HHI_lag1:cl_def4_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS4C)

CBre_Comp_NCS4C <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def4_ratio_lag1+n_Comp:cl_def4_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS4C)
# 
# #Plot the fitted model plot
# CBre_Comp_04A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_04A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_04A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_04A_curve, 
#                              args=list(Comp=4),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_NCS4A,CBre_Cons_NCS4B,CBre_Cons_NCS4C,
                       CBre_Comp_01B,CBre_Comp_NCS4B,CBre_Comp_NCS4C,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_NCS2B,CBre_Cons_NCS2C,bins=10)
summary_residual_compare(CBre_Comp_NCS2B,CBre_Comp_NCS2C,bins=5)


```
VIF exceeded in both cases.


#### Model NCS4D: cl_def4_obl_lag1
Defense sector obligations are added to better adjust for the fact that larger sectors tend to have lower HHI indices if only because they include a broader range of activities. In addition, Acting somewhat as a proxy for MDAP status, larger sectors may also have a greater risk of cascading problems. Thus greater defense obligations in a given sector are expected to estimate a greater likelihood over ceiling breaches,
Expectations are  unchanged.
```{r ModelNCS4D_CBre}


#Model
CBre_Cons_NCS4D <- glm (data=smp,
                 b_CBre ~cl_def4_HHI_lag1+cl_def4_ratio_lag1+cl_def4_obl_lag1, family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS4D)


CBre_Comp_NCS4D <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def4_ratio_lag1+ cl_def4_obl_lag1,
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS4D)
# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
stargazer::stargazer(CBre_Cons_NCS4B,CBre_Cons_NCS4D,CBre_Cons_NCS6E,
                       CBre_Comp_NCS4B,CBre_Comp_NCS4D,CBre_Comp_NCS6E,type="text",
                       digits=2)



  #Compare to prior at same level
summary_residual_compare(CBre_Cons_NCS4B,CBre_Cons_NCS4D,bins=20)
#Compare to prior at lower level
summary_residual_compare(CBre_Cons_NCS6E,CBre_Cons_NCS4D,bins=20)
summary_residual_compare(CBre_Co_NCS4B,CBre_Comp_NCS4D,bins=20)
```
Size seems to add less to the model at level 4 than level 6.

#### Model NCS4E: Interaction of HHI and size
Whether consolidation has positive or negative effets, these should be stronger for larger sectors, as size tends to dilute HHI. The interaction should estimate a significant change in the likelihood of breaches. While the hypothesis allows for both efficiencies and the downsides of monopoly to arrive from consolidation, the study team expects that the interaction with sector size will positively estimate ceiling breaches, as the efficiency may apply just as well in small sectors.
```{r ModelNCS4E_CBre}
#Frequency Plot for unlogged ceiling


#Model

CBre_Cons_NCS4E <- glm (data=smp,
                 b_CBre ~cl_def4_HHI_lag1+cl_def4_ratio_lag1+cl_def4_obl_lag1+
                   cl_def4_HHI_lag1:cl_def4_obl_lag1, family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS4E)


# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")





#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_NCS4D,CBre_Cons_NCS4E,CBre_Cons_NCS6F,
                       CBre_Comp_NCS4D,CBre_Comp_NCS6E,type="text",
                       digits=2)

  #Compare to prior at same level
summary_residual_compare(CBre_Cons_NCS4D,CBre_Cons_NCS4E,bins=20)
summary_residual_compare(CBre_Cons_NCS6F,CBre_Cons_NCS4E,bins=20)

```
Expectations were not uphelped. Level 4 doesn't seem to be quite as effective as level 6 with the multiple measures included, but it does better than 5

### Level 3
#### Model NCS3A: cl_def3_HHI
```{r ModelNCS3A_CBre}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(smp,"l_def3_HHI_lag1")


#Model
CBre_Cons_NCS3A <- glm (data=smp,
                 b_CBre ~cl_def3_HHI_lag1, family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS3A)


# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")
# 


#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_NCS6B,CBre_Cons_NCS6E,CBre_Cons_NCS6F,CBre_Cons_NCS3A,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_NCS6B,CBre_Cons_NCS3A,bins=20)


```

Level 3 HHI seems to slightly out perform level 6.


#### Model NCS3B: Defense to Overall ratio
The higher the ratio of defense obligations to reciepts in the overall economy, the DoD holds a monosopy over a sector. Given the challenges of monosopy, the a higher ratio estimates a greater  risk of ceiling breaches.
```{r ModelNCS3B_CBre}
#Frequency Plot for unlogged ceiling




summary_continuous_plot(smp,"capped_def3_ratio_lag1")
summary_continuous_plot(smp,"l_def3_ratio_lag1")

#Model
CBre_Cons_NCS3B <- glm (data=smp,
                 b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS3B)

CBre_Comp_NCS3B <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def3_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS3B)
# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_NCS4B,CBre_Cons_NCS3A,CBre_Cons_NCS3B,
                       CBre_Comp_01B,CBre_Comp_NCS4B,CBre_Comp_NCS3B,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_NCS3A,CBre_Cons_NCS3B,bins=20)
summary_residual_compare(CBre_Cons_NCS4B,CBre_Cons_NCS3B,bins=20)
summary_residual_compare(CBre_Comp_01B,CBre_Comp_NCS3B,bins=2)
summary_residual_compare(CBre_Comp_NCS4B,CBre_Comp_NCS3B,bins=2)


```
The results align with the hypothesis, although the magnitude is small, if larger in magnitude than the level 4 version. Although the residuals also notably increase in magnitude with the introduction of this variable.

#### Model NCS3C: Defense to Overall ratio
When there is a larger market available, consolidation may matter less, for better or wrose. Thus interaction of consolidation and ratio will estimate greater magnitude than HHI index on its own. Per the hypothesis, this does not necessarily. 

For competition, the effects may be greatest outside of a monospy context, thus the competition will estimate a lower occurance of ceiling breaches but the interaction of competition and ratio will estimate a higher rate.

```{r ModelNCS3C_CBre}
#Frequency Plot for unlogged ceiling


#Model
CBre_Cons_NCS3C <- glm (data=smp,
                 b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+cl_def3_HHI_lag1:cl_def3_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS3C)

CBre_Comp_NCS3C <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def3_ratio_lag1+n_Comp:cl_def3_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS3C)
# 
# #Plot the fitted model plot
# CBre_Comp_03A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_03A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_03A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_03A_curve, 
#                              args=list(Comp=3),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_NCS3A,CBre_Cons_NCS3B,CBre_Cons_NCS3C,
                       CBre_Comp_01B,CBre_Comp_NCS3B,CBre_Comp_NCS3C,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_NCS2B,CBre_Cons_NCS2C,bins=10)
summary_residual_compare(CBre_Comp_NCS2B,CBre_Comp_NCS2C,bins=5)


```
Both exceed VIF of 2.



#### Model NCS3D: cl_def3_obl_lag1
Defense sector obligations are added to better adjust for the fact that larger sectors tend to have lower HHI indices if only because they include a broader range of activities. In addition, Acting somewhat as a proxy for MDAP status, larger sectors may also have a greater risk of cascading problems. Thus greater defense obligations in a given sector are expected to estimate a greater likelihood over ceiling breaches,
Expectations are  unchanged.
```{r ModelNCS3D_CBre}


#Model
CBre_Cons_NCS3D <- glm (data=smp,
                 b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+cl_def3_obl_lag1, family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS3D)


CBre_Comp_NCS3D <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def3_ratio_lag1+ cl_def3_obl_lag1,
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS3D)
# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
stargazer::stargazer(CBre_Cons_NCS3B,CBre_Cons_NCS3E,CBre_Cons_NCS6F,
                       CBre_Cons_NCS3B,CBre_Cons_NCS3D,type="text",
                       digits=2)



  #Compare to prior at same level
summary_residual_compare(CBre_Cons_NCS3A,CBre_Cons_NCS3D,bins=20)
#Compare to prior at lower level
summary_residual_compare(CBre_Cons_NCS6E,CBre_Cons_NCS3D,bins=20)
```
Size seems to add less to the model at level 3 than level 6.

#### Model NCS3E: Interaction of HHI and size
Whether consolidation has positive or negative effets, these should be stronger for larger sectors, as size tends to dilute HHI. The interaction should estimate a significant change in the likelihood of breaches. While the hypothesis allows for both efficiencies and the downsides of monopoly to arrive from consolidation, the study team expects that the interaction with sector size will positively estimate ceiling breaches, as the efficiency may apply just as well in small sectors.
```{r ModelNCS3E_CBre}
#Frequency Plot for unlogged ceiling


#Model
CBre_Cons_NCS3E <- glm (data=smp,
                 b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+cl_def3_obl_lag1+cl_def3_HHI_lag1:cl_def3_obl_lag1, family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS3E)


# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")





#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_NCS3D,CBre_Cons_NCS3E,CBre_Cons_NCS6F,
                       CBre_Comp_NCS3D,CBre_Comp_NCS6E,type="text",
                       digits=2)

  #Compare to prior at same level
summary_residual_compare(CBre_Cons_NCS3D,CBre_Cons_NCS3E,bins=20)
summary_residual_compare(CBre_Cons_NCS6F,CBre_Cons_NCS3E,bins=20)


```
Expectations were not uphelped. Level 3 seems to outperform level 6. Which suggests further exploration is worthwhile. That said, sector size just doesn't add that much to this model relative to level 6.

#### Model NCS3F: Average Salary
Average salary can be an proxy for unobserved skill requirements. We expect that a greater skill requirement will estimate a greater risk of ceiling breaches.
```{r ModelNCS3F_CBre}
#Frequency Plot for unlogged ceiling


summary_continuous_plot(smp,"US3_avg_sal_lag1")
summary_continuous_plot(smp,"l_US3_avg_sal_lag1")

summary_continuous_plot(smp,"US5_avg_sal_lag1")
summary_continuous_plot(smp,"US4_avg_sal_lag1")
summary_continuous_plot(smp,"US3_avg_sal_lag1")
summary_continuous_plot(smp,"US2_avg_sal_lag1")

#Model

CBre_Cons_NCS3F <- glm (data=smp,
                 b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+cl_def3_obl_lag1+
                  cl_US3_avg_sal_lag1+cl_def3_HHI_lag1:cl_def3_obl_lag1 , family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS3F)


CBre_Comp_NCS3F <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def3_ratio_lag1+cl_def3_obl_lag1+cl_US3_avg_sal_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS3F)



glmer_examine(CBre_Cons_NCS3F)
glmer_examine(CBre_Comp_NCS3F)


CBre_Cons_NCS3F2 <- glm (data=smp,
                 b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1
                  cl_US3_avg_sal_lag1 , family=binomial(link="logit"))#+cl_def3_HHI_lag1:cl_def3_obl_lag1
glmer_examine(CBre_Cons_NCS3F2)


CBre_Comp_NCS3F2 <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def3_ratio_lag1+cl_US3_avg_sal_lag1, #cl_def3_obl_lag1+
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS3F2)


CBre_Cons_NCS3F3 <- glm (data=smp,
                 b_CBre ~cl_def3_HHI_lag1+cl_def3_obl_lag1+#cl_def3_ratio_lag1
                  cl_US3_avg_sal_lag1+cl_def3_HHI_lag1:cl_def3_obl_lag1 , family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS3F3)
glmer_examine(CBre_Cons_NCS3F3)

CBre_Cons_NCS3F4 <- glm (data=smp,
                 b_CBre ~cl_def3_HHI_lag1+cl_def3_obl_lag1+#cl_def3_ratio_lag1
                  cl_US3_avg_sal_lag1 , family=binomial(link="logit"))#+cl_def3_HHI_lag1:cl_def3_obl_lag1
glmer_examine(CBre_Cons_NCS3F4)
glmer_examine(CBre_Cons_NCS3F4)

CBre_Comp_NCS3F3 <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def3_obl_lag1+cl_US3_avg_sal_lag1, #cl_def3_ratio_lag1
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS3F3)


# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
 stargazer::stargazer(CBre_Cons_NCS3E,CBre_Cons_NCS3F2,CBre_Cons_NCS3F4,CBre_Cons_NCS6G,
                       CBre_Comp_NCS3D,CBre_Comp_NCS3F2,CBre_Comp_NCS3F3,CBre_Comp_NCS6G,
                       type="text",digits=2)


summary_residual_compare(CBre_Cons_NCS3F,CBre_Cons_NCS3F2,bins=20)
summary_residual_compare(CBre_Comp_NCS3D,CBre_Comp_NCS3F2,bins=10)
summary_residual_compare(CBre_Cons_NCS3F2,CBre_Cons_NCS3F4,bins=20)
summary_residual_compare(CBre_Comp_NCS3F2,CBre_Comp_NCS3F3,bins=10)

summary_residual_compare(CBre_Cons_NCS3F,CBre_Cons_NCS3F4,bins=20)
summary_residual_compare(CBre_Comp_NCS3D,CBre_Comp_NCS3F3,bins=10)


```
After sorting out VIF, obligations has more contained residuals and for consolidation a lower deviance. For competition the deviance is lower for when salary is not included and both ratio and defense obligations are.

#### Model NCS3G: NAICS 6 and NAICS 3
Consolidation at lessa nd more granular levels may have different effects. Efficiencies are often used to describe sectors, like utilities, with high barriers to entry. Many of these aspects seem like they would already be captured at less granular NAICS levels, e.g. power plants, rather than more specific NAICS levels, like solar vs. coal. As a result, consolidation for more granular NAICS codes should estimate higher rates of ceiling breaches compared to less granular NAICS code.

We'll start by adding in everything from both models and seeing what violates VIF.
```{r ModelNCS3G_CBre}
#Frequency Plot for unlogged ceiling


#Model
CBre_Cons_NCS3G <- glm (data=smp,
                 b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+cl_def3_obl_lag1+
                  cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+cl_def6_HHI_lag1:cl_def6_obl_lag1  , family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS3G)
vif(CBre_Cons_NCS3G)
#Defense obl 3 have the highest VIF and no coefficient to speak of, dropping it
CBre_Cons_NCS3G2 <- glm (data=smp,
                 b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                  cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                  cl_US6_avg_sal_lag1+cl_def6_HHI_lag1:cl_def6_obl_lag1  , family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS3G2)
vif(CBre_Cons_NCS3G2)
#Average salary 6 has the highest VIF though but both average salaries are over 2.0 and 3 is more contrary to expectations. Taking it out.
CBre_Cons_NCS3G3 <- glm (data=smp,
                 b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                  #cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                  cl_US6_avg_sal_lag1+cl_def6_HHI_lag1:cl_def6_obl_lag1  , family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS3G3)
vif(CBre_Cons_NCS3G3)


CBre_Comp_NCS3G <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def3_ratio_lag1+cl_def3_obl_lag1+cl_US3_avg_sal_lag1+
                   n_Comp+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS3G)
vif(CBre_Comp_NCS3G)
#Defense obl 3 have the highest VIF and no coefficient to speak of, dropping it
CBre_Comp_NCS3G2 <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def3_ratio_lag1+cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                   n_Comp+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS3G2)
vif(CBre_Comp_NCS3G2)
#Taking out average salary 3 to keep the models snced up.
CBre_Comp_NCS3G3 <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                   n_Comp+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS3G3)
vif(CBre_Comp_NCS3G3)


# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
 stargazer::stargazer(CBre_Cons_NCS3E,CBre_Cons_NCS3F2,CBre_Cons_NCS3F4,CBre_Cons_NCS6G,CBre_Cons_NCS3G3,
                       CBre_Comp_NCS3D,CBre_Comp_NCS3F2,CBre_Comp_NCS3F3,CBre_Comp_NCS6G,CBre_Comp_NCS3G3,
                       type="text",digits=2)


summary_residual_compare(CBre_Cons_NCS3F4,CBre_Cons_NCS3G3,bins=20)
summary_residual_compare(CBre_Comp_NCS3F3,CBre_Comp_NCS3G3,bins=10)
summary_residual_compare(CBre_Cons_NCS3F2,CBre_Cons_NCS3G3,bins=20)
summary_residual_compare(CBre_Comp_NCS3F2,CBre_Comp_NCS3G3,bins=10)

summary_residual_compare(CBre_Cons_NCS3F,CBre_Cons_NCS3G3,bins=20)
summary_residual_compare(CBre_Comp_NCS3D,CBre_Comp_NCS3G3,bins=10)
summary_residual_compare(CBre_Cons_NCS6G,CBre_Cons_NCS3G3,bins=20)
summary_residual_compare(CBre_Comp_NCS6G,CBre_Comp_NCS3G3,bins=10)

```
The hypothesis is upheld. Deviance is a little lower and residuals a little higher than the prior forms of consolidation for the level 3 model.  For the level 6 model, deviance is reduced some in both cases.


### Level 2
#### Model NCS2A: cl_def2_HHI
```{r ModelNCS2A_CBre}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(smp,"l_def2_HHI_lag1")


#Model
CBre_Cons_NCS2A <- glm (data=smp,
                 b_CBre ~cl_def2_HHI_lag1, family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS2A)


# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")
# 


#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_NCS6B,CBre_Cons_NCS6E,CBre_Cons_NCS6F,CBre_Cons_NCS2A,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_NCS6B,CBre_Cons_NCS2A,bins=20)


```

Level 2 HHI seems to slightly out perform level 6.

#### Model NCS2B: Defense to Overall ratio
The higher the ratio of defense obligations to reciepts in the overall economy, the DoD holds a monosopy over a sector. Given the challenges of monosopy, the a higher ratio estimates a greater  risk of ceiling breaches.
```{r ModelNCS2B_CBre}
#Frequency Plot for unlogged ceiling




summary_continuous_plot(smp,"capped_def2_ratio_lag1")
summary_continuous_plot(smp,"l_def2_ratio_lag1")

#Model
CBre_Cons_NCS2B <- glm (data=smp,
                 b_CBre ~cl_def2_HHI_lag1+cl_def2_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS2B)

CBre_Comp_NCS2B <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def2_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS2B)
# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_NCS3B,CBre_Cons_NCS2A,CBre_Cons_NCS2B,
                       CBre_Comp_01B,CBre_Comp_NCS3B,CBre_Comp_NCS2B,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_NCS2A,CBre_Cons_NCS2B,bins=10)
summary_residual_compare(CBre_Cons_NCS3B,CBre_Cons_NCS2B,bins=20)
summary_residual_compare(CBre_Comp_01B,CBre_Comp_NCS2B,bins=2)
summary_residual_compare(CBre_Comp_NCS3B,CBre_Comp_NCS2B,bins=2)


```
The results align with the hypothesis on competition but not on consolidation, showing a surprising divergence.


#### Model NCS2C: Defense to Overall ratio
When there is a larger market available, consolidation may matter less, for better or wrose. Thus interaction of consolidation and ratio will estimate greater magnitude than HHI index on its own. Per the hypothesis, this does not necessarily. 

For competition, the effects may be greatest outside of a monospy context, thus the competition will estimate a lower occurance of ceiling breaches but the interaction of competition and ratio will estimate a higher rate.

```{r ModelNCS2C_CBre}
#Frequency Plot for unlogged ceiling


#Model
CBre_Cons_NCS2C <- glm (data=smp,
                 b_CBre ~cl_def2_HHI_lag1+cl_def2_ratio_lag1+cl_def2_HHI_lag1:cl_def2_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS2C)

CBre_Comp_NCS2C <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def2_ratio_lag1+n_Comp:cl_def2_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS2C)
# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_NCS2A,CBre_Cons_NCS2B,CBre_Cons_NCS2C,
                       CBre_Comp_01B,CBre_Comp_NCS2B,CBre_Comp_NCS2C,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_NCS2B,CBre_Cons_NCS2C,bins=10)
summary_residual_compare(CBre_Comp_NCS2B,CBre_Comp_NCS2C,bins=5)


```
Ratio 2 and consolidation continues to tell us fairly little, with the contrary to the hypothesis result that ratio and hhi show no particular relationship. Competition violates VIF. Leaving this out.



#### Model NCS2D: cl_def2_obl_lag1
Defense sector obligations are added to better adjust for the fact that larger sectors tend to have lower HHI indices if only because they include a broader range of activities. In addition, Acting somewhat as a proxy for MDAP status, larger sectors may also have a greater risk of cascading problems. Thus greater defense obligations in a given sector are expected to estimate a greater likelihood over ceiling breaches,
Expectations are  unchanged.
```{r ModelNCS2D_CBre}


#Model
CBre_Cons_NCS2D <- glm (data=smp,
                 b_CBre ~cl_def2_HHI_lag1+cl_def2_ratio_lag1+cl_def2_obl_lag1, family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS2D)


CBre_Comp_NCS2D <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def2_ratio_lag1+cl_def2_obl_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS2D)
# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
stargazer::stargazer(CBre_Cons_NCS6B,CBre_Cons_NCS6E,CBre_Cons_NCS6F,
                       CBre_Cons_NCS2A,CBre_Cons_NCS2D,type="text",
                       digits=2)



  #Compare to prior at same level
summary_residual_compare(CBre_Cons_NCS2A,CBre_Cons_NCS2D,bins=10)
#Compare to prior at lower level
summary_residual_compare(CBre_Cons_NCS6E,CBre_Cons_NCS2D,bins=10)
summary_residual_compare(CBre_Cons_NCS3G,CBre_Cons_NCS2D,bins=10)
```
Size seems to add less to the model at level 2 than level 6.

#### Model NCS2E: Interaction of HHI and size
Whether consolidation has positive or negative effets, these should be stronger for larger sectors, as size tends to dilute HHI. The interaction should estimate a significant change in the likelihood of breaches. While the hypothesis allows for both efficiencies and the downsides of monopoly to arrive from consolidation, the study team expects that the interaction with sector size will positively estimate ceiling breaches, as the efficiency may apply just as well in small sectors.
```{r ModelNCS2E_CBre}
#Frequency Plot for unlogged ceiling


#Model
CBre_Cons_NCS2E <- glm (data=smp,
                 b_CBre ~cl_def2_HHI_lag1+cl_def2_obl_lag1+cl_def2_HHI_lag1:cl_def2_obl_lag1, family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS2E)


# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")







#Plot residuals versus fitted
stargazer::stargazer(CBre_Cons_NCS6B,CBre_Cons_NCS6D,CBre_Cons_NCS6E,
                       CBre_Comp_NCS2B,CBre_Comp_NCS2D,CBre_Comp_NCS6E,type="text",
                       digits=2)



  #Compare to prior at same level
summary_residual_compare(CBre_Cons_NCS2B,CBre_Cons_NCS2D,bins=20)
#Compare to prior at lower level
summary_residual_compare(CBre_Cons_NCS6E,CBre_Cons_NCS2D,bins=20)
summary_residual_compare(CBre_Co_NCS2B,CBre_Comp_NCS2D,bins=20)

```
This interaction adds nothing to this model.


#### Model NCS2F: Average Salary
Average salary can be an proxy for unobserved skill requirements. We expect that a greater skill requirement will estimate a greater risk of ceiling breaches.
```{r ModelNCS2F_CBre}
#Frequency Plot for unlogged ceiling


summary_continuous_plot(smp,"US2_avg_sal_lag1")
summary_continuous_plot(smp,"l_US2_avg_sal_lag1")

summary_continuous_plot(smp,"US5_avg_sal_lag1")
summary_continuous_plot(smp,"US4_avg_sal_lag1")
summary_continuous_plot(smp,"US2_avg_sal_lag1")
summary_continuous_plot(smp,"US2_avg_sal_lag1")

#Model

CBre_Cons_NCS2F <- glm (data=smp,
                 b_CBre ~cl_def2_HHI_lag1+cl_def2_ratio_lag1+cl_def2_obl_lag1+
                  cl_US2_avg_sal_lag1+cl_def2_HHI_lag1:cl_def2_obl_lag1 , family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS2F)


CBre_Comp_NCS2F <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def2_ratio_lag1+cl_def2_obl_lag1+cl_US2_avg_sal_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS2F)



glmer_examine(CBre_Cons_NCS2F)
glmer_examine(CBre_Comp_NCS2F)


CBre_Cons_NCS2F2 <- glm (data=smp,
                 b_CBre ~cl_def2_HHI_lag1+cl_def2_ratio_lag1+#cl_def2_obl_lag1
                  cl_US2_avg_sal_lag1 , family=binomial(link="logit"))#+cl_def2_HHI_lag1:cl_def2_obl_lag1
glmer_examine(CBre_Cons_NCS2F2)


CBre_Comp_NCS2F2 <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def2_ratio_lag1+cl_US2_avg_sal_lag1, #cl_def2_obl_lag1+
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS2F2)


glmer_examine(CBre_Cons_NCS2F2)
glmer_examine(CBre_Cons_NCS2F2)

CBre_Cons_NCS2F3 <- glm (data=smp,
                 b_CBre ~cl_def2_HHI_lag1+cl_def2_obl_lag1+#cl_def2_ratio_lag1
                  cl_US2_avg_sal_lag1 , family=binomial(link="logit"))#+cl_def2_HHI_lag1:cl_def2_obl_lag1


CBre_Comp_NCS2F3 <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def2_obl_lag1+cl_US2_avg_sal_lag1, #cl_def2_ratio_lag1
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS2F2)

glmer_examine(CBre_Cons_NCS2F3)
glmer_examine(CBre_Cons_NCS2F3)
# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
 stargazer::stargazer(CBre_Cons_NCS2D,CBre_Cons_NCS2F2,CBre_Cons_NCS2F3,#CBre_Cons_NCS6G,
                       CBre_Comp_NCS2D,CBre_Comp_NCS2F2,CBre_Comp_NCS2F3,#CBre_Comp_NCS6G,
                       type="text",digits=2)


summary_residual_compare(CBre_Cons_NCS2D,CBre_Cons_NCS2F2,bins=10)
summary_residual_compare(CBre_Comp_NCS2D,CBre_Comp_NCS2F2,bins=5)
summary_residual_compare(CBre_Cons_NCS2F2,CBre_Cons_NCS2F3,bins=10)
summary_residual_compare(CBre_Comp_NCS2F2,CBre_Comp_NCS2F3,bins=5)

summary_residual_compare(CBre_Cons_NCS2F,CBre_Cons_NCS2F3,bins=20)
summary_residual_compare(CBre_Comp_NCS2D,CBre_Comp_NCS2F3,bins=10)


```
Sticking with  ratio and dropping with Obl, prioritizing alignment with expectations and secondarily deviance reduction.
#### Model NCS2G: NAICS 6 and NAICS 2
Consolidation at lessa nd more granular levels may have different effects. Efficiencies are often used to describe sectors, like utilities, with high barriers to entry. Many of these aspects seem like they would already be captured at less granular NAICS levels, e.g. power plants, rather than more specific NAICS levels, like solar vs. coal. As a result, consolidation for more granular NAICS codes should estimate higher rates of ceiling breaches compared to less granular NAICS code.

We'll start by adding in everything from both models and seeing what violates VIF.
```{r ModelNCS2G_CBre}
#Frequency Plot for unlogged ceiling


#Model
CBre_Cons_NCS2G <- glm (data=smp,
                 b_CBre ~cl_def2_HHI_lag1+cl_def2_ratio_lag1+
                  cl_US2_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+cl_def6_HHI_lag1:cl_def6_obl_lag1  , family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS2G)


#Defense obl 2 have the highest VIF and no coefficient to speak of, dropping it
CBre_Cons_NCS2G <- glm (data=smp,
                 b_CBre ~cl_def2_HHI_lag1+cl_def2_ratio_lag1+
                  #cl_US2_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+cl_def6_HHI_lag1:cl_def6_obl_lag1  , family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS2G)


#Checking if removing the interaction can let us keep HHI2
CBre_Cons_NCS2G3 <- glm (data=smp,
                 b_CBre ~cl_def2_HHI_lag1+cl_def2_ratio_lag1+
                  #cl_US2_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1,#+cl_def6_HHI_lag1:cl_def6_obl_lag1  ,
                 family=binomial(link="logit"))
glmer_examine(CBre_Cons_NCS2G3)




 stargazer::stargazer(CBre_Cons_NCS2D,CBre_Cons_NCS2F2,CBre_Cons_NCS2G3,#CBre_Cons_NCS6G,
                       CBre_Comp_NCS2D,CBre_Comp_NCS2F2,CBre_Comp_NCS2G3,#CBre_Comp_NCS6G,
                       type="text",digits=2)



CBre_Comp_NCS2G <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def2_ratio_lag1+cl_US2_avg_sal_lag1+
                   cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS2G)
#Average salary 6 has the highest VIF though but both average salaries are over 2.0 and 2 is more contrary to expectations. Taking it out.
CBre_Comp_NCS2G2 <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def2_ratio_lag1+#cl_US2_avg_sal_lag1+
                   cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS2G2)


#Defense obl 2 have the highest VIF and no coefficient to speak of, dropping it

#Taking out average salary 2 to keep the models snced up.



# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
 stargazer::stargazer(CBre_Cons_NCS3E,CBre_Cons_NCS3F2,CBre_Cons_NCS3F4,CBre_Cons_NCS6G,CBre_Cons_NCS3G3,
                       CBre_Comp_NCS3D,CBre_Comp_NCS3F2,CBre_Comp_NCS3F3,CBre_Comp_NCS6G,CBre_Comp_NCS3G3,
                       type="text",digits=2)


summary_residual_compare(CBre_Cons_NCS3F4,CBre_Cons_NCS3G3,bins=20)
summary_residual_compare(CBre_Comp_NCS3F3,CBre_Comp_NCS3G3,bins=10)
summary_residual_compare(CBre_Cons_NCS3F2,CBre_Cons_NCS3G3,bins=20)
summary_residual_compare(CBre_Comp_NCS3F2,CBre_Comp_NCS3G3,bins=10)

summary_residual_compare(CBre_Cons_NCS3F,CBre_Cons_NCS3G3,bins=20)
summary_residual_compare(CBre_Comp_NCS3D,CBre_Comp_NCS3G3,bins=10)
summary_residual_compare(CBre_Cons_NCS6G,CBre_Cons_NCS3G3,bins=20)
summary_residual_compare(CBre_Comp_NCS6G,CBre_Comp_NCS3G3,bins=10)

```
The hypothesis is upheld. Deviance is a little lower and residuals a little higher than the prior forms of consolidation for the level 3 model.  For the level 6 model, deviance is reduced some in both cases.


##Scope Variables
###Model 02A: Cost Ceiling


```{r Model02A_CBre}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(smp,"UnmodifiedContractBaseAndAllOptionsValue",
               bins=1000)
summary_continuous_plot(subset(smp,UnmodifiedContractBaseAndAllOptionsValue<100000000),
               "UnmodifiedContractBaseAndAllOptionsValue",
               bins=1000)

#Frequency Plot for logged ceiling
summary_continuous_plot(smp,"l_Ceil")

#Model
CBre_Cons_02A <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil, family=binomial(link="logit"))
glmer_examine(CBre_Cons_02C)

CBre_Comp_02A <- glm (data=smp,
                 b_CBre ~n_Comp + cl_Ceil, family=binomial(link="logit"))
glmer_examine(CBre_Comp_02A)


#Plot the fitted model plot
CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}

#Competition curves
fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
                             args=list(Comp=0),color="blue")+
  stat_function(fun = CBre_Comp_02A_curve, 
                             args=list(Comp=2),color="blue")



#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_Comp_02A)

#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_01F, CBre_Cons_02A,CBre_Comp_01B,CBre_Comp_02A,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_01F,CBre_Cons_02A,CBre_Comp_01B,CBre_Comp_02A,bins=2)


```

Contract ceiling has a significant relationship.





###Model 02C: Cost Ceiling and Competition
Larger contracts may encourage bid to win strategies  that could raise ceiling breaches for competition. That is a more indirect effect in consolidated markets.

```{r Model02C_CBre}

#Frequency Plot
summary_continuous_plot(smp,"l_Ceil","EffComp")


#Create the model
CBre_Cons_02C <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + 
                   cl_def6_HHI_lag1:cl_Ceil, family=binomial(link="logit"))
glmer_examine(CBre_Cons_02C)

CBre_Comp_02C <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + 
                   n_Comp:cl_Ceil, family=binomial(link="logit"))
glmer_examine(CBre_Comp_02C)


CBre_Comp_02C_curve<-function(x, Comp){invlogit(cbind(1,Comp,x,Comp*x) %*%  coef(CBre_Comp_02C))}

#Competition Curves
fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02C_curve, 
                             args=list(Comp=0),color="blue")+
  stat_function(fun = CBre_Comp_02C_curve, 
                             args=list(Comp=2),color="blue")

#Plot the fitted values vs actual results
  stargazer::stargazer(CBre_Cons_02A,CBre_Cons_02C,CBre_Comp_02A,CBre_Comp_02C,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_02A,CBre_Cons_02C,CBre_Comp_02A,CBre_Comp_02C,bins=20)


```
The interaction went in the expected direction for competition, but is surprisingly powerful. Competition heightens the importance of contract ceiling, and larger contract ceilings mitigate the importance of competition. The other powerful part of this interaction was the dramatic increase in the coefficient for competition and the comparative reduction in the correlation of ceiling. However, the VIF exceeds 2 by  considerable margin, leaving it out.

The weaker expectation was not upheld with consolidation but is significant. Leaving that in for now. May reflect the efficiencies of more utility like sectors with large contracts.

###Model 02D: Maximum Duration


```{r Model02D_CBre}
#Frequency Plot for max duration
summary_continuous_plot(smp,"UnmodifiedDays",
               bins=1000)

#Frequency Plot for logged max duration
summary_continuous_plot(smp,"l_Days")



#Model
CBre_Cons_02D <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days + 
                   cl_def6_HHI_lag1:cl_Ceil, family=binomial(link="logit"))
glmer_examine(CBre_Cons_02D)

CBre_Comp_02D <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days , family=binomial(link="logit"))
glmer_examine(CBre_Comp_02D)


CBre_Comp_02D_curve<-function(x, Comp,Ceil){invlogit(cbind(1,Comp,Ceil,x,Comp*Ceil) %*%  coef(CBre_Comp_02D))}

#Competition Curves
fitted_cbre_model(smp,"cl_Days") + stat_function(fun = CBre_Comp_02D_curve, 
                             args=list(Comp=0,Ceil=0),color="blue")+
  stat_function(fun = CBre_Comp_02D_curve, 
                             args=list(Comp=2,Ceil=0),color="blue")

#Ceiling Curves
fitted_cbre_model(smp,"cl_Days") +  stat_function(fun = CBre_Comp_02D_curve, 
                             args=list(Comp=0,Ceil=0),color="blue")+
  stat_function(fun = CBre_Comp_02D_curve, 
                             args=list(Comp=0,Ceil=1),color="blue")

#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_Comp_02D)


#Plot residuals versus fitted
residuals_cbre_plot(CBre_Comp_02D)+
  labs(x="Estimated  Pr (Ceiling Breach)")
# debug(binned.resids)
# residuals_cbre_plot(CBre_Comp_02D,"cl_Days")+
  # labs(x="Centered Log(Ceiling)")


  stargazer::stargazer(CBre_Cons_02D,CBre_Comp_02D,type="text",
                       digits=2)

summary_residual_compare(CBre_Cons_02C,CBre_Cons_02D,CBre_Comp_02A,CBre_Comp_02D,bins=20)

```
The initial model results are surprising as ceiling change direction, reducing and correlates with a lower risk of termiation now, although the interaction between competition and ceiling remains roughly the same. The graph of the fitted values shows that this model The next step will be to look at the interaction of ceiling and duration. The difference in deviance for residual difference has more than trippled, an indication of the correlative power of duration. However, the residuals do show a clear pattern that indicates another exponential variable may be necessary. However, the interaction between ceiling and duration is a more important analytical question and will be the next variable added.


###Model 02E: Ceiling and Duration
```{r Mode02E_CBre}

#First a quick scatter plot for terminations by duration and ceiling
ggplot(data=subset(smp,!is.na(l_Ceil)),
       aes(x=l_Days,y=l_Ceil))+geom_point(alpha=0.1)+facet_grid(Term~.)+
  labs(title="Frequency by Termination",
          caption="Source: FPDS, CSIS Analysis")


#Create the model
CBre_Cons_02E <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days + 
                   cl_def6_HHI_lag1:cl_Ceil+
                    cl_Ceil:cl_Days, family=binomial(link="logit"))
glmer_examine(CBre_Cons_02E)


CBre_Comp_02E <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+
                    cl_Ceil:cl_Days, family=binomial(link="logit"))
glmer_examine(CBre_Comp_02E)

CBre_Comp_02E_curve<-function(x, Comp,Ceil){invlogit(
  cbind(1,Comp,Ceil,x,
        Comp*Ceil,x*Ceil) %*%  coef(CBre_Comp_02E))}



#Competition Curves
fitted_cbre_model(smp,"cl_Days") + stat_function(fun = CBre_Comp_02E_curve, 
                             args=list(Comp=0,Ceil=0),color="blue")+
  stat_function(fun = CBre_Comp_02E_curve, 
                             args=list(Comp=2,Ceil=0),color="blue")

#Ceiling Curves
fitted_cbre_model(smp,"cl_Days") +  stat_function(fun = CBre_Comp_02E_curve, 
                             args=list(Comp=0,Ceil=0),color="blue")+
  stat_function(fun = CBre_Comp_02E_curve, 
                             args=list(Comp=0,Ceil=1),color="blue")


  stargazer::stargazer(CBre_Cons_02D,CBre_Cons_02E,CBre_Comp_02D,CBre_Comp_02E,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_02D,CBre_Cons_02E,CBre_Comp_02D,CBre_Comp_02E,bins=20)

```

Excluded by VIF in both cases.The interaction of ceiling and duration has a minimal coefficient and is not significant. Leaving it out.


###Model 02H: Duration and Comp/Cons
Skipping duration^2 and removal of ceiling ^2

Greater duration may limit the influence of competition, at least under the policy guidance that encourages  regular recompeting. In theor this same logic could apply to consolidation as it locks in market conditions at a particular point.

```{r Mode02H_CBre}

#Frequency Plot
summary_continuous_plot(smp,"l_Days","EffComp")

#Create the model
CBre_Cons_02H <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+
                   cl_def6_HHI_lag1:cl_Ceil+
                   cl_def6_HHI_lag1:cl_Days, family=binomial(link="logit"))
glmer_examine(CBre_Cons_02H)

CBre_Comp_02H <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   n_Comp:cl_Days, family=binomial(link="logit"))
glmer_examine(CBre_Comp_02H)
# 
# CBre_Comp_02H_curve<-function(x, Comp,Ceil){invlogit(
#   cbind(1,Comp,Ceil,x,
#         Comp*Ceil,x*Ceil,x*Comp) %*%  coef(CBre_Comp_02H))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Days") + stat_function(fun = CBre_Comp_02H_curve, 
#                              args=list(Comp=0,Ceil=0),color="blue")+
#   stat_function(fun = CBre_Comp_02H_curve, 
#                              args=list(Comp=2,Ceil=0),color="blue")
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_cbre_residuals(CBre_Comp_02H)
# 
# #Plot residuals versus fitted
# residuals_cbre_plot(CBre_Comp_02H)+
#   labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot(CBre_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

stargazer::stargazer(CBre_Cons_02D,CBre_Cons_02H,CBre_Comp_02D,CBre_Comp_02H,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_02D,CBre_Cons_02H,CBre_Comp_02D,CBre_Comp_02H,bins=20)


```
The interaction of competition and duration is significant in itself and also has interesting consequences for other variables, notably boosting the negative cooeficient for competition and reducing the coefficient for duration. However,  VIF excludes this variable.

Contrary to expectation, consolidation matters more for greater duration contracts. Unfortunately the residuals still show questionable patterns that merit continued observation. 


##Contract Vehicle
Our dataset includes both stand alone contract awards and task orders that are under larger indefinite delivery vehilces (IDVs). 

###Model 03A: Single-Award, Multi-Award, and Other Indefinite Delivery Vehicles


```{r Model03A_CBre}
#Frequency Plot
summary_discrete_plot(smp,"Veh")


#Create the model
CBre_Cons_03A <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   cl_def6_HHI_lag1:cl_Ceil  +
                   cl_def6_HHI_lag1:cl_Days
                 , family=binomial(link="logit"))
glmer_examine(CBre_Cons_03A)


CBre_Comp_03A <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh
                  
                   #cl_def6_HHI_lag1:cl_Days
                 , family=binomial(link="logit"))
glmer_examine(CBre_Comp_03A)
# 
# #Plot the model and Vehicle for SIDV
# CBre_Comp_03A_SIDV_curve<-function(x, Comp,Ceil,Days,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,x,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp) %*%  coef(CBre_Comp_03A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_03A_SIDV_curve, 
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_03A_SIDV_curve, 
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# CBre_Comp_03A_MIDV_curve<-function(x, Comp,Ceil,Days,SIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,x,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp) %*%  coef(CBre_Comp_03A))}
# 
# #Plot the model and Vehicle for MIDV
# #Competition curves
# fitted_cbre_model(smp,"MIDV") +
#   stat_function(fun = CBre_Comp_03A_MIDV_curve, 
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_03A_MIDV_curve, 
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# CBre_Comp_03A_OIDV_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,x,
#         Comp*Ceil,Days*Ceil,Days*Comp) %*%  coef(CBre_Comp_03A))}
# 
# #Plot the model and Vehicle for OIDV
# #Competition curves
# fitted_cbre_model(smp,"OIDV") +
#   stat_function(fun = CBre_Comp_03A_OIDV_curve, 
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=0),color="blue")+
#   stat_function(fun = CBre_Comp_03A_OIDV_curve, 
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=0),color="blue")
# 


#Plot the fitted values vs actual results
stargazer::stargazer(CBre_Cons_02H,CBre_Cons_03A,CBre_Comp_02D,CBre_Comp_03A,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_02H,CBre_Cons_03A,CBre_Comp_02D,CBre_Comp_03A,bins=20)

```

The first check lumps looks at three categories of IDVs, each facing a notably lower a risk of termination. The largest negative coefficient is for single award IDCs, multiple award IDVs second, and other IDVs third. The deviation residual notably creeps up after this addition, though this is likely attributable to a missing data problem rather than the new information not being useful. Unfortunately, while the for both ceiling^2 and duration^2 were notably reduced in magnitude, the residuals show significant patterns, underestimating the risk of termination in the fitted range from around 0.005 to 0.01 and overestimating by 0.02. There's no exponential term that makes sense to add here, which leaves the hope that interactions may address this phenomenon.

This may reflect that the Ceiling and Days entries reflect only the task order and not the larger contract. The next step is to check the intersections with ceiling.

###Model 03B: Vehicle and Duration
Expectation, those vehicles that are prone towards particularly short task orders may estimate greater ceiling breaches when they interact with longer durations. This covers Single-Award IDCs and to a lesser extent the dual peaked BPA/BOAs.
```{r Model03B_CBre}

#Frequency Plot
summary_continuous_plot(smp,"l_Days","Veh")




#Create the model
CBre_Cons_03B <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   cl_def6_HHI_lag1:cl_Ceil  +
                   cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days
                 , family=binomial(link="logit"))
glmer_examine(CBre_Cons_03B)

glmer_examine(CBre_Cons_03B)

CBre_Comp_03B <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_def6_HHI_lag1:cl_Ceil  + 
                   #cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days, family=binomial(link="logit"))
glmer_examine(CBre_Comp_03B)

# Plot the model and Vehicle for SIDV
# CBre_Comp_03B_SIDV_curve<-function(x, Comp,Ceil,Days,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,x,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*x,Days*MIDV,Days*OIDV) %*%  coef(CBre_Comp_03B))}
# 
# #Duration curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_03B_SIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=-1,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_03B_SIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=1,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# CBre_Comp_03B_MIDV_curve<-function(x, Comp,Ceil,Days,SIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,x,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*SIDV,Days*x,Days*OIDV) %*%  coef(CBre_Comp_03B))}
# 
# #Plot the model and Vehicle for MIDV
# #Duration Curves
# fitted_cbre_model(smp,"MIDV") +
#   stat_function(fun = CBre_Comp_03B_MIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=-1,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_03B_MIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=1,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# CBre_Comp_03B_OIDV_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,x,BPABOA,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*SIDV,Days*MIDV,Days*x) %*%  coef(CBre_Comp_03B))}
# 
# #Plot the model and Vehicle for FSSGWAC
# #Duration curves
# fitted_cbre_model(smp,"FSSGWAC") +
#   stat_function(fun = CBre_Comp_03B_OIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=-1,
#                                        SIDV=0,MIDV=0),color="blue")+
#   stat_function(fun = CBre_Comp_03B_OIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=1,
#                                        SIDV=0,MIDV=0),color="blue")


  
  CBre_Cons_03B2 <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   cl_def6_HHI_lag1:cl_Ceil  +
                   # cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days
                 , family=binomial(link="logit"))
glmer_examine(CBre_Cons_03B2)

  stargazer::stargazer(CBre_Cons_03A,CBre_Cons_03B2,CBre_Comp_03A,CBre_Comp_03B,type="text",
                         digits=2)
  
  summary_residual_compare(CBre_Cons_03A,CBre_Cons_03B2,CBre_Comp_03A,CBre_Comp_03B,bins=20)

  
```

The vast majority of very short duration contracts are IDVs. The distribution in each of the categories is typically not normal, Other IDVs in particularly being prone to two peaks. Interestingly enough, definitive contracts and purchase orders have the most consistent relationship with terminations, and single-award IDVs the most noisy. For the MIDVs and OIDVs, below l_days=2, or about the average point, there's almost no risk of termination, but that risk steadily rises above that level. 

Interactions:
* Single-Award IDVs have a large negative coefficient, but as the duration grows longer this affect is diminished and the importance of duration grows. 
* Multiple-Award IDVs now have the largest negative coefficient, but to an even greater degree than with Single-Award IDVs, as the duration grows longer this affect is diminished and the importance of duration grows. 
* Other IDVs now have a no longer signicant risk of termination, but the relationship with duration is the reverse of the other two, OIDVs dampen the rise in termination risk for longer contracts.

This variable necessitates the removal of l_days::hhi_lag1. This is a difficult call, as consistency between the comp and cons model is important and the residuals are not improved by the veh:l_days interaction. However, leaving it for now, as at least on the Single-Award side, the theory is better understood here. This may be worth revisiting later.

###Model 03C: Vehicle and Competition
Competition occurs more regularly with definitive contracts, multiple award IDCs, GWACs/FSS, and some BPA/BOA. As a result we expect those vehicles that when interacting with competitive contracts to estiamte lower risk of ceiling breach. For consolidation, we expect single award IDCs and perhaps BPA/BOAs, which  are sometime single award, to be highly influenced by consolidation as competition  doesn't occur after initial selection but the overall market dynamic would instead influence whether contracting officers feel pressured to use that mechanism.


```{r Model03C_CBre}

#Frequency Plot
summary_discrete_plot(smp,"EffComp","Veh")
summary_continuous_plot(smp,"HHI_lag1","Veh")

#Create the model
CBre_Cons_03C <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   cl_def6_HHI_lag1:cl_Ceil  + #cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1, family=binomial(link="logit"))
glmer_examine(CBre_Cons_03C)

CBre_Comp_03C <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                 Veh:cl_Days+
                   Veh:n_Comp, family=binomial(link="logit"))
glmer_examine(CBre_Comp_03C)
# 
# # Plot the model and Vehicle for SIDV
# CBre_Comp_03C_SIDV_curve<-function(x, Comp,Ceil,Days,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,x,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(CBre_Comp_03C))}
# 
# #Competition curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_03C_SIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_03C_SIDV_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# CBre_Comp_03C_MIDV_curve<-function(x, Comp,Ceil,Days,SIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,x,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*SIDV,Days*x,Days*OIDV,
#         Comp*SIDV,Comp*x,Comp*OIDV) %*%  coef(CBre_Comp_03C))}
# 
# #Plot the model and Vehicle for MIDV
# #Competition Curves
# fitted_cbre_model(smp,"MIDV") +
#   stat_function(fun = CBre_Comp_03C_MIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_03C_MIDV_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# CBre_Comp_03C_OIDV_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,x,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*SIDV,Days*MIDV,Days*x,
#         Comp*SIDV,Comp*MIDV,Comp*x) %*%  coef(CBre_Comp_03C))}
# 
# #Plot the model and Vehicle for OIDV
# #Competition curves
# fitted_cbre_model(smp,"OIDV") +
#   stat_function(fun = CBre_Comp_03C_OIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=0),color="blue")+
#   stat_function(fun = CBre_Comp_03C_OIDV_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=0),color="blue")

  stargazer::stargazer(CBre_Cons_03B2,CBre_Cons_03C,CBre_Comp_03B,CBre_Comp_03C,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_03B2,CBre_Cons_03C,CBre_Comp_03B,CBre_Comp_03C,bins=20)

```
The average plots did show varying relationships and slopes between different types of vehicles. However, 
the coeficient for competition itself remains negative, though not significant, despite the baseline vehicle state, definitive/purchase, having higher termination rates among competed contracts. Given the other interactions, this suggests that this phenomenon is already captured by other inputs and interactions in the dataset. 

Interactions
* For single-award IDVs, competition magnifies the lower termination coeffient. This is somewhat surprising, as competition reflects the competed status of the IDV, not the individual task order. Nonetheless, that rate appears to very much matter, and suggests that uncompeted IDVs lose some of their termination reduction correlation.
* For multiple-award IDVs, competition also dampens the termination rate. This also magnificies the import of duration for multiple-award IDVs, which now can complete overcome the base termination coefficient of the vehicle.
* Competition dampens the termination reduction coefficient for other IDVs. It is not significant, I am tempted to leave it out, though it may be appropriate to always leave in the triples.

Unlike the existance of competition, having more offers does not have the same dramatic relationship with multi-award IDVs that it does with competition. This does raise the question as to whether the long tail of high numbers of offers might be undercutting the relationship. However, for now, we will stick with competition. 

VIF concompetition:vehicle exceeds 2, which necessitates removing it. HHI_lag1 results magnify residuals and run contrary to expectations. The deviation reduction at 30 is good, but not amazing. Leaving it out.


###Model 03D: Vehicle and Contract Ceiling
Based on a the descriptive statistics, it appears that the definitive vehicles, multi-award, and FSS/GWACs vary most based on  size. This woud be consistent with the idea that regular reward on these mechanisms might be an important  part of managmening them. By comparison breaking single-award IDCs and the sometimes single-award BPA/BOA into smaller chunks may just not matter to the same degree. Thus the expectation is that  M-IDV, FSS/GWAC, and definitive  (the baseline), will estimate higher risk of ceiling breaches for larger contracts.
```{r Model03D_Comp}

#Frequency Plot
summary_continuous_plot(smp,"l_Ceil","Veh")


#Create the model
CBre_Cons_03D <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   cl_def6_HHI_lag1:cl_Ceil  + #cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_Ceil, family=binomial(link="logit"))
glmer_examine(CBre_Cons_03D)
glmer_examine(CBre_Cons_03D)

CBre_Comp_03D <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_def6_HHI_lag1:cl_Ceil  +
                   #cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days  + 
                   Veh:cl_Ceil, family=binomial(link="logit"))
glmer_examine(CBre_Comp_03D)
# 
# # Plot the model and Vehicle for SIDV
# CBre_Comp_03D_SIDV_curve<-function(x, Comp,Ceil,Days,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,x,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         Ceil*x,Ceil*MIDV,Ceil*OIDV) %*%  coef(CBre_Comp_03D))}
# 
# #Competition curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_03D_SIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_03D_SIDV_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# CBre_Comp_03D_MIDV_curve<-function(x, Comp,Ceil,Days,SIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,x,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*SIDV,Days*x,Days*OIDV,
#         Comp*SIDV,Comp*x,Comp*OIDV,
#         Ceil*SIDV,Ceil*x,Ceil*OIDV) %*%  coef(CBre_Comp_03D))}
# 
# #Plot the model and Vehicle for MIDV
# #Competition Curves
# fitted_cbre_model(smp,"MIDV") +
#   stat_function(fun = CBre_Comp_03D_MIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_03D_MIDV_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# CBre_Comp_03D_OIDV_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,x,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*SIDV,Days*MIDV,Days*x,
#         Comp*SIDV,Comp*MIDV,Comp*x,
#         Ceil*SIDV,Ceil*MIDV,Ceil*x) %*%  coef(CBre_Comp_03D))}
# 
# #Plot the model and Vehicle for OIDV
# #Competition curves
# fitted_cbre_model(smp,"OIDV") +
#   stat_function(fun = CBre_Comp_03D_OIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=0),color="blue")+
#   stat_function(fun = CBre_Comp_03D_OIDV_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=0),color="blue")
# 




CBre_Cons_03D2 <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_Ceil, family=binomial(link="logit"))
glmer_examine(CBre_Cons_03D2)


stargazer::stargazer(CBre_Cons_03B2,CBre_Cons_03D2,
                     CBre_Comp_03B,CBre_Comp_03D,type="text",
                       digits=2)
summary_residual_compare(CBre_Cons_03B2,CBre_Cons_03D2,CBre_Comp_03B,CBre_Comp_03D,bins=20)
summary_residual_compare(CBre_Cons_03A,CBre_Cons_03D2,bins=20)

```

The results are interesting, upholding expectations for definitive award contracts and to a lesser degree for FSS/GWACS, but not for multi-award IDCs. The addition Interestingly, risk for indefinite delivery vehicles seems to depend much more on  duration, whille for definitive contracts ceiling matters most.

VIF for ceiling exceeded 2 for consolidated, and we compared a model with  HHI_lag1:ceiling removed. That reduced devinace and had a mixed effect on residuals, decreasing the magnitude of outliers though slighty throwing off the  highest risk predictions.





##Type of Contract

The next step adds a measure for whether the contract was cost-based or fixed-price. Prior CSIS research has found that fixed-price contracts do face a higher risk of termination across the board.



###Model 04A: Fixed-Price Numerical
```{r Model04A}

#Frequency Plot
summary_discrete_plot(smp,"FxCb")


#Create the model
CBre_Cons_04A <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_Ceil+
                n_Fixed, family=binomial(link="logit"))
glmer_examine(CBre_Cons_04A)

CBre_Comp_04A <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh   + 
                 Veh:cl_Days+
                   Veh:cl_Ceil+
                   n_Fixed,
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_04A)
# 
# # Plot the model and Vehicle 
# CBre_Comp_04A_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(CBre_Comp_04A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_04A_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_04A_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_cbre_residuals(CBre_Comp_04A)
# 
# #Plot residuals versus fittedO
# residuals_cbre_plot(CBre_Comp_04A)+
#   labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot(CBre_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

stargazer::stargazer(CBre_Cons_03D2,CBre_Cons_04A,
                     CBre_Comp_03D,CBre_Comp_04A,type="text",
                       digits=2)
summary_residual_compare(CBre_Cons_03D2,CBre_Cons_04A,CBre_Comp_03D,CBre_Comp_04A,bins=20)

```

And fixed price contracts do indeed have a significant coefficient that correlates with higher termination risk. In addition, the addition of this variable reduces the pattern in the residuals that in the middle range. 



###Model 04B: Fixed-Price Bins
```{r Model04B}

#Frequency Plot
summary_discrete_plot(smp,"FxCb")


#Create the model
CBre_Cons_04B <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_Ceil+
                FxCb, family=binomial(link="logit"))
glmer_examine(CBre_Cons_04B)

CBre_Comp_04B <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   FxCb +
                   #cl_def6_HHI_lag1:cl_Ceil  + 
                 Veh:cl_Days+
                   Veh:cl_Ceil,
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_04B)

# Plot the model and Vehicle 
# CBre_Comp_04B_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(CBre_Comp_04A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_04A_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_04A_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_cbre_residuals(CBre_Comp_04A)
# 
# #Plot residuals versus fittedO
# residuals_cbre_plot(CBre_Comp_04A)+
#   labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot(CBre_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

stargazer::stargazer(CBre_Cons_04A,CBre_Cons_04B,
                     CBre_Comp_04A,CBre_Comp_04B,type="text",
                       digits=2)
summary_residual_compare(CBre_Cons_04A,CBre_Cons_04B,CBre_Comp_04A,CBre_Comp_04B,bins=20)

```

And fixed price contracts do indeed have a significant coefficient that correlates with higher termination risk. In addition, the addition of this variable reduces the pattern in the residuals that in the middle range. 



###Model 04C: Pricing Detail
Firm fixed price contracts have the least flexibility, and thus may estimate a higher probability of ceilign breach. By comparison, time and materials contracts, labor hours, and fixed-price level of effort contracts are comparatively straightforward  but also lack fees meant to incentive cost savings. Thus they may estimate a higher probability of ceiling breach than narrowly defined cost plus contracts.
```{r Model04C}

#Frequency Plot
summary_discrete_plot(smp,"FxCb")
summary_discrete_plot(smp,"Fee")
summary_discrete_plot(smp,"FxCb","Fee")



summary_discrete_plot(smp,"Pricing",rotate=FALSE)

#Create the model
CBre_Cons_04C <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_Ceil+
                Pricing, family=binomial(link="logit"))
glmer_examine(CBre_Cons_04C)

CBre_Comp_04C <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   Pricing +
                   #cl_def6_HHI_lag1:cl_Ceil  + 
                 Veh:cl_Days+
                   Veh:cl_Ceil,
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_04C)

# Plot the model and Vehicle 
# CBre_Comp_04B_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(CBre_Comp_04A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_04A_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_04A_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_cbre_residuals(CBre_Comp_04A)
# 
# #Plot residuals versus fittedO
# residuals_cbre_plot(CBre_Comp_04A)+
#   labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot(CBre_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

stargazer::stargazer(CBre_Cons_04B,CBre_Cons_04C,
                     CBre_Comp_04B,CBre_Comp_04C,type="text",
                       digits=2)
summary_residual_compare(CBre_Cons_04A,CBre_Cons_04B,CBre_Comp_04B,CBre_Comp_04C,bins=20)

```


###Model 04D: Incentive Fees

In the performance of the defense acquisition system report, the benefits found were reduced cost overruns. That could help avoid terminations, but it's an indirect connection at best. Unfortunately, incentive fees are incredibly rare, which makes them challenging to examine directly.


```{r Model04D_CBre}

#Frequency Plot
summary_discrete_plot(smp,"Fee")



summary(factor(smp$PricingFee))

#Create the model
CBre_Cons_04D <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_Ceil+
                PricingFee, family=binomial(link="logit"))
glmer_examine(CBre_Cons_04D)

CBre_Comp_04D <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_def6_HHI_lag1:cl_Ceil  + 
                 Veh:cl_Days+
                   
                   Veh:cl_Ceil+
                                   PricingFee , 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_04D)
glmer_examine(CBre_Comp_04D)

# 
# # Plot the model and Vehicle 
# CBre_Comp_04D_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(CBre_Comp_04D))}
# 
# #Days curves
# fitted_cbre_model(smp,"n_Incent") +
#   stat_function(fun = CBre_Comp_04D_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,Fixed=1),color="blue")+
#   stat_function(fun = CBre_Comp_04D_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,Fixed=1),color="blue")


# #Plot the fitted values vs actual results
# binned_fitted_versus_cbre_residuals(CBre_Comp_04D)
# 
# #Plot residuals versus fittedO
# residuals_cbre_plot(CBre_Comp_04D)+
#   labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot(CBre_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

stargazer::stargazer(CBre_Cons_04C,CBre_Cons_04D,
                     CBre_Comp_04C,CBre_Comp_04D,type="text",
                       digits=2)
summary_residual_compare(CBre_Cons_04C,CBre_Cons_04D,
                         CBre_Comp_04C,CBre_Comp_04D,bins=20)

```

The effect of incentive fees are not significant. They do have a noteworthy coefficient, however, given prior research on their ability to prevent cost overruns, their lowered heightened probably of terminations lacks an immdetiate explaintation. There's also a fair amount of unlabeled data, which reduces the samplle size. It's still worth checking the interaction with fixed price, as they are based on a common field in FPDS and the two are closely related in concept.


###Model 04E: Fixed-Price and Base Duration
Past CSIS research has found that fixed-price contracts do appear to be at higher risk if they have a longer maximum duration. Fixed-price contracting does require upfront estimation of likely costs, and thus a longer duration means more opportunity for changed circumstance.

Time&Materials/Labor Hours/Fixed-Price Level of Effort are typically used for smaller projects, but may not scale as well for longer lasting projects. 
```{r Model04E_CBre}

#Frequency Plot
summary_continuous_plot(smp,"l_Days","PricingFee")

#Create the model
CBre_Cons_04E <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_Ceil+
                PricingFee+
                   cl_Days:PricingFee, family=binomial(link="logit"))
glmer_examine(CBre_Cons_04E)
glmer_examine(CBre_Cons_04E)

CBre_Comp_04E <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_def6_HHI_lag1:cl_Ceil  + 
                 Veh:cl_Days+
                   
                   Veh:cl_Ceil+
                                      PricingFee +
                   cl_Days:PricingFee , 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_04E)
glmer_examine(CBre_Comp_04E)

# Plot the model and Vehicle 
# CBre_Comp_04E_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         Days*x) %*%  coef(CBre_Comp_04E))}

# #Days curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_04E_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_04E_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_cbre_residuals(CBre_Comp_04E)
# 
# #Plot residuals versus fittedO
# residuals_cbre_plot(CBre_Comp_04E)+
#   labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot(CBre_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")


CBre_Cons_04E2 <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_def6_HHI_lag1:cl_Days +
                 # Veh:cl_Days+
                   Veh:cl_Ceil+
                PricingFee+
                   cl_Days:PricingFee, family=binomial(link="logit"))
glmer_examine(CBre_Cons_04E2)
glmer_examine(CBre_Cons_04E2)

CBre_Comp_04E2 <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_def6_HHI_lag1:cl_Ceil  + 
                 # Veh:cl_Days+
                   
                   Veh:cl_Ceil+
                                      PricingFee +
                   cl_Days:PricingFee , 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_04E2)

stargazer::stargazer(CBre_Cons_04C,CBre_Cons_04E2,
                     CBre_Comp_04C,CBre_Comp_04E2,type="text",
                       digits=2)
summary_residual_compare(CBre_Cons_04C,CBre_Cons_04E2,CBre_Comp_04C,CBre_Comp_04E2,bins=20)

```
The probability of termination by duration chart is more clearcut with fixed price than with cost-based contracts. However, the variable does not appreciably decrease the deviation, is not significant, and undercuts the significance of other variables. It will not be added tto the model.


###Model 04F: Fixed-Price and Vehicle


```{r Model04F_CBre}

#Frequency Plot
summary_discrete_plot(smp,"FxCb","Veh")

#Create the model

#Create the model
CBre_Cons_04F <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_Ceil+
                FxCb+FxCb:Veh, family=binomial(link="logit"))
glmer_examine(CBre_Cons_04F)

CBre_Comp_04F <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   FxCb +
                   #cl_def6_HHI_lag1:cl_Ceil  + 
                 Veh:cl_Days+
                   Veh:cl_Ceil+
                   FxCb:Veh,
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_04F)
# Plot the model and Vehicle for SIDV
# CBre_Comp_04F_curve<-function(x, Comp,Ceil,Days,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         n_Fixed,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*SIDV,Days*MIDV,Days*OIDV,
#         Comp*SIDV,Comp*MIDV,Comp*OIDV,
#         x*SIDV,x*MIDV,x*OIDV
#         ) %*%  coef(CBre_Comp_04F))}
# 
# #Vehicle curves
# fitted_cbre_model(smp,"n_Fixed") +
#   stat_function(fun = CBre_Comp_04F_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=1,MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_04F_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=1,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_04F_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=0,OIDV=1),color="blue")
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_cbre_residuals(CBre_Comp_04F)
# 
# #Plot residuals versus fittedO
# residuals_cbre_plot(CBre_Comp_04F)+
#   labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot(CBre_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")
stargazer::stargazer(CBre_Cons_04C,CBre_Cons_04F,
                     CBre_Comp_04C,CBre_Comp_04F,type="text",
                       digits=2)
summary_residual_compare(CBre_Cons_04C,CBre_Cons_04F,CBre_Comp_04C,CBre_Comp_04F,bins=20)

```
The interactions are not significant and do little to reduce the residual deviance. They will not be added to the model. They exceed VIF of 2 in both cases.



###Model 04G: Fixed-Price and Ceiling
Past CSIS research has found that fixed-price contracts do appear to be at higher risk if they have a longer maximum duration. Fixed-price contracting does require upfront estimation of likely costs, and thus a higher ceiling does often mean higher risk.

Time&Materials/Labor Hours/Fixed-Price Level of Effort are typically used for smaller projects, but may not scale as well for large contracts.

Incentive fees, in theory, should do a estimate lower ceiling breaches as they incentive cost savings and are more oriented towards large projects.

```{r Model04G_CBre}

#Frequency Plot
summary_continuous_plot(smp,"l_Ceil","PricingFee")

#Create the model
CBre_Cons_04G <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_Ceil+
                PricingFee+
                   cl_Ceil:PricingFee, family=binomial(link="logit"))
glmer_examine(CBre_Cons_04G)
glmer_examine(CBre_Cons_04G)

CBre_Comp_04G <- glm (data=smp,
                 b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_def6_HHI_lag1:cl_Ceil  + 
                 Veh:cl_Days+
                   Veh:cl_Ceil+
                                      PricingFee +
                   cl_Ceil:PricingFee , 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_04G)
glmer_examine(CBre_Comp_04G)

# Plot the model and Vehicle 
# CBre_Comp_04G_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         Days*x) %*%  coef(CBre_Comp_04G))}

# #Days curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_04G_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_04G_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_cbre_residuals(CBre_Comp_04G)
# 
# #Plot residuals versus fittedO
# residuals_cbre_plot(CBre_Comp_04G)+
#   labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot(CBre_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")


stargazer::stargazer(CBre_Cons_04C,CBre_Cons_04G,
                     CBre_Comp_04C,CBre_Comp_04G,type="text",
                       digits=2)
summary_residual_compare(CBre_Cons_04C,CBre_Cons_04G,CBre_Comp_04C,CBre_Comp_04G,bins=20)

```

###Model 04H: Undefinitized Contract Awards
Undefinitized Contract Awards allow for quick action in situations where there is not time or information to establish all of a contracts properties at the time of signing. They have been found by the GAO and the Performance of the Defense Acquisition studies to contain notable risks, primarily relating to cost overruns and thus ceiling breaches. Will these risks also carry into terminations and ceiling breaches?


```{r Model04H_CBre}

#Frequency Plot
summary_discrete_plot(smp,"UCA")



#Create the model
CBre_Cons_04H <- glm (data=smp,
                 b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_Ceil+
                PricingFee+ b_UCA +
                   cl_Ceil:PricingFee, family=binomial(link="logit"))
glmer_examine(CBre_Cons_04H)
glmer_examine(CBre_Cons_04H)


#Create the model
CBre_Comp_04H <- glm (data=smp,
b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                    b_UCA +
                   #cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_Ceil+
                PricingFee+
                   cl_Ceil:PricingFee, family=binomial(link="logit"))
glmer_examine(CBre_Comp_04H)

# Plot the model and Vehicle 
# CBre_Comp_04H_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(CBre_Comp_04H))}


#Days curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_04H_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1),color="blue")+
#   stat_function(fun = CBre_Comp_04H_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1),color="blue")
# 
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_cbre_residuals(CBre_Comp_04H)
# 
# #Plot residuals versus fittedO
# residuals_cbre_plot(CBre_Comp_04H)+
#   labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot(CBre_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")
stargazer::stargazer(CBre_Cons_04G,CBre_Cons_04H,
                     CBre_Comp_04G,CBre_Comp_04H,type="text",
                       digits=2)
summary_residual_compare(CBre_Cons_04G,CBre_Cons_04H,CBre_Comp_04G,CBre_Comp_04H,bins=20)


```


###Model 04I: UCA and Competition
Based on GAO research, uncompeted UCA are high risk and  thus should estimate a greater probability of  ceiling  breach. The same logic potentially holds for consolidation.
```{r Model04I_Comp}

#Frequency Plot
summary_discrete_plot(smp,"UCA","n_Comp")
summary_continuous_plot(smp,"cl_def6_HHI_lag1","UCA")

#Create the model

CBre_Cons_04I <- glm (data=smp,
b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   PricingFee + b_UCA +
                  
                 Veh:cl_Days+
                   # Veh:cl_def6_HHI_lag1  +
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                b_UCA:cl_def6_HHI_lag1
                    , family=binomial(link="logit"))
glmer_examine(CBre_Cons_04I)

CBre_Comp_04I <- glm (data=smp,
b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh  +
  PricingFee+ b_UCA +
                 Veh:cl_Days+
                   
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                   
                b_UCA:n_Comp
                    , family=binomial(link="logit"))
glmer_examine(CBre_Comp_04I)



# Plot the model and Vehicle 
# CBre_Comp_04I_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(CBre_Comp_04I))}
# 
# #Days curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_04I_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1),color="blue")+
#   stat_function(fun = CBre_Comp_04I_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1),color="blue")

stargazer::stargazer(CBre_Cons_04H,CBre_Cons_04I,
                     CBre_Comp_04H,CBre_Comp_04I,type="text",
                       digits=2)
summary_residual_compare(CBre_Cons_04H,CBre_Cons_04I,CBre_Comp_04H,CBre_Comp_04I,bins=20)


```
The interaction of UCA and Comp does align with the findings of the GAO as to the heightened risk of uncompeted UCA. However, the results are not significant. The results for consolidation are significant 






###Model 04J: UCA and Duration

While duration tracks the base duration and not the length spent in UCA, nonetheless longer length should estimate a higher probability of breach.
```{r Model04K_Term}


#Frequency Plot
summary_continuous_plot(smp,"l_Days","UCA")

CBre_Cons_04J <- glm (data=smp,
b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   PricingFee + b_UCA +
                  
                 Veh:cl_Days+
                   # Veh:cl_def6_HHI_lag1  +
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                b_UCA:cl_def6_HHI_lag1 + 
                  b_UCA:l_Days
                    , family=binomial(link="logit"))
glmer_examine(CBre_Cons_04J)

CBre_Comp_04J <- glm (data=smp,
b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh  +
  PricingFee+ b_UCA +
                 Veh:cl_Days+
                   
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                   
                b_UCA:n_Comp + 
                  b_UCA:l_Days
                    , family=binomial(link="logit"))
glmer_examine(CBre_Comp_04J)




# Plot the model and Vehicle 
# Term_Comp_04J_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         Comp*x,Days*x) %*%  coef(Term_Comp_04J))}
# 
# #Days curves
# discrete_fitted_term_model(smp,"SIDV") +
#   stat_function(fun = Term_Comp_04J_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1),color="blue")+
#   stat_function(fun = Term_Comp_04J_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1),color="blue")

CBre_Cons_04J2 <- glm (data=smp,
b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   PricingFee + b_UCA +
                  
                 # Veh:cl_Days+
                   # Veh:cl_def6_HHI_lag1  +
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                b_UCA:cl_def6_HHI_lag1 + 
                  b_UCA:l_Days
                    , family=binomial(link="logit"))
glmer_examine(CBre_Cons_04J2)

CBre_Comp_04J2 <- glm (data=smp,
b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh  +
  PricingFee+ b_UCA +
                 # Veh:cl_Days+
                   
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                   
                b_UCA:n_Comp + 
                  b_UCA:l_Days
                    , family=binomial(link="logit"))
glmer_examine(CBre_Comp_04J2)



stargazer::stargazer(CBre_Cons_04I,CBre_Cons_04J2,
                     CBre_Comp_04I,CBre_Comp_04J2,type="text",
                       digits=2)
summary_residual_compare(CBre_Cons_04I,CBre_Cons_04J2,CBre_Comp_04I,CBre_Comp_04J2,bins=20)



```

UCA:l_Days violates VIF even with removal of other da 

###Model 04K: UCA and Ceiling

Here the possible risk is similar to days, that larger, and thus possibly more complex projects, are at greater risk with UCA and that UCA and high ceiling estimate a higher chance of breaches.
```{r Model04K_Term}


#Frequency Plot
summary_continuous_plot(smp,"l_Ceil","UCA")

CBre_Cons_04K <- glm (data=smp,
b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   PricingFee + b_UCA +
                  
                 Veh:cl_Days+
                   # Veh:cl_def6_HHI_lag1  +
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                b_UCA:cl_def6_HHI_lag1 + 
                  b_UCA:cl_Ceil
                    , family=binomial(link="logit"))
glmer_examine(CBre_Cons_04K)

CBre_Comp_04K <- glm (data=smp,
b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh  +
  PricingFee+ b_UCA +
                 Veh:cl_Days+
                   
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                   
                b_UCA:n_Comp + 
                  b_UCA:cl_Ceil
                    , family=binomial(link="logit"))
glmer_examine(CBre_Comp_04K)



# Plot the model and Vehicle 
# Term_Comp_04K_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         Comp*x,Days*x) %*%  coef(Term_Comp_04K))}
# 
# #Days curves
# discrete_fitted_term_model(smp,"SIDV") +
#   stat_function(fun = Term_Comp_04K_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1),color="blue")+
#   stat_function(fun = Term_Comp_04K_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1),color="blue")

CBre_Cons_04K2 <- glm (data=smp,
b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   PricingFee + b_UCA +
                  
                 # Veh:cl_Days+
                   # Veh:cl_def6_HHI_lag1  +
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                b_UCA:cl_def6_HHI_lag1 + 
                  b_UCA:l_Days
                    , family=binomial(link="logit"))
glmer_examine(CBre_Cons_04K2)

CBre_Comp_04K2 <- glm (data=smp,
b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh  +
  PricingFee+ b_UCA +
                 # Veh:cl_Days+
                   
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                   
                b_UCA:n_Comp + 
                  b_UCA:l_Days
                    , family=binomial(link="logit"))
glmer_examine(CBre_Comp_04K2)



stargazer::stargazer(CBre_Cons_04I,CBre_Cons_04K,
                     CBre_Comp_04I,CBre_Comp_04K,type="text",
                       digits=2)
summary_residual_compare(CBre_Cons_04I,CBre_Cons_04K,CBre_Comp_04I,CBre_Comp_04K,bins=20)



```
The results are counter-intuitive but strong. Based on the descriptive statistics it appears that  mid-range, not the largest UCAs, have the great risk of breaches.

###Model 04L: Pricing and Average Wage
Fixed Price is less  appropriate as an approach when there is greater uncertainty. A phenomenon likely to extend to time and materials / labor hours contracts. By comparison, fixed price incentive and cost based should estimate a lower risk of ceiling breaches and terminations.

```{r Model04L_Wage}


#Frequency Plot
summary_continuous_plot(smp,"l_Ceil","UCA")

CBre_Cons_04L <- glm (data=smp,
b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   PricingFee + b_UCA +
                  
                 Veh:cl_Days+
                   # Veh:cl_def6_HHI_lag1  +
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  cl_US6_avg_sal_lag1+
  cl_US6_avg_sal_lag1:PricingFee+
  # b_UCA:cl_Ceil+
                b_UCA:cl_def6_HHI_lag1 + 
                  b_UCA:cl_Ceil
                    , family=binomial(link="logit"))
glmer_examine(CBre_Cons_04L)

CBre_Comp_04L <- glm (data=smp,
b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh  +
  PricingFee+ b_UCA +
                 Veh:cl_Days+
                   
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                   
  cl_US6_avg_sal_lag1+
  cl_US6_avg_sal_lag1:PricingFee+
                b_UCA:n_Comp + 
                  b_UCA:cl_Ceil
                    , family=binomial(link="logit"))
glmer_examine(CBre_Comp_04L)


#Frequency Plot


CBre_Cons_04L2 <- glm (data=smp,
b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   PricingFee + b_UCA +
                  
                 Veh:cl_Days+
                   # Veh:cl_def6_HHI_lag1  +
                   Veh:cl_Ceil+
  # cl_Ceil:PricingFee+
  cl_US6_avg_sal_lag1+
  cl_US6_avg_sal_lag1:PricingFee+
  # b_UCA:cl_Ceil+
                b_UCA:cl_def6_HHI_lag1 + 
                  b_UCA:cl_Ceil
                    , family=binomial(link="logit"))
glmer_examine(CBre_Cons_04L2)

CBre_Comp_04L2 <- glm (data=smp,
b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh  +
  PricingFee+ b_UCA +
                 Veh:cl_Days+
                   
                   Veh:cl_Ceil+
  # cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                   
  cl_US6_avg_sal_lag1+
  cl_US6_avg_sal_lag1:PricingFee+
                b_UCA:n_Comp + 
                  b_UCA:cl_Ceil
                    , family=binomial(link="logit"))
glmer_examine(CBre_Comp_04L2)



# Plot the model and Vehicle 
# Term_Comp_04L_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         Comp*x,Days*x) %*%  coef(Term_Comp_04L))}
# 
# #Days curves
# discrete_fitted_term_model(smp,"SIDV") +
#   stat_function(fun = Term_Comp_04L_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1),color="blue")+
#   stat_function(fun = Term_Comp_04L_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1),color="blue")




stargazer::stargazer(CBre_Cons_04L2,
                     CBre_Comp_04L2,type="text",
                       digits=2)
summary_residual_compare(CBre_Cons_04L2,CBre_Cons_04L2,CBre_Comp_04L2,CBre_Comp_04L2,bins=20)



```
##Place of Performance
###Model 05A: Any International

International contracts may often be in conflict zones and thus experience greater risk. International contracts are exepected to estimate a higher probability of ceiling breaches.
```{r Model05A_Comp}

#Frequency Plot
summary_discrete_plot(smp,"Intl")



#Create the model
CBre_Cons_05A <- glm (data=smp,
b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   PricingFee + b_UCA +
  b_Intl+
                  
                 Veh:cl_Days+
                   # Veh:cl_def6_HHI_lag1  +
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                b_UCA:cl_def6_HHI_lag1 + 
                  b_UCA:cl_Ceil
                    , family=binomial(link="logit"))
glmer_examine(CBre_Cons_05A)

CBre_Comp_05A <- glm (data=smp,
b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh  +
  PricingFee+ b_UCA +
  b_Intl+
                 Veh:cl_Days+
                   
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                   
                b_UCA:n_Comp + 
                  b_UCA:cl_Ceil
                    , family=binomial(link="logit"))
glmer_examine(CBre_Comp_05A)

# Plot the model and Vehicle 
# CBre_Comp_05A_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,UCA,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         UCA*Comp) %*%  coef(CBre_Comp_05A))}
# 
# #Days curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_05A_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1,UCA=0),color="blue")+
#   stat_function(fun = CBre_Comp_05A_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1,UCA=0),color="blue")


stargazer::stargazer(CBre_Cons_04K,CBre_Cons_05A,
                     CBre_Comp_04K,CBre_Comp_05A,type="text",
                       digits=2)
summary_residual_compare(CBre_Cons_04K,CBre_Cons_05A,CBre_Comp_04K,CBre_Comp_05A,bins=20)



```

International performance of contract had a positive  coefficent as expected.


###Model 05B: Fixed Price and Any International

Firm fixed price contracts and to a less degree other fixed-price contracts and time and materials/labor hours/fixed price level of effort contracts may be more vulnerable to changing conditions internationally. Thus they may estimate a higher rate of ceiling breaches.
```{r Model05B_Comp}

#Frequency Plot
summary_discrete_plot(smp,"Intl","PricingFee")



#Create the model
CBre_Cons_05B <- glm (data=smp,
b_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   PricingFee + b_UCA +
  b_Intl+
                  
                 Veh:cl_Days+
                   # Veh:cl_def6_HHI_lag1  +
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                b_UCA:cl_def6_HHI_lag1 + 
                  b_UCA:cl_Ceil+
  
  b_Intl:PricingFee
                    , family=binomial(link="logit"))
glmer_examine(CBre_Cons_05B)

CBre_Comp_05B <- glm (data=smp,
b_CBre ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh  +
  PricingFee+ b_UCA +
  b_Intl+
                 Veh:cl_Days+
                   
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                   
                b_UCA:n_Comp + 
                  b_UCA:cl_Ceil+
  
  b_Intl:PricingFee
                    , family=binomial(link="logit"))
glmer_examine(CBre_Comp_05B)

# Plot the model and Vehicle 
# CBre_Comp_05B_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,UCA,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         UCA*Comp) %*%  coef(CBre_Comp_05B))}
# 
# #Days curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_05B_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1,UCA=0),color="blue")+
#   stat_function(fun = CBre_Comp_05B_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1,UCA=0),color="blue")


stargazer::stargazer(CBre_Cons_05A,CBre_Cons_05B,
                     CBre_Comp_05A,CBre_Comp_05B,type="text",
                       digits=2)
summary_residual_compare(CBre_Cons_05A,CBre_Cons_05B,CBre_Comp_05A,CBre_Comp_05B,bins=20)



```
Due in part to small sample sizes, the results were fairly extreme, including a coefficient of -11 for other fixed price. They also did not reduce model deviance by much and ran contrary to hypotheses. Leaving this out.
###Model 05C: Vehicle and Any International
Mechanisms like multi-award IDCs and GWAC/FSS use a known pool of contractors but still incorporate competition. Multi-award was emphasized in part after earlier scandals as preferable to single-award IDCs. Thus multi-award IDCs, and perhaps other vehicles that offer task order competition, is expected to estimate a lower rate of ceiling breaches. 


```{r Model05C}

#Frequency Plot
summary_discrete_plot(smp,"Intl","Veh")



#Create the model
CBre_Cons_05C <- glm (data=smp,
                      b_CBre ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                       
                        Veh:cl_Days+
                        # Veh:cl_def6_HHI_lag1  +
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        # b_UCA:cl_Ceil+
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_05C)

CBre_Comp_05C <- glm (data=smp,
                      b_CBre ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        # b_UCA:cl_Ceil+
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh 
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_05C)



# # Plot the model and Vehicle 
# Term_Comp_05C_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,UCA,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         UCA*Comp) %*%  coef(Term_Comp_05C))}
# 
# #Days curves
# discrete_fitted_term_model(smp,"SIDV") +
#   stat_function(fun = Term_Comp_05C_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1,UCA=0),color="blue")+
#   stat_function(fun = Term_Comp_05C_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1,UCA=0),color="blue")
# 
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_residuals(Term_Comp_05C)
# 
# #Plot residuals versus fittedO
# residuals_term_plot(Term_Comp_05C)+
#   labs(x="Estimated  Pr (Termination)")

# residuals_term_plot(Term_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")
stargazer::stargazer(CBre_Cons_05A,CBre_Cons_05C,
                     CBre_Comp_05A,CBre_Comp_05C,type="text",
                       digits=2)
summary_residual_compare(CBre_Cons_05A,CBre_Cons_05C,CBre_Comp_05A,CBre_Comp_05C,bins=20)

```


##Who
Adding who resulted in a range of models that failed to converge. The one exception was combining Product/Service/R&D alone and Who, which did require removing multiple interactions from the model before convergence could be reached, but did allow the continued inclusion of  the combination of Product/Service/R&D and competition. All other models have been commented out to allow for the Markdown file  to  be created in a manageable amount of time. The study team initially considered using start year or contracting office identity as additional non-nested levels. However, those models failed to converge or had eigenvalue related challenges. As a result, the study team chose to focus on the question of what is being acquired. Who is acquiring is instead being handled by individual dummy variables or group level summary variables where appropriate, but not by seperate intercepts or slopes. Start year is not included in the model because of the complicatitons related to durations. Namely longer duration contracts from recent years have not yet had the opportunity to live out their natural life span. This means  that recent years will have an artificially high termination rate for longer contracts, because we only know about those that ended before their maximum duration, often due to termination.


###Model 06A: Agency
Other DoD stands out for its sheer quantity of contracts and task orders and also its lower termination rate. It includes the DLA which specializes in logistic delivery, and may thus estimate a lower rate of ceiling breahces.
```{r Model06A}
    #Frequency Plot
  summary_discrete_plot(def,"Agency",rotate_text=TRUE)
    summary_discrete_plot(def,rotate_text=TRUE)
    summary_discrete_plot(def,"b_ODoD",rotate_text=TRUE)


#Create the model
CBre_Cons_06A <- glm (data=smp,
                      b_CBre ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        Agency+
                       
                        Veh:cl_Days+
                        # Veh:cl_def6_HHI_lag1  +
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        # b_UCA:cl_Ceil+
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_06A)

CBre_Cons_06A2 <- glm (data=smp,
                      b_CBre ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        Agency+
                       
                        Veh:cl_Days+
                        # Veh:cl_def6_HHI_lag1  +
                        Veh:cl_Ceil+
                        # cl_Ceil:PricingFee+
                        # b_UCA:cl_Ceil+
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_06A2)


CBre_Cons_06A3 <- glm (data=smp,
                      b_CBre ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        Agency+
                       
                        Veh:cl_Days+
                        # Veh:cl_def6_HHI_lag1  +
                        # Veh:cl_Ceil+
                        # cl_Ceil:PricingFee+
                        # b_UCA:cl_Ceil+
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_06A3)


CBre_Comp_06A <- glm (data=smp,
                      b_CBre ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        Agency+
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        # b_UCA:cl_Ceil+
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh 
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_06A)

CBre_Comp_06A2 <- glm (data=smp,
                      b_CBre ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        Agency+
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        # cl_Ceil:PricingFee+
                        # b_UCA:cl_Ceil+
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh 
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_06A2)


CBre_Comp_06A3 <- glm (data=smp,
                      b_CBre ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        Agency+
                        Veh:cl_Days+
                        
                        # Veh:cl_Ceil+
                        # cl_Ceil:PricingFee+
                        # b_UCA:cl_Ceil+
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh 
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_06A3)





  stargazer::stargazer(CBre_Cons_05C,CBre_Cons_06A3,CBre_Comp_05C,CBre_Comp_06A3,type="text",
                       digits=2)
  
summary_residual_compare(CBre_Cons_05C,CBre_Cons_06A3,CBre_Comp_05C,CBre_Comp_06A3,bins=20)

rm(CBre_Comp_06A,CBre_Comp_06A2,CBre_Cons_06A,CBre_Cons_06A2)
```


### Model 06B: Less detailed pricing?

After inclusion of agency, the deviance of both models are reduced considerably (over 1000). The residuals show an even more pronounced dip at low levels for competition. Vehicle:Ceiling and Pricing:Ceiling are both dropped from the model due to VIF. The next step will be to see if the less detailed version of pricing would allow us to add back that interaction.



```{r Model06B}
    #Frequency Plot
  summary_continuous_plot(def,"l_Ceil","Pricing")
    


CBre_Cons_06B <- glm (data=smp,
                      b_CBre ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        Pricing + b_UCA +
                        b_Intl+
                        Agency+
                       
                        Veh:cl_Days+
                        # Veh:cl_def6_HHI_lag1  +
                        # Veh:cl_Ceil+
                        cl_Ceil:Pricing+
                        # b_UCA:cl_Ceil+
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_06B)



CBre_Comp_06B <- glm (data=smp,
                      b_CBre ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        Pricing+ b_UCA +
                        b_Intl+
                        Agency+
                        Veh:cl_Days+
                        
                        # Veh:cl_Ceil+
                        cl_Ceil:Pricing+
                        # b_UCA:cl_Ceil+
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh 
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_06B)





  stargazer::stargazer(CBre_Cons_06A3,CBre_Cons_06B,CBre_Comp_06A3,CBre_Comp_06B,type="text",
                       digits=2)
  
summary_residual_compare(CBre_Cons_06A3,CBre_Cons_06B,CBre_Comp_06A3,CBre_Comp_06B,bins=20)

rm(CBre_Cons_06B,CBre_Comp_06B)

```
Even with the simpler version of pricing, VIF exceeds 2 in both cases, leaving this out.



### Model 06C: Removing veh:day
While not strictly violating VIF, l_Day:Veh has vif values approaching 2 and is only significant for SIDCs, removing it seems worth considering. This may be appropriate because much of the explanatory power of vehicle appears to have been captured by agency.
```{r Model06C}

#Create the model

CBre_Cons_06C <- glm (data=smp,
                      b_CBre ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        Agency+
                       
                        # Veh:cl_Days+
                        # Veh:cl_def6_HHI_lag1  +
                        
                        
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_06C)


CBre_Comp_06C <- glm (data=smp,
                      b_CBre ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        Agency+
                        # Veh:cl_Days+
                        
                        
                        
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh 
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_06C)





  stargazer::stargazer(CBre_Cons_06A3,CBre_Cons_06C,CBre_Comp_06A3,CBre_Comp_06C,type="text",
                       digits=2)
  
summary_residual_compare(CBre_Cons_06A3,CBre_Cons_06C,CBre_Comp_06A3,CBre_Comp_06C,bins=20)

```

Removing Veh:Days has only causes a small increase in deviance and notably reduces the residual pit for the competition model. Leaving it out.

### Model 06D: Removing veh:Intl
Vehicle:International is not a VIF risk, but the results are no longer significant for most variables nor do they align with expecations. Checking whether removing it makes sense.
```{r Model06D}

#Create the model

CBre_Cons_06D <- glm (data=smp,
                      b_CBre ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        Agency+
                       
                        
                        # Veh:cl_def6_HHI_lag1  +
                        
                        
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil
                        
                        # b_Intl:Veh
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_06D)


CBre_Comp_06D <- glm (data=smp,
                      b_CBre ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        Agency+
                        
                        
                        
                        
                        # b_UCA:cl_Ceil+
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil
                        
                        # b_Intl:Veh 
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_06D)





  stargazer::stargazer(CBre_Cons_06C,CBre_Cons_06D,CBre_Comp_06C,CBre_Comp_06D,type="text",
                       digits=2)
  
summary_residual_compare(CBre_Cons_06C,CBre_Cons_06D,CBre_Comp_06C,CBre_Comp_06D,bins=20)

```
Leaving out Veh:Intl increases the deviance by less than 10 points and slightly reduces the residuals. Taking it out.

##What
### Model 07A: NAICS2
```{r Model07A}
corrdisp<-Hmisc::rcorr(
  as.matrix(cbind(subset(crisis_smp, select=c(b_UCA,c_OffCri,cl_Ceil,
                                              cl_Days,n_Fixed,b_Intl)),
                  dummies::dummy(crisis_smp$Crisis),
                  dummies::dummy(crisis_smp$NoComp),
                  dummies::dummy(crisis_smp$Reach),
                  dummies::dummy(crisis_smp$Veh),
                  dummies::dummy(crisis_smp$Is.Defense),
                  dummies::dummy(crisis_smp$Simple))))
corrdisp[[1]]

#Sumamry plot
summary_discrete_plot(smp1m,"NAICS2",rotate_text=TRUE)
CBre_Cons_07A <- glm (data=smp,
                      b_CBre ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+

                       
                        
                        # Veh:cl_def6_HHI_lag1  +
                        
                        
                        
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                                                Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_07A)

CBre_Comp_07A <- glm (data=smp,
                      b_CBre ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+

                        
                        
                        
                        
                        
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        
                                                Agency+
                   NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_07A)


  stargazer::stargazer(CBre_Cons_06D,CBre_Cons_07A,CBre_Comp_06D,CBre_Comp_07A,type="text",
                       digits=2)
  
summary_residual_compare(CBre_Cons_06D,CBre_Cons_07A,CBre_Comp_06D,CBre_Comp_07A,bins=20)


```

Unlike agency, the temporary addition of binned NAICS2 did not necessitate the removal of any variables. After NAICS is incorporated, some types of vehicles lose signficance and the magnitude of a range of UCA related variables increase. Most interestingly, the sign of cl_def6_HHI_lag1 switches and is now in line with expectations and powerfully so. Competition continues to surprisingly estimate a greater risk of ceiling breaches, but the magnitude has decreased.

Unfortunately introduction of the NAICS variables significantly increases the number and magnitude of outlier residuals.


### Model 07B: NAICS2 and NAICS6 Sector Data
The next step is to reincorporate the economic sector variables first considered under study variable consolidation.
```{r Model07B}


#Sumamry plot



CBre_Cons_07B <- glm (data=smp,
                      b_CBre ~cl_def6_HHI_lag1 +cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                    
                       
                          +cl_def6_HHI_lag1:cl_def6_obl_lag1+ 
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_07B)

CBre_Comp_07B <- glm (data=smp,
                      b_CBre ~n_Comp +
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                   Agency+
                   NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_07B)
glmer_examine(CBre_Comp_07B)



  stargazer::stargazer(CBre_Cons_07A,CBre_Cons_07B,CBre_Comp_07A,CBre_Comp_07B,type="text",
                       digits=2)
  
summary_residual_compare(CBre_Cons_07A,CBre_Cons_07B,CBre_Comp_07A,CBre_Comp_07B,bins=20)


```
Adding back in the sector variables results in some notable changes in sign, for example, as expected, higher average wages now estimate a greater risk of ceiling breaches, which the study team anticipated as a means of tracking unobserved skill requirements which may correlate with contract risks. 

One variable, cl_def6_obl_lag1, is not itself significant and its interaction with consolidation run contrary to expectation. In the next step we'll test its removal.


### Model 07C: NAICS2 and NAICS3/NAICS6 Sector Data
This model includes economic sector at the NAICS3 and NAICS 6 levels.
```{r Model07C}

#Taking out average salary 3 to keep the models snced up.
CBre_Comp_NCS3G3 <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                   n_Comp+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS3G3)
vif(CBre_Comp_NCS3G3)

CBre_Cons_07C <- glm (data=smp,
                      b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_07C)


CBre_Comp_07C <- glm (data=smp,
                      b_CBre~n_Comp+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_07C)


stargazer::stargazer(CBre_Cons_07A,CBre_Cons_07B,CBre_Cons_07C,CBre_Cons_07C,CBre_Comp_07A,CBre_Comp_07B,CBre_Comp_07C,CBre_Comp_07C,type="text",
                       digits=2)

summary_residual_compare(CBre_Cons_07A,CBre_Cons_07C,CBre_Comp_07A,CBre_Comp_07C,bins=20)

```

## Cluster Analysis
### Model 08A: Office Clustered Ceiling
This approach explores an alternate means of considering ceiling, using cluster averaging by office rather than grand mean averaging. This means that we'd be considering the initial size of each contract or task order relative to others released by the same office rather than the average of all contracts. In this case, the averaging is done after logging the ceiling.
```{r Model08A}
def<-def %>% group_by(Agency,Office) %>%
  dplyr::mutate(office_l_Ceil_mean=mean(l_Ceil,na.rm=TRUE),
                  office_l_Ceil_sd=sd(l_Ceil,na.rm=TRUE)
                  )

def$c_office_l_Ceil<-(def$l_Ceil-def$office_l_Ceil_mean)/(def$office_l_Ceil_sd*2)
def$c_office_l_Ceil_mean<-arm::rescale(def$office_l_Ceil_mean)
summary_continuous_plot(smp,"c_office_l_Ceil")
summary_continuous_plot(smp,"cl_Ceil")

#Taking out average salary 3 to keep the models snced up.
CBre_Comp_NCS3G3 <- glm (data=smp,
                 b_CBre ~n_Comp+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                   n_Comp+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS3G3)
vif(CBre_Comp_NCS3G3)

CBre_Cons_08A <- glm (data=smp,
                      b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        c_office_l_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:c_office_l_Ceil+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_08A)


CBre_Comp_08A <- glm (data=smp,
                      b_CBre~n_Comp+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        c_office_l_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:n_Comp + 
                        b_UCA:c_office_l_Ceil+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_08A)


stargazer::stargazer(CBre_Cons_07C,CBre_Cons_08A,CBre_Comp_07C,CBre_Comp_08A,type="text",
                       digits=2)

summary_residual_compare(CBre_Cons_07C,CBre_Cons_08A,CBre_Comp_07C,CBre_Comp_08A,bins=20)

```
### Model 08B: Office Clustered Days

```{r Model08B}
def<-def %>% group_by(Agency,Office) %>%
  dplyr::mutate(office_l_Days_mean=mean(l_Days,na.rm=TRUE),
                  office_l_Days_sd=sd(l_Days,na.rm=TRUE)
                  )

def$c_office_l_Days<-(def$l_Days-def$office_l_Days_mean)/(def$office_l_Days_sd*2)
def$c_office_l_Days_mean<-arm::rescale(def$office_l_Days_mean)
summary_continuous_plot(smp,"c_office_l_Days")
summary_continuous_plot(smp,"cl_Days")


CBre_Cons_08B <- glm (data=smp,
                      b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        c_office_l_Ceil + c_office_l_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:c_office_l_Ceil+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_08B)


CBre_Comp_08B <- glm (data=smp,
                      b_CBre~n_Comp+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        c_office_l_Ceil + c_office_l_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:n_Comp + 
                        b_UCA:c_office_l_Ceil+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_08B)


stargazer::stargazer(CBre_Cons_07C,CBre_Cons_08B,CBre_Comp_07C,CBre_Comp_08B,type="text",
                       digits=2)

summary_residual_compare(CBre_Cons_07C,CBre_Cons_08B,CBre_Comp_07C,CBre_Comp_08B,bins=20)

```

## Competition and Consolidation together
### Model 09A: NAICS6 Combination
```{r Model07B}


#Sumamry plot



CBre_Cons_Comp_09A <- glm (data=smp,
                      b_CBre ~cl_def6_HHI_lag1 +cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                    
                       
                          +cl_def6_HHI_lag1:cl_def6_obl_lag1+ 
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:cl_def6_HHI_lag1 + 
                            b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_Comp_09A)




  stargazer::stargazer(CBre_Cons_07A,CBre_Cons_07B,CBre_Comp_07A,CBre_Comp_07B,CBre_Cons_Comp_09A,type="text",
                       digits=2)
  
summary_residual_compare(CBre_Cons_07B,CBre_Cons_Comp_09A,CBre_Comp_07B,CBre_Cons_Comp_09A,bins=100)


```
### Model 09B: NAICS3/NAICS6 Combination
```{r Model09B}


CBre_Cons_Comp_09B <- glm (data=smp,
                      b_CBre ~cl_def3_HHI_lag1+
                        cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+
                        cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+
                        n_Comp+
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:n_Comp + 
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_Comp_09B)



stargazer::stargazer(CBre_Cons_07C,CBre_Comp_07C,CBre_Cons_Comp_09B,type="text",
                       digits=2)

summary_residual_compare(CBre_Cons_07C,CBre_Cons_Comp_09B,CBre_Comp_07C,CBre_Cons_Comp_09B,bins=100)

```

# Final Review
## Interactions
### Model 10A: No Interactions
```{r Model10A}
corrdisp<-Hmisc::rcorr(
  as.matrix(cbind(subset(crisis_smp, select=c(b_UCA,c_OffCri,cl_Ceil,
                                              cl_Days,n_Fixed,b_Intl)),
                  dummies::dummy(crisis_smp$Crisis),
                  dummies::dummy(crisis_smp$NoComp),
                  dummies::dummy(crisis_smp$Reach),
                  dummies::dummy(crisis_smp$Veh),
                  dummies::dummy(crisis_smp$Is.Defense),
                  dummies::dummy(crisis_smp$Simple))))
corrdisp[[1]]

#Sumamry plot
summary_discrete_plot(smp1m,"NAICS2",rotate_text=TRUE)

CBre_Cons_10A <- glm (data=smp,
                      b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        # cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        # b_UCA:cl_def6_HHI_lag1 + 
                        # b_UCA:cl_Ceil+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_10A)


CBre_Comp_10A <- glm (data=smp,
                      b_CBre~n_Comp+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        # b_UCA:n_Comp + 
                        # b_UCA:cl_Ceil+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_10A)

  stargazer::stargazer(CBre_Cons_07C,CBre_Cons_10A,CBre_Comp_07C,CBre_Comp_10A,type="text",
                       digits=2)
  
summary_residual_compare(CBre_Cons_07C,CBre_Cons_10A,CBre_Comp_07C,CBre_Comp_10A,bins=20)


```
Removal of the interaction resulted in a comparatively small reduction in deviance and fairly minimal changes in residuals.

### Model 10B: Comp/Cons:UCA
Starting with Competition and UCA. It's strong in both models and thus a natural starting point.
```{r Model10B}
#Sumamry plot
summary_continuous_plot(smp1m,"cl_def6_HHI_lag1","UCA")
summary_discrete_plot(smp1m,"EffComp","UCA")


#Create the model
CBre_Cons_10B <- glm (data=smp,
                      b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        # cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:cl_def6_HHI_lag1 +
                        # b_UCA:cl_Ceil+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_10B)


CBre_Comp_10B <- glm (data=smp,
                      b_CBre~n_Comp+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:n_Comp +
                        # b_UCA:cl_Ceil+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_10B)

  stargazer::stargazer(CBre_Comp_10A,CBre_Comp_10B,CBre_Cons_10A,CBre_Cons_10B,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Comp_10A,CBre_Comp_10B,CBre_Cons_10A,CBre_Cons_10B,bins=20)


```
The interaction is significant and competion / low levels of consolidation estimates lower risks associated withUCAs. In diagnostic terms, the residuals for ceiling breaches get a little worse, but the change is marginal and the interaction is relevant to study questions. Keeping it.


### Model 10C: Comp/Cons:Days
The next reintroduction is competition and days. The benefits of competition may reduce over time. We don't have firm expectations for consolidation, so leaving that out.
```{r Model10C}


#Sumamry plot
summary_continuous_plot(smp1m,"cl_Days","EffComp")



CBre_Comp_10C <- glm (data=smp,
                      b_CBre~n_Comp+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:n_Comp +
                        # b_UCA:cl_Ceil+
                        n_Comp:cl_Days +
                       
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_10C)


```

This combination encounters VIF problems for competition Leaving it out.


### Model 10D: Comp/Cons:Ceiling
The next reintroduction is competition and ceiling. Competition and ceiling might have a negative coefficient, because large contracts might encourage bid to win approaches. No expectations for consolidation, so leaving that out.
```{r Model10D}


#Sumamry plot
summary_continuous_plot(smp1m,"cl_Ceil","n_Comp")



CBre_Comp_10D <- glm (data=smp,
                      b_CBre~n_Comp+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:n_Comp +
                        # b_UCA:cl_Ceil+
                        n_Comp:cl_Ceil +
                       
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_10D)


```
This interaction runs afowl of the VIF test on the competition side.


### Model 10E: Comp/Cons:Veh
The next reintroduction is competition and vehicle. Multi-award contracts in particular emphasize competition between the awardees which suggests that it may increase the benefits of competition.


```{r Model10E}


#Sumamry plot
summary_discrete_plot(smp1m,"Veh","cl_def6_HHI_lag1")
summary_discrete_plot(smp1m,"Veh","n_Comp")

#Create the model


CBre_Cons_10E <- glm (data=smp,
                      b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        # cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:cl_def6_HHI_lag1 +
                        # b_UCA:cl_Ceil+
                        Veh:cl_def6_HHI_lag1+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_10E)


CBre_Comp_10E <- glm (data=smp,
                      b_CBre~n_Comp+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:n_Comp +
                        # b_UCA:cl_Ceil+
                       Veh:n_Comp+
                       
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_10E)



  stargazer::stargazer(CBre_Cons_10D,CBre_Cons_10E,CBre_Comp_10B,CBre_Comp_10E,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_10D,CBre_Cons_10E,CBre_Comp_10B,CBre_Comp_10E,bins=20)


```


Competition and vehicle results are interesting, but run afowl of VIF test. Consolidation is somewhat contrary to expectation and on the cusp of VIF problems, leaving it  out.


### Model 10F: UCA and Ceiling
Larger ceiling UCAs may run into bigger problems. The interaction of UCA and ceiling estimates a higher risk of breaches. 

```{r Model10F}


#Sumamry plot
summary_discrete_plot(smp1m,"Veh","cl_def6_HHI_lag1")
summary_discrete_plot(smp1m,"Veh","n_Comp")

#Create the model


CBre_Cons_10F <- glm (data=smp,
                      b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        # cl_def6_HHI_lag1:cl_def6_obl_lag1  +
               
                        b_UCA:cl_def6_HHI_lag1 +
                        b_UCA:cl_Ceil+
                        # Veh:cl_def6_HHI_lag1+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_10F)


CBre_Comp_10F <- glm (data=smp,
                      b_CBre~n_Comp+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:n_Comp +
                        b_UCA:cl_Ceil+
                       # Veh:n_Comp+
                       
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_10F)



  stargazer::stargazer(CBre_Cons_10D,CBre_Cons_10F,CBre_Comp_10B,CBre_Comp_10F,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_10D,CBre_Cons_10F,CBre_Comp_10B,CBre_Comp_10F,bins=20)


```
The result runs contrary to expectation, but notably reduces by over 10 points in each case and is largely a wash when it comes to residuals. Leaving it in. One possible rationale is that small UCAs may raise risks because they are under less scrutiny.
### Model 10G: Pricing and Average Wage

Average wage is a proxy for unobserved skill requirements, which in turn is a proxy for complexity. Fixed price contracting may run afoul of in these sectors, due to the greater difficulties of prediction. Labor hours/t&M, will likely are expected to estimate lower risk of problems, but not as low as cost-based. Incentive fee and cost-based are both expected to lower the estimated risk fo breaches.

```{r Model10G}


#Sumamry plot
summary_continuous_plot(smp1m,"cl_US6_avg_sal_lag1","PricingFee")


#Create the model


CBre_Cons_10G <- glm (data=smp,
                      b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        # cl_def6_HHI_lag1:cl_def6_obl_lag1  +
               
                        b_UCA:cl_def6_HHI_lag1 +
                        b_UCA:cl_Ceil+
                        PricingFee:cl_US6_avg_sal_lag1+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_10G)


CBre_Comp_10G <- glm (data=smp,
                      b_CBre~n_Comp+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:n_Comp +
                        b_UCA:cl_Ceil+
                       PricingFee:cl_US6_avg_sal_lag1+
                       
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_10G)


  stargazer::stargazer(CBre_Cons_10F,CBre_Cons_10G,CBre_Comp_10F,CBre_Comp_10G,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_10D,CBre_Cons_10G,CBre_Comp_10B,CBre_Comp_10G,bins=20)


```
The results run contrary to expectation and are only barely significant for other fixed-price. Leaving this out.

### Model 10H: Def Sec Obl:HHI
Because HHI in smaller sectors tends to be larger, high readings from large sectors may deserve more weight. This interaction is expected to amplify HHI magnitudes.
```{r Model10H}


#Sumamry plot
summary_continuous_plot(smp1m,"cl_US6_avg_sal_lag1","PricingFee")


#Create the model


CBre_Cons_10H <- glm (data=smp,
                      b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        cl_def6_HHI_lag1:cl_def6_obl_lag1  +
               
                        b_UCA:cl_def6_HHI_lag1 +
                        b_UCA:cl_Ceil+
                        # PricingFee:cl_US6_avg_sal_lag1+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_10H)


  stargazer::stargazer(CBre_Cons_10F,CBre_Cons_10H,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_10F,CBre_Cons_10H,bins=20)


```
Results are not significant and are contrary to expectations, according to AIC, no value is added. Leaving it out.


### Model 10I: Ratio:HHI
Because HHI in smaller sectors tends to be larger, high readings from large sectors may deserve more weight. This interaction is expected to amplify HHI magnitudes.

Likewise, competition may be more effective in more commercial sectors where monosopy is not a problem.
```{r Model10I}


#Sumamry plot
summary_continuous_plot(smp1m,"cl_US6_avg_sal_lag1","PricingFee")


#Create the model


CBre_Cons_10I <- glm (data=smp,
                      b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       # cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        cl_def6_HHI_lag1:cl_def6_ratio_lag1  +
               
                        b_UCA:cl_def6_HHI_lag1 +
                        b_UCA:cl_Ceil+
                        
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_10I)



CBre_Comp_10I <- glm (data=smp,
                      b_CBre~n_Comp+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:n_Comp +
                        b_UCA:cl_Ceil+
                       PricingFee:cl_US6_avg_sal_lag1+
                       n_Comp:cl_def6_ratio_lag1  +
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_10I)


CBre_Comp_10I2 <- glm (data=smp,
                      b_CBre~n_Comp+
                        #cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:n_Comp +
                        b_UCA:cl_Ceil+
                       PricingFee:cl_US6_avg_sal_lag1+
                       n_Comp:cl_def6_ratio_lag1  +
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_10I2)

  stargazer::stargazer(CBre_Cons_10F,CBre_Cons_10H,CBre_Cons_10I,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_10F,CBre_Cons_10I,bins=20)
summary_residual_compare(CBre_Cons_10H,CBre_Cons_10I,bins=20)


```
Significant though contrary to expectation. The next step is to check for the removal of ratio for def3.



### Model 10J: Removing Ratiofor Level 3 NAICS.
Because HHI in smaller sectors tends to be larger, high readings from large sectors may deserve more weight. This interaction is expected to amplify HHI magnitudes.
```{r Model10J}


#Sumamry plot
summary_continuous_plot(smp1m,"cl_US6_avg_sal_lag1","PricingFee")


#Create the model


CBre_Cons_10J <- glm (data=smp,
                      b_CBre ~cl_def3_HHI_lag1+#cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        cl_def6_HHI_lag1:cl_def6_ratio_lag1  +
               
                        b_UCA:cl_def6_HHI_lag1 +
                        b_UCA:cl_Ceil+
                        
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_10J)



CBre_Comp_10J<- glm (data=smp,
                      b_CBre~n_Comp+
                        #cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:n_Comp +
                        b_UCA:cl_Ceil+
               
                       
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_10J)

  stargazer::stargazer(CBre_Cons_10H,CBre_Cons_10J,
                       CBre_Comp_10F,CBre_Comp_10J,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_10H,CBre_Cons_10J,CBre_Comp_10F,CBre_Comp_10J,bins=20)



```

Removing it doesn't appear to do any good. Leaving it in.

### Model 10K: HHI6 and competition

If competition is an instrument for consolidation, than it should be most effective when consolidation is lower.
```{r Model10K}
summary_continuous_plot(smp1m,"cl_def6_HHI_lag1","EffComp")
summary_continuous_plot(smp1m,"cl_def3_HHI_lag1","EffComp")

CBre_Cons_Comp_10K <- glm (data=smp,
                      b_CBre ~cl_def3_HHI_lag1+
                        cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+
                        cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+
                        n_Comp+
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        cl_def6_HHI_lag1:cl_def6_ratio_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:n_Comp + 
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        cl_def6_HHI_lag1:n_Comp  +
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_Comp_10K)


CBre_Cons_Comp_10K2 <- glm (data=smp,
                      b_CBre ~cl_def3_HHI_lag1+
                        cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+
                        cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+
                        n_Comp+
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        # cl_def6_HHI_lag1:cl_def6_ratio_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:n_Comp + 
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        cl_def6_HHI_lag1:n_Comp  +
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_Comp_10K2)


CBre_Cons_Comp_10K3 <- glm (data=smp,
                      b_CBre ~cl_def3_HHI_lag1+
                        cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+
                        cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+
                        n_Comp+
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        #cl_def6_HHI_lag1:cl_def6_ratio_lag1 +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:n_Comp + 
                        # b_UCA:cl_def6_HHI_lag1 +
                        b_UCA:cl_Ceil+
                        cl_def6_HHI_lag1:n_Comp  +
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_Comp_10K3)


CBre_Cons_Comp_10K4<- glm (data=smp,
                      b_CBre ~#cl_def3_HHI_lag1+
                        #cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+
                        cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+
                        n_Comp+
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        # cl_def6_HHI_lag1:cl_def6_ratio_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:n_Comp + 
                        # b_UCA:cl_def6_HHI_lag1 +
                        b_UCA:cl_Ceil+
                        cl_def6_HHI_lag1:n_Comp  +
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))


CBre_Cons_Comp_10K5<- glm (data=smp,
                      b_CBre ~#cl_def3_HHI_lag1+
                        #cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+
                        cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        # cl_US6_avg_sal_lag1+
                        n_Comp+
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        # cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:n_Comp + 
                        # b_UCA:cl_def6_HHI_lag1 +
                        b_UCA:cl_Ceil+
                        cl_def6_HHI_lag1:n_Comp  +
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))

glmer_examine(CBre_Cons_Comp_10K5)

```
The interaction ran into VIF challenges even with widescale removal of related variables. Leaving it out.

### Model 10J: Ratio:HHI
Checking this out because of curiosity about the multilevel model results. While both the subsector ratio and the subsector HHI estimate higher risk of ceiling breaches, in combination they still represent a subsector with fewer commercial options and thus are expected to estimate a higher risk of ceiling breaches.
```{r Model10J}


#Sumamry plot
summary_double_continuous(smp,"cl_def3_HHI_lag1","cl_def3_ratio_lag1")
#Create the model


CBre_Cons_10J <- glm (data=smp,
                      b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       # cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        cl_def6_HHI_lag1:cl_def6_ratio_lag1  +
                        cl_def3_HHI_lag1:cl_def3_ratio_lag1  +
               
                        b_UCA:cl_def6_HHI_lag1 +
                        b_UCA:cl_Ceil+
                        
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_10J,display=TRUE)



  

summary_residual_compare(CBre_Cons_10I,CBre_Cons_10J,bins=20)


```
Significant though contrary to expectation. The next step is to check for the removal of ratio for def3.




##   Alternate Comp Metrics

### Model 11A: Binned Effective Comp
Switching from an ordinal scaled competition variable to a binned one.

```{r Model11A}




#Create the model




CBre_Comp_11A <- glm (data=smp,
                      b_CBre~EffComp+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:EffComp +
                        b_UCA:cl_Ceil+
                       # PricingFee:cl_US6_avg_sal_lag1+
                       # EffComp:cl_def6_ratio_lag1  +
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_11A)

CBre_Cons_Comp_11A <- glm (data=smp,
                      b_CBre ~cl_def3_HHI_lag1+
                        cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+
                        cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+
                        EffComp+
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        cl_def6_HHI_lag1:cl_def6_ratio_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:EffComp + 
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        # cl_def6_HHI_lag1:EffComp  +
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_Comp_11A)
  
  stargazer::stargazer(CBre_Comp_10F,CBre_Comp_11A,CBre_Cons_Comp_09B,CBre_Cons_Comp_11A,
                       type="text",
                       digits=2)

summary_residual_compare(CBre_Comp_10F,CBre_Comp_11A,
                         CBre_Cons_Comp_09B,CBre_Cons_Comp_11A,bins=100)



```


### Model 11B: Double checking recently failed interactions.
```{r Model11A}




#Create the model




CBre_Comp_11B <- glm (data=smp,
                      b_CBre~EffComp+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:EffComp +
                        b_UCA:cl_Ceil+
                       # PricingFee:cl_US6_avg_sal_lag1+
                       EffComp:cl_def6_ratio_lag1  +
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_11B)

CBre_Cons_Comp_11A <- glm (data=smp,
                      b_CBre ~cl_def3_HHI_lag1+
                        cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+
                        cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+
                        EffComp+
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        cl_def6_HHI_lag1:cl_def6_ratio_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:EffComp + 
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        cl_def6_HHI_lag1:EffComp  +
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_Comp_11A)
  
  stargazer::stargazer(CBre_Comp_10F,CBre_Comp_11A,CBre_Cons_Comp_09B,CBre_Cons_Comp_11A,
                       type="text",
                       digits=2)

summary_residual_compare(CBre_Comp_10F,CBre_Comp_11A,
                         CBre_Cons_Comp_09B,CBre_Cons_Comp_11A,bins=100)



```
VIF problems are still there. Moving on.

### Model 11C: Binned Offers
```{r Model11C}




#Create the model




CBre_Comp_11C <- glm (data=smp,
                      b_CBre~CompOffr+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:CompOffr +
                        b_UCA:cl_Ceil+
                       PricingFee:cl_US6_avg_sal_lag1+
                       # CompOffr:cl_def6_ratio_lag1  +
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_11C)

CBre_Cons_Comp_11C <- glm (data=smp,
                      b_CBre ~cl_def3_HHI_lag1+
                        cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+
                        cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+
                        CompOffr+
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        cl_def6_HHI_lag1:cl_def6_ratio_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:CompOffr + 
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        # cl_def6_HHI_lag1:CompOffr  +
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_Comp_11C)
  
  stargazer::stargazer(CBre_Comp_10F,CBre_Comp_11A,CBre_Comp_11C,
                       CBre_Cons_Comp_09B,CBre_Cons_Comp_11A,CBre_Cons_Comp_11C,
                       type="text",
                       digits=2)

summary_residual_compare(CBre_Comp_10F,CBre_Comp_11C,
                         CBre_Cons_Comp_09B,CBre_Cons_Comp_11C,bins=100)



```
#Multi-Level Model Cons Or Comp

## Agency/Office & NAICS6
###Model 12A: Too many Interactions
This initial run proved a bit premature, as incorporation of Agency as a dummy variable showed that many of the interactions included.
```{r Model12A}
load(file="Output//CBre_Cons_12A.rdata")

if(!exists("CBre_Cons_12A"))
  CBre_Cons_12A <- glmer (data=smp,
                          b_CBre ~cl_def6_HHI_lag1 +cl_def6_ratio_lag1+cl_def6_obl_lag1+
                            cl_US6_avg_sal_lag1+cl_def6_HHI_lag1:cl_def6_obl_lag1+ 
                            cl_Ceil + cl_Days+ 
                            Veh +
                            PricingFee + b_UCA +
                            b_Intl+
                            # Who+ Who is missing
                           
                            Veh:cl_Days+
                            
                            
                            cl_Ceil:PricingFee+
                            
                            b_UCA:cl_def6_HHI_lag1 + 
                            b_UCA:cl_Ceil+
                            # 6
                            
                            # Who:b_Intl+
                            (1 | NAICS) + (1 | Agency/Office)
                          , family=binomial(link="logit"),
                          verbose=1)
glmer_examine(CBre_Cons_12A)

# CBre_Comp_12A <- glmer (data=smp,
#                       b_CBre ~n_Comp +
#                         cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
#                         cl_Ceil + cl_Days+ 
#                         Veh  +
#                         PricingFee+ b_UCA +
#                         b_Intl+
                        # Who+ Who is missing
                       
                        # Veh:cl_Days+
                        
                        # 
                        # cl_Ceil:PricingFee+
                        # 
                        # b_UCA:cl_def6_HHI_lag1 + 
                        # b_UCA:cl_Ceil+
                        # 6
                        
                       # Who:b_Intl+
#                    (1 | NAICS) + (1 | Agency/Office)
#                       , family=binomial(link="logit"),
                  # verbose=1)
# glmer_examine(CBre_Comp_12A)
# glmer_examine(CBre_Comp_12A)
# failure to converge in 10000 evaluation
summary_residual_compare(CBre_Cons_07B2,CBre_Cons_12A,CBre_Comp_07B2,CBre_Comp_07C3,bins=20)
save(CBre_Cons_12A,file="Output//CBre_Cons_12A.rdata")
```

The initial attempt to include the pre-existing intercepts and all inputs resulted in a model that initially failed to converge. Conservatively the intercepts have been temporarily removed to be added back in a subsequent step.

### Model 12B: Trimmed 
```{r Model12B}
#Frequency Plot
summary_discrete_plot(smp,"NAICS")

#This is currently running at home

CBre_Cons_12B <- glmer (data=smp,
                        b_CBre ~cl_def6_HHI_lag1 +cl_def6_ratio_lag1+cl_def6_obl_lag1+
                          cl_US6_avg_sal_lag1+
                          cl_Ceil + cl_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                         
                          
                          cl_def6_HHI_lag1:cl_def6_obl_lag1+ 
                          b_UCA:cl_def6_HHI_lag1 + 
                          b_UCA:cl_Ceil+

                          (1 | NAICS) + (1 | Agency/Office)
                        
                        , family=binomial(link="logit"),
                        verbose=1)

glmer_examine(CBre_Cons_12B)

CBre_Comp_12B <-  glmer (data=smp,
                      b_CBre ~n_Comp +
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        cl_Ceil + cl_Days+
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                    
                        b_UCA:n_Comp +
                        b_UCA:cl_Ceil+

                   (1 | NAICS) + (1 | Agency/Office)

                   , family=binomial(link="logit"),
                  verbose=1)

glmer_examine(CBre_Comp_12B)
save(CBre_Comp_12B,file="CBre_Comp_12B.rdata")
summary_residual_compare(CBre_Cons_07B2,CBre_Cons_12B,CBre_Comp_07B2,CBre_Comp_07C3,bins=20)
```

## Agency/Office & NAICS3/6
###Model 13A: Agency/Office+NAICS6/NAICS3
The North American Industrial Classification system captures the sector of each contract, which are each given a seperate intercept in the model.
```{r Model13A}
load(file="Output//CBre_Cons_13A.rdata")

if(!exists("CBre_Cons_13A"))
  CBre_Cons_13A <- glmer (data=smp,
                          b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                            #cl_US3_avg_sal_lag1+
                            cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                            cl_US6_avg_sal_lag1+
                            cl_Ceil + cl_Days+ 
                            Veh +
                            PricingFee + b_UCA +
                            b_Intl+
                            # Who+
                           
                            Veh:cl_Days+
                            
                            Veh:cl_Ceil+
                            cl_Ceil:PricingFee+
                            cl_def6_HHI_lag1:cl_def6_obl_lag1+
                            b_UCA:cl_def6_HHI_lag1 + 
                            b_UCA:cl_Ceil+
                            # 6
                            b_Intl:Veh+ 
                            (1 | NAICS3/NAICS) + 
                            (1 | Agency/Office) 
                          # Who:b_Intl+
                          # NAICS2
                          , family=binomial(link="logit"),
                          verbose=1)


glmer_examine(CBre_Cons_13A,display=TRUE)

save(CBre_Cons_13A,file="Output//CBre_Cons_13A.rdata")
```

###Model 13B: Agency/Office+NAICS6/NAICS3 trimmed
```{r Model13B}
load("Output//CBre_Cons_13B.rdata")

CBre_Cons_13B <- glmer (data=smp,
                        b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                          #cl_US3_avg_sal_lag1+
                          cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                          cl_US6_avg_sal_lag1+
                          cl_Ceil + cl_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                          
                          
                          
                          b_UCA:cl_def6_HHI_lag1 + 
                          b_UCA:cl_Ceil+
                          cl_def6_HHI_lag1:cl_def6_obl_lag1+
                          
                          (1 | NAICS3/NAICS) + 
                          (1 | Agency/Office) 
                        
                        , family=binomial(link="logit"),
                        verbose=1)

glmer_examine(CBre_Cons_13B,display=TRUE)


  CBre_Cons_13B_1m <- glmer (data=smp1m,
                          b_CBre ~cl_def3_HHI_lag1+
                            cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                            #cl_US3_avg_sal_lag1+
                            cl_def6_HHI_lag1+
                            cl_def6_obl_lag1+cl_def6_ratio_lag1+
                            cl_US6_avg_sal_lag1+
                            cl_Ceil + cl_Days+ 
                            Veh +
                            PricingFee + b_UCA +
                            b_Intl+
                            
                            b_UCA:cl_def6_HHI_lag1 + 
                            b_UCA:cl_Ceil+
                            cl_def6_HHI_lag1:cl_def6_obl_lag1+
                            
                            (1 | NAICS3/NAICS) + 
                            (1 | Agency/Office), 
                          
                          family=binomial(link="logit"),
                          verbose=1)
glmer_examine(CBre_Cons_13B_1m,display=TRUE)

save(CBre_Cons_13B,file="Output//CBre_Cons_13B.rdata")
CBre_Comp_13B <- glmer (data=smp,
                        b_CBre~n_Comp+
                          cl_def3_ratio_lag1+
                          #cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                          n_Comp+
                          cl_def6_ratio_lag1+
                          cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                          cl_Ceil + cl_Days+
                          Veh  +
                          PricingFee+
                          b_UCA +
                          b_Intl+
                          
                          b_UCA:n_Comp +
                          b_UCA:cl_Ceil+
                          
                          (1 | NAICS3/NAICS) + (1 | Agency/Office)
                        , family=binomial(link="logit"),
                        verbose=1)
glmer_examine(CBre_Comp_13B)

stargazer::stargazer(CBre_Cons_14A,CBre_Cons_13B,CBre_Comp_14A.restart,CBre_Comp_13B,type="text",
                     digits=2)



summary_residual_compare(CBre_Cons_14A,CBre_Cons_13B,CBre_Comp_14A.restart,CBre_Comp_13B,bins=20)



any(diag.vals<1e-6)

if(!exists("CBre_Cons_13B.devfun"))
  CBre_Cons_13B.devfun <- update(CBre_Cons_13B, devFunOnly=TRUE)


pars<-get_pars(CBre_Cons_13B)


if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Cons_13B.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Cons_13B.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(CBre_Cons_13_scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Cons_13B@optinfo$derivs

if(!exists("CBre_Cons_13B.restart"))
  CBre_Cons_13B.restart <- update(CBre_Cons_13B, start=pars)
glmer_examine(CBre_Cons_13B.restart)

save(CBre_Cons_13B,
     CBre_Cons_13B.devfun,
     CBre_Cons_13_scgrad,
     CBre_Cons_13B.restart,
     CBre_Comp_13B,
     CBre_Comp_13B.devfun,
     CBre_Comp_13B.restart,
     file="Output//CBre_Cons_13B.rdata")

source(system.file("utils", "allFit.R", package="lme4"))
CBre_Cons_13B.all <- allFit(CBre_Cons_13B)
CBre_Cons_13B_ss_cons <- summary(CBre_Cons_13B.all)

CBre_Comp_13C.all <- allFit(CBre_Comp_13C)
CBre_Comp_13C_ss_cons <- summary(CBre_Cons_13C.all)


#CBre Comp
if(!exists("CBre_Comp_13B.devfun"))
  CBre_Comp_13B.devfun <- update(CBre_Comp_13B, devFunOnly=TRUE)

pars<-get_pars(CBre_Comp_13B)

if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Comp_13B.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Comp_13B.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Comp_13B@optinfo$derivs

if(!exists("CBre_Comp_13B.restart"))
  CBre_Comp_13B.restart <- update(CBre_Comp_13B, start=pars)
glmer_examine(CBre_Comp_13B.restart)


save(CBre_Cons_13B,CBre_Comp_13B,CBre_Cons_13B.restart,CBre_Comp_13B.restart,
     file="Output//CBre_Cons_13B.rdata")

stargazer::stargazer(CBre_Cons_14A,CBre_Cons_13B,CBre_Cons_13B.restart,CBre_Comp_14A.restart,CBre_Comp_13B,type="text",
                     digits=2)



if(!exists("CBre_Cons_13B_1m_restart")){
   pars<-get_pars(CBre_Cons_13B_1m)
   CBre_Cons_13B_1m_restart <- update(CBre_Cons_13B_1m, 
                                      start=pars,
                                      verbose=1)
   save(CBre_Cons_13B,
        CBre_Cons_13B.restart,
        CBre_Cons_13B_1m,
        CBre_Cons_13B_1m_restart,
        file="Output//CBre_Cons_13B.rdata")
 }
stargazer::stargazer(CBre_Cons_13B,CBre_Cons_13B.restart,
                     CBre_Cons_13B_1m_restart,
                     CBre_Cons_13B_1m,type="text",
                     digits=2)
summary_residual_compare(CBre_Cons_13B,CBre_Cons_13B.restart,CBre_Cons_13B_1m,CBre_Cons_13B_1m_restart,bins=50)
glmer_examine(CBre_Cons_13B_1m)
glmer_examine(CBre_Cons_13B_1m_restart)
load("Output//CBre_Comp_13B.rdata")

summary(CBre_Cons_13B_1m_restart)
source(system.file("utils", "allFit.R", package="lme4"))
CBre_Cons_13B_1m_all <- allFit(CBre_Cons_13B_1m_restart)
ss_cons <- summary(CBre_Cons_13B_1m_all)
   save(CBre_Cons_13B,
        CBre_Cons_13B.restart,
        CBre_Cons_13B_1m,
        CBre_Cons_13B_1m_restart,
        CBre_Cons_13B_1m_all,
        file="Output//CBre_Cons_13B.rdata")

summary_residual_compare(CBre_Cons_13B,CBre_Cons_13B.restart,CBre_Comp_14A.restart,CBre_Comp_13B,bins=20)

summary(CBre_Cons_13B.restart)
source(system.file("utils", "allFit.R", package="lme4"))
CBre_Cons_13C.all <- allFit(CBre_Cons_13B.restart)
ss_cons <- summary(CBre_Cons_13C.all)

# str(CBre_Cons_13C.all[[1]])
# stargazer::stargazer(CBre_Cons_13C.all[[1]],
#                 CBre_Cons_13C.all[[2]],
#                 CBre_Cons_13C.all[[3]],
#                 CBre_Cons_13C.all[[4]],
#                 CBre_Cons_13C.all[[5]],
#                 CBre_Cons_13C.all[[6]],
#                 CBre_Cons_13C.all[[7]],type="text",
#                        digits=2)
# 
#               

save(CBre_Cons_13B,CBre_Comp_13B,CBre_Cons_13B.restart,CBre_Cons_13C.all,
     CBre_Comp_13B.restart,
     file="Output//CBre_Cons_13B.rdata")

# fm1.all <- allFit(CBre_Comp_13C)
# ss_comp <- summary(CBre_Comp_13C.all)
```


###Model 13C: Agency/Office+NAICS6/NAICS3 Binned Comp Offers
```{r Model13C}

CBre_Comp_13C <- glmer (data=smp,
                        b_CBre ~CompOffr+cl_def3_ratio_lag1+
                          #cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                          cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                          cl_Ceil + cl_Days+
                          Veh  +
                          PricingFee+
                          b_UCA +
                          b_Intl+
                          
                          b_UCA:CompOffr +
                          b_UCA:cl_Ceil+
                          
                          (1 | NAICS3/NAICS) + (1 | Agency/Office)
                        , family=binomial(link="logit"),
                        verbose=1)
glmer_examine(CBre_Comp_13C)

CBre_Comp_13C_1m <- glmer (data=smp1m,
                        b_CBre ~CompOffr+cl_def3_ratio_lag1+
                          #cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                          cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                          cl_Ceil + cl_Days+
                          Veh  +
                          PricingFee+
                          b_UCA +
                          b_Intl+
                          
                          b_UCA:CompOffr +
                          b_UCA:cl_Ceil+
                          
                          (1 | NAICS3/NAICS) + (1 | Agency/Office)
                        , family=binomial(link="logit"),
                        verbose=1)
glmer_examine(CBre_Comp_13C_1m)

save(CBre_Comp_13C,file="Output//CBre_Comp_13C.rdata")

  stargazer::stargazer(CBre_Comp_13B,CBre_Comp_13C,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_14A,CBre_Cons_13C,CBre_Comp_14A.restart,CBre_Comp_13C,bins=20)



any(diag.vals<1e-6)

if(!exists("CBre_Cons_13C.devfun"))
  CBre_Cons_13C.devfun <- update(CBre_Cons_13C, devFunOnly=TRUE)


pars<-get_pars(CBre_Cons_13C)
if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Cons_13C.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Cons_13C.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Cons_13C@optinfo$derivs

if(!exists("CBre_Cons_13C.restart"))
  CBre_Cons_13C.restart <- update(CBre_Cons_13C, start=pars)
glmer_examine(CBre_Cons_13C.restart)




#CBre Comp
if(!exists("CBre_Comp_13C.devfun"))
  CBre_Comp_13C.devfun <- update(CBre_Comp_13C, devFunOnly=TRUE)

pars<-get_pars(CBre_Comp_13C)
if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Comp_13C.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Comp_13C.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Comp_13C@optinfo$derivs

if(!exists("CBre_Comp_13C.restart"))
  CBre_Comp_13C.restart <- update(CBre_Comp_13C, start=pars)
glmer_examine(CBre_Comp_13C.restart)


  save(CBre_Cons_13C,CBre_Comp_13C,CBre_Cons_13C.restart,CBre_Comp_13C.restart,
       file="Output//CBre_Cons_13C.rdata")
  
stargazer::stargazer(CBre_Cons_14A,CBre_Cons_13C,CBre_Cons_13C.restart,CBre_Comp_14A.restart,CBre_Comp_13C,type="text",
                       digits=2)





  
load("Output//CBre_Comp_13C.rdata")

  summary_residual_compare(CBre_Cons_13C,CBre_Cons_13C.restart,CBre_Comp_14A.restart,CBre_Comp_13C,bins=20)


  source(system.file("utils", "allFit.R", package="lme4"))
  CBre_Cons_13C.all <- allFit(CBre_Cons_13C.restart)
  ss_cons <- summary(CBre_Cons_13C.all)
  save(CBre_Cons_13C,CBre_Comp_13C,CBre_Cons_13C.restart,CBre_Cons_13C.all,
       CBre_Comp_13C.restart,
       file="Output//CBre_Cons_13C.rdata")
  
  # fm1.all <- allFit(CBre_Comp_13C)
  # ss_comp <- summary(CBre_Comp_13C.all)
```

###Model 13D: Cluster Means
```{r Model13D}

load("Output//CBre_Cons_13D.rdata")

CBre_Cons_13D <- glmer (data=smp,
                        b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                          #cl_US3_avg_sal_lag1+
                          cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                          cl_US6_avg_sal_lag1+
                          c_office_l_Ceil + c_office_l_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                          b_UCA:cl_def6_HHI_lag1 + 
                          b_UCA:c_office_l_Ceil+
                          cl_def6_HHI_lag1:cl_def6_obl_lag1+
                          
                          (1 | NAICS3/NAICS) + 
                          (1 | Agency/Office) 
                        
                        , family=binomial(link="logit"),
                        verbose=1)



glmer_examine(CBre_Cons_13D,display=TRUE)


CBre_Comp_13D <- glmer (data=smp,
                        b_CBre ~n_Comp+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                   n_Comp+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        c_office_l_Ceil + c_office_l_Days+
                        Veh  +
                        PricingFee+
                        b_UCA +
                        b_Intl+
                        
                        
                        
                        b_UCA:n_Comp +
                        b_UCA:c_office_l_Ceil+
                        
                        (1 | NAICS3/NAICS) + (1 | Agency/Office)
                      , family=binomial(link="logit"),
                        verbose=1)
glmer_examine(CBre_Comp_13D)


  stargazer::stargazer(CBre_Cons_13C, CBre_Cons_13D,CBre_Comp_13C,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_13C,CBre_Cons_13D,#CBre_Comp_14A.restart,CBre_Comp_13D,
                         bins=20)

CBre_Cons_13C@devcomp$cmp[[8]]
CBre_Cons_13C@devcomp$cmp

any(diag.vals<1e-6)

if(!exists("CBre_Cons_13D.devfun"))
  CBre_Cons_13D.devfun <- update(CBre_Cons_13D, devFunOnly=TRUE)


pars<-get_pars(CBre_Cons_13D)


if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Cons_13D.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Cons_13D.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Cons_13D@optinfo$derivs

if(!exists("CBre_Cons_13D.restart"))
  CBre_Cons_13D.restart <- update(CBre_Cons_13D, start=pars)
glmer_examine(CBre_Cons_13D.restart)




#CBre Comp
if(!exists("CBre_Comp_13D.devfun"))
  CBre_Comp_13D.devfun <- update(CBre_Comp_13D, devFunOnly=TRUE)


pars<-get_pars(CBre_Comp_13D)



if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Comp_13D.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Comp_13D.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Comp_13D@optinfo$derivs

if(!exists("CBre_Comp_13D.restart"))
  CBre_Comp_13D.restart <- update(CBre_Comp_13D, start=pars)
glmer_examine(CBre_Comp_13D.restart)


  save(CBre_Cons_13D,CBre_Comp_13D,CBre_Cons_13D.restart,CBre_Comp_13D.restart,
       file="Output//CBre_Cons_13D.rdata")
  
stargazer::stargazer(CBre_Cons_13C,CBre_Cons_13D,CBre_Cons_13D.restart,
                    CBre_Comp_13C,CBre_Comp_13D,CBre_Comp_13D.restart,
                    type="text",
                       digits=2)





  save(CBre_Cons_13D,CBre_Comp_13D.devfun,CBre_Cons_13D.restart,
       CBre_Comp_13D,CBre_Comp_13D.devfun,CBre_Comp_13D.restart,
       file="Output//CBre_Cons_13D.rdata")
load("Output//CBre_Comp_13D.rdata")

  summary_residual_compare(CBre_Cons_13D,CBre_Cons_13D.restart,CBre_Comp_13D,CBre_Comp_13D.restart,bins=20)
  summary_residual_compare(CBre_Cons_13C,CBre_Cons_13D.restart,CBre_Comp_13C,CBre_Comp_13D.restart,bins=20)


```
###Model 13E: Interlevel Ceiling Slope
```{r Model13E}

load(file="Output//CBre_Cons_13E.rdata")
CBre_Cons_13E <- glmer (data=smp,
                        b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                          #cl_US3_avg_sal_lag1+
                          cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                          cl_US6_avg_sal_lag1+
                          c_office_l_Ceil + c_office_l_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                          b_UCA:cl_def6_HHI_lag1 + 
                          b_UCA:c_office_l_Ceil+
                          cl_def6_HHI_lag1:cl_def6_obl_lag1+
                          
                          (1 | NAICS3/NAICS) + 
                          (1 | Agency) +
                          (1 + c_office_l_Ceil | Agency:Office) 
                        
                        , family=binomial(link="logit"),
                        verbose=1)


glmer_examine(CBre_Cons_13E,display=TRUE)
save(CBre_Cons_13E,file="Output//CBre_Cons_13E.rdata")

CBre_Comp_13E <- glmer (data=smp,
                        b_CBre ~n_Comp+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                   n_Comp+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        c_office_l_Ceil + c_office_l_Days+
                        Veh  +
                        PricingFee+
                        b_UCA +
                        b_Intl+
                        
                        
                        
                        b_UCA:n_Comp +
                        b_UCA:c_office_l_Ceil+
                        
                        (1 | NAICS3/NAICS) +
                                               (1 | Agency) +
                          (1 + c_office_l_Ceil | Agency:Office) 
                      , family=binomial(link="logit"),
                        verbose=1)
glmer_examine(CBre_Comp_13E,display=TRUE)

save(CBre_Cons_13E,CBre_Comp_13E,file="Output//CBre_13E.rdata")
  stargazer::stargazer(CBre_Cons_13B, CBre_Cons_13D,CBre_Cons_13E,CBre_Comp_13B,type="text",
                       digits=2)
  
  
summary_residual_compare(CBre_Cons_13D,CBre_Cons_13E,#CBre_Comp_14A.restart,CBre_Comp_13E,
                         bins=100)
summary_residual_compare(CBre_Cons_13B,CBre_Cons_13E,#CBre_Comp_14A.restart,CBre_Comp_13E,
                         bins=100)



any(diag.vals<1e-6)

if(!exists("CBre_Cons_13E.devfun"))
  CBre_Cons_13E.devfun <- update(CBre_Cons_13E, devFunOnly=TRUE)


pars<-get_pars(CBre_Cons_13D)

if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Cons_13D.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Cons_13D.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Cons_13D@optinfo$derivs



if(!exists("CBre_Cons_13D.restart"))
  CBre_Cons_13D.restart <- update(CBre_Cons_13D, start=pars)
glmer_examine(CBre_Cons_13D.restart)


#CBre Comp
if(!exists("CBre_Comp_13D.devfun"))
  CBre_Comp_13D.devfun <- update(CBre_Comp_13D, devFunOnly=TRUE)



if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Comp_13D.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Comp_13D.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Comp_13D@optinfo$derivs

if(!exists("CBre_Comp_13D.restart"))
  CBre_Comp_13D.restart <- update(CBre_Comp_13D, start=pars)
glmer_examine(CBre_Comp_13D.restart)


  save(CBre_Cons_13D,CBre_Comp_13D,CBre_Cons_13D.restart,CBre_Comp_13D.restart,
       file="Output//CBre_Cons_13D.rdata")
  
stargazer::stargazer(CBre_Cons_13B,CBre_Cons_13D,CBre_Cons_13D.restart,
                    CBre_Comp_13B,CBre_Comp_13D,CBre_Comp_13D.restart,
                    type="text",
                       digits=2)





  save(CBre_Cons_13D,CBre_Comp_13D.devfun,CBre_Cons_13D.restart,
       CBre_Comp_13D,CBre_Comp_13D.devfun,CBre_Comp_13D.restart,
       file="Output//CBre_Cons_13D.rdata")
load("Output//CBre_Comp_13D.rdata")

  summary_residual_compare(CBre_Cons_13D,CBre_Cons_13D.restart,CBre_Comp_13D,CBre_Comp_13D.restart,bins=20)
  summary_residual_compare(CBre_Cons_13B,CBre_Cons_13D.restart,CBre_Comp_13B,CBre_Comp_13D.restart,bins=20)


```




###Model 13F: Agency/Office+NAICS6/NAICS3 Binned Comp Offers
```{r Model13F}

glmer_examine(CBre_Comp_13F)
save(CBre_Comp_13F,file="Output//CBre_Comp_13F.rdata")

  stargazer::stargazer(CBre_Comp_13B,CBre_Comp_13C,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_14A,CBre_Cons_13C,CBre_Comp_14A.restart,CBre_Comp_13C,bins=20)



any(diag.vals<1e-6)

if(!exists("CBre_Cons_13C.devfun"))
  CBre_Cons_13C.devfun <- update(CBre_Cons_13C, devFunOnly=TRUE)
pars<-get_pars(CBre_Cons_13C)

if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Cons_13C.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Cons_13C.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Cons_13C@optinfo$derivs

if(!exists("CBre_Cons_13C.restart"))
  CBre_Cons_13C.restart <- update(CBre_Cons_13C, start=pars)
glmer_examine(CBre_Cons_13C.restart)



```


#Multi-Level Model Both Cons and Comp 
##Agency/Office & NaICS7
###Model 14A: Base
```{r Model14A}
load("Output//CBre_Cons_Comp_14A.rdata")



CBre_Cons_Comp_14A <- glmer (data=smp,
                      b_CBre ~cl_def6_HHI_lag1 +cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+
                    n_Comp+
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                    
                       
                          +cl_def6_HHI_lag1:cl_def6_obl_lag1+ 
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:cl_def6_HHI_lag1 + 
                            b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
        (1 | NAICS) + 
                        (1 | Agency/Office) 

                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_Comp_14A)
save(CBre_Cons_Comp_14A,"Output//CBre_Cons_Comp_14A.rdata")




  stargazer::stargazer(CBre_Cons_13A,CBre_Cons_13B,CBre_Comp_13A.restart,CBre_Comp_13B,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_13A,CBre_Cons_13B,CBre_Comp_13A.restart,CBre_Comp_13B,bins=20)



any(diag.vals<1e-6)

if(!exists("CBre_Cons_13B.devfun"))
  CBre_Cons_13B.devfun <- update(CBre_Cons_13B, devFunOnly=TRUE)
pars<-get_pars(CBre_Cons_13B)

if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Cons_13B.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Cons_13B.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Cons_13B@optinfo$derivs

if(!exists("CBre_Cons_13B.restart"))
  CBre_Cons_13B.restart <- update(CBre_Cons_13B, start=pars)
glmer_examine(CBre_Cons_13B.restart)




#CBre Comp
if(!exists("CBre_Comp_13B.devfun"))
  CBre_Comp_13B.devfun <- update(CBre_Comp_13B, devFunOnly=TRUE)
pars<-get_pars(CBre_Comp_13B)

if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Comp_13B.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Comp_13B.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Comp_13B@optinfo$derivs

if(!exists("CBre_Comp_13B.restart"))
  CBre_Comp_13B.restart <- update(CBre_Comp_13B, start=pars)
glmer_examine(CBre_Comp_13B.restart)


  save(CBre_Cons_13B,CBre_Comp_13B,CBre_Cons_13B.restart,CBre_Comp_13B.restart,
       file="Output//CBre_Cons_13B.rdata")
  
stargazer::stargazer(CBre_Cons_14A,CBre_Cons_13B,CBre_Cons_13B.restart,CBre_Comp_14A.restart,CBre_Comp_13B,type="text",
                       digits=2)





  save(CBre_Cons_13B,CBre_Comp_13B,CBre_Cons_13B.restart,
       file="Output//CBre_Cons_13B.rdata")
load("Output//CBre_Comp_13B.rdata")

  summary_residual_compare(CBre_Cons_13B,CBre_Cons_13B.restart,CBre_Comp_14A.restart,CBre_Comp_13B,bins=20)


  source(system.file("utils", "allFit.R", package="lme4"))
  CBre_Cons_13C.all <- allFit(CBre_Cons_13C)
  ss_cons <- summary(CBre_Cons_13C.all)

  fm1.all <- allFit(CBre_Comp_13C)
  ss_comp <- summary(CBre_Comp_13C.all)
```

###Model 14B: Switch fromn_Comp to CompOffr
```{r Model14B}
load("Output//CBre_Cons_Comp_14B.rdata")



CBre_Cons_Comp_14B <- glmer (data=smp,
                      b_CBre ~cl_def6_HHI_lag1 +cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+
                    CompOffr+
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                    
                       
                          +cl_def6_HHI_lag1:cl_def6_obl_lag1+ 
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:cl_def6_HHI_lag1 + 
                            b_UCA:CompOffr + 
                        b_UCA:cl_Ceil+
                        
        (1 | NAICS) + 
                        (1 | Agency/Office) 

                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_Comp_14B)
save(CBre_Cons_Comp_14B,"Output//CBre_Cons_Comp_14B.rdata")




  stargazer::stargazer(CBre_Cons_13A,CBre_Cons_13B,CBre_Comp_13A.restart,CBre_Comp_13B,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_13A,CBre_Cons_13B,CBre_Comp_13A.restart,CBre_Comp_13B,bins=20)



any(diag.vals<1e-6)

if(!exists("CBre_Cons_13B.devfun"))
  CBre_Cons_13B.devfun <- update(CBre_Cons_13B, devFunOnly=TRUE)

pars<-get_pars(CBre_Cons_13B)
if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Cons_13B.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Cons_13B.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Cons_13B@optinfo$derivs

if(!exists("CBre_Cons_13B.restart"))
  CBre_Cons_13B.restart <- update(CBre_Cons_13B, start=pars)
glmer_examine(CBre_Cons_13B.restart)




#CBre Comp
if(!exists("CBre_Comp_13B.devfun"))
  CBre_Comp_13B.devfun <- update(CBre_Comp_13B, devFunOnly=TRUE)

pars<-get_pars(CBre_Comp_13B)
if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Comp_13B.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Comp_13B.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Comp_13B@optinfo$derivs

if(!exists("CBre_Comp_13B.restart"))
  CBre_Comp_13B.restart <- update(CBre_Comp_13B, start=pars)
glmer_examine(CBre_Comp_13B.restart)


  save(CBre_Cons_13B,CBre_Comp_13B,CBre_Cons_13B.restart,CBre_Comp_13B.restart,
       file="Output//CBre_Cons_13B.rdata")
  
stargazer::stargazer(CBre_Cons_14A,CBre_Cons_13B,CBre_Cons_13B.restart,CBre_Comp_14A.restart,CBre_Comp_13B,type="text",
                       digits=2)





  save(CBre_Cons_13B,CBre_Comp_13B,CBre_Cons_13B.restart,
       file="Output//CBre_Cons_13B.rdata")
load("Output//CBre_Comp_13B.rdata")

  summary_residual_compare(CBre_Cons_13B,CBre_Cons_13B.restart,CBre_Comp_14A.restart,CBre_Comp_13B,bins=20)


  source(system.file("utils", "allFit.R", package="lme4"))
  CBre_Cons_13C.all <- allFit(CBre_Cons_13C)
  ss_cons <- summary(CBre_Cons_13C.all)

  fm1.all <- allFit(CBre_Comp_13C)
  ss_comp <- summary(CBre_Comp_13C.all)
```

## Agency/Office & NAICS3/6
###Model 15A: Models 13B Cons and 13C Comp combined
```{r Model15A}
load("Output//CBre_Cons_Comp_15A.rdata")

CBre_Cons_Comp_15A <- glmer (data=smp,
                 b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                  #cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                  cl_US6_avg_sal_lag1+
                   CompOffr+
                                                cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                   
                       
                        
                        b_UCA:CompOffr +
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        cl_def6_HHI_lag1:cl_def6_obl_lag1+
                         
                        (1 | NAICS3/NAICS) + 
                        (1 | Agency/Office) 

                      , family=binomial(link="logit"),
                        verbose=1)

save(CBre_Cons_Comp_15A,CBre_Cons_Comp_15A_1m,file="Output//CBre_Cons_Comp_15A.rdata")
glmer_examine(CBre_Cons_Comp_15A)


stargazer::stargazer(CBre_Cons_Comp_15A,CBre_Cons_Comp_15A_1m,type="text",
                       digits=2)
  stargazer::stargazer(CBre_Cons_13B,CBre_Comp_13C,CBre_Cons_Comp_14B,CBre_Cons_Comp_15A,CBre_Cons_Comp_15A_1m,type="text",
                       digits=2)
  
```


###Model 15B: Ratio instead of obligations
```{r Model15B}
load("Output//CBre_Cons_15B.rdata")

CBre_Cons_15B <- glmer (data=smp,
                 b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                  #cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                  cl_US6_avg_sal_lag1+
                                                cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                   
                       
                        
                        
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        cl_def6_ratio_lag1:cl_def6_HHI_lag1+
                         
                        (1 | NAICS3/NAICS) + 
                        (1 | Agency/Office) ,
                 
                 family=binomial(link="logit"),
                        verbose=1)

glmer_examine(CBre_Cons_15B,display=TRUE)

CBre_Cons_Comp_15B <- glmer (data=smp,
                 b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                  #cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                  cl_US6_avg_sal_lag1+
                   CompOffr+
                                                cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                   
                       
                        
                        b_UCA:CompOffr +
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        cl_def6_ratio_lag1:cl_def6_HHI_lag1+
                         
                        (1 | NAICS3/NAICS) + 
                        (1 | Agency/Office) ,
                 
                 family=binomial(link="logit"),
                        verbose=1)



glmer_examine(CBre_Cons_Comp_15B,display=TRUE)


  stargazer::stargazer(CBre_Cons_13B,CBre_Comp_13C,CBre_Cons_Comp_14B,CBre_Cons_15B,CBre_Cons_Comp_15A,CBre_Cons_Comp_15B,type="text",
                       digits=2)

save(CBre_Cons_15B,CBre_Cons_Comp_15B,file="Output//CBre_15B.rdata")



```
The new variable proves to not be significant.

# Appendix
## No longer Relevant Code

###Examine Minimium Size
```{r MinimumSize}
# path<-"https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/"
#   directory="economic/"
#   deflator_file <- "Lookup_Deflators.csv"
#   
#  deflators_retrieved <- readr::read_csv(paste0(path, directory,deflator_file))
# deflators_retrieved$cutoff_3500<-3500*deflators_retrieved$Deflator.2016
# deflators_retrieved<-subset(deflators_retrieved,select=c(Fiscal.Year,cutoff_3500))
# colnames(deflators_retrieved)[1]<-"StartFY"
# def<-plyr::join(def,deflators_retrieved)
# #Frequency Plot for logged ceiling
# def$UnmodifiedContractBaseAndAllOptionsValue
# smp<-def[
#   !is.na(def$b_Term)&
#     !is.na(def$Comp)&
#     def$UnmodifiedContractBaseAndAllOptionsValue>=
#     def$cutoff_3500,]
# 
# smp<-smp[sample(nrow(smp),250000),]
# 
# 
# freq_continuous_term_plot(smp,"l_Ceil")
# exp(mean(smp$l_Ceil,na.rm=TRUE))
# 
# smp$StartFY
# 
# cutoff<-quantile(smp$l_Ceil,0.05,na.rm=TRUE)
# exp(cutoff)
# cutoff<-log(3500)
# 
# nrow(subset(smp,l_Ceil<cutoff,na.rm=TRUE))/nrow(smp)
# sum(subset(smp,l_Ceil<cutoff)$b_Term)/sum(smp$b_Term)
# 
# 
# sum(subset(smp,l_Ceil<cutoff,na.rm=TRUE)$Action.Obligation)/sum(smp$Action.Obligation)
# sum(subset(smp,l_Ceil>=cutoff,na.rm=TRUE)$Action.Obligation)/sum(smp$Action.Obligation)
# 
# sum(subset(smp,l_Ceil<cutoff)$b_Term)/nrow(subset(smp,l_Ceil<cutoff,na.rm=TRUE))
# 
# sum(subset(smp,l_Ceil>=cutoff)$b_Term)/nrow(subset(smp,l_Ceil<cutoff,na.rm=TRUE))
# 
# 
# exp(2)
```

## Who
This approach was initially used before the empty model analysis revealed that the entire agency structure would need to be included.

### Model Old 06A: Sub Customer 
Other DoD stands out for its sheer quantity of contracts and task orders and also its lower termination rate. It includes the DLA which specializes in logistic delivery, and may thus estimate a lower rate of ceiling breahces.
```{r ModelOld06A}
    #Frequency Plot
  summary_discrete_plot(def,"Agency",rotate_text=TRUE)
    summary_discrete_plot(def,rotate_text=TRUE)
    summary_discrete_plot(def,"b_ODoD",rotate_text=TRUE)


#Create the model
CBre_Cons_06A <- glm (data=smp,
                      b_CBre ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        Who+
                       
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_06A)

CBre_Comp_06A <- glm (data=smp,
                      b_CBre ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        Who+
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh 
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_06A)

# # Plot the model and Vehicle 
# Term_Comp_06A_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA,Intl){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,UCA,Intl,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         UCA*Comp) %*%  coef(Term_Comp_06A))}
# 
# #Days curves
# discrete_fitted_term_model(smp,"b_ODoD") +
#   stat_function(fun = Term_Comp_06A_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1,UCA=0,Intl=0),color="blue")+
#   stat_function(fun = Term_Comp_06A_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1,UCA=0,Intl=0),color="blue")
# 
# 



  stargazer::stargazer(CBre_Cons_05C,CBre_Cons_06A,CBre_Comp_05C,CBre_Comp_06A,type="text",
                       digits=2)
  
summary_residual_compare(CBre_Cons_05C,CBre_Cons_06A,CBre_Comp_04I,CBre_Comp_06A,bins=20)



```

###Model Old 06B: SubCustomer and International
Army international spending is particularly in this period, is tied to crisis contracting and U.S. occupations. This high risk connection may mean that Army international contracting predicts a higher rate of ceiling breaches
```{r Model06B}

#Frequency Plot
summary_discrete_plot(smp,"Who","Intl",rotate_text=TRUE)



#Create the model
CBre_Cons_06B <- glm (data=smp,
                      b_CBre ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        Who+
                       
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh+
                        Who:b_Intl
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_06B)

CBre_Comp_06B <- glm (data=smp,
                      b_CBre ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        Who+
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh+
                        Who:b_Intl 
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_06B)


CBre_Cons_06B2 <- glm (data=smp,
                      b_CBre ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        Who+
                       
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        
                        Who:b_Intl
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_06B2)

CBre_Comp_06B2 <- glm (data=smp,
                      b_CBre ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        Who+
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        
                        Who:b_Intl 
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_06B2)

# # Plot the model and Vehicle 
# Term_Comp_06B_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA,Intl){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,UCA,Intl,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         UCA*Comp) %*%  coef(Term_Comp_06B))}
# 
# #Days curves
# discrete_fitted_term_model(smp,"b_ODoD") +
#   stat_function(fun = Term_Comp_06B_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1,UCA=0,Intl=0),color="blue")+
#   stat_function(fun = Term_Comp_06B_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1,UCA=0,Intl=0),color="blue")
# 
# 



  stargazer::stargazer(CBre_Cons_06A,CBre_Cons_06B,CBre_Comp_06A,CBre_Comp_06B,type="text",
                       digits=2)
  
summary_residual_compare(CBre_Cons_06A,CBre_Cons_06B,CBre_Comp_06A,CBre_Comp_06B,bins=20)



```
The results are interesting and run contrary to expectations. Army does have a higher number of international contracts, but this does not account for the Army's higher breach rate. Instead, Navy and Other DoD, which are less frequently international, are more likely to have challenges.
###Model Old 06C: Other DoD
```{r Model06A}


summary_discrete_plot(smp,"ODoD",rotate_text=TRUE)


# Plot the model and Vehicle 
# Term_Comp_06A_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA,Intl){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,UCA,Intl,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         UCA*Comp) %*%  coef(Term_Comp_06A))}
# 
# #Days curves
# discrete_fitted_term_model(smp,"b_ODoD") +
#   stat_function(fun = Term_Comp_06A_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1,UCA=0,Intl=0),color="blue")+
#   stat_function(fun = Term_Comp_06A_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1,UCA=0,Intl=0),color="blue")


CBre_Cons_06C <- glm (data=smp,
                      b_CBre ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        ODoD+
                       
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_06C)

CBre_Comp_06C <- glm (data=smp,
                      b_CBre ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        ODoD+
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh 
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_06C)
glmer_examine(CBre_Cons_06C)



  stargazer::stargazer(CBre_Cons_06A,CBre_Cons_06C,CBre_Comp_06A,CBre_Comp_06C,type="text",
                       digits=2)
  
summary_residual_compare(CBre_Cons_06A,CBre_Cons_06C,CBre_Comp_06A,CBre_Comp_06C,bins=20)



```

After inclusion of Other DoD, the Competition correlates significantly predicts a greater risk of termination. Studying that interaction will be our next step.

### Model Old 06D: Other DoD & Competition
DLA primarily deals with commodities and parts and thus the breadth of the vendor pool can be a key determiner while for the other branches, complexity of the contract may prove more important. Thus OtherDoD and concentration estimate higher probablity of  ceiling breaches. Competition may matter more for the military services, as the difference between 1 and 2 contractors is more likely to come up.

```{r Model06D}

#Frequency Plot
summary_discrete_plot(smp,"EffComp","ODoD",rotate_text=TRUE)
summary_continuous_plot(smp,"cl_def6_HHI_lag1","ODoD",rotate_text=TRUE)



CBre_Cons_06D <- glm (data=smp,
                      b_CBre ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        ODoD+
                       
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh+ 
                        ODoD:cl_def6_HHI_lag1
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_06D)

CBre_Comp_06D <- glm (data=smp,
                      b_CBre ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        ODoD+
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh +
                   ODoD + ODoD:n_Comp
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_06D)
glmer_examine(CBre_Cons_06D)



  stargazer::stargazer(CBre_Cons_06A,CBre_Cons_06C,CBre_Cons_06D,CBre_Comp_06A,CBre_Comp_06C,CBre_Comp_06D,type="text",
                       digits=2)
  
summary_residual_compare(CBre_Cons_06C,CBre_Cons_06D,CBre_Comp_06C,CBre_Comp_06D,bins=20)
summary_residual_compare(CBre_Cons_06A,CBre_Cons_06D,CBre_Comp_06A,CBre_Comp_06D,bins=20)
```
VIF is exceeded for competition but not consolidation. Keeping it for consolidation.
### Model Old 06E: Other DoD & Vehicle
A significant portion of DLA contracting is done through IDIQ contracts. Because of this, the previously found low estimates  for single-award IDV contracts and other forms might be influenced by the specific high volume vehicles used by DLA rather than the general traits of  tehse vehicles. Thus the interaction of DLA and non-definitive contracts may estimate lower  rates of breaches. This may not apply to BPA/BOA, which encompass a wider variety. It may also be a little weaker for FSS/GWAC which can call on vehicles outside of DoD and this may depend less on customers.

```{r Model06E}

#Frequency Plot
summary_discrete_plot(smp,"EffComp","ODoD",rotate_text=TRUE)
summary_continuous_plot(smp,"cl_def6_HHI_lag1","ODoD",rotate_text=TRUE)



CBre_Cons_06E <- glm (data=smp,
                      b_CBre ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        ODoD+
                       
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh+ 
                        ODoD:cl_def6_HHI_lag1+
                        ODoD:Veh
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_06E)
glmer_examine(CBre_Cons_06E)

CBre_Comp_06E <- glm (data=smp,
                      b_CBre ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        ODoD+
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh +
                   ODoD+ #+ ODoD:n_Comp 
                   ODoD:Veh
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_06E)



  stargazer::stargazer(CBre_Cons_06A,CBre_Cons_06D,CBre_Cons_06E,CBre_Comp_06A,CBre_Comp_06C,CBre_Comp_06E,type="text",
                       digits=2)
  
summary_residual_compare(CBre_Cons_06D,CBre_Cons_06E,CBre_Comp_06C,CBre_Comp_06E,bins=20)
```
Both exceed VIF limitation.

### Model 07B: Old NAICS and ODoD
```{r OldModel07B}
corrdisp<-Hmisc::rcorr(
  as.matrix(cbind(subset(crisis_smp, select=c(b_UCA,c_OffCri,cl_Ceil,
                                              cl_Days,n_Fixed,b_Intl)),
                  dummies::dummy(crisis_smp$Crisis),
                  dummies::dummy(crisis_smp$NoComp),
                  dummies::dummy(crisis_smp$Reach),
                  dummies::dummy(crisis_smp$Veh),
                  dummies::dummy(crisis_smp$Is.Defense),
                  dummies::dummy(crisis_smp$Simple))))
corrdisp[[1]]

#Sumamry plot
summary_discrete_plot(smp1m,"NAICS2",rotate_text=TRUE)
CBre_Cons_07B <- glm (data=smp,
                      b_CBre ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        ODoD+
                       
                        
                        
                        
                        
                        
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        
                        ODoD:b_Intl+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_07B)
glmer_examine(CBre_Cons_07B)

CBre_Comp_07B <- glm (data=smp,
                      b_CBre ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        
                        
                        
                        
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh +
                   ODoD+ ODoD:b_Intl+
                   NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_07B)
glmer_examine(CBre_Comp_07B)

CBre_Cons_07B2 <- glm (data=smp,
                      b_CBre ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        # ODoD+ Agency is missing
                       
                        
                        
                        
                        
                        
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        
                       # ODoD:b_Intl+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Cons_07B2)
glmer_examine(CBre_Cons_07B2)

CBre_Comp_07B2 <- glm (data=smp,
                      b_CBre ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        
                        
                        
                        
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh +
                   # ODoD+
                   NAICS2
                      , family=binomial(link="logit"))
glmer_examine(CBre_Comp_07B2)
glmer_examine(CBre_Comp_07B2)


  stargazer::stargazer(CBre_Cons_07A,CBre_Cons_07B2,CBre_Comp_07A,CBre_Comp_07B2,type="text",
                       digits=2)
  
summary_residual_compare(CBre_Cons_07A,CBre_Cons_07B2,CBre_Comp_07A,CBre_Comp_07B2,bins=20)


```

### Model 10F: Veh:Days
IDVs lower the transaction costs of contracting.  This may lead to a diminishment of their  effects as their  duration grows.

```{r Model10F}


#Sumamry plot
summary_continuous_plot(smp1m,"l_Days","Veh")

#Create the model
CBre_Cons_10F <- glm(data=smp,
                       b_CBre ~cl_def6_HHI_lag1 + 
                         cl_Ceil + cl_Days+
                       cl_def6_HHI_lag1:cl_Ceil+
                                                
                         Veh+
                          #cl_Ceil:cl_Days  +
                         n_Fixed + b_UCA +
                                                b_UCA:cl_def6_HHI_lag1+
                         b_Intl +
                         Veh:cl_Days +
                         NAICS2
                       , family=binomial(link="logit"))
glmer_examine(CBre_Cons_10F)
glmer_examine(CBre_Cons_10F)
  
CBre_Comp_10F<- glm(data=smp,
                       b_CBre ~n_Comp + 
                         cl_Ceil + cl_Days+
                         Veh+
                         # cl_Ceil:cl_Days  +
                         n_Fixed + b_UCA +
                                               b_UCA:n_Comp+
                         b_Intl +
                         Veh:cl_Days +
                         NAICS2
                       , family=binomial(link="logit"))
glmer_examine(CBre_Comp_10F)
glmer_examine(CBre_Comp_10F)

  stargazer::stargazer(CBre_Cons_10D,CBre_Cons_10F,CBre_Comp_10B,CBre_Comp_10F,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_10D,CBre_Cons_10F,CBre_Comp_10B,CBre_Comp_10F,bins=20)


```
The interaction adds fairly little to the model and makes residuals worse, leaving it out.

### Model 10F: Ceil:Days

There are two competing explainations. First, high base duration and ceiling contracts might estimate lower risks, because they give enouogh time to complete the contract. 
```{r Model10F}


#Sumamry plot
summary_continuous_plot(smp1m,"l_Days","l_Ceil")

#Create the model
CBre_Cons_10F <- glm(data=smp,
                       b_CBre ~cl_def6_HHI_lag1 + 
                         cl_Ceil + cl_Days+
                       cl_def6_HHI_lag1:cl_Ceil+
                       cl_Ceil:cl_Days  +
                         Veh+
                          
                         n_Fixed + b_UCA +
                        b_UCA:cl_def6_HHI_lag1+
                         b_Intl +
                         NAICS2
                       , family=binomial(link="logit"))
glmer_examine(CBre_Cons_10F)
glmer_examine(CBre_Cons_10F)
  
CBre_Comp_10F<- glm(data=smp,
                       b_CBre ~n_Comp + 
                         cl_Ceil + cl_Days+
                         Veh+
                         cl_Ceil:cl_Days  +
                         n_Fixed + b_UCA +
                        b_UCA:n_Comp+
                         b_Intl +
                         NAICS2
                       , family=binomial(link="logit"))
glmer_examine(CBre_Comp_10F)
glmer_examine(CBre_Comp_10F)

  stargazer::stargazer(CBre_Cons_10D,CBre_Cons_10F,CBre_Comp_10B,CBre_Comp_10F,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_10D,CBre_Cons_10F,CBre_Comp_10B,CBre_Comp_10F,bins=20)


```
The results were significant though contrary to expectation. The reduction  in deviance is fairly minor and for consolidations makes the residuals worse. Perhaps this results happens because  contracts with a longer duration and higher base might indicate less complexity and more the delivery of something expensive.

### Model 11A: No interactions
This model runs comparatively fast because it only deals in the agency and NAICS2, the broadest categories. The study team initially feared that only this level of analysis might work when it comes to avoiding convergence errors, but subsequent research ( https://rdrr.io/cran/lme4/man/convergence.html ) revealed that large datasets can be a source of false positive warnings.
```{r Model11A}
#Frequency Plot
summary_discrete_plot(smp,"NAICS2")

#This is currently running at home

CBre_Cons_11A <- glmer (data=smp,
                        b_CBre ~cl_def6_HHI_lag1 +cl_def6_ratio_lag1+cl_def6_obl_lag1+
                          cl_US6_avg_sal_lag1+
                          cl_Ceil + cl_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                         
                          
                          # cl_def6_HHI_lag1:cl_def6_obl_lag1+ 
                          # b_UCA:cl_def6_HHI_lag1 + 
                          # b_UCA:cl_Ceil+

                          (1 | NAICS2) + (1 | Agency)
                        
                        , family=binomial(link="logit"),
                        verbose=1)

glmer_examine(CBre_Cons_11A)

CBre_Comp_11A <- glmer (data=smp,
                      b_CBre ~n_Comp +
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        cl_Ceil + cl_Days+
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                    
                        # b_UCA:n_Comp +
                        # b_UCA:cl_Ceil+

                   (1 | NAICS2) + (1 | Agency)

                   , family=binomial(link="logit"),
                  verbose=1)

glmer_examine(CBre_Comp_11A)


any(diag.vals<1e-6)
CBre_Comp_11A.devfun<-devfun
if(!exists("CBre_Comp_11A.devfun"))
  CBre_Comp_11A.devfun <- update(CBre_Comp_11A, devFunOnly=TRUE)


pars<-get_pars(CBre_Comp_11A)
if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Comp_11A.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Comp_11A.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Comp_11A@optinfo$derivs

if(!exists("CBre_Comp_11A.restart"))
  CBre_Comp_11A.restart <- update(CBre_Comp_11A, start=pars)
glmer_examine(CBre_Comp_11A.restart)



stargazer::stargazer(CBre_Cons_11A,CBre_Comp_11A.restart,CBre_Comp_11A.restart
                     ,type="text",
                       digits=2)

summary_residual_compare(CBre_Cons_07B2,CBre_Cons_11A,CBre_Comp_07B2,CBre_Comp_07C3,bins=20)
CBre_Cons_11A<-CBre_Cons_14A
CBre_Comp_11A<-CBre_Comp_14A
CBre_Comp_11A.restart<-CBre_Comp_14A.restart
CBre_Comp_11A.devfun<-CBre_Comp_14A.devfun
summary_residual_compare(CBre_Cons_11A,CBre_Cons_11A,CBre_Comp_11A,CBre_Comp_11A.restart,bins=20)
save(CBre_Cons_11A,CBre_Comp_11A.restart,CBre_Comp_11A.devfun,CBre_Comp_11A.restart,file="output/CBre_11.rdata")

```

### Model 11B: Agency/Office & NAICS2

The North American Industrial Classification system captures the sector of each contract, which are each given a seperate intercept in the model.

```{r Model11B}

#Frequency Plot
summary_discrete_plot(smp,"NAICS2")


CBre_Cons_11B <- glmer (data=smp,
                        b_CBre ~cl_def6_HHI_lag1 +cl_def6_ratio_lag1+cl_def6_obl_lag1+
                          cl_US6_avg_sal_lag1+
                          cl_Ceil + cl_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                         
                          
                          cl_def6_HHI_lag1:cl_def6_obl_lag1+ 
                          b_UCA:cl_def6_HHI_lag1 + 
                          b_UCA:cl_Ceil+

                          (1 | NAICS2) + (1 | Agency/Office)
                        
                        , family=binomial(link="logit"),
                        verbose=1)

glmer_examine(CBre_Cons_11B)

save(CBre_Cons_11B,file="Output//CBre_Cons_11B.rdata")
CBre_Comp_11B <- glmer (data=smp,
                      b_CBre ~n_Comp +
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        cl_Ceil + cl_Days+
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                    
                        b_UCA:n_Comp +
                        b_UCA:cl_Ceil+

                   (1 | NAICS2) + (1 | Agency/Office)

                   , family=binomial(link="logit"),
                  verbose=1)

# glmer_examine(CBre_Comp_11B)
#Ran for two hours Model failed to converge with max|grad| = 0.186396 (tol = 0.001, component 1)
# Plot the model and Vehicle 
# CBre_Comp_11B_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,UCA,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         UCA*Comp) %*%  coef(CBre_Comp_11B))}
# 
# #Days curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_11B_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1,UCA=0),color="blue")+
#   stat_function(fun = CBre_Comp_11B_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1,UCA=0),color="blue")


```

The initial attempt to include the pre-existing intercepts and all inputs resulted in a model that initially failed to converge. Conservatively the intercepts have been temporarily removed to be added back in a subsequent step.



Unfortunately, after including Start Fiscal Year, the model again failed to converge. The standard deviation of Who is 0 while it is notably higher for determining the slope of competition via PSR and for Start Fiscal Year. This suggests that who is adding little to the model and that it is time to go back to model 6C as a starter.



After the incorporation of NAICS intercepts, ceiling related interactions had strange consequences (left out for speed of running RMD reasons). The interaction of Competition and Ceiling, even when introduced alone  had a positive coefficient and removed the effect of Ceiling by itself. When all three interactions were included,  Ceiling and Duration similarly had a notable negative coefficient, which seemed contrary to past literature that suggests greater risks when trying to do a large contract too fast. The interaction of competition and days had a positive coefficient, but was not significant. Single Award IDV does have a significant negative coefficient in interaction with Competition, but the other two types do not and the model fails to converge (with the 250k or 1m sample) and exhibit a peak at the lower end of the residuals.
