---
title: "Contract Termination"
author: "Greg Sanders"
date: "Wednesday, February 8, 2017"
output:
  html_document:
    keep_md: yes
--- 

Modeling Likelihood of Contract Termination
============================================================================

#Setup
```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(arm)
library(R2WinBUGS)
library(Hmisc)
library(sjstats)
source("DIIGstat.r")
source("NAICS.r")

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40


```

Contracts are classified using a mix of numerical and categorical variables. While the changes in numerical variables are easy to grasp and summarize, a contract may have one line item that is competed and another that is not. As is detailed in the exploration on R&D, we are only considering information available prior to contract start. The percentage of contract obligations that were competed is a valuable benchmark, but is highly influenced by factors that occured after contract start.

## Contract Competition

Modeling comepetition with logit model requires limiting to two staes. We limit it to 0 for sole source and 1 for competition, whether there is 1 or more offers.

##Prepare Data
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from   FPDS.


###Data Transformations and Summary



```{r ReadInData, echo = TRUE}
 # load(file="Data/defense_contract_complete.Rdata")
# head(def)
# debug(transform_contract)
# def<-transform_contract(def)  
 # save(file="Data/transformed_def.Rdata",def)
load(file="Data/transformed_def.Rdata")

```


* b_Crai is a binary variable that has a value of 1 for a ceiling Breach of any size has occured, 0 otherwise. ('r summary(def$b_Crai)
NA_stats(def,"b_Crai"))
* b_Term is a binary variable that has a value of 1 for any contracts that have experienced a partial or complete termination, 0 otherwise. ('r summary(def$b_Term)
NA_stats(def,"b_Term"))
* cl_Offr is a binary variable based on competition. It has a value of 0 for uncompeted contracts and a value of 1 for competition, regardless of number of offers. 'r  summary(def$cl_Offr);
NA_stats(def,"cl_Offr")'
* n_Comp is a numeric variable based on competition and number of offers. It has a value of 0 for uncompeted contracts and a value of 1 for single-offer competition, and a value of 2 for multi-offer competition. 'r summary(def$n_Comp);
NA_stats(def,"n_Comp")'
* n_Offr is a numeric variable based on competition and with more granularity on number offers. It has a value of 0 for uncompeted contracts and a value of 1 for single-offer competition, and a value of 2 for 2-offers, 3 for 3-4 offers, and 4 for 5+ offers. 'r summary(def$n_Offr);
NA_stats(def,"n_Offr")'
* l_Offr is the natural log of the number of offers received. Uncompeted contracts are classified as having received one offer. 'r summary(def$l_Offr);
NA_stats(def,"l_Offr")'
* cl_Ceil is the natural log of the initial contract cost ceiling, in then-year dollars. 'r centered_log_description(def$l_Ceil,"dollars");
NA_stats(def,"l_Ceil")'
* cl_Days is the natural log of the initial maximum duration of the contract, in days. The variable is centered, by subtracting its mean ('r centered_log_description(def$l_Days,"days");
NA_stats(def,"l_Days")' 
* SIDV, MIDV, and OIDV are dummy variables based on the contract vehicle. They correspond to Single-Award IDVs, Multi-Award IDVs, and Other IDVs, respectively, having a value of 1 when the task order has that vehicle type, and having a 0 other. The remaining types, definitive contracts and purchase orders, are intentionally left out. ('r summary(def$SIDV);
summary(def$MIDV);
summary(def$OIDV);
NA_stats(def,"Veh")'
* n_Fixed is a numeric variable based on contract pricing. It has a value of 0 for cost-based, 0.5 or "combination or other", 1 for any fixed price (excluding fixed-price level of effort which is classified as cost-based). ('r summary(def$n_Fixed);
NA_stats(def,"n_Fixed")')
* n_Incent is a numeric variable based on fee type. Ig has a value. 1 for incentive fee or cost sharing, 0.5 or "combination or other", 0 for all remaining types. ('r summary(def$n_Incent);
NA_stats(def,"n_Incent")')
* b_UCA is a binary variable with a value of 1 for contracts/task orders that begin as letter contracts or undefinitized contract awards (UCA) and a value of 0 otherwise. 'r
summary(def$b_UCA);
NA_stats(def,"b_UCA")'
* b_Intl is a binary variable with a value of 1 for contracts/task orders with any transactions performed internationally and a value of 0 otherwise. 'r
summary(def$b_Intl);
NA_stats(def,"b_Intl")'
* PSR is a factor reporting whether a contract is primarily for products/services/R&D. 'r
summary(def$PSR);
NA_stats(def,"PSR")'
* ProdServ is a factor reporting the top Product or Service Code of each contract. 'r
summary(def$ProdServ);
NA_stats(def,"ProdServ")'
* NAICS is a factor reporting the top North American Industrial Classification Code of each contract. 'r
summary(def$NAICS);
NA_stats(def,"NAICS")'
* Agency is a factor reporting the top Contracting Agency of each contract. 'r
summary(def$Agency);
NA_stats(def,"Agency")'
* Office is a factor reporting the top Contracting office of each contract. 'r
summary(def$Office);
NA_stats(def,"Office")'


In addition, l_Ceil and l_Days are rescaled to have an average value of 0 and a standard deviation of one. This standardizes interpretation and prevents a "very large eigen value" error later when l_Ceil:lDay is introduced.


Next, we eliminate missing data entries and then draw a sample. The final computation uses all of the data, but as a computation shortcut, only a subset of the data is needed to allow for processing of models in minutes rather than hours.

###Computational Sample Creation
```{r Sample}
 load(file="data//def_sample.Rdata")


levels(smp$EffComp)
smp$cl_Offr<-smp$EffComp
levels(smp$cl_Offr)<-list("0"=c("No Comp.","1 Offer"),
                           "1"="2+ Offers")
summary(smp$cl_Offr)
summary(smp$EffComp)
smp$cl_Offr<-as.numeric(as.character(smp$cl_Offr))

levels(smp1m$EffComp)
smp1m$cl_Offr<-smp1m$EffComp
levels(smp1m$cl_Offr)<-list("0"=c("No Comp.","1 Offer"),
                           "1"="2+ Offers")
summary(smp1m$cl_Offr)
summary(smp1m$EffComp)
smp1m$cl_Offr<-as.numeric(as.character(smp1m$cl_Offr))


# save(smp,smp1m,file="data//def_sample.Rdata")
#Code to update sample w/o recreating.
# smp<-smp["CSIScontractID"]
# smp<-left_join(smp,def)
# smp1m<-smp1m["CSIScontractID"]
# smp1m<-left_join(smp1m,def)

  
# complete<-!is.na(def$b_Term)&
#   !is.na(def$cl_Offr)&
#   !is.na(def$n_Comp)&
#   !is.na(def$l_Ceil)&
#   !is.na(def$l_Days)&
#   !is.na(def$Veh) &
#   !is.na(def$n_Fixed)&
#   !is.na(def$b_Intl)&
#   !is.na(def$b_UCA)&
#   !is.na(def$NAICS)&
#   !is.na(def$NAICS2)&
#   !is.na(def$cl_def6_HHI_lag1)&
#   !is.na(def$US6_avg_sal_lag1)
# # 
# smp<-def[complete,]
# #8818392  to 8818392
# 13057769 to 8335209
# nrow(def[!complete,])/nrow(def)
# sum(def[!complete,]$Action.Obligation,na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
# 
# smp1m<-smp[sample(nrow(smp),1000000),]
# smp<-smp[sample(nrow(smp),250000),]
# save(file="data//def_sample.Rdata",smp,smp1m)

# levels(smp$Intl)<- list("Just U.S."=c("Just U.S."), 
#                                 "Any Intl."=c("Any International"))
# levels(smp1m$Intl)<- list("Just U.S."=c("Just U.S."), 
#                                 "Any Intl."=c("Any International"))


```

#Initial Logit Model

## Study Variable Consolidation

### Level 6
#### Model NCS6A: def6_HHI_lag1
The expectation of the hypotheses is that a lower rate of consolidation will estimate higher levels of competition.

```{r ModelNCS6A_Comp}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(metric="comp",smp,"def6_HHI_lag1")
summary_continuous_plot(metric="comp",smp,"def5_HHI_lag1")
summary_continuous_plot(metric="comp",smp,"def4_HHI_lag1")
summary_continuous_plot(metric="comp",smp,"def3_HHI_lag1")
summary_continuous_plot(metric="comp",smp,"def2_HHI_lag1")

#Model
Comp_Cons_NCS6A <- glm (data=smp,
                 cl_Offr ~c_def6_HHI_lag1)
display(Comp_Cons_NCS6A)


# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")



#Plot residuals versus fitted
  stargazer::stargazer(Comp_Cons_NCS6A,type="text",
                       digits=2)


summary_regression_compare(Comp_Cons_NCS6A,Comp_Cons_NCS6A)

```
Both the summary statistics and the results are surprising. More consolidated sectors are more likely to have competition.

#### Model NCS6B: l_def6_HHI_lag1

Expectations are  unchanged.
```{r ModelNCS6A_Comp}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(metric="comp",smp,"l_def6_HHI_lag1")
summary_continuous_plot(metric="comp",smp,"l_def5_HHI_lag1")
summary_continuous_plot(metric="comp",smp,"l_def4_HHI_lag1")
summary_continuous_plot(metric="comp",smp,"l_def3_HHI_lag1")
summary_continuous_plot(metric="comp",smp,"l_def2_HHI_lag1")


#Model
Comp_Cons_NCS6B <- glm (data=smp,
                 cl_Offr ~cl_def6_HHI_lag1)
display(Comp_Cons_NCS6B)


# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")
# 


#Plot residuals versus fitted
  stargazer::stargazer(Comp_Cons_NCS6A,Comp_Cons_NCS6B,type="text",
                       digits=2)


summary_regression_compare(Comp_Cons_NCS6A,Comp_Cons_NCS6B)
ggplot(Comp_Cons_NCS6B)+geom_point(aes(x=.fitted, y=.resid))




```
Switching to log reomves the uneven distribution with most entries on the lefthand side from the residuals though it doesn't shrink them. 

#### Model NCS6C: Defense to Overall ratio
The lower the ratio of defense obligations to reciepts in the overall economy, the more potential competitors, but also the less developed industrial base. Given the difficulties the DoD has access many more traditional firms, a very low ratio may estimate a lower rate of competition. Interestingly both contradictory expectations find some support in the exploratory statistics, which show a sweet spot well below 5% where competition seems to peak.
```{r ModelNCS6C_Comp}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(metric="comp",smp,"capped_def6_ratio_lag1")
      summary_continuous_plot(metric="comp",smp,"l_def6_ratio_lag1")
      summary_continuous_plot(metric="comp",smp,"capped_def5_ratio_lag1")
      summary_continuous_plot(metric="comp",smp,"l_def5_ratio_lag1")
      
      summary_continuous_plot(metric="comp",smp,"capped_def4_ratio_lag1")
      summary_continuous_plot(metric="comp",smp,"l_def4_ratio_lag1")
      summary_continuous_plot(metric="comp",smp,"capped_def3_ratio_lag1")
      summary_continuous_plot(metric="comp",smp,"l_def3_ratio_lag1")
      summary_continuous_plot(metric="comp",smp,"capped_def2_ratio_lag1")
      summary_continuous_plot(metric="comp",smp,"l_def2_ratio_lag1")
      


#Model
Comp_Cons_NCS6C <- glm (data=smp,
                 cl_Offr ~cl_def6_HHI_lag1+cl_def6_ratio_lag1
                 )
glmer_examine(Comp_Cons_NCS6C,display=TRUE)

# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(Comp_Cons_NCS6B,Comp_Cons_NCS6C,
                       type="text",
                       digits=2)


summary_regression_compare(Comp_Cons_NCS6B,Comp_Cons_NCS6C)



```
The results align with the hypothesis and are significant, although the magnitude is minimal.


#### Model NCS6D: cl_def6_obl_lag1
Defense sector obligations are added to better adjust for the fact that larger sectors tend to have lower HHI indices if only because they include a broader range of activities. In addition, the industrial base is likely more diverse when markets are larger. Thus greater defense in a given sector are expected to estimate a greater likelihood over multi-offer competition. The descriptive statistics tell a somewhat different story for the vary largest defense sectors, which have lower numbers of offers.
Expectations are  unchanged.
```{r ModelNCS6D_Comp}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(metric="comp",smp,"def6_obl_lag1")


summary_continuous_plot(metric="comp",smp,"l_def6_obl_lag1")
summary_continuous_plot(metric="comp",smp,"def5_obl_lag1")

summary_continuous_plot(metric="comp",smp,"l_def5_obl_lag1")
summary_continuous_plot(metric="comp",smp,"def4_obl_lag1")

summary_continuous_plot(metric="comp",smp,"l_def4_obl_lag1")
summary_continuous_plot(metric="comp",smp,"def3_obl_lag1")

summary_continuous_plot(metric="comp",smp,"l_def4_obl_lag1")
summary_continuous_plot(metric="comp",smp,"def2_obl_lag1")

summary_continuous_plot(metric="comp",smp,"l_def2_obl_lag1")

#Model
Comp_Cons_NCS6D <- glm (data=smp,
                 cl_Offr ~cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1)
glmer_examine(Comp_Cons_NCS6D)



#Plot residuals versus fitted
  stargazer::stargazer(Comp_Cons_NCS6C,Comp_Cons_NCS6D,
                       
                       type="text",digits=2)


summary_regression_compare(Comp_Cons_NCS6C,Comp_Cons_NCS6D)



```
Estimated results occur. Residuals increase in magnitude for consolidation but reduce for competition.


#### Model NCS6E: Average Salary
Average salary can be an proxy for unobserved skill requirements and thus complexity. We expect that a greater skill requirement will estimate fewer available competitors and thus fewer offers. The descriptive statistics appear to contradict this belief.
```{r ModelNCS6E_Comp}
#Frequency Plot for unlogged ceiling


summary_continuous_plot(metric="comp",smp,"US6_avg_sal_lag1")

summary_continuous_plot(metric="comp",smp,"l_US6_avg_sal_lag1")

summary_continuous_plot(metric="comp",smp,"US5_avg_sal_lag1")
summary_continuous_plot(metric="comp",smp,"US4_avg_sal_lag1")
summary_continuous_plot(metric="comp",smp,"US3_avg_sal_lag1")
summary_continuous_plot(metric="comp",smp,"US2_avg_sal_lag1")

#Model
#cl_def6_obl_lag1

Comp_Cons_NCS6E <- glm (data=smp,
                 cl_Offr ~cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1 )
glmer_examine(Comp_Cons_NCS6E)



# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
 stargazer::stargazer(Comp_Cons_NCS6C,Comp_Cons_NCS6D,Comp_Cons_NCS6E,
                       
                       type="text",digits=2)



summary_regression_compare(Comp_Cons_NCS6D,Comp_Cons_NCS6E)




```
The results were significant but in the opposite direction expected. This also reverses the sign on ratio, contrary to hypothesis. That said, the reversal of sign for HHI is in keeping with the hypothesis.


### Level 5
#### Model NCS5A: cl_def5_HHI
```{r ModelNCS5A_Comp}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(metric="comp",smp,"l_def6_HHI_lag1")
summary_continuous_plot(metric="comp",smp,"l_def5_HHI_lag1")
summary_continuous_plot(metric="comp",smp,"l_def4_HHI_lag1")
summary_continuous_plot(metric="comp",smp,"l_def3_HHI_lag1")
summary_continuous_plot(metric="comp",smp,"l_def2_HHI_lag1")


#Model
Comp_Cons_NCS5A <- glm (data=smp,
                 cl_Offr ~cl_def5_HHI_lag1)
glmer_examine(Comp_Cons_NCS5A)


# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")
# 


#Plot residuals versus fitted
  stargazer::stargazer(Comp_Cons_NCS6B,Comp_Cons_NCS6D,Comp_Cons_NCS6E,Comp_Cons_NCS5A,type="text",
                       digits=2)


summary_regression_compare(Comp_Cons_NCS6B,Comp_Cons_NCS5A)


```
More significant HHI to offers than 6, but still the opposite of expecations.

#### Model NCS5B: Defense to Overall ratio
The higher the ratio of defense obligations to reciepts in the overall economy, the DoD holds a monosopy over a sector. Given the challenges of monosopy, the a higher ratio estimates a greater  risk of ceiling breaches.
```{r ModelNCS5Bl_Offr}
#Frequency Plot for unlogged ceiling




summary_continuous_plot(metric="comp",smp,"capped_def5_ratio_lag1")
summary_continuous_plot(metric="comp",smp,"l_def5_ratio_lag1")

#Model
Comp_Cons_NCS5B <- glm (data=smp,
                 cl_Offr ~cl_def5_HHI_lag1+cl_def5_ratio_lag1 
                 )
glmer_examine(Comp_Cons_NCS5B)

# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(Comp_Cons_NCS6C,Comp_Cons_NCS6E,Comp_Cons_NCS5A,Comp_Cons_NCS5B,
                       type="text",
                       digits=2)


summary_regression_compare(Comp_Cons_NCS5A,Comp_Cons_NCS5B)
summary_regression_compare(Comp_Cons_NCS6D,Comp_Cons_NCS5B)



```
The results align with the hypothesis, although the magnitude is minimal, if larger in magnitude than the level 6 version.

#### Model NCS5C: cl_def5_obl_lag1
Defense sector obligations are added to better adjust for the fact that larger sectors tend to have lower HHI indices if only because they include a broader range of activities. In addition, Acting somewhat as a proxy for MDAP status, larger sectors may also have a greater risk of cascading problems. Thus greater defense obligations in a given sector are expected to estimate a greater likelihood over ceiling breaches,
Expectations are  unchanged.
```{r ModelNCSD_Comp}


#Model
Comp_Cons_NCS5C <- glm (data=smp,
                 cl_Offr ~cl_def5_HHI_lag1+cl_def5_ratio_lag1+cl_def5_obl_lag1)
glmer_examine(Comp_Cons_NCS5C)


# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(Comp_Cons_NCS6D,Comp_Cons_NCS6E,Comp_Cons_NCS5A,Comp_Cons_NCS5B,Comp_Cons_NCS5C,
                       type="text",
                       digits=2)


summary_regression_compare(Comp_Cons_NCS5B,Comp_Cons_NCS5C)


```
Size seems to ad less to the model at level 5 than level 6.

#### Model NCS5D: Average Salary
Average salary can be an proxy for unobserved skill requirements and thus complexity. We expect that a greater skill requirement will estimate fewer available competitors and thus fewer offers. The descriptive statistics appear to contradict this belief.
```{r ModelNCS5D_Comp}
#Frequency Plot for unlogged ceiling



summary_continuous_plot(metric="comp",smp,"US5_avg_sal_lag1")

#Model
#cl_def5_obl_lag1

Comp_Cons_NCS5D <- glm (data=smp,
                 cl_Offr ~cl_def5_HHI_lag1+cl_def5_ratio_lag1+cl_def5_obl_lag1+
                  cl_US5_avg_sal_lag1 )
glmer_examine(Comp_Cons_NCS5D)



# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(Comp_Cons_NCS6E,Comp_Cons_NCS5A,Comp_Cons_NCS5B,Comp_Cons_NCS5C,Comp_Cons_NCS5D,
                       type="text",
                       digits=2)




summary_regression_compare(Comp_Cons_NCS5C,Comp_Cons_NCS5D)




```
The results were significant but in the opposite direction expected. This also reverses the sign on everthing else, contrary to expectations in hte case of ratio and obl. That said, the reversal of sign for HHI is in keeping with the hypothesis.

### Level 4
#### Model NCS4A: cl_def4_HHI
```{r ModelNCS4A_Comp}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(metric="comp",smp,"l_def4_HHI_lag1")


#Model
Comp_Cons_NCS4A <- glm (data=smp,
                 cl_Offr ~cl_def4_HHI_lag1)
display(Comp_Cons_NCS4A)


# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")
# 


#Plot residuals versus fitted
  stargazer::stargazer(Comp_Cons_NCS6B,Comp_Cons_NCS6D,Comp_Cons_NCS6E,Comp_Cons_NCS5A,Comp_Cons_NCS4A,type="text",
                       digits=2)


summary_regression_compare(Comp_Cons_NCS6B,Comp_Cons_NCS4A)


```

Level 4 HHI seems to slightly out perform level 6 and 5. Though is still opposite of expectations.



#### Model NCS4B: Defense to Overall ratio
The higher the ratio of defense obligations to reciepts in the overall economy, the DoD holds a monosopy over a sector. Given the challenges of monosopy, the a higher ratio estimates a greater  risk of ceiling breaches.
```{r ModelNCS4cl_Offr}
#Frequency Plot for unlogged ceiling


summary_continuous_plot(metric="comp",smp,"capped_def4_ratio_lag1")
summary_continuous_plot(metric="comp",smp,"l_def4_ratio_lag1")

#Model
Comp_Cons_NCS4B <- glm (data=smp,
                 cl_Offr ~cl_def4_HHI_lag1+cl_def4_ratio_lag1, 
                 )
glmer_examine(Comp_Cons_NCS4B)



#Plot residuals versus fitted
  stargazer::stargazer(Comp_Cons_NCS6C,Comp_Cons_NCS5B,Comp_Cons_NCS4A,Comp_Cons_NCS4B,
                       type="text",
                       digits=2)


summary_regression_compare(Comp_Cons_NCS4A,Comp_Cons_NCS4B)
summary_regression_compare(Comp_Cons_NCS5B,Comp_Cons_NCS4B)




```
The results align with the hypothesis, although the magnitude is small, if larger in magnitude than the level 5 or level 6 version.



#### Model NCS4C: cl_def4_obl_lag1
Defense sector obligations are added to better adjust for the fact that larger sectors tend to have lower HHI indices if only because they include a broader range of activities. In addition, Acting somewhat as a proxy for MDAP status, larger sectors may also have a greater risk of cascading problems. Thus greater defense obligations in a given sector are expected to estimate a greater likelihood over ceiling breaches,
Expectations are  unchanged.
```{r ModelNCS4C_Comp}


#Model
Comp_Cons_NCS4C <- glm (data=smp,
                 cl_Offr ~cl_def4_HHI_lag1+cl_def4_ratio_lag1+cl_def4_obl_lag1)
glmer_examine(Comp_Cons_NCS4C)


# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
stargazer::stargazer(Comp_Cons_NCS6D,Comp_Cons_NCS5C,Comp_Cons_NCS4B,Comp_Cons_NCS4C,
                       type="text",
                       digits=2)



  #Compare to prior at same level
summary_regression_compare(Comp_Cons_NCS4B,Comp_Cons_NCS4C)
#Compare to prior at lower level
summary_regression_compare(Comp_Cons_NCS6D,Comp_Cons_NCS4C)
```
Size seems to add only a little less to the model at level 4 than level 6. In  general, magnitudes are  greater, though for HHI in an unexpected direction.

#### Model NCS4D: Average Salary
Average salary can be an proxy for unobserved skill requirements and thus complexity. We expect that a greater skill requirement will estimate fewer available competitors and thus fewer offers. The descriptive statistics appear to contradict this belief.
```{r ModelNCS4D_Comp}
#Frequency Plot for unlogged ceiling



summary_continuous_plot(metric="comp",smp,"US4_avg_sal_lag1")

#Model
#cl_def4_obl_lag1

Comp_Cons_NCS4D <- glm (data=smp,
                 cl_Offr ~cl_def4_HHI_lag1+cl_def4_ratio_lag1+cl_def4_obl_lag1+
                  cl_US4_avg_sal_lag1 )
glmer_examine(Comp_Cons_NCS4D)



# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(Comp_Cons_NCS6E,Comp_Cons_NCS5D,Comp_Cons_NCS4A,Comp_Cons_NCS4B,Comp_Cons_NCS4C,Comp_Cons_NCS4D,
                       type="text",
                       digits=2)




summary_regression_compare(Comp_Cons_NCS4C,Comp_Cons_NCS4D)




```
The results were significant but in the opposite direction expected. Nothing flipps signs in this iteration. The AIC however, is notably higher than for level 5 and 6 results.
### Level 3
#### Model NCS3A: cl_def3_HHI
```{r ModelNCS3A_Comp}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(metric="comp",smp,"l_def3_HHI_lag1")


#Model
Comp_Cons_NCS3A <- glm (data=smp,
                 cl_Offr ~cl_def3_HHI_lag1)
display(Comp_Cons_NCS3A)


# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")
# 


#Plot residuals versus fitted
  stargazer::stargazer(Comp_Cons_NCS6B,Comp_Cons_NCS6E,Comp_Cons_NCS5A,Comp_Cons_NCS4A,Comp_Cons_NCS3A,type="text",
                       digits=2)


summary_regression_compare(Comp_Cons_NCS6B,Comp_Cons_NCS3A)


```

HHI becomes a more powerful predictor at each level, but never in the expecteddirection.


#### Model NCS3B: Defense to Overall ratio
The higher the ratio of defense obligations to reciepts in the overall economy, the DoD holds a monosopy over a sector. Given the challenges of monosopy, the a higher ratio estimates a greater  risk of ceiling breaches.
```{r ModelNCS3cl_Offr}
#Frequency Plot for unlogged ceiling




summary_continuous_plot(metric="comp",smp,"capped_def3_ratio_lag1")
summary_continuous_plot(metric="comp",smp,"l_def3_ratio_lag1")

#Model
Comp_Cons_NCS3B <- glm (data=smp,
                 cl_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1, 
                 )
glmer_examine(Comp_Cons_NCS3B)


#Plot residuals versus fitted
  stargazer::stargazer(Comp_Cons_NCS6C,Comp_Cons_NCS5B,Comp_Cons_NCS4B,Comp_Cons_NCS3A,Comp_Cons_NCS3B,
                       type="text",
                       digits=2)


summary_regression_compare(Comp_Cons_NCS3A,Comp_Cons_NCS3B)
summary_regression_compare(Comp_Cons_NCS4B,Comp_Cons_NCS3B)


```
The results align with the hypothesis, although the magnitude is small, if larger in magnitude than the level 4 version. Although the residuals also notably increase in magnitude with the introduction of this variable.


#### Model NCS3C: cl_def3_obl_lag1
Defense sector obligations are added to better adjust for the fact that larger sectors tend to have lower HHI indices if only because they include a broader range of activities. In addition, Acting somewhat as a proxy for MDAP status, larger sectors may also have a greater risk of cascading problems. Thus greater defense obligations in a given sector are expected to estimate a greater likelihood over ceiling breaches,
Expectations are  unchanged.
```{r ModelNCS3C_Comp}


#Model
Comp_Cons_NCS3C <- glm (data=smp,
                 cl_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+cl_def3_obl_lag1)
glmer_examine(Comp_Cons_NCS3C)

Comp_Cons_NCS3C2 <- glm (data=smp,
                 cl_Offr ~cl_def3_HHI_lag1+cl_def3_obl_lag1)
glmer_examine(Comp_Cons_NCS3C2)


#Plot residuals versus fitted
stargazer::stargazer(Comp_Cons_NCS6D,Comp_Cons_NCS5C,Comp_Cons_NCS4C,
                       Comp_Cons_NCS3C2,type="text",
                       digits=2)



  #Compare to prior at same level
summary_regression_compare(Comp_Cons_NCS3B,Comp_Cons_NCS3C2)
#Compare to prior at lower level
summary_regression_compare(Comp_Cons_NCS6D,Comp_Cons_NCS3C2)
```
Size and ratio have a VIF challenge. Keeping ratio as it has more predictive power.


#### Model NCS3D: Average Salary
Average salary can be an proxy for unobserved skill requirements. We expect that a greater skill requirement will estimate a greater risk of ceiling breaches.
```{r ModelNCS3D_Comp}
#Frequency Plot for unlogged ceiling


summary_continuous_plot(metric="comp",smp,"US3_avg_sal_lag1")
summary_continuous_plot(metric="comp",smp,"l_US3_avg_sal_lag1")

summary_continuous_plot(metric="comp",smp,"US5_avg_sal_lag1")
summary_continuous_plot(metric="comp",smp,"US4_avg_sal_lag1")
summary_continuous_plot(metric="comp",smp,"US3_avg_sal_lag1")
summary_continuous_plot(metric="comp",smp,"US2_avg_sal_lag1")

#Model

Comp_Cons_NCS3D <- glm (data=smp,
                 cl_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                  cl_US3_avg_sal_lag1)
glmer_examine(Comp_Cons_NCS3D)






#Plot residuals versus fitted
 stargazer::stargazer(Comp_Cons_NCS6E,Comp_Cons_NCS5D,Comp_Cons_NCS4D,Comp_Cons_NCS3B,Comp_Cons_NCS3C2,Comp_Cons_NCS3D,
                       
                       type="text",digits=2)


summary_regression_compare(Comp_Cons_NCS3B,Comp_Cons_NCS3D)
summary_regression_compare(Comp_Cons_NCS3C2,Comp_Cons_NCS3D)


```
Average salary continues to surprise, but even without defense obligations this model has the lowest AIC.


#### Model NCS3E: NAICS 6 and NAICS 3
Consolidation at lessa nd more granular levels may have different effects. Efficiencies are often used to describe sectors, like utilities, with high barriers to entry. Many of these aspects seem like they would already be captured at less granular NAICS levels, e.g. power plants, rather than more specific NAICS levels, like solar vs. coal. As a result, consolidation for more granular NAICS codes should estimate higher rates of ceiling breaches compared to less granular NAICS code.

We'll start by adding in everything from both models and seeing what violates VIF.
```{r ModelNCS3E_Comp}
#Frequency Plot for unlogged ceiling


#Model
Comp_Cons_NCS3E <- glm (data=smp,
                 cl_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                  cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1  )
glmer_examine(Comp_Cons_NCS3E,display=TRUE)
#Average salary 6 has the highest VIF though but both average salaries are over 2.0 and 3 is more contrary to expectations. Taking it out.
Comp_Cons_NCS3E2 <- glm (data=smp,
                 cl_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                  # cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1  )
glmer_examine(Comp_Cons_NCS3E2,display=TRUE)



#Plot residuals versus fitted
#Plot residuals versus fitted
 stargazer::stargazer(Comp_Cons_NCS6E,Comp_Cons_NCS5D,Comp_Cons_NCS4D,Comp_Cons_NCS3B,Comp_Cons_NCS3C2,Comp_Cons_NCS3D,Comp_Cons_NCS3E2,
                       
                       type="text",digits=2)


summary_regression_compare(Comp_Cons_NCS3D,Comp_Cons_NCS3E2)
summary_regression_compare(Comp_Cons_NCS6E,Comp_Cons_NCS3E2)


```
The expectation is upheld. Avereage Salary 3 was removed from the model for VIF reasons and because it is less precise than average salary 3.


### Level 2
#### Model NCS2A: cl_def2_HHI
```{r ModelNCS2A_Comp}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(metric="comp",smp,"l_def2_HHI_lag1")


#Model
Comp_Cons_NCS2A <- glm (data=smp,
                 cl_Offr ~cl_def2_HHI_lag1)
display(Comp_Cons_NCS2A)



#Plot residuals versus fitted
  stargazer::stargazer(Comp_Cons_NCS6B,Comp_Cons_NCS5A,Comp_Cons_NCS4A,Comp_Cons_NCS3A,Comp_Cons_NCS2A,type="text",
                       digits=2)


summary_regression_compare(Comp_Cons_NCS6B,Comp_Cons_NCS2A)


```

Expectations not met. Level 2 HHI seems to slightly out perform level 6, but underperform level 3.

#### Model NCS2B: Defense to Overall ratio
The higher the ratio of defense obligations to reciepts in the overall economy, the DoD holds a monosopy over a sector. Given the challenges of monosopy, the a higher ratio estimates a greater  risk of ceiling breaches.
```{r ModelNCS2cl_Offr}
#Frequency Plot for unlogged ceiling




summary_continuous_plot(metric="comp",smp,"capped_def2_ratio_lag1")
summary_continuous_plot(metric="comp",smp,"l_def2_ratio_lag1")

#Model
Comp_Cons_NCS2B <- glm (data=smp,
                 cl_Offr ~cl_def2_HHI_lag1+cl_def2_ratio_lag1
                 )
glmer_examine(Comp_Cons_NCS2B)


#Plot residuals versus fitted
#Plot residuals versus fitted
  stargazer::stargazer(Comp_Cons_NCS6C,Comp_Cons_NCS5B,Comp_Cons_NCS4B,Comp_Cons_NCS3B,Comp_Cons_NCS2A,Comp_Cons_NCS2B,
                       type="text",
                       digits=2)


summary_regression_compare(Comp_Cons_NCS2A,Comp_Cons_NCS2B)
summary_regression_compare(Comp_Cons_NCS3B,Comp_Cons_NCS2B)

```
The results do align with the expectation, but with a minimal magnitude




#### Model NCS2C: cl_def2_obl_lag1
Defense sector obligations are added to better adjust for the fact that larger sectors tend to have lower HHI indices if only because they include a broader range of activities. In addition, Acting somewhat as a proxy for MDAP status, larger sectors may also have a greater risk of cascading problems. Thus greater defense obligations in a given sector are expected to estimate a greater likelihood over ceiling breaches,
Expectations are  unchanged.
```{r ModelNCS2C_Comp}


#Model
Comp_Cons_NCS2C <- glm (data=smp,
                 cl_Offr ~cl_def2_HHI_lag1+cl_def2_ratio_lag1+cl_def2_obl_lag1)
glmer_examine(Comp_Cons_NCS2C,display=TRUE)

Comp_Cons_NCS2C2 <- glm (data=smp,
                 cl_Offr ~cl_def2_HHI_lag1+cl_def2_obl_lag1)
glmer_examine(Comp_Cons_NCS2C,display=TRUE)




#Plot residuals versus fitted
stargazer::stargazer(Comp_Cons_NCS6D,Comp_Cons_NCS5C,Comp_Cons_NCS4C,
                       Comp_Cons_NCS3B,Comp_Cons_NCS3C2,Comp_Cons_NCS2B,Comp_Cons_NCS2C2,type="text",
                       digits=2)



  #Compare to prior at same level
summary_regression_compare(Comp_Cons_NCS2B,Comp_Cons_NCS2C2)
#Compare to prior at lower level
summary_regression_compare(Comp_Cons_NCS6D,Comp_Cons_NCS2C2)


```
Size seems to add less to the model at level 2 than level 6. That said it still has greater magnitude and lower AIC than the model with ratio, so keeping this one.


#### Model NCS2D: Average Salary
Average salary can be an proxy for unobserved skill requirements. We expect that a greater skill requirement will estimate a greater risk of ceiling breaches.
```{r ModelNCS2D_Comp}
#Frequency Plot for unlogged ceiling


summary_continuous_plot(metric="comp",smp,"US2_avg_sal_lag1")
summary_continuous_plot(metric="comp",smp,"l_US2_avg_sal_lag1")

summary_continuous_plot(metric="comp",smp,"US5_avg_sal_lag1")
summary_continuous_plot(metric="comp",smp,"US4_avg_sal_lag1")
summary_continuous_plot(metric="comp",smp,"US2_avg_sal_lag1")
summary_continuous_plot(metric="comp",smp,"US2_avg_sal_lag1")

#Model

Comp_Cons_NCS2D <- glm (data=smp,
                 cl_Offr ~cl_def2_HHI_lag1+cl_def2_obl_lag1+
                  cl_US2_avg_sal_lag1 )
glmer_examine(Comp_Cons_NCS2D)






#Plot residuals versus fitted
 stargazer::stargazer(Comp_Cons_NCS6E,Comp_Cons_NCS5D,Comp_Cons_NCS4D,Comp_Cons_NCS3D,
                      Comp_Cons_NCS2B,Comp_Cons_NCS2C2,Comp_Cons_NCS2D,
                       
                       type="text",digits=2)



summary_regression_compare(Comp_Cons_NCS2C2,Comp_Cons_NCS2D)
summary_regression_compare(Comp_Cons_NCS6E,Comp_Cons_NCS2D)
summary_regression_compare(Comp_Cons_NCS3D,Comp_Cons_NCS2D)


```
Contrary to expectation but significant.

#### Model NCS2E: NAICS 6 and NAICS 2
Consolidation at lessa nd more granular levels may have different effects. Efficiencies are often used to describe sectors, like utilities, with high barriers to entry. Many of these aspects seem like they would already be captured at less granular NAICS levels, e.g. power plants, rather than more specific NAICS levels, like solar vs. coal. As a result, consolidation for more granular NAICS codes should estimate higher rates of ceiling breaches compared to less granular NAICS code.

We'll start by adding in everything from both models and seeing what violates VIF.
```{r ModelNCS2E_Comp}
#Frequency Plot for unlogged ceiling


#Model
Comp_Cons_NCS2E <- glm (data=smp,
                 cl_Offr ~cl_def2_HHI_lag1+cl_def2_obl_lag1+
                  cl_US2_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1  )
glmer_examine(Comp_Cons_NCS2E)

#Average salary 6 has the highest VIF though but both average salaries are over 2.0 and 2 is more contrary to expectations and less deatiled. Taking it out.
Comp_Cons_NCS2E2 <- glm (data=smp,
                 cl_Offr ~cl_def2_HHI_lag1+cl_def2_obl_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1  )
glmer_examine(Comp_Cons_NCS2E2)


#Plot residuals versus fitted
 stargazer::stargazer(Comp_Cons_NCS3E2,Comp_Cons_NCS2D,Comp_Cons_NCS2E2,
                       type="text",digits=2)


summary_regression_compare(Comp_Cons_NCS3E2,Comp_Cons_NCS2E2)
summary_regression_compare(Comp_Cons_NCS2D,Comp_Cons_NCS2E2)
summary_regression_compare(Comp_Cons_NCS2D,Comp_Cons_NCS2E2)



```
The expectations is upheld. AIC is  lower for the level3/level 6 version, so sticking with that.


##Scope Variables
###Model 02A: Cost Ceiling
Contract size is one proxy for contract complexity, which raises barriers to entry and reduces the number of qualified vendors. Thus contract size is expected to estimate a smaller number of offers.

```{r Model02A_Comp}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(metric="comp",smp,"UnmodifiedContractBaseAndAllOptionsValue",
               bins=1000)
summary_continuous_plot(subset(smp,UnmodifiedContractBaseAndAllOptionsValue<100000000),
               "UnmodifiedContractBaseAndAllOptionsValue",
               metric="comp")

#Frequency Plot for logged ceiling
summary_continuous_plot(metric="comp",smp,"l_Ceil")


#Model
Comp_Cons_02A <- glm (data=smp,
                 cl_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                  # cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1 + cl_Ceil )
glmer_examine(Comp_Cons_02A,display=TRUE)

#Plot residuals versus fitted
  stargazer::stargazer(Comp_Cons_NCS3E2, Comp_Cons_02A,type="text",
                       digits=2)


summary_regression_compare(Comp_Cons_NCS3E2,Comp_Cons_02A)


```

Contract ceiling has a significant relationship in the expected direction.






###Model 02B: Maximum Duration
The study team did not have strong apriori expectation on the effect on contract duration. Past research has found that longer contracts offer stability and are often more appealing to vendors but may also indicate increased complexity. Examining the descriptive stats, the second logic seems to win out. We expect that initial duration contracts will have fewer offers.

```{r Model02B_Comp}
#Frequency Plot for max duration
summary_continuous_plot(metric="comp",smp,"UnmodifiedDays",
               bins=1000)

#Frequency Plot for logged max duration
summary_continuous_plot(metric="comp",smp,"l_Days")



#Model
Comp_Cons_02B <- glm (data=smp,
                 cl_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                  # cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1 + 
                   cl_Ceil+cl_Days )
glmer_examine(Comp_Cons_02B,display=TRUE)


  stargazer::stargazer(Comp_Cons_02A,Comp_Cons_02B,type="text",
                       digits=2)

summary_regression_compare(Comp_Cons_02A,Comp_Cons_02B)

```
The descriptive stat based expectation was upheld.




##Contract Vehicle
### Model 03A: Contract Vehicles
Our dataset includes both stand alone contract awards and task orders that are under larger indefinite delivery vehilces (IDVs). We do not have clear expectations on single-award IDCs or BPA/BOA. The baseline form of definitive contracts are commonly used in industry and do not have an intrinsic requirement to compete to compete. Multi-award IDCs and FSS/GWACs do have such a requirements, but also have a structure intended to insure competition, so they may estimate a lower rate of offers than definitive contracts but a higher rate than other forms.


```{r Model03A_Comp}
#Frequency Plot
summary_discrete_plot(metric="comp",smp,"Veh")





#Model
Comp_Cons_03A <- glm (data=smp,
                 cl_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                  # cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1 + 
                   cl_Ceil+cl_Days+
                   Veh)
glmer_examine(Comp_Cons_03A,display=TRUE)


#Plot the fitted values vs actual results
stargazer::stargazer(Comp_Cons_02B,Comp_Cons_03A,type="text",
                       digits=2)


summary_regression_compare(Comp_Cons_02B,Comp_Cons_03A)

```

The greater numbmer of offers for definitive contracts is confirmed. Somewhat surprisingly, single-award IDCs receive a high number of offers, though this reflects competition for tha overall vehicle and not each specific task order like for Multiple Award IDCs.




##Type of Contract

The next step adds a measure for whether the contract was cost-based or fixed-price. Prior CSIS research has found that fixed-price contracts do face a higher risk of termination across the board.



###Model 04A: Fixed-Price Numerical
While fixed-price contracts can be higher risk, they are also standard in industry and do not require cost accounting standards. Closer to fixed-price contracts are expected to estimate  higher number of offers.
```{r Model04A}

#Frequency Plot
summary_discrete_plot(metric="comp",smp,"FxCb")


#Create the model
Comp_Cons_04A <- glm (data=smp,
                 cl_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                  # cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1 + 
                   cl_Ceil+cl_Days+
                   Veh+
                   n_Fixed)
glmer_examine(Comp_Cons_04A,display=TRUE)



stargazer::stargazer(Comp_Cons_03A,Comp_Cons_04A,type="text",
                       digits=2)
summary_regression_compare(Comp_Cons_03A,Comp_Cons_04A)

```

And fixed price contracts do indeed have a significant coefficient that correlates with a greater number of offer.


###Model 04B: Fixed-Price Bins
This appraoch treats combination as a seperate category of contracts rather than a mid point between fixed-price and cost base. The expectation is that it will still fall in the middle between the two when estimating the number of offers, since fixed-price is the base, this means that both it and cost-based would have a negative coefficient. 
```{r Model04B}

#Frequency Plot
summary_discrete_plot(metric="comp",smp,"FxCb")


#Create the model

Comp_Cons_04B <- glm (data=smp,
                 cl_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                  # cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1 + 
                   cl_Ceil+cl_Days+
                   Veh+
                   FxCb)
glmer_examine(Comp_Cons_04B,display=TRUE)

stargazer::stargazer(Comp_Cons_04A,Comp_Cons_04B,
                     type="text",
                       digits=2)
summary_regression_compare(Comp_Cons_04A,Comp_Cons_04B)

```

Combo/Other contracts do not end up in the middle and are instead not significant, otherwise the results are as expcted.


###Model 04C: Pricing Detail


The more commercial like models, firm-fixed price and time & materials/labor hours/ fixed price;level of effort have fewer requirements for cost accounting and other standards not common in the commercial sector. The baseline condition of firm fixed price wwill estimate greater number of offers aswill T&M/LH/FP:LoE. 
```{r Model04C}

#Frequency Plot
summary_discrete_plot(metric="comp",smp,"FxCb")
summary_discrete_plot(metric="comp",smp,"Fee")
summary_discrete_plot(metric="comp",smp,"FxCb","Fee")



summary_discrete_plot(metric="comp",smp,"Pricing",rotate=FALSE)

#Create the model
Comp_Cons_04C <- glm (data=smp,
                 cl_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                  # cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1 + 
                   cl_Ceil+cl_Days+
                   Veh+
                   Pricing)
glmer_examine(Comp_Cons_04C,display=TRUE)


stargazer::stargazer(Comp_Cons_04A,Comp_Cons_04B,Comp_Cons_04C,
                     type="text",
                       digits=2)
summary_regression_compare(Comp_Cons_04A,Comp_Cons_04B)

```
Labor Hours/T&M/FFP:LoE proved associated with even more offers than FFP, but Fixed-PRice other is the clear winner. Oddly including this breakout resulted in larger ceilings now predicting more offers.

###Model 04D: Incentive Fees

In the performance of the defense acquisition system report, the benefits found were reduced cost overruns. Their cost sharing might  be more popular than other forms of cost-based contracts, but the cost-accounting is likely to be a barrier to entry and  the  coefficient for other fixed price is  already quite high. Thus the expectation is that incentive fees will estimate a slightly lower rate of offers than firm fixed price contracts.

```{r Model04D_Comp}

#Frequency Plot
summary_discrete_plot(metric="comp",smp,"Fee")
summary_discrete_plot(metric="comp",smp,"PricingFee")


summary(factor(smp$PricingFee))

#Create the model
Comp_Cons_04D <- glm (data=smp,
                 cl_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                  # cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1 + 
                   cl_Ceil+cl_Days+
                   Veh+
                   PricingFee)
glmer_examine(Comp_Cons_04D)


stargazer::stargazer(Comp_Cons_04A,Comp_Cons_04B,Comp_Cons_04C,Comp_Cons_04D,
                     type="text",
                       digits=2)
summary_regression_compare(Comp_Cons_04C,Comp_Cons_04D)

```

Oddly the number of offers for incentive fee contracts is notably lower than cost-based contracts.

###Model 04E: Undefinitized Contract Awards
Undefinitized Contract Awards allow for quick action in situations where there is not time or information to establish all of a contracts properties at the time of signing. These circumstances are often not conducive to competing or receiving multiple offers and thus UCA is expected to estimate fewer offers.


```{r Model04E_Comp}

#Frequency Plot
summary_discrete_plot(metric="comp",smp,"UCA")



#Create the model
Comp_Cons_04E <- glm (data=smp,
                 cl_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                  # cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1 + 
                   cl_Ceil+cl_Days+
                   Veh+
                   PricingFee+UCA)

glmer_examine(Comp_Cons_04E)


stargazer::stargazer(Comp_Cons_04D,Comp_Cons_04E,
                     type="text",
                       digits=2)
summary_regression_compare(Comp_Cons_04D,Comp_Cons_04E)


```
Expectations hold.


##Place of Performance
###Model 05A: Any International

International contracts may often offer fewer known options to DoD customer and a more challenging operating environment. And thus international place of performance contracts are expected to estimate fewer offers. Interestingly, in the descriptive stats, they are more competed but still receive fewer offers, which is not inconsistent with this expectation.
```{r Model05A_Comp}

#Frequency Plot
summary_discrete_plot(metric="comp",smp,"Intl")



#Create the model
Comp_Cons_05A <- glm (data=smp,
                 cl_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                  # cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1 + 
                   cl_Ceil+cl_Days+
                   Veh+
                   PricingFee+UCA+
                   b_Intl)

glmer_examine(Comp_Cons_05A)


stargazer::stargazer(Comp_Cons_04E,Comp_Cons_05A,
                     type="text",
                       digits=2)
summary_regression_compare(Comp_Cons_04E,Comp_Cons_05A)



```

International performance of contract had a positive  coefficent as expected.

##Who
Adding agency is a computationally light way of considering the eventual inclusion of agency and office.


###Model 06A: Agency
This inclusion is not intended to study agenc directly, but to see a blunt version of effect inclusion on other variables.
```{r Model06A}
    #Frequency Plot
  summary_discrete_plot(def,"Agency",rotate_text=TRUE)


#Create the model
Comp_Cons_06A <- glm (data=smp,
                 cl_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                  # cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1 + 
                   cl_Ceil+cl_Days+
                   Veh+
                   PricingFee+UCA+
                   b_Intl+
                   Agency)

glmer_examine(Comp_Cons_06A)


  stargazer::stargazer(Comp_Cons_05A,Comp_Cons_06A,type="text",
                       digits=2)
  
summary_regression_compare(Comp_Cons_05A,Comp_Cons_06A)

rm(Comp_Cons_06A,Comp_Cons_06A2)
```



##What
### Model 07A: NAICS2
```{r Model07A}
corrdisp<-Hmisc::rcorr(
  as.matrix(cbind(subset(crisis_smp, select=c(b_UCA,c_OffCri,cl_Ceil,
                                              cl_Days,n_Fixed,b_Intl)),
                  dummies::dummy(crisis_smp$Crisis),
                  dummies::dummy(crisis_smp$NoComp),
                  dummies::dummy(crisis_smp$Reach),
                  dummies::dummy(crisis_smp$Veh),
                  dummies::dummy(crisis_smp$Is.Defense),
                  dummies::dummy(crisis_smp$Simple))))
corrdisp[[1]]

#Sumamry plot
summary_discrete_plot(metric="comp",smp1m,"NAICS2",rotate_text=TRUE)




#Create the model
Comp_Cons_07A <- glm (data=smp,
                 cl_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                  # cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1 + 
                   cl_Ceil+cl_Days+
                   Veh+
                   PricingFee+UCA+
                   b_Intl+
                   Agency+
                   NAICS2)

glmer_examine(Comp_Cons_07A)



  stargazer::stargazer(Comp_Cons_06A,Comp_Cons_07A,type="text",
                       digits=2)
  
summary_regression_compare(Comp_Cons_06A,Comp_Cons_07A)


```


Unfortunately introduction of the NAICS variables significantly increases the magnitude of outlier residuals.

# Interactions
## Consolidation
### Model 10A: Cons:UCA
Starting with Consolidation and UCA. Time pressure is often in place for UCAs so in consolidated sectors, offers may be particularly hard to come by. Thus the interaction of consolidation and UCA estimates fewer offers.
```{r Model10A}
#Sumamry plot
summary_continuous_plot(metric="comp",smp1m,"cl_def6_HHI_lag1","UCA")



#Create the model
Comp_Cons_10A <- glm (data=smp,
                 cl_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                  # cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1 + 
                   cl_Ceil+cl_Days+
                   Veh+
                   PricingFee+UCA+
                   b_Intl+
                   
                   b_UCA:cl_def6_HHI_lag1 +
                   
                   Agency+
                   NAICS2)

glmer_examine(Comp_Cons_10A)

  stargazer::stargazer(Comp_Cons_07A,Comp_Cons_10A,type="text",
                       digits=2)
  
  

summary_regression_compare(Comp_Cons_07A,Comp_Cons_10A)


```
The interaction is significant and UCA / high levels of consolidation estimates fewer offers.


### Model 10C: Cons:Days
The next reintroduction is competition/consolidation and days. The benefits of competition may reduce over time.
Skipping duration^2 and removal of ceiling ^2

Greater duration may limit the influence of competition, at least under the policy guidance that encourages  regular recompeting. In theor this same logic could apply to consolidation as it locks in market conditions at a particular point.



```{r Model10C}


#Sumamry plot
summary_continuous_plot(metric="comp",smp1m,"cl_Days","cl_def6_HHI_lag1")
summary_continuous_plot(metric="comp",smp1m,"cl_Days","EffComp")

#Create the model
Comp_Cons_10C <- glm (data=smp,
                      cl_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       cl_def6_HHI_lag1:cl_Days +
                        # cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:cl_def6_HHI_lag1 +
                        # b_UCA:cl_Ceil+
                        
                        Agency+
                        NAICS2
                      )
glmer_examine(Comp_Cons_10C)





  stargazer::stargazer(Comp_Cons_10B,Comp_Cons_10C,type="text",
                       digits=2)
  
  

summary_regression_compare(Comp_Cons_10B,Comp_Cons_10C)


```
The interaction of competition and duration is significant in itself and also has interesting consequences for other variables, notably boosting the negative cooeficient for competition and reducing the coefficient for duration. However,  VIF excludes this variable.

Contrary to expectation, consolidation matters more for greater duration contracts. Unfortunately the residuals still show questionable patterns that merit continued observation. 

This combination has a marginal affect on reducing deviance and encounters VIF problems for competition Leaving it out.


### Model 10D: Cons:Ceiling
The next reintroduction is competition and ceiling. Competition and ceiling might have a negative coefficient, because large contracts might encourage bid to win approaches. 
```{r Model10D}


#Sumamry plot
summary_continuous_plot(metric="comp",smp1m,"cl_Ceil","cl_def6_HHI_lag1")
summary_continuous_plot(metric="comp",smp1m,"cl_Ceil","n_Comp")

#Create the model
Comp_Cons_10D <- glm(data=smp,
                       cl_Offr ~cl_def6_HHI_lag1 + 
                         cl_Ceil + cl_Days+
                         Veh+
                         cl_def6_HHI_lag1:cl_Ceil  +
                         n_Fixed + b_UCA +
                         b_Intl +
                         # Veh:cl_Days +
                         # Veh:cl_def6_HHI_lag1+
                         b_UCA:cl_def6_HHI_lag1+
                         NAICS2
                       )
glmer_examine(Comp_Cons_10D)
glmer_examine(Comp_Cons_10D)
  
CBre_Comp_10D<- glm(data=smp,
                       cl_Offr ~n_Comp + 
                         cl_Ceil + cl_Days+
                         Veh+
                          n_Comp:cl_Ceil  +
                         n_Fixed + b_UCA +
                         b_Intl +
                         # Veh:cl_Days +
                         # Veh:n_Comp+
                         b_UCA:n_Comp+
                         NAICS2
                       )



  stargazer::stargazer(Comp_Cons_10B,Comp_Cons_10D,type="text",
                       digits=2)
  
  

summary_regression_compare(Comp_Cons_10B,Comp_Cons_10D)


```
This interaction runs afowl of the VIF test on the competition side. On the consolidation side, there is a significant reduction in deviance, and a reduction in outliers, though in general there remains a fairly strong pattern in the residuals. Leaving it in for consolidation

The interaction went in the expected direction for competition, but is surprisingly powerful. Competition heightens the importance of contract ceiling, and larger contract ceilings mitigate the importance of competition. The other powerful part of this interaction was the dramatic increase in the coefficient for competition and the comparative reduction in the correlation of ceiling. However, the VIF exceeds 2 by  considerable margin, leaving it out.

The weaker expectation was not upheld with consolidation but is significant. Leaving that in for now. May reflect the efficiencies of more utility like sectors with large contracts.



### Model 10E: Cons:Veh
The next reintroduction is competition and vehicle. Multi-award contracts in particular emphasize competition between the awardees which suggests that it may increase the benefits of competition.
Competition occurs more regularly with definitive contracts, multiple award IDCs, GWACs/FSS, and some BPA/BOA. As a result we expect those vehicles that when interacting with competitive contracts to estiamte lower risk of ceiling breach. For consolidation, we expect single award IDCs and perhaps BPA/BOAs, which  are sometime single award, to be highly influenced by consolidation as competition  doesn't occur after initial selection but the overall market dynamic would instead influence whether contracting officers feel pressured to use that mechanism.



```{r Model10E}


#Sumamry plot
summary_discrete_plot(metric="comp",smp1m,"Veh","cl_def6_HHI_lag1")
summary_discrete_plot(metric="comp",smp1m,"Veh","n_Comp")

#Create the model
Comp_Cons_10E <- glm(data=smp,
                       cl_Offr ~cl_def6_HHI_lag1 + 
                         cl_Ceil + cl_Days+
                       cl_def6_HHI_lag1:cl_Ceil+
                                                Veh:cl_def6_HHI_lag1+
                         Veh+
                          #cl_Ceil:cl_Days  +
                         n_Fixed + b_UCA +
                                                b_UCA:cl_def6_HHI_lag1+
                         b_Intl +
                         # Veh:cl_Days +
                         NAICS2
                       )
glmer_examine(Comp_Cons_10E)
glmer_examine(Comp_Cons_10E)
  
CBre_Comp_10E<- glm(data=smp,
                       cl_Offr ~n_Comp + 
                         cl_Ceil + cl_Days+
                         Veh+
                                               Veh:n_Comp+

                         # cl_Ceil:cl_Days  +
                         n_Fixed + b_UCA +
                                               b_UCA:n_Comp+

                         b_Intl +
                         # Veh:cl_Days +
                         NAICS2
                       )



  stargazer::stargazer(Comp_Cons_10D,Comp_Cons_10E,type="text",
                       digits=2)
  
  

summary_regression_compare(Comp_Cons_10D,Comp_Cons_10E)


```


Competition and vehicle results are interesting, but run afowl of VIF test. Consolidation doesn't add much and makes the residualsworse, leaving it  out.

The average plots did show varying relationships and slopes between different types of vehicles. However, 
the coeficient for competition itself remains negative, though not significant, despite the baseline vehicle state, definitive/purchase, having higher termination rates among competed contracts. Given the other interactions, this suggests that this phenomenon is already captured by other inputs and interactions in the dataset. 

Interactions
* For single-award IDVs, competition magnifies the lower termination coeffient. This is somewhat surprising, as competition reflects the competed status of the IDV, not the individual task order. Nonetheless, that rate appears to very much matter, and suggests that uncompeted IDVs lose some of their termination reduction correlation.
* For multiple-award IDVs, competition also dampens the termination rate. This also magnificies the import of duration for multiple-award IDVs, which now can complete overcome the base termination coefficient of the vehicle.
* Competition dampens the termination reduction coefficient for other IDVs. It is not significant, I am tempted to leave it out, though it may be appropriate to always leave in the triples.

Unlike the existance of competition, having more offers does not have the same dramatic relationship with multi-award IDVs that it does with competition. This does raise the question as to whether the long tail of high numbers of offers might be undercutting the relationship. However, for now, we will stick with competition. 

VIF concompetition:vehicle exceeds 2, which necessitates removing it. HHI_lag1 results magnify residuals and run contrary to expectations. The deviation reduction at 30 is good, but not amazing. Leaving it out.
# Econoimc Sector
###Model 04L: Pricing and Average Wage
Fixed Price is less  appropriate as an approach when there is greater uncertainty. A phenomenon likely to extend to time and materials / labor hours contracts. By comparison, fixed price incentive and cost based should estimate a lower risk of ceiling breaches and terminations.

```{r Model04L_Wage}


#Frequency Plot
summary_continuous_plot(metric="comp",smp,"l_Ceil","UCA")

Comp_Cons_04L <- glm (data=smp,
cl_Offr ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   PricingFee + b_UCA +
                   # cl_def6_HHI_lag1:cl_Ceil  +
                 Veh:cl_Days+
                   # Veh:cl_def6_HHI_lag1  +
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  cl_US6_avg_sal_lag1+
  cl_US6_avg_sal_lag1:PricingFee+
  # b_UCA:cl_Ceil+
                b_UCA:cl_def6_HHI_lag1 + 
                  b_UCA:cl_Ceil
                    )
glmer_examine(Comp_Cons_04L)

CBre_Comp_04L <- glm (data=smp,
cl_Offr ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh  +
  PricingFee+ b_UCA +
                 Veh:cl_Days+
                   
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                   
  cl_US6_avg_sal_lag1+
  cl_US6_avg_sal_lag1:PricingFee+
                b_UCA:n_Comp + 
                  b_UCA:cl_Ceil
                    )



#Frequency Plot


Comp_Cons_04L2 <- glm (data=smp,
cl_Offr ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   PricingFee + b_UCA +
                   # cl_def6_HHI_lag1:cl_Ceil  +
                 Veh:cl_Days+
                   # Veh:cl_def6_HHI_lag1  +
                   Veh:cl_Ceil+
  # cl_Ceil:PricingFee+
  cl_US6_avg_sal_lag1+
  cl_US6_avg_sal_lag1:PricingFee+
  # b_UCA:cl_Ceil+
                b_UCA:cl_def6_HHI_lag1 + 
                  b_UCA:cl_Ceil
                    )
glmer_examine(Comp_Cons_04L2)

CBre_Comp_04L2 <- glm (data=smp,
cl_Offr ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh  +
  PricingFee+ b_UCA +
                 Veh:cl_Days+
                   
                   Veh:cl_Ceil+
  # cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                   
  cl_US6_avg_sal_lag1+
  cl_US6_avg_sal_lag1:PricingFee+
                b_UCA:n_Comp + 
                  b_UCA:cl_Ceil
                    )




# Plot the model and Vehicle 
# Term_Comp_04L_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         Comp*x,Days*x) %*%  coef(Term_Comp_04L))}
# 
# #Days curves
# discrete_fitted_term_model(smp,"SIDV") +
#   stat_function(fun = Term_Comp_04L_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1),color="blue")+
#   stat_function(fun = Term_Comp_04L_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1),color="blue")




stargazer::stargazer(Comp_Cons_04L2,
                     type="text",
                       digits=2)
summary_regression_compare(Comp_Cons_04L2,Comp_Cons_04L2)



```



###Model 05B: Fixed Price and Any International

#### Model NCS6D: Interaction Defense to Overall ratio
When there is a larger market available, consolidation may matter less, for better or wrose. Thus interaction of consolidation and ratio will estimate greater magnitude than HHI index on its own. Per the hypothesis, this does not necessarily. 
  
  For competition, the effects may be greatest outside of a monospy context, thus the competition will estimate a lower occurance of ceiling breaches but the interaction of competition and ratio will estimate a higher rate.

```{r ModelNCS6D_Comp}
#Frequency Plot for unlogged ceiling


#Model
Comp_Cons_NCS6D <- glm (data=smp,
                 cl_Offr ~cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_HHI_lag1:cl_def6_ratio_lag1
                 )
glmer_examine(Comp_Cons_NCS6D,display=TRUE)


```
This violates the VIF threshold of 2 and will not be added.



#### Model NCS6F: Interaction of HHI and size
Whether consolidation has positive or negative effets, these should be stronger for larger sectors, as size tends to dilute HHI. The interaction should estimate a significant change in the likelihood of breaches. While the hypothesis allows for both efficiencies and the downsides of monopoly to arrive from consolidation, the study team expects that the interaction with sector size will positively estimate ceiling breaches, as the efficiency may apply just as well in small sectors.
```{r ModelNCS6F_Comp}
#Frequency Plot for unlogged ceiling


#Model
Comp_Cons_NCS6E <- glm (data=smp,
                 cl_Offr ~cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_def6_HHI_lag1:cl_def6_obl_lag1)
glmer_examine(Comp_Cons_NCS6E)


# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted

  stargazer::stargazer(Comp_Cons_NCS6C,Comp_Cons_NCS6D,Comp_Cons_NCS6E,
                       
                       type="text",digits=2)


summary_regression_compare(Comp_Cons_NCS6D,Comp_Cons_NCS6E)



```
Expectations were not uphelped. That said relaxing the assumption that the interaction will result in a higher risk of breaches and just looking at whether it is an effective predictor of a greater magnitude of change, that holds.



#### Model NCS3C: Defense to Overall ratio
When there is a larger market available, consolidation may matter less, for better or wrose. Thus interaction of consolidation and ratio will estimate greater magnitude than HHI index on its own. Per the hypothesis, this does not necessarily. 

For competition, the effects may be greatest outside of a monospy context, thus the competition will estimate a lower occurance of ceiling breaches but the interaction of competition and ratio will estimate a higher rate.

```{r ModelNCS3C_Comp}
#Frequency Plot for unlogged ceiling


#Model
Comp_Cons_NCS3C <- glm (data=smp,
                 cl_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+cl_def3_HHI_lag1:cl_def3_ratio_lag1, 
                 )
glmer_examine(Comp_Cons_NCS3C)

CBre_Comp_NCS3C <- glm (data=smp,
                 cl_Offr ~n_Comp+cl_def3_ratio_lag1+n_Comp:cl_def3_ratio_lag1
                 )
glmer_examine(CBre_Comp_NCS3C)
# 
# #Plot the fitted model plot
# CBre_Comp_03A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_03A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_03A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_03A_curve, 
#                              args=list(Comp=3),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(Comp_Cons_NCS3A,Comp_Cons_NCS3B,Comp_Cons_NCS3C,
                       type="text",
                       digits=2)


summary_regression_compare(Comp_Cons_NCS2B,Comp_Cons_NCS2C)
summary_regression_compare(CBre_Comp_NCS2C,bins=5)


```
Both exceed VIF of 2.



#### Model NCS3E: Interaction of HHI and size
Whether consolidation has positive or negative effets, these should be stronger for larger sectors, as size tends to dilute HHI. The interaction should estimate a significant change in the likelihood of breaches. While the hypothesis allows for both efficiencies and the downsides of monopoly to arrive from consolidation, the study team expects that the interaction with sector size will positively estimate ceiling breaches, as the efficiency may apply just as well in small sectors.
```{r ModelNCS3E_Comp}
#Frequency Plot for unlogged ceiling


#Model
Comp_Cons_NCS3E <- glm (data=smp,
                 cl_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+cl_def3_obl_lag1+cl_def3_HHI_lag1:cl_def3_obl_lag1)
glmer_examine(Comp_Cons_NCS3E)


# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")





#Plot residuals versus fitted
  stargazer::stargazer(Comp_Cons_NCS3C,Comp_Cons_NCS3E,Comp_Cons_NCS6E,
                       type="text",
                       digits=2)

  #Compare to prior at same level
summary_regression_compare(Comp_Cons_NCS3C,Comp_Cons_NCS3E)
summary_regression_compare(Comp_Cons_NCS6E,Comp_Cons_NCS3E)


```
Expectations were not uphelped. Level 3 seems to outperform level 6. Which suggests further exploration is worthwhile. That said, sector size just doesn't add that much to this model relative to level 6.



## Vehicle



###Model 03D: Vehicle and Contract Ceiling
Based on a the descriptive statistics, it appears that the definitive vehicles, multi-award, and FSS/GWACs vary most based on  size. This woud be consistent with the idea that regular reward on these mechanisms might be an important  part of managmening them. By comparison breaking single-award IDCs and the sometimes single-award BPA/BOA into smaller chunks may just not matter to the same degree. Thus the expectation is that  M-IDV, FSS/GWAC, and definitive  (the baseline), will estimate higher risk of ceiling breaches for larger contracts.
```{r Model03D_Comp}

#Frequency Plot
summary_continuous_plot(metric="comp",smp,"l_Ceil","Veh")


#Create the model
Comp_Cons_03D <- glm (data=smp,
                 cl_Offr ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   cl_def6_HHI_lag1:cl_Ceil  + #cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_Ceil)
glmer_examine(Comp_Cons_03D)
glmer_examine(Comp_Cons_03D)

CBre_Comp_03D <- glm (data=smp,
                 cl_Offr ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_def6_HHI_lag1:cl_Ceil  +
                   #cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days  + 
                   Veh:cl_Ceil)

# 
# # Plot the model and Vehicle for SIDV
# CBre_Comp_03D_SIDV_curve<-function(x, Comp,Ceil,Days,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,x,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         Ceil*x,Ceil*MIDV,Ceil*OIDV) %*%  coef(CBre_Comp_03D))}
# 
# #Competition curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_03D_SIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_03D_SIDV_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# CBre_Comp_03D_MIDV_curve<-function(x, Comp,Ceil,Days,SIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,x,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*SIDV,Days*x,Days*OIDV,
#         Comp*SIDV,Comp*x,Comp*OIDV,
#         Ceil*SIDV,Ceil*x,Ceil*OIDV) %*%  coef(CBre_Comp_03D))}
# 
# #Plot the model and Vehicle for MIDV
# #Competition Curves
# fitted_cbre_model(smp,"MIDV") +
#   stat_function(fun = CBre_Comp_03D_MIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_03D_MIDV_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# CBre_Comp_03D_OIDV_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,x,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*SIDV,Days*MIDV,Days*x,
#         Comp*SIDV,Comp*MIDV,Comp*x,
#         Ceil*SIDV,Ceil*MIDV,Ceil*x) %*%  coef(CBre_Comp_03D))}
# 
# #Plot the model and Vehicle for OIDV
# #Competition curves
# fitted_cbre_model(smp,"OIDV") +
#   stat_function(fun = CBre_Comp_03D_OIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=0),color="blue")+
#   stat_function(fun = CBre_Comp_03D_OIDV_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=0),color="blue")
# 




Comp_Cons_03D2 <- glm (data=smp,
                 cl_Offr ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   # cl_def6_HHI_lag1:cl_Ceil  + #cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_Ceil)
glmer_examine(Comp_Cons_03D2)


stargazer::stargazer(Comp_Cons_03B2,Comp_Cons_03D2,
                     type="text",
                       digits=2)
summary_regression_compare(Comp_Cons_03B2,Comp_Cons_03D2)
summary_regression_compare(Comp_Cons_03A,Comp_Cons_03D2)

```

The results are interesting, upholding expectations for definitive award contracts and to a lesser degree for FSS/GWACS, but not for multi-award IDCs. The addition Interestingly, risk for indefinite delivery vehicles seems to depend much more on  duration, whille for definitive contracts ceiling matters most.

VIF for ceiling exceeded 2 for consolidated, and we compared a model with  HHI_lag1:ceiling removed. That reduced devinace and had a mixed effect on residuals, decreasing the magnitude of outliers though slighty throwing off the  highest risk predictions.


###Model 04F: Fixed-Price and Vehicle


```{r Model04F_Comp}

#Frequency Plot
summary_discrete_plot(metric="comp",smp,"FxCb","Veh")

#Create the model

#Create the model
Comp_Cons_04F <- glm (data=smp,
                 cl_Offr ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   # cl_def6_HHI_lag1:cl_Ceil  + #cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_Ceil+
                FxCb+FxCb:Veh)
glmer_examine(Comp_Cons_04F)

CBre_Comp_04F <- glm (data=smp,
                 cl_Offr ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   FxCb +
                   #cl_def6_HHI_lag1:cl_Ceil  + 
                 Veh:cl_Days+
                   Veh:cl_Ceil+
                   FxCb:Veh,
                 )

# Plot the model and Vehicle for SIDV
# CBre_Comp_04F_curve<-function(x, Comp,Ceil,Days,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         n_Fixed,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*SIDV,Days*MIDV,Days*OIDV,
#         Comp*SIDV,Comp*MIDV,Comp*OIDV,
#         x*SIDV,x*MIDV,x*OIDV
#         ) %*%  coef(CBre_Comp_04F))}
# 
# #Vehicle curves
# fitted_cbre_model(smp,"n_Fixed") +
#   stat_function(fun = CBre_Comp_04F_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=1,MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_04F_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=1,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_04F_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=0,OIDV=1),color="blue")
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_cbre_residuals(CBre_Comp_04F)
# 
# #Plot residuals versus fittedO
# residuals_cbre_plot(CBre_Comp_04F)+
#   labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot("cl_days")+
#   labs(x="Centered Log(Days)")
stargazer::stargazer(Comp_Cons_04C,Comp_Cons_04F,
                     type="text",
                       digits=2)
summary_regression_compare(Comp_Cons_04C,Comp_Cons_04F)

```
The interactions are not significant and do little to reduce the residual deviance. They will not be added to the model. They exceed VIF of 2 in both cases.

###Model 05C: Vehicle and Any International
Mechanisms like multi-award IDCs and GWAC/FSS use a known pool of contractors but still incorporate competition. Multi-award was emphasized in part after earlier scandals as preferable to single-award IDCs. Thus multi-award IDCs, and perhaps other vehicles that offer task order competition, is expected to estimate a lower rate of ceiling breaches. 


```{r Model05C}

#Frequency Plot
summary_discrete_plot(metric="comp",smp,"Intl","Veh")



#Create the model
Comp_Cons_05C <- glm (data=smp,
                      cl_Offr ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        # cl_def6_HHI_lag1:cl_Ceil  +
                        Veh:cl_Days+
                        # Veh:cl_def6_HHI_lag1  +
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        # b_UCA:cl_Ceil+
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh
                      )
glmer_examine(Comp_Cons_05C)

CBre_Comp_05C <- glm (data=smp,
                      cl_Offr ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        # b_UCA:cl_Ceil+
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh 
                      )




# # Plot the model and Vehicle 
# Term_Comp_05C_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,UCA,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         UCA*Comp) %*%  coef(Term_Comp_05C))}
# 
# #Days curves
# discrete_fitted_term_model(smp,"SIDV") +
#   stat_function(fun = Term_Comp_05C_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1,UCA=0),color="blue")+
#   stat_function(fun = Term_Comp_05C_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1,UCA=0),color="blue")
# 
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_residuals(Term_Comp_05C)
# 
# #Plot residuals versus fittedO
# residuals_term_plot(Term_Comp_05C)+
#   labs(x="Estimated  Pr (Termination)")

# residuals_term_plot(Term_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")
stargazer::stargazer(Comp_Cons_05A,Comp_Cons_05C,
                     type="text",
                       digits=2)
summary_regression_compare(Comp_Cons_05A,Comp_Cons_05C)

```



## Pricing





###Model 04E: Fixed-Price and Base Duration
Past CSIS research has found that fixed-price contracts do appear to be at higher risk if they have a longer maximum duration. This may mean they 

Time&Materials/Labor Hours/Fixed-Price Level of Effort are typically used for smaller projects, but may not scale as well for longer lasting projects. 
```{r Model04E_Comp}

#Frequency Plot
summary_continuous_plot(metric="comp",smp,"l_Days","PricingFee")

#Create the model
Comp_Cons_04E <- glm (data=smp,
                 cl_Offr ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   # cl_def6_HHI_lag1:cl_Ceil  + #cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_Ceil+
                PricingFee+
                   cl_Days:PricingFee)
glmer_examine(Comp_Cons_04E)
glmer_examine(Comp_Cons_04E)

CBre_Comp_04E <- glm (data=smp,
                 cl_Offr ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_def6_HHI_lag1:cl_Ceil  + 
                 Veh:cl_Days+
                   
                   Veh:cl_Ceil+
                                      PricingFee +
                   cl_Days:PricingFee , 
                 )



# Plot the model and Vehicle 
# CBre_Comp_04E_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         Days*x) %*%  coef(CBre_Comp_04E))}

# #Days curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_04E_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_04E_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_cbre_residuals(CBre_Comp_04E)
# 
# #Plot residuals versus fittedO
# residuals_cbre_plot(CBre_Comp_04E)+
#   labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot("cl_days")+
#   labs(x="Centered Log(Days)")


Comp_Cons_04E2 <- glm (data=smp,
                 cl_Offr ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   # cl_def6_HHI_lag1:cl_Ceil  + #cl_def6_HHI_lag1:cl_Days +
                 # Veh:cl_Days+
                   Veh:cl_Ceil+
                PricingFee+
                   cl_Days:PricingFee)
glmer_examine(Comp_Cons_04E2)
glmer_examine(Comp_Cons_04E2)

CBre_Comp_04E2 <- glm (data=smp,
                 cl_Offr ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_def6_HHI_lag1:cl_Ceil  + 
                 # Veh:cl_Days+
                   
                   Veh:cl_Ceil+
                                      PricingFee +
                   cl_Days:PricingFee , 
                 )


stargazer::stargazer(Comp_Cons_04C,Comp_Cons_04E2,
                     type="text",
                       digits=2)
summary_regression_compare(Comp_Cons_04C,Comp_Cons_04E2)

```
The probability of termination by duration chart is more clearcut with fixed price than with cost-based contracts. However, the variable does not appreciably decrease the deviation, is not significant, and undercuts the significance of other variables. It will not be added tto the model.




###Model 04G: Fixed-Price and Ceiling
Past CSIS research has found that fixed-price contracts do appear to be at higher risk if they have a longer maximum duration. Fixed-price contracting does require upfront estimation of likely costs, and thus a higher ceiling does often mean higher risk.

Time&Materials/Labor Hours/Fixed-Price Level of Effort are typically used for smaller projects, but may not scale as well for large contracts.

Incentive fees, in theory, should do a estimate lower ceiling breaches as they incentive cost savings and are more oriented towards large projects.

```{r Model04G_Comp}

#Frequency Plot
summary_continuous_plot(metric="comp",smp,"l_Ceil","PricingFee")

#Create the model
Comp_Cons_04G <- glm (data=smp,
                 cl_Offr ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   # cl_def6_HHI_lag1:cl_Ceil  + #cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_Ceil+
                PricingFee+
                   cl_Ceil:PricingFee)
glmer_examine(Comp_Cons_04G)
glmer_examine(Comp_Cons_04G)

CBre_Comp_04G <- glm (data=smp,
                 cl_Offr ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_def6_HHI_lag1:cl_Ceil  + 
                 Veh:cl_Days+
                   Veh:cl_Ceil+
                                      PricingFee +
                   cl_Ceil:PricingFee , 
                 )



# Plot the model and Vehicle 
# CBre_Comp_04G_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         Days*x) %*%  coef(CBre_Comp_04G))}

# #Days curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_04G_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_04G_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_cbre_residuals(CBre_Comp_04G)
# 
# #Plot residuals versus fittedO
# residuals_cbre_plot(CBre_Comp_04G)+
#   labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot("cl_days")+
#   labs(x="Centered Log(Days)")


stargazer::stargazer(Comp_Cons_04C,Comp_Cons_04G,
                     type="text",
                       digits=2)
summary_regression_compare(Comp_Cons_04C,Comp_Cons_04G)

```



###Model 04J: UCA and Duration

While duration tracks the base duration and not the length spent in UCA, nonetheless longer length should estimate a higher probability of breach.
```{r Model04K_Term}


#Frequency Plot
summary_continuous_plot(metric="comp",smp,"l_Days","UCA")

Comp_Cons_04J <- glm (data=smp,
cl_Offr ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   PricingFee + b_UCA +
                   # cl_def6_HHI_lag1:cl_Ceil  +
                 Veh:cl_Days+
                   # Veh:cl_def6_HHI_lag1  +
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                b_UCA:cl_def6_HHI_lag1 + 
                  b_UCA:l_Days
                    )
glmer_examine(Comp_Cons_04J)

CBre_Comp_04J <- glm (data=smp,
cl_Offr ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh  +
  PricingFee+ b_UCA +
                 Veh:cl_Days+
                   
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                   
                b_UCA:n_Comp + 
                  b_UCA:l_Days
                    )





# Plot the model and Vehicle 
# Term_Comp_04J_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         Comp*x,Days*x) %*%  coef(Term_Comp_04J))}
# 
# #Days curves
# discrete_fitted_term_model(smp,"SIDV") +
#   stat_function(fun = Term_Comp_04J_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1),color="blue")+
#   stat_function(fun = Term_Comp_04J_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1),color="blue")

Comp_Cons_04J2 <- glm (data=smp,
cl_Offr ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   PricingFee + b_UCA +
                   # cl_def6_HHI_lag1:cl_Ceil  +
                 # Veh:cl_Days+
                   # Veh:cl_def6_HHI_lag1  +
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                b_UCA:cl_def6_HHI_lag1 + 
                  b_UCA:l_Days
                    )
glmer_examine(Comp_Cons_04J2)

CBre_Comp_04J2 <- glm (data=smp,
cl_Offr ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh  +
  PricingFee+ b_UCA +
                 # Veh:cl_Days+
                   
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                   
                b_UCA:n_Comp + 
                  b_UCA:l_Days
                    )




stargazer::stargazer(Comp_Cons_04I,Comp_Cons_04J2,
                     type="text",
                       digits=2)
summary_regression_compare(Comp_Cons_04I,Comp_Cons_04J2)



```

UCA:l_Days violates VIF even with removal of other da 

###Model 04K: UCA and Ceiling

Here the possible risk is similar to days, that larger, and thus possibly more complex projects, are at greater risk with UCA and that UCA and high ceiling estimate a higher chance of breaches.
```{r Model04K_Term}


#Frequency Plot
summary_continuous_plot(metric="comp",smp,"l_Ceil","UCA")

Comp_Cons_04K <- glm (data=smp,
cl_Offr ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   PricingFee + b_UCA +
                   # cl_def6_HHI_lag1:cl_Ceil  +
                 Veh:cl_Days+
                   # Veh:cl_def6_HHI_lag1  +
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                b_UCA:cl_def6_HHI_lag1 + 
                  b_UCA:cl_Ceil
                    )
glmer_examine(Comp_Cons_04K)

CBre_Comp_04K <- glm (data=smp,
cl_Offr ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh  +
  PricingFee+ b_UCA +
                 Veh:cl_Days+
                   
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                   
                b_UCA:n_Comp + 
                  b_UCA:cl_Ceil
                    )





# Plot the model and Vehicle 
# Term_Comp_04K_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         Comp*x,Days*x) %*%  coef(Term_Comp_04K))}
# 
# #Days curves
# discrete_fitted_term_model(smp,"SIDV") +
#   stat_function(fun = Term_Comp_04K_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1),color="blue")+
#   stat_function(fun = Term_Comp_04K_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1),color="blue")

Comp_Cons_04K2 <- glm (data=smp,
cl_Offr ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   PricingFee + b_UCA +
                   # cl_def6_HHI_lag1:cl_Ceil  +
                 # Veh:cl_Days+
                   # Veh:cl_def6_HHI_lag1  +
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                b_UCA:cl_def6_HHI_lag1 + 
                  b_UCA:l_Days
                    )
glmer_examine(Comp_Cons_04K2)

CBre_Comp_04K2 <- glm (data=smp,
cl_Offr ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh  +
  PricingFee+ b_UCA +
                 # Veh:cl_Days+
                   
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                   
                b_UCA:n_Comp + 
                  b_UCA:l_Days
                    )




stargazer::stargazer(Comp_Cons_04I,Comp_Cons_04K,
                     type="text",
                       digits=2)
summary_regression_compare(Comp_Cons_04I,Comp_Cons_04K)



```
The results are counter-intuitive but strong. Based on the descriptive statistics it appears that  mid-range, not the largest UCAs, have the great risk of breaches.



Firm fixed price contracts and to a less degree other fixed-price contracts and time and materials/labor hours/fixed price level of effort contracts may be more vulnerable to changing conditions internationally. Thus they may estimate a higher rate of ceiling breaches.
```{r Model05cl_Offr}

#Frequency Plot
summary_discrete_plot(metric="comp",smp,"Intl","PricingFee")



#Create the model
Comp_Cons_05B <- glm (data=smp,
cl_Offr ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   PricingFee + b_UCA +
  b_Intl+
                   # cl_def6_HHI_lag1:cl_Ceil  +
                 Veh:cl_Days+
                   # Veh:cl_def6_HHI_lag1  +
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                b_UCA:cl_def6_HHI_lag1 + 
                  b_UCA:cl_Ceil+
  
  b_Intl:PricingFee
                    )
glmer_examine(Comp_Cons_05B)

CBre_Comp_05B <- glm (data=smp,
cl_Offr ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh  +
  PricingFee+ b_UCA +
  b_Intl+
                 Veh:cl_Days+
                   
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                   
                b_UCA:n_Comp + 
                  b_UCA:cl_Ceil+
  
  b_Intl:PricingFee
                    )


# Plot the model and Vehicle 
# CBre_Comp_05B_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,UCA,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         UCA*Comp) %*%  coef(CBre_Comp_05B))}
# 
# #Days curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_05B_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1,UCA=0),color="blue")+
#   stat_function(fun = CBre_Comp_05B_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1,UCA=0),color="blue")


stargazer::stargazer(Comp_Cons_05A,Comp_Cons_05B,
                     type="text",
                       digits=2)
summary_regression_compare(Comp_Cons_05A,Comp_Cons_05B)



```
Due in part to small sample sizes, the results were fairly extreme, including a coefficient of -11 for other fixed price. They also did not reduce model deviance by much and ran contrary to hypotheses. Leaving this out.





#Multi-Level Model
##   NAICS2 & Agency

### Model 11A: No interactions
This model runs comparatively fast because it only deals in the agency and NAICS2, the broadest categories. The study team initially feared that only this level of analysis might work when it comes to avoiding convergence errors, but subsequent research ( https://rdrr.io/cran/lme4/man/convergence.html ) revealed that large datasets can be a source of false positive warnings.
```{r Model11A}
#Frequency Plot
summary_discrete_plot(metric="comp",smp,"NAICS2")

#This is currently running at home

Comp_Cons_11A <- glmer (data=smp,
                        cl_Offr ~cl_def6_HHI_lag1 +cl_def6_ratio_lag1+cl_def6_obl_lag1+
                          cl_US6_avg_sal_lag1+
                          cl_Ceil + cl_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                          # cl_def6_HHI_lag1:cl_Ceil  +
                          # Veh:cl_def6_HHI_lag1  +
                          # cl_def6_HHI_lag1:cl_def6_obl_lag1+ 
                          # b_UCA:cl_def6_HHI_lag1 + 
                          # b_UCA:cl_Ceil+

                          (1 | NAICS2) + (1 | Agency)
                        
                        ,
                        verbose=1)

glmer_examine(Comp_Cons_11A)

CBre_Comp_11A <- glmer (data=smp,
                      cl_Offr ~n_Comp +
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        cl_Ceil + cl_Days+
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                    
                        # b_UCA:n_Comp +
                        # b_UCA:cl_Ceil+

                   (1 | NAICS2) + (1 | Agency)

                   ,
                  verbose=1)




any(diag.vals<1e-6)
CBre_Comp_11A.devfun<-devfun
if(!exists("CBre_Comp_11A.devfun"))
  CBre_Comp_11A.devfun <- update(CBre_Comp_11A, devFunOnly=TRUE)

if (isLMM(CBre_Comp_11A)) {
  pars <- getME(CBre_Comp_11A,"theta")
} else {
  ## GLMM: requires both random and fixed parameters
  pars <- getME(CBre_Comp_11A, c("theta","fixef"))
}
if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Comp_11A.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Comp_11A.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Comp_11A@optinfo$derivs

if(!exists("CBre_Comp_11A.restart"))
  CBre_Comp_11A.restart <- update(CBre_Comp_11A, start=pars)
glmer_examine(CBre_Comp_11A.restart)



stargazer::stargazer(Comp_Cons_11A,CBre_Comp_11A.restart,CBre_Comp_11A.restart
                     ,type="text",
                       digits=2)

summary_regression_compare(Comp_Cons_07B2,Comp_Cons_11A)
Comp_Cons_11A<-Comp_Cons_14A
CBre_Comp_11A<-CBre_Comp_14A
CBre_Comp_11A.restart<-CBre_Comp_14A.restart
CBre_Comp_11A.devfun<-CBre_Comp_14A.devfun
summary_regression_compare(Comp_Cons_11A,Comp_Cons_11A,CBre_Comp_11A.restart)
save(Comp_Cons_11A,CBre_Comp_11A.restart,CBre_Comp_11A.devfun,CBre_Comp_11A.restart,file="output/CBre_11.rdata")

```


#### Model NCS5E: Interaction of HHI and size
Whether consolidation has positive or negative effets, these should be stronger for larger sectors, as size tends to dilute HHI. The interaction should estimate a significant change in the likelihood of breaches. While the hypothesis allows for both efficiencies and the downsides of monopoly to arrive from consolidation, the study team expects that the interaction with sector size will positively estimate ceiling breaches, as the efficiency may apply just as well in small sectors.
```{r ModelNCS5E_Comp}
#Frequency Plot for unlogged ceiling

#Model
Comp_Cons_NCS5E <- glm (data=smp,
                 cl_Offr ~cl_def5_HHI_lag1+cl_def5_ratio_lag1+cl_def5_obl_lag1+
                   cl_def5_HHI_lag1:cl_def5_obl_lag1)
glmer_examine(Comp_Cons_NCS5E)


# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(Comp_Cons_NCS5C,Comp_Cons_NCS5E,Comp_Cons_NCS6E,
                       type="text",
                       digits=2)

  #Compare to prior at same level
summary_regression_compare(Comp_Cons_NCS5C,Comp_Cons_NCS5E)
summary_regression_compare(Comp_Cons_NCS6E,Comp_Cons_NCS5E)


```
Expectations were not uphelped. The interaction appears to badly misjudge some contracts at the estimated low risk of the scale, although deviance for other estimates reduces. Level 5 seems on the whole to be less effective an estimator than level 6.

## Agency/Office & NAICS6

### Model 12B: Trimmed 
```{r Model12B}
#Frequency Plot
summary_discrete_plot(metric="comp",smp,"NAICS")

#This is currently running at home

Comp_Cons_12B <- glmer (data=smp,
                        cl_Offr ~cl_def6_HHI_lag1 +cl_def6_ratio_lag1+cl_def6_obl_lag1+
                          cl_US6_avg_sal_lag1+
                          cl_Ceil + cl_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                          # cl_def6_HHI_lag1:cl_Ceil  +
                          # Veh:cl_def6_HHI_lag1  +
                          cl_def6_HHI_lag1:cl_def6_obl_lag1+ 
                          b_UCA:cl_def6_HHI_lag1 + 
                          b_UCA:cl_Ceil+

                          (1 | NAICS) + (1 | Agency/Office)
                        
                        ,
                        verbose=1)

glmer_examine(Comp_Cons_12B)

CBre_Comp_12B <- glmer (data=smp,
                      cl_Offr ~n_Comp +
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        cl_Ceil + cl_Days+
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                    
                        b_UCA:n_Comp +
                        b_UCA:cl_Ceil+

                   (1 | NAICS) + (1 | Agency/Office)

                   ,
                  verbose=1)



summary_regression_compare(Comp_Cons_07B2,Comp_Cons_12B)
```

## Agency/Office & NAICS3/6

###Model 13B: Agency/Office+NAICS6/NAICS3 trimmed
```{r Model13B}

Comp_Cons_13B <- glmer (data=smp,
                 cl_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                  #cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                  cl_US6_avg_sal_lag1+cl_def6_HHI_lag1:cl_def6_obl_lag1+
                                                cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                   
                        # cl_def6_HHI_lag1:cl_Ceil  +
                        # Veh:cl_def6_HHI_lag1  +
                        
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        # 6
                         
                        (1 | NAICS3/NAICS) + 
                        (1 | Agency/Office) 

                      ,
                        verbose=1)


glmer_examine(Comp_Cons_13B)

save(Comp_Cons_13B,file="Output//Comp_Cons_13B.rdata")
CBre_Comp_13B <- glmer (data=smp,
                        cl_Offr ~n_Comp+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                   n_Comp+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        cl_Ceil + cl_Days+
                        Veh  +
                        PricingFee+
                        b_UCA +
                        b_Intl+
                        
                        
                        
                        b_UCA:n_Comp +
                        b_UCA:cl_Ceil+
                        
                        (1 | NAICS) + (1 | Agency/Office)
                   # Who+
                   # NAICS2
                      ,
                        verbose=1)

save(Comp_Cons_13B,file="Output//Comp_Cons_13B.rdata")
```

