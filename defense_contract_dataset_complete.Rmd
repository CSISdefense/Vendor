---
title: "Defense Contract Dataset Complete"
author: "Greg Sanders"
date: "Monday, March 23, 2015"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
#*************************************Required Libraries******************************************
require(dplyr)
require(grid)
require(reshape2)
require(stringr)
require(ggplot2)
library(Hmisc)
library(readr)
#*************************************Options*****************************************************
options(error=recover)
options(warn=1)

#*************************************Lookup Files*****************************************************

Path<-"https://github.com/CSISdefense/R-scripts-and-data/blob/master/"
# Path<-"K:\\2007-01 PROFESSIONAL SERVICES\\R scripts and data\\"
# Path<-"~\\FPDS\\R scripts and data\\"
# Path<-"C:\\Users\\Greg Sanders\\SkyDrive\\Documents\\R Scripts and Data SkyDrive\\"
source("ContractCleanup.r")
source("https://raw.githubusercontent.com/CSISdefense/R-scripts-and-data/master/lookups.r")
source("https://raw.githubusercontent.com/CSISdefense/R-scripts-and-data/master/helper.r")

```

#Combining Source Files
##Sample Criteria
```{r DetailCustomer}
if(!is.null(def_full)){
def_full <-readr::read_delim(
  "Data\\\contract.SP_ContractSampleCriteriaDetailsCustomer.txt",
  col_names=TRUE, 
  delim=",",
  # , dec=".",
  trim_ws=TRUE,
  na=c("NULL","NA")
  # stringsAsFactors=FALSE
)
} else{
  def_full<-csis360::read_and_join_experiment(data=def_full
  ,"contract_SP_ContractSampleCriteriaDetailsCustomer.txt"
  ,path=""
  ,"Data\\"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
)
}

def_full<-csis360::standardize_variable_names(def_full)


#Limit to completed contracts that start in 2007 or later
def_full$LastCurrentCompletionDate<-strptime(def_full$LastCurrentCompletionDate,"%Y-%m-%d") 
#Drop contracts starting before the study period and not clearly end within it
def_full<-subset(def_full, StartFiscal_Year>=2007   &
    (LastCurrentCompletionDate<="2015-09-30" | IsClosed==1)
)

if(is.numeric(def_full$Term)){
    def_full$Term<-factor(def_full$Term,
                                levels = c(0,1),
                                labels = c("Unterminated", "Terminated")
    )
}

# def_full<-subset(def_full,select=-c(StartFiscal_Year
# ,IsClosed
# ,LastSignedLastDateToOrder
#                                                       ,LastUltimateCompletionDate
# ))


def_full<-def_full[,!colnames(def_full) %in% 
    c(
      # "StartFiscal_Year",
      # "SumofObligatedAmount",
    # "IsClosed"             ,
    "LastSignedLastDateToOrder",
     "LastUltimateCompletionDate",
    # "LastCurrentCompletionDate",
    # "MinOfSignedDate",
    # "MinOfEffectiveDate",
"UnmodifiedContractObligatedAmount.1",
"UnmodifiedContractBaseAndExercisedOptionsValue.1",
"UnmodifiedContractBaseAndAllOptionsValue.2"
    )]
save(file="Data\\Federal_contract_CSIScontractID_complete.Rdata",def_full)


```


##Initial Scope
```{r Scope}
# load(file="Data\\Federal_contract_CSIScontractID_complete.Rdata")

def_full<-csis360::read_and_join_experiment(data=def_full
  ,"Contract.SP_ContractUnmodifiedAndOutcomeDetailsCustomer.txt"
  ,path=""
  ,"Data\\"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
)


def_all<-input_initial_scope(def_all,
                             file="Contract.SP_ContractUnmodifiedAndOutcomeDetailsCustomer2017.txt",
                             )

# 
# def_full<-csis360::standardize_variable_names(def_full)
# 
# 
# def_full$UnmodifiedCurrentCompletionDate<-
#   strptime(def_full$UnmodifiedCurrentCompletionDate,"%Y-%m-%d") 
# 
# #Calculate the number of days the contract lasts.
# def_full$UnmodifiedDays<-as.numeric(
#   difftime(strptime(def_full$UnmodifiedCurrentCompletionDate,"%Y-%m-%d")
#     , strptime(def_full$MinOfEffectiveDate,"%Y-%m-%d")
#     , unit="days"
#   ))+1
# 
# # 
# # CDuration<-as.duration(strptime(def_full$UnmodifiedCurrentCompletionDate,"%Y-%m-%d")-
# #                 strptime(def_full$MinOfEffectiveDate,"%Y-%m-%d"))
# # 
# # CPeriod<-as.period(
# #     CInterval<-new_interval(ymd(def_full$UnmodifiedCurrentCompletionDate),
# #                 ymd(def_full$MinOfEffectiveDate))
# # 
# # 
# # 
# # summary(dYears)
# 
# #Break the count of days into four categories.
# def_full$qDuration<-cut2(def_full$UnmodifiedDays,cuts=c(61,214,366,732))
# 
# 
# 
# 
# 
# if (levels(def_full$qDuration)[[2]]=="[   61,  214)"){
#   def_full$qDuration<-factor(def_full$qDuration, 
#     
#     levels=c("[    0,   61)",
#       "[   61,  214)",
#       "[  214,  366)",
#       "[  366,  732)",
#       "[  732,33192]"),
#     labels=c("[0 months,~2 months)",
#       "[~2 months,~7 months)",
#       "[~7 months-~1 year]",
#       "(~1 year,~2 years]",
#       "(~2 years+]"),
#     ordered=TRUE
#   )
# }
# 
# 
# lowroundedcutoffs<-c(15000,100000,1000000,30000000)
# highroundedcutoffs<-c(15000,100000,1000000,10000000,75000000)
# def_full$qLowCeiling <- cut2(def_full$UnmodifiedContractBaseAndAllOptionsValue,cuts=lowroundedcutoffs)
# def_full$qHighCeiling <- cut2(def_full$UnmodifiedContractBaseAndAllOptionsValue,cuts=highroundedcutoffs)
# rm(lowroundedcutoffs,highroundedcutoffs)
# 
# 
# 
# 
# if (all(levels(def_full$qHighCeiling)==c("[0.00e+00,1.50e+04)",
#   "[1.50e+04,1.00e+05)",
#   "[1.00e+05,1.00e+06)",
#   "[1.00e+06,1.00e+07)",
#   "[1.00e+07,7.50e+07)",
#   "[7.50e+07,3.36e+12]"))){
#   def_full$qHighCeiling<-factor(def_full$qHighCeiling, 
#     
#     levels=c("[0.00e+00,1.50e+04)",
#       "[1.50e+04,1.00e+05)",
#       "[1.00e+05,1.00e+06)",
#       "[1.00e+06,1.00e+07)",
#       "[1.00e+07,7.50e+07)",
#       "[7.50e+07,3.36e+12]"),
#     labels=c("[0,15k)",
#       "[15k,100k)",
#       "[100k,1m)",
#       "[1m,10m)",
#       "[10m,75m)",
#       "[75m+]"),
#     ordered=TRUE
#   )
# }
# 
# if (all(levels(def_full$qLowCeiling)==c("[0.00e+00,1.50e+04)",
#   "[1.50e+04,1.00e+05)",
#   "[1.00e+05,1.00e+06)",
#   "[1.00e+06,3.00e+07)",
#   "[3.00e+07,3.36e+12]"))){
#   def_full$qLowCeiling<-factor(def_full$qLowCeiling, 
#     
#     levels=c("[0.00e+00,1.50e+04)",
#       "[1.50e+04,1.00e+05)",
#       "[1.00e+05,1.00e+06)",
#       "[1.00e+06,3.00e+07)",
#       "[3.00e+07,3.36e+12]"),
#     labels=c("[0,15k)",
#       "[15k,100k)",
#       "[100k,1m)",
#       "[1m,30m)",
#       "[30m+]"),
#     ordered=TRUE
#   )
# }
# 
# 
# 
# 
# 
# 
# summary(subset(def_full$qCRais,def_full$SumOfisChangeOrder>0    ))
# 
# def_full<-def_full[,!colnames(def_full) %in% 
#     c(
#   #     UnmodifiedDays,
#       # UnmodifiedCurrentCompletionDate
#       # "MinOfEffectiveDate",
#   "LastUltimateCompletionDate"
#     )]

save(file="Data\\Federal_contract_CSIScontractID_complete.Rdata",def_full)
```

## ContractingDelta
```{r ContractingDelta}
# load(file="Data\\Federal_contract_CSIScontractID_complete.Rdata")

def_full<-csis360::read_and_join_experiment(def_full,
  "contract_SP_ContractModificationDeltaCustomer.csv",
  "",
  "Data\\",
  by="CSIScontractID",
  new_var_checked=FALSE
)

def_full<-csis360::standardize_variable_names(def_full)

def_full$ChangeOrderObligatedAmount<-FactorToNumber(def_full$ChangeOrderObligatedAmount)
def_full$ChangeOrderBaseAndAllOptionsValue<-FactorToNumber(def_full$ChangeOrderBaseAndAllOptionsValue)



def_full$qNChg <- cut2(def_full$SumOfisChangeOrder,c(1,2,3))


# def_full$pChangeOrderObligated<-def_full$ChangeOrderObligatedAmount/
#   def_full$Action.Obligation
# def_full$pChangeOrderObligated[is.na(def_full$pChangeOrderObligated)&
#     def_full$SumOfisChangeOrder==0]<-0
def_full$pChangeOrderUnmodifiedBaseAndAll<-def_full$ChangeOrderBaseAndAllOptionsValue/
  def_full$UnmodifiedContractBaseAndAllOptionsValue
def_full$pChangeOrderUnmodifiedBaseAndAll[
  is.na(def_full$pChangeOrderUnmodifiedBaseAndAll) & def_full$SumOfisChangeOrder==0]<-0

#Boolean value for ceiling breaches
#Safety measure to make sure we don't assume it's never NA.
def_full$CBre <- NA
def_full$CBre[!is.na(def_full$SumOfisChangeOrder)] <- "None"
def_full$CBre[def_full$ChangeOrderBaseAndAllOptionsValue > 0
              & def_full$SumOfisChangeOrder>0] <- "Ceiling Breach"
def_full$CBre<-ordered(def_full$CBre,levels=c("None","Ceiling Breach"))


def_full$qCRais <- cut2(
  def_full$pChangeOrderUnmodifiedBaseAndAll,c(
    -0.001,
    0.001,
    0.15)
)
#                                               min(subset(
#                                                   def_full$pChangeOrderObligated,
#                                                   def_full$pChangeOrderObligated>0)),

def_full<-def_full[,!colnames(def_full) %in% 
    c(
    "ChangeOrderObligatedAmount"             ,
    "ChangeOrderBaseAndExercisedOptionsValue",
#     ChangeOrderBaseAndAllOptionsValue      ,
    "NewWorkObligatedAmount",
    "NewWorkBaseAndExercisedOptionsValue"    ,
    # "NewWorkBaseAndAllOptionsValue",
# "SumOfisChangeOrder",
"MaxOfisChangeOrder",
# "SumOfisNewWork"
"MaxOfisNewWork"
    )]

save(file="Data\\Federal_contract_CSIScontractID_complete.Rdata",def_full)
```
##Location
```{r Location}
# load(file="Data\\Federal_contract_CSIScontractID_complete.Rdata")

def_full<-csis360::read_and_join_experiment(def_full,
    "Contract.SP_ContractLocationCustomer.txt"
  ,path=""
  ,dir="Data\\"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
  # ,zip_file="Contract.SP_ContractLocationCustomer.zip"
)

def_full<-csis360::standardize_variable_names(def_full)



# def_full$pIsInternational<-
#   as.double(def_full$ObligatedAmountPlaceIsInternational)/
#   as.double(def_full$Action.Obligation)
# length(def_full$pIsInternational[
#   # is.na(def_full$pIsInternational)&
#     def_full$PlaceIsInternational==1
# ])<-0
# summary(def_full$pIsInternational)
# summary(def_full$PlaceIsInternational)
# summary(subset(def_full,is.finite(pIsInternational)))
# 
# ggplot(def_full, aes(x=ObligatedAmountPlaceIsInternational))+geom_histogram()

# summary(def_full$ObligatedAmountPlaceIsInternational)
# summary(def_full$PlaceIsInternational)

def_full$AnyPlaceInternational[is.na(def_full$PlaceIsInternational) &
    is.na(def_full$UnmodifiedPlaceIsInternational)]<-NA

summary(def_full$AnyPlaceInternational)
summary(def_full$PlaceIsInternational)
summary(def_full$UnmodifiedPlaceIsInternational)
summary(factor(def_full$PlaceCountryISO3))
summary(factor(def_full$UnmodifiedPlaceCountryISO3))


if(is.numeric(def_full$AnyPlaceInternational)){
  def_full$AnyPlaceInternational<-factor(def_full$AnyPlaceInternational,
    exclude=NULL,
    levels=c(0,1,NA),
    labels=c("Just U.S.","Any International",NA)
  )
}

summary(def_full$AnyPlaceInternational)
def_full$UnmodifiedPlaceCountryISO3[is.na(def_full$UnmodifiedPlaceCountryISO3)]<-
  def_full$PlaceCountryISO3[is.na(def_full$UnmodifiedPlaceCountryISO3)]
def_full$UnmodifiedPlaceCountryISO3<-factor(def_full$UnmodifiedPlaceCountryISO3)



def_full<-def_full[,!colnames(def_full) %in% 
    c(
  # "PlaceCountryISO3",
  # "UnmodifiedPlaceCountryISO3",
  "ObligatedAmountPlaceIsInternational"     ,
   # "AnyPlaceInternational",
  "PlaceIsInternational"  ,
  "UnmodifiedPlaceIsInternational",
   "VendorCountryISO3",
  "UnmodifiedVendorCountryISO3" ,
  "ObligatedAmountVendorIsInternational"  ,
   "AnyVendorInternational",
  "VendorIsInternational",
  "UnmodifiedVendorIsInternational"         ,
   "OriginCountryISO3",
  "UnmodifiedOriginCountryISO3",
  "ObligatedAmountOriginIsInternational"    ,
   "AnyOriginInternational",
  "OriginIsInternational",
  "UnmodifiedOriginIsInternational" ,
  "pIsInternational" #This just isn't working
    )]


save(file="Data\\Federal_contract_CSIScontractID_complete.Rdata",def_full)


```


##BucketPlatform
```{r BucketPlatform}
# load(file="Data\\Federal_contract_CSIScontractID_complete.Rdata")
#Note to identify is.defense here.
def_full<-csis360::read_and_join_experiment(data=def_full
  ,"Contract_SP_ContractBucketPlatformCustomer.txt"
  ,path=""
  ,"Data\\"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
)
# 
# def_full$ObligatedAmountIsProducts<-FactorToNumber(def_full$ObligatedAmountIsProducts)
# 
# def_full$ObligatedAmountIsServices<-FactorToNumber(def_full$ObligatedAmountIsServices)
# 
# def_full$ObligatedAmountIsRnD<-FactorToNumber(def_full$ObligatedAmountIsRnD)
# 
# def_full$pIsProducts <- def_full$ObligatedAmountIsProducts/def_full$Action.Obligation
# def_full$pIsProducts[is.na(def_full$ObligatedAmountIsProducts)] <- 0
# 
# def_full$pIsServices <- def_full$ObligatedAmountIsServices/def_full$Action.Obligation
# def_full$pIsServices[is.na(def_full$ObligatedAmountIsServices)] <- 0
# 
# def_full$pIsRnD <- def_full$ObligatedAmountIsRnD/def_full$Action.Obligation
# def_full$pIsRnD[is.na(def_full$ObligatedAmountIsRnD)] <- 0

#Need to update these to the new platform portfolios
# 
# 
# def_full$ObligatedAmountIsLand<-FactorToNumber(def_full$ObligatedAmountIsLand)
# 
# def_full$ObligatedAmountIsVessel<-FactorToNumber(def_full$ObligatedAmountIsVessel)
# 
# 
# def_full$ObligatedAmountIsVessel<-FactorToNumber(def_full$ObligatedAmountIsAir)
# 
# def_full$ObligatedAmountIsVessel<-FactorToNumber(def_full$ObligatedAmountIsOtherPP)
# 
# def_full$ObligatedAmountIsWnA<-FactorToNumber(def_full$ObligatedAmountIsWnA)
# 
# def_full$ObligatedAmountIsMnS<-FactorToNumber(def_full$ObligatedAmountIsMnS)
# 
# def_full$ObligatedAmountIsEnC<-FactorToNumber(def_full$ObligatedAmountIsEnC)
# 
# def_full$ObligatedAmountIsFRSnC<-FactorToNumber(def_full$ObligatedAmountIsFRSnC)
# 
# 
# def_full$pIsLand <- def_full$ObligatedAmountIsLand/def_full$Action.Obligation
# def_full$pIsLand[is.nan(def_full$pIsLand)|is.infinite(def_full$pIsLand)|is.na(def_full$ObligatedAmountIsLand)] <- 0
# 
# def_full$pIsVessel <- def_full$ObligatedAmountIsVessel/def_full$Action.Obligation
# def_full$pIsVessel[is.nan(def_full$pIsVessel)|is.infinite(def_full$pIsVessel)|is.na(def_full$ObligatedAmountIsVessel)] <- 0
# 
# def_full$pIsOtherPP <- def_full$ObligatedAmountIsOtherPP/def_full$Action.Obligation
# def_full$pIsOtherPP[is.nan(def_full$pIsOtherPP)|is.infinite(def_full$pIsOtherPP)|is.na(def_full$ObligatedAmountIsOtherPP)] <- 0
# 
# def_full$pIsAir <- def_full$ObligatedAmountIsAir/def_full$Action.Obligation
# def_full$pIsAir[is.nan(def_full$pIsAir)|is.infinite(def_full$pIsAir)|is.na(def_full$ObligatedAmountIsAir)] <- 0
# 
# def_full$pIsEnC <- def_full$ObligatedAmountIsEnC/def_full$Action.Obligation
# def_full$pIsEnC[is.nan(def_full$pIsEnC)|is.infinite(def_full$pIsEnC)|is.na(def_full$ObligatedAmountIsEnC)] <- 0
# 
# def_full$pIsFRSnC <- def_full$ObligatedAmountIsFRSnC/def_full$Action.Obligation
# def_full$pIsFRSnC[is.nan(def_full$pIsFRSnC)|is.infinite(def_full$pIsFRSnC)|is.na(def_full$ObligatedAmountIsFRSnC)] <- 0
# 
# 
# def_full$pIsMnS <- def_full$ObligatedAmountIsMnS/def_full$Action.Obligation
# def_full$pIsMnS[is.nan(def_full$pIsMnS)|is.infinite(def_full$pIsMnS)|is.na(def_full$ObligatedAmountIsMnS)] <- 0


# TempList<-c("PlatformPortfolio","UnmodifiedPlatformPortfolio","ObligatedAmountIsAir","ObligatedAmountIsEnC","ObligatedAmountIsFRSnC","ObligatedAmountIsLand","ObligatedAmountIsMnS","ObligatedAmountIsOtherPP","ObligatedAmountIsVessel","ObligatedAmountIsWnA","ProductOrServiceArea","UnmodifiedProductOrServiceArea","SimpleArea","UnmodifiedSimpleArea","ObligatedAmountIsProducts","ObligatedAmountIsServices","ObligatedAmountIsRnD","MaxOfIsPossibleSoftwareEngineering")

# TempList<-TempList[TempList %in% names(def_full)]
# def_full<-subset(def_full,select=-c(PlatformPortfolio,
#                                                       UnmodifiedPlatformPortfolio,
#                                                       SimpleArea,UnmodifiedSimpleArea ))

NASimpleArea<-(def_full$SimpleArea=="Mixed or Unlabeled" | is.na(def_full$SimpleArea))&
  !is.na(def_full$UnmodifiedSimpleArea) & def_full$UnmodifiedSimpleArea!="NULL"
def_full$SimpleArea[NASimpleArea]<-def_full$UnmodifiedSimpleArea[NASimpleArea]
# def_full$SimpleArea[def_full$SimpleArea=="Mixed or Unlabeled" & def_full$pIsProducts>0.5]<-"Products"
# def_full$SimpleArea[def_full$SimpleArea=="Mixed or Unlabeled" & def_full$pIsServices>0.5]<-"Services"
# def_full$SimpleArea[def_full$SimpleArea=="Mixed or Unlabeled" & def_full$pIsRnD>0.5]<-"R&D"



# def_full$PlatformPortfolio.sum[def_full$pIsLand>=0.75&
#     def_full$PlatformPortfolio.sum=="Unlabeled"]<-"Land Vehicles"
# def_full$PlatformPortfolio.sum[def_full$pIsVessel>=0.75&
#     def_full$PlatformPortfolio.sum=="Unlabeled"]<-"Ships & Submarines"
# def_full$PlatformPortfolio.sum[def_full$pIsAir>=0.75&
#     def_full$PlatformPortfolio.sum=="Unlabeled"]<-"Aircraft and Drones"
# def_full$PlatformPortfolio.sum[def_full$pIsOtherPP>=0.75&
#     def_full$PlatformPortfolio.sum=="Unlabeled"]<-"Other"
# def_full$PlatformPortfolio.sum[def_full$pIsWnA>=0.75&
#     def_full$PlatformPortfolio.sum=="Unlabeled"]<-"Weapons and Ammunition"
# def_full$PlatformPortfolio.sum[def_full$pIsMnS>=0.75&
#     def_full$PlatformPortfolio.sum=="Unlabeled"]<-"Missile and Space Systems"
# def_full$PlatformPortfolio.sum[def_full$pIsEnC>=0.75&
#     def_full$PlatformPortfolio.sum=="Unlabeled"]<-"Electronics and Communications"
# def_full$PlatformPortfolio.sum[def_full$pIsFRSnC>=0.75&
#     def_full$PlatformPortfolio.sum=="Unlabeled"]<-"Facilities and Construction"
# 
# def_full$SoftwareEng<-factor(def_full$MaxOfIsPossibleSoftwareEngineering,
#   levels=c(0,1),
#   labels=c("Not Software Eng.","Possible Software Eng.")
# )
# 
# def_full$SoftwareEng[is.na(def_full$SoftwareEng)&
#     !is.na(def_full$SimpleArea)]<-"Not Software Eng."



def_full$PlatformPortfolio<-factor(def_full$PlatformPortfolio)
def_full$UnmodifiedPlatformPortfolio<-factor(def_full$UnmodifiedPlatformPortfolio)

def_full$ProductOrServiceArea<-factor(def_full$ProductOrServiceArea)
def_full$UnmodifiedProductOrServiceArea<-factor(def_full$UnmodifiedProductOrServiceArea)

def_full$SimpleArea<-factor(def_full$SimpleArea)
def_full$UnmodifiedSimpleArea<-factor(def_full$UnmodifiedSimpleArea)


def_full<-subset(def_full,select=-c(
  # UnmodifiedSimpleArea,
  # SimpleArea,
  MaxOfIsPossibleSoftwareEngineering
  # ObligatedAmountIsProducts,
  # ObligatedAmountIsServices,
  # ObligatedAmountIsRnD,
  # ObligatedAmountIsLand,
  # ObligatedAmountIsVessel,
  # ObligatedAmountIsOtherPP,
  # ObligatedAmountIsAir,
  # ObligatedAmountIsEnC,
  # ObligatedAmountIsFRSnC,
  # ObligatedAmountIsMnS,
  # ObligatedAmountIsWnA
  
  
))


def_full$AnyPlaceInternational<-droplevels(def_full$AnyPlaceInternational)


def_full$SimpleArea<-droplevels(def_full$SimpleArea)


save(file="Data\\Federal_contract_CSIScontractID_complete.Rdata",def_full)

```

##Competition Vehicle
```{r CompetitionVehicle}
# load(file="Data\\Federal_contract_CSIScontractID_complete.Rdata")


##Contract_SP_ContractUnmodifiedCompetitionvehicleCustomer.txt
def_full<-csis360::read_and_join_experiment(data=def_full
  ,"Contract.SP_ContractUnmodifiedCompetitionvehicleCustomer.txt"
  ,path=""
  ,"Data\\"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
)

#Contract.SP_ContractCompetitionVehicleCustomer.txt
def_full<-csis360::read_and_join_experiment(data=def_full
  ,"Contract.SP_ContractCompetitionVehicleCustomer.txt"
  ,path=""
  ,"Data\\"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
)


#Number of Offers
def_full$UnmodifiedNumberOfOffersReceived[def_full$UnmodifiedNumberOfOffersReceived==0]<-NA
def_full$NumberOfOffersReceived[def_full$NumberOfOffersReceived==0]<-NA
def_full$UnmodifiedNumberOfOffersReceived<-FactorToNumber(def_full$UnmodifiedNumberOfOffersReceived)
def_full$NumberOfOffersReceived<-FactorToNumber(def_full$NumberOfOffersReceived)
def_full$UnmodifiedNumberOfOffersReceived[is.null(def_full$UnmodifiedNumberOfOffersReceived)]<-NA
def_full$NumberOfOffersReceived[is.null(def_full$NumberOfOffersReceived)]<-NA

def_full$UnmodifiedNumberOfOffersReceived<-impute_unmodified(
  def_full$UnmodifiedNumberOfOffersReceived,
  def_full$NumberOfOffersReceived
)

def_full$Offr <- cut2(def_full$UnmodifiedNumberOfOffersReceived,cuts=c(1,2,3,5))



if (all(levels(def_full$Offr)==c("  1","  2","[  3,  5)","[  5,999]"))){
  def_full$Offr<-factor(def_full$Offr, 
    levels=c("  1","  2","[  3,  5)","[  5,999]"),
    labels=c("1","2","3-4","5+"),
    ordered=TRUE
  )
}




#Competition


#IsSomeCompetition Impute missing values when labeled entries have a consistent value.

def_full$UnmodifiedIsSomeCompetition<-impute_unmodified(
  def_full$UnmodifiedIsSomeCompetition,
  def_full$IsSomeCompetition
)


#Set is some competion = 1 when it is blank and there are multiple offers

def_full$UnmodifiedIsSomeCompetition[is.na(def_full$UnmodifiedIsSomeCompetition)&
    !is.na(def_full$UnmodifiedNumberOfOffersReceived)&
    def_full$UnmodifiedNumberOfOffersReceived>1
  ]<-1

#Set number of offers =1 when there is a NA and no competition
def_full$Offr[is.na(def_full$Offr)&
    !is.na(def_full$UnmodifiedIsSomeCompetition)&
    def_full$UnmodifiedIsSomeCompetition==0
  ]<-"1"

def_full$UnmodifiedNumberOfOffersReceived[is.na(def_full$UnmodifiedNumberOfOffersReceived)&
    !is.na(def_full$UnmodifiedIsSomeCompetition)&
    def_full$UnmodifiedIsSomeCompetition==0
  ]<-1


#Produce Comp factor
def_full$Comp[def_full$UnmodifiedIsSomeCompetition==0]<-"No Comp."
# def_full$Comp[def_full$UnmodifiedIsSomeCompetition=="Comp." &
#                            def_full$UnmodifiedIsFullAndOpen=="Not Full & Open"]<-"Comp."
# def_full$Comp[def_full$UnmodifiedIsSomeCompetition=="Comp." &
#                            def_full$UnmodifiedIsFullAndOpen=="Comp."]<-"Comp."
def_full$Comp[def_full$UnmodifiedIsSomeCompetition==1]<-"Comp."

def_full$Comp<-factor(def_full$Comp,
                               levels=c("No Comp.","Comp.")
                                                              )


#Produce EffComp factor

#Competition and Offer  
def_full$EffComp<-as.character(def_full$Comp)

def_full$EffComp[def_full$Comp=="Comp." & !is.na(def_full$Comp)]<-
  ifelse(def_full$UnmodifiedNumberOfOffersReceived[
    def_full$Comp=="Comp." & !is.na(def_full$Comp)]>1,"2+ Offers","1 Offer")

def_full$EffComp<-factor(def_full$EffComp,
                               levels=c("No Comp.","1 Offer","2+ Offers")
                               )


#Impute missing urgency values
def_full$UnmodifiedIsUrgency<-impute_unmodified(
  def_full$UnmodifiedIsUrgency,
  def_full$IsUrgency
)
#If there's competition, than the urgency exception wasn't used
def_full$UnmodifiedIsUrgency[is.na(def_full$UnmodifiedIsUrgency)&
                               !is.na(def_full$UnmodifiedIsSomeCompetition)&
                               def_full$UnmodifiedIsSomeCompetition==1]<-0


def_full$Urg[def_full$UnmodifiedIsUrgency==0]<-"Not Urgency"
def_full$Urg[def_full$UnmodifiedIsUrgency==1]<-"Urgency Except."
def_full$Urg<-factor(def_full$Urg,
                               levels=c("Not Urgency","Urgency Except.")
                               )

#Vehicle
#Award_Type_Code Impute missing values when labeled entries have a consistent value.
def_full$unmodifiedaward_type_code<-impute_unmodified(
  def_full$unmodifiedaward_type_code,
  def_full$Award_Type_Code
)

#idv_type_code Impute missing values when labeled entries have a consistent value.
def_full$unmodifiedidv_type_code<-impute_unmodified(
  def_full$unmodifiedidv_type_code,
  def_full$IDV_Type_Code
)


#Unmodifiedmultipleorsingleawardidc Impute missing values when labeled entries have a consistent value.
def_full$Unmodifiedmultipleorsingleawardidc<-impute_unmodified(
  def_full$Unmodifiedmultipleorsingleawardidc,
  def_full$multipleorsingleawardidc
)

#Assign Is IDV
#A = BPA Call, C = Delivery Order
def_full$IsIDV[!is.na(def_full$unmodifiedaward_type_code) &
                               def_full$unmodifiedaward_type_code %in% c("A","C")]<-1
#B = Purchase Order, D = Definitive Contract
def_full$IsIDV[!is.na(def_full$unmodifiedaward_type_code) &
                               def_full$unmodifiedaward_type_code %in% c("B","D")]<-0
def_full$IsIDV[!is.na(def_full$unmodifiedidv_type_code)]<-1

if(is.numeric(def_full$IsIDV)){
  def_full$IsIDV<-factor(def_full$IsIDV,levels=c(0,1),labels=c("Def/Pur","IDV"))
}


#Simple Vehicle, which consolidates IDV and award types
def_full$Veh[
  !is.na(def_full$unmodifiedaward_type_code) &
    def_full$unmodifiedaward_type_code %in% c("B","D")]<-"Def/Pur"


def_full$Veh[
  !is.na(def_full$unmodifiedidv_type_code) &
    def_full$unmodifiedidv_type_code %in% c("B") &
    !is.na(def_full$Unmodifiedmultipleorsingleawardidc)]<-
  paste(def_full$Unmodifiedmultipleorsingleawardidc[
     !is.na(def_full$unmodifiedidv_type_code) &
    def_full$unmodifiedidv_type_code %in% c("B") &
    !is.na(def_full$Unmodifiedmultipleorsingleawardidc)
  ],"IDC")

#IDV_type_Code D = BOA, E=BPA, Award_Type_code A=BPA Call
def_full$Veh[
  !is.na(def_full$unmodifiedidv_type_code) &
    def_full$unmodifiedidv_type_code %in% c("D","E") |
  !is.na(def_full$unmodifiedaward_type_code) &
    def_full$unmodifiedaward_type_code %in% c("A") 
    ]<-
  "BPA/BOA"
#IDV_type_cde A=GWAC C=FSS
def_full$Veh[
  !is.na(def_full$unmodifiedidv_type_code)
  & def_full$unmodifiedidv_type_code 
  %in% c('A','C')]<-"FSS/GWAC"

#Imputing that when Multiple Award/Single Award is known, but IDV_type_code is not
#that the vehicle type is an IDC
def_full$Veh[
  is.na(def_full$Veh)&
  is.na(def_full$unmodifiedidv_type_code) &
    !is.na(def_full$Unmodifiedmultipleorsingleawardidc)]<-
  paste(def_full$Unmodifiedmultipleorsingleawardidc[
  is.na(def_full$Veh)&
  is.na(def_full$unmodifiedidv_type_code) &
    !is.na(def_full$Unmodifiedmultipleorsingleawardidc)],"IDC")

def_full$Veh<-factor(def_full$Veh)
summary(def_full$Veh)
#Imputing that when the simple vehicle is a kind of IDV, IsIDV should follow as well
def_full$IsIDV[
  is.na(def_full$IsIDV)&
    def_full$Veh %in% c(
      'BPA/BOA','FSS/GWAC','MULTIPLE AWARD IDC','SINGLE AWARD IDC'
    )]<-"IDV"





def_full<-def_full[,!colnames(def_full) %in% 
    c(
  #     UnmodifiedIsFullAndOpen,
  # "UnmodifiedIsOnlyOneSource",
  "UnmodifiedIsFollowonToCompetedAction",
      "Unmodifiedmultipleorsingleawardidc",
        # "UnmodifiedIsUrgency",
      "Unmodifiedaddmultipleorsingawardidc",
  # "IsFullAndOpen",
  # IsOnlyOneSource 
  # "IsFollowonToCompetedAction"
    "IsUrgency",
      "multipleorsingleawardidc",
      "AddMultipleOrSingleAwardIDC",
  "Award_Type_Code",
  "unmodifiedaward_type_code",
  "IDV_Type_Code",
  # "UnmodifiedNumberOfOffersReceived",
  "unmodifiedidv_type_code",
  "NumberOfOffersReceived"
)]
str(def_full)
  
save(file="Data\\Federal_contract_CSIScontractID_complete.Rdata",def_full)

```


##Pricing
```{r Pricing}
# load(file="Data\\Federal_contract_CSIScontractID_complete.Rdata")

def_full<-csis360::read_and_join_experiment(data=def_full
  ,"Contract.SP_ContractPricingCustomer.txt"
  ,path=""
  ,"Data\\"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
)

#Process Fixed Or Cost
def_full$pIsFixedPrice<-percent_obligated(def_full,
                                          "ObligatedAmountIsFixedPrice",
                                            "Action.Obligation",
                                          "UnmodifiedIsFixedPrice",
                                          "IsFixedPrice")

def_full$pIsCostBased<-percent_obligated(def_full,
                                          "ObligatedAmountIsCostBased",
                                            "Action.Obligation",
                                          "UnmodifiedIsCostBased",
                                          "IsCostBased")


def_full$pIsCombination<-percent_obligated(def_full,
                                          "ObligatedAmountIsCombination",
                                            "Action.Obligation",
                                          "UnmodifiedIsCombination",
                                          "IsCombination")



#Assign FxCb
def_full$FxCb[def_full$pIsFixedPrice>0  |
    def_full$pIsCostBased>0 | 
    def_full$pIsCombination>0 | 
      def_full$pIsOtherFee>0]<-"Combination or Other"

def_full$FxCb[def_full$pIsFixedPrice>=0.95|(def_full$IsFixedPrice==1 & (def_full$pIsCombination<=0.05 | is.na(def_full$pIsCombination)))]<-"Fixed-Price"
def_full$FxCb[def_full$pIsCostBased>=0.95|(def_full$IsCostBased==1 & (def_full$pIsCombination<=0.05 | is.na(def_full$pIsCombination)))]<-"Cost-Based"
def_full$FxCb<-factor(def_full$FxCb,levels=c("Fixed-Price","Cost-Based","Combination or Other"))
#Process Fee

View(subset(def_full,is.na(FxCb) & !is.na(FxCb)))
def_full$pIsIncentive<-percent_obligated(def_full,
                                          "ObligatedAmountIsIncentive",
                                            "Action.Obligation",
                                          "UnmodifiedIsIncentive",
                                          "IsIncentive")


def_full$pIsAwardFee<-percent_obligated(def_full,
                                          "ObligatedAmountIsAwardFee",
                                            "Action.Obligation",
                                          "UnmodifiedIsAwardFee",
                                          "IsAwardFee")



def_full$pIsFFPorNoFee<-percent_obligated(def_full,
                                          "ObligatedAmountIsFFPorNoFee",
                                            "Action.Obligation",
                                          "UnmodifiedIsFFPorNoFee",
                                          "IsFFPorNoFee")


def_full$pIsFixedFee<-percent_obligated(def_full,
                                          "ObligatedAmountIsFixedFee",
                                            "Action.Obligation",
                                          "UnmodifiedIsFixedFee",
                                          "IsFixedFee")




def_full$pIsOtherFee<-percent_obligated(def_full,
                                          "ObligatedAmountIsOtherFee",
                                            "Action.Obligation",
                                          "UnmodifiedIsOtherFee",
                                          "IsOtherFee")


#AssignFee

def_full$Fee[def_full$pIsAwardFee>0  |
    def_full$pIsIncentive>0 | 
    def_full$pIsFFPorNoFee>0 |
      def_full$pIsFixedFee>0 |
      def_full$pIsOtherFee>0 |
      def_full$pIsCombination>0]<-"Combination"

def_full$Fee[def_full$pIsAwardFee>=0.9|(def_full$IsAwardFee==1
  & (def_full$pIsCombination<=0.05 | is.na(def_full$pIsCombination))) ]<-"Award Fee"
def_full$Fee[def_full$pIsIncentive>=0.9|(def_full$IsIncentive==1
  & (def_full$pIsCombination<=0.05 | is.na(def_full$pIsCombination)))]<-"Incentive"
def_full$Fee[def_full$pIsFFPorNoFee>=0.9|(def_full$IsFFPorNoFee==1
  & (def_full$pIsCombination<=0.05 | is.na(def_full$pIsCombination)))]<-"FFP or No Fee"
def_full$Fee[def_full$pIsFixedFee>=0.9|(def_full$IsFixedFee==1
  & (def_full$pIsCombination<=0.05 | is.na(def_full$pIsCombination)))]<-"Fixed Fee"
def_full$Fee[def_full$pIsOtherFee>=0.9|(def_full$IsOtherFee==1
  & (def_full$pIsCombination<=0.05 | is.na(def_full$pIsCombination)))]<-"Other Fee"


def_full$Fee<-ordered(def_full$Fee,
  levels=c("Incentive","Fixed Fee","Award Fee",
    "FFP or No Fee","Other Fee","Combination"))


summary(def_full$Fee)
summary(def_full$FxCb)
#Undefinitized Contract Awards
# def_full$Veh[def_full$AwardOrIDVcontractActionType == "Letter Contract"]<-"Letter"
# def_full$Veh[def_full$AwardOrIDVcontractActionType %in%
#     c("Indefinite Delivery Contract",
#       "Delivery Order")]<-
#   as.character(def_full$multipleorsingleawardidc[def_full$AwardOrIDVcontractActionType %in%
#       c("Indefinite Delivery Contract",
#         "Delivery Order")])


#Imput UCA unmodified values when consistent for the remainder of the vehicle
def_full$UnmodifiedIsUCA[is.na(def_full$UnmodifiedIsUCA)&
  !is.na(def_full$IsUCA)]<-
  def_full$UCA[is.na(def_full$UnmodifiedIsUCA)&
  !is.na(def_full$IsUCA)]



def_full$UCA<-factor(def_full$UnmodifiedIsUCA,
  levels=c(0,1),
  labels=c("Not UCA","UCA")
)

#Imputing to make up for absence of 
#There's no obligations in the dataset to UCAs using the regulated vehicle of FSS/GWAC
def_full$UCA[is.na(def_full$UCA)&
               def_full$Veh=="FSS/GWAC"]<-"Not UCA"
summary(def_full$UCA)
def_full<-def_full[,!colnames(def_full) %in% 
    c(
  # Pricing.Mechanism.Code,
  "UnmodifiedTypeOfContractPricing",
  "IsLabeledPricing",
  "ObligatedAmountIsFixedPrice",
  # IsFixedPrice,
  "UnmodifiedIsFixedPrice",
  "ObligatedAmountIsCostBased",
  # IsCostBased,
  "UnmodifiedIsCostBased",
  "ObligatedAmountIsCombination",
  # IsCombination,
  "UnmodifiedIsCombination",
  "ObligatedAmountIsIncentive",
  # IsIncentive,
  "UnmodifiedIsIncentive",
  "ObligatedAmountIsAwardFee",
  # IsAwardFee,
  "UnmodifiedIsAwardFee",
  "ObligatedAmountIsFFPorNoFee",
  # IsFFPorNoFee,
  "UnmodifiedIsFFPorNoFee",
  "ObligatedAmountIsFixedFee",
  # IsFixedFee,
  "UnmodifiedIsFixedFee",
  "ObligatedAmountIsOtherFee",
  # IsOtherFee,
  "UnmodifiedIsOtherFee"
  # pIsFixedPrice,
  # pIsCostBased,
  # pIsCombination,
  # pIsIncentive,
  # pIsAwardFee,
  # pIsFFPorNoFee,
  # pIsFixedFee,
  # pIsOtherFee,
  # FxCb,
  # Fee,
    )]

str(def_full)

save(file="Data\\Federal_contract_CSIScontractID_complete.Rdata",def_full)
```

## Top PSC Office NAICS
```{r TopPSCofficeNAICS}
# load(file="Data\\Federal_contract_CSIScontractID_complete.Rdata")
def_full<-plyr::join(def_full,test)
test<-read_delim("Data\\Contract.SP_ContractTopPSCofficeNAICS.txt",delim="\t",
                 na=c("NA","NULL"),
                 col_types="icdcdcdcd")
                   # c(col_integer(),
                   #   col_character(),
                   #   col_double(),
                   #   col_character(),
                   #   col_double(),
                   #   col_character(),
                   #   col_double(),
                   #   col_character(),
                   #   col_double()))
def_full<-csis360::read_and_join_experiment(data=def_full
  ,"Contract.SP_ContractTopPSCofficeNAICS.txt"
  ,path=""
  ,"Data\\"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
)

def_full$topContractingOfficeAgencyID<-factor(
  def_full$topContractingOfficeAgencyID
)
def_full$topContractingOfficeID<-factor(
  def_full$topContractingOfficeID
)
def_full$topProductOrServiceCode<-factor(
  def_full$topProductOrServiceCode
)
def_full$topPrincipalNAICScode<-factor(
  def_full$topPrincipalNAICScode
)


def_full<-def_full[,!colnames(def_full) %in% 
    c(
      # "topContractingOfficeAgencyID",
      "topContractingOfficeAgencyIDamount"      ,
      # "topContractingOfficeID",
      "topContractingOfficeAmount"  ,
      # "topProductOrServiceCode",
      "topProductOrServiceAmount"               ,
      # "topPrincipalNAICScode",
      "topPrincipalNAICSamount")]
# load(file="Data\\Federal_contract_CSIScontractID_complete.Rdata")


```

#Final Cleanup and Output
##Applying lookups
```{r PostApply}
# debug(apply_lookups)


def_full<-apply_lookups(Path,def_full)




# def_full<-csis360::read_and_join(
#   def_full,
#   "Lookup_SubCustomer.csv",
#   by=c("Customer","SubCustomer"),
#   # replace_na_var=NULL,
#   # overlap_var_replaced=TRUE,
#   add_var="SubCustomer.sum"
#   # new_var_checked=TRUE,
#   # skip_check_var="CHPKisCrisisFunding"
#   )

# def_full$SubCustomer.sum<-factor(def_full$SubCustomer.sum)
# def_full$SubCustomer.sum<-droplevels(def_full$SubCustomer.sum)
# def_full$SubCustomer.sum<-droplevels(def_full$SubCustomer.sum)


def_full<-csis360::read_and_join(
  def_full,
  "LOOKUP_PlatformPortfolio.csv",
  by="PlatformPortfolio",
  # replace_na_var=NULL,
  # overlap_var_replaced=TRUE,
  add_var="PlatformPortfolio.sum"
  # new_var_checked=TRUE,
  # skip_check_var="CHPKisCrisisFunding"
  )
def_full$PlatformPortfolio.sum<-factor(def_full$PlatformPortfolio.sum)



save(file="Data\\Federal_contract_CSIScontractID_complete.Rdata",def_full)
# def_full<-rename_dataset(def_full)

```
##Dataset Output

```{r DatasetOutput}
def<-rename_dataset(def_full)
def<-def[,colnames(def) %in% c(
  # IsIDV,
  "FxCb",
  "Fee",
  "UCA",
  "Comp",
  "EffComp",
  "Urg",
  # MDAP,
  # unmodifiedSystemequipmentcode,
  "Who",
  "Veh",
  "PSR",
  "What",
  "Where",
  "Intl",
  # "LowCeil",
  "Ceil",
  "Dur",
  "Offr",
  # IsIDV,
  # Soft,
  "CBre",
  "CRai",
  "NChg",
  "Term",
  "UnmodifiedNumberOfOffersReceived",
  "UnmodifiedContractBaseAndAllOptionsValue",
  "SumOfisChangeOrder",
  "ChangeOrderBaseAndAllOptionsValue",
  # pChangeOrderObligated,
  "UnmodifiedDays",
  # "MinOfEffectiveDate",
  "StartFY",
  "Action.Obligation",
  "Agency",
  "Office",
  "ProdServ",
  "NAICS",
  "MaxOfDecisionTree",
  # "MaxOfDecisionTreeStep4",
  "MinOfDecisionTree"
  # "MinOfDecisionTreeStep4"
)]
# 

   

write.table(def
  ,file=paste("data\\Federal_contract_CSIScontractID_detail.csv"
    ,sep=""
  )
  #   ,header=TRUE
  , sep=","
  , row.names=FALSE
  , append=FALSE
)




summary(def$Agency[def$Who=="Uncategorized"])
def<-def[def$Who!="Civilian",]
load(file="Data\\Defense_contract_CSIScontractID_detail.Rdata")

 save(def,file="Data\\Defense_contract_CSIScontractID_detail.Rdata")
  
#Strip out the cuts



```

