---
title: "Contract Termination"
author: "Greg Sanders"
date: "Wednesday, February 8, 2017"
output:
  html_document:
    keep_md: yes
--- 

Modeling Likelihood of Contract Termination
============================================================================

#Setup
```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(arm)
library(R2WinBUGS)
library(Hmisc)
library(sjstats)
source("DIIGstat.r")
source("NAICS.r")

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40


```

Contracts are classified using a mix of numerical and categorical variables. While the changes in numerical variables are easy to grasp and summarize, a contract may have one line item that is competed and another that is not. As is detailed in the exploration on R&D, we are only considering information available prior to contract start. The percentage of contract obligations that were competed is a valuable benchmark, but is highly influenced by factors that occured after contract start.

## Contract Terminations

Contract terminations and the number of change orders can be calculated for the entire sample.  Contract termination is determined using the *Reason for Modification* field in FPDS.  A contract is considered to be terminated if it has at least one modification with the following values:

* "Terminate for Default (complete or partial)"
* "Terminate for Convenience (complete or partial)"
* "Terminate for Cause"
* "Legal Contract Cancellation"

These four catetegories and the "Close Out" category are used to mark a contract as closed.  Many contracts in FPDS and in the sample are never marked closed.  



##Prepare Data
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from   FPDS.


###Data Transformations and Summary



```{r ReadInData, echo = TRUE}
 # load(file="Data/defense_contract_complete.Rdata")
# head(def)
# debug(transform_contract)
# def<-transform_contract(def)  
 # save(file="Data/transformed_def.Rdata",def)
load(file="Data/transformed_def.Rdata")
def$NAICS2<-factor(def$NAICS2)
def<-def[!colnames(def) %in% "cb_Comp"]
def<-def[!colnames(def) %in% "StartFY.1"]
```



* b_Term is a binary variable that has a value of 1 for any contracts that have experienced a partial or complete termination, 0 otherwise. ('r summary(def$b_Term)
NA_stats(def,"b_Term"))
* b_Comp is a binary variable based on competition. It has a value of 0 for uncompeted contracts and a value of 1 for competition, regardless of number of offers. 'r  summary(def$b_Comp);
NA_stats(def,"b_Comp")'
* n_Comp is a numeric variable based on competition and number of offers. It has a value of 0 for uncompeted contracts and a value of 1 for single-offer competition, and a value of 2 for multi-offer competition. 'r summary(def$n_Comp);
NA_stats(def,"n_Comp")'
* n_Offr is a numeric variable based on competition and with more granularity on number offers. It has a value of 0 for uncompeted contracts and a value of 1 for single-offer competition, and a value of 2 for 2-offers, 3 for 3-4 offers, and 4 for 5+ offers. 'r summary(def$n_Offr);
NA_stats(def,"n_Offr")'
* l_Offr is the natural log of the number of offers received. Uncompeted contracts are classified as having received one offer. 'r summary(def$l_Offr);
NA_stats(def,"l_Offr")'
* cl_Ceil is the natural log of the initial contract cost ceiling, in then-year dollars. 'r centered_log_description(def$l_Ceil,"dollars");
NA_stats(def,"l_Ceil")'
* cl_Days is the natural log of the initial maximum duration of the contract, in days. The variable is centered, by subtracting its mean ('r centered_log_description(def$l_Days,"days");
NA_stats(def,"l_Days")' 
* SIDV, MIDV, and OIDV are dummy variables based on the contract vehicle. They correspond to Single-Award IDVs, Multi-Award IDVs, and Other IDVs, respectively, having a value of 1 when the task order has that vehicle type, and having a 0 other. The remaining types, definitive contracts and purchase orders, are intentionally left out. ('r summary(def$SIDV);
summary(def$MIDV);
summary(def$OIDV);
NA_stats(def,"Veh")'
* n_Fixed is a numeric variable based on contract pricing. It has a value of 0 for cost-based, 0.5 or "combination or other", 1 for any fixed price (excluding fixed-price level of effort which is classified as cost-based). ('r summary(def$n_Fixed);
NA_stats(def,"n_Fixed")')
* n_Incent is a numeric variable based on fee type. Ig has a value. 1 for incentive fee or cost sharing, 0.5 or "combination or other", 0 for all remaining types. ('r summary(def$n_Incent);
NA_stats(def,"n_Incent")')
* b_UCA is a binary variable with a value of 1 for contracts/task orders that begin as letter contracts or undefinitized contract awards (UCA) and a value of 0 otherwise. 'r
summary(def$b_UCA);
NA_stats(def,"b_UCA")'
* b_Intl is a binary variable with a value of 1 for contracts/task orders with any transactions performed internationally and a value of 0 otherwise. 'r
summary(def$b_Intl);
NA_stats(def,"b_Intl")'
* PSR is a factor reporting whether a contract is primarily for products/services/R&D. 'r
summary(def$PSR);
NA_stats(def,"PSR")'
* ProdServ is a factor reporting the top Product or Service Code of each contract. 'r
summary(def$ProdServ);
NA_stats(def,"ProdServ")'
* NAICS is a factor reporting the top North American Industrial Classification Code of each contract. 'r
summary(def$NAICS);
NA_stats(def,"NAICS")'
* Agency is a factor reporting the top Contracting Agency of each contract. 'r
summary(def$Agency);
NA_stats(def,"Agency")'
* Office is a factor reporting the top Contracting office of each contract. 'r
summary(def$Office);
NA_stats(def,"Office")'


In addition, l_Ceil and l_Days are rescaled to have an average value of 0 and a standard deviation of one. This standardizes interpretation and prevents a "very large eigen value" error later when l_Ceil:lDay is introduced.


Next, we eliminate missing data entries and then draw a sample. The final computation uses all of the data, but as a computation shortcut, only a subset of the data is needed to allow for processing of models in minutes rather than hours.

###Computational Sample Creation
```{r Sample}
 load(file="data//def_sample.Rdata")
# save(smp,smp1m,file="data//def_sample.Rdata")
#Code to update sample w/o recreating.
smp<-smp["CSIScontractID"]
smp<-left_join(smp,def)
smp1m<-smp1m["CSIScontractID"]
smp1m<-left_join(smp1m,def)

  
  #Customer
  if(!"Is.Defense" %in% colnames(contract) & "Who" %in% colnames(contract)){
    contract$Is.Defense<-as.character(contract$Who)
    contract$Is.Defense[contract$Is.Defense %in%
                     c("Air Force","Army",
                       "Navy","Other DoD","Uncategorized"  )
                   ]<-"Defense"
    contract$Is.Defense<-factor(contract$Is.Defense)
    
    contract$Who[contract$Who=="Uncategorized"]<-NA
    
    #b_ODoD
    contract$b_ODoD<-contract$Who
    levels(contract$b_ODoD)<- list("1"=c("Other DoD"),
                              "0"=c("Air Force","Army","Navy"))
    
    contract$b_ODoD<-as.integer(as.character(contract$b_ODoD))
    
    contract$ODoD<-contract$Who
    levels(contract$ODoD)<- list("Military Departments"=c("Air Force","Army","Navy"),
                            "Other DoD"=c("Other DoD"))
    
    
    
    
    
  }
  contract
}
debug(add_who)
smp<-add_who(smp)
smp1m<-add_who(smp1m)
# complete<-!is.na(def$b_Term)&
#   !is.na(def$b_Term)&
#   !is.na(def$n_Comp)&
#   !is.na(def$l_Ceil)&
#   !is.na(def$l_Days)&
#   !is.na(def$Veh) &
#   !is.na(def$n_Fixed)&
#   !is.na(def$b_Intl)&
#   !is.na(def$b_UCA)&
#   !is.na(def$NAICS)&
#   !is.na(def$NAICS2)&
#   !is.na(def$cl_def6_HHI_lag1)&
#   !is.na(def$US6_avg_sal_lag1)
# # 
# smp<-def[complete,]
# #8818392  to 8818392
# 13057769 to 8335209
# nrow(def[!complete,])/nrow(def)
# sum(def[!complete,]$Action.Obligation,na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
# 
# smp1m<-smp[sample(nrow(smp),1000000),]
# smp<-smp[sample(nrow(smp),250000),]
# save(file="data//def_sample.Rdata",smp,smp1m)

# levels(smp$Intl)<- list("Just U.S."=c("Just U.S."), 
#                                 "Any Intl."=c("Any International"))
# levels(smp1m$Intl)<- list("Just U.S."=c("Just U.S."), 
#                                 "Any Intl."=c("Any International"))


```

#Initial Logit Model

##Study Variable: Competition
Competition has the potential to reduce terminations by giving the government more options in vendors and encouraging better behavior from the contractor that was chosen. 
###Model 01A: No Competition / Competition


```{r Model01A_Term}

#Frequency Plot
summary_discrete_plot(smp,"Comp")

#Model
Term_Comp_01A <- glm (data=smp,
                 b_Term ~ b_Comp, family=binomial(link="logit"))
display(Term_Comp_01A)

#Plot the new variable and coefficients
# Add the fitted regression line
# fitted_Term_model(smp,"cb_Comp") +
#   stat_function(fun = fit_curve, args=list(a=coef(Term_Comp_01A)[1],                                                        b=coef(Term_Comp_01A)[2]),color="blue")

  stargazer::stargazer(Term_Comp_01A,type="text",
                       digits=2)
  
  





```
Competition alone has a very slight, but significant, negative correlation with terminations. The next step is to check alternate formulations. There's not yet enough in this model for any meaningful residual models. The next step is to look at a more detailed model, where single offer competition is broken out as a middle option between competition and no competion.



###Model 01B: Numerical Effective Competition

```{r Model01b_Term}

#Frequency Plot
summary_discrete_plot(smp,"EffComp")


#Model
Term_Comp_01B <- glm (data=smp,
                 b_Term ~ n_Comp, family=binomial(link="logit"))
display(Term_Comp_01B)

#Plot the Fitted
# Add the fitted regression line
# fitted_Term_model(smp,"n_Comp") +
  # stat_function(fun = fit_curve, args=list(a=coef(Term_Comp_01B)[1],
                                           # b=coef(Term_Comp_01B)[2]),
                # color="blue")
 stargazer::stargazer(Term_Comp_01A,Term_Comp_01B,type="text",
                       digits=2)
  
  



summary_residual_compare(Term_Comp_01A,Term_Comp_01B,bins=2,skip_vif=TRUE)




```


The correltion between the three categories of competition has a smaller coefficent, but is still signficant and the AIC is better. In the next step, the multiple award competition is broken down in greater detail.

###Model 01C: Numerical Effective Competition

```{r Model01C_Term}

#Frequency Plot
summary_discrete_plot(smp,"EffComp")


#Model
Term_Comp_01C <- glm (data=smp,
                 b_Term ~ EffComp, family=binomial(link="logit"))
display(Term_Comp_01C)

#Plot the Fitted
# Add the fitted regression line
# fitted_Term_model(smp,"n_Comp") +
  # stat_function(fun = fit_curve, args=list(a=coef(Term_Comp_01C)[1],
                                           # b=coef(Term_Comp_01C)[2]),
                # color="blue")
 stargazer::stargazer(Term_Comp_01A,Term_Comp_01B,Term_Comp_01C,type="text",
                       digits=2)
  
  



summary_residual_compare(Term_Comp_01A,Term_Comp_01C,bins=2,skip_vif=TRUE)

summary_residual_compare(Term_Comp_01B,Term_Comp_01C,bins=2,skip_vif=TRUE)


```

###Model 01D: Ordinal No Competition / Number of Offer  

```{r Model01D_Term}

#Frequency Plot
summary_discrete_plot(smp,"CompOffr")

#Model
Term_Comp_01D <- glm (data=smp,
                 b_Term ~ cn_Offr, family=binomial(link="logit"))
display(Term_Comp_01D)

#Plot the Fitted
#Add the fitted regression line
# fitted_Term_model(smp,"n_Comp") +
#   stat_function(fun = fit_curve, args=list(a=coef(Term_Comp_01D)[1],
#                                            b=coef(Term_Comp_01D)[2]),
#                 color="blue")


 stargazer::stargazer(Term_Comp_01A,Term_Comp_01B,Term_Comp_01C,
                      Term_Comp_01D,type="text",
                       digits=2)
  
  

```


As measured by residual deviance, this variable has slightly less predictive power than random noise. That can likely be attributed to the fact that 5+ offers category has a higher termination rate than 2 and 3-4. In theory, this could be because of non-liner relationship, for example higher number of offers competition may be more vulnerable to aggressive bidding beavior. 

Th estudy team then tested offers as a categorical variable with dummies. This does risk capture a hidden variable, such as competition methods. However, Within the limits of the dataset prepared for this study, binning number of offers may be the best way to examine this question.


###Model 01E: Binned No Competition / Number of Offer  

```{r Model01E_Term}

#Frequency Plot
summary_discrete_plot(smp,"CompOffr")

#Model
Term_Comp_01E <- glm (data=smp,
                 b_Term ~ CompOffr, family=binomial(link="logit"))
display(Term_Comp_01E)

#Plot the Fitted
#Add the fitted regression line
# fitted_Term_model(smp,"n_Comp") +
#   stat_function(fun = fit_curve, args=list(a=coef(Term_Comp_01E)[1],
#                                            b=coef(Term_Comp_01E)[2]),
#                 color="blue")


 stargazer::stargazer(Term_Comp_01A,Term_Comp_01B,Term_Comp_01C,
                      Term_Comp_01D,Term_Comp_01E,type="text",
                       digits=2)
  
  

```

Instead, the last variant to be checked is the number of offers directly. This is handled logarithmicly because the differences between number of offers at the bottom end of the scale mtters much more than at the high end of the scale. In this method, contracts that were not open to competition are grouped with contracts that received only a single offer.
###Model 01F: Number of Offer Categories 

```{r Model01F_Term}

#Frequency Plot
summary_continuous_plot(smp,"l_Offr")

#Percent Terminated Plot
summary_continuous_plot(smp,"l_Offr","FxCb")

#Percent Terminated Plot
summary_continuous_plot(smp,"l_Offr","PSR")

#Percent Terminated Plot
summary_continuous_plot(smp,"l_Offr","Veh")


#Model
Term_Comp_01F <- glm (data=smp,
                 b_Term ~ cl_Offr, family=binomial(link="logit"))
display(Term_Comp_01F)

#Variant Model
smp$clsqr_Offer<-smp$cl_Offr^2
Term_Comp_01G <- glm (data=smp,
                 b_Term ~ cl_Offr +clsqr_Offer, family=binomial(link="logit"))
display(Term_Comp_01G)

# #Plot the data and fitted curve
# Term_Comp_01F_plot<-ggplot(data=smp,
#        aes(y=j_Term,x=cl_Offr))+geom_jitter(alpha=0.01,height=0)+scale_y_sqrt() +
#   labs(title="Fitted Linear Model", caption="Source: FPDS, CSIS Analysis")

#Plot the Fitted
#Add the fitted regression line
# fitted_Term_model(smp,"cl_Offr") +
#   stat_function(fun = fit_curve, args=list(a=coef(Term_Comp_01F)[1],
#                                            b=coef(Term_Comp_01F)[2]),
#                              color="blue")
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_Term_residuals(Term_Comp_01F)
# 
# 
# 
# #Plot residuals versus fitted
# residuals_Term_plot(Term_Comp_01F,bins=3)+
#   labs(x="Estimated  Pr (Ceiling Breach)")




 stargazer::stargazer(Term_Comp_01A,Term_Comp_01B,Term_Comp_01C,
                      Term_Comp_01D,Term_Comp_01E,Term_Comp_01F,
                      Term_Comp_01G,type="text",
                       digits=2)
  

```

Closer examination further undercuts the idea that more offers is associated with a lower termination risk. As measured by deviance, the number offers adds less to the model than random noise. A quick experiment also found that use of number of offer squared only made the model slightly better than noise.

A variety of binned percent terminated graphs found that in the middle range of the number of offers, there is often an increase in the percent terminated. The study team had expected that this phenomenon may prove isolated to a certain type of contracting mechanism or product/service, but that did not prove to be the case.

The difference between single-offer and effective competition is worth exploring, even if it lowers the significance of the starting model. Happily, this decision is supported by the fact that this five category variable offers the greatest reduction in residual deviance. 

The greatest distinctiveness can be found in types of indefinite delivery vehicles. Definitive contracts and purchase orders show a higher termination rate as the number of offers increase. However, for single and multiple award IDVs, there's a decline in terminations rates correlated with low levels of competition, that often fades and even reverses as the number of offers increases. However, the results do not seem consistent with am exponential relationship. Instead, the study team will used binned competition/number of offers going forward. A decision reached in part because of the analysis of models with only the study variable but incorporating agency/office and NAICS categories.
## Study Variable Consolidation

### Level 6
#### Model NCS6A: def6_HHI_lag1
The expectation of the hypotheses is that consolidation will vary with consolidation, but does not predict a direction.


```{r ModelNCS6A_Term}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(smp,"def6_HHI_lag1")
summary_continuous_plot(smp,"def5_HHI_lag1")
summary_continuous_plot(smp,"def4_HHI_lag1")
summary_continuous_plot(smp,"def3_HHI_lag1")
summary_continuous_plot(smp,"def2_HHI_lag1")

#Model
Term_Cons_NCS6A <- glm (data=smp,
                 b_Term ~c_def6_HHI_lag1, family=binomial(link="logit"))
display(Term_Cons_NCS6A)


# #Plot the fitted model plot
# Term_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(Term_Comp_02A))}
# 
# #Competition curves
# fitted_Term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")



#Plot the fitted values vs actual results
# binned_fitted_versus_Term_residuals(Term_Comp_02A)

#Plot residuals versus fitted
  stargazer::stargazer(Term_Comp_01E,Term_Cons_NCS6A,type="text",
                       digits=2)


summary_residual_compare(Term_Comp_01E,Term_Cons_NCS6A,bins=20)


```
#### Model NCS6B: l_def6_HHI_lag1

Expectations are  unchanged.
```{r ModelNCS6A_Term}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(smp,"l_def6_HHI_lag1")
summary_continuous_plot(smp,"l_def5_HHI_lag1")
summary_continuous_plot(smp,"l_def4_HHI_lag1")
summary_continuous_plot(smp,"l_def3_HHI_lag1")
summary_continuous_plot(smp,"l_def2_HHI_lag1")


#Model
Term_Cons_NCS6B <- glm (data=smp,
                 b_Term ~cl_def6_HHI_lag1, family=binomial(link="logit"))
glmer_examine(Term_Cons_NCS6B)


# #Plot the fitted model plot
# Term_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(Term_Comp_02A))}
# 
# #Competition curves
# fitted_Term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")
# 


#Plot residuals versus fitted
  stargazer::stargazer(Term_Cons_NCS6A,Term_Cons_NCS6B,Term_Cons_NCS6D,type="text",
                       digits=2)


summary_residual_compare(Term_Cons_NCS6A,Term_Cons_NCS6B,bins=20)


```
The use of log doesn't change the direction of finding, but it does reduce the magnitude of the residuals and smooths out the trend. 


#### Model NCS6C: Defense to Overall ratio
The higher the ratio of defense obligations to reciepts in the overall economy, the DoD holds a monosopy over a sector. Given the challenges of monosopy, the a higher ratio estimates a greater  risk of ceiling breaches.
```{r ModelNCS6C_Term}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(smp,"capped_def6_ratio_lag1")
      summary_continuous_plot(smp,"l_def6_ratio_lag1")
      summary_continuous_plot(smp,"capped_def5_ratio_lag1")
      summary_continuous_plot(smp,"l_def5_ratio_lag1")
      
      summary_continuous_plot(smp,"capped_def4_ratio_lag1")
      summary_continuous_plot(smp,"l_def4_ratio_lag1")
      summary_continuous_plot(smp,"capped_def3_ratio_lag1")
      summary_continuous_plot(smp,"l_def3_ratio_lag1")
      summary_continuous_plot(smp,"capped_def2_ratio_lag1")
      summary_continuous_plot(smp,"l_def2_ratio_lag1")
      


#Model
Term_Cons_NCS6C <- glm (data=smp,
                 b_Term ~cl_def6_HHI_lag1+cl_def6_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(Term_Cons_NCS6C)

Term_Comp_NCS6C <- glm (data=smp,
                 b_Term ~CompOffr+cl_def6_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_NCS6C)
# 
# #Plot the fitted model plot
# Term_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(Term_Comp_02A))}
# 
# #Competition curves
# fitted_Term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(Term_Cons_NCS6B,Term_Cons_NCS6C,
                       Term_Comp_01E,Term_Comp_NCS6C,type="text",
                       digits=2)


summary_residual_compare(Term_Cons_NCS6B,Term_Cons_NCS6C,bins=20)
summary_residual_compare(Term_Comp_01E,Term_Comp_NCS6C,bins=2)


```
The results align with the hypothesis and are significant, although the magnitude is minimal.




#### Model NCS6D: cl_def6_obl_lag1
Defense sector obligations are added to better adjust for the fact that larger sectors tend to have lower HHI indices if only because they include a broader range of activities. In addition, Acting somewhat as a proxy for MDAP status, larger sectors may also have a greater risk of cascading problems. Thus greater defense obligations in a given sector are expected to estimate a greater likelihood over ceiling breaches,
Expectations are  unchanged.
```{r ModelNCS6D_Term}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(smp,"def6_obl_lag1")


summary_continuous_plot(smp,"l_def6_obl_lag1")
summary_continuous_plot(smp,"def5_obl_lag1")

summary_continuous_plot(smp,"l_def5_obl_lag1")
summary_continuous_plot(smp,"def4_obl_lag1")

summary_continuous_plot(smp,"l_def4_obl_lag1")
summary_continuous_plot(smp,"def3_obl_lag1")

summary_continuous_plot(smp,"l_def4_obl_lag1")
summary_continuous_plot(smp,"def2_obl_lag1")

summary_continuous_plot(smp,"l_def2_obl_lag1")

#Model
Term_Cons_NCS6D <- glm (data=smp,
                 b_Term ~cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1, family=binomial(link="logit"))
glmer_examine(Term_Cons_NCS6D)


Term_Comp_NCS6D <- glm (data=smp,
                 b_Term ~CompOffr+cl_def6_ratio_lag1+cl_def6_obl_lag1, 
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_NCS6D)

# 
# #Plot the fitted model plot
# Term_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(Term_Comp_02A))}
# 
# #Competition curves
# fitted_Term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(Term_Cons_NCS6C,Term_Cons_NCS6D,
                       Term_Comp_NCS6C,Term_Comp_NCS6D,
                       type="text",digits=2)


summary_residual_compare(Term_Cons_NCS6C,Term_Cons_NCS6D,
                         Term_Comp_NCS6C,Term_Comp_NCS6D,bins=20)


```
The results are significant but contary to expectations. AIC benefits are fairly substantail, so leaving it in for now but may  revisit later.


#### Model NCS6E: Average Salary
Average salary can be an proxy for unobserved skill requirements. We expect that a greater skill requirement will estimate a greater risk of ceiling breaches.
```{r ModelNCS6E_Term}
#Frequency Plot for unlogged ceiling


summary_continuous_plot(smp,"US6_avg_sal_lag1")

summary_continuous_plot(smp,"l_US6_avg_sal_lag1")

summary_continuous_plot(smp,"US5_avg_sal_lag1")
summary_continuous_plot(smp,"US4_avg_sal_lag1")
summary_continuous_plot(smp,"US3_avg_sal_lag1")
summary_continuous_plot(smp,"US2_avg_sal_lag1")

#Model
#cl_def6_obl_lag1

Term_Cons_NCS6E <- glm (data=smp,
                 b_Term ~cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1 , family=binomial(link="logit"))
glmer_examine(Term_Cons_NCS6E)


Term_Comp_NCS6E <- glm (data=smp,
                 b_Term ~CompOffr+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1, 
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_NCS6E)


# 
# #Plot the fitted model plot
# Term_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(Term_Comp_02A))}
# 
# #Competition curves
# fitted_Term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
 stargazer::stargazer(Term_Cons_NCS6C,Term_Cons_NCS6D,Term_Cons_NCS6E,
                       Term_Comp_NCS6C,Term_Comp_NCS6D,Term_Comp_NCS6E,
                       type="text",digits=2)



summary_residual_compare(Term_Cons_NCS6D,Term_Cons_NCS6E,bins=20)
summary_residual_compare(Term_Comp_NCS6D,Term_Comp_NCS6E,bins=20)



```
The results were significant and in line with expectations. Although this does remove the significance of ratio. Interestingly, as more factors are added, competition with 5 or more offers has a steadily rising termination rate, contrary to expectation.


### Level 5
#### Model NCS5A: cl_def5_HHI
```{r ModelNCS5A_Term}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(smp,"l_def6_HHI_lag1")
summary_continuous_plot(smp,"l_def5_HHI_lag1")
summary_continuous_plot(smp,"l_def4_HHI_lag1")
summary_continuous_plot(smp,"l_def3_HHI_lag1")
summary_continuous_plot(smp,"l_def2_HHI_lag1")


#Model
Term_Cons_NCS5A <- glm (data=smp,
                 b_Term ~cl_def5_HHI_lag1, family=binomial(link="logit"))
display(Term_Cons_NCS5A)


# #Plot the fitted model plot
# Term_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(Term_Comp_02A))}
# 
# #Competition curves
# fitted_Term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")
# 


#Plot residuals versus fitted
  stargazer::stargazer(Term_Cons_NCS6B,Term_Cons_NCS6D,Term_Cons_NCS6E,Term_Cons_NCS5A,type="text",
                       digits=2)


summary_residual_compare(Term_Cons_NCS6B,Term_Cons_NCS5A,bins=20)


```
The strong relationship is in line with the hypothesis.
#### Model NCS5B: Defense to Overall ratio
The higher the ratio of defense obligations to reciepts in the overall economy, the DoD holds a monosopy over a sector. Given the challenges of monosopy, the a higher ratio estimates a greater  risk of ceiling breaches.
```{r ModelNCS5b_Term}
#Frequency Plot for unlogged ceiling




summary_continuous_plot(smp,"capped_def5_ratio_lag1")
summary_continuous_plot(smp,"l_def5_ratio_lag1")

#Model
Term_Cons_NCS5B <- glm (data=smp,
                 b_Term ~cl_def5_HHI_lag1+cl_def5_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(Term_Cons_NCS5B)

Term_Comp_NCS5B <- glm (data=smp,
                 b_Term ~CompOffr+cl_def5_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_NCS5B)
# 
# #Plot the fitted model plot
# Term_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(Term_Comp_02A))}
# 
# #Competition curves
# fitted_Term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(Term_Cons_NCS6C,Term_Cons_NCS5A,Term_Cons_NCS5B,
                       Term_Comp_01E,Term_Comp_NCS6D,Term_Comp_NCS5B,type="text",
                       digits=2)


summary_residual_compare(Term_Cons_NCS5A,Term_Cons_NCS5B,bins=20)
summary_residual_compare(Term_Cons_NCS6D,Term_Cons_NCS5B,bins=20)
summary_residual_compare(Term_Comp_01E,Term_Comp_NCS5B,bins=2)
summary_residual_compare(Term_Comp_NCS6D,Term_Comp_NCS5B,bins=2)


```
The results align with the hypothesis, although the magnitude is minimal, if larger in magnitude than the level 6 version.


#### Model NCS5C: cl_def5_obl_lag1
Defense sector obligations are added to better adjust for the fact that larger sectors tend to have lower HHI indices if only because they include a broader range of activities. In addition, Acting somewhat as a proxy for MDAP status, larger sectors may also have a greater risk of cascading problems. Thus greater defense obligations in a given sector are expected to estimate a greater likelihood over ceiling breaches,
Expectations are  unchanged.
```{r ModelNCSD_Term}


#Model
Term_Cons_NCS5C <- glm (data=smp,
                 b_Term ~cl_def5_HHI_lag1+cl_def5_ratio_lag1+cl_def5_obl_lag1, family=binomial(link="logit"))
glmer_examine(Term_Cons_NCS5C)


Term_Comp_NCS5C <- glm (data=smp,
                 b_Term ~CompOffr+cl_def5_ratio_lag1+cl_def5_obl_lag1, 
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_NCS5C)
# 
# #Plot the fitted model plot
# Term_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(Term_Comp_02A))}
# 
# #Competition curves
# fitted_Term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(Term_Cons_NCS6D,Term_Cons_NCS5A,Term_Cons_NCS5B,Term_Cons_NCS5C,
                       Term_Comp_NCS6D,Term_Comp_NCS5B,Term_Comp_NCS5C,type="text",
                       digits=2)


summary_residual_compare(Term_Cons_NCS5B,Term_Cons_NCS5C,bins=10)
summary_residual_compare(Term_Comp_NCS5B,Term_Comp_NCS5C,bins=5)

```
Size is less significant but for consolidation is in line with expectations.


### Level 4
#### Model NCS4A: cl_def4_HHI
```{r ModelNCS4A_Term}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(smp,"l_def4_HHI_lag1")


#Model
Term_Cons_NCS4A <- glm (data=smp,
                 b_Term ~cl_def4_HHI_lag1, family=binomial(link="logit"))
display(Term_Cons_NCS4A)


# #Plot the fitted model plot
# Term_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(Term_Comp_02A))}
# 
# #Competition curves
# fitted_Term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")
# 


#Plot residuals versus fitted
  stargazer::stargazer(Term_Cons_NCS6B,Term_Cons_NCS6D,Term_Cons_NCS6E,Term_Cons_NCS4A,type="text",
                       digits=2)


summary_residual_compare(Term_Cons_NCS6B,Term_Cons_NCS4A,bins=20)


```

Level 4 HHI seems to slightly out perform level 6.



#### Model NCS4B: Defense to Overall ratio
The higher the ratio of defense obligations to reciepts in the overall economy, the DoD holds a monosopy over a sector. Given the challenges of monosopy, the a higher ratio estimates a greater  risk of ceiling breaches.
```{r ModelNCS4b_Term}
#Frequency Plot for unlogged ceiling




summary_continuous_plot(smp,"capped_def4_ratio_lag1")
summary_continuous_plot(smp,"l_def4_ratio_lag1")

#Model
Term_Cons_NCS4B <- glm (data=smp,
                 b_Term ~cl_def4_HHI_lag1+cl_def4_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(Term_Cons_NCS4B)

Term_Comp_NCS4B <- glm (data=smp,
                 b_Term ~CompOffr+cl_def4_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_NCS4B)
# 
# #Plot the fitted model plot
# Term_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(Term_Comp_02A))}
# 
# #Competition curves
# fitted_Term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(Term_Cons_NCS5B,Term_Cons_NCS4A,Term_Cons_NCS4B,
                       Term_Comp_01E,Term_Comp_NCS5B,Term_Comp_NCS4B,type="text",
                       digits=2)


summary_residual_compare(Term_Cons_NCS4A,Term_Cons_NCS4B,bins=20)
summary_residual_compare(Term_Cons_NCS5B,Term_Cons_NCS4B,bins=20)
summary_residual_compare(Term_Comp_01E,Term_Comp_NCS4B,bins=2)
summary_residual_compare(Term_Comp_NCS5B,Term_Comp_NCS4B,bins=2)


```
The results align with the hypothesis, although the magnitude is small, if larger in magnitude than the level 5 version.




#### Model NCS4C: cl_def4_obl_lag1
Defense sector obligations are added to better adjust for the fact that larger sectors tend to have lower HHI indices if only because they include a broader range of activities. In addition, Acting somewhat as a proxy for MDAP status, larger sectors may also have a greater risk of cascading problems. Thus greater defense obligations in a given sector are expected to estimate a greater likelihood over ceiling breaches,
Expectations are  unchanged.
```{r ModelNCS4C_Term}


#Model
Term_Cons_NCS4C <- glm (data=smp,
                 b_Term ~cl_def4_HHI_lag1+cl_def4_ratio_lag1+cl_def4_obl_lag1, family=binomial(link="logit"))
glmer_examine(Term_Cons_NCS4C)


Term_Comp_NCS4C <- glm (data=smp,
                 b_Term ~CompOffr+cl_def4_ratio_lag1+ cl_def4_obl_lag1,
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_NCS4C)
# 
# #Plot the fitted model plot
# Term_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(Term_Comp_02A))}
# 
# #Competition curves
# fitted_Term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
stargazer::stargazer(Term_Cons_NCS4B,Term_Cons_NCS4C,Term_Cons_NCS6D,
                       Term_Comp_NCS4B,Term_Comp_NCS4C,Term_Comp_NCS6D,type="text",
                       digits=2)



  #Compare to prior at same level
summary_residual_compare(Term_Cons_NCS4B,Term_Cons_NCS4C,bins=20)
#Compare to prior at lower level
summary_residual_compare(Term_Cons_NCS6D,Term_Cons_NCS4C,bins=20)
summary_residual_compare(Term_Co_NCS4B,Term_Comp_NCS4C,bins=20)
```
Size seems to add less to the model at level 4 than level 6 and is not in line with expectations.


### Level 3
#### Model NCS3A: cl_def3_HHI
```{r ModelNCS3A_Term}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(smp,"l_def3_HHI_lag1")


#Model
Term_Cons_NCS3A <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1, family=binomial(link="logit"))
display(Term_Cons_NCS3A)


# #Plot the fitted model plot
# Term_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(Term_Comp_02A))}
# 
# #Competition curves
# fitted_Term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")
# 


#Plot residuals versus fitted
  stargazer::stargazer(Term_Cons_NCS6B,Term_Cons_NCS6D,Term_Cons_NCS6E,Term_Cons_NCS3A,type="text",
                       digits=2)


summary_residual_compare(Term_Cons_NCS6B,Term_Cons_NCS3A,bins=20)


```

Level 3 HHI seems is less significant than other levels.


#### Model NCS3B: Defense to Overall ratio
The higher the ratio of defense obligations to reciepts in the overall economy, the DoD holds a monosopy over a sector. Given the challenges of monosopy, the a higher ratio estimates a greater  risk of ceiling breaches.
```{r ModelNCS3b_Term}
#Frequency Plot for unlogged ceiling




summary_continuous_plot(smp,"capped_def3_ratio_lag1")
summary_continuous_plot(smp,"l_def3_ratio_lag1")

#Model
Term_Cons_NCS3B <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(Term_Cons_NCS3B)

Term_Comp_NCS3B <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_NCS3B)
# 
# #Plot the fitted model plot
# Term_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(Term_Comp_02A))}
# 
# #Competition curves
# fitted_Term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(Term_Cons_NCS6C,Term_Cons_NCS5B,Term_Cons_NCS4B,Term_Cons_NCS3A,Term_Cons_NCS3B,
                       Term_Comp_01E,Term_Comp_NCS6C,Term_Comp_NCS5B,Term_Comp_NCS4B,Term_Comp_NCS3B,type="text",
                       digits=2)


summary_residual_compare(Term_Cons_NCS3A,Term_Cons_NCS3B,bins=20)
summary_residual_compare(Term_Cons_NCS4B,Term_Cons_NCS3B,bins=20)
summary_residual_compare(Term_Comp_01E,Term_Comp_NCS3B,bins=2)
summary_residual_compare(Term_Comp_NCS4B,Term_Comp_NCS3B,bins=2)


```
The results align with the hypothesis, and the magnitude is no longer small. The AIC reduction is noteworth as well that said, the chances in competition are contrary to hypothesis.





#### Model NCS3C: cl_def3_obl_lag1
Defense sector obligations are added to better adjust for the fact that larger sectors tend to have lower HHI indices if only because they include a broader range of activities. In addition, Acting somewhat as a proxy for MDAP status, larger sectors may also have a greater risk of cascading problems. Thus greater defense obligations in a given sector are expected to estimate a greater likelihood over ceiling breaches,
Expectations are  unchanged.
```{r ModelNCS3C_Term}


#Model
Term_Cons_NCS3C <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+cl_def3_obl_lag1, family=binomial(link="logit"))
glmer_examine(Term_Cons_NCS3)

Term_Cons_NCS3C2 <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_obl_lag1, family=binomial(link="logit"))
glmer_examine(Term_Cons_NCS3C2)


Term_Comp_NCS3C <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+ cl_def3_obl_lag1,
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_NCS3C)


Term_Comp_NCS3C2 <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_obl_lag1,
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_NCS3C)
# 
# #Plot the fitted model plot
# Term_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(Term_Comp_02A))}
# 
# #Competition curves
# fitted_Term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
stargazer::stargazer(Term_Cons_NCS6D,Term_Cons_NCS3B,Term_Cons_NCS3C2,
                       Term_Comp_NCS6D,Term_Comp_NCS3B,Term_Comp_NCS3C,Term_Comp_NCS3C2,type="text",
                       digits=2)



  #Compare to prior at same level
summary_residual_compare(Term_Cons_NCS3B,Term_Cons_NCS3C,bins=20)
#Compare to prior at lower level
summary_residual_compare(Term_Cons_NCS6D,Term_Cons_NCS3C,bins=20)
```
The magnitude of the change from size is noteworthy, greater than level six, and in line with expecations when included alone. But the AIC for the ratio model is far lower and keeping consistency between the models is valuable, so leaving it out.


#### Model NCS3D: Average Salary
Average salary can be an proxy for unobserved skill requirements. We expect that a greater skill requirement will estimate a greater risk of ceiling breaches.
```{r ModelNCS3D_Term}
#Frequency Plot for unlogged ceiling


summary_continuous_plot(smp,"US3_avg_sal_lag1")
summary_continuous_plot(smp,"l_US3_avg_sal_lag1")

summary_continuous_plot(smp,"US5_avg_sal_lag1")
summary_continuous_plot(smp,"US4_avg_sal_lag1")
summary_continuous_plot(smp,"US3_avg_sal_lag1")
summary_continuous_plot(smp,"US2_avg_sal_lag1")

#Model

Term_Cons_NCS3D <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                  cl_US3_avg_sal_lag1, family=binomial(link="logit"))
glmer_examine(Term_Cons_NCS3D)


Term_Comp_NCS3D <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+cl_US3_avg_sal_lag1,  #cl_def3_obl_lag1+
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_NCS3D)



# 
# #Plot the fitted model plot
# Term_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(Term_Comp_02A))}
# 
# #Competition curves
# fitted_Term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
stargazer::stargazer(Term_Cons_NCS6E,Term_Cons_NCS3B,Term_Cons_NCS3D,
                       Term_Comp_NCS6E,Term_Comp_NCS3B,Term_Comp_NCS3D,type="text",
                       digits=2)






summary_residual_compare(Term_Cons_NCS3D,Term_Cons_NCS3D2,bins=20)
summary_residual_compare(Term_Comp_NCS3C,Term_Comp_NCS3D2,bins=10)
summary_residual_compare(Term_Cons_NCS3D2,Term_Cons_NCS3D4,bins=20)
summary_residual_compare(Term_Comp_NCS3D2,Term_Comp_NCS3D3,bins=10)

summary_residual_compare(Term_Cons_NCS3D,Term_Cons_NCS3D4,bins=20)
summary_residual_compare(Term_Comp_NCS3C,Term_Comp_NCS3D3,bins=10)


```
In line with expectations and significant.


#### Model NCS3E: NAICS 6 and NAICS 3
Consolidation at lessa nd more granular levels may have different effects. Efficiencies are often used to describe sectors, like utilities, with high barriers to entry. Many of these aspects seem like they would already be captured at less granular NAICS levels, e.g. power plants, rather than more specific NAICS levels, like solar vs. coal. As a result, consolidation for more granular NAICS codes should estimate higher rates of ceiling breaches compared to less granular NAICS code.

We'll start by adding in everything from both models and seeing what violates VIF.
```{r ModelNCS3E_Term}
#Frequency Plot for unlogged ceiling


#Model
Term_Cons_NCS3E <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                  cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1  , family=binomial(link="logit"))
glmer_examine(Term_Cons_NCS3E)
vif(Term_Cons_NCS3E)


Term_Comp_NCS3E <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+cl_US3_avg_sal_lag1+
                   CompOffr+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1, 
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_NCS3E)




# 
# #Plot the fitted model plot
# Term_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(Term_Comp_02A))}
# 
# #Competition curves
# fitted_Term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
 stargazer::stargazer(Term_Cons_NCS6E,Term_Cons_NCS3D,Term_Cons_NCS3E,
                       Term_Comp_NCS6E,Term_Comp_NCS3D,Term_Comp_NCS3E,
                       type="text",digits=2)


summary_residual_compare(Term_Cons_NCS3D4,Term_Cons_NCS3E3,bins=20)
summary_residual_compare(Term_Comp_NCS3D3,Term_Comp_NCS3E3,bins=10)
summary_residual_compare(Term_Cons_NCS3D2,Term_Cons_NCS3E3,bins=20)
summary_residual_compare(Term_Comp_NCS3D2,Term_Comp_NCS3E3,bins=10)

summary_residual_compare(Term_Cons_NCS3D,Term_Cons_NCS3E3,bins=20)
summary_residual_compare(Term_Comp_NCS3C,Term_Comp_NCS3E3,bins=10)
summary_residual_compare(Term_Cons_NCS6E,Term_Cons_NCS3E3,bins=20)
summary_residual_compare(Term_Comp_NCS6E,Term_Comp_NCS3E3,bins=10)

```
No VIF trouble, but US3_avg_Sal seems  to add fairly little and is contrary to expectation. 

#### Model NCS3F: Testing removal of wage at NAICS 3

```{r ModelNCS3F_Term}
#Frequency Plot for unlogged ceiling


#Model
Term_Cons_NCS3F <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                  # cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1  , family=binomial(link="logit"))
glmer_examine(Term_Cons_NCS3F)


Term_Comp_NCS3F <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                 # +cl_US3_avg_sal_lag1+
                   CompOffr+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1, 
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_NCS3F)



# 
# #Plot the fitted model plot
# Term_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(Term_Comp_02A))}
# 
# #Competition curves
# fitted_Term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
 stargazer::stargazer(Term_Cons_NCS6E,Term_Cons_NCS3D,Term_Cons_NCS3E,Term_Cons_NCS3F,
                       Term_Comp_NCS6E,Term_Comp_NCS3D,Term_Comp_NCS3E,Term_Comp_NCS3F,
                       type="text",digits=2)


summary_residual_compare(Term_Cons_NCS3E,Term_Cons_NCS3F,
                         Term_Cons_NCS3E,Term_Cons_NCS3F,bins=20)

summary_residual_compare(Term_Cons_NCS6E,Term_Cons_NCS3F,
                         Term_Comp_NCS6E,Term_Comp_NCS3F,bins=10)

```
The removal reduces the VIF for Comp and only slightly increases it for Cons. Taking  it out.
### Level 2
#### Model NCS2A: cl_def2_HHI
```{r ModelNCS2A_Term}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(smp,"l_def2_HHI_lag1")


#Model
Term_Cons_NCS2A <- glm (data=smp,
                 b_Term ~cl_def2_HHI_lag1, family=binomial(link="logit"))
display(Term_Cons_NCS2A)


# #Plot the fitted model plot
# Term_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(Term_Comp_02A))}
# 
# #Competition curves
# fitted_Term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")
# 


#Plot residuals versus fitted
  stargazer::stargazer(Term_Cons_NCS6B,Term_Cons_NCS6D,Term_Cons_NCS6E,Term_Cons_NCS2A,type="text",
                       digits=2)


summary_residual_compare(Term_Cons_NCS6B,Term_Cons_NCS2A,bins=20)


```

Level 2 HHI seems to slightly under perform level 6.

#### Model NCS2B: Defense to Overall ratio
The higher the ratio of defense obligations to reciepts in the overall economy, the DoD holds a monosopy over a sector. Given the challenges of monosopy, the a higher ratio estimates a greater  risk of ceiling breaches.
```{r ModelNCS2b_Term}
#Frequency Plot for unlogged ceiling




summary_continuous_plot(smp,"capped_def2_ratio_lag1")
summary_continuous_plot(smp,"l_def2_ratio_lag1")

#Model
Term_Cons_NCS2B <- glm (data=smp,
                 b_Term ~cl_def2_HHI_lag1+cl_def2_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(Term_Cons_NCS2B)

Term_Comp_NCS2B <- glm (data=smp,
                 b_Term ~CompOffr+cl_def2_ratio_lag1, 
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_NCS2B)
# 
# #Plot the fitted model plot
# Term_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(Term_Comp_02A))}
# 
# #Competition curves
# fitted_Term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(Term_Cons_NCS3B,Term_Cons_NCS2A,Term_Cons_NCS2B,
                       Term_Comp_01E,Term_Comp_NCS3B,Term_Comp_NCS2B,type="text",
                       digits=2)


summary_residual_compare(Term_Cons_NCS2A,Term_Cons_NCS2B,bins=10)
summary_residual_compare(Term_Cons_NCS3B,Term_Cons_NCS2B,bins=20)
summary_residual_compare(Term_Comp_01E,Term_Comp_NCS2B,bins=2)
summary_residual_compare(Term_Comp_NCS3B,Term_Comp_NCS2B,bins=2)


```
The results align with the hypothesis on competition and for consolidation, though are weaker in the later case. The benefits of competition are substantially weakened by introduction of this variable, for contracts with 2 or more offers.





#### Model NCS2C: cl_def2_obl_lag1
Defense sector obligations are added to better adjust for the fact that larger sectors tend to have lower HHI indices if only because they include a broader range of activities. In addition, Acting somewhat as a proxy for MDAP status, larger sectors may also have a greater risk of cascading problems. Thus greater defense obligations in a given sector are expected to estimate a greater likelihood over ceiling breaches,
Expectations are  unchanged.
```{r ModelNCS2C_Term}


#Model
Term_Cons_NCS2C <- glm (data=smp,
                 b_Term ~cl_def2_HHI_lag1+cl_def2_ratio_lag1+cl_def2_obl_lag1, family=binomial(link="logit"))
glmer_examine(Term_Cons_NCS2C)


Term_Comp_NCS2C <- glm (data=smp,
                 b_Term ~CompOffr+cl_def2_ratio_lag1+cl_def2_obl_lag1, 
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_NCS2C)
# 
# #Plot the fitted model plot
# Term_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(Term_Comp_02A))}
# 
# #Competition curves
# fitted_Term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")





#Plot residuals versus fitted
  stargazer::stargazer(Term_Cons_NCS6D,Term_Cons_NCS3C,Term_Cons_NCS2B,Term_Cons_NCS2C,
                       Term_Comp_NCS6D,Term_Comp_NCS3C,Term_Comp_NCS2B,Term_Comp_NCS2C,type="text",
                       digits=2)

  #Compare to prior at same level
summary_residual_compare(Term_Cons_NCS2A,Term_Cons_NCS2C,bins=10)
#Compare to prior at lower level
summary_residual_compare(Term_Cons_NCS6D,Term_Cons_NCS2C,bins=10)
summary_residual_compare(Term_Cons_NCS3E,Term_Cons_NCS2C,bins=10)
```
In line with expectations, though lower magnitude.



#### Model NCS2D: Average Salary
Average salary can be an proxy for unobserved skill requirements. We expect that a greater skill requirement will estimate a greater risk of ceiling breaches.
```{r ModelNCS2D_Term}
#Frequency Plot for unlogged ceiling


summary_continuous_plot(smp,"US2_avg_sal_lag1")
summary_continuous_plot(smp,"l_US2_avg_sal_lag1")

summary_continuous_plot(smp,"US5_avg_sal_lag1")
summary_continuous_plot(smp,"US4_avg_sal_lag1")
summary_continuous_plot(smp,"US2_avg_sal_lag1")
summary_continuous_plot(smp,"US2_avg_sal_lag1")

#Model

Term_Cons_NCS2D <- glm (data=smp,
                 b_Term ~cl_def2_HHI_lag1+cl_def2_ratio_lag1+cl_def2_obl_lag1+
                  cl_US2_avg_sal_lag1 , family=binomial(link="logit"))
glmer_examine(Term_Cons_NCS2D)

Term_Cons_NCS2D2 <- glm (data=smp,
                 b_Term ~cl_def2_HHI_lag1+cl_def2_ratio_lag1+#cl_def2_obl_lag1
                  cl_US2_avg_sal_lag1 , family=binomial(link="logit"))#
glmer_examine(Term_Cons_NCS2D2)


Term_Comp_NCS2D <- glm (data=smp,
                 b_Term ~CompOffr+cl_def2_ratio_lag1+cl_def2_obl_lag1+cl_US2_avg_sal_lag1, 
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_NCS2D)


Term_Comp_NCS2D2 <- glm (data=smp,
                 b_Term ~CompOffr+cl_def2_ratio_lag1+cl_US2_avg_sal_lag1, #cl_def2_obl_lag1+
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_NCS2D2)




# 
# #Plot the fitted model plot
# Term_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(Term_Comp_02A))}
# 
# #Competition curves
# fitted_Term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")


#Plot residuals versus fitted
 stargazer::stargazer(Term_Cons_NCS6E,Term_Cons_NCS3D,Term_Cons_NCS2C,Term_Cons_NCS2D2,#Term_Cons_NCS6E,
                       Term_Comp_NCS6E,Term_Comp_NCS3D,Term_Comp_NCS2C,Term_Comp_NCS2D,Term_Comp_NCS2D2,#Term_Comp_NCS6E,
                       type="text",digits=2)


summary_residual_compare(Term_Cons_NCS2C,Term_Cons_NCS2D2,bins=10)
summary_residual_compare(Term_Comp_NCS2C,Term_Comp_NCS2D2,bins=5)
summary_residual_compare(Term_Cons_NCS2D2,Term_Cons_NCS2D3,bins=10)
summary_residual_compare(Term_Comp_NCS2D2,Term_Comp_NCS2D3,bins=5)

summary_residual_compare(Term_Cons_NCS2D,Term_Cons_NCS2D3,bins=20)
summary_residual_compare(Term_Comp_NCS2C,Term_Comp_NCS2D3,bins=10)


```
Sticking with  ratio and dropping with Obl. This is only necessary on the consolidation side, but for competition wage does add more than obligations.
#### Model NCS2E: NAICS 6 and NAICS 2
Consolidation at lessa nd more granular levels may have different effects. Efficiencies are often used to describe sectors, like utilities, with high barriers to entry. Many of these aspects seem like they would already be captured at less granular NAICS levels, e.g. power plants, rather than more specific NAICS levels, like solar vs. coal. As a result, consolidation for more granular NAICS codes should estimate higher rates of ceiling breaches compared to less granular NAICS code.

We'll start by adding in everything from both models and seeing what violates VIF.
```{r ModelNCS2E_Term}
#Frequency Plot for unlogged ceiling


#Model
Term_Cons_NCS2E <- glm (data=smp,
                 b_Term ~cl_def2_HHI_lag1+cl_def2_ratio_lag1+
                  cl_US2_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1  , family=binomial(link="logit"))
glmer_examine(Term_Cons_NCS2E)


#Defense obl 2 have the highest VIF and no coefficient to speak of, dropping it
Term_Comp_NCS2E <- glm (data=smp,
                 b_Term ~CompOffr+cl_def2_ratio_lag1+
                  #cl_US2_avg_sal_lag1+
                   CompOffr+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1  , family=binomial(link="logit"))
glmer_examine(Term_Cons_NCS2E)


#





#Defense obl 2 have the highest VIF and no coefficient to speak of, dropping it

#Taking out average salary 2 to keep the models snced up.



# 
# #Plot the fitted model plot
# Term_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(Term_Comp_02A))}
# 
# #Competition curves
# fitted_Term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
 stargazer::stargazer(Term_Cons_NCS6E,Term_Cons_NCS3F,Term_Cons_NCS2D2,Term_Cons_NCS2E,
                       Term_Comp_NCS6E,Term_Comp_NCS3F,Term_Comp_NCS2D2,Term_Comp_NCS2E,
                       type="text",digits=2)


summary_residual_compare(Term_Cons_NCS3F,Term_Cons_NCS2E,
                         Term_Comp_NCS3F,Term_Comp_NCS2E,bins=10)

summary_residual_compare(Term_Cons_NCS3D,Term_Cons_NCS3E3,bins=20)
summary_residual_compare(Term_Comp_NCS3C,Term_Comp_NCS3E3,bins=10)
summary_residual_compare(Term_Cons_NCS6E,Term_Cons_NCS3E3,bins=20)
summary_residual_compare(Term_Comp_NCS6E,Term_Comp_NCS3E3,bins=10)

```
The hypothesis is upheld. AIC is lower and residuals a little higher than the prior forms of consolidation for the level 3 model.  For the level 6 model, deviance is reduced some in both cases.


##Scope Variables
###Model 02A: Cost Ceiling

The model starts by examing the influence of large ceilings on contracts, the core idea here, as observed in the fixed priced paper, is that larger contracts are at greater risk of termination. This can be explained by both the inherent risk in the contract and high transaction costs of contract termination which discourage making the effort for smaller contracts.

```{r Model02A_Term}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(smp,"UnmodifiedContractBaseAndAllOptionsValue",
               bins=1000)
summary_continuous_plot(subset(smp,UnmodifiedContractBaseAndAllOptionsValue<100000000),
               "UnmodifiedContractBaseAndAllOptionsValue",
               bins=1000)

#Frequency Plot for logged ceiling
summary_continuous_plot(smp,"l_Ceil")




#Model
Term_Cons_02A <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil  , family=binomial(link="logit"))
glmer_examine(Term_Cons_02A)


Term_Comp_02A <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   CompOffr+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil, 
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_02A)




#Plot the fitted model plot
# Term_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(Term_Comp_02A))}
# 
# #Competition curves
# fitted_Term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = Term_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")
# 



#Plot residuals versus fitted
  stargazer::stargazer(Term_Cons_NCS3F, Term_Cons_02A,Term_Comp_NCS3F,Term_Comp_02A,type="text",
                       digits=2)


summary_residual_compare(Term_Cons_NCS3F,Term_Cons_02A,Term_Comp_NCS3F,Term_Comp_02A,bins=20)


```

Contract ceiling has a significant relationship, though the residuals show a possible non-linear patterns. However, these patterns seem more sinosuadal than exponential.

Contract ceiling has a significant relationship, though the residuals show a possible non-linear patterns. 




###Model 02B: Cost Ceiling and Competition
Larger contracts may encourage bid to win strategies  that could raise ceiling breaches for competition. That is a more indirect effect in consolidated markets.

```{r Model02B_Term}

#Frequency Plot
summary_continuous_plot(smp,"l_Ceil","CompOffr")




#Model
Term_Cons_02B <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil +cl_def6_HHI_lag1:cl_Ceil , family=binomial(link="logit"))
glmer_examine(Term_Cons_02B)


Term_Comp_02B <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   CompOffr+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + CompOffr:cl_Ceil, 
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_02B)

# 
# Term_Comp_02B_curve<-function(x, Comp){invlogit(cbind(1,Comp,x,Comp*x) %*%  coef(Term_Comp_02B))}
# 
# #Competition Curves
# fitted_Term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02B_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = Term_Comp_02B_curve, 
#                              args=list(Comp=2),color="blue")

#Plot the fitted values vs actual results
  stargazer::stargazer(Term_Cons_02A,Term_Cons_02B,type="text",
                       digits=2)#,Term_Comp_02A,Term_Comp_02B


summary_residual_compare(Term_Cons_02A,Term_Cons_02B,bins=20)#,Term_Comp_02A,Term_Comp_02B


```
The interaction went in the expected direction, Consolidation heightens the importance of contract ceiling, and vice versa. The results for comp are excluded because of VIF.




###Model 02C: Maximum Duration


```{r Model02C_Term}
#Frequency Plot for max duration
summary_continuous_plot(smp,"UnmodifiedDays",
               bins=1000)

#Frequency Plot for logged max duration
summary_continuous_plot(smp,"l_Days")



#Model
Term_Cons_02C <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days    
                 
                 +cl_def6_HHI_lag1:cl_Ceil , family=binomial(link="logit"))
glmer_examine(Term_Cons_02C)


Term_Comp_02C <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   CompOffr+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days, 
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_02C)

# 
# Term_Comp_02C_curve<-function(x, Comp,Ceil){invlogit(cbind(1,Comp,Ceil,x,Comp*Ceil) %*%  coef(Term_Comp_02C))}
# 
# #Competition Curves
# fitted_Term_model(smp,"cl_Days") + stat_function(fun = Term_Comp_02C_curve, 
#                              args=list(Comp=0,Ceil=0),color="blue")+
#   stat_function(fun = Term_Comp_02C_curve, 
#                              args=list(Comp=2,Ceil=0),color="blue")
# 
# #Ceiling Curves
# fitted_Term_model(smp,"cl_Days") +  stat_function(fun = Term_Comp_02C_curve, 
#                              args=list(Comp=0,Ceil=0),color="blue")+
#   stat_function(fun = Term_Comp_02C_curve, 
#                              args=list(Comp=0,Ceil=1),color="blue")
# 


#Plot residuals versus fitted
# residuals_Term_plot(Term_Comp_02C)+
#   labs(x="Estimated  Pr (Ceiling Breach)")
# debug(binned.resids)
# residuals_Term_plot(Term_Comp_02C,"cl_Days")+
  # labs(x="Centered Log(Ceiling)")
  stargazer::stargazer(Term_Cons_02A,Term_Cons_02B,Term_Cons_02C,type="text",
                       Term_Comp_02A,Term_Comp_02C,
                       digits=2)#,



summary_residual_compare(Term_Cons_02B,Term_Cons_02C,Term_Comp_02A,Term_Comp_02C,bins=20)

```
The initial model results are surprising as ceiling change reduces in importance, competition loses any benefit, and days proves to have an immense influence, and HHI flips its sign.

The graph of the fitted values shows that this model does a much better job of capturing the trends and ease concerns about patterns in residuals.

The next step will be to look at the interaction of ceiling and duration.

###Model 02D: Interaction of Duration and Competition
The effect of competition may fade with time, which is one of the ideas of having regularly repeated competitions. Thus the interaction of duration and competition is expected to estimate a greater risks of termination.

For consolidation likewise the nature of the sector may change over time reducing the impact. Thus the interaction of duration and solidation should have the opposite sign of consolidation itself. 

```{r Mode02D}

#Frequency Plot
summary_continuous_plot(smp,"l_Days","CompOffr")



#Model
Term_Cons_02D <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days    +
                   
                   cl_def6_HHI_lag1:cl_Ceil +
                   cl_def6_HHI_lag1:cl_Days, family=binomial(link="logit"))
glmer_examine(Term_Cons_02D)


Term_Cons_02D2 <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days    +
                   
                   # cl_def6_HHI_lag1:cl_Ceil +
                   cl_def6_HHI_lag1:cl_Days, family=binomial(link="logit"))
glmer_examine(Term_Cons_02D2)


Term_Comp_02D <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   CompOffr+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   CompOffr:cl_Days,
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_02D)

```
Excluded on VIF grounds.

##Contract Vehicle
Our dataset includes both stand alone contract awards and task orders that are under larger indefinite delivery vehilces (IDVs). 

###Model 03A: Single-Award, Multi-Award, and Other Indefinite Delivery Vehicles
Definitive contracts, single-award IDCs, FSS/GWAC contracts are all expected to estimate a lower rate of terminatiion. Multi-award IDCs are expected to estimate a higher rate of termination.

```{r Model03A_Term}
#Frequency Plot
summary_discrete_plot(smp,"Veh")


#Model
Term_Cons_03A <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 
                 +cl_def6_HHI_lag1:cl_Ceil , family=binomial(link="logit"))
glmer_examine(Term_Cons_03A)


Term_Comp_03A <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   CompOffr+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   Veh, 
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_03A)

# 
# #Plot the model and Vehicle for SIDV
# Term_Comp_03A_SIDV_curve<-function(x, Comp,Ceil,Days,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,x,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp) %*%  coef(Term_Comp_03A))}
# 
# #Competition curves
# fitted_Term_model(smp,"SIDV") +
#   stat_function(fun = Term_Comp_03A_SIDV_curve, 
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = Term_Comp_03A_SIDV_curve, 
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# Term_Comp_03A_MIDV_curve<-function(x, Comp,Ceil,Days,SIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,x,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp) %*%  coef(Term_Comp_03A))}
# 
# #Plot the model and Vehicle for MIDV
# #Competition curves
# fitted_Term_model(smp,"MIDV") +
#   stat_function(fun = Term_Comp_03A_MIDV_curve, 
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = Term_Comp_03A_MIDV_curve, 
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# Term_Comp_03A_OIDV_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,x,
#         Comp*Ceil,Days*Ceil,Days*Comp) %*%  coef(Term_Comp_03A))}
# 
# #Plot the model and Vehicle for OIDV
# #Competition curves
# fitted_Term_model(smp,"OIDV") +
#   stat_function(fun = Term_Comp_03A_OIDV_curve, 
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=0),color="blue")+
#   stat_function(fun = Term_Comp_03A_OIDV_curve, 
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=0),color="blue")
# 


#Plot the fitted values vs actual results
stargazer::stargazer(Term_Cons_02C,Term_Cons_03A,Term_Comp_02C,Term_Comp_03A,type="text",
                       digits=2)


summary_residual_compare(Term_Cons_02C,Term_Cons_03A,Term_Comp_02C,Term_Comp_03A,bins=20)

```
Expections were not uphed with multi-award IDCs but were other wise. THis notably reduces some of strength of def3_ratio and def_obl.

The next step is to check the intersections with ceiling.

###Model 03B: Vehicle and Duration
Expectation, those vehicles that are prone towards particularly short task orders may estimate greater ceiling breaches when they interact with longer durations. This covers Single-Award IDCs and to a lesser extent the dual peaked BPA/BOAs.
```{r Model03b_Term}

#Frequency Plot
summary_continuous_plot(smp,"l_Days","Veh")

Term_Cons_03B <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 
                 +cl_def6_HHI_lag1:cl_Ceil
                 +Veh:cl_Days, family=binomial(link="logit"))
glmer_examine(Term_Cons_03B)


Term_Comp_03B <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   CompOffr+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   Veh+
                   Veh:cl_Days, 
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_03B)



# Plot the model and Vehicle for SIDV
# Term_Comp_03B_SIDV_curve<-function(x, Comp,Ceil,Days,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,x,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*x,Days*MIDV,Days*OIDV) %*%  coef(Term_Comp_03B))}
# 
# #Duration curves
# fitted_Term_model(smp,"SIDV") +
#   stat_function(fun = Term_Comp_03B_SIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=-1,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = Term_Comp_03B_SIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=1,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# Term_Comp_03B_MIDV_curve<-function(x, Comp,Ceil,Days,SIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,x,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*SIDV,Days*x,Days*OIDV) %*%  coef(Term_Comp_03B))}
# 
# #Plot the model and Vehicle for MIDV
# #Duration Curves
# fitted_Term_model(smp,"MIDV") +
#   stat_function(fun = Term_Comp_03B_MIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=-1,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = Term_Comp_03B_MIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=1,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# Term_Comp_03B_OIDV_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,x,BPABOA,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*SIDV,Days*MIDV,Days*x) %*%  coef(Term_Comp_03B))}
# 
# #Plot the model and Vehicle for FSSGWAC
# #Duration curves
# fitted_Term_model(smp,"FSSGWAC") +
#   stat_function(fun = Term_Comp_03B_OIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=-1,
#                                        SIDV=0,MIDV=0),color="blue")+
#   stat_function(fun = Term_Comp_03B_OIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=1,
#                                        SIDV=0,MIDV=0),color="blue")


  

  stargazer::stargazer(Term_Cons_03A,Term_Cons_03B,Term_Comp_03A,Term_Comp_03B,type="text",
                         digits=2)
  
  summary_residual_compare(Term_Cons_03A,Term_Cons_03B2,Term_Comp_03A,Term_Comp_03B,bins=20)

  
```

Expectations are partially upheld. for longer duration Single-Award IDCs and to a lesser degree Multi-Award IDCs show notable positive coefficients. Unexpectedly, Longer duration FSS/GWACs have notably lower risks of termination. Leaving it in. 


###Model 03C: Vehicle and Competition

The next step is to check interactions with the contract vehicles. Each has a slightly different approach to competition. For example, the competition for a Single-Award IDV happens at the start of the IDV, after that, contracts awarded through that vehicle go to that single winning vendor

Competition occurs more regularly with definitive contracts, multiple award IDCs, GWACs/FSS, and some BPA/BOA. As a result we expect those vehicles that when interacting with competitive contracts to estiamte lower risk of ceiling breach. For consolidation, we expect single award IDCs and perhaps BPA/BOAs, which  are sometime single award, to be highly influenced by consolidation as competition  doesn't occur after initial selection but the overall market dynamic would instead influence whether contracting officers feel pressured to use that mechanism.

Mechanisms such as single-awrd IDcs and mullti-award IDCs, and evenFSS/GWACs which may have price list in theory maybe one means of addressing a consolidated market. These mechanisms in interaction with consolidation are expected to estimate a lower rate of termination.

```{r Model03C_Term}

#Frequency Plot
summary_discrete_plot(smp,"CompOffr","Veh")
summary_continuous_plot(smp,"HHI_lag1","Veh")

#Create the model
Term_Cons_03C <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 
                 +cl_def6_HHI_lag1:cl_Ceil+
                 +Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1, family=binomial(link="logit"))
glmer_examine(Term_Cons_03C)


Term_Comp_03C <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   CompOffr+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   Veh+
                   Veh:cl_Days+
                   Veh:CompOffr, 
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_03C)


Term_Comp_03C2 <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   CompOffr+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   Veh+
                   # Veh:cl_Days+
                   Veh:CompOffr, 
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_03C2)



# 
# # Plot the model and Vehicle for SIDV
# Term_Comp_03C_SIDV_curve<-function(x, Comp,Ceil,Days,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,x,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(Term_Comp_03C))}
# 
# #Competition curves
# fitted_Term_model(smp,"SIDV") +
#   stat_function(fun = Term_Comp_03C_SIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = Term_Comp_03C_SIDV_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# Term_Comp_03C_MIDV_curve<-function(x, Comp,Ceil,Days,SIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,x,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*SIDV,Days*x,Days*OIDV,
#         Comp*SIDV,Comp*x,Comp*OIDV) %*%  coef(Term_Comp_03C))}
# 
# #Plot the model and Vehicle for MIDV
# #Competition Curves
# fitted_Term_model(smp,"MIDV") +
#   stat_function(fun = Term_Comp_03C_MIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = Term_Comp_03C_MIDV_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# Term_Comp_03C_OIDV_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,x,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*SIDV,Days*MIDV,Days*x,
#         Comp*SIDV,Comp*MIDV,Comp*x) %*%  coef(Term_Comp_03C))}
# 
# #Plot the model and Vehicle for OIDV
# #Competition curves
# fitted_Term_model(smp,"OIDV") +
#   stat_function(fun = Term_Comp_03C_OIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=0),color="blue")+
#   stat_function(fun = Term_Comp_03C_OIDV_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=0),color="blue")

  stargazer::stargazer(Term_Cons_03B,Term_Cons_03C,type="text",
                       digits=2)


summary_residual_compare(Term_Cons_03B,Term_Cons_03C,bins=20)

```

VIF concompetition:vehicle exceeds 2, which necessitates removing it. HHI_lag1 results are in line with expectation and slightly reduce residuals. Adding it.



###Model 03D: Vehicle and Contract Ceiling
Based on a the descriptive statistics, it appears that the definitive vehicles, multi-award, and FSS/GWACs vary most based on  size. This woud be consistent with the idea that regular reward on these mechanisms might be an important  part of managmening them. By comparison breaking single-award IDCs and the sometimes single-award BPA/BOA into smaller chunks may just not matter to the same degree. Thus the expectation is that  M-IDV, FSS/GWAC, and definitive  (the baseline), will estimate higher risk of ceiling breaches for larger contracts.
```{r Model03D_Comp}

#Frequency Plot
summary_continuous_plot(smp,"l_Ceil","Veh")


#Create the model
Term_Cons_03D <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 
                 +cl_def6_HHI_lag1:cl_Ceil+
                 +Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil, family=binomial(link="logit"))
glmer_examine(Term_Cons_03D)


Term_Comp_03D <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   CompOffr+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   Veh+
                   Veh:cl_Days+
                   Veh:cl_Ceil, 
                 family=binomial(link="logit"))
glmer_examine(Term_Cons_03D)

# 
# # Plot the model and Vehicle for SIDV
# Term_Comp_03D_SIDV_curve<-function(x, Comp,Ceil,Days,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,x,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         Ceil*x,Ceil*MIDV,Ceil*OIDV) %*%  coef(Term_Comp_03D))}
# 
# #Competition curves
# fitted_Term_model(smp,"SIDV") +
#   stat_function(fun = Term_Comp_03D_SIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = Term_Comp_03D_SIDV_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# Term_Comp_03D_MIDV_curve<-function(x, Comp,Ceil,Days,SIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,x,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*SIDV,Days*x,Days*OIDV,
#         Comp*SIDV,Comp*x,Comp*OIDV,
#         Ceil*SIDV,Ceil*x,Ceil*OIDV) %*%  coef(Term_Comp_03D))}
# 
# #Plot the model and Vehicle for MIDV
# #Competition Curves
# fitted_Term_model(smp,"MIDV") +
#   stat_function(fun = Term_Comp_03D_MIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = Term_Comp_03D_MIDV_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# Term_Comp_03D_OIDV_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,x,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*SIDV,Days*MIDV,Days*x,
#         Comp*SIDV,Comp*MIDV,Comp*x,
#         Ceil*SIDV,Ceil*MIDV,Ceil*x) %*%  coef(Term_Comp_03D))}
# 
# #Plot the model and Vehicle for OIDV
# #Competition curves
# fitted_Term_model(smp,"OIDV") +
#   stat_function(fun = Term_Comp_03D_OIDV_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=0),color="blue")+
#   stat_function(fun = Term_Comp_03D_OIDV_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=0),color="blue")
# 


stargazer::stargazer(Term_Cons_03C,Term_Cons_03D,
                     Term_Comp_03B,Term_Comp_03D,type="text",
                       digits=2)
summary_residual_compare(Term_Cons_03C,Term_Cons_03D,Term_Comp_03B,Term_Comp_03D,bins=20)


```
Statistic based expectation do not hold up. Instead, the results mirror the expectation for duration. that those vehcles with smaller task orders run into more problems as ceilings get high. Keeping it. THe VIF is getting notably high so we'll probably have to remove some of these at some point.


##Type of Contract

The next step adds a measure for whether the contract was cost-based or fixed-price. Prior CSIS research has found that fixed-price contracts do face a higher risk of termination across the board.



###Model 04A: Fixed-Price Numerical
```{r Model04A}

#Frequency Plot
summary_discrete_plot(smp,"FxCb")


#Create the model
Term_Cons_04A <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 
                 +cl_def6_HHI_lag1:cl_Ceil+
                 +Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                   n_Fixed, family=binomial(link="logit"))
glmer_examine(Term_Cons_04A)


Term_Comp_04A <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   CompOffr+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   Veh+
                   Veh:cl_Days+
                   Veh:cl_Ceil+
                   n_Fixed, 
                 family=binomial(link="logit"))
glmer_examine(Term_Cons_04A)

# 
# # Plot the model and Vehicle 
# Term_Comp_04A_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(Term_Comp_04A))}
# 
# #Competition curves
# fitted_Term_model(smp,"SIDV") +
#   stat_function(fun = Term_Comp_04A_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = Term_Comp_04A_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_Term_residuals(Term_Comp_04A)
# 
# #Plot residuals versus fittedO
# residuals_Term_plot(Term_Comp_04A)+
#   labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_Term_plot(Term_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

stargazer::stargazer(Term_Cons_03D,Term_Cons_04A,
                     Term_Comp_03D,Term_Comp_04A,type="text",
                       digits=2)
summary_residual_compare(Term_Cons_03D,Term_Cons_04A,Term_Comp_03D,Term_Comp_04A,bins=20)

```

And fixed price contracts do indeed have a significant coefficient that correlates with higher termination risk. In addition, the addition of this variable reduces the pattern in the residuals that in the middle range. 

The coding of combination at the halfway point maybe too strong an assumption. The next step breaks pricing into bins instead.

###Model 04B: Fixed-Price Bins
```{r Model04B}

#Frequency Plot
summary_discrete_plot(smp,"FxCb")


#Create the model
Term_Cons_04B <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 
                 +cl_def6_HHI_lag1:cl_Ceil+
                 +Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                   FxCb, family=binomial(link="logit"))
glmer_examine(Term_Cons_04B)


Term_Comp_04B <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   CompOffr+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   Veh+
                   Veh:cl_Days+
                   Veh:cl_Ceil+
                   FxCb, 
                 family=binomial(link="logit"))
glmer_examine(Term_Cons_04B)

# Plot the model and Vehicle 
# Term_Comp_04B_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(Term_Comp_04A))}
# 
# #Competition curves
# fitted_Term_model(smp,"SIDV") +
#   stat_function(fun = Term_Comp_04A_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = Term_Comp_04A_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_Term_residuals(Term_Comp_04A)
# 
# #Plot residuals versus fittedO
# residuals_Term_plot(Term_Comp_04A)+
#   labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_Term_plot(Term_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

stargazer::stargazer(Term_Cons_04A,Term_Cons_04B,
                     Term_Comp_04A,Term_Comp_04B,type="text",
                       digits=2)
summary_residual_compare(Term_Cons_04A,Term_Cons_04B,Term_Comp_04A,Term_Comp_04B,bins=20)

```

Switching to binned makes sense, as the expectation that combination would be halfway between fixed and costed based is not upheld.



###Model 04C: Pricing Detail
Firm fixed price contracts have the least flexibility, and thus may estimate a higher probability of termination. By comparison, cost based approaches, other cost based, time & materials, labor hours, and fp_loe, and to oa lesser degree incentive fee contracts have more flexibility to pay based on post-award factors and thus estimate a lower risk of termination.
```{r Model04C}

#Frequency Plot
summary_discrete_plot(smp,"FxCb")
summary_discrete_plot(smp,"Fee")
summary_discrete_plot(smp,"FxCb","Fee")



summary_discrete_plot(smp,"Pricing",rotate=FALSE)


#Create the model
Term_Cons_04C <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 
                 +cl_def6_HHI_lag1:cl_Ceil+
                 +Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                   Pricing, family=binomial(link="logit"))
glmer_examine(Term_Cons_04C)


Term_Comp_04C <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   Veh+
                   Veh:cl_Days+
                   Veh:cl_Ceil+
                   Pricing, 
                 family=binomial(link="logit"))
glmer_examine(Term_Cons_04C)


# Plot the model and Vehicle 
# Term_Comp_04B_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(Term_Comp_04A))}
# 
# #Competition curves
# fitted_Term_model(smp,"SIDV") +
#   stat_function(fun = Term_Comp_04A_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = Term_Comp_04A_curve,
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_Term_residuals(Term_Comp_04A)
# 
# #Plot residuals versus fittedO
# residuals_Term_plot(Term_Comp_04A)+
#   labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_Term_plot(Term_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

stargazer::stargazer(Term_Cons_04B,Term_Cons_04C,
                     Term_Comp_04B,Term_Comp_04C,type="text",
                       digits=2)
summary_residual_compare(Term_Cons_04A,Term_Cons_04B,Term_Comp_04B,Term_Comp_04C,bins=20)

```
The detail does not help the AIC, but is in line with expectation. Keeping it for parity with breach model.

###Model 04D: Incentive Fees

In the performance of the defense acquisition system report, the benefits found were reduced cost overruns. That could help avoid terminations, but it's an indirect connection at best. Unfortunately, incentive fees are incredibly rare, which makes them challenging to examine directly.


```{r Model04D_Term}

#Frequency Plot
summary_discrete_plot(smp,"Fee")
summary(factor(smp$PricingFee))


#Create the model
Term_Cons_04D <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 
                 +cl_def6_HHI_lag1:cl_Ceil+
                 +Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                   PricingFee, family=binomial(link="logit"))
glmer_examine(Term_Cons_04D)


Term_Comp_04D <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   Veh+
                   Veh:cl_Days+
                   Veh:cl_Ceil+
                   PricingFee, 
                 family=binomial(link="logit"))
glmer_examine(Term_Cons_04D)
# 
# # Plot the model and Vehicle 
# Term_Comp_04D_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(Term_Comp_04D))}
# 
# #Days curves
# fitted_Term_model(smp,"n_Incent") +
#   stat_function(fun = Term_Comp_04D_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,Fixed=1),color="blue")+
#   stat_function(fun = Term_Comp_04D_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,Fixed=1),color="blue")


# #Plot the fitted values vs actual results
# binned_fitted_versus_Term_residuals(Term_Comp_04D)
# 
# #Plot residuals versus fittedO
# residuals_Term_plot(Term_Comp_04D)+
#   labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_Term_plot(Term_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

stargazer::stargazer(Term_Cons_04C,Term_Cons_04D,
                     Term_Comp_04C,Term_Comp_04D,type="text",
                       digits=2)
summary_residual_compare(Term_Cons_04C,Term_Cons_04D,
                         Term_Comp_04C,Term_Comp_04D,bins=20)

```

Incentive fees contracts are less likely to be terminated, but not significantly so. Again the AIC went up, it may be worth considering going back to just FxCB.

###Model 04E: Fixed-Price and Base Duration
Past CSIS research has found that fixed-price contracts do appear to be at higher risk if they have a longer maximum duration. Fixed-price contracting does require upfront estimation of likely costs, and thus a longer duration means more opportunity for changed circumstance.

Time&Materials/Labor Hours/Fixed-Price Level of Effort are typically used for smaller projects, but may not scale as well for longer lasting projects. 
```{r Model04E_Term}

#Frequency Plot
summary_continuous_plot(smp,"l_Days","PricingFee")

#Create the model

#Create the model
Term_Cons_04E <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 
                 +cl_def6_HHI_lag1:cl_Ceil+
                 +Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                   PricingFee+
                   cl_Days:PricingFee, family=binomial(link="logit"))
glmer_examine(Term_Cons_04E)

Term_Cons_04E2 <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 
                 +cl_def6_HHI_lag1:cl_Ceil+
                 # +Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                   PricingFee+
                   cl_Days:PricingFee, family=binomial(link="logit"))
glmer_examine(Term_Cons_04E2)


Term_Cons_04E3 <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 
                 +cl_def6_HHI_lag1:cl_Ceil+
                 # +Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                   FxCb+
                   cl_Days:FxCb, family=binomial(link="logit"))
glmer_examine(Term_Cons_04E3)



Term_Comp_04E <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   Veh+
                   Veh:cl_Days+
                   Veh:cl_Ceil+
                   PricingFee+
                   cl_Days:PricingFee, 
                 family=binomial(link="logit"))
glmer_examine(Term_Cons_04E)



```
Excluded for VIF reasons. Checked alternatives using cons but they were also all excluded.




###Model 04F: Fixed-Price and Ceiling
Past CSIS research has found that fixed-price contracts do appear to be at higher risk if they have a longer maximum duration. Fixed-price contracting does require upfront estimation of likely costs, and thus a higher ceiling does often mean higher risk.

Time&Materials/Labor Hours/Fixed-Price Level of Effort are typically used for smaller projects, but may not scale as well for large contracts.

Incentive fees, in theory, should do a estimate lower ceiling breaches as they incentive cost savings and are more oriented towards large projects.

```{r Model04F_Term}

#Frequency Plot
summary_continuous_plot(smp,"l_Ceil","PricingFee")


#Create the model
Term_Cons_04F <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 PricingFee+
                   
                 +cl_def6_HHI_lag1:cl_Ceil+
                 +Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil, family=binomial(link="logit"))
glmer_examine(Term_Cons_04F)


Term_Comp_04F <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   PricingFee+
                   Veh+
                   Veh:cl_Days+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil                  , 
                 family=binomial(link="logit"))
glmer_examine(Term_Cons_04F)

# Plot the model and Vehicle 
# Term_Comp_04F_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         Days*x) %*%  coef(Term_Comp_04F))}

# #Days curves
# fitted_Term_model(smp,"SIDV") +
#   stat_function(fun = Term_Comp_04F_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = Term_Comp_04F_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_Term_residuals(Term_Comp_04F)
# 
# #Plot residuals versus fittedO
# residuals_Term_plot(Term_Comp_04F)+
#   labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_Term_plot(Term_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")


stargazer::stargazer(Term_Cons_04B,Term_Cons_04C,Term_Cons_04D,Term_Cons_04F,
                     Term_Comp_04B,Term_Comp_04C,Term_Comp_04D,Term_Comp_04F,type="text",
                       digits=2)
summary_residual_compare(Term_Cons_04C,Term_Cons_04F,Term_Comp_04C,Term_Comp_04F,bins=20)
summary_residual_compare(Term_Cons_04D,Term_Cons_04F,Term_Comp_04D,Term_Comp_04F,bins=20)

```
The results are interesting, but largely not significant. Leaving this in for now, but it will likely be dropped at a later step.


###Model 04G: Undefinitized Contract Awards
Undefinitized Contract Awards allow for quick action in situations where there is not time or information to establish all of a contracts properties at the time of signing. They have been found by the GAO and the Performance of the Defense Acquisition studies to contain notable risks, primarily relating to cost overruns and thus ceiling breaches. Will these risks also carry into terminations and ceiling breaches?


```{r Model04G_Term}

#Frequency Plot
summary_discrete_plot(smp,"UCA")

Term_Cons_04G <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 PricingFee+b_UCA+
                   
                 +cl_def6_HHI_lag1:cl_Ceil+
                 +Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil, family=binomial(link="logit"))
glmer_examine(Term_Cons_04G)


Term_Comp_04G <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   Veh+
                   PricingFee+b_UCA+
                 
                   Veh:cl_Days+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil                  , 
                 family=binomial(link="logit"))
glmer_examine(Term_Cons_04G)



# Plot the model and Vehicle 
# Term_Comp_04G_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(Term_Comp_04G))}


#Days curves
# fitted_Term_model(smp,"SIDV") +
#   stat_function(fun = Term_Comp_04G_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1),color="blue")+
#   stat_function(fun = Term_Comp_04G_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1),color="blue")
# 
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_Term_residuals(Term_Comp_04G)
# 
# #Plot residuals versus fittedO
# residuals_Term_plot(Term_Comp_04G)+
#   labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_Term_plot(Term_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")
stargazer::stargazer(Term_Cons_04F,Term_Cons_04G,
                     Term_Comp_04F,Term_Comp_04G,type="text",
                       digits=2)
summary_residual_compare(Term_Cons_04F,Term_Cons_04G,Term_Comp_04F,Term_Comp_04G,bins=20)


```
Results are in line with expectations.

###Model 04H: UCA and Competition
Based on GAO research, sole source UCA are high risk and  thus should estimate a greater probability of  ceiling  breach. The same logic potentially holds for consolidation.
```{r Model04H_Comp}

#Frequency Plot
summary_discrete_plot(smp,"UCA","CompOffr")
summary_continuous_plot(smp,"cl_def6_HHI_lag1","UCA")

#Create the model
Term_Cons_04H <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 PricingFee+b_UCA+
                   
                 +cl_def6_HHI_lag1:cl_Ceil+
                 +Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil+
                   b_UCA:cl_def6_HHI_lag1, family=binomial(link="logit"))
glmer_examine(Term_Cons_04H)


Term_Comp_04H <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   Veh+
                   PricingFee+b_UCA+
                 
                   Veh:cl_Days+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil    +
                   b_UCA:CompOffr, 
                 family=binomial(link="logit"))
glmer_examine(Term_Cons_04H)



                


# Plot the model and Vehicle 
# Term_Comp_04H_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(Term_Comp_04H))}
# 
# #Days curves
# fitted_Term_model(smp,"SIDV") +
#   stat_function(fun = Term_Comp_04H_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1),color="blue")+
#   stat_function(fun = Term_Comp_04H_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1),color="blue")

stargazer::stargazer(Term_Cons_04G,Term_Cons_04H,
                     Term_Comp_04G,Term_Comp_04H,type="text",
                       digits=2)
summary_residual_compare(Term_Cons_04G,Term_Cons_04H,Term_Comp_04G,Term_Comp_04H,bins=20)


```
The interaction of UCA and Comp does align with the findings of the GAO as to the heightened risk of uncompeted UCA. However, the results are not significant. The results for consolidation are significant and in line with expectations. The magnitude of the coefficents is is considerable, although the rarity of UCAs means the effect on deviation is fairly small. This can also be seen in the residuals where there is a substantial gap between 0.03 and 0.05 in estimated risk of termination.






###Model 04I: UCA and Duration

While duration tracks the base duration and not the length spent in UCA, nonetheless longer length should estimate a higher probability of breach.
```{r Model04K_Term}


#Frequency Plot
summary_continuous_plot(smp,"l_Days","UCA")

Term_Cons_04I <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 PricingFee+b_UCA+
                   
                 +cl_def6_HHI_lag1:cl_Ceil+
                 # +Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil+
                   b_UCA:cl_def6_HHI_lag1 + 
                  b_UCA:l_Days, family=binomial(link="logit"))
glmer_examine(Term_Cons_04I)


Term_Cons_04I2 <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 PricingFee+b_UCA+
                   
                 +cl_def6_HHI_lag1:cl_Ceil+
                 # +Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil+
                   b_UCA:cl_def6_HHI_lag1 + 
                  b_UCA:l_Days, family=binomial(link="logit"))
glmer_examine(Term_Cons_04I2)


Term_Cons_04I3 <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 PricingFee+b_UCA+
                   
                 +cl_def6_HHI_lag1:cl_Ceil+
                 # +Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil+
                   # b_UCA:cl_def6_HHI_lag1 + 
                  b_UCA:l_Days, family=binomial(link="logit"))
glmer_examine(Term_Cons_04I3)

Term_Comp_04I <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   Veh+
                   PricingFee+b_UCA+
                 
                   Veh:cl_Days+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil    +
                   b_UCA:CompOffr + 
                  b_UCA:l_Days, 
                 family=binomial(link="logit"))
glmer_examine(Term_Cons_04I)





# Plot the model and Vehicle 
# Term_Comp_04I_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         Comp*x,Days*x) %*%  coef(Term_Comp_04I))}
# 
# #Days curves
# discrete_fitted_term_model(smp,"SIDV") +
#   stat_function(fun = Term_Comp_04I_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1),color="blue")+
#   stat_function(fun = Term_Comp_04I_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1),color="blue")



```
Fails VIF test. 

##Place of Performance
###Model 05A: Any International

International contracts may often be in conflict zones and thus experience greater risk. International contracts are exepected to estimate a higher probability of ceiling breaches.
```{r Model05A_Comp}

#Frequency Plot
summary_discrete_plot(smp,"Intl")


#Create the model
Term_Cons_05A <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 PricingFee+b_UCA+
                 b_Intl+
                   
                 +cl_def6_HHI_lag1:cl_Ceil+
                 +Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil+
                   b_UCA:cl_def6_HHI_lag1, family=binomial(link="logit"))
glmer_examine(Term_Cons_05A)


Term_Comp_05A <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   Veh+
                   PricingFee+b_UCA+
                 b_Intl+
                   
                   Veh:cl_Days+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil    +
                   b_UCA:CompOffr, 
                 family=binomial(link="logit"))
glmer_examine(Term_Cons_05A)




# Plot the model and Vehicle 
# Term_Comp_05A_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,UCA,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         UCA*Comp) %*%  coef(Term_Comp_05A))}
# 
# #Days curves
# fitted_Term_model(smp,"SIDV") +
#   stat_function(fun = Term_Comp_05A_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1,UCA=0),color="blue")+
#   stat_function(fun = Term_Comp_05A_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1,UCA=0),color="blue")


stargazer::stargazer(Term_Cons_04H,Term_Cons_05A,
                     Term_Comp_04H,Term_Comp_05A,type="text",
                       digits=2)
summary_residual_compare(Term_Cons_04H,Term_Cons_05A,Term_Comp_04H,Term_Comp_05A,bins=20)



```

International performance of contract had a positive  coefficent as expected.



###Model 05B: Fixed Price and Any International

Firm fixed price contracts and to a less degree other fixed-price contracts and time and materials/labor hours/fixed price level of effort contracts may be more vulnerable to changing conditions internationally. Thus they may estimate a higher rate of ceiling breaches.
```{r Model05B_Comp}

#Frequency Plot
summary_discrete_plot(smp,"Intl","PricingFee")



#Create the model
Term_Cons_05B <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 PricingFee+b_UCA+
                 b_Intl+
                   
                 +cl_def6_HHI_lag1:cl_Ceil+
                 +Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil+
                   b_UCA:cl_def6_HHI_lag1+
                   b_Intl:PricingFee, family=binomial(link="logit"))
glmer_examine(Term_Cons_05B)


Term_Comp_05B <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   Veh+
                   PricingFee+b_UCA+
                 b_Intl+
                   
                   Veh:cl_Days+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil    +
                   b_UCA:CompOffr+
                   b_Intl:PricingFee, 
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_05B)




# Plot the model and Vehicle 
# Term_Comp_05A_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,UCA,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         UCA*Comp) %*%  coef(Term_Comp_05A))}
# 
# #Days curves
# fitted_Term_model(smp,"SIDV") +
#   stat_function(fun = Term_Comp_05A_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1,UCA=0),color="blue")+
#   stat_function(fun = Term_Comp_05A_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1,UCA=0),color="blue")


stargazer::stargazer(Term_Cons_05A,Term_Cons_05B,
                     Term_Comp_05A,Term_Comp_05B,type="text",
                       digits=2)
summary_residual_compare(Term_Cons_05A,Term_Cons_05B,Term_Comp_05A,Term_Comp_05B,bins=20)



```
Due in part to small sample sizes, the results were fairly extreme, including a coefficient of -11 for  fixed price incentive. They also did not reduce model deviance by much and ran contrary to hypotheses. Leaving this out.
###Model 05C: Vehicle and Any International
Mechanisms like multi-award IDCs and GWAC/FSS use a known pool of contractors but still incorporate competition. Multi-award was emphasized in part after earlier scandals as preferable to single-award IDCs. Thus multi-award IDCs, and perhaps other vehicles that offer task order competition, is expected to estimate a lower rate of ceiling breaches. 


```{r Model05C}

#Frequency Plot
summary_discrete_plot(smp,"Intl","Veh")


#Create the model
Term_Cons_05C <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 PricingFee+b_UCA+
                 b_Intl+
                   
                 +cl_def6_HHI_lag1:cl_Ceil+
                 +Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil+
                   b_UCA:cl_def6_HHI_lag1+
                        
                        b_Intl:Veh, family=binomial(link="logit"))
glmer_examine(Term_Cons_05C)


Term_Comp_05C <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   Veh+
                   PricingFee+b_UCA+
                 b_Intl+
                   
                   Veh:cl_Days+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil    +
                   b_UCA:CompOffr+
                        
                        b_Intl:Veh, 
                 family=binomial(link="logit"))
glmer_examine(Term_Cons_05C)





# # Plot the model and Vehicle 
# Term_Comp_05C_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,UCA,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         UCA*Comp) %*%  coef(Term_Comp_05C))}
# 
# #Days curves
# discrete_fitted_term_model(smp,"SIDV") +
#   stat_function(fun = Term_Comp_05C_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1,UCA=0),color="blue")+
#   stat_function(fun = Term_Comp_05C_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1,UCA=0),color="blue")
# 
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_residuals(Term_Comp_05C)
# 
# #Plot residuals versus fittedO
# residuals_term_plot(Term_Comp_05C)+
#   labs(x="Estimated  Pr (Termination)")

# residuals_term_plot(Term_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")
stargazer::stargazer(Term_Cons_05A,Term_Cons_05C,
                     Term_Comp_05A,Term_Comp_05C,type="text",
                       digits=2)
summary_residual_compare(Term_Cons_05A,Term_Cons_05C,Term_Comp_05A,Term_Comp_05C,bins=20)

```
The ONS AIC is made worse and Comp barely improves, Single-Award IDC is the only interaction that aligns with expectations. Leaving it out.
 
##Who
Adding who resulted in a range of models that failed to converge. The one exception was combining Product/Service/R&D alone and Who, which did require removing multiple interactions from the model before convergence could be reached, but did allow the continued inclusion of  the combination of Product/Service/R&D and competition. All other models have been commented out to allow for the Markdown file  to  be created in a manageable amount of time. The study team initially considered using start year or contracting office identity as additional non-nested levels. However, those models failed to converge or had eigenvalue related challenges. As a result, the study team chose to focus on the question of what is being acquired. Who is acquiring is instead being handled by individual dummy variables or group level summary variables where appropriate, but not by seperate intercepts or slopes. Start year is not included in the model because of the complicatitons related to durations. Namely longer duration contracts from recent years have not yet had the opportunity to live out their natural life span. This means  that recent years will have an artificially high termination rate for longer contracts, because we only know about those that ended before their maximum duration, often due to termination.


###Model 06A: Agency
Other DoD stands out for its sheer quantity of contracts and task orders and also its lower termination rate. It includes the DLA which specializes in logistic delivery, and may thus estimate a lower rate of ceiling breahces.
```{r Model06A}
    #Frequency Plot
  summary_discrete_plot(def,"Agency",rotate_text=TRUE)
    summary_discrete_plot(def,rotate_text=TRUE)

    
#Create the model
Term_Cons_06A <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 PricingFee+b_UCA+
                 b_Intl+
                   
                 +cl_def6_HHI_lag1:cl_Ceil+
                 +Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil+
                   b_UCA:cl_def6_HHI_lag1+
                   Agency, family=binomial(link="logit"))
glmer_examine(Term_Cons_06A)


Term_Comp_06A <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   Veh+
                   PricingFee+b_UCA+
                 b_Intl+
                   
                   Veh:cl_Days+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil    +
                   b_UCA:CompOffr+
                   Agency, 
                 family=binomial(link="logit"))
glmer_examine(Term_Cons_06A)



  stargazer::stargazer(Term_Cons_05A,Term_Cons_06A,Term_Comp_05A,Term_Comp_06A,type="text",
                       digits=2)
  
summary_residual_compare(Term_Cons_05A,Term_Cons_06A,Term_Comp_05A,Term_Comp_06A,bins=20)

rm(Term_Comp_06A,Term_Comp_06A2,Term_Cons_06A,Term_Cons_06A2)
```



##What
### Model 07A: NAICS2
```{r Model07A}
corrdisp<-Hmisc::rcorr(
  as.matrix(cbind(subset(crisis_smp, select=c(b_UCA,c_OffCri,cl_Ceil,
                                              cl_Days,n_Fixed,b_Intl)),
                  dummies::dummy(crisis_smp$Crisis),
                  dummies::dummy(crisis_smp$NoComp),
                  dummies::dummy(crisis_smp$Reach),
                  dummies::dummy(crisis_smp$Veh),
                  dummies::dummy(crisis_smp$Is.Defense),
                  dummies::dummy(crisis_smp$Simple))))
corrdisp[[1]]

#Sumamry plot

#Create the model
Term_Cons_07A <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 PricingFee+b_UCA+
                 b_Intl+
                   
                 +cl_def6_HHI_lag1:cl_Ceil+
                 +Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil+
                   b_UCA:cl_def6_HHI_lag1+
                   Agency + NAICS2, family=binomial(link="logit"))
glmer_examine(Term_Cons_07A)

#Days has the higher VIF and is the least significant

Term_Cons_07A2 <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 PricingFee+b_UCA+
                 b_Intl+
                   
                 cl_def6_HHI_lag1:cl_Ceil+
                 # Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil+
                   b_UCA:cl_def6_HHI_lag1+
                   Agency + NAICS2, family=binomial(link="logit"))
glmer_examine(Term_Cons_07A2)

Term_Comp_07A <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   Veh+
                   PricingFee+b_UCA+
                 b_Intl+
                   
                   Veh:cl_Days+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil    +
                   b_UCA:CompOffr+
                   Agency + NAICS2, 
                 family=binomial(link="logit"))
glmer_examine(Term_Cons_07A)



Term_Comp_07A2 <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   Veh+
                   PricingFee+b_UCA+
                 b_Intl+
                   
                   # Veh:cl_Days+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil    +
                   b_UCA:CompOffr+
                   Agency + NAICS2, 
                 family=binomial(link="logit"))
glmer_examine(Term_Cons_07A2)
  stargazer::stargazer(Term_Cons_06A,Term_Cons_07A,Term_Comp_06A,Term_Comp_07A,type="text",
                       digits=2)
  
summary_residual_compare(Term_Cons_06D,Term_Cons_07A,Term_Comp_06D,Term_Comp_07A,bins=20)


```

Unlike agency, the temporary addition of binned NAICS2 did not necessitate the removal of any variables. After NAICS is incorporated, some types of vehicles lose signficance and the magnitude of a range of UCA related variables increase. Most interestingly, the sign of cl_def6_HHI_lag1 switches and is now in line with expectations and powerfully so. Competition continues to surprisingly estimate a greater risk of ceiling breaches, but the magnitude has decreased.

Unfortunately introduction of the NAICS variables significantly increases the number and magnitude of outlier residuals.



### Model 07B: Less detailed pricing?



```{r Model07B}
    #Frequency Plot
  summary_continuous_plot(def,"l_Ceil","Pricing")
    



#Create the model

Term_Cons_07B <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 FxCb+b_UCA+
                 b_Intl+
                   
                 cl_def6_HHI_lag1:cl_Ceil+
                 # Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                   FxCb:cl_Ceil+
                   b_UCA:cl_def6_HHI_lag1+
                   Agency + NAICS2, family=binomial(link="logit"))
glmer_examine(Term_Cons_07B)

Term_Cons_07B2 <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 FxCb+b_UCA+
                 b_Intl+
                   
                 cl_def6_HHI_lag1:cl_Ceil+
                 # Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                   # FxCb:cl_Ceil+
                   b_UCA:cl_def6_HHI_lag1+
                   Agency + NAICS2, family=binomial(link="logit"))
glmer_examine(Term_Cons_07B2)

Term_Comp_07B <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   Veh+
                   FxCb+b_UCA+
                 b_Intl+
                   
                   # Veh:cl_Days+
                   Veh:cl_Ceil+
                   FxCb:cl_Ceil    +
                   b_UCA:CompOffr+
                   Agency + NAICS2, 
                 family=binomial(link="logit"))



Term_Comp_07B2 <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   Veh+
                   FxCb+b_UCA+
                 b_Intl+
                   
                   # Veh:cl_Days+
                   Veh:cl_Ceil+
                   # FxCb:cl_Ceil    +
                   b_UCA:CompOffr+
                   Agency + NAICS2, 
                 family=binomial(link="logit"))


glmer_examine(Term_Cons_07B2)
  stargazer::stargazer(Term_Cons_07A2,Term_Cons_07B2,Term_Comp_07A2,Term_Comp_07B2,type="text",
                       digits=2)





summary_residual_compare(Term_Cons_07A2,Term_Cons_07B2,Term_Comp_07A2,Term_Comp_07B2,bins=20)

rm(Term_Cons_07B,Term_Comp_07B)

```
THere's not a real improvement from the more detailed version, so keeping it in for parity.


### Model 07C: Drop NAICS6_Ratio



```{r Model07B}
    #Frequency Plot
  summary_continuous_plot(def,"l_Ceil","Pricing")
    



#Create the model


#Create the model
Term_Cons_07C <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_obl_lag1+#cl_def6_ratio_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 PricingFee+b_UCA+
                 b_Intl+
                   
                 cl_def6_HHI_lag1:cl_Ceil+
                 # Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil+
                   b_UCA:cl_def6_HHI_lag1+
                   Agency + NAICS2, family=binomial(link="logit"))
glmer_examine(Term_Cons_07C)


Term_Comp_07C <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   +cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ #cl_def6_ratio_lag1
                   cl_Ceil + cl_Days+
                   Veh+
                   PricingFee+b_UCA+
                 b_Intl+
                   
                   # Veh:cl_Days+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil    +
                   b_UCA:CompOffr+
                   Agency + NAICS2, 
                 family=binomial(link="logit"))

glmer_examine(Term_Comp_07C)

  stargazer::stargazer(Term_Cons_07A2,Term_Cons_07C,Term_Comp_07A2,Term_Comp_07C,type="text",
                       digits=2)





summary_residual_compare(Term_Cons_07A2,Term_Cons_07B2,Term_Comp_07A2,Term_Comp_07C,bins=20)

rm(Term_Cons_07B,Term_Comp_07B)

```

### Model 07D: Drop NAICS3_Ratio



```{r Model07D}
    #Frequency Plot
  summary_continuous_plot(def,"l_Ceil","Pricing")
    



#Create the model


#Create the model
Term_Cons_07D <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+#cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 PricingFee+b_UCA+
                 b_Intl+
                   
                 cl_def6_HHI_lag1:cl_Ceil+
                 # Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil+
                   b_UCA:cl_def6_HHI_lag1+
                   Agency + NAICS2, family=binomial(link="logit"))
glmer_examine(Term_Cons_07D)


Term_Comp_07D <- glm (data=smp,
                 b_Term ~CompOffr+#cl_def3_ratio_lag1+
                   +cl_def6_obl_lag1+cl_def6_ratio_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   Veh+
                   PricingFee+b_UCA+
                 b_Intl+
                   
                   # Veh:cl_Days+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil    +
                   b_UCA:CompOffr+
                   Agency + NAICS2, 
                 family=binomial(link="logit"))

glmer_examine(Term_Comp_07D)

  stargazer::stargazer(Term_Cons_07A2,Term_Cons_07C,Term_Cons_07D,Term_Comp_07A2,Term_Comp_07C,Term_Comp_07D,type="text",
                       digits=2)





summary_residual_compare(Term_Cons_07C,Term_Cons_07D,Term_Comp_07C,Term_Comp_07D,bins=20)

rm(Term_Cons_07B,Term_Comp_07B)

```
Removing one of the two variables drops AIC. 
### Model 07E: Drop NAICS3_Ratio



```{r Model07E}
    #Frequency Plot
  summary_continuous_plot(def,"l_Ceil","Pricing")
    



#Create the model


#Create the model
Term_Cons_07E <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+#cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+#cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 PricingFee+b_UCA+
                 b_Intl+
                   
                 cl_def6_HHI_lag1:cl_Ceil+
                 # Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil+
                   b_UCA:cl_def6_HHI_lag1+
                   Agency + NAICS2, family=binomial(link="logit"))
glmer_examine(Term_Cons_07E)


Term_Comp_07E <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   +cl_def6_ratio_lag1+cl_US6_avg_sal_lag1+ #+cl_def6_obl_lag1
                   cl_Ceil + cl_Days+
                   Veh+
                   PricingFee+b_UCA+
                 b_Intl+
                   
                   # Veh:cl_Days+
                   Veh:cl_Ceil+
                   PricingFee:cl_Ceil    +
                   b_UCA:CompOffr+
                   Agency + NAICS2, 
                 family=binomial(link="logit"))

glmer_examine(Term_Comp_07E)

  stargazer::stargazer(Term_Cons_07A2,Term_Cons_07C,Term_Cons_07E,Term_Comp_07A2,Term_Comp_07C,Term_Comp_07E,type="text",
                       digits=2)





summary_residual_compare(Term_Cons_07C,Term_Cons_07E,Term_Comp_07C,Term_Comp_07E,bins=20)

rm(Term_Cons_07B,Term_Comp_07B)

```
## Cluster Analysis
### Model 08A: Office Clustered Ceiling
This approach explores an alternate means of considering ceiling, using cluster averaging by office rather than grand mean averaging. This means that we'd be considering the initial size of each contract or task order relative to others released by the same office rather than the average of all contracts. In this case, the averaging is done after logging the ceiling.
```{r Model08A}
def<-def %>% group_by(Agency,Office) %>%
  dplyr::mutate(office_l_Ceil_mean=mean(l_Ceil,na.rm=TRUE),
                  office_l_Ceil_sd=sd(l_Ceil,na.rm=TRUE)
                  )

def$c_office_l_Ceil<-(def$l_Ceil-def$office_l_Ceil_mean)/(def$office_l_Ceil_sd*2)
def$c_office_l_Ceil_mean<-arm::rescale(def$office_l_Ceil_mean)
summary_continuous_plot(smp,"c_office_l_Ceil")
summary_continuous_plot(smp,"cl_Ceil")

#Taking out average salary 3 to keep the models snced up.
Term_Comp_NCS3E3 <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                   CompOffr+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1, 
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_NCS3E3)
vif(Term_Comp_NCS3E3)

Term_Cons_08A <- glm (data=smp,
                      b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        c_office_l_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:c_office_l_Ceil+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Cons_08A)


Term_Comp_08A <- glm (data=smp,
                      b_Term~CompOffr+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        c_office_l_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:CompOffr + 
                        b_UCA:c_office_l_Ceil+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Comp_08A)


stargazer::stargazer(Term_Cons_07C,Term_Cons_08A,Term_Comp_07C,Term_Comp_08A,type="text",
                       digits=2)

summary_residual_compare(Term_Cons_07C,Term_Cons_08A,Term_Comp_07C,Term_Comp_08A,bins=20)

```
### Model 08B: Office Clustered Days

```{r Model08B}
def<-def %>% group_by(Agency,Office) %>%
  dplyr::mutate(office_l_Days_mean=mean(l_Days,na.rm=TRUE),
                  office_l_Days_sd=sd(l_Days,na.rm=TRUE)
                  )

def$c_office_l_Days<-(def$l_Days-def$office_l_Days_mean)/(def$office_l_Days_sd*2)
def$c_office_l_Days_mean<-arm::rescale(def$office_l_Days_mean)
summary_continuous_plot(smp,"c_office_l_Days")
summary_continuous_plot(smp,"cl_Days")


Term_Cons_08B <- glm (data=smp,
                      b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        c_office_l_Ceil + c_office_l_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:c_office_l_Ceil+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Cons_08B)


Term_Comp_08B <- glm (data=smp,
                      b_Term~CompOffr+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        c_office_l_Ceil + c_office_l_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:CompOffr + 
                        b_UCA:c_office_l_Ceil+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Comp_08B)


stargazer::stargazer(Term_Cons_07C,Term_Cons_08B,Term_Comp_07C,Term_Comp_08B,type="text",
                       digits=2)

summary_residual_compare(Term_Cons_07C,Term_Cons_08B,Term_Comp_07C,Term_Comp_08B,bins=20)

```




# Interactions
### Model 10A: No Interactions
```{r Model10A}
corrdisp<-Hmisc::rcorr(
  as.matrix(cbind(subset(crisis_smp, select=c(b_UCA,c_OffCri,cl_Ceil,
                                              cl_Days,n_Fixed,b_Intl)),
                  dummies::dummy(crisis_smp$Crisis),
                  dummies::dummy(crisis_smp$NoComp),
                  dummies::dummy(crisis_smp$Reach),
                  dummies::dummy(crisis_smp$Veh),
                  dummies::dummy(crisis_smp$Is.Defense),
                  dummies::dummy(crisis_smp$Simple))))
corrdisp[[1]]

#Sumamry plot
summary_discrete_plot(smp1m,"NAICS2",rotate_text=TRUE)


Term_Cons_10A <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 PricingFee+b_UCA+
                 b_Intl+
                   
                 # cl_def6_HHI_lag1:cl_Ceil+
                 #   Veh:cl_def6_HHI_lag1+
                 #   Veh:cl_Ceil+
                 #   PricingFee:cl_Ceil+
                 #   b_UCA:cl_def6_HHI_lag1+
                   Agency + NAICS2, family=binomial(link="logit"))
glmer_examine(Term_Cons_10A)




Term_Comp_10A <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   Veh+
                   PricingFee+b_UCA+
                 b_Intl+
                   
                   # Veh:cl_Ceil+
                   # PricingFee:cl_Ceil    +
                   # b_UCA:CompOffr+
                   Agency + NAICS2,
                 family=binomial(link="logit"))
glmer_examine(Term_Comp_10A)
  stargazer::stargazer(Term_Cons_07A2,Term_Cons_10A,Term_Comp_07A2,Term_Comp_10A,type="text",
                       digits=2)



summary_residual_compare(Term_Cons_07A2,Term_Cons_10A,Term_Comp_07A2,Term_Comp_10A,bins=20)


```
Removal of the interaction resulted in a comparatively small reduction in deviance and fairly minimal changes in residuals.


### Model 10B: Comp/Cons:Days
The next reintroduction is competition and days. The benefits of competition may reduce over time. We don't have firm expectations for consolidation, so leaving that out.
```{r Model10B}


#Sumamry plot
summary_continuous_plot(smp1m,"cl_Days","CompOffr")


Term_Cons_10B <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 PricingFee+b_UCA+
                 b_Intl+

                                      
                cl_def6_HHI_lag1:cl_Days+
                 # cl_def6_HHI_lag1:cl_Ceil+
                 #   Veh:cl_def6_HHI_lag1+
                 #   Veh:cl_Ceil+
                 #   PricingFee:cl_Ceil+
                 #   b_UCA:cl_def6_HHI_lag1+
                   Agency + NAICS2, family=binomial(link="logit"))
glmer_examine(Term_Cons_10B)



Term_Comp_10B <- glm (data=smp,
                      b_Term~CompOffr+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        CompOffr:cl_Days +
                       # Veh:cl_Ceil+
                   # PricingFee:cl_Ceil    +
                   # b_UCA:CompOffr+
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Comp_10B)

stargazer::stargazer(Term_Cons_10A,Term_Cons_10B,type="text",
                       digits=2)#,Term_Comp_10A,Term_Comp_10B



summary_residual_compare(Term_Cons_10A,Term_Cons_10B,bins=20)#,Term_Comp_10A,Term_Comp_10B



```

This combination encounters VIF problems for competition 
### Model 10C: Comp/Cons:Veh
The next reintroduction is competition and vehicle. Multi-award contracts in particular emphasize competition between the awardees which suggests that it may increase the benefits of competition.


```{r Model10C}


#Sumamry plot
summary_discrete_plot(smp1m,"Veh","cl_def6_HHI_lag1")
summary_discrete_plot(smp1m,"Veh","CompOffr")

#Create the model
Term_Cons_10C <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 PricingFee+b_UCA+
                 b_Intl+
                   
                cl_def6_HHI_lag1:cl_Days+
                  cl_def6_HHI_lag1:Veh+
                 # cl_def6_HHI_lag1:cl_Ceil+
                 #   Veh:cl_def6_HHI_lag1+
                 #   Veh:cl_Ceil+
                 #   PricingFee:cl_Ceil+
                 #   b_UCA:cl_def6_HHI_lag1+
                   Agency + NAICS2, family=binomial(link="logit"))
glmer_examine(Term_Cons_10C)



Term_Comp_10C <- glm (data=smp,
                      b_Term~CompOffr+
                        # cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        

                                                # CompOffr:cl_Days +
                                                CompOffr:Veh +
                       # Veh:cl_Ceil+
                   # PricingFee:cl_Ceil    +
                   # b_UCA:CompOffr+
                       
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Comp_10C)


  stargazer::stargazer(Term_Cons_10D,Term_Cons_10C,Term_Comp_10B,Term_Comp_10C,type="text",
                       digits=2)
  
  

summary_residual_compare(Term_Cons_10D,Term_Cons_10C,Term_Comp_10B,Term_Comp_10C,bins=20)


```
Competition and vehicle interactions do reduce deviance


Competition and vehicle results are interesting, but run afowl of VIF test. Consolidation is somewhat contrary to expectation and on the cusp of VIF problems, leaving it  out.

### Model 10D: Comp:Ceiling
The next reintroduction is competition and ceiling. Competition and ceiling might have a negative coefficient, because large contracts might encourage bid to win approaches. No expectations for consolidation, so leaving that out.
```{r Model10D}


#Sumamry plot
summary_continuous_plot(smp1m,"cl_Ceil","CompOffr")



Term_Comp_10D <- glm (data=smp,
                      b_Term~CompOffr+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        

                        
                        CompOffr:cl_Ceil 
  
                    # Veh:cl_Ceil+
                   # PricingFee:cl_Ceil    +
                   # b_UCA:CompOffr+
                    +
                       
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Comp_10D)


```
This interaction runs afowl of the VIF test on the competition side.





### Model 10E: UCA and Ceiling

Here the possible risk is similar to days, that larger, and thus possibly more complex projects, are at greater risk with UCA and that UCA and high ceiling estimate a higher chance of breaches.
Larger ceiling UCAs may run into bigger problems. The interaction of UCA and ceiling estimates a higher risk of breaches. 

```{r Model10E}


#Sumamry plot
summary_continuous_plot(smp1m,"l_Ceil","UCA")

#Create the model


Term_Cons_10E <- glm (data=smp,
                      b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                        cl_def6_HHI_lag1:cl_Days+
                        # cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        b_UCA:cl_Ceil+
                        # Veh:cl_def6_HHI_lag1+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Cons_10E)


Term_Comp_10E <- glm (data=smp,
                      b_Term~CompOffr+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
  
                        b_UCA:cl_Ceil+
                       # Veh:CompOffr+
                       
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Comp_10E)



  stargazer::stargazer(Term_Cons_10B,Term_Cons_10E,Term_Comp_10A,Term_Comp_10E,type="text",
                       digits=2)
  
  

summary_residual_compare(Term_Cons_10B,Term_Cons_10E,Term_Comp_10A,Term_Comp_10E,bins=20)


```
The result runs contrary to expectation, but notably reduces by over 10 points in each case and is largely a wash when it comes to residuals. Leaving it in. One possible rationale is that small UCAs may raise risks because they are under less scrutiny.

The results are counter-intuitive but strong. Based on the descriptive statistics it appears that  mid-range, not the largest UCAs, have the great risk of breaches.

### Model 10F: Comp/Cons:UCA
Starting with Competition and UCA. It's strong in both models and thus a natural starting point.
```{r Model10F}
#Sumamry plot
summary_continuous_plot(smp1m,"cl_def6_HHI_lag1","UCA")
summary_discrete_plot(smp1m,"CompOffr","UCA")


#Create the model
Term_Cons_10F <- glm (data=smp,
                      b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                        cl_def6_HHI_lag1:cl_Days+
                        # cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        b_UCA:cl_Ceil+
                        # Veh:cl_def6_HHI_lag1+
                        b_UCA:cl_def6_HHI_lag1 +
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Cons_10F)


Term_Comp_10F <- glm (data=smp,
                      b_Term~CompOffr+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:CompOffr +
                        b_UCA:cl_Ceil+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Comp_10F,display=TRUE)

  stargazer::stargazer(Term_Cons_10E,Term_Cons_10F,Term_Comp_10E,Term_Comp_10F,type="text",
                       digits=2)
  
  

summary_residual_compare(Term_Comp_10E,Term_Comp_10F,Term_Cons_10E,Term_Cons_10F,bins=20)


```
The interaction is significant and competion has a powerful affect on reducing the risks of UCA. In diagnostic terms, the residuals for ceiling breaches get a little worse, but the change is marginal.


The interaction is significant and competion / low levels of consolidation estimates lower risks associated with UCAs. 

### Model 10G: Pricing and Average Wage
Fixed Price is less  appropriate as an approach when there is greater uncertainty. A phenomenon likely to extend to time and materials / labor hours contracts. By comparison, fixed price incentive and cost based should estimate a lower risk of ceiling breaches and terminations.

Average wage is a proxy for unobserved skill requirements, which in turn is a proxy for complexity. Fixed price contracting may run afoul of in these sectors, due to the greater difficulties of prediction. Labor hours/t&M, will likely are expected to estimate lower risk of problems, but not as low as cost-based. Incentive fee and cost-based are both expected to lower the estimated risk fo breaches.

```{r Model10G}


#Sumamry plot
summary_continuous_plot(smp1m,"cl_US6_avg_sal_lag1","PricingFee")


#Create the model


Term_Cons_10G <- glm (data=smp,
                      b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
             
                        cl_def6_HHI_lag1:cl_Days+
                        b_UCA:cl_Ceil+
                        b_UCA:cl_def6_HHI_lag1 +
                       PricingFee:cl_US6_avg_sal_lag1+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Cons_10G)


Term_Comp_10G <- glm (data=smp,
                      b_Term~CompOffr+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
               b_UCA:CompOffr +
                        b_UCA:cl_Ceil+
           
                       PricingFee:cl_US6_avg_sal_lag1+
                       
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Comp_10G)


  stargazer::stargazer(Term_Cons_10F,Term_Cons_10G,Term_Comp_10F,Term_Comp_10G,type="text",
                       digits=2)
  
  

summary_residual_compare(Term_Cons_10F,Term_Cons_10G,Term_Comp_10F,Term_Comp_10G,bins=20)


```
The results run contrary to expectation and are only barely significant for other fixed-price. Leaving this out.

### Model 10H: Def Sec Obl:HHI
Because HHI in smaller sectors tends to be larger, high readings from large sectors may deserve more weight. This interaction is expected to amplify HHI magnitudes.

Whether consolidation has positive or negative effets, these should be stronger for larger sectors, as size tends to dilute HHI. The interaction should estimate a significant change in the likelihood of breaches. While the hypothesis allows for both efficiencies and the downsides of monopoly to arrive from consolidation, the study team expects that the interaction with sector size will positively estimate ceiling breaches, as the efficiency may apply just as well in small sectors.

For competition, a larger base of traditional suppliers may ease selection.

```{r Model10H}


#Sumamry plot
summary_continuous_plot(smp1m,"cl_US6_avg_sal_lag1","PricingFee")


#Create the model


Term_Cons_10H <- glm (data=smp,
                      b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                                     
                        cl_def6_HHI_lag1:cl_Days+
                        b_UCA:cl_Ceil+
                        b_UCA:cl_def6_HHI_lag1 +
                       PricingFee:cl_US6_avg_sal_lag1+
                        cl_def6_HHI_lag1:cl_def6_obl_lag1  +

                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Cons_10H)


Term_Comp_10H <- glm (data=smp,
                      b_Term~CompOffr+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
               b_UCA:CompOffr +
                        b_UCA:cl_Ceil+
           
                       PricingFee:cl_US6_avg_sal_lag1+
                        CompOffr:cl_def6_obl_lag1  +
                       
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Comp_10H)



  stargazer::stargazer(Term_Cons_10G,Term_Cons_10H,type="text",
                       digits=2)
  
  

summary_residual_compare(Term_Cons_10G,Term_Cons_10H,bins=20)


```
Results are partially significant and somewhat in line with  expectations. Leaving it in for now.

Competition violates VIF.

### Model 10I: Ratio6:HHI
Because HHI in smaller sectors tends to be larger, high readings from large sectors may deserve more weight. This interaction is expected to amplify HHI magnitudes.



When there is a larger market available, consolidation may matter less, for better or wrose. Thus interaction of consolidation and ratio will estimate greater magnitude than HHI index on its own. Per the hypothesis, this does not necessarily. 

For competition, the effects may be greatest outside of a monospy context, thus the competition will estimate a lower occurance of ceiling breaches but the interaction of competition and ratio will estimate a higher rate.

```{r Model10I}


#Sumamry plot
summary_continuous_plot(smp1m,"cl_US6_avg_sal_lag1","PricingFee")


#Create the model


Term_Cons_10I <- glm (data=smp,
                      b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
 
                                     
                        cl_def6_HHI_lag1:cl_Days+
                        b_UCA:cl_Ceil+
                        b_UCA:cl_def6_HHI_lag1 +
                       PricingFee:cl_US6_avg_sal_lag1+
                        cl_def6_HHI_lag1:cl_def6_obl_lag1  +

                      cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Cons_10I)



Term_Comp_10I <- glm (data=smp,
                      b_Term~CompOffr+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
               b_UCA:CompOffr +
                        b_UCA:cl_Ceil+
           
                       PricingFee:cl_US6_avg_sal_lag1+
                        CompOffr:cl_def6_obl_lag1  +
                       
                        CompOffr:cl_def6_ratio_lag1  +
                 
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Comp_10I)



Term_Comp_10I2 <- glm (data=smp,
                      b_Term~CompOffr+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
               b_UCA:CompOffr +
                        b_UCA:cl_Ceil+
           
                       PricingFee:cl_US6_avg_sal_lag1+
                        # CompOffr:cl_def6_obl_lag1  +
                       
                        CompOffr:cl_def6_ratio_lag1  +
                 
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Comp_10I2)



  stargazer::stargazer(Term_Cons_10H,Term_Cons_10I,Term_Comp_10H,Term_Comp_10I2,type="text",
                       digits=2)
  
  

summary_residual_compare(Term_Cons_10D,Term_Cons_10I,bins=20)
summary_residual_compare(Term_Cons_10H,Term_Cons_10I,bins=20)


```
VIF problems for comp. For Cons, it's not sigificant or in line with expectations leavening out.




### Model 10J: Ratio3:HHI
Because HHI in smaller sectors tends to be larger, high readings from large sectors may deserve more weight. This interaction is expected to amplify HHI magnitudes.



When there is a larger market available, consolidation may matter less, for better or wrose. Thus interaction of consolidation and ratio will estimate greater magnitude than HHI index on its own. Per the hypothesis, this does not necessarily. 

For competition, the effects may be greatest outside of a monospy context, thus the competition will estimate a lower occurance of ceiling breaches but the interaction of competition and ratio will estimate a higher rate.

```{r Model10J}


#Sumamry plot
summary_continuous_plot(smp1m,"cl_US3_avg_sal_lag1","PricingFee")


#Create the model


Term_Cons_10J <- glm (data=smp,
                      b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
 
                                     
                        cl_def6_HHI_lag1:cl_Days+
                        b_UCA:cl_Ceil+
                        b_UCA:cl_def6_HHI_lag1 +
                       PricingFee:cl_US6_avg_sal_lag1+
                        cl_def6_HHI_lag1:cl_def6_obl_lag1  +
# cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                      cl_def3_HHI_lag1:cl_def3_ratio_lag1+
                        
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Cons_10J,display=TRUE)



Term_Comp_10J <- glm (data=smp,
                      b_Term~CompOffr+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
               b_UCA:CompOffr +
                        b_UCA:cl_Ceil+
           
                       PricingFee:cl_US6_avg_sal_lag1+
                        CompOffr:cl_def6_obl_lag1  +
                       
                        CompOffr:cl_def3_ratio_lag1  +
                 
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Comp_10J)



Term_Comp_10J2 <- glm (data=smp,
                      b_Term~CompOffr+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
               b_UCA:CompOffr +
                        b_UCA:cl_Ceil+
           
                       PricingFee:cl_US6_avg_sal_lag1+
                        # CompOffr:cl_def6_obl_lag1  +
                       
                        CompOffr:cl_def3_ratio_lag1  +
                 
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Comp_10J2)


  stargazer::stargazer(Term_Cons_10H,Term_Cons_10I,Term_Cons_10J,type="text",
                       digits=2)
  
  
summary_residual_compare(Term_Cons_10I,Term_Cons_10J,bins=20)
summary_residual_compare(Term_Cons_10H,Term_Cons_10J,bins=20)


```
Comp excluded by VIF. Keeping for Cons.

### Model 10K: Pricing and Ceilng
```{r Model10H}


#Sumamry plot
summary_continuous_plot(smp1m,"cl_US6_avg_sal_lag1","PricingFee")


#Create the model


Term_Cons_10K <- glm (data=smp,
                      b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                     
                        cl_def6_HHI_lag1:cl_Days+
                        b_UCA:cl_Ceil+
                        b_UCA:cl_def6_HHI_lag1 +
                       PricingFee:cl_US6_avg_sal_lag1+
                        cl_def6_HHI_lag1:cl_def6_obl_lag1  +  
                     # Veh:cl_Ceil+               
                   PricingFee:cl_Ceil+
                   Agency + NAICS2, family=binomial(link="logit"))
glmer_examine(Term_Cons_10K)



Term_Comp_10K <- glm (data=smp,
                      b_Term~CompOffr+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
               b_UCA:CompOffr +
                        b_UCA:cl_Ceil+
                   # Veh:cl_Ceil+
                   PricingFee:cl_Ceil    +
                       PricingFee:cl_US6_avg_sal_lag1+
                       
                        Agency+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Comp_10K)



  stargazer::stargazer(Term_Cons_10H,Term_Cons_10K,Term_Comp_10G,Term_Comp_10K,type="text",
                       digits=2)
  
  

summary_residual_compare(Term_Cons_10H,Term_Cons_10K,Term_Comp_10G,Term_Comp_10K,bins=20)
  

```

### Model 10L: Trimming back
Looking at taking out interactions again after looking at 13D results. This would take us back to 10A for comp, no interactions.

```{r Term10L}
Term_Cons_10L <- glm (data=smp,
                        b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                          #cl_US3_avg_sal_lag1+
                          cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                          cl_US6_avg_sal_lag1+     
                          cl_Ceil + cl_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                          cl_def6_HHI_lag1:cl_Days+
                          # b_UCA:cl_Ceil+
                          # b_UCA:cl_def6_HHI_lag1 +
                          # PricingFee:cl_US6_avg_sal_lag1+
                          cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                          # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                          cl_def3_HHI_lag1:cl_def3_ratio_lag1+
                          Agency + NAICS2, family=binomial(link="logit"))
glmer_examine(Term_Comp_10L)

  stargazer::stargazer(Term_Cons_10A,Term_Cons_10F,Term_Cons_10J,Term_Cons_10L,Term_Comp_10A,Term_Comp_10F,Term_Comp_10G,type="text",
                       digits=2)

```

Benefits are fairly small and not in line with expectations.



### Model 10M: Both
```{r Term10M}
Term_Comp_Cons_10M<- glm (data=smp,
                        b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                          #cl_US3_avg_sal_lag1+
                          cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                          cl_US6_avg_sal_lag1+     
                        CompOffr+
                          cl_Ceil + cl_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                          cl_def6_HHI_lag1:cl_Days+
                          # b_UCA:cl_Ceil+
                          # b_UCA:cl_def6_HHI_lag1 +
                          # PricingFee:cl_US6_avg_sal_lag1+
                          cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                          # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                          cl_def3_HHI_lag1:cl_def3_ratio_lag1+
                          Agency + NAICS2, family=binomial(link="logit"))
glmer_examine(Term_Comp_Cons_10M)

  stargazer::stargazer(Term_Cons_10L,Term_Comp_10A,Term_Comp_Cons_10M,type="text",
                       digits=2)

```



### Model 10N: Interaction of Competition and Concentration
```{r Term10N}
Term_Comp_Cons_10N <- glm (data=smp,
                        b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                          #cl_US3_avg_sal_lag1+
                          cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                          cl_US6_avg_sal_lag1+     
                        CompOffr+
                        CompOffr:cl_def6_HHI_lag1+
                          cl_Ceil + cl_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                          cl_def6_HHI_lag1:cl_Days+
                          # b_UCA:cl_Ceil+
                          # b_UCA:cl_def6_HHI_lag1 +
                          # PricingFee:cl_US6_avg_sal_lag1+
                          cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                          # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                          cl_def3_HHI_lag1:cl_def3_ratio_lag1+
                          Agency + NAICS2, family=binomial(link="logit"))
glmer_examine(Term_Comp_Cons_10N)


Term_Comp_Cons_10N2 <- glm (data=smp,
                        b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                          #cl_US3_avg_sal_lag1+
                          cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                          cl_US6_avg_sal_lag1+     
                        CompOffr+
                        CompOffr:cl_def6_HHI_lag1+
                          cl_Ceil + cl_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                          # cl_def6_HHI_lag1:cl_Days+
                          # b_UCA:cl_Ceil+
                          # b_UCA:cl_def6_HHI_lag1 +
                          # PricingFee:cl_US6_avg_sal_lag1+
                          cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                          # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                          cl_def3_HHI_lag1:cl_def3_ratio_lag1+
                          Agency + NAICS2, family=binomial(link="logit"))
glmer_examine(Term_Comp_Cons_10N2)



Term_Comp_Cons_10N3 <- glm (data=smp,
                        b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                          #cl_US3_avg_sal_lag1+
                          cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                          cl_US6_avg_sal_lag1+     
                        CompOffr+
                        CompOffr:cl_def6_HHI_lag1+
                          cl_Ceil + cl_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                          # cl_def6_HHI_lag1:cl_Days+
                          # b_UCA:cl_Ceil+
                          # b_UCA:cl_def6_HHI_lag1 +
                          # PricingFee:cl_US6_avg_sal_lag1+
                          # cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                          # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                          cl_def3_HHI_lag1:cl_def3_ratio_lag1+
                          Agency + NAICS2, family=binomial(link="logit"))
glmer_examine(Term_Comp_Cons_10N3)


Term_Comp_Cons_10N3 <- glm (data=smp,
                        b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                          #cl_US3_avg_sal_lag1+
                          cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                          cl_US6_avg_sal_lag1+     
                        CompOffr+
                        CompOffr:cl_def6_HHI_lag1+
                          cl_Ceil + cl_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                          # cl_def6_HHI_lag1:cl_Days+
                          # b_UCA:cl_Ceil+
                          # b_UCA:cl_def6_HHI_lag1 +
                          # PricingFee:cl_US6_avg_sal_lag1+
                          # cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                          # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                          cl_def3_HHI_lag1:cl_def3_ratio_lag1+
                          Agency + NAICS2, family=binomial(link="logit"))
glmer_examine(Term_Comp_Cons_10N3)


Term_Comp_Cons_10N4 <- glm (data=smp,
                        b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                          #cl_US3_avg_sal_lag1+
                          cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                          cl_US6_avg_sal_lag1+     
                        CompOffr+
                        CompOffr:cl_def3_HHI_lag1+
                          cl_Ceil + cl_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                          # cl_def6_HHI_lag1:cl_Days+
                          # b_UCA:cl_Ceil+
                          # b_UCA:cl_def6_HHI_lag1 +
                          # PricingFee:cl_US6_avg_sal_lag1+
                          # cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                          # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                          cl_def3_HHI_lag1:cl_def3_ratio_lag1+
                          Agency + NAICS2, family=binomial(link="logit"))
glmer_examine(Term_Comp_Cons_10N4)


Term_Comp_Cons_10N5 <- glm (data=smp,
                        b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                          #cl_US3_avg_sal_lag1+
                          cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                          cl_US6_avg_sal_lag1+     
                        CompOffr+
                        CompOffr:cl_def3_HHI_lag1+
                          cl_Ceil + cl_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                          # cl_def6_HHI_lag1:cl_Days+
                          # b_UCA:cl_Ceil+
                          # b_UCA:cl_def6_HHI_lag1 +
                          # PricingFee:cl_US6_avg_sal_lag1+
                          # cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                          # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                          # cl_def3_HHI_lag1:cl_def3_ratio_lag1+
                          Agency + NAICS2, family=binomial(link="logit"))
glmer_examine(Term_Comp_Cons_10N5)



  stargazer::stargazer(Term_Cons_10L,Term_Comp_10A,Term_CoM,s_10NTerm_Cons_10N,type="text",
                       digits=2)

```
Every variant left VIF problem, so leaving that interaction out.


#Multi-Level Model


##   NAICS2 & Agency
### Model 11A: No interactions
This model runs comparatively fast because it only deals in the agency and NAICS2, the broadest categories. The study team initially feared that only this level of analysis might work when it comes to avoiding convergence errors, but subsequent research ( https://rdrr.io/cran/lme4/man/convergence.html ) revealed that large datasets can be a source of false positive warnings.
```{r Model11A}
#Frequency Plot
summary_discrete_plot(smp,"NAICS2")

#This is currently running at home

Term_Cons_11A <- glmer (data=smp,
                        b_Term ~cl_def6_HHI_lag1 +cl_def6_ratio_lag1+cl_def6_obl_lag1+
                          cl_US6_avg_sal_lag1+
                          cl_Ceil + cl_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                         
                          
                          # cl_def6_HHI_lag1:cl_def6_obl_lag1+ 
                          # b_UCA:cl_def6_HHI_lag1 + 
                          # b_UCA:cl_Ceil+

                          (1 | NAICS2) + (1 | Agency)
                        
                        , family=binomial(link="logit"),
                        verbose=1)

glmer_examine(Term_Cons_11A)

Term_Comp_11A <- glmer (data=smp,
                      b_Term ~n_Comp +
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        cl_Ceil + cl_Days+
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                    
                        # b_UCA:n_Comp +
                        # b_UCA:cl_Ceil+

                   (1 | NAICS2) + (1 | Agency)

                   , family=binomial(link="logit"),
                  verbose=1)

glmer_examine(Term_Comp_11A)


any(diag.vals<1e-6)
Term_Comp_11A.devfun<-devfun
if(!exists("Term_Comp_11A.devfun"))
  Term_Comp_11A.devfun <- update(Term_Comp_11A, devFunOnly=TRUE)

if (isLMM(Term_Comp_11A)) {
  pars <- getME(Term_Comp_11A,"theta")
} else {
  ## GLMM: requires both random and fixed parameters
  pars <- getME(Term_Comp_11A, c("theta","fixef"))
}
if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(Term_Comp_11A.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(Term_Comp_11A.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
Term_Comp_11A@optinfo$derivs

if(!exists("Term_Comp_11A.restart"))
  Term_Comp_11A.restart <- update(Term_Comp_11A, start=pars)
glmer_examine(Term_Comp_11A.restart)



stargazer::stargazer(Term_Cons_11A,Term_Comp_11A.restart,Term_Comp_11A.restart
                     ,type="text",
                       digits=2)

summary_residual_compare(Term_Cons_07B2,Term_Cons_11A,Term_Comp_07B2,Term_Comp_07C3,bins=20)
summary_residual_compare(Term_Cons_11A,Term_Cons_11A,Term_Comp_11A,Term_Comp_11A.restart,bins=20)
save(Term_Cons_11A,Term_Comp_11A.restart,Term_Comp_11A.devfun,Term_Comp_11A.restart,file="output/Term_11.rdata")

```

### Model 11B: Agency/Office & NAICS2

The North American Industrial Classification system captures the sector of each contract, which are each given a seperate intercept in the model.

```{r Model11B}

#Frequency Plot
summary_discrete_plot(smp,"NAICS2")


Term_Cons_11B <- glmer (data=smp,
                        b_Term ~cl_def6_HHI_lag1 +cl_def6_ratio_lag1+cl_def6_obl_lag1+
                          cl_US6_avg_sal_lag1+
                          cl_Ceil + cl_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                         
                          
                          cl_def6_HHI_lag1:cl_def6_obl_lag1+ 
                          b_UCA:cl_def6_HHI_lag1 + 
                          b_UCA:cl_Ceil+

                          (1 | NAICS2) + (1 | Agency/Office)
                        
                        , family=binomial(link="logit"),
                        verbose=1)

glmer_examine(Term_Cons_11B)

save(Term_Cons_11B,file="Output//Term_Cons_11B.rdata")
Term_Comp_11B <- glmer (data=smp,
                      b_Term ~n_Comp +
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        cl_Ceil + cl_Days+
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                    
                        b_UCA:n_Comp +
                        b_UCA:cl_Ceil+

                   (1 | NAICS2) + (1 | Agency/Office)

                   , family=binomial(link="logit"),
                  verbose=1)

# glmer_examine(Term_Comp_11B)
#Ran for two hours Model failed to converge with max|grad| = 0.186396 (tol = 0.001, component 1)
# Plot the model and Vehicle 
# Term_Comp_11B_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,UCA,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         UCA*Comp) %*%  coef(Term_Comp_11B))}
# 
# #Days curves
# fitted_Term_model(smp,"SIDV") +
#   stat_function(fun = Term_Comp_11B_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1,UCA=0),color="blue")+
#   stat_function(fun = Term_Comp_11B_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1,UCA=0),color="blue")


```

The initial attempt to include the pre-existing intercepts and all inputs resulted in a model that initially failed to converge. Conservatively the intercepts have been temporarily removed to be added back in a subsequent step.



Unfortunately, after including Start Fiscal Year, the model again failed to converge. The standard deviation of Who is 0 while it is notably higher for determining the slope of competition via PSR and for Start Fiscal Year. This suggests that who is adding little to the model and that it is time to go back to model 6C as a starter.



After the incorporation of NAICS intercepts, ceiling related interactions had strange consequences (left out for speed of running RMD reasons). The interaction of Competition and Ceiling, even when introduced alone  had a positive coefficient and removed the effect of Ceiling by itself. When all three interactions were included,  Ceiling and Duration similarly had a notable negative coefficient, which seemed contrary to past literature that suggests greater risks when trying to do a large contract too fast. The interaction of competition and days had a positive coefficient, but was not significant. Single Award IDV does have a significant negative coefficient in interaction with Competition, but the other two types do not and the model fails to converge (with the 250k or 1m sample) and exhibit a peak at the lower end of the residuals.

## Agency/Office & NAICS6
###Model 12A: Too many Interactions
This initial run proved a bit premature, as incorporation of Agency as a dummy variable showed that many of the interactions included.
```{r Model12A}
load(file="Output//Term_Cons_12A.rdata")

if(!exists("Term_Cons_12A"))
  Term_Cons_12A <- glmer (data=smp,
                          b_Term ~cl_def6_HHI_lag1 +cl_def6_ratio_lag1+cl_def6_obl_lag1+
                            cl_US6_avg_sal_lag1+cl_def6_HHI_lag1:cl_def6_obl_lag1+ 
                            cl_Ceil + cl_Days+ 
                            Veh +
                            PricingFee + b_UCA +
                            b_Intl+
                            # Who+ Who is missing
                           
                            Veh:cl_Days+
                            
                            
                            cl_Ceil:PricingFee+
                            
                            b_UCA:cl_def6_HHI_lag1 + 
                            b_UCA:cl_Ceil+
                            # 6
                            
                            # Who:b_Intl+
                            (1 | NAICS) + (1 | Agency/Office)
                          , family=binomial(link="logit"),
                          verbose=1)
glmer_examine(Term_Cons_12A)

# Term_Comp_12A <- glmer (data=smp,
#                       b_Term ~n_Comp +
#                         cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
#                         cl_Ceil + cl_Days+ 
#                         Veh  +
#                         PricingFee+ b_UCA +
#                         b_Intl+
                        # Who+ Who is missing
                       
                        # Veh:cl_Days+
                        
                        # 
                        # cl_Ceil:PricingFee+
                        # 
                        # b_UCA:cl_def6_HHI_lag1 + 
                        # b_UCA:cl_Ceil+
                        # 6
                        
                       # Who:b_Intl+
#                    (1 | NAICS) + (1 | Agency/Office)
#                       , family=binomial(link="logit"),
                  # verbose=1)
# glmer_examine(Term_Comp_12A)
# glmer_examine(Term_Comp_12A)
# failure to converge in 10000 evaluation
summary_residual_compare(Term_Cons_07B2,Term_Cons_12A,Term_Comp_07B2,Term_Comp_07C3,bins=20)
save(Term_Cons_12A,file="Output//Term_Cons_12A.rdata")
```

The initial attempt to include the pre-existing intercepts and all inputs resulted in a model that initially failed to converge. Conservatively the intercepts have been temporarily removed to be added back in a subsequent step.

### Model 12B: Trimmed 
```{r Model12B}
#Frequency Plot
summary_discrete_plot(smp,"NAICS")

#This is currently running at home

Term_Cons_12B <- glmer (data=smp,
                        b_Term ~cl_def6_HHI_lag1 +cl_def6_ratio_lag1+cl_def6_obl_lag1+
                          cl_US6_avg_sal_lag1+
                          cl_Ceil + cl_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                         
                          
                          cl_def6_HHI_lag1:cl_def6_obl_lag1+ 
                          b_UCA:cl_def6_HHI_lag1 + 
                          b_UCA:cl_Ceil+

                          (1 | NAICS) + (1 | Agency/Office)
                        
                        , family=binomial(link="logit"),
                        verbose=1)

glmer_examine(Term_Cons_12B)

Term_Comp_12B <-  glmer (data=smp,
                      b_Term ~n_Comp +
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        cl_Ceil + cl_Days+
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                    
                        b_UCA:n_Comp +
                        b_UCA:cl_Ceil+

                   (1 | NAICS) + (1 | Agency/Office)

                   , family=binomial(link="logit"),
                  verbose=1)

glmer_examine(Term_Comp_12B)
save(Term_Comp_12B,file="Term_Comp_12B.rdata")
summary_residual_compare(Term_Cons_07B2,Term_Cons_12B,Term_Comp_07B2,Term_Comp_07C3,bins=20)
```

## Agency/Office & NAICS3/6
###Model 13A: Agency/Office+NAICS6/NAICS3
The North American Industrial Classification system captures the sector of each contract, which are each given a seperate intercept in the model.
```{r Model13A}
load(file="Output//Term_Cons_13A.rdata")

if(!exists("Term_Cons_13A"))
  Term_Cons_13A <- glmer (data=smp,
                          b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                            #cl_US3_avg_sal_lag1+
                            cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                            cl_US6_avg_sal_lag1+
                            cl_Ceil + cl_Days+ 
                            Veh +
                            PricingFee + b_UCA +
                            b_Intl+
                            # Who+
                           
                            Veh:cl_Days+
                            
                            Veh:cl_Ceil+
                            cl_Ceil:PricingFee+
                            cl_def6_HHI_lag1:cl_def6_obl_lag1+
                            b_UCA:cl_def6_HHI_lag1 + 
                            b_UCA:cl_Ceil+
                            # 6
                            b_Intl:Veh+ 
                            (1 | NAICS3/NAICS) + 
                            (1 | Agency/Office) 
                          # Who:b_Intl+
                          # NAICS2
                          , family=binomial(link="logit"),
                          verbose=1)


glmer_examine(Term_Cons_13A,display=TRUE)

save(Term_Cons_13A,file="Output//Term_Cons_13A.rdata")
```

###Model 13B: Agency/Office+NAICS6/NAICS3 trimmed
```{r Model13B}
load("Output//Term_Cons_13B.rdata")

Term_Cons_13B <- glmer (data=smp,
                        b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                          #cl_US3_avg_sal_lag1+
                          cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                          cl_US6_avg_sal_lag1+
                          cl_Ceil + cl_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                          b_UCA:cl_def6_HHI_lag1 + 
                          b_UCA:cl_Ceil+
                          cl_def6_HHI_lag1:cl_def6_obl_lag1+
                          
                          (1 | NAICS3/NAICS) + 
                          (1 | Agency/Office), 
                        family=binomial(link="logit"),
                        verbose=1)

glmer_examine(Term_Cons_13B,display=TRUE)

save(Term_Cons_13B,file="Output//Term_Cons_13B.rdata")

Term_Comp_13B <- glmer (data=smp,
                        b_Term ~n_Comp+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                          n_Comp+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                          cl_Ceil + cl_Days+
                          Veh  +
                          PricingFee+
                          b_UCA +
                          b_Intl+

                          b_UCA:n_Comp +
                          b_UCA:cl_Ceil+
                          
                          (1 | NAICS3/NAICS) + (1 | Agency/Office)
                        , family=binomial(link="logit"),
                        verbose=1)
glmer_examine(Term_Comp_13B)
save(Term_Cons_13B,Term_Comp_13B,file="Output//Term_Cons_13B.rdata")

  stargazer::stargazer(Term_Cons_13B,Term_Comp_13B,type="text",
                       digits=2)
  
  

summary_residual_compare(Term_Cons_11A,Term_Cons_13B,Term_Comp_11A.restart,Term_Comp_13B,bins=20)



any(diag.vals<1e-6)

if(!exists("Term_Cons_13B.devfun"))
  Term_Cons_13B.devfun <- update(Term_Cons_13B, devFunOnly=TRUE)

if (isLMM(Term_Cons_13B)) {
  pars <- getME(Term_Cons_13B,"theta")
} else {
  ## GLMM: requires both random and fixed parameters
  pars <- getME(Term_Cons_13B, c("theta","fixef"))
}
if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(Term_Cons_13B.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(Term_Cons_13B.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
Term_Cons_13B@optinfo$derivs

if(!exists("Term_Cons_13B.restart"))
  Term_Cons_13B.restart <- update(Term_Cons_13B, start=pars)
glmer_examine(Term_Cons_13B.restart)




#CBre Comp
if(!exists("Term_Comp_13B.devfun"))
  Term_Comp_13B.devfun <- update(Term_Comp_13B, devFunOnly=TRUE)

if (isLMM(Term_Comp_13B)) {
  pars <- getME(Term_Comp_13B,"theta")
} else {
  ## GLMM: requires both random and fixed parameters
  pars <- getME(Term_Comp_13B, c("theta","fixef"))
}
if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(Term_Comp_13B.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(Term_Comp_13B.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
Term_Comp_13B@optinfo$derivs

if(!exists("Term_Comp_13B.restart"))
  Term_Comp_13B.restart <- update(Term_Comp_13B, start=pars)
glmer_examine(Term_Comp_13B.restart)


  save(Term_Cons_13B,Term_Comp_13B,Term_Cons_13B.restart,Term_Comp_13B.restart,
       file="Output//Term_Cons_13B.rdata")
  
stargazer::stargazer(Term_Cons_11A,Term_Cons_13B,Term_Cons_13B.restart,Term_Comp_11A.restart,Term_Comp_13B,type="text",
                       digits=2)





  save(Term_Cons_13B,Term_Comp_13B,Term_Cons_13B.restart,
       file="Output//Term_Cons_13B.rdata")
load("Output//Term_Comp_13B.rdata")

  summary_residual_compare(Term_Cons_13B,Term_Cons_13B.restart,Term_Comp_11A.restart,Term_Comp_13B,bins=20)


  source(system.file("utils", "allFit.R", package="lme4"))
  Term_Cons_13C.all <- allFit(Term_Cons_13C)
  ss_cons <- summary(Term_Cons_13C.all)

  fm1.all <- allFit(Term_Comp_13C)
  ss_comp <- summary(Term_Comp_13C.all)
```
Ceiling:UCA runs into a VIF problem.

###Model 13C: Agency/Office+NAICS6/NAICS3 Competition Update
```{r Model13C}
load("Output//Term_Comp_13C.rdata")


Term_Comp_13C <- glmer (data=smp,
                        b_Term ~CompOffr+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                          cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                          cl_Ceil + cl_Days+
                          Veh  +
                          PricingFee+
                          b_UCA +
                          b_Intl+

                          b_UCA:CompOffr + #was b_UCA:n_Comp when ran, which was a mistake.
                          b_UCA:cl_Ceil+
                          
                          (1 | NAICS3/NAICS) + (1 | Agency/Office)
                        , family=binomial(link="logit"),
                        verbose=1)
glmer_examine(Term_Comp_13C)
save(Term_Comp_13C,file="Output//Term_Comp_13C.rdata")

  stargazer::stargazer(Term_Cons_13B,Term_Comp_13B,Term_Comp_13C,type="text",
                       digits=2)
  
  

summary_residual_compare(Term_Cons_11A,Term_Cons_13B,Term_Comp_11A.restart,Term_Comp_13B,bins=20)




  save(Term_Cons_13B,Term_Comp_13B,Term_Cons_13B.restart,
       file="Output//Term_Cons_13B.rdata")
load("Output//Term_Comp_13B.rdata")

  summary_residual_compare(Term_Cons_13B,Term_Cons_13B.restart,Term_Comp_11A.restart,Term_Comp_13B,bins=20)


  source(system.file("utils", "allFit.R", package="lme4"))
  Term_Cons_13C.all <- allFit(Term_Cons_13C)
  ss_cons <- summary(Term_Cons_13C.all)

  fm1.all <- allFit(Term_Comp_13C)
  ss_comp <- summary(Term_Comp_13C.all)
```

### Model 13D: Integrating interactions from 10. (Except 10J, oops!)
```{r 13D_Interactions}
load(file="Output//Term_Cons_13D.rdata")

Term_Cons_13D <- glmer (data=smp,
                      b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
 
                                     
                        cl_def6_HHI_lag1:cl_Days+
                        b_UCA:cl_Ceil+
                        b_UCA:cl_def6_HHI_lag1 +
                       PricingFee:cl_US6_avg_sal_lag1+
                        cl_def6_HHI_lag1:cl_def6_obl_lag1  +

                      cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                        
                                                (1 | NAICS3/NAICS) + (1 | Agency/Office)
                      , family=binomial(link="logit"))
glmer_examine(Term_Cons_13D)
save(Term_Cons_13D,file="Output//Term_Cons_13D.rdata")

load(file="Output//Term_Comp_13D.rdata")
Term_Comp_13D <- glmer (data=smp,
                        b_Term~CompOffr+
                          cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                          cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                          
                          cl_Ceil + cl_Days+ 
                          Veh  +
                          PricingFee+ b_UCA +
                          b_Intl+
                          
                          b_UCA:CompOffr +
                          b_UCA:cl_Ceil+
                          
                          PricingFee:cl_US6_avg_sal_lag1+
                          
                          (1 | NAICS3/NAICS) + (1 | Agency/Office),
                        family=binomial(link="logit"))
glmer_examine(Term_Comp_13D)
save(Term_Comp_13D,file="Output//Term_Comp_13D.rdata")

stargazer::stargazer(Term_Cons_13B,Term_Cons_13D,
                     Term_Comp_13C,Term_Comp_13D,
                     type="text",
                       digits=2)
  
  vif(Term_Comp_13D)

```

### Model 13E: Trimming back those that weren't high value added in  13D
Dropping a few from 13E and adding back in cl_def3_HHI_lag1:cl_def3_ratio_lag1 which was accidentally dropped. 

* b_UCA:cl_Ceil: Is not significant and is not in line with expectations.
* PricingFee:cl_US6_avg_sal_lag1: Only partially in line with expectations, and leaves most of the base inputs insignificant.

First test, with term_comp_13E, tok  a risk by leaving in b_UCA:CompOffr. It  is at least in line with expectations, if mostly not significant. Removing ceiling might have helped  This risk did not pay off and a negative eigen value resulted.

```{r 13E_Interactions}
load(file="Output//Term_Cons_13E.rdata")




Term_Cons_13E <- glmer (data=smp,
                        b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                          #cl_US3_avg_sal_lag1+
                          cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                          cl_US6_avg_sal_lag1+     
                          cl_Ceil + cl_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                          cl_def6_HHI_lag1:cl_Days+
                          # b_UCA:cl_Ceil+
                          # b_UCA:cl_def6_HHI_lag1 +
                          # PricingFee:cl_US6_avg_sal_lag1+
                          cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                          # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                          cl_def3_HHI_lag1:cl_def3_ratio_lag1+  
                          
                          (1 | NAICS3/NAICS) + (1 | Agency/Office),
                        family=binomial(link="logit"))
glmer_examine(Term_Cons_13E)
save(Term_Cons_13E,file="Output//Term_Cons_13E.rdata")

# load(file="Output//Term_Comp_13E.rdata")
# Term_Comp_13E <- glmer (data=smp,
#                         b_Term~CompOffr+
#                           cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
#                           cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
#                           
#                           cl_Ceil + cl_Days+ 
#                           Veh  +
#                           PricingFee+ b_UCA +
#                           b_Intl+
#                           
#                           b_UCA:CompOffr+
#                         # b_UCA:cl_Ceil+
#                         # PricingFee:cl_US6_avg_sal_lag1+
#                         
#                         (1 | NAICS3/NAICS) + (1 | Agency/Office),
#                         family=binomial(link="logit"),
                        verbose=1)
# glmer_examine(Term_Comp_13E)
# save(Term_Comp_13E,file="Output//Term_Comp_13E.rdata")

Term_Comp_13E2 <- glmer (data=smp,
                        b_Term~CompOffr+
                          cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                          cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+

                          cl_Ceil + cl_Days+
                          Veh  +
                          PricingFee+ b_UCA +
                          b_Intl+

                          # b_UCA:CompOffr+
                        # b_UCA:cl_Ceil+
                        # PricingFee:cl_US6_avg_sal_lag1+

                        (1 | NAICS3/NAICS) + (1 | Agency/Office),
                        family=binomial(link="logit"),
                        verbose=1)
glmer_examine(Term_Comp_13E2)
save(Term_Comp_13E,Term_Comp_13E2,file="Output//Term_Comp_13E.rdata")



stargazer::stargazer(Term_Cons_13B,Term_Cons_13D,Term_Cons_13E,
                     Term_Comp_13C,Term_Comp_13D,Term_Comp_13E2,
                     type="text",
                       digits=2)



any(diag.vals<1e-6)

if(!exists("Term_Cons_13B.devfun"))
  Term_Cons_13B.devfun <- update(Term_Cons_13B, devFunOnly=TRUE)

if (isLMM(Term_Cons_13B)) {
  pars <- getME(Term_Cons_13B,"theta")
} else {
  ## GLMM: requires both random and fixed parameters
  pars <- getME(Term_Cons_13B, c("theta","fixef"))
}
if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(Term_Cons_13B.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(Term_Cons_13B.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
Term_Cons_13B@optinfo$derivs

if(!exists("Term_Cons_13B.restart"))
  Term_Cons_13B.restart <- update(Term_Cons_13B, start=pars)
glmer_examine(Term_Cons_13B.restart)




#CBre Comp
if(!exists("Term_Comp_13E.devfun"))
  Term_Comp_13E.devfun <- update(Term_Comp_13E, devFunOnly=TRUE)

if (isLMM(Term_Comp_13E)) {
  pars <- getME(Term_Comp_13E,"theta")
} else {
  ## GLMM: requires both random and fixed parameters
  pars <- getME(Term_Comp_13E, c("theta","fixef"))
}
if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(Term_Comp_13E.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(Term_Comp_13E.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
Term_Comp_13E@optinfo$derivs

if(!exists("Term_Comp_13E.restart"))
  Term_Comp_13E.restart <- update(Term_Comp_13E, start=pars)
glmer_examine(Term_Comp_13E.restart)


  save(Term_Cons_13E,Term_Comp_13E,Term_Cons_13E.restart,Term_Comp_13E.restart,
       file="Output//Term_Cons_13E.rdata")
  
stargazer::stargazer(Term_Cons_11A,Term_Cons_13E,Term_Cons_13E.restart,Term_Comp_11A.restart,Term_Comp_13E,type="text",
                       digits=2)




```
Term_COmp_13E did not work at all. 



### Model 14A Both: Integrating interactions from 10. (Except 10J again, oops!)
```{r 14A_Interactions}
load(file="Output//Term_Cons_14A.rdata")

Term_Cons_Comp_14A <- glmer (data=smp,
                      b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+
                        CompOffr+
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
 
                                     
                        cl_def6_HHI_lag1:cl_Days+
                        b_UCA:cl_Ceil+
                        b_UCA:cl_def6_HHI_lag1 +
                       PricingFee:cl_US6_avg_sal_lag1+
                        cl_def6_HHI_lag1:cl_def6_obl_lag1  +

                      cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                        
                                                (1 | NAICS3/NAICS) + (1 | Agency/Office)
                      , family=binomial(link="logit"),verbose=1)
glmer_examine(Term_Cons_Comp_14A)
save(Term_Cons_Comp_14A,file="Output//Term_Cons_Comp_14A")


stargazer::stargazer(Term_Cons_13B,Term_Cons_13D,
                     Term_Comp_13C,Term_Comp_13D,Term_Cons_Comp_14A,
                     type="text",
                       digits=2)
  

```

### Model 14B Both: Integrating interactions from 10. (Except 10J again!, oops!)
```{r 14B_Interactions}
load(file="Output//Term_Cons_14B.rdata")

Term_Cons_Comp_14B <- glmer (data=smp,
                             b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                               #cl_US3_avg_sal_lag1+
                               cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                               cl_US6_avg_sal_lag1+
                               CompOffr+
                               cl_Ceil + cl_Days+ 
                               Veh +
                               PricingFee + b_UCA +
                               b_Intl+
                               
                               cl_def6_HHI_lag1:cl_Days+
                               # b_UCA:cl_Ceil+
                               # b_UCA:cl_def6_HHI_lag1 +
                               # PricingFee:cl_US6_avg_sal_lag1+
                               cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                               # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                               cl_def3_HHI_lag1:cl_def3_ratio_lag1+  
                               
                               (1 | NAICS3/NAICS) + (1 | Agency/Office)
                             , family=binomial(link="logit"),verbose=1)
glmer_examine(Term_Cons_Comp_14B)
save(Term_Cons_Comp_14B,file="Output//Term_Cons_Comp_14B")


stargazer::stargazer(Term_Cons_13B,Term_Cons_13D,
                     Term_Comp_13C,Term_Comp_13D,Term_Cons_Comp_14A,Term_Cons_Comp_14B,
                     type="text",
                       digits=2)
  

```

## Archives
### Model 10: Both
```{r Term10M}
Term_Comp_Cons_10M<- glm (data=smp,
                        b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                          #cl_US3_avg_sal_lag1+
                          cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                          cl_US6_avg_sal_lag1+     
                        CompOffr+
                          cl_Ceil + cl_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                          cl_def6_HHI_lag1:cl_Days+
                          # b_UCA:cl_Ceil+
                          # b_UCA:cl_def6_HHI_lag1 +
                          # PricingFee:cl_US6_avg_sal_lag1+
                          cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                          # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                          cl_def3_HHI_lag1:cl_def3_ratio_lag1+
                          Agency + NAICS2, family=binomial(link="logit"))
glmer_examine(Term_Comp_Cons_10M)

  stargazer::stargazer(Term_Cons_10L,Term_Comp_10A,Term_Comp_Cons_10M,type="text",
                       digits=2)



# Appendix
## No longer Relevant Code

###Examine Minimium Size
```{r MinimumSize}
# path<-"https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/"
#   directory="economic/"
#   deflator_file <- "Lookup_Deflators.csv"
#   
#  deflators_retrieved <- readr::read_csv(paste0(path, directory,deflator_file))
# deflators_retrieved$cutoff_3500<-3500*deflators_retrieved$Deflator.2016
# deflators_retrieved<-subset(deflators_retrieved,select=c(Fiscal.Year,cutoff_3500))
# colnames(deflators_retrieved)[1]<-"StartFY"
# def<-plyr::join(def,deflators_retrieved)
# #Frequency Plot for logged ceiling
# def$UnmodifiedContractBaseAndAllOptionsValue
# smp<-def[
#   !is.na(def$b_Term)&
#     !is.na(def$Comp)&
#     def$UnmodifiedContractBaseAndAllOptionsValue>=
#     def$cutoff_3500,]
# 
# smp<-smp[sample(nrow(smp),250000),]
# 
# 
# freq_continuous_term_plot(smp,"l_Ceil")
# exp(mean(smp$l_Ceil,na.rm=TRUE))
# 
# smp$StartFY
# 
# cutoff<-quantile(smp$l_Ceil,0.05,na.rm=TRUE)
# exp(cutoff)
# cutoff<-log(3500)
# 
# nrow(subset(smp,l_Ceil<cutoff,na.rm=TRUE))/nrow(smp)
# sum(subset(smp,l_Ceil<cutoff)$b_Term)/sum(smp$b_Term)
# 
# 
# sum(subset(smp,l_Ceil<cutoff,na.rm=TRUE)$Action.Obligation)/sum(smp$Action.Obligation)
# sum(subset(smp,l_Ceil>=cutoff,na.rm=TRUE)$Action.Obligation)/sum(smp$Action.Obligation)
# 
# sum(subset(smp,l_Ceil<cutoff)$b_Term)/nrow(subset(smp,l_Ceil<cutoff,na.rm=TRUE))
# 
# sum(subset(smp,l_Ceil>=cutoff)$b_Term)/nrow(subset(smp,l_Ceil<cutoff,na.rm=TRUE))
# 
# 
# exp(2)
```

## Who
This approach was initially used before the empty model analysis revealed that the entire agency structure would need to be included.

###Model 02B: Cost Ceiling Squared
```{r Model02B_Term}



#Frequency Plot
freq_continuous_term_plot(smp,"lsqr_Ceil")

#Percent Terminated Plot
binned_percent_term_plot(smp,"lsqr_Ceil")

#Model
Term_Comp_02B <- glm (data=smp,
                 b_Term ~n_Comp + cl_Ceil + clsqr_Ceil, family=binomial(link="logit"))
display(Term_Comp_02B)

#Plot the fitted model plot
Term_Comp_02B_curve<-function(x, Comp){invlogit(cbind(1,Comp,x, x^2) %*%  coef(Term_Comp_02B))}

#Competition curves
fitted_term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02B_curve, 
                             args=list(Comp=0),color="blue")+
  stat_function(fun = Term_Comp_02B_curve, 
                             args=list(Comp=2),color="blue")

#Plot the fitted values vs actual results
binned_fitted_versus_residuals(Term_Comp_02B)

#Plot residuals versus fitted
residuals_term_plot(Term_Comp_02B)+
  labs(x="Estimated  Pr (Termination)")

residuals_term_plot(Term_Comp_02B,"cl_Ceil")+
  labs(x="Centered Log(Ceiling)")

```

Contracts with very small or very large ceilings appear have a negative coefficient for calculating termination. On the upper end, this might represent contracts that are "too large to fail"" or simply that above a certain size, risk stops rising. Adding the log(Ceiling) squared greatly reduces the apparent pattern in the residuals, although more than 5 percent of the binned residuals still fall outside the 95% confidence interval.

###Model 02F: Duration Squared

```{r Model02F}



#Frequency Plot
freq_continuous_term_plot(smp,"lsqr_Days")

#Percent Terminated Plot
binned_percent_term_plot(smp,"lsqr_Days")


#Create the model
Term_Comp_02F <- glm (data=smp,
                 b_Term ~n_Comp + 
                   cl_Ceil + clsqr_Ceil + cl_Days+ clsqr_Days +
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days, family=binomial(link="logit"))
display(Term_Comp_02F)

Term_Comp_02F_curve<-function(x, Comp,Ceil){invlogit(
  cbind(1,Comp,Ceil,Ceil^2,x,x^2,
        Comp*Ceil,x*Ceil) %*%  coef(Term_Comp_02F))}

#Competition curves
fitted_term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02F_curve, 
                             args=list(Comp=0),color="blue")+
  stat_function(fun = Term_Comp_02F_curve, 
                             args=list(Comp=2),color="blue")

#Plot the fitted values vs actual results
binned_fitted_versus_residuals(Term_Comp_02F)

#Plot residuals versus fitted
residuals_term_plot(Term_Comp_02F)+
  labs(x="Estimated  Pr (Termination)")

# residuals_term_plot(Term_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")


residuals_term_plot(Term_Comp_02F,"cl_Ceil")+
  labs(x="Centered Log(Ceiling)")


```
Adding log(initial duration)^2 does seem to address the troubling pattern present in the residuals, namely the parabolic curve and the large number of data bins falling outside of the 95% confidence interval. Both of the ceiling coefficients remain positive but they are no longer coefficient. The next step is to see whether log(initial cost ceiling)^2 is still useful in this model now that the square of duration is included.



###Model 02G: Testing the removal of Ceiling^2 

```{r Model02G}

#Create the model
Term_Comp_02G <- glm (data=smp,
                 b_Term ~n_Comp + 
                   cl_Ceil + cl_Days+ clsqr_Days +
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days, family=binomial(link="logit"))
display(Term_Comp_02G)

Term_Comp_02G_curve<-function(x, Comp,Ceil){invlogit(
  cbind(1,Comp,Ceil,x,x^2,
        Comp*Ceil,x*Ceil) %*%  coef(Term_Comp_02E))}

#Competition curves
fitted_term_model(smp,"cl_Ceil") + stat_function(fun = Term_Comp_02G_curve, 
                             args=list(Comp=0),color="blue")+
  stat_function(fun = Term_Comp_02G_curve, 
                             args=list(Comp=2),color="blue")

#Plot the fitted values vs actual results
binned_fitted_versus_residuals(Term_Comp_02G)

#Plot residuals versus fitted
residuals_term_plot(Term_Comp_02G)+
  labs(x="Estimated  Pr (Termination)")

residuals_term_plot(Term_Comp_02G,"cl_Ceil")+
  labs(x="Centered Log(Ceiling)")

```

While the effect on the residual deviance is fairly minor, it does still appear that the ceiling^2 does reduce the incidence of non-linear patterns in the residuals. So for now we will be leaving it in.




###Model 03E: Testing the removal of Ceiling^2 

```{r Model03E}

#Create the model
Term_Cons_03E <- glm (data=smp,
                 b_Term ~c_HHI_lag1 + 
                   cl_Ceil  + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   c_HHI_lag1:cl_Ceil  + cl_Ceil:cl_Days  + c_HHI_lag1:cl_Days +
                 SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:c_HHI_lag1+MIDV:c_HHI_lag1+OIDV:c_HHI_lag1, family=binomial(link="logit"))
display(Term_Cons_03E)

#Create the model
Term_Comp_03E <- glm (data=smp,
                 b_Term ~n_Comp + 
                   cl_Ceil  + cl_Days+ clsqr_Days +
                   Veh + 
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days +
                 Veh:cl_Days+
                   SIDV:n_Comp+MIDV:n_Comp+OIDV:n_Comp, family=binomial(link="logit"))
display(Term_Comp_03E)



# Plot the model and Vehicle for SIDV
Term_Cons_03E_SIDV_curve<-function(x, HHI,Days,SIDV,MIDV,OIDV){invlogit(
  cbind(1,HHI,x,Days,Days^2,SIDV,MIDV,OIDV,
        HHI*x,Days*x,Days*HHI,
        Days*SIDV,Days*MIDV,Days*OIDV,
        HHI*SIDV,HHI*MIDV,HHI*OIDV) %*%  coef(Term_Cons_03E))}

#Competition curves
discrete_fitted_term_model(smp,"cl_Ceil") +
  stat_function(fun = Term_Cons_03E_SIDV_curve,
                             args=list(HHI=0,Days=0,
                                       MIDV=0,FSSGWAC=0,BPABOA=0,SIDV=0),color="blue")+
  stat_function(fun = Term_Cons_03E_SIDV_curve,
                             args=list(HHI=2,Days=0,
                                       MIDV=0,FSSGWAC=0,BPABOA=0,SIDV=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_residuals(Term_Cons_03E)

#Plot residuals versus fitted
residuals_term_plot(Term_Cons_03E)+
  labs(x="Estimated  Pr (Termination)")

residuals_term_plot(Term_Cons_03D,"cl_Ceil")+
  labs(x="Centered Log(Ceiling)")


residuals_term_plot(Term_Cons_03E,"cl_Ceil")+
  labs(x="Centered Log(Ceiling)")

```
Ceiling squared does little to reduce deviance and only slightly mitigates, rather than removing, any patterns in the residuals. Removing it from the model.






###Model 03F: Testing the removal of Duration^2 

```{r Model03F}

#Create the model
Term_Cons_03F <- glm (data=smp,
                 b_Term ~c_HHI_lag1 + 
                   cl_Ceil  + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   c_HHI_lag1:cl_Ceil  + cl_Ceil:cl_Days  + c_HHI_lag1:cl_Days +
                 SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:c_HHI_lag1+MIDV:c_HHI_lag1+OIDV:c_HHI_lag1, family=binomial(link="logit"))
display(Term_Cons_03F)



#Create the model
Term_Comp_03F <- glm (data=smp,
                 b_Term ~n_Comp + 
                   cl_Ceil  + cl_Days+ 
                   Veh + 
                   n_Comp:cl_Ceil  + cl_Ceil:cl_Days  + n_Comp:cl_Days +
                 Veh:cl_Days+
                   SIDV:n_Comp+MIDV:n_Comp+OIDV:n_Comp, family=binomial(link="logit"))
display(Term_Comp_03F)
# 
# # Plot the model and Vehicle for SIDV
# Term_Cons_03F_SIDV_curve<-function(x, HHI,Days,SIDV,MIDV,OIDV){invlogit(
#   cbind(1,HHI,x,Days,Days^2,SIDV,MIDV,OIDV,
#         HHI*x,Days*x,Days*HHI,
#         Days*SIDV,Days*MIDV,Days*OIDV,
#         HHI*SIDV,HHI*MIDV,HHI*OIDV) %*%  coef(Term_Cons_03F))}
# 
# #Competition curves
# discrete_fitted_term_model(smp,"cl_Ceil") +
#   stat_function(fun = Term_Cons_03F_SIDV_curve,
#                              args=list(HHI=0,Days=0,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0,SIDV=0),color="blue")+
#   stat_function(fun = Term_Cons_03F_SIDV_curve,
#                              args=list(HHI=2,Days=0,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0,SIDV=0),color="blue")
# 
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_residuals(Term_Cons_03F)
# 
# 
# #Plot residuals versus fitted
# residuals_term_plot(Term_Cons_03E)+
#   labs(x="Estimated  Pr (Termination)")
# 
# 
# #Plot residuals versus fitted
# residuals_term_plot(Term_Cons_03F)+
#   labs(x="Estimated  Pr (Termination)")

# residuals_term_plot(Term_Cons_03E,"cl_Days")+
  # labs(x="Centered Log(Duration)")


# residuals_term_plot(Term_Cons_03F,"cl_Days")+
  # labs(x="Centered Log(Duration)")
```

The benefits of duration squared are fairly minimal as well at this point.



###Model 04E: Incentive Fees and Fixed-Price  

```{r Model04E}

#Frequency Plot
freq_discrete_term_plot(smp,"Fee","FxCb")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

#Percent Terminated Plot 
discrete_percent_term_plot(smp,"Fee","FxCb")+
   theme(axis.text.x = element_text(angle = 90, hjust = 1))



#Create the model
Term_Cons_04E <- glm (data=smp,
                 b_Term ~c_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   c_HHI_lag1:cl_Ceil  + cl_Ceil:cl_Days  + c_HHI_lag1:cl_Days +
                   n_Fixed + n_Incent + 
                   SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:c_HHI_lag1+MIDV:c_HHI_lag1+OIDV:c_HHI_lag1 +
                   n_Fixed:n_Incent
                    , family=binomial(link="logit"))
display(Term_Cons_04E)

# Plot the model and Vehicle 
Term_Cons_04E_curve<-function(x, HHI,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
  cbind(1,HHI,Ceil,Days,SIDV,MIDV,OIDV,
        HHI*Ceil,Days*Ceil,Days*HHI,
        Fixed,x,
        Days*x,Days*MIDV,Days*OIDV,
        HHI*x,HHI*MIDV,HHI*OIDV,
        x*Fixed) %*%  coef(Term_Cons_04E))}

#Days curves
discrete_fitted_term_model(smp,"SIDV") +
  stat_function(fun = Term_Cons_04E_curve,
                             args=list(HHI=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
                                       Fixed=0),color="blue")+
  stat_function(fun = Term_Cons_04E_curve,
                             args=list(HHI=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
                                       Fixed=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_residuals(Term_Cons_04E)

#Plot residuals versus fittedO
residuals_term_plot(Term_Cons_04E)+
  labs(x="Estimated  Pr (Termination)")

# residuals_term_plot(Term_Cons_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```
Looking at Incentive Fees and Fixed-Price interactions undercuts the significance of both base variables. Incentive will not be added to the model.

###Model 04F: Fixed-Price and Vehicle


```{r Model04F_Term}

#Frequency Plot
summary_discrete_plot(smp,"FxCb","Veh")

#Create the model
#Create the model
Term_Cons_04F <- glm (data=smp,
                 b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days  +
                   Veh+
                 PricingFee+
                 +cl_def6_HHI_lag1:cl_Ceil+
                 +Veh:cl_Days+
                   Veh:cl_def6_HHI_lag1+
                   Veh:cl_Ceil+
                 Veh:PricingFee  , family=binomial(link="logit"))
glmer_examine(Term_Cons_04F)


Term_Comp_04F <- glm (data=smp,
                 b_Term ~CompOffr+cl_def3_ratio_lag1+
                   cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
                   cl_Ceil + cl_Days+
                   Veh+
                   Veh:cl_Days+
                   Veh:cl_Ceil+
                   PricingFee, 
                 family=binomial(link="logit"))
glmer_examine(Term_Cons_04F)
# Plot the model and Vehicle for SIDV
# Term_Comp_04F_curve<-function(x, Comp,Ceil,Days,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         n_Fixed,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Days*SIDV,Days*MIDV,Days*OIDV,
#         Comp*SIDV,Comp*MIDV,Comp*OIDV,
#         x*SIDV,x*MIDV,x*OIDV
#         ) %*%  coef(Term_Comp_04F))}
# 
# #Vehicle curves
# fitted_Term_model(smp,"n_Fixed") +
#   stat_function(fun = Term_Comp_04F_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=1,MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = Term_Comp_04F_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=1,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = Term_Comp_04F_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=0,OIDV=1),color="blue")
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_Term_residuals(Term_Comp_04F)
# 
# #Plot residuals versus fittedO
# residuals_Term_plot(Term_Comp_04F)+
#   labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_Term_plot(Term_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")
stargazer::stargazer(Term_Cons_04C,Term_Cons_04F,
                     Term_Comp_04C,Term_Comp_04F,type="text",
                       digits=2)
summary_residual_compare(Term_Cons_04C,Term_Cons_04F,Term_Comp_04C,Term_Comp_04F,bins=20)

```
The interactions are not significant and do little to reduce the residual deviance. They will not be added to the model. They exceed VIF of 2 in both cases.


### Model Old 06A: Sub Customer 
Other DoD stands out for its sheer quantity of contracts and task orders and also its lower termination rate. It includes the DLA which specializes in logistic delivery, and may thus estimate a lower rate of ceiling breahces.
```{r ModelOld06A}
    #Frequency Plot
  summary_discrete_plot(def,"Agency",rotate_text=TRUE)
    summary_discrete_plot(def,rotate_text=TRUE)
    summary_discrete_plot(def,"b_ODoD",rotate_text=TRUE)


#Create the model
Term_Cons_06A <- glm (data=smp,
                      b_Term ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        Who+
                       
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh
                      , family=binomial(link="logit"))
glmer_examine(Term_Cons_06A)

Term_Comp_06A <- glm (data=smp,
                      b_Term ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        Who+
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh 
                      , family=binomial(link="logit"))
glmer_examine(Term_Comp_06A)

# # Plot the model and Vehicle 
# Term_Comp_06A_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA,Intl){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,UCA,Intl,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         UCA*Comp) %*%  coef(Term_Comp_06A))}
# 
# #Days curves
# discrete_fitted_term_model(smp,"b_ODoD") +
#   stat_function(fun = Term_Comp_06A_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1,UCA=0,Intl=0),color="blue")+
#   stat_function(fun = Term_Comp_06A_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1,UCA=0,Intl=0),color="blue")
# 
# 



  stargazer::stargazer(Term_Cons_05C,Term_Cons_06A,Term_Comp_05C,Term_Comp_06A,type="text",
                       digits=2)
  
summary_residual_compare(Term_Cons_05C,Term_Cons_06A,Term_Comp_04H,Term_Comp_06A,bins=20)



```

###Model Old 06B: SubCustomer and International
Army international spending is particularly in this period, is tied to crisis contracting and U.S. occupations. This high risk connection may mean that Army international contracting predicts a higher rate of ceiling breaches
```{r Model06B}

#Frequency Plot
summary_discrete_plot(smp,"Who","Intl",rotate_text=TRUE)



#Create the model
Term_Cons_06B <- glm (data=smp,
                      b_Term ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        Who+
                       
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh+
                        Who:b_Intl
                      , family=binomial(link="logit"))
glmer_examine(Term_Cons_06B)

Term_Comp_06B <- glm (data=smp,
                      b_Term ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        Who+
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh+
                        Who:b_Intl 
                      , family=binomial(link="logit"))
glmer_examine(Term_Comp_06B)


Term_Cons_06B2 <- glm (data=smp,
                      b_Term ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        Who+
                       
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        
                        Who:b_Intl
                      , family=binomial(link="logit"))
glmer_examine(Term_Cons_06B2)

Term_Comp_06B2 <- glm (data=smp,
                      b_Term ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        Who+
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        
                        Who:b_Intl 
                      , family=binomial(link="logit"))
glmer_examine(Term_Comp_06B2)

# # Plot the model and Vehicle 
# Term_Comp_06B_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA,Intl){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,UCA,Intl,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         UCA*Comp) %*%  coef(Term_Comp_06B))}
# 
# #Days curves
# discrete_fitted_term_model(smp,"b_ODoD") +
#   stat_function(fun = Term_Comp_06B_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1,UCA=0,Intl=0),color="blue")+
#   stat_function(fun = Term_Comp_06B_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1,UCA=0,Intl=0),color="blue")
# 
# 



  stargazer::stargazer(Term_Cons_06A,Term_Cons_06B,Term_Comp_06A,Term_Comp_06B,type="text",
                       digits=2)
  
summary_residual_compare(Term_Cons_06A,Term_Cons_06B,Term_Comp_06A,Term_Comp_06B,bins=20)



```
The results are interesting and run contrary to expectations. Army does have a higher number of international contracts, but this does not account for the Army's higher breach rate. Instead, Navy and Other DoD, which are less frequently international, are more likely to have challenges.
###Model Old 06C: Other DoD
```{r Model06A}


summary_discrete_plot(smp,"ODoD",rotate_text=TRUE)


# Plot the model and Vehicle 
# Term_Comp_06A_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA,Intl){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,UCA,Intl,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         UCA*Comp) %*%  coef(Term_Comp_06A))}
# 
# #Days curves
# discrete_fitted_term_model(smp,"b_ODoD") +
#   stat_function(fun = Term_Comp_06A_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1,UCA=0,Intl=0),color="blue")+
#   stat_function(fun = Term_Comp_06A_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,OIDV=0,
#                                        Fixed=1,UCA=0,Intl=0),color="blue")


Term_Cons_06C <- glm (data=smp,
                      b_Term ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        ODoD+
                       
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh
                      , family=binomial(link="logit"))
glmer_examine(Term_Cons_06C)

Term_Comp_06C <- glm (data=smp,
                      b_Term ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        ODoD+
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh 
                      , family=binomial(link="logit"))
glmer_examine(Term_Comp_06C)
glmer_examine(Term_Cons_06C)



  stargazer::stargazer(Term_Cons_06A,Term_Cons_06C,Term_Comp_06A,Term_Comp_06C,type="text",
                       digits=2)
  
summary_residual_compare(Term_Cons_06A,Term_Cons_06C,Term_Comp_06A,Term_Comp_06C,bins=20)



```

After inclusion of Other DoD, the Competition correlates significantly predicts a greater risk of termination. Studying that interaction will be our next step.

### Model Old 06D: Other DoD & Competition
DLA primarily deals with commodities and parts and thus the breadth of the vendor pool can be a key determiner while for the other branches, complexity of the contract may prove more important. Thus OtherDoD and concentration estimate higher probablity of  ceiling breaches. Competition may matter more for the military services, as the difference between 1 and 2 contractors is more likely to come up.

```{r Model06D}

#Frequency Plot
summary_discrete_plot(smp,"EffComp","ODoD",rotate_text=TRUE)
summary_continuous_plot(smp,"cl_def6_HHI_lag1","ODoD",rotate_text=TRUE)



Term_Cons_06D <- glm (data=smp,
                      b_Term ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        ODoD+
                       
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh+ 
                        ODoD:cl_def6_HHI_lag1
                      , family=binomial(link="logit"))
glmer_examine(Term_Cons_06D)

Term_Comp_06D <- glm (data=smp,
                      b_Term ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        ODoD+
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh +
                   ODoD + ODoD:n_Comp
                      , family=binomial(link="logit"))
glmer_examine(Term_Comp_06D)
glmer_examine(Term_Cons_06D)



  stargazer::stargazer(Term_Cons_06A,Term_Cons_06C,Term_Cons_06D,Term_Comp_06A,Term_Comp_06C,Term_Comp_06D,type="text",
                       digits=2)
  
summary_residual_compare(Term_Cons_06C,Term_Cons_06D,Term_Comp_06C,Term_Comp_06D,bins=20)
summary_residual_compare(Term_Cons_06A,Term_Cons_06D,Term_Comp_06A,Term_Comp_06D,bins=20)
```
VIF is exceeded for competition but not consolidation. Keeping it for consolidation.
### Model Old 06E: Other DoD & Vehicle
A significant portion of DLA contracting is done through IDIQ contracts. Because of this, the previously found low estimates  for single-award IDV contracts and other forms might be influenced by the specific high volume vehicles used by DLA rather than the general traits of  tehse vehicles. Thus the interaction of DLA and non-definitive contracts may estimate lower  rates of breaches. This may not apply to BPA/BOA, which encompass a wider variety. It may also be a little weaker for FSS/GWAC which can call on vehicles outside of DoD and this may depend less on customers.

```{r Model06E}

#Frequency Plot
summary_discrete_plot(smp,"EffComp","ODoD",rotate_text=TRUE)
summary_continuous_plot(smp,"cl_def6_HHI_lag1","ODoD",rotate_text=TRUE)



Term_Cons_06E <- glm (data=smp,
                      b_Term ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        ODoD+
                       
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh+ 
                        ODoD:cl_def6_HHI_lag1+
                        ODoD:Veh
                      , family=binomial(link="logit"))
glmer_examine(Term_Cons_06E)
glmer_examine(Term_Cons_06E)

Term_Comp_06E <- glm (data=smp,
                      b_Term ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        ODoD+
                        Veh:cl_Days+
                        
                        Veh:cl_Ceil+
                        cl_Ceil:PricingFee+
                        
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh +
                   ODoD+ #+ ODoD:n_Comp 
                   ODoD:Veh
                      , family=binomial(link="logit"))
glmer_examine(Term_Comp_06E)



  stargazer::stargazer(Term_Cons_06A,Term_Cons_06D,Term_Cons_06E,Term_Comp_06A,Term_Comp_06C,Term_Comp_06E,type="text",
                       digits=2)
  
summary_residual_compare(Term_Cons_06D,Term_Cons_06E,Term_Comp_06C,Term_Comp_06E,bins=20)
```
Both exceed VIF limitation.

### Model 07B: Old NAICS and ODoD
```{r OldModel07B}
corrdisp<-Hmisc::rcorr(
  as.matrix(cbind(subset(crisis_smp, select=c(b_UCA,c_OffCri,cl_Ceil,
                                              cl_Days,n_Fixed,b_Intl)),
                  dummies::dummy(crisis_smp$Crisis),
                  dummies::dummy(crisis_smp$NoComp),
                  dummies::dummy(crisis_smp$Reach),
                  dummies::dummy(crisis_smp$Veh),
                  dummies::dummy(crisis_smp$Is.Defense),
                  dummies::dummy(crisis_smp$Simple))))
corrdisp[[1]]

#Sumamry plot
summary_discrete_plot(smp1m,"NAICS2",rotate_text=TRUE)
Term_Cons_07B <- glm (data=smp,
                      b_Term ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        ODoD+
                       
                        
                        
                        
                        
                        
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        
                        ODoD:b_Intl+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Cons_07B)
glmer_examine(Term_Cons_07B)

Term_Comp_07B <- glm (data=smp,
                      b_Term ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        
                        
                        
                        
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh +
                   ODoD+ ODoD:b_Intl+
                   NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Comp_07B)
glmer_examine(Term_Comp_07B)

Term_Cons_07B2 <- glm (data=smp,
                      b_Term ~cl_def6_HHI_lag1 + 
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        # ODoD+ Agency is missing
                       
                        
                        
                        
                        
                        
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        
                       # ODoD:b_Intl+
                        NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Cons_07B2)
glmer_examine(Term_Cons_07B2)

Term_Comp_07B2 <- glm (data=smp,
                      b_Term ~n_Comp + 
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        
                        
                        
                        
                        
                        b_UCA:n_Comp + 
                        b_UCA:cl_Ceil+
                        
                        b_Intl:Veh +
                   # ODoD+
                   NAICS2
                      , family=binomial(link="logit"))
glmer_examine(Term_Comp_07B2)
glmer_examine(Term_Comp_07B2)


  stargazer::stargazer(Term_Cons_07A,Term_Cons_07B2,Term_Comp_07A,Term_Comp_07B2,type="text",
                       digits=2)
  
summary_residual_compare(Term_Cons_07A,Term_Cons_07B2,Term_Comp_07A,Term_Comp_07B2,bins=20)


```




### Model 10F: Veh:Days
IDVs lower the transaction costs of contracting.  This may lead to a diminishment of their  effects as their  duration grows.

```{r Model10F}


#Sumamry plot
summary_continuous_plot(smp1m,"l_Days","Veh")

#Create the model
Term_Cons_10F <- glm(data=smp,
                       b_Term ~cl_def6_HHI_lag1 + 
                         cl_Ceil + cl_Days+
                       cl_def6_HHI_lag1:cl_Ceil+
                                                
                         Veh+
                          #cl_Ceil:cl_Days  +
                         n_Fixed + b_UCA +
                                                b_UCA:cl_def6_HHI_lag1+
                         b_Intl +
                         Veh:cl_Days +
                         NAICS2
                       , family=binomial(link="logit"))
glmer_examine(Term_Cons_10F)
glmer_examine(Term_Cons_10F)
  
Term_Comp_10F<- glm(data=smp,
                       b_Term ~n_Comp + 
                         cl_Ceil + cl_Days+
                         Veh+
                         # cl_Ceil:cl_Days  +
                         n_Fixed + b_UCA +
                                               b_UCA:n_Comp+
                         b_Intl +
                         Veh:cl_Days +
                         NAICS2
                       , family=binomial(link="logit"))
glmer_examine(Term_Comp_10F)
glmer_examine(Term_Comp_10F)

  stargazer::stargazer(Term_Cons_10D,Term_Cons_10F,Term_Comp_10B,Term_Comp_10F,type="text",
                       digits=2)
  
  

summary_residual_compare(Term_Cons_10D,Term_Cons_10F,Term_Comp_10B,Term_Comp_10F,bins=20)


```
The interaction adds fairly little to the model and makes residuals worse, leaving it out.

### Model 10F: Ceil:Days

There are two competing explainations. First, high base duration and ceiling contracts might estimate lower risks, because they give enouogh time to complete the contract. 
```{r Model10F}


#Sumamry plot
summary_continuous_plot(smp1m,"l_Days","l_Ceil")

#Create the model
Term_Cons_10F <- glm(data=smp,
                       b_Term ~cl_def6_HHI_lag1 + 
                         cl_Ceil + cl_Days+
                       cl_def6_HHI_lag1:cl_Ceil+
                       cl_Ceil:cl_Days  +
                         Veh+
                          
                         n_Fixed + b_UCA +
                        b_UCA:cl_def6_HHI_lag1+
                         b_Intl +
                         NAICS2
                       , family=binomial(link="logit"))
glmer_examine(Term_Cons_10F)
glmer_examine(Term_Cons_10F)
  
Term_Comp_10F<- glm(data=smp,
                       b_Term ~n_Comp + 
                         cl_Ceil + cl_Days+
                         Veh+
                         cl_Ceil:cl_Days  +
                         n_Fixed + b_UCA +
                        b_UCA:n_Comp+
                         b_Intl +
                         NAICS2
                       , family=binomial(link="logit"))
glmer_examine(Term_Comp_10F)
glmer_examine(Term_Comp_10F)

  stargazer::stargazer(Term_Cons_10D,Term_Cons_10F,Term_Comp_10B,Term_Comp_10F,type="text",
                       digits=2)
  
  

summary_residual_compare(Term_Cons_10D,Term_Cons_10F,Term_Comp_10B,Term_Comp_10F,bins=20)


```
The results were significant though contrary to expectation. The reduction  in deviance is fairly minor and for consolidations makes the residuals worse. Perhaps this results happens because  contracts with a longer duration and higher base might indicate less complexity and more the delivery of something expensive.


## Multilevel

###Model 08A: No Interactions
The North American Industrial Classification system captures the sector of each contract, which are each given a seperate intercept in the model.
```{r Model08}

#Frequency Plot
freq_discrete_term_plot(smp,"NAICS")

#Percent Terminated Plot 
discrete_percent_term_plot(smp,"NAICS")

Term_Cons_08A <- glmer(data=smp,
                 b_Term ~c_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Fixed + b_UCA + 
                   # b_Intl +
                   (1 | NAICS)
                  , family=binomial(link="logit"))
display(Term_Cons_08A)



#Create the model
# Term_Cons_08A <- glmer(data=smp,
#                  b_Term ~c_HHI_lag1 + 
#                    cl_Ceil + cl_Days+ 
#                    SIDV + MIDV + FSSGWAC + BPABOA +
#                    n_Fixed + b_UCA + 
#                    b_Intl + 
#                    c_HHI_lag1:cl_Ceil  + cl_Ceil:cl_Days  + c_HHI_lag1:cl_Days +
#                    SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
#                    SIDV:c_HHI_lag1+MIDV:c_HHI_lag1+OIDV:c_HHI_lag1+
#                    b_UCA:c_HHI_lag1+
#                    (1 | NAICS)
#                     , family=binomial(link="logit"))
# display(Term_Cons_08A)
#Ran for two hours Model failed to converge with max|grad| = 0.186396 (tol = 0.001, component 1)
# Plot the model and Vehicle 
# Term_Cons_08A_curve<-function(x, HHI,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
#   cbind(1,HHI,Ceil,Days,SIDV,MIDV,OIDV,
#         HHI*Ceil,Days*Ceil,Days*HHI,
#         Fixed,UCA,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         UCA*HHI) %*%  coef(Term_Cons_08A))}
# 
# #Days curves
# discrete_fitted_term_model(smp,"SIDV") +
#   stat_function(fun = Term_Cons_08A_curve,
#                              args=list(HHI=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1,UCA=0),color="blue")+
#   stat_function(fun = Term_Cons_08A_curve,
#                              args=list(HHI=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1,UCA=0),color="blue")
# 
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_residuals(Term_Cons_08A)
# 
# #Plot residuals versus fittedO
# residuals_term_plot(Term_Cons_08A)+
#   labs(x="Estimated  Pr (Termination)")

# residuals_term_plot(Term_Cons_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```

The initial attempt to include the pre-existing intercepts and all inputs resulted in a model that initially failed to converge. Conservatively the intercepts have been temporarily removed to be added back in a subsequent step.

Unfortunately, after including Start Fiscal Year, the model again failed to converge. The standard deviation of Who is 0 while it is notably higher for determining the slope of competition via PSR and for Start Fiscal Year. This suggests that who is adding little to the model and that it is time to go back to model 6C as a starter.




###Model 08B: Single Interaction
```{r Model08B}



#Create the model
Term_Cons_08B <- glmer(data=smp,
                 b_Term ~c_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Fixed + b_UCA + 
                   # b_Intl +
                   c_HHI_lag1:cl_Ceil + #+ cl_Ceil:cl_Days  + c_HHI_lag1:cl_Days +
                   (1 | NAICS)
                  , family=binomial(link="logit"))
display(Term_Cons_08B)



#Create the model
Term_Comp_08B <- glmer(data=Term_Comp_smp1m,
                 b_Term ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh + 
                   n_Fixed + b_UCA + 
                   Veh:cl_Days+
                   # Veh:n_Comp +
                   # b_Intl +
                  # n_Comp:cl_Ceil + #+ cl_Ceil:cl_Days  + n_Comp:cl_Days +
                   (1 | NAICS)
                  , family=binomial(link="logit"))
glmer_examine(Term_Comp_08B)

#Model failed to converge with max|grad| = 0.00858407 (tol = 0.001, component 1)
# Term_Cons_08B <- glmer(data=smp,
#                  b_Term ~c_HHI_lag1 + 
#                    cl_Ceil + cl_Days+ 
#                    SIDV + MIDV + FSSGWAC + BPABOA +
#                    c_HHI_lag1:cl_Ceil  +
#                    # cl_Ceil:cl_Days  + 
#                    c_HHI_lag1:cl_Days +
#                    n_Fixed + b_UCA + 
#                    b_Intl + 
#                    SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
#                    SIDV:c_HHI_lag1+MIDV:c_HHI_lag1+OIDV:c_HHI_lag1+
#                    b_UCA:c_HHI_lag1+
#                    (1 | PSR) + (1 | PSR_What)
#                     , family=binomial(link="logit"))
# display(Term_Cons_08B)

# Plot the model and Vehicle 
# Term_Cons_08B_curve<-function(x, HHI,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
#   cbind(1,HHI,Ceil,Days,SIDV,MIDV,OIDV,
#         HHI*Ceil,Days*Ceil,Days*HHI,
#         Fixed,UCA,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         UCA*HHI) %*%  coef(Term_Cons_08B))}
# 
# #Days curves
# discrete_fitted_term_model(smp,"SIDV") +
#   stat_function(fun = Term_Cons_08B_curve,
#                              args=list(HHI=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1,UCA=0),color="blue")+
#   stat_function(fun = Term_Cons_08B_curve,
#                              args=list(HHI=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1,UCA=0),color="blue")
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_residuals(Term_Cons_08B)
# 
# #Plot residuals versus fittedO
# residuals_term_plot(Term_Cons_08B)+
#   labs(x="Estimated  Pr (Termination)")

# residuals_term_plot(Term_Cons_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```
After the incorporation of NAICS intercepts, ceiling related interactions had strange consequences (left out for speed of running RMD reasons). The interaction of Competition and Ceiling, even when introduced alone  had a positive coefficient and removed the effect of Ceiling by itself. When all three interactions were included,  Ceiling and Duration similarly had a notable negative coefficient, which seemed contrary to past literature that suggests greater risks when trying to do a large contract too fast. The interaction of competition and days had a positive coefficient, but was not significant.



###Model 08C: Interactions
```{r Model 6 Exploration}
#, fig.height = 10, fig.width = 6.5
#Effective Competition
#Frequency Plot
summary_discrete_plot(smp,"PSR_What","EffComp",rotate_text=TRUE)

#Percent Terminated Plot 
summary_discrete_plot(smp,"EffComp","PSR",rotate_text=TRUE)

summary_discrete_plot(smp,"EffComp","What",rotate_text=TRUE)

summary_discrete_plot(smp,"EffComp","PSR_What",rotate_text=TRUE)


#Effective Competition
#Frequency Plot
summary_discrete_plot(smp,"PSR_What","Veh",rotate_text=TRUE)

#Percent Terminated Plot 
summary_discrete_plot(smp,"Veh","PSR",rotate_text=TRUE)

summary_discrete_plot(smp,"Veh","What",rotate_text=TRUE)

summary_discrete_plot(smp,"Veh","PSR_What",rotate_text=TRUE)

#FxCb
#Frequency Plot
summary_discrete_plot(smp,"PSR_What","FxCb",rotate_text=TRUE)

#Percent Terminated Plot 
summary_discrete_plot(smp,"FxCb","PSR",rotate_text=TRUE)

summary_discrete_plot(smp,"FxCb","What",rotate_text=TRUE)

summary_discrete_plot(smp,"FxCb","PSR_What",rotate_text=TRUE)



Term_Cons_08C <- glmer(data=smp,
                 b_Term ~ #c_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   c_HHI_lag1:cl_Ceil  +
                   # cl_Ceil:cl_Days  + 
                   c_HHI_lag1:cl_Days +
                   n_Fixed + b_UCA + 
                   b_Intl + 
                   SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:c_HHI_lag1+MIDV:c_HHI_lag1+OIDV:c_HHI_lag1+
                   b_UCA:c_HHI_lag1+
                   (1 + c_HHI_lag1 | PSR) + (1 | PSR_What)
                    , family=binomial(link="logit"))
display(Term_Cons_08C)


Term_Comp_08C <- glmer(data=Term_Comp_smp1m,
                 b_Term ~n_Comp +
                   cl_Ceil + cl_Days+
                   Veh + 
                   # n_Comp:cl_Ceil  +
                   # cl_Ceil:cl_Days  +
                   # n_Comp:cl_Days +
                   n_Fixed + b_UCA +
                   # b_Intl +
                   
                   # Veh:n_Comp +
                   b_UCA:n_Comp+
                   (1 | NAICS)
                    , family=binomial(link="logit"))
glmer_examine(Term_Comp_08C)
save(Term_Comp_08C,file="Term08C.Rdata")
```


### 08C
```{r Model08C}

Term_Cons_08D <- glmer(data=smp,
                 b_Term ~ c_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   c_HHI_lag1:cl_Ceil  +
                   # cl_Ceil:cl_Days  + 
                   c_HHI_lag1:cl_Days +
                   n_Fixed + b_UCA + 
                   b_Intl + 
                   SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
                   SIDV:c_HHI_lag1+MIDV:c_HHI_lag1+OIDV:c_HHI_lag1+
                   b_UCA:c_HHI_lag1+
                   (1  | PSR) + (1 + c_HHI_lag1| PSR_What)
                    , family=binomial(link="logit"))
display(Term_Cons_08D)

Term_Comp_08D <- glmer(data=smp,
                 b_Term ~ n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh + 
                   n_Comp:cl_Ceil  +
                   # cl_Ceil:cl_Days  + 
                   n_Comp:cl_Days +
                   n_Fixed + b_UCA + 
                   b_Intl + 
                   Veh:cl_Days+
                   Veh:n_Comp +
                   b_UCA:n_Comp+
                   (1  | PSR) + (1 + n_Comp| PSR_What)
                    , family=binomial(link="logit"))
glmer_examine(Term_Comp_08D)

#Plot the fitted values vs actual results
binned_fitted_versus_residuals(Term_Comp_08C)


#Plot residuals versus fittedO
residuals_term_plot(Term_Comp_08C)+
  labs(x="Estimated  Pr (Termination)")


# Term_Comp_08E <- glmer(data=smp,
#                  b_Term ~ n_Comp + 
#                    cl_Ceil + cl_Days+ 
#                    Veh + 
#                    n_Comp:cl_Ceil  +
#                    # cl_Ceil:cl_Days  + 
#                    n_Comp:cl_Days +
#                    n_Fixed + b_UCA + 
#                    b_Intl + 
#                    Veh:cl_Days+
#                    Veh:n_Comp +
#                    b_UCA:n_Comp+
#                    (1+n_Comp  | PSR) + (1+ n_Comp | PSR_What)
#                     , family=binomial(link="logit"))
# glmer_examine(Term_Comp_08E)
# failure to converge in 10000 evaluations

#Plot the fitted values vs actual results
binned_fitted_versus_residuals(Term_Comp_08C)


#Plot residuals versus fittedO
residuals_term_plot(Term_Comp_08C)+
  labs(x="Estimated  Pr (Termination)")


#Plot the fitted values vs actual results
binned_fitted_versus_residuals(Term_Comp_08D)


#Plot residuals versus fittedO
residuals_term_plot(Term_Comp_08D)+
  labs(x="Estimated  Pr (Termination)")

# Term_Cons_08E <- glmer(data=smp,
#                  b_Term ~ c_HHI_lag1 + 
#                    cl_Ceil + cl_Days+ 
#                    SIDV + MIDV + FSSGWAC + BPABOA +
#                    c_HHI_lag1:cl_Ceil  +
#                    # cl_Ceil:cl_Days  + 
#                    c_HHI_lag1:cl_Days +
#                    n_Fixed + b_UCA + 
#                    b_Intl + 
#                    SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
#                    SIDV:c_HHI_lag1+MIDV:c_HHI_lag1+OIDV:c_HHI_lag1+
#                    b_UCA:c_HHI_lag1+
#                    (1+c_HHI_lag1  | PSR) + (1+ c_HHI_lag1 | PSR_What)
#                     , family=binomial(link="logit"))
# display(Term_Cons_08E)
# failure to converge in 10000 evaluations
```
The use of Comp as 


### Model 09A: Add International


```{r Model09A}

#Frequency Plot
freq_discrete_term_plot(smp,"NAICS")

#Percent Terminated Plot 
discrete_percent_term_plot(smp,"NAICS")

#Model failed to converge with max|grad| = 0.00993991 (tol = 0.001, component 1)
Term_Cons_09A <- glmer(data=smp,
                 b_Term ~c_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Fixed + b_UCA + 
                   b_Intl + 
                   (1 | Agency)
                  , family=binomial(link="logit"))
display(Term_Cons_09A)


#Model failed to converge with max|grad| = 0.00993991 (tol = 0.001, component 1)
Term_Comp_09A <- glmer(data=smp,
                 b_Term ~n_Comp + 
                   cl_Ceil + cl_Days+ 
                   Veh + 
                   n_Fixed + b_UCA + 
                   b_Intl + 
                   (1 | Agency)
                  , family=binomial(link="logit"))
glmer_examine(Term_Comp_09A)

#Create the model
# Term_Cons_08B <- glmer(data=smp,
#                  b_Term ~c_HHI_lag1 + 
#                    cl_Ceil + cl_Days+ 
#                    SIDV + MIDV + FSSGWAC + BPABOA +
#                    n_Fixed + b_UCA + 
#                    b_Intl + 
#                    c_HHI_lag1:cl_Ceil  + cl_Ceil:cl_Days  + c_HHI_lag1:cl_Days +
#                    SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
#                    SIDV:c_HHI_lag1+MIDV:c_HHI_lag1+OIDV:c_HHI_lag1+
#                    b_UCA:c_HHI_lag1+
#                    (1 | NAICS)
#                     , family=binomial(link="logit"))
# display(Term_Cons_08B)
#Ran for two hours Model failed to converge with max|grad| = 0.186396 (tol = 0.001, component 1)
# Plot the model and Vehicle 
# Term_Cons_08A_curve<-function(x, HHI,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
#   cbind(1,HHI,Ceil,Days,SIDV,MIDV,OIDV,
#         HHI*Ceil,Days*Ceil,Days*HHI,
#         Fixed,UCA,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         UCA*HHI) %*%  coef(Term_Cons_08A))}
# 
# #Days curves
# discrete_fitted_term_model(smp,"SIDV") +
#   stat_function(fun = Term_Cons_08A_curve,
#                              args=list(HHI=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1,UCA=0),color="blue")+
#   stat_function(fun = Term_Cons_08A_curve,
#                              args=list(HHI=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1,UCA=0),color="blue")
# 
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_residuals(Term_Cons_08A)
# 
# #Plot residuals versus fittedO
# residuals_term_plot(Term_Cons_08A)+
#   labs(x="Estimated  Pr (Termination)")

# residuals_term_plot(Term_Cons_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```







###Model 09A: oFFICE
The North American Industrial Classification system captures the sector of each contract, which are each given a seperate intercept in the model.
```{r Model09A}

#Frequency Plot
freq_discrete_term_plot(smp,"NAICS")

#Percent Terminated Plot 
discrete_percent_term_plot(smp,"NAICS")
smp$topContractingOfficeID
Term_Cons_09A <- glmer(data=smp,
                 b_Term ~c_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Fixed + b_UCA + 
                   # b_Intl +
                   (1 | topContractingOfficeID)
                  , family=binomial(link="logit"))
display(Term_Cons_09A)



#Create the model
# Term_Cons_09A <- glmer(data=smp,
#                  b_Term ~c_HHI_lag1 + 
#                    cl_Ceil + cl_Days+ 
#                    SIDV + MIDV + FSSGWAC + BPABOA +
#                    n_Fixed + b_UCA + 
#                    b_Intl + 
#                    c_HHI_lag1:cl_Ceil  + cl_Ceil:cl_Days  + c_HHI_lag1:cl_Days +
#                    SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
#                    SIDV:c_HHI_lag1+MIDV:c_HHI_lag1+OIDV:c_HHI_lag1+
#                    b_UCA:c_HHI_lag1+
#                    (1 | NAICS)
#                     , family=binomial(link="logit"))
# display(Term_Cons_09A)
#Ran for two hours Model failed to converge with max|grad| = 0.186396 (tol = 0.001, component 1)
# Plot the model and Vehicle 
Term_Cons_09A_curve<-function(x, HHI,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
  cbind(1,HHI,Ceil,Days,SIDV,MIDV,OIDV,
        HHI*Ceil,Days*Ceil,Days*HHI,
        Fixed,UCA,x,
        Days*x,Days*MIDV,Days*OIDV,
        UCA*HHI) %*%  coef(Term_Cons_09A))}

#Days curves
discrete_fitted_term_model(smp,"SIDV") +
  stat_function(fun = Term_Cons_09A_curve,
                             args=list(HHI=0,Ceil=0,Days=0,
                                       MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
                                       Fixed=1,UCA=0),color="blue")+
  stat_function(fun = Term_Cons_09A_curve,
                             args=list(HHI=2,Ceil=0,Days=1,
                                       MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
                                       Fixed=1,UCA=0),color="blue")


#Plot the fitted values vs actual results
binned_fitted_versus_residuals(Term_Cons_09A)

#Plot residuals versus fittedO
residuals_term_plot(Term_Cons_09A)+
  labs(x="Estimated  Pr (Termination)")

# residuals_term_plot(Term_Cons_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```






### Model 09B

```{r Model09B}

#Frequency Plot
freq_discrete_term_plot(smp,"NAICS")

#Percent Terminated Plot 
discrete_percent_term_plot(smp,"NAICS")

#Model failed to converge with max|grad| = 0.00993991 (tol = 0.001, component 1)
Term_Cons_09A <- glmer(data=smp,
                 b_Term ~c_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   SIDV + MIDV + FSSGWAC + BPABOA +
                   n_Fixed + b_UCA + 
                   b_Intl + 
                   (1 | Agency)
                  , family=binomial(link="logit"))
display(Term_Cons_09A)

#Create the model
# Term_Cons_08B <- glmer(data=smp,
#                  b_Term ~c_HHI_lag1 + 
#                    cl_Ceil + cl_Days+ 
#                    SIDV + MIDV + FSSGWAC + BPABOA +
#                    n_Fixed + b_UCA + 
#                    b_Intl + 
#                    c_HHI_lag1:cl_Ceil  + cl_Ceil:cl_Days  + c_HHI_lag1:cl_Days +
#                    SIDV:cl_Days+MIDV:cl_Days+OIDV:cl_Days +
#                    SIDV:c_HHI_lag1+MIDV:c_HHI_lag1+OIDV:c_HHI_lag1+
#                    b_UCA:c_HHI_lag1+
#                    (1 | NAICS)
#                     , family=binomial(link="logit"))
# display(Term_Cons_08B)
#Ran for two hours Model failed to converge with max|grad| = 0.186396 (tol = 0.001, component 1)
# Plot the model and Vehicle 
# Term_Cons_08A_curve<-function(x, HHI,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
#   cbind(1,HHI,Ceil,Days,SIDV,MIDV,OIDV,
#         HHI*Ceil,Days*Ceil,Days*HHI,
#         Fixed,UCA,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         UCA*HHI) %*%  coef(Term_Cons_08A))}
# 
# #Days curves
# discrete_fitted_term_model(smp,"SIDV") +
#   stat_function(fun = Term_Cons_08A_curve,
#                              args=list(HHI=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1,UCA=0),color="blue")+
#   stat_function(fun = Term_Cons_08A_curve,
#                              args=list(HHI=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1,UCA=0),color="blue")
# 
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_residuals(Term_Cons_08A)
# 
# #Plot residuals versus fittedO
# residuals_term_plot(Term_Cons_08A)+
#   labs(x="Estimated  Pr (Termination)")

# residuals_term_plot(Term_Cons_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

```
