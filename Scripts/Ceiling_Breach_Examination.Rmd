---
title: "Ceiling_Breach_Examination"
author: "Greg Sanders"
date: "June 24, 2019"
output: 
  html_document: 
    fig_caption: yes
    keep_md: yes
    number_sections: yes
    toc: yes
---


#Setup
```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(arm)
library(R2WinBUGS)
library(knitr)
library(foreign)
library(stargazer)
library(texreg)
library(reshape2)
source("DIIGstat.r")

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40


```

```{r vargraphs: b_CBre}
# load(file="../Data/Clean/transformed_def.Rdata")
load(file="..\\data\\semi_clean\\CBre_pre_clean.rdata")
# W912UM <- def %>% filter(Office=="W912UM")
# W912UMtrans<-read.delim(file="..\\data\\semi_clean\\W912UM_trans.csv", sep=",")
# W912UMtrans<-remove_bom(W912UMtrans)
# cbre_preclean<-def %>% filter(b_CBre==1)
# cbre_preclean$qGrowth<-Hmisc::cut2(cbre_preclean$p_CBre-1,c(1,10))
# summary(cbre_preclean$qGrowth)
# save(W912UM,W912UMtrans,cbre_preclean,file="..\\data\\semi_clean\\CBre_pre_clean.rdata")

# colnames(W912UM)[colnames(W912UM)=="UnmodifiedCeiling_Then_Year"]<-"UnmodifiedCeiling"
# debug(input_contract_delta)
# W912UM<-input_contract_delta(W912UM,
#              file="Contract.SP_ContractModificationDeltaCustomer.txt")
# colnames(W912UM)[colnames(W912UM)=="UnmodifiedCeiling"]<-"UnmodifiedCeiling_Then_Year"
# debug(read_and_join_experiment)
  # W912UM<-read_and_join_experiment( W912UM,
  #                                       "Contract.sp_ContractExercisedOptions.txt",
  #                                       path="",
  #                                       directory="..\\data\\semi_clean\\",
  #                                       by=c("CSIScontractID"),
  #                                       add_var=c("AnyUnmodifiedUnexercisedOptions",
  #                                                 "AnyUnmodifiedUnexercisedOptionsWhy",
  #                                                 "UnmodifiedBase",
  #                                                 "SteadyScopeOptionGrowthAlone",
  #                                                 "SteadyScopeOptionRescision",
  #                                                 "AdminOptionModification"),
  #                                       new_var_checked=FALSE,
  #                                       create_lookup_rdata=TRUE,
  #                                       lookup_char_as_factor=TRUE)
  
```



# Before Cleaning
```{r CeilingOutlier_pre}
nrow(cbre_preclean %>% filter((p_CBre-1)>1))
nrow(cbre_preclean %>% filter((p_CBre-1)>10))
nrow(cbre_preclean %>% filter((p_CBre-1)>100))
nrow(cbre_preclean %>% filter((p_CBre-1)>100 & UnmodifiedCeiling_Then_Year<=0))
summary(cbre_preclean$Ceil[(cbre_preclean$p_CBre-1)>10 & cbre_preclean$UnmodifiedCeiling_Then_Year>0])
summary(cbre_preclean$Ceil[(cbre_preclean$p_CBre-1)>100 & cbre_preclean$UnmodifiedCeiling_Then_Year>0])
cbre_preclean$Why_Outlier<-NA
cbre_preclean$Why_Outlier[cbre_preclean$UnmodifiedCeiling_Then_Year<=0]<-"No Unmodified Ceiling"
cbre_preclean$Why_Outlier[is.na(cbre_preclean$Why_Outlier)&
                            cbre_preclean$Action_Obligation_Then_Year*2>=cbre_preclean$UnmodifiedCeiling_Then_Year+
                            cbre_preclean$n_CBre]<-
  "Obligations at least half Orig+CRai"
cbre_preclean$Why_Outlier[is.na(cbre_preclean$Why_Outlier)&
                            cbre_preclean$Office=="W912UM"]<-
  "Korean Office W912UM"
cbre_preclean$Why_Outlier[is.na(cbre_preclean$Why_Outlier)&
                            cbre_preclean$n_CBre>=2.5e8]<-
  ">=$250M, Insepect"
cbre_preclean$Why_Outlier[is.na(cbre_preclean$Why_Outlier)&
                            cbre_preclean$p_CBre-1>10]<-
  "Other Unexplained 10x Ceiling Breach"
cbre_preclean$Why_Outlier<-factor(cbre_preclean$Why_Outlier,
                                  levels=c(
                                    "No Unmodified Ceiling",
                                    "Obligations at least half Orig+CRai",
                                    "Later Deobligated",
                                    "Korean Office W912UM",
                                    ">=$250M, Insepect",
                                    "Other Unexplained 10x Ceiling Breach"
                                  ))
summary(cbre_preclean$Why_Outlier[(cbre_preclean$p_CBre-1)>10])
summary(cbre_preclean$Why_Outlier)


p_outlier_summary<-cbre_preclean %>% filter(p_CBre-1>10) %>% group_by(Why_Outlier) %>%
  dplyr::summarise(nContract=length(n_CBre),
                   SumOfChangeOrderCeilingGrowth=sum(n_CBre),
                   MaxOfChangeOrderCeilingGrowth=max(n_CBre),
                   SumOfAction_Obligation_Then_Year=sum(Action_Obligation_Then_Year))


n_outlier_summary<-cbre_preclean %>% filter(n_CBre>2.5e8) %>% group_by(Why_Outlier) %>%
  dplyr::summarise(nContract=length(n_CBre),
                   SumOfChangeOrderCeilingGrowth=sum(n_CBre),
                   MaxOfChangeOrderCeilingGrowth=max(n_CBre),
                   SumOfAction_Obligation_Then_Year=sum(Action_Obligation_Then_Year))


summary(Hmisc::cut2(cbre_preclean$n_CBre,c(1e3,
                                           1e6,
                                           1e7,
                                           1e8,
                                           2.5e8,
                                           1e9,
                                           1e10,
                                           2e10
)))
summary(cbre_preclean$Ceil[cbre_preclean$n_CBre>=1e6])
summary(cbre_preclean$Ceil[cbre_preclean$n_CBre>=1e9])


write.csv(file="..\\Data\\semi_clean\\p_CBre_outliers.csv",cbre_preclean %>% filter((p_CBre-1)>10),row.names = FALSE)
write.csv(file="..\\Data\\semi_clean\\n_CBre_outliers.csv",cbre_preclean %>% filter(n_CBre>=2.5e8),row.names = FALSE)
```
Examining cases of large ceiling growth, `r nrow(cbre_preclean %>% filter(p_CBre-1>10))` contracts experienced greater than 10 fold growth. An increase of that side strains credulity, even in high risk defense contracting. While by no means impossible, the more likely explaination is a misrecorded initial ceiling.

The study team broke down the outliers into 6 categories:
`r knitr::kable(p_outlier_summary)`
* No Unmodified Ceiling: Contracts with an initial ceiling <=0. These are eliminated from the sample as missing data.
* Obligations at least half Orig+CRai: For this category, total obligations of the contract were at least half the value of the initial ceiling plus ceiling growth under change orders. These contrats have had spending that massively exceeded their original ceiling, so the growth in absolute terrms seems plausible. This category accounts for the overwhelming majority of outlier spending but only a tiny fraction of change order growth.
* Later Deobligated: The change order growth metrics only counts increases. These may simply have been mistaken increases, as when including deobligation the growth no longer exceeded 10x the original ceiling. The number, obligations, and change order growth of these contracts are comparatively small, and thus should not distort the overall data.
* Korean Office W912UM refers to a contracting office that sometimes records base and all options values in Korean Won, approximate exchange rate 1,000 Won : 1 USD. 
* There are nrow(cbre_preclean %>% dplyr::filter(Why_Outlier ==">=$250M, Insepect" & (p_CBre-1)>10)) contracts with ceiling growth of over $250 million that account for hundreds of billions in change order growth. These merit manual inspection.
* Finally a few score contrats have unexplained growth, but remain below the $10M threshold. The quantity and magnitude of these contrats is not sufficient to risk the overall model.

This examination left the study team less confident in percentage growth as a metric, especially in extreme cases, while increasing the study team's confidence in measures of growth in absoute term. In the worst case, simply removing all of the unexplained over  10 million contracts from the sample would reduce the number of contracts by a tiny amount and reduce the spending accounted for by  `r sum(cbre_preclean$Action_Obligation_Then_Year[cbre_preclean$Why_Outlier ==">=$250M, Insepect"& (cbre_preclean$p_CBre-1)>10] ,na.rm=TRUE)`.

Shifting the focus to all contracts with growth of at least 250 million, there are far fewer contracts that account for far more money.
`r knitr::kable(n_outlier_summary)`

Inspecting W912UM, either to remove or fix its oversized growth, is an imperative as it accounts for the majority of these contracts or task orders. Even so, there are still `r nrow(cbre_preclean %>% filter(Why_Outlier ==">=$250M, Insepect"))` That merit special inspection for given that there growth far outpaces their spending.

## Ceiling Change Checksum
```{r CeilingChangeChecksum}
# load(file="..\\data\\clean\\defense_contract_all_detail.Rdata")
# 
# if(any(
#   def_all$UnmodifiedCeiling+
#   def_all$ChangeOrderCeilingGrowth+
#   def_all$ChangeOrderCeilingRescision+
#     def_all$AdminCeilingModification+
#     def_all$EndingCeilingModification+
#     def_all$OtherCeilingModification!=
#     def_all$SumOfBaseandalloptionsvalue
# )) stop("Ceiling Modification Checksum failure.")
  # rm(def_all)
#Cn't do this yet, need SumOfBaseandalloptionsvalue
```


## Ceiling Growth
```{r CeilingGrowthGraphs}

(
  ggplot(cbre_preclean, aes(x=UnmodifiedCeiling_Then_Year,y=p_CBre-1)) +#,color=qGrowth
    geom_point(alpha=0.25,shape=".")+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()+
    #+
    geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
    # facet_wrap(~Ceil,scales="free_y")+#+, space="free_y"
    labs(title="Distribution of Ceiling Breaches",
         y="Percent of Growth in  Ceiling",
         x="Unmodified Contract Ceiling")#,
  # fill="Termination Completion"
)


(
  ggplot(cbre_preclean, aes(x=UnmodifiedCeiling_Then_Year,y=n_CBre)) +#,color=qGrowth
    geom_point(alpha=0.25,shape=".")+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()+
    #+
    geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
    # facet_wrap(~Ceil,scales="free_y")+#+, space="free_y"
    labs(title="Distribution of Ceiling Breaches",
         y="Absolute Growth in  Ceiling",
         x="Unmodified Contract Ceiling")#,
  # fill="Termination Completion"
)

(
  ggplot(cbre_preclean, aes(x=UnmodifiedCeiling_Then_Year+ChangeOrderCeilingGrowth+ChangeOrderCeilingRescision,y=Action_Obligation_Then_Year)) +#,color=qGrowth
    geom_point(alpha=0.25,shape=".")+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()#+
  #+
  #   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
  # # facet_wrap(~Ceil,scales="free_y")+#+, space="free_y"
  #   labs(title="Distribution of Ceiling Breaches",
  #        y="Percent of Growth in  Ceiling",
  #        x="Unmodified Contract Ceiling")#,
  #        # fill="Termination Completion"
)

summary(cbre_preclean$ChangeOrderCeilingGrowth)
summary(cbre_preclean$ChangeOrderCeilingRescision)




(
  ggplot(cbre_preclean, aes(x=n_CBre,y=ChangeOrderCeilingGrowth+ChangeOrderCeilingRescision)) +#,color=qGrowth
    geom_point(alpha=0.25,shape=".")+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()#+
  #+
  #   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
  # # facet_wrap(~Ceil,scales="free_y")+#+, space="free_y"
  #   labs(title="Distribution of Ceiling Breaches",
  #        y="Percent of Growth in  Ceiling",
  #        x="Unmodified Contract Ceiling")#,
  #        # fill="Termination Completion"
)

(
  ggplot(cbre_preclean, aes(x=p_CBre-1,fill=qGrowth)) +
    geom_histogram(bins=100)+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+
    #+
    geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
    facet_wrap(~Ceil,scales="free_y")+#+, space="free_y"
    labs(title="Distribution of Ceiling Breaches",
         y="Contract Count",
         x="Percent of Growth in  Ceiling")#,
  # fill="Termination Completion"
)






(
  ggplot(cbre_preclean, aes(x=n_CBre,fill=qGrowth)) +
    geom_histogram(bins=100)+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+
    #+
    geom_vline(xintercept = 1)#+geom_vline(xintercept = 0.1)+
  #facet_grid(NoPreTermObl~.,scales="free_y", space="free_y")+
  # labs(title="Distribution of Contracts with Obligations After Last termination",
  #      y="Contract Count",
  #      x="Percent of Obligations After Day of Termination",
  #      fill="Termination Completion"
)

(
  ggplot(cbre_preclean, aes(x=n_CBre,fill=qGrowth)) +
    geom_histogram(bins=100)+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+
    #+
    geom_vline(xintercept = 1)+
    facet_wrap(~Ceil,scales="free_y")#+, space="free_y"
  #+geom_vline(xintercept = 0.1)+
  #facet_grid(NoPreTermObl~.,scales="free_y", space="free_y")+
  # labs(title="Distribution of Contracts with Obligations After Last termination",
  #      y="Contract Count",
  #      x="Percent of Obligations After Day of Termination",
  #      fill="Termination Completion"
)


```

## >250 Inspect
```{r gt250k}
inspect250<-cbre_preclean %>% filter(Why_Outlier==">=$250M, Insepect")
inspect250trans<-read.delim(file="..\\data\\semi_clean\\gt250k_change_outliers.txt", sep="\t")

inspect250trans %>% group_by(CSIScontractID)



#This is obviously unfinished, just  managed the download  this morning
```
CSIScontractID 1431340 IDV -- FA881111C0001. This is a MDAP "LETTER CONTRACT FOR MUOS-2, WGS-6, NROL-65" The massive change order is for "FY 12 ATLAS-V MISSIONS AND FY12 DELTA IV MISSIONS" This is later descreased for "TRANSFER THE FY-12 MISSIONS OFF THIS CONTRACT AND RE-ALIGN ONTO CONTRACT FA8811-13-C-0002 FOR ADMINISTRATIVE PURPOSES." and "DEFINITIZATION OF DELTA IV ELS UCA MISSIONS: NROL-65, WGS-6, AND WGS-5" before being increased again for "DEFINITIZE ATLAS FY 12 LAUNCH SERVICE MISSIONS INITIALLY AWARDED VIA P00012". Thus the amounts seem entirely realistic.

CSIScontractID 8341560 IDV -- PIID W912GB09C0090. "FIELD MODIFICATION A00002, CR 002 CONVOY LIVE FIRE RANGE" with 344 billion increase immediately rescinded "ADMINISTRATIVE MODIFICATION TO CORRECT TYPOGRAPHICAL ERROR ON PRIOR MODIFICATION. THIS CONTRACT ACTION IS GOVERNED BY THE ABG75 PROCESS AND NOT THE FAR." which was an other administrative action. Overriding.

CSIScontractID 10090818 IDV FA860410D7045 / PIID 1 "DESCOPE CLINS 1001,2001,3001,4001,  5001 AND ADD NEW REVISED PWS 0001" is a single transaction responsible for  289,097,216 increase. Software development "ADP SYSTEMS DEVELOPMENT SERVICES" Seems improbable, especially considering there's a ceiling increase that's literally one percent of the size in the next transaction, but the evidence isn't overwhelmiing


CSIScontractID 19005830 IDV N4008005D3501 / PIID 87
$13 billion ceiling for "MISC SERVICE & TRADE EQ" / "FFP BASE OPERATIONS SUPPORT SERVICES FOR PHASE IN PERIOD OF 01/01/2012 - 02/29/2012." Seems safely classified as a mistake even absent any subsequent correction.

CSIScontractID 24816950 IDV W912HN07D0061 / PIID 4
"PROJECT NUMBER 71657, STARSHIP 11000 REPAIR, FORT JACKSON, SC"

CSIS contractID 24719937 IDV W9126G08D0016 / PIID 1
Construction of "STUDENT DORMITORIES 1 & 2" 447M corrected by the next transaction in an other administrative action.


## W912IM

### Contract Initial Examination

#### Ceiling/Change Orders  
```{r W912UM}
sum(W912UM$Action_Obligation_Then_Year[])

(
  ggplot(W912UM, aes(x=UnmodifiedCeiling_Then_Year+ChangeOrderCeilingGrowth+ChangeOrderCeilingRescision,y=Action_Obligation_Then_Year)) +#,color=qGrowth
    geom_point(alpha=0.25,shape=".")+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()+
    #+
    #   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
    facet_wrap(~StartFY,scales="free_y")#+, space="free_y"
  #   labs(title="Distribution of Ceiling Breaches",
  #        y="Percent of Growth in  Ceiling",
  #        x="Unmodified Contract Ceiling")#,
  #        # fill="Termination Completion"
)

summary(W912UM$UnmodifiedCeiling_Then_Year)
W912UM$unmodWon<-NA
W912UM$unmodWon[W912UM$UnmodifiedCeiling_Then_Year>=W912UM$Action_Obligation_Then_Year*400&
                  W912UM$Action_Obligation_Then_Year>0]<-'WON Unm'
W912UM$unmodWon[is.na(W912UM$unmodWon) &
                  W912UM$UnmodifiedCeiling_Then_Year>=W912UM$Action_Obligation_Then_Year*20 &
                  W912UM$UnmodifiedCeiling_Then_Year>10000
                ]<-'? Unm'
W912UM$unmodWon[is.na(W912UM$unmodWon) &
                  (W912UM$UnmodifiedCeiling_Then_Year<W912UM$Action_Obligation_Then_Year*20|
                     W912UM$UnmodifiedCeiling_Then_Year<10000)]<-'$ Unm'
summary(factor(W912UM$unmodWon))


W912UM$changeWon<-NA
W912UM$changeWon[abs(W912UM$ChangeOrderCeilingGrowth+W912UM$ChangeOrderCeilingRescision)==0]<-'0 Chg'
W912UM$changeWon[abs(W912UM$ChangeOrderCeilingGrowth+W912UM$ChangeOrderCeilingRescision)>=W912UM$Action_Obligation_Then_Year*100&
                   W912UM$ChangeOrderCeilingGrowth+W912UM$ChangeOrderCeilingRescision>10000]<-'WON Chg'
W912UM$changeWon[is.na(W912UM$changeWon) &
                   abs(W912UM$ChangeOrderCeilingGrowth+W912UM$ChangeOrderCeilingRescision)>=W912UM$Action_Obligation_Then_Year*10&
                   W912UM$ChangeOrderCeilingGrowth+W912UM$ChangeOrderCeilingRescision>10000]<-'? Chg'
W912UM$changeWon[is.na(W912UM$changeWon) &
                   (abs(W912UM$ChangeOrderCeilingGrowth+W912UM$ChangeOrderCeilingRescision)<W912UM$Action_Obligation_Then_Year*10|
                      W912UM$ChangeOrderCeilingGrowth+W912UM$ChangeOrderCeilingRescision<=10000)]<-'$ Chg'
summary(factor(W912UM$changeWon))


W912UM$sumWon<-NA
W912UM$sumWon[W912UM$Action_Obligation_Then_Year==0]<-'0 Obl'
W912UM$sumWon[W912UM$UnmodifiedCeiling_Then_Year+
                W912UM$ChangeOrderCeilingGrowth+W912UM$ChangeOrderCeilingRescision>=W912UM$Action_Obligation_Then_Year*400&
                W912UM$UnmodifiedCeiling_Then_Year+
                W912UM$ChangeOrderCeilingGrowth+W912UM$ChangeOrderCeilingRescision>10000]<-'WON Sum'
W912UM$sumWon[is.na(W912UM$sumWon) &
                W912UM$UnmodifiedCeiling_Then_Year+
                W912UM$ChangeOrderCeilingGrowth+W912UM$ChangeOrderCeilingRescision>=W912UM$Action_Obligation_Then_Year*20&
                W912UM$UnmodifiedCeiling_Then_Year+
                W912UM$ChangeOrderCeilingGrowth+W912UM$ChangeOrderCeilingRescision>10000]<-'? Sum'
W912UM$sumWon[is.na(W912UM$sumWon) &
                (W912UM$UnmodifiedCeiling_Then_Year+
                   W912UM$ChangeOrderCeilingGrowth+W912UM$ChangeOrderCeilingRescision<W912UM$Action_Obligation_Then_Year*20|
                   W912UM$UnmodifiedCeiling_Then_Year+
                   W912UM$ChangeOrderCeilingGrowth+W912UM$ChangeOrderCeilingRescision>10000)]<-'$ Sum'
summary(factor(W912UM$sumWon))



(
  ggplot(W912UM, aes(x=UnmodifiedCeiling_Then_Year+ChangeOrderBaseAndAllOptionsValue,y=Action_Obligation_Then_Year,color=sumWon)) +#,color=qGrowth
    geom_point(alpha=0.25)+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()+
    #+
    #   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
    facet_grid(unmodWon~changeWon)#+, space="free_y"
  #   labs(title="Distribution of Ceiling Breaches",
  #        y="Percent of Growth in  Ceiling",
  #        x="Unmodified Contract Ceiling")#,
  #        # fill="Termination Completion"
)


(
  ggplot(W912UM, aes(x=UnmodifiedCeiling_Then_Year+ChangeOrderBaseAndAllOptionsValue,y=Action_Obligation_Then_Year,color=sumWon)) +#,color=qGrowth
    geom_point(alpha=0.25)+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()+
    #+
    #   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
    facet_wrap(~Veh)#+, space="free_y"
  #   labs(title="Distribution of Ceiling Breaches",
  #        y="Percent of Growth in  Ceiling",
  #        x="Unmodified Contract Ceiling")#,
  #        # fill="Termination Completion"
)

(
  ggplot(W912UM, aes(x=UnmodifiedCeiling_Then_Year+ChangeOrderCeilingGrowth+ChangeOrderCeilingRescision,y=Action_Obligation_Then_Year,color=sumWon)) +#,color=qGrowth
    geom_point(alpha=0.25)+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()+
    #+
    #   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
    facet_wrap(~Intl)#+, space="free_y"
  #   labs(title="Distribution of Ceiling Breaches",
  #        y="Percent of Growth in  Ceiling",
  #        x="Unmodified Contract Ceiling")#,
  #        # fill="Termination Completion"
)

summary(W912UM$Intl)
W912UM$unmodWon<-factor(W912UM$unmodWon)
summary(W912UM$Veh)
summary(W912UM$unmodWon)
summary(factor(W912UM$changeWon))
statsummary_discrete(c("unmodWon"), W912UM %>% filter(Intl=="Any Intl."&
                                                        !Veh %in% c("FSS/GWAC","BPA/BOA")),
                     value_col="Action_Obligation_Then_Year")

```

All of the questionable contracts take place internationally and none use BPA/BOA or FSS/GWACs. That makes sense and raises confidence, but given that the clearly USD contract categories are less common, this doesn't help in resolving the ambiguous cases. That said, Single Award IDCs appear to have most of the ambigious cases, which suggests that this might be resolvable by looking at parent IDVs in those cases. 

#### Base/Options
```{r W912UMExercised}
(
  ggplot(W912UM, aes(x=UnmodifiedBase+SteadyScopeOptionGrowthAlone,y=Action_Obligation_Then_Year)) +#,color=q_OptGrowth
    geom_point(alpha=0.25,shape=".")+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()+
    #+
    #   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
    facet_wrap(~StartFY,scales="free_y")#+, space="free_y"
  #   labs(title="Distribution of Exercised Options",
  #        y="Percent of Options Growth from Base",
  #        x="Unmodified Contract Base")#,
  #        # fill="Termination Completion"
)

summary(W912UM$UnmodifiedBase)
W912UM$baseWon<-NA
W912UM$baseWon[W912UM$UnmodifiedBase>=W912UM$Action_Obligation_Then_Year*400&
                 W912UM$Action_Obligation_Then_Year>0]<-'WON Base'
W912UM$baseWon[is.na(W912UM$baseWon) &
                 W912UM$UnmodifiedBase>=W912UM$Action_Obligation_Then_Year*20 &
                 W912UM$UnmodifiedBase>10000
               ]<-'? Base'
W912UM$baseWon[is.na(W912UM$baseWon) &
                 (W912UM$UnmodifiedBase<W912UM$Action_Obligation_Then_Year*20|
                    W912UM$UnmodifiedBase<10000)]<-'$ Base'
summary(factor(W912UM$baseWon))


W912UM$optWon<-NA
W912UM$optWon[abs(W912UM$SteadyScopeOptionGrowthAlone)==0]<-'0 Opt'
W912UM$optWon[abs(W912UM$SteadyScopeOptionGrowthAlone)>=W912UM$Action_Obligation_Then_Year*100&
                W912UM$SteadyScopeOptionGrowthAlone>10000]<-'WON Opt'
W912UM$optWon[is.na(W912UM$optWon) &
                abs(W912UM$SteadyScopeOptionGrowthAlone)>=W912UM$Action_Obligation_Then_Year*10&
                W912UM$SteadyScopeOptionGrowthAlone>10000]<-'? Opt'
W912UM$optWon[is.na(W912UM$optWon) &
                (abs(W912UM$SteadyScopeOptionGrowthAlone)<W912UM$Action_Obligation_Then_Year*10|
                   W912UM$SteadyScopeOptionGrowthAlone<=10000)]<-'$ Opt'
summary(factor(W912UM$optWon))


W912UM$sumWon<-NA
W912UM$sumWon[W912UM$Action_Obligation_Then_Year==0]<-'0 Obl'
W912UM$sumWon[W912UM$UnmodifiedBase+
                W912UM$SteadyScopeOptionGrowthAlone>=W912UM$Action_Obligation_Then_Year*400&
                W912UM$UnmodifiedBase+
                W912UM$SteadyScopeOptionGrowthAlone>10000]<-'WON Sum'
W912UM$sumWon[is.na(W912UM$sumWon) &
                W912UM$UnmodifiedBase+
                W912UM$SteadyScopeOptionGrowthAlone>=W912UM$Action_Obligation_Then_Year*20&
                W912UM$UnmodifiedBase+
                W912UM$SteadyScopeOptionGrowthAlone>10000]<-'? Sum'
W912UM$sumWon[is.na(W912UM$sumWon) &
                (W912UM$UnmodifiedBase+
                   W912UM$SteadyScopeOptionGrowthAlone<W912UM$Action_Obligation_Then_Year*20|
                   W912UM$UnmodifiedBase+
                   W912UM$SteadyScopeOptionGrowthAlone>10000)]<-'$ Sum'
summary(factor(W912UM$sumWon))



(
  ggplot(W912UM, aes(x=UnmodifiedBase+SteadyScopeOptionGrowthAlone,y=Action_Obligation_Then_Year,color=sumWon)) +#,color=q_OptGrowth
    geom_point(alpha=0.25)+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()+
    #+
    #   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
    facet_grid(baseWon~optWon)#+, space="free_y"
  #   labs(title="Distribution of Exercised Options",
  #        y="Percent of Options Growth from Base",
  #        x="Unmodified Contract Base")#,
  #        # fill="Termination Completion"
)


(
  ggplot(W912UM, aes(x=UnmodifiedBase+SteadyScopeOptionGrowthAlone,y=Action_Obligation_Then_Year,color=sumWon)) +#,color=q_OptGrowth
    geom_point(alpha=0.25)+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()+
    #+
    #   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
    facet_wrap(~Veh)#+, space="free_y"
  #   labs(title="Distribution of Exercised Options",
  #        y="Percent of Options Growth from Base",
  #        x="Unmodified Contract Base")#,
  #        # fill="Termination Completion"
)

(
  ggplot(W912UM, aes(x=UnmodifiedBase+SteadyScopeOptionGrowthAlone,y=Action_Obligation_Then_Year,color=sumWon)) +#,color=q_OptGrowth
    geom_point(alpha=0.25)+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()+
    #+
    #   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
    facet_wrap(~Intl)#+, space="free_y"
  #   labs(title="Distribution of Exercised Options",
  #        y="Percent of Options Growth from Base",
  #        x="Unmodified Contract Base")#,
  #        # fill="Termination Completion"
)

summary(W912UM$Intl)
W912UM$baseWon<-factor(W912UM$baseWon)
summary(W912UM$Veh)
summary(W912UM$baseWon)
summary(factor(W912UM$optWon))
statsummary_discrete(c("baseWon"), W912UM %>% filter(Intl=="Any Intl."&
                                                       !Veh %in% c("FSS/GWAC","BPA/BOA")),
                     value_col="Action_Obligation_Then_Year")

```

All of the questionable contracts take place internationally and none use BPA/BOA or FSS/GWACs. That makes sense and raises confidence, but given that the clearly USD contract categories are less common, this doesn't help in resolving the ambiguous cases. That said, Single Award IDCs appear to have most of the ambigious cases, which suggests that this might be resolvable by looking at parent IDVs in those cases. 

### Transaction
#### Unmodified Transactions
##### Ceiling
```{r W912UM_transction_unmodified}
# W912UMtrans<-read.delim(file="..\\data\\semi_clean\\W912UM_complete.txt", sep="\t")



W912UMtrans<-inner_join(W912UMtrans,W912UM %>% group_by() %>%
                          dplyr::select(CSIScontractID,
                                        unmodWon,sumWon,changeWon,baseWon,optWon,
                                        ChangeOrderCeilingGrowth,
                                        ChangeOrderCeilingRescision,
                                        UnmodifiedCeiling_Then_Year,
                                        Action_Obligation_Then_Year,
                                        UnmodifiedBase,
                                        SteadyScopeOptionGrowthAlone,
                                        n_CBre),
                        by="CSIScontractID")

W912UMtrans$unmodWonT<-NA
W912UMtrans$unmodWonT[W912UMtrans$baseandalloptionsvalue>=W912UMtrans$obligatedamount*400&
                        W912UMtrans$baseandalloptionsvalue>10000&
                        W912UMtrans$baseandalloptionsvalue>=W912UMtrans$Action_Obligation_Then_Year*400&
                        (W912UMtrans$obligatedamount>0 | W912UMtrans$Action_Obligation_Then_Year>0)& 
                        W912UMtrans$modnumber=='0']<-'WON Unm'
W912UMtrans$unmodWonT[is.na(W912UMtrans$unmodWonT) &
                        W912UMtrans$baseandalloptionsvalue>=W912UMtrans$obligatedamount*20&
                        W912UMtrans$baseandalloptionsvalue>10000&
                        W912UMtrans$baseandalloptionsvalue>=W912UMtrans$Action_Obligation_Then_Year*20&
                        W912UMtrans$modnumber=='0']<-'? Unm'
W912UMtrans$unmodWonT[is.na(W912UMtrans$unmodWonT) &
                        (W912UMtrans$baseandalloptionsvalue<W912UMtrans$obligatedamount*20|
                           W912UMtrans$baseandalloptionsvalue<W912UMtrans$Action_Obligation_Then_Year*20|
                           W912UMtrans$baseandalloptionsvalue<=10000) &
                        W912UMtrans$modnumber=='0']<-'$ Unm'
W912UMtrans$unmodWonT[W912UMtrans$modnumber!='0']<-"Not Unmodified Transaction"




summary(factor(W912UMtrans$unmodWonT))

if(any(is.na(W912UMtrans$unmodWonT))) stop("Unclassified unmodWonT")
# View(W912UMtrans[is.na(),])
# write.csv(file="..\\Data\\semi_clean\\NA_unmodWonT.csv",W912UMtrans[is.na(W912UMtrans$unmodWonT),],row.names = FALSE)

#Examining disagreements
# View(W912UMtrans %>% filter(unmodWonT=='WON Unm'& unmodWon!='WON Unm') )
# View(W912UMtrans %>% filter(unmodWonT!='WON Unm'& unmodWon=='WON Unm') )
#Examining ?s
# View(W912UMtrans %>% filter(unmodWonT=='? Unm'& obligatedamount>0) )
# View(W912UMtrans %>% filter(unmodWonT=='? Unm'& obligatedamount==0) )


statsummary_discrete(c("unmodWon"),W912UMtrans %>% filter(modnumber=='0'),
                     value_col="Action_Obligation_Then_Year")
grouped_barplot(c("unmodWon"),W912UMtrans %>% filter(modnumber=='0'),
                value_col="Action_Obligation_Then_Year")

UnmodDisagree<-W912UMtrans %>% filter(unmodWonT=='WON Unm'& unmodWon!='WON Unm') 
# View(W912UM %>% filter(CSIScontractID %in% UnmodDisagree$CSIScontractID))
CSIScontractID_ceil_to_na<-W912UMtrans$CSIScontractID[W912UMtrans$unmodWonT == 'WON Unm'&
                                                        !is.na(W912UMtrans$unmodWonT)]


#Spreading  the labeled values to modified entries, which helps in the next step.
W912UMtrans$unmodWonT[W912UMtrans$unmodWonT=="Not Unmodified Transaction" &
                        W912UMtrans$CSIScontractID %in% CSIScontractID_ceil_to_na]<-'WON Unm'
# 
W912UMtrans$unmodWonT[W912UMtrans$unmodWonT=="Not Unmodified Transaction" &
                        W912UMtrans$CSIScontractID %in% W912UMtrans$CSIScontractID[W912UMtrans$unmodWonT == '? Unm'&
                                                                                     !is.na(W912UMtrans$unmodWonT)]]<- '? Unm'
W912UMtrans$unmodWonT[W912UMtrans$unmodWonT=="Not Unmodified Transaction" &
                        W912UMtrans$CSIScontractID %in%
                        W912UMtrans$CSIScontractID[W912UMtrans$unmodWonT == '$ Unm'& 
                                                     !is.na(W912UMtrans$unmodWonT)]]<- '$ Unm'

summary(factor(W912UMtrans$unmodWonT))
```


Contracts ceilings are marked null if:
* Contracting office W912UM 
* Initial transaction has a ceiling 400 times obligations.
* Initial ceiling 400 times total obligations.
* Initial or total obligations are positive.
Then it the ceiling is set to NA and it will not be in the sample.

##### Base
```{r W912UM_exercised_transction_base}
# W912UMtrans<-read.delim(file="..\\data\\semi_clean\\W912UM_complete.txt", sep="\t")



W912UMtrans$SteadyScopeOptionGrowthAlone[is.na(W912UMtrans$SteadyScopeOptionGrowthAlone)]<-0
W912UMtrans$baseandexercisedoptionsvalue<-as.numeric(as.character(W912UMtrans$baseandexercisedoptionsvalue))
W912UMtrans$baseWonT<-NA
W912UMtrans$baseWonT[W912UMtrans$baseandexercisedoptionsvalue>=W912UMtrans$obligatedamount*400&
                       W912UMtrans$baseandexercisedoptionsvalue>10000&
                       W912UMtrans$baseandexercisedoptionsvalue>=W912UMtrans$Action_Obligation_Then_Year*400&
                       (W912UMtrans$obligatedamount>0 | W912UMtrans$Action_Obligation_Then_Year>0)& 
                       W912UMtrans$modnumber=='0']<-'WON Base'
W912UMtrans$baseWonT[is.na(W912UMtrans$baseWonT) &
                       W912UMtrans$baseandexercisedoptionsvalue>=W912UMtrans$obligatedamount*20&
                       W912UMtrans$baseandexercisedoptionsvalue>10000&
                       W912UMtrans$baseandexercisedoptionsvalue>=W912UMtrans$Action_Obligation_Then_Year*20&
                       W912UMtrans$modnumber=='0']<-'? Base'
W912UMtrans$baseWonT[is.na(W912UMtrans$baseWonT) &
                       (W912UMtrans$baseandexercisedoptionsvalue<W912UMtrans$obligatedamount*20|
                          W912UMtrans$baseandexercisedoptionsvalue<W912UMtrans$Action_Obligation_Then_Year*20|
                          W912UMtrans$baseandexercisedoptionsvalue<=10000) &
                       W912UMtrans$modnumber=='0']<-'$ Base'
W912UMtrans$baseWonT[W912UMtrans$modnumber!='0']<-"Not Unmodified Transaction"




summary(factor(W912UMtrans$baseWonT))

if(any(is.na(W912UMtrans$baseWonT))) stop("Unclassified baseWonT")
# View(W912UMtrans[is.na(),])
# write.csv(file="..\\Data\\semi_clean\\NA_baseWonT.csv",W912UMtrans[is.na(W912UMtrans$baseWonT),],row.names = FALSE)

#Examining disagreements
# View(W912UMtrans %>% filter(baseWonT=='WON Base'& unmodWon!='WON Base') )
# View(W912UMtrans %>% filter(baseWonT!='WON Base'& unmodWon=='WON Base') )
#Examining ?s
# View(W912UMtrans %>% filter(baseWonT=='? Base'& obligatedamount>0) )
# View(W912UMtrans %>% filter(baseWonT=='? Base'& obligatedamount==0) )


statsummary_discrete(c("baseWonT"),W912UMtrans %>% filter(modnumber=='0'),
                     value_col="Action_Obligation_Then_Year")
grouped_barplot(c("baseWonT"),W912UMtrans %>% filter(modnumber=='0'),
                value_col="Action_Obligation_Then_Year")

UnmodDisagree<-W912UMtrans %>% filter(baseWonT=='WON Base'& unmodWon!='WON Base') 
# View(W912UM %>% filter(CSIScontractID %in% UnmodDisagree$CSIScontractID))
CSIScontractID_ceil_to_na<-W912UMtrans$CSIScontractID[W912UMtrans$baseWonT == 'WON Base'&
                                                        !is.na(W912UMtrans$baseWonT)]


#Spreading  the labeled values to modified entries, which helps in the next step.
W912UMtrans$baseWonT[W912UMtrans$baseWonT=="Not Unmodified Transaction" &
                       W912UMtrans$CSIScontractID %in% CSIScontractID_ceil_to_na]<-'WON Base'
# 
W912UMtrans$baseWonT[W912UMtrans$baseWonT=="Not Unmodified Transaction" &
                       W912UMtrans$CSIScontractID %in% W912UMtrans$CSIScontractID[W912UMtrans$baseWonT == '? Base'&
                                                                                    !is.na(W912UMtrans$baseWonT)]]<- '? Base'
W912UMtrans$baseWonT[W912UMtrans$baseWonT=="Not Unmodified Transaction" &
                       W912UMtrans$CSIScontractID %in% W912UMtrans$CSIScontractID[W912UMtrans$baseWonT == '$ Base'&
                                                                                    !is.na(W912UMtrans$baseWonT)]]<- '$ Base'

summary(factor(W912UMtrans$baseWonT))
```


Contracts bases are marked null if:
* Contracting office W912UM 
* Initial transaction has a base 400 times obligations.
* initial base 400 times total obligations.
* Initial or total obligations are positive.
Then it the base is set to NA and it will not be in the sample.

#### Modified Transactions
##### Change Order Transactions
```{r W912UM_transaction}

W912UMtrans$changeWonT<-NA
W912UMtrans$changeWonT[W912UMtrans$modnumber=='0']<-"Unmodified Transaction"
W912UMtrans$changeWonT[is.na(W912UMtrans$changeWonT)&
                         (W912UMtrans$baseandalloptionsvalue==0 | 
                            W912UMtrans$n_CBre==0)
                       &W912UMtrans$modnumber!='0']<-'0 Chg Growth'
W912UMtrans$changeWonT[is.na(W912UMtrans$changeWonT)&
                         abs(W912UMtrans$baseandalloptionsvalue)>=abs(W912UMtrans$obligatedamount*400)&
                         (abs(W912UMtrans$ChangeOrderCeilingGrowth+W912UMtrans$ChangeOrderCeilingRescision)+
                            W912UMtrans$UnmodifiedCeiling_Then_Year)>=
                         W912UMtrans$Action_Obligation_Then_Year*10&
                         abs(W912UMtrans$ChangeOrderCeilingGrowth+W912UMtrans$ChangeOrderCeilingRescision)>10000
                       # (W912UMtrans$baseandalloptionsvalue>=
                       #    W912UMtrans$UnmodifiedCeiling_Then_Year*100 |
                       #   (!is.na(W912UMtrans$unmodWonT) & W912UMtrans$unmodWonT %in% c('WON Unm','? Unm')))&
                       # # (W912UMtrans$obligatedamount>0 | W912UMtrans$Action_Obligation_Then_Year>0)& 
                       # abs(W912UMtrans$baseandalloptionsvalue)>0 & W912UMtrans$ChangeOrderCeilingGrowth+W912UMtrans$ChangeOrderCeilingRescision>0
                       ]<-'WON Chg'
W912UMtrans$changeWonT[is.na(W912UMtrans$changeWonT) &
                         abs(W912UMtrans$baseandalloptionsvalue)>=abs(W912UMtrans$obligatedamount*20)&
                         (abs(W912UMtrans$ChangeOrderCeilingGrowth+W912UMtrans$ChangeOrderCeilingRescision)+
                            W912UMtrans$UnmodifiedCeiling_Then_Year)>=
                         W912UMtrans$Action_Obligation_Then_Year*5&
                         abs(W912UMtrans$ChangeOrderCeilingGrowth+W912UMtrans$ChangeOrderCeilingRescision)
                       # (W912UMtrans$baseandalloptionsvalue>=
                       #    W912UMtrans$UnmodifiedCeiling_Then_Year*10 |
                       #  (!is.na(W912UMtrans$unmodWonT) & W912UMtrans$unmodWonT %in% c('WON Unm','? Unm')))&
                       # abs(W912UMtrans$baseandalloptionsvalue)>0 & W912UMtrans$ChangeOrderCeilingGrowth+W912UMtrans$ChangeOrderCeilingRescision>0
                       ]<-'? Chg'
W912UMtrans$changeWonT[is.na(W912UMtrans$changeWonT) &
                         (abs(W912UMtrans$baseandalloptionsvalue)<abs(W912UMtrans$obligatedamount*20)|
                            (abs(W912UMtrans$ChangeOrderCeilingGrowth+W912UMtrans$ChangeOrderCeilingRescision)+
                               W912UMtrans$UnmodifiedCeiling_Then_Year)<
                            W912UMtrans$Action_Obligation_Then_Year*5 |
                            abs(W912UMtrans$ChangeOrderCeilingGrowth+W912UMtrans$ChangeOrderCeilingRescision)<=10000)
                       # (W912UMtrans$baseandalloptionsvalue<
                       #    W912UMtrans$UnmodifiedCeiling_Then_Year*10 |
                       #  (!is.na(W912UMtrans$unmodWonT) & W912UMtrans$unmodWonT %in% c('WON Unm','? Unm')))&
                       # abs(W912UMtrans$baseandalloptionsvalue)>0 & W912UMtrans$ChangeOrderCeilingGrowth+W912UMtrans$ChangeOrderCeilingRescision>0
                       ]<-'$ Chg'

summary(factor(W912UMtrans$changeWonT))

if(any(is.na(W912UMtrans$changeWonT))) stop("Unclassified changeWonT")
# View(W912UMtrans[is.na(is.na(W912UMtrans$changeWonT)),])
write.csv(file="..\\Data\\semi_clean\\changeWonT.csv",W912UMtrans %>% filter(changeWonT=="WON Chg"),row.names = FALSE)

```
##### Exercised  Options Transactions
```{r W912UM_exercised_transaction}

W912UMtrans$optWonT<-NA
W912UMtrans$optWonT[W912UMtrans$modnumber=='0']<-"Unmodified Transaction"
W912UMtrans$optWonT[is.na(W912UMtrans$optWonT)&
                      (W912UMtrans$baseandexercisedoptionsvalue==0 | 
                         W912UMtrans$SteadyScopeOptionGrowthAlone==0)
                    &W912UMtrans$modnumber!='0']<-'0 Opt Growth'
W912UMtrans$optWonT[is.na(W912UMtrans$optWonT)&
                      abs(W912UMtrans$baseandexercisedoptionsvalue)>=abs(W912UMtrans$obligatedamount*400)&
                      (abs(W912UMtrans$SteadyScopeOptionGrowthAlone)+
                         W912UMtrans$UnmodifiedBase)>=
                      W912UMtrans$Action_Obligation_Then_Year*10&
                      abs(W912UMtrans$SteadyScopeOptionGrowthAlone)>10000
                    # (W912UMtrans$baseandexercisedoptionsvalue>=
                    #    W912UMtrans$UnmodifiedBase*100 |
                    #   (!is.na(W912UMtrans$baseWonT) & W912UMtrans$baseWonT %in% c('WON Base','? Base')))&
                    # # (W912UMtrans$obligatedamount>0 | W912UMtrans$Action_Obligation_Then_Year>0)& 
                    # abs(W912UMtrans$baseandexercisedoptionsvalue)>0 & W912UMtrans$SteadyScopeOptionGrowthAlone>0
                    ]<-'WON Opt'
W912UMtrans$optWonT[is.na(W912UMtrans$optWonT) &
                      abs(W912UMtrans$baseandexercisedoptionsvalue)>=abs(W912UMtrans$obligatedamount*20)&
                      (abs(W912UMtrans$SteadyScopeOptionGrowthAlone)+
                         W912UMtrans$UnmodifiedBase)>=
                      W912UMtrans$Action_Obligation_Then_Year*5&
                      abs(W912UMtrans$SteadyScopeOptionGrowthAlone)
                    # (W912UMtrans$baseandexercisedoptionsvalue>=
                    #    W912UMtrans$UnmodifiedBase*10 |
                    #  (!is.na(W912UMtrans$baseWonT) & W912UMtrans$baseWonT %in% c('WON Base','? Base')))&
                    # abs(W912UMtrans$baseandexercisedoptionsvalue)>0 & W912UMtrans$SteadyScopeOptionGrowthAlone>0
                    ]<-'? Opt'
W912UMtrans$optWonT[is.na(W912UMtrans$optWonT) &
                      (abs(W912UMtrans$baseandexercisedoptionsvalue)<abs(W912UMtrans$obligatedamount*20)|
                         (abs(W912UMtrans$SteadyScopeOptionGrowthAlone)+
                            W912UMtrans$UnmodifiedBase)<
                         W912UMtrans$Action_Obligation_Then_Year*5 |
                         abs(W912UMtrans$SteadyScopeOptionGrowthAlone)<=10000)
                    # (W912UMtrans$baseandexercisedoptionsvalue<
                    #    W912UMtrans$UnmodifiedBase*10 |
                    #  (!is.na(W912UMtrans$baseWonT) & W912UMtrans$baseWonT %in% c('WON Base','? Base')))&
                    # abs(W912UMtrans$baseandexercisedoptionsvalue)>0 & W912UMtrans$SteadyScopeOptionGrowthAlone>0
                    ]<-'$ Opt'

summary(factor(W912UMtrans$optWonT))

if(any(is.na(W912UMtrans$optWonT))) stop("Unclassified optWonT")
# View(W912UMtrans[is.na(W912UMtrans$optWonT),])
write.csv(file="..\\Data\\semi_clean\\optWonT.csv",W912UMtrans %>% filter(optWonT=="WON Opt"),row.names = FALSE)

```




#### Examining International Related Vars
```{r tran_related_vars}

levels(W912UMtrans$vendorcountrycode)<-list(
  # ""="",
  "ABW: ARUBA"="ABW: ARUBA",
  "JPN: JAPAN"="JPN: JAPAN",
  "KOR: KOREA, REPUBLIC OF"=c("KOR: KOREA, REPUBLIC OF","KOR","SOUTH KOREA"),
  "USA: UNITED STATES OF AMERICA"=c("USA: UNITED STATES OF AMERICA","UNITED STATES","USA")
)

summary(W912UMtrans$changeWonT)
#Ceiling and Change Orders
ggplot(W912UMtrans %>% filter(modnumber=='0') ,aes(x=unmodWonT))+geom_bar()+facet_wrap(~vendorcountrycode)
ggplot(W912UMtrans %>% filter(modnumber!='0'),aes(x=changeWonT))+geom_bar()+facet_wrap(~vendorcountrycode)
ggplot(W912UMtrans %>% filter(modnumber!='0'),aes(x=changeWonT))+geom_bar()+facet_wrap(~unmodWonT)
ggplot(W912UMtrans,aes(x=sumWon))+geom_bar()+facet_wrap(~vendorcountrycode)

#Base and Options
ggplot(W912UMtrans %>% filter(modnumber=='0') ,aes(x=baseWonT))+geom_bar()+facet_wrap(~vendorcountrycode)
ggplot(W912UMtrans %>% filter(modnumber!='0'),aes(x=optWonT))+geom_bar()+facet_wrap(~vendorcountrycode)
ggplot(W912UMtrans %>% filter(modnumber!='0'),aes(x=optWonT))+geom_bar()+facet_wrap(~baseWonT)
ggplot(W912UMtrans,aes(x=sumWon))+geom_bar()+facet_wrap(~vendorcountrycode)


#Ceiling and Change Order
ggplot(W912UMtrans %>% filter(modnumber=='0'),aes(x=unmodWon))+
  geom_bar()+facet_wrap(~placeofmanufacture)
ggplot(W912UMtrans %>% filter(modnumber=='0'),aes(x=unmodWon))+
  geom_bar()+facet_wrap(~countryoforigin)
ggplot(W912UMtrans %>% filter(modnumber=='0'),aes(x=unmodWon))+
  geom_bar()+facet_wrap(~placeofperformancecountrycode)

#Base and Options

W912UMtrans$placeofperformancecountrycode
ggplot(W912UMtrans %>% filter(modnumber=='0'),aes(x=baseWon))+
  geom_bar()+facet_wrap(~placeofmanufacture)
ggplot(W912UMtrans %>% filter(modnumber=='0'),aes(x=baseWon))+
  geom_bar()+facet_wrap(~countryoforigin)
ggplot(W912UMtrans %>% filter(modnumber=='0'),aes(x=baseWon))+
  geom_bar()+facet_wrap(~placeofperformancecountrycode)

summary(factor(W912UMtrans$optWonT))

# View(W912UMtrans %>% filter(unmodWon %in% c("? Unm","Won Unm") & vendorcountrycode=="USA: UNITED STATES OF AMERICA" & modnumber=='0'))

# Miscategorized<-W912UMtrans %>% filter(unmodWon %in% c("? Unm","WON Unm") & (
#   vendorcountrycode=="USA: UNITED STATES OF AMERICA" |
#     countryoforigin=="USA" |
#     placeofperformancecountrycode=="USA")
#   & modnumber=='0')

summary(factor(W912UMtrans$changeWonT))

Miscategorized<-W912UMtrans %>% filter((unmodWon %in% c("? Unm","WON Unm")|
                                          unmodWonT %in% c("? Unm","WON Unm")|
                                          changeWon %in% c("? Chg","WON Chg")|
                                          changeWonT %in% c("? Chg","WON Chg")|
                                          baseWon %in% c("? Base","WON Base")|
                                          baseWonT %in% c("? Base","WON Base")|
                                          optWon %in% c("? Opt","WON Opt")|
                                          optWonT %in% c("? Opt","WON Opt")
)& (
  
  placeofperformancecountrycode=="USA")
& modnumber=='0')


if(nrow(Miscategorized)>0) stop("False positive contract in Won performed in US")
# View(W912UM %>% filter(CSIScontractID %in% Miscategorized$CSIScontractID))


```

# Cleaning
## Validating CSIS_contract_inspection
### Unmodified Ceiling in Won
```{r validate_ceiling_inspection_lookup}
inspected<-read.csv(file.path("https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                              "contract/","CSIS_contract_inspection.csv"))

#Identify incorrectly FALSE in inspection
inspect_should_be_true<-inspected$CSIScontractID[
  inspected$CSIScontractID %in% c(W912UM$CSIScontractID[W912UM$unmodWon=="WON Unm"],
                                  W912UMtrans$CSIScontractID[W912UMtrans$unmodWonT=="WON Unm"])&
    inspected$override_unmodified_ceiling==FALSE
  ]

if(length(inspect_should_be_true)>0){
  inspected[inspected$CSIScontractID %in% inspect_should_be_true,]
  inspected$override_unmodified_ceiling[inspected$CSIScontractID %in% inspect_should_be_true]<-TRUE
  write.csv(inspected,file="../Output/CSIS_contract_inspection.csv",row.names=FALSE)
  stop(paste("CSIS_contract_inspection.csv has incorrect false values for",length(inspect_should_be_true),
             "CSIScontractIDs in override_unmodified_ceiling.",
             "See Output/CSIS_contract_inspection.csv for updated file."))
}
rm(inspect_should_be_true)

#Identify incorrectly true in inspection
inspect_should_be_false<-inspected$CSIScontractID[
  !inspected$CSIScontractID %in% c(W912UM$CSIScontractID[W912UM$unmodWon=="WON Unm"],
                                   W912UMtrans$CSIScontractID[W912UMtrans$unmodWonT=="WON Unm"])&
    inspected$override_unmodified_ceiling==TRUE &
    inspected$CSIS_inspection=="W912UM Won"
  ]

if(length(inspect_should_be_false)>0){
  inspected[inspected$CSIScontractID %in% inspect_should_be_false,]
  inspected$override_unmodified_ceiling[inspected$CSIScontractID %in% inspect_should_be_false]<-FALSE
  write.csv(inspected,file="../Output/CSIS_contract_inspection.csv",row.names=FALSE)
  stop(paste("CSIS_contract_inspection.csv has incorrect true values for",length(inspect_should_be_false),
             "CSIScontractIDs in override_unmodified_ceiling.",
             "See Output/CSIS_contract_inspection.csv for updated file."))
}
rm(inspect_should_be_false)

#Identify missing from csis_inspect
inspect_missing<-unique(c(W912UM$CSIScontractID[W912UM$unmodWon=="WON Unm"],
                          W912UMtrans$CSIScontractID[W912UMtrans$unmodWonT=="WON Unm"]))
inspect_missing<-inspect_missing[!inspect_missing %in% inspected$CSIScontractID]

if(length(inspect_missing)>0){
  new_rows<-data.frame(CSIScontractID=inspect_missing,
                       override_unmodified_ceiling=TRUE,
                       override_unmodified_base=FALSE,
                       override_change_order_growth=FALSE,
                       override_exercised_growth=FALSE,
                       CSIS_inspection="W912UM Won")
  
  
  new_rows$override_unmodified_base[
    new_rows$CSIScontractID %in% c(W912UM$CSIScontractID[W912UM$baseWon=="WON Base"],
                                   W912UMtrans$CSIScontractID[W912UMtrans$baseWonT=="WON Base"])]<-TRUE
  
  new_rows$override_change_order_growth[
    new_rows$CSIScontractID %in% c(W912UM$CSIScontractID[W912UM$changeWon=="WON Chg"],
                                   W912UMtrans$CSIScontractID[W912UMtrans$changeWonT=="WON Chg"]
    )]<-TRUE
  
  new_rows$override_exercised_growth[
    new_rows$CSIScontractID %in% c(W912UM$CSIScontractID[W912UM$optWon=="WON Opt"],
                                   W912UMtrans$CSIScontractID[W912UMtrans$optWonT=="WON Opt"])]<-TRUE
  
  
  
  write.csv(rbind(inspected,new_rows),file="../Output/CSIS_contract_inspection.csv",row.names=FALSE)
  rm(new_rows)
  stop(paste("CSIS_contract_inspection.csv is missing rows for ",length(inspect_missing),
             "CSIScontractIDs.",
             "See Output/CSIS_contract_inspection.csv for updated file."))
}
rm(inspect_missing)
```

### Unmodified Base in Won
```{r validate_base_inspection_lookup}
inspected<-read.csv(file.path("https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                              "contract/","CSIS_contract_inspection.csv"))

#Identify incorrectly FALSE in inspection
inspect_should_be_true<-inspected$CSIScontractID[
  inspected$CSIScontractID %in% c(W912UM$CSIScontractID[W912UM$baseWon=="WON Base"],
                                  W912UMtrans$CSIScontractID[W912UMtrans$baseWonT=="WON Base"])&
    inspected$override_unmodified_base==FALSE
  ]

summary(W912UMtrans$baseWon)

if(length(inspect_should_be_true)>0){
  inspected[inspected$CSIScontractID %in% inspect_should_be_true,]
  inspected$override_unmodified_base[inspected$CSIScontractID %in% inspect_should_be_true]<-TRUE
  write.csv(inspected,file="../Output/CSIS_contract_inspection.csv",row.names=FALSE)
  stop(paste("CSIS_contract_inspection.csv has incorrect false values for",length(inspect_should_be_true),
             "CSIScontractIDs in override_unmodified_base.",
             "See Output/CSIS_contract_inspection.csv for updated file."))
}
rm(inspect_should_be_true)

#Identify incorrectly true in inspection
inspect_should_be_false<-inspected$CSIScontractID[
  !inspected$CSIScontractID %in% c(W912UM$CSIScontractID[W912UM$baseWon=="WON Base"],
                                   W912UMtrans$CSIScontractID[W912UMtrans$baseWonT=="WON Base"])&
    inspected$override_unmodified_base==TRUE &
    inspected$CSIS_inspection=="W912UM Won"
  ]

if(length(inspect_should_be_false)>0){
  inspected[inspected$CSIScontractID %in% inspect_should_be_false,]
  inspected$override_unmodified_base[inspected$CSIScontractID %in% inspect_should_be_false]<-FALSE
  write.csv(inspected,file="../Output/CSIS_contract_inspection.csv",row.names=FALSE)
  stop(paste("CSIS_contract_inspection.csv has incorrect true values for",length(inspect_should_be_false),
             "CSIScontractIDs in override_unmodified_base.",
             "See Output/CSIS_contract_inspection.csv for updated file."))
}
rm(inspect_should_be_false)

#Identify missing from csis_inspect
inspect_missing<-unique(c(W912UM$CSIScontractID[W912UM$baseWon=="WON Base"],
                          W912UMtrans$CSIScontractID[W912UMtrans$baseWonT=="WON Base"]))
inspect_missing<-inspect_missing[!inspect_missing %in% inspected$CSIScontractID]

if(length(inspect_missing)>0){
  new_rows<-data.frame(CSIScontractID=inspect_missing,
                       override_unmodified_ceiling=FALSE,
                       override_unmodified_base=TRUE,
                       override_change_order_growth=FALSE,
                       override_exercised_growth=FALSE,
                       CSIS_inspection="W912UM Won")
  
  
new_rows$override_unmodified_ceiling[
    new_rows$CSIScontractID %in% c(W912UM$CSIScontractID[W912UM$unmodWon=="WON Unm"],
                                   W912UMtrans$CSIScontractID[W912UMtrans$unmodWonT=="WON Unm"]
    )]<-TRUE
    
  new_rows$override_change_order_growth[
    new_rows$CSIScontractID %in% c(W912UM$CSIScontractID[W912UM$changeWon=="WON Chg"],
                                   W912UMtrans$CSIScontractID[W912UMtrans$changeWonT=="WON Chg"]
    )]<-TRUE
  new_rows$override_exercised_growth[
    new_rows$CSIScontractID %in% c(W912UM$CSIScontractID[W912UM$optWon=="WON Opt"],
                                   W912UMtrans$CSIScontractID[W912UMtrans$optWonT=="WON Opt"])]<-TRUE
  
  write.csv(rbind(inspected,new_rows),file="../Output/CSIS_contract_inspection.csv",row.names=FALSE)
  rm(new_rows)
  stop(paste("CSIS_contract_inspection.csv is missing rows for ",length(inspect_missing),
             "CSIScontractIDs.",
             "See Output/CSIS_contract_inspection.csv for updated file."))
}
rm(inspect_missing)
```


### Change Order in Won

```{r validate_change_inspection_lookup}
inspected<-read.csv(file.path("https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                              "contract/","CSIS_contract_inspection.csv"))

#Identify incorrectly FALSE in inspection
inspect_should_be_true<-inspected$CSIScontractID[
  inspected$CSIScontractID %in% c(W912UM$CSIScontractID[W912UM$changeWon=="WON Chg"],
                                  W912UMtrans$CSIScontractID[W912UMtrans$changeWonT=="WON Chg"])&
    inspected$override_change_order_growth==FALSE
  ]

if(length(inspect_should_be_true)>0){
  inspected[inspected$CSIScontractID %in% inspect_should_be_true,]
  inspected$override_change_order_growth[inspected$CSIScontractID %in% inspect_should_be_true]<-TRUE
  write.csv(inspected,file="../Output/CSIS_contract_inspection.csv",row.names=FALSE)
  stop(paste("CSIS_contract_inspection.csv has incorrect false values for",length(inspect_should_be_true),
             "CSIScontractIDs in override_change_order_growth.",
             "See Output/CSIS_contract_inspection.csv for updated file."))
}
rm(inspect_should_be_true)

#Identify incorrectly true in inspection
inspect_should_be_false<-inspected$CSIScontractID[
  !inspected$CSIScontractID %in% c(W912UM$CSIScontractID[W912UM$changeWon=="WON Chg"],
                                   W912UMtrans$CSIScontractID[W912UMtrans$changeWonT=="WON Chg"])&
    inspected$override_change_order_growth==TRUE &
    inspected$CSIS_inspection=="W912UM Won"
  ]

if(length(inspect_should_be_false)>0){
  inspected[inspected$CSIScontractID %in% inspect_should_be_false,]
  inspected$override_change_order_growth[inspected$CSIScontractID %in% inspect_should_be_false]<-FALSE
  write.csv(inspected,file="../Output/CSIS_contract_inspection.csv",row.names=FALSE)
  stop(paste("CSIS_contract_inspection.csv has incorrect true values for",length(inspect_should_be_false),
             "CSIScontractIDs in override_change_order_growth.",
             "See Output/CSIS_contract_inspection.csv for updated file."))
}
rm(inspect_should_be_false)

#Identify missing from csis_inspect
inspect_missing<-unique(c(W912UM$CSIScontractID[W912UM$changeWon=="WON Chg"],
                          W912UMtrans$CSIScontractID[W912UMtrans$changeWonT=="WON Chg"]))
inspect_missing<-inspect_missing[!inspect_missing %in% inspected$CSIScontractID]

if(length(inspect_missing)>0){
  new_rows<-data.frame(CSIScontractID=inspect_missing,
                       override_unmodified_ceiling=FALSE,
                       override_unmodified_base=FALSE,
                       override_change_order_growth=TRUE,
                       override_exercised_growth=FALSE,
                       CSIS_inspection="W912UM Won")
  
  new_rows$override_unmodified_ceiling[
    new_rows$CSIScontractID %in% c(W912UM$CSIScontractID[W912UM$unmodWon=="WON Unm"],
                                   W912UMtrans$CSIScontractID[W912UMtrans$unmodWonT=="WON Unm"]
    )]<-TRUE
  
  new_rows$override_unmodified_base[
    new_rows$CSIScontractID %in% c(W912UM$CSIScontractID[W912UM$baseWon=="WON Base"],
                                   W912UMtrans$CSIScontractID[W912UMtrans$baseWonT=="WON Base"])]<-TRUE
  
  new_rows$override_exercised_growth[
    new_rows$CSIScontractID %in% c(W912UM$CSIScontractID[W912UM$optWon=="WON Opt"],
                                   W912UMtrans$CSIScontractID[W912UMtrans$optWonT=="WON Opt"])]<-TRUE
  
  write.csv(rbind(inspected,new_rows),file="../Output/CSIS_contract_inspection.csv",row.names=FALSE)
  rm(new_rows)
  stop(paste("CSIS_contract_inspection.csv is missing rows for ",length(inspect_missing),
             "CSIScontractIDs.",
             "See Output/CSIS_contract_inspection.csv for updated file."))
}
rm(inspect_missing)


```



### Options in Won

```{r validate_option_inspection_lookup}
inspected<-read.csv(file.path("https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                              "contract/","CSIS_contract_inspection.csv"))


summary(factor(W912UM$optWon))

#Identify incorrectly FALSE in inspection
inspect_should_be_true<-inspected$CSIScontractID[
  inspected$CSIScontractID %in% c(W912UM$CSIScontractID[W912UM$optWon=="WON Opt"],
                                  W912UMtrans$CSIScontractID[W912UMtrans$optWonT=="WON Opt"])&
    inspected$override_exercised_growth==FALSE
  ]

if(length(inspect_should_be_true)>0){
  inspected[inspected$CSIScontractID %in% inspect_should_be_true,]
  inspected$override_exercised_growth[inspected$CSIScontractID %in% inspect_should_be_true]<-TRUE
  write.csv(inspected,file="../Output/CSIS_contract_inspection.csv",row.names=FALSE)
  stop(paste("CSIS_contract_inspection.csv has incorrect false values for",length(inspect_should_be_true),
             "CSIScontractIDs in override_exercised_growth.",
             "See Output/CSIS_contract_inspection.csv for updated file."))
}
rm(inspect_should_be_true)

#Identify incorrectly true in inspection
inspect_should_be_false<-inspected$CSIScontractID[
  !inspected$CSIScontractID %in% c(W912UM$CSIScontractID[W912UM$optWon=="WON Opt"],
                                   W912UMtrans$CSIScontractID[W912UMtrans$optWonT=="WON Opt"])&
    inspected$override_exercised_growth==TRUE &
    inspected$CSIS_inspection=="W912UM Won"
  ]

if(length(inspect_should_be_false)>0){
  inspected[inspected$CSIScontractID %in% inspect_should_be_false,]
  inspected$override_exercised_growth[inspected$CSIScontractID %in% inspect_should_be_false]<-FALSE
  write.csv(inspected,file="../Output/CSIS_contract_inspection.csv",row.names=FALSE)
  stop(paste("CSIS_contract_inspection.csv has incorrect true values for",length(inspect_should_be_false),
             "CSIScontractIDs in override_exercised_growth.",
             "See Output/CSIS_contract_inspection.csv for updated file."))
}
rm(inspect_should_be_false)

#Identify missing from csis_inspect
inspect_missing<-unique(c(W912UM$CSIScontractID[W912UM$optWon=="WON Opt"],
                          W912UMtrans$CSIScontractID[W912UMtrans$optWonT=="WON Opt"]))
inspect_missing<-inspect_missing[!inspect_missing %in% inspected$CSIScontractID]

if(length(inspect_missing)>0){
  new_rows<-data.frame(CSIScontractID=inspect_missing,
                       override_unmodified_ceiling=FALSE,
                       override_unmodified_base=FALSE,
                       override_change_order_growth=FALSE,
                       override_exercised_growth=TRUE,
                       CSIS_inspection="W912UM Won")
  

  new_rows$override_unmodified_ceiling[
    new_rows$CSIScontractID %in% c(W912UM$CSIScontractID[W912UM$unmodWon=="WON Unm"],
                                   W912UMtrans$CSIScontractID[W912UMtrans$unmodWonT=="WON Unm"]
    )]<-TRUE
    
  new_rows$override_unmodified_base[
    new_rows$CSIScontractID %in% c(W912UM$CSIScontractID[W912UM$baseWon=="WON Base"],
                                   W912UMtrans$CSIScontractID[W912UMtrans$baseWonT=="WON Base"])]<-TRUE  

    new_rows$override_change_order_growth[
    new_rows$CSIScontractID %in% c(W912UM$CSIScontractID[W912UM$changeWon=="WON Chg"],
                                   W912UMtrans$CSIScontractID[W912UMtrans$changeWonT=="WON Chg"]
    )]<-TRUE
  
  write.csv(rbind(inspected,new_rows),file="../Output/CSIS_contract_inspection.csv",row.names=FALSE)
  rm(new_rows)
  stop(paste("CSIS_contract_inspection.csv is missing rows for ",length(inspect_missing),
             "CSIScontractIDs.",
             "See Output/CSIS_contract_inspection.csv for updated file."))
}
rm(inspect_missing)


```


## Validate Transformed_Dataset
This is a quick inspection to make sure that the version of the transformed dataset to be used is current, focusing on ceiling and change orders.

```{r validate_transformed_dataset}

load(file="../Data/Clean/transformed_def.Rdata")
colnames(def)[colnames(def)=="ChangeOrderCeilingGrowth"]<-"n_CBre"
#Overrides
def<-read_and_join_experiment( def,
                               "CSIS_contract_inspection.csv",
                               path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                               directory="contract/",
                               by=c("CSIScontractID"),
                               # add_var=c("EntityID","UnmodifiedEntityID"),
                               new_var_checked=FALSE,
                               create_lookup_rdata=FALSE
)

#Making sure the transformed dataset has been set to NA 
if(any(!is.na(def$UnmodifiedCeiling_Then_Year[
  def$override_unmodified_ceiling==TRUE]))){
  stop("Unmodified Ceilings set to be overiden have not been set to NA. Rerun transform portion of creat_defense_contract_dataset.r")
}

if(any(!is.na(def$ChangeOrderCeilingGrowth[
  def$override_change_order_growth==TRUE]))){
  stop("Ceilings Breaches set to be overiden have not been set to NA. Rerun transform portion of creat_defense_contract_dataset.r")
}


```

# Examining Outliers

```{r CeilingOutlier_post}

#The original variables for b_Term and b_CBre are Term and CBre
grouped_barplot("CBre", def,value_col="Action_Obligation_Then_Year")
statsummary_discrete(c("CBre"), def,value_col="Action_Obligation_Then_Year")
cbre<-def %>% filter(b_CBre==1)
cbre$qGrowth<-Hmisc::cut2(cbre$p_CBre-1,c(1,10))
summary(cbre$qGrowth)

cbre$Why_Outlier<-NA
cbre$Why_Outlier[is.na(cbre$UnmodifiedCeiling_Then_Year)]<-"No Unmodified Ceiling"
cbre$Why_Outlier[is.na(cbre$Why_Outlier)&
                   cbre$Action_Obligation_Then_Year*2>=cbre$UnmodifiedCeiling_Then_Year+
                   cbre$ChangeOrderCeilingGrowth]<-
  "Obligations at least half Orig+CRai"
cbre$Why_Outlier[is.na(cbre$Why_Outlier)&
                   cbre$Office=="W912UM"]<-
  "Korean Office W912UM"
cbre$Why_Outlier[is.na(cbre$Why_Outlier)&
                   cbre$ChangeOrderCeilingGrowth>=2.5e8]<-
  ">=$250M, Insepect"
cbre$Why_Outlier[is.na(cbre$Why_Outlier)&
                   cbre$p_CBre-1>10]<-
  "Other Unexplained 10x Ceiling Breach"
cbre$Why_Outlier<-factor(cbre$Why_Outlier,
                         levels=c(
                           "No Unmodified Ceiling",
                           "Obligations at least half Orig+CRai",
                           "Later Deobligated",
                           "Korean Office W912UM",
                           ">=$250M, Insepect",
                           "Other Unexplained 10x Ceiling Breach"
                         ))

#Percent Growth
summary(Hmisc::cut2(cbre_preclean$p_CBre-1,c(1,
                                             10,
                                             100
)))
summary(Hmisc::cut2(cbre$p_CBre-1,c(1,
                                    10,
                                    100
)))

summary(cbre$qHighCeiling[(cbre$p_CBre-1)>10])
summary(cbre$qHighCeiling[(cbre$p_CBre-1)>100])


p_outlier_summary<-cbre %>% filter(p_CBre-1>10) %>% group_by(Why_Outlier) %>%
  dplyr::summarise(nContract=length(ChangeOrderCeilingGrowth),
                   SumOfChangeOrderCeilingGrowth=sum(ChangeOrderCeilingGrowth),
                   MaxOfChangeOrderCeilingGrowth=max(ChangeOrderCeilingGrowth),
                   SumOfAction_Obligation_Then_Year=sum(Action_Obligation_Then_Year))

#Absolute Growth
summary(Hmisc::cut2(cbre_preclean$ChangeOrderCeilingGrowth,c(1e3,
                                           1e6,
                                           1e7,
                                           1e8,
                                           2.5e8,
                                           1e9,
                                           1e10,
                                           2e10
))
)
summary(Hmisc::cut2(cbre$ChangeOrderCeilingGrowth,c(1e3,
                                  1e6,
                                  1e7,
                                  1e8,
                                  2.5e8,
                                  1e9,
                                  1e10,
                                  2e10
))
)

summary(cbre$qHighCeiling[cbre$ChangeOrderCeilingGrowth>=1e6])
summary(cbre$qHighCeiling[cbre$ChangeOrderCeilingGrowth>=1e9])



n_outlier_summary<-cbre %>% filter(ChangeOrderCeilingGrowth>2.5e8) %>% group_by(Why_Outlier) %>%
  dplyr::summarise(nContract=length(ChangeOrderCeilingGrowth),
                   SumOfChangeOrderCeilingGrowth=sum(ChangeOrderCeilingGrowth),
                   MaxOfChangeOrderCeilingGrowth=max(ChangeOrderCeilingGrowth),
                   SumOfAction_Obligation_Then_Year=sum(Action_Obligation_Then_Year))

```

The cleaning has cut in half the outliers with growth >=100,000,000, although the influence has been much smaller on the percentage growth outliers, reinforcing the choice to switch to absolute growth. The study team chose to set a threshold of Shifting the focus to all contracts with growth of at least 250 million, there are far fewer contracts that account for far more money.
`r knitr::kable(n_outlier_summary)`

After the cleaning, 2 categories remain relevant.

`r knitr::kable(p_outlier_summary)`
* Obligations at least half Orig+CRai: For this category, total obligations of the contract were at least half the value of the initial ceiling plus ceiling growth under change orders. As before, this category accounts for the overwhelming majority of outlier spending but only a tiny fraction of change order growth.
* There are `r nrow(cbre %>% dplyr::filter(Why_Outlier ==">=$250M, Insepect" ))` contracts with ceiling growth of over $250 million that account for hundreds of billions in change order growth. These merit manual inspection.

## Graphs after Cleaning

```{r CeilingGrowthAfterCleaning}

(
  ggplot(cbre, aes(x=UnmodifiedCeiling_Then_Year,y=p_CBre-1)) +#,color=qGrowth
    geom_point(alpha=0.25,shape=".")+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()+
    #+
    geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
    # facet_wrap(~qHighCeiling,scales="free_y")+#+, space="free_y"
    labs(title="Distribution of Ceiling Breaches",
         y="Percent of Growth in  Ceiling",
         x="Unmodified Contract Ceiling")#,
  # fill="Termination Completion"
)


(
  ggplot(cbre, aes(x=UnmodifiedCeiling_Then_Year,y=ChangeOrderCeilingGrowth)) +#,color=qGrowth
    geom_point(alpha=0.25,shape=".")+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()+
    #+
    geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
    # facet_wrap(~qHighCeiling,scales="free_y")+#+, space="free_y"
    labs(title="Distribution of Ceiling Breaches",
         y="Absolute Growth in  Ceiling",
         x="Unmodified Contract Ceiling")#,
  # fill="Termination Completion"
)

(
  ggplot(cbre, aes(x=UnmodifiedCeiling_Then_Year+ChangeOrderCeilingGrowth+ChangeOrderCeilingRescision,
                   y=Action_Obligation_Then_Year)) +#,color=qGrowth
    geom_point(alpha=0.25,shape=".")+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()#+
  #+
  #   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
  # # facet_wrap(~qHighCeiling,scales="free_y")+#+, space="free_y"
  #   labs(title="Distribution of Ceiling Breaches",
  #        y="Percent of Growth in  Ceiling",
  #        x="Unmodified Contract Ceiling")#,
  #        # fill="Termination Completion"
)

summary(cbre$ChangeOrderCeilingGrowth)
summary(cbre$ChangeOrderCeilingRescision)




(
  ggplot(cbre, aes(x=ChangeOrderCeilingGrowth,y=ChangeOrderCeilingGrowth+ChangeOrderCeilingRescision)) +#,color=qGrowth
    geom_point(alpha=0.25,shape=".")+
    # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+scale_y_log10()#+
  #+
  #   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
  # # facet_wrap(~qHighCeiling,scales="free_y")+#+, space="free_y"
  #   labs(title="Distribution of Ceiling Breaches",
  #        y="Percent of Growth in  Ceiling",
  #        x="Unmodified Contract Ceiling")#,
  #        # fill="Termination Completion"
)

(
  ggplot(cbre, aes(x=p_CBre-1,fill=qGrowth)) +
    geom_histogram(bins=100)+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+
    #+
    geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
    facet_wrap(~qHighCeiling,scales="free_y")+#+, space="free_y"
    labs(title="Distribution of Ceiling Breaches",
         y="Contract Count",
         x="Percent of Growth in  Ceiling")#,
  # fill="Termination Completion"
)






(
  ggplot(cbre, aes(x=ChangeOrderCeilingGrowth,fill=qGrowth)) +
    geom_histogram(bins=100)+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+
    #+
    geom_vline(xintercept = 1)#+geom_vline(xintercept = 0.1)+
  #facet_grid(NoPreTermObl~.,scales="free_y", space="free_y")+
  # labs(title="Distribution of Contracts with Obligations After Last termination",
  #      y="Contract Count",
  #      x="Percent of Obligations After Day of Termination",
  #      fill="Termination Completion"
)

(
  ggplot(cbre, aes(x=ChangeOrderCeilingGrowth,fill=qGrowth)) +
    geom_histogram(bins=100)+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10()+
    #+
    geom_vline(xintercept = 1)+
    facet_wrap(~qHighCeiling,scales="free_y")#+, space="free_y"
  #+geom_vline(xintercept = 0.1)+
  #facet_grid(NoPreTermObl~.,scales="free_y", space="free_y")+
  # labs(title="Distribution of Contracts with Obligations After Last termination",
  #      y="Contract Count",
  #      x="Percent of Obligations After Day of Termination",
  #      fill="Termination Completion"
)


```


