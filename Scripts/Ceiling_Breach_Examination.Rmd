---
title: "Ceiling_Breach_Examination"
author: "Greg Sanders"
date: "June 24, 2019"
output: html_document
---


#Setup
```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(arm)
library(R2WinBUGS)
library(knitr)
library(foreign)
library(stargazer)
library(texreg)
library(reshape2)
source("DIIGstat.r")

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40


```

```{r vargraphs: b_CBre}
load(file="../Data/Clean/transformed_def.Rdata")
#The original variables for b_Term and b_CBre are Term and CBre
undebug(grouped_barplot)
grouped_barplot("CBre", def,value_col="Action_Obligation_Then_Year")
statsummary_discrete(c("CBre"), def)
cbre<-def %>% filter(b_CBre==1)
cbre$qGrowth<-Hmisc::cut2(cbre$n_CBre-1,c(1,10))
summary(cbre$qGrowth)

```
# Outlier Study
```{r CeilingOutlier}
nrow(cbre %>% filter((n_CBre-1)>1))
nrow(cbre %>% filter((n_CBre-1)>10))
nrow(cbre %>% filter((n_CBre-1)>100))
nrow(cbre %>% filter((n_CBre-1)>100 & UnmodifiedContractBaseAndAllOptionsValue_Then_Year<=0))
summary(cbre$Ceil[(cbre$n_CBre-1)>10 & cbre$UnmodifiedContractBaseAndAllOptionsValue_Then_Year>0])
summary(cbre$Ceil[(cbre$n_CBre-1)>100 & cbre$UnmodifiedContractBaseAndAllOptionsValue_Then_Year>0])
cbre$Why_Outlier<-NA
cbre$Why_Outlier[cbre$UnmodifiedContractBaseAndAllOptionsValue_Then_Year<=0]<-"No Unmodified Ceiling"
cbre$Why_Outlier[is.na(cbre$Why_Outlier)&
                   cbre$Action_Obligation_Then_Year*2>=cbre$UnmodifiedContractBaseAndAllOptionsValue_Then_Year+
                   cbre$ChangeOrderCeilingGrowth]<-
  "Obligations at least half Orig+CRai"
cbre$Why_Outlier[is.na(cbre$Why_Outlier)&
                   cbre$Office=="W912UM"]<-
  "Korean Office W912UM"
cbre$Why_Outlier[is.na(cbre$Why_Outlier)&
                   cbre$ChangeOrderCeilingGrowth>=2.5e8]<-
  ">=$250M, Insepect"
cbre$Why_Outlier[is.na(cbre$Why_Outlier)&
                   cbre$n_CBre-1>10]<-
  "Other Unexplained 10x Ceiling Breach"
cbre$Why_Outlier<-factor(cbre$Why_Outlier,
                         levels=c(
                           "No Unmodified Ceiling",
                           "Obligations at least half Orig+CRai",
                           "Later Deobligated",
                           "Korean Office W912UM",
                           ">=$250M, Insepect",
                           "Other Unexplained 10x Ceiling Breach"
                         ))
summary(cbre$Why_Outlier[(cbre$n_CBre-1)>10])
summary(cbre$Why_Outlier)


p_outlier_summary<-cbre %>% filter(n_CBre-1>10) %>% group_by(Why_Outlier) %>%
  dplyr::summarise(nContract=length(ChangeOrderCeilingGrowth),
    SumOfChangeOrderCeilingGrowth=sum(ChangeOrderCeilingGrowth),
                   MaxOfChangeOrderCeilingGrowth=max(ChangeOrderCeilingGrowth),
                   SumOfAction_Obligation_Then_Year=sum(Action_Obligation_Then_Year))


n_outlier_summary<-cbre %>% filter(ChangeOrderCeilingGrowth>2.5e8) %>% group_by(Why_Outlier) %>%
  dplyr::summarise(nContract=length(ChangeOrderCeilingGrowth),
    SumOfChangeOrderCeilingGrowth=sum(ChangeOrderCeilingGrowth),
                   MaxOfChangeOrderCeilingGrowth=max(ChangeOrderCeilingGrowth),
                   SumOfAction_Obligation_Then_Year=sum(Action_Obligation_Then_Year))


nrow(cbre %>% filter((ChangeOrderCeilingGrowth)>=1e3))
nrow(cbre %>% filter((ChangeOrderCeilingGrowth)>=1e6))
nrow(cbre %>% filter((ChangeOrderCeilingGrowth)>=1e7))
nrow(cbre %>% filter((ChangeOrderCeilingGrowth)>=1e8))
nrow(cbre %>% filter((ChangeOrderCeilingGrowth)>=2.5e8))
nrow(cbre %>% filter((ChangeOrderCeilingGrowth)>=1e9))
nrow(cbre %>% filter((ChangeOrderCeilingGrowth)>=1e10))
nrow(cbre %>% filter((ChangeOrderCeilingGrowth)>=2e10))
summary(cbre$Ceil[cbre$ChangeOrderCeilingGrowth>=1e6])
summary(cbre$Ceil[cbre$ChangeOrderCeilingGrowth>=1e9])


write.csv(file="..\\Data\\semi_clean\\p_CBre_outliers.csv",cbre %>% filter((n_CBre-1)>10),row.names = FALSE)
write.csv(file="..\\Data\\semi_clean\\n_CBre_outliers.csv",cbre %>% filter(ChangeOrderCeilingGrowth>=2.5e8),row.names = FALSE)
```
Examining cases of large ceiling growth, `r nrow(cbre %>% filter(n_CBre-1>10))` contracts experienced greater than 10 fold growth. An increase of that side strains credulity, even in high risk defense contracting. While by no means impossible, the more likely explaination is a misrecorded initial ceiling.

The study team broke down the outliers into 6 categories:
`r p_outlier_summary`
* No Unmodified Ceiling: Contracts with an initial ceiling <=0. These are eliminated from the sample as missing data.
* Obligations at least half Orig+CRai: For this category, total obligations of the contract were at least half the value of the initial ceiling plus ceiling growth under change orders. These contrats have had spending that massively exceeded their original ceiling, so the growth in absolute terrms seems plausible. This category accounts for the overwhelming majority of outlier spending but only a tiny fraction of change order growth.
* Later Deobligated: The change order growth metrics only counts increases. These may simply have been mistaken increases, as when including deobligation the growth no longer exceeded 10x the original ceiling. The number, obligations, and change order growth of these contracts are comparatively small, and thus should not distort the overall data.
* Korean Office W912UM refers to a contracting office that sometimes records base and all options values in Korean Won, approximate exchange rate 1,000 Won : 1 USD. 
* There are `r nrow(cbre %>% filter(Why_Outlier ==">=$250M, Insepect" & (cbre$n_CBre-1)>10))` contracts with ceiling growth of over $250 million that account for hundreds of billions in change order growth. These merit manual inspection.
* Finally a few score contrats have unexplained growth, but remain below the $10M threshold. The quantity and magnitude of these contrats is not sufficient to risk the overall model.

This examination left the study team less confident in percentage growth as a metric, especially in extreme cases, while increasing the study team's confidence in measures of growth in absoute term. In the worst case, simply removing all of the unexplained over  10 million contracts from the sample would reduce the number of contracts by a tiny amount and reduce the spending accounted for by  `r sum(cbre$Action_Obligation_Then_Year[cbre$Why_Outlier ==">=$250M, Insepect"& (cbre$n_CBre-1)>10] ,na.rm=TRUE)`.

Shifting the focus to all contracts with growth of at least 250 million, there are far fewer contracts that account for far more money.
`r n_outlier_summary`

Inspecting W912UM, either to remove or fix its oversized growth, is an imperative as it accounts for the majority of these contracts or task orders. Even so, there are still `r nrow(cbre %>% filter(Why_Outlier ==">=$250M, Insepect"))` That merit special inspection for given that there growth far outpaces their spending.

##W912UM
```{r W912UM}
W912UM <- def %>% filter(Office=="W912UM")

(
ggplot(W912UM, aes(x=UnmodifiedContractBaseAndAllOptionsValue_Then_Year+ChangeOrderBaseAndAllOptionsValue,y=Action_Obligation_Then_Year)) +#,color=qGrowth
  geom_point(alpha=0.25,shape=".")+
  # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_x_log10()+scale_y_log10()+
  #+
#   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
facet_wrap(~StartFY,scales="free_y")#+, space="free_y"
#   labs(title="Distribution of Ceiling Breaches",
#        y="Percent of Growth in  Ceiling",
#        x="Unmodified Contract Ceiling")#,
#        # fill="Termination Completion"
)

summary(W912UM$UnmodifiedContractBaseAndAllOptionsValue_Then_Year)
W912UM$unmodWon<-NA
W912UM$unmodWon[W912UM$UnmodifiedContractBaseAndAllOptionsValue_Then_Year>=W912UM$Action_Obligation_Then_Year*500]<-'WON Unm'
W912UM$unmodWon[is.na(W912UM$unmodWon) &
                    W912UM$UnmodifiedContractBaseAndAllOptionsValue_Then_Year>=W912UM$Action_Obligation_Then_Year*10]<-'? Unm'
W912UM$unmodWon[is.na(W912UM$unmodWon) &
                    W912UM$UnmodifiedContractBaseAndAllOptionsValue_Then_Year<W912UM$Action_Obligation_Then_Year*10]<-'$ Unm'
summary(factor(W912UM$unmodWon))


W912UM$changeWon<-NA
W912UM$changeWon[abs(W912UM$ChangeOrderBaseAndAllOptionsValue)==0]<-'0 Chg'
W912UM$changeWon[abs(W912UM$ChangeOrderBaseAndAllOptionsValue)>=W912UM$Action_Obligation_Then_Year*100]<-'WON Chg'
W912UM$changeWon[is.na(W912UM$changeWon) &
                    abs(W912UM$ChangeOrderBaseAndAllOptionsValue)>=W912UM$Action_Obligation_Then_Year*10]<-'? Chg'
W912UM$changeWon[is.na(W912UM$changeWon) &
                    abs(W912UM$ChangeOrderBaseAndAllOptionsValue)<W912UM$Action_Obligation_Then_Year*10]<-'$ Chg'
summary(factor(W912UM$changeWon))


W912UM$sumWon<-NA
W912UM$sumWon[W912UM$Action_Obligation_Then_Year==0]<-'0 Obl'
W912UM$sumWon[W912UM$UnmodifiedContractBaseAndAllOptionsValue_Then_Year+
                W912UM$ChangeOrderBaseAndAllOptionsValue>=W912UM$Action_Obligation_Then_Year*500]<-'WON Sum'
W912UM$sumWon[is.na(W912UM$sumWon) &
                    W912UM$UnmodifiedContractBaseAndAllOptionsValue_Then_Year+
                W912UM$ChangeOrderBaseAndAllOptionsValue>=W912UM$Action_Obligation_Then_Year*10]<-'? Sum'
W912UM$sumWon[is.na(W912UM$sumWon) &
                    W912UM$UnmodifiedContractBaseAndAllOptionsValue_Then_Year+
                W912UM$ChangeOrderBaseAndAllOptionsValue<W912UM$Action_Obligation_Then_Year*10]<-'$ Sum'
summary(factor(W912UM$sumWon))



(
ggplot(W912UM, aes(x=UnmodifiedContractBaseAndAllOptionsValue_Then_Year+ChangeOrderBaseAndAllOptionsValue,y=Action_Obligation_Then_Year,color=sumWon)) +#,color=qGrowth
  geom_point(alpha=0.25)+
  # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_x_log10()+scale_y_log10()+
  #+
#   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
facet_grid(unmodWon~changeWon)#+, space="free_y"
#   labs(title="Distribution of Ceiling Breaches",
#        y="Percent of Growth in  Ceiling",
#        x="Unmodified Contract Ceiling")#,
#        # fill="Termination Completion"
)


(
ggplot(W912UM, aes(x=UnmodifiedContractBaseAndAllOptionsValue_Then_Year+ChangeOrderBaseAndAllOptionsValue,y=Action_Obligation_Then_Year,color=sumWon)) +#,color=qGrowth
  geom_point(alpha=0.25)+
  # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_x_log10()+scale_y_log10()+
  #+
#   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
facet_wrap(~Veh)#+, space="free_y"
#   labs(title="Distribution of Ceiling Breaches",
#        y="Percent of Growth in  Ceiling",
#        x="Unmodified Contract Ceiling")#,
#        # fill="Termination Completion"
)

W912UM$Intl
(
ggplot(W912UM, aes(x=UnmodifiedContractBaseAndAllOptionsValue_Then_Year+ChangeOrderBaseAndAllOptionsValue,y=Action_Obligation_Then_Year,color=sumWon)) +#,color=qGrowth
  geom_point(alpha=0.25)+
  # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_x_log10()+scale_y_log10()+
  #+
#   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
facet_wrap(~Intl)#+, space="free_y"
#   labs(title="Distribution of Ceiling Breaches",
#        y="Percent of Growth in  Ceiling",
#        x="Unmodified Contract Ceiling")#,
#        # fill="Termination Completion"
)


```

All of the questionable contracts take place internationally and none use BPA/BOA or FSS/GWACs. That makes sense and raises confidence, but given that the clearly USD contract categories are less common, this doesn't help in resolving the ambiguous cases. That said, Single Award IDCs appear to have most of the ambigious cases, which suggests that this might be resolvable by looking at parent IDVs in those cases. 

# Ceiling Growth
```{r CeilingGrowthGraphs}

(
ggplot(cbre, aes(x=UnmodifiedContractBaseAndAllOptionsValue_Then_Year,y=n_CBre-1)) +#,color=qGrowth
  geom_point(alpha=0.25,shape=".")+
  # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_x_log10()+scale_y_log10()+
  #+
  geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
# facet_wrap(~Ceil,scales="free_y")+#+, space="free_y"
  labs(title="Distribution of Ceiling Breaches",
       y="Percent of Growth in  Ceiling",
       x="Unmodified Contract Ceiling")#,
       # fill="Termination Completion"
)


(
ggplot(cbre, aes(x=UnmodifiedContractBaseAndAllOptionsValue_Then_Year,y=ChangeOrderCeilingGrowth)) +#,color=qGrowth
  geom_point(alpha=0.25,shape=".")+
  # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_x_log10()+scale_y_log10()+
  #+
  geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
# facet_wrap(~Ceil,scales="free_y")+#+, space="free_y"
  labs(title="Distribution of Ceiling Breaches",
       y="Percent of Growth in  Ceiling",
       x="Unmodified Contract Ceiling")#,
       # fill="Termination Completion"
)

cbre$Action_Obligation_Then_Year

(
ggplot(cbre, aes(x=UnmodifiedContractBaseAndAllOptionsValue_Then_Year+ChangeOrderBaseAndAllOptionsValue,y=Action_Obligation_Then_Year)) +#,color=qGrowth
  geom_point(alpha=0.25,shape=".")+
  # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_x_log10()+scale_y_log10()#+
  #+
#   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
# # facet_wrap(~Ceil,scales="free_y")+#+, space="free_y"
#   labs(title="Distribution of Ceiling Breaches",
#        y="Percent of Growth in  Ceiling",
#        x="Unmodified Contract Ceiling")#,
#        # fill="Termination Completion"
)


(
ggplot(cbre, aes(x=UnmodifiedContractBaseAndAllOptionsValue_Then_Year+ChangeOrderCeilingGrowth,y=Action_Obligation_Then_Year)) +#,color=qGrowth
  geom_point(alpha=0.25,shape=".")+
  # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_x_log10()+scale_y_log10()#+
  #+
#   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
# # facet_wrap(~Ceil,scales="free_y")+#+, space="free_y"
#   labs(title="Distribution of Ceiling Breaches",
#        y="Percent of Growth in  Ceiling",
#        x="Unmodified Contract Ceiling")#,
#        # fill="Termination Completion"
)
summary(cbre$ChangeOrderBaseAndAllOptionsValue)




(
ggplot(cbre, aes(x=ChangeOrderCeilingGrowth,y=ChangeOrderBaseAndAllOptionsValue)) +#,color=qGrowth
  geom_point(alpha=0.25,shape=".")+
  # theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_x_log10()+scale_y_log10()#+
  #+
#   geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
# # facet_wrap(~Ceil,scales="free_y")+#+, space="free_y"
#   labs(title="Distribution of Ceiling Breaches",
#        y="Percent of Growth in  Ceiling",
#        x="Unmodified Contract Ceiling")#,
#        # fill="Termination Completion"
)

(
ggplot(cbre, aes(x=n_CBre-1,fill=qGrowth)) +
  geom_histogram(bins=100)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_x_log10()+
  #+
  geom_vline(xintercept = c(1,10,100))+#+geom_vline(xintercept = 0.1)+
facet_wrap(~Ceil,scales="free_y")+#+, space="free_y"
  labs(title="Distribution of Ceiling Breaches",
       y="Contract Count",
       x="Percent of Growth in  Ceiling")#,
       # fill="Termination Completion"
)






(
ggplot(cbre, aes(x=ChangeOrderCeilingGrowth,fill=qGrowth)) +
  geom_histogram(bins=100)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_x_log10()+
  #+
  geom_vline(xintercept = 1)#+geom_vline(xintercept = 0.1)+
#facet_grid(NoPreTermObl~.,scales="free_y", space="free_y")+
  # labs(title="Distribution of Contracts with Obligations After Last termination",
  #      y="Contract Count",
  #      x="Percent of Obligations After Day of Termination",
  #      fill="Termination Completion"
)

(
ggplot(cbre, aes(x=ChangeOrderCeilingGrowth,fill=qGrowth)) +
  geom_histogram(bins=100)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_x_log10()+
  #+
  geom_vline(xintercept = 1)+
facet_wrap(~Ceil,scales="free_y")#+, space="free_y"
#+geom_vline(xintercept = 0.1)+
#facet_grid(NoPreTermObl~.,scales="free_y", space="free_y")+
  # labs(title="Distribution of Contracts with Obligations After Last termination",
  #      y="Contract Count",
  #      x="Percent of Obligations After Day of Termination",
  #      fill="Termination Completion"
)


```
