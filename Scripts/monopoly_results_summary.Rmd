---
title: "Monopoly Results Summary"
output:
  html_document:
    keep_md: yes
    toc: yes
date: "Wednesday, February 8, 2017"
---

#Setup
```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(arm)
library(R2WinBUGS)
library(knitr)
library(foreign)
library(stargazer)
library(texreg)
library(reshape2)
source("DIIGstat.r")

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40


```


Contracts are classified using a mix of numerical and categorical variables. While the changes in numerical variables are easy to grasp and summarize, a contract may have one line item that is competed and another that is not. As is detailed in the exploration on R&D, we are only considering information available prior to contract start. The percentage of contract obligations that were competed is a valuable benchmark, but is highly influenced by factors that occured after contract start..

## Contract Terminations

Contract terminations and the number of change orders can be calculated for the entire sample.  Contract termination is determined using the *Reason for Modification* field in FPDS.  A contract is considered to be terminated if it has at least one modification with the following values:

* "Terminate for Default (complete or partial)"
* "Terminate for Convenience (complete or partial)"
* "Terminate for Cause"
* "Legal Contract Cancellation"

These four categories and the "Close Out" category are used to mark a contract as closed.  Many contracts in FPDS and in the sample are never marked closed.  


##Prepare Data
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from   FPDS.


###Data Transformations and Summary



```{r ReadInData, echo = TRUE}
# load(file="../Data/Clean/defense_contract_complete.RData")
# save(file="Data/defense_contract_complete.RData",def)
# def<-def[def$MinOfSignedDate>=as.Date("2008-01-01") & def$MinOfSignedDate<=as.Date("2015-12-31"),]
# # head(def)
# debug(transform_contract)
# def<-transform_contract(def)
# 
# 



# summary(def$UnmodifiedContractBaseAndAllOptionsValue)
# summary(def$Action.Obligation)



load(file="../Data/Clean/transformed_def.Rdata")
# def<-def[!colnames(def) %in% colnames(def)[grep("^l_",colnames(def))]]
# save(file="Data/transformed_def.Rdata", def)


#Removing l_s just to reduce size. They can be derived easily.

# load("..//Output//naics_join.Rdata")

```



## Dependent Variables

NA_stats(def,"b_Term")
* b_Term is a binary variable that has a value of 1 for any contracts that have experienced a partial or complete termination, 0 otherwise. (`r summary(def$b_Term);
sum(def$Action.Obligation[def$b_Term==1],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)`
* b_CBre is a binary variable that has a value of 1 for any contracts that have experienced a partial or complete termination, 0 otherwise. (`r summary(def$b_CBre);
sum(def$Action.Obligation[def$b_CBre==1],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
NA_stats(def,"b_CBre")`)

```{r vargraphs: b_Term, b_CBre}
#The original variables for b_Term and b_CBre are Term and CBre
grouped_barplot("Term", def)
grouped_barplot("CBre", def)
statsummary_discrete(c("Term"), def)
statsummary_discrete(c("CBre"), def)
statsummary_continuous(c("UnmodifiedNumberOfOffersReceived"), def)
```

### Termination Examination
The reason for modification code includes both partial and complete terminations. As a way of differentiating complete from partial terminations, we take a closer look at how much spending happened after a contracts last termination. The last termination was used because a contract with both a partial and a complete termination would still qualify as having been completely terminated.


#### After Termination Processing

```{r TermInput}
term<-def %>% dplyr::filter(Term=="Terminated")


term<-csis360::read_and_join_experiment(term,
                            lookup_file = "Contract.SP_ContractTerminationExamination.txt",
                            path="..\\",
                            dir="Data\\semi_clean\\",
                            by="CSIScontractID"#,
                            # skip_check_var=c("ObligatedBeforeMaxTerminatedDate",
                            #                  "ObligatedOnMaxTerminatedDate",
                            #                  "ObligatedAfterMaxTerminatedDate")
)

# summary(term)
summary(term$ObligatedBeforeMaxTerminatedDate)
summary(term$ObligatedAfterMaxTerminatedDate)
summary(term$ObligatedOnMaxTerminatedDate)
summary(term$MaxTerminatedDate)
sum(term$ObligatedBeforeMaxTerminatedDate)
sum(term$ObligatedOnMaxTerminatedDate)
sum(term$ObligatedAfterMaxTerminatedDate)

summary(term$qHighCeiling)
  if (all(levels(term$qHighCeiling)[1:5]==c("[0.00e+00,1.50e+04)",
                                             "[1.50e+04,1.00e+05)",
                                             "[1.00e+05,1.00e+06)",
                                             "[1.00e+06,1.00e+07)",
                                             "[1.00e+07,7.50e+07)"))){
      term$qHighCeiling<-factor(term$qHighCeiling,

                                    levels=c("[0.00e+00,1.50e+04)",
                                             "[1.50e+04,1.00e+05)",
                                             "[1.00e+05,1.00e+06)",
                                             "[1.00e+06,1.00e+07)",
                                             "[1.00e+07,7.50e+07)",
                                             levels(term$qHighCeiling)[6]),
                                    labels=c("[0,15k)",
                                             "[15k,100k)",
                                             "[100k,1m)",
                                             "[1m,10m)",
                                             "[10m,75m)",
                                             "[75m+]"),
                                    ordered=TRUE)
  }
```

```{r TermProcess}

#How often there no net pre-termination obligations
nrow(term %>% filter(ObligatedBeforeMaxTerminatedDate<=0))

#How often are contracts terminated on their first day
nrow(term %>% filter(MaxTerminatedDate<=MinOfSignedDate) )

# term$PreTerm<-NA
# term$PreTerm[term$MaxTerminatedDate<=term$MinOfSignedDate]<-
#   term$ObligatedBeforeMaxTerminatedDate[term$MaxTerminatedDate<=term$MinOfSignedDate]+
#   term$ObligatedOnMaxTerminatedDate[term$MaxTerminatedDate<=term$MinOfSignedDate]
# term$PreTerm[term$MaxTerminatedDate>term$MinOfSignedDate]<-
#   term$ObligatedBeforeMaxTerminatedDate[term$MaxTerminatedDate>term$MinOfSignedDate]

term$ThroughTerm<-term$ObligatedBeforeMaxTerminatedDate+
  term$ObligatedOnMaxTerminatedDate[term$MaxTerminatedDate<=term$MinOfSignedDate]


# term$PostTerm<-NA
# term$PostTerm[term$MaxTerminatedDate<=term$MinOfSignedDate]<-
#   term$ObligatedAfterMaxTerminatedDate[term$MaxTerminatedDate<=term$MinOfSignedDate]
# term$PostTerm[term$MaxTerminatedDate>term$MinOfSignedDate]<-
#   term$ObligatedOnMaxTerminatedDate[term$MaxTerminatedDate>term$MinOfSignedDate]+
#   term$ObligatedAfterMaxTerminatedDate[term$MaxTerminatedDate>term$MinOfSignedDate]
#   
# term$PreTerm[term$MaxTerminatedDate<=term$MinOfSignedDate]<-
#   term$ObligatedBeforeMaxTerminatedDate[term$MaxTerminatedDate<=term$MinOfSignedDate]+
#   term$ObligatedOnMaxTerminatedDate[term$MaxTerminatedDate<=term$MinOfSignedDate]



nrow(term %>% filter(ThroughTerm<=0))
nrow(term %>% filter(ThroughTerm<=ObligatedAfterMaxTerminatedDate))
nrow(term %>% filter(ThroughTerm/10<=ObligatedAfterMaxTerminatedDate))

term$PostTermFloor0<-term$ObligatedAfterMaxTerminatedDate
term$PostTermFloor0[term$PostTermFloor0<0]<-0
term$PreTermFloor1<-term$ThroughTerm
term$PreTermFloor1[term$ThroughTerm<1]<-1
term$TermRatio<-term$PostTermFloor0/term$PreTermFloor1
term$TermRatioCapped<-term$TermRatio
term$TermRatioCapped[term$TermRatio>1]<-1
summary(term$TermRatioCapped)
# g<-build_plot(
#   data=term, # %>% dplyr::select(PostTermFloor0),
#   chart_geom = "Histogram",
#   share = FALSE,
#   # labels_and_colors=labels_and_colors,
#   # NA, #VAR.ncol
#   x_var="PostTermFloor0", #x_var
#   y_var="Count", #VAR.y.variable
#   # color_var="DecisionTreeDisplay", #color_var
#   # facet_var="DecisionTreeDisplay", #facet_var
#   # column_key=column_key,
#   format=TRUE
# )


term$NoPreTermObl<-"Some Net $s Pre-Term."
term$NoPreTermObl[term$ObligatedBeforeMaxTerminatedDate<=0]<-"Terminated Before Any Net $s"
term$NoPreTermObl<-factor(term$NoPreTermObl)


term$TerMRatioCat<-Hmisc::cut2(term$TermRatio,c(0.1,1))
summary(term$TerMRatioCat)
levels(term$TerMRatioCat)[3]<-"[100%+]"
term$TerMRatioCat<-as.character(term$TerMRatioCat)
term$TerMRatioCat[term$TermRatio==0]<-"[0]"
term$TerMRatioCat[term$TermRatio==0 & term$ObligatedOnMaxTerminatedDate>0]<-"[0]+Last Day Spend"
# term$TerMRatioCat[term$TermRatio==0 & term$ObligatedOnMaxTerminatedDate>0 & term$MaxTerminatedDate<=term$MinOfSignedDate]<-"[0]+One Day Spend"
summary(factor(term$TerMRatioCat))


term$TerMRatioCat<-factor(term$TerMRatioCat)



levels(term$TerMRatioCat)<-list(
  "[0]+No Last Day Spend"="[0]",
  "[0]+Last Day Spend"="[0]+Last Day Spend",
  "(0%,10%)"="[0.00e+00,1.00e-01)",
  "[10%,100%)"="[1.00e-01,1.00e+00)",
  "[100%+]"="[100%+]"
)
term$TerMRatioCat3<-term$TerMRatioCat
levels(term$TerMRatioCat3)<-list(
  "Term Ends Spend"="[0]+No Last Day Spend",
  "Last Day Spend"="[0]+Last Day Spend",
  "Any After"=c("(0%,10%)","[10%,100%)","[100%+]")
)
summary(term$TerMRatioCat)


term$PreTermLength<-term$MaxTerminatedDate-term$MinOfSignedDate
summary(term$PreTermLength)

term$FirstDayTerm<-"No"
term$FirstDayTerm[term$MaxTerminatedDate==term$MinOfSignedDate]<-"Yes"

(
TermRatioHist<-ggplot(term %>% filter(TermRatioCapped>0),aes(x=TermRatio,fill=TerMRatioCat )) +
  geom_histogram(bins=100)+scale_x_log10(breaks=c(0.001,0.01,0.1,0.5,1,10,100,1000))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  geom_vline(xintercept = 1)+geom_vline(xintercept = 0.1)+
facet_grid(NoPreTermObl~.,scales="free_y")+
  labs(title="Distribution of Contracts with Obligations After Last termination",
       y="Contract Count",
       x="Ratio of Spending After Termination\nto Spending Through Termination",
       fill="Termination Completion"
       )
)

(
TermRatio<-ggplot(term,aes(x=TermRatio)) +
  stat_ecdf(geom = "step")+
    coord_cartesian(ylim=c(0.9,1),xlim=c(0,2))+
  labs(title="Cumulative Distribution of Terminated Contracts",
       y="% of Terminated Contracts",
       x="Ratio of Spending After Termination\nto Spending Through Termination"
       )
)

(
TermCeilRatio<-ggplot(term,aes(x=TermRatio,color=qHighCeiling)) +
  stat_ecdf(geom = "step")+
    coord_cartesian(ylim=c(0.70,1),xlim=c(0,3))+geom_vline(xintercept = 0.1)+
  labs(title="Cumulative Distribution of Terminated Contracts",
       y="% of Category's Terminated Contracts",
       x="Ratio of Spending After Termination\nto Spending Through Termination",
       color="Initial Ceiling")+
  scale_y_continuous(label=percent)
)

(
TermObl<-ggplot(term,aes(x=PostTermFloor0+1)) +
  stat_ecdf(geom = "step")+
    coord_cartesian(ylim=c(0.9,1))+#+,xlim=c(0,1e8)
  scale_x_log10(label=comma)+
  labs(title="Cumulative Distribution of Terminated Contracts",
       y="% of Terminated Contracts",
       x="Obligations After Termination")
)
#+geom_vline(xintercept = 0.1)+geom_vline(xintercept =1)+

# termDouble<-term
# termDouble$qHighCeiling<-"Overall"
# termDouble$NoPreTermObl<-"Overall"

(
TermNoObl<-ggplot(term,aes(x=PostTermFloor0+1,color=NoPreTermObl)) +
  stat_ecdf(geom = "step")+
    coord_cartesian(ylim=c(0.9,1))+#+,xlim=c(0,1e8)
  scale_x_log10(label=comma)+
  labs(title="Cumulative Distribution of Terminated Contracts",
       y="% of Category's Terminated Contracts",
       x="Obligations After Termination",
       color="Any Spending Before Termination?")+
    theme(legend.position = "bottom")
#+geom_vline(xintercept = 0.1)+geom_vline(xintercept =1)+
)

(
TermCeilObl<-ggplot(term,aes(x=PostTermFloor0+1,color=qHighCeiling)) +
  stat_ecdf(geom = "step")+stat_ecdf(geom = "step",aes(x=PostTermFloor0+1))+
    coord_cartesian(ylim=c(0.65,1))+#+,xlim=c(0,1e8)
  scale_x_log10(label=comma)+
  labs(title="Cumulative Distribution of Terminated Contracts",
       y="% of Category's Terminated Contracts",
       x="Obligations After Termination",
       color="Initial Ceiling")+
  scale_y_continuous(label=percent)
)

ggsave(TermCeilRatio,file="../Output/TermCeilRatio.png")

```
An odd side effect of the way histograms work, it actually overestimates the number of 0 and above cap growth entries there are, there's only 83,306 

#### After Term Crosstabs
```{r TermCrosstab}

summary(term$TerMRatioCat)


freq_table("TerMRatioCat",term)

(
  TermSum<-grouped_barplot("TerMRatioCat",term)+
    labs(title = "Termination Completion Summary")
)

(
TermOblByCeil<-ggplot(term,aes(x=TerMRatioCat,fill=TerMRatioCat,y=Action.Obligation)) +
  geom_col()+scale_y_continuous(labels = comma)+
  facet_wrap(qHighCeiling~.)+
  labs(title="Termination Completeness by Initial Ceiling",
       y="Contract Obligations",
       x="Termination Completeness")+
  theme(legend.position="None",axis.text.x = element_text(angle=90))
)

# ggplot(term,aes(x=NoPreTermObl,fill=TerMRatioCat)) +facet_grid(TerMRatioCat3~.,scales="free_y")+
#   geom_bar()+scale_y_continuous(labels = comma)

(
TermComp<-ggplot(term,aes(x=CompOffr,fill=TerMRatioCat)) +facet_grid(TerMRatioCat3~.,scales="free_y")+
  geom_bar()+scale_y_continuous(labels = comma)+
  labs(title="Competition and Termination Completeness",
       y="Contract Count",
       x="Termination Completeness",
       fill="Termination Completeness")
)


(
TermVeh<-ggplot(term,aes(x=Veh,fill=TerMRatioCat)) +facet_grid(TerMRatioCat3~.,scales="free_y")+
  geom_bar()+scale_y_continuous(labels = comma)+
  labs(title="Vehicle and Termination Completeness",
       y="Contract Count",
       x="Termination Completeness",
       fill="Termination Completeness")
)

term$Veh3<-term$Veh
levels(term$Veh3)=list(
  "Def/Pur"="Def/Pur",
  "S-IDC"="S-IDC",
  "Other IDV"=c("M-IDC","FSS/GWAC","BPA/BOA" )
)

(
TermDur<-ggplot(term,aes(x=PreTermLength,color=TerMRatioCat)) +
  stat_ecdf(geom = "step")+
    coord_cartesian(ylim=c(0,1))+#+,xlim=c(0,1e8)
  # scale_x_log10(label=comma)+
  labs(title="Duration and Termination Completeness",
       y="Cumulative Distribution % of\nCategory's Terminated Contracts",
       x="Days from Start to Final Termination",
       color="Termination Completeness")+
  scale_y_continuous(label=percent)
)


(
TermDay1<-ggplot(term %>% filter(FirstDayTerm=="Yes" & !is.na(CompOffr) & !is.na(Veh)),
                 aes(x=TerMRatioCat3,fill=TerMRatioCat)) +facet_grid(Veh3~CompOffr)+
  geom_bar()+scale_y_continuous(labels = comma)+
  labs(title="Distribution of Day 1 Final Termination Contracts",
       y="Contract Count",
       x="Competition Category",
       fill="Termination Completeness",
       caption="Unlabeled Vehicle and Competition Excluded")+
    theme(legend.position = "bottom",
          axis.text.x = element_text(angle = 90))+
    scale_fill_discrete(guide=guide_legend(nrow=2))
)


ggsave(TermSum,file="../Output/TermSum.png")
ggsave(TermDur,file="../Output/TermDur.png")
ggsave(TermDay1,file="../Output/TermDay1.png")

```


## Independent Variables
### Study Variables

* b_Comp is a binary variable based on competition. It has a value of 0 for uncompeted contracts and a value of 1 for competition, regardless of number of offers. `r  summary(def$Comp);
NA_stats(def,"Comp") `
* n_Comp is a binary variable based on competition. It has a value of 0 for uncompeted contracts and a value of 1 for competition, regardless of number of offers. `r  summary(def$EffComp);
NA_stats(def,"EffComp")
sum(def$Action.Obligation[def$EffComp=="No Comp."],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
sum(def$Action.Obligation[def$EffComp=="1 Offer"],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
sum(def$Action.Obligation[def$EffComp=="2+ Offers"],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)`
)
* CompOffr is a dummy variable based on competition and the number of offers. It's baseline value is No Competition, sole-source contracts, which are intentionally not assigned a dummy to avoid multicollinearity. `r  summary(def$CompOffr);
debug(NA_stats)
NA_stats(def,"CompOffr")
sum(def$Action.Obligation[def$CompOffr=="No Competition"],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
sum(def$Action.Obligation[def$CompOffr=="1 offer"],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
sum(def$Action.Obligation[def$CompOffr=="2 offers"],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
sum(def$Action.Obligation[def$CompOffr=="3-4 offers"],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
sum(def$Action.Obligation[def$CompOffr=="5+ offers"],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)

length(def$CompOffr[def$CompOffr=="No Competition" & !is.na(def$CompOffr)])/nrow(def)
length(def$CompOffr[def$CompOffr=="1 offer"& !is.na(def$CompOffr)])/nrow(def)
length(def$CompOffr[def$CompOffr=="2 offers"& !is.na(def$CompOffr)])/nrow(def)
length(def$CompOffr[def$CompOffr=="3-4 offers"& !is.na(def$CompOffr)])/nrow(def)
length(def$CompOffr[def$CompOffr=="5+ offers"& !is.na(def$CompOffr)])/nrow(def)

`
)
summary(def$offer)
centered_description(def$UnmodifiedNumberOfOffersReceived,"number of offers")
centered_log_description(def$UnmodifiedNumberOfOffersReceived,"number of offers")
NA_stats(def,"cl_Offr")
<!-- cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+ -->
                            <!-- #cl_US3_avg_sal_lag1+ -->
                            <!-- cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+ -->
                            <!-- cl_US6_avg_sal_lag1+ -->


centered_log_description(def$l_def3_obl_lag1,"obligations")
centered_log_description(def$l_def6_obl_lag1,"obligations")
NA_stats(def,"l_def3_obl_lag1")

NA_stats(def,"l_def6_obl_lag1")
def$l_def6_ratio_lag1[is.nan(def$l_def6_ratio_lag1) | is.infinite(def$l_def6_ratio_lag1)]<-NA
def$cl_def6_ratio_lag1[is.nan(def$cl_def6_ratio_lag1) | is.infinite(def$cl_def6_ratio_lag1)]<-NA

centered_log_description(def$l_def3_ratio_lag1,"obligations")

centered_log_description(def$l_def6_ratio_lag1,"obligations")
centered_log_description(def$l_def6_ratio_lag1[!
NA_stats(def,"cl_def3_ratio_lag1")
NA_stats(def,"cl_def6_ratio_lag1")

                            
                            
* cl_def6_HHI_lag1 is a numeric variable based on the HHI Index of a NAICS code for defense contracting. Index values of 1500 and below are considered unconsolidated. 1500-2000 is considered moderately consolidated. And 2,000 and above are considered highly consolidated. The scale runs from 0 to 10,000. `r summary(def$cl_def6_HHI_lag1);
summary(def$l_def6_HHI_lag1);
centered_description(def$def6_HHI_lag1,"HHI score")
centered_log_description(def$l_def6_HHI_lag1,"HHI score")

NA_stats(def,"def6_HHI_lag1")
NA_stats(def,"def3_HHI_lag1")
centered_description(def$def3_HHI_lag1,"HHI score")
centered_log_description(def$def3_HHI_lag1,"HHI score")

cl_US6_avg_sal_lag1
cl_US6_avg_sal_lag1
centered_log_description(def$l_US6_avg_sal_lag1,"dollars")
NA_stats(def,"cl_US6_avg_sal_lag1")
NA_stats(def,"cl_def3_HHI_lag1")
`
```{r statistic summary table for continuous variables: cl_def_HHI_lag1, cl_def_ratio_lag1, cl_US_avg_sal_lag1, cl_def_obl_lag1, all use original variables instead}
HHI_category <- c("def6_HHI_lag1", "def5_HHI_lag1", "def4_HHI_lag1","def3_HHI_lag1", "def2_HHI_lag1")
ratio_category <- c("capped_def6_ratio_lag1", "capped_def5_ratio_lag1", "capped_def4_ratio_lag1", "capped_def3_ratio_lag1", "capped_def2_ratio_lag1")
avg_category <- c("US6_avg_sal_lag1", "US5_avg_sal_lag1", "US4_avg_sal_lag1", "US3_avg_sal_lag1", "US2_avg_sal_lag1")
obl_category <- c("def6_obl_lag1", "def5_obl_lag1", "def4_obl_lag1", "def3_obl_lag1", "def2_obl_lag1" )

statsummary_discrete("CompOffr",def)



hhi<-statsummary_continuous(HHI_category, def)
hhi
write.csv(hhi,file="..//Output/hhi_summary.csv")
statsummary_continuous(ratio_category, def)
statsummary_continuous(avg_category, def)
statsummary_continuous(obl_category, def)

statsummary_discrete("CompOffr", def)
```




```{r varGraphs: b_Comp, n_Comp, Comp, CompOffr, EffComp, offr}
# b_Comp
# n_Comp
# Comp
# EffComp
# CompOffr
# offr:


grouped_barplot("Comp",def)
grouped_barplot("EffComp",def)
grouped_barplot("CompOffr", def)
grouped_barplot("Offr", def)

# def$n_Comp <- factor(def$n_Comp,c(0,1))
# grouped_barplot("Comp", def)
# #grouped_barplot("n_Comp")
# grouped_barplot("Comp", def)
# grouped_barplot("EffComp", def)
# grouped_barplot("CompOffr", def)
# grouped_barplot("Offr", def)

```




### Initial Contract Scope
* cl_Ceil is the natural log of the initial contract cost ceiling, in then-year dollars. `r centered_log_description(def$UnmodifiedContractBaseAndAllOptionsValue,"dollars");
NA_stats(def,"cl_Ceil")`
* cl_Days is the natural log of the initial maximum duration of the contract, in days. The variable is centered, by subtracting its mean (`r centered_log_description(def$UnmodifiedDays,"days");
NA_stats(def,"cl_Days")` 


```{r statistic summary table for continuous variables: cl_Ceil, cl_Days}
#original variable for cl_Ceil: UnmodifiedContractBaseAndAllOptionsValue
#original variable for cl_Days: UnmodifiedDays


statsummary_continuous(c("UnmodifiedDays","UnmodifiedContractBaseAndAllOptionsValue"), def)



```


### Contract Vehicle
* SIDV, MIDV, and FSS/GWAC, BPA/BOA are dummy variables based on the contract vehicle. They correspond to Single-Award IDVs, Multi-Award IDVs, and Other IDVs, respectively, having a value of 1 when the task order has that vehicle type, and having a 0 other. The remaining types, definitive contracts and purchase orders, are intentionally left out. (`r 
summary(def$Veh);
length(def$Veh[def$Veh =="Def/Pur"])/nrow(def)

length(def$Veh[def$Veh =="S-IDC"& !is.na(def$Veh)])/nrow(def)
length(def$Veh[def$Veh =="M-IDC"& !is.na(def$Veh)])/nrow(def)
length(def$Veh[def$Veh =="FSS/GWAC"& !is.na(def$Veh)])/nrow(def)
length(def$Veh[def$Veh =="BPA/BOA"& !is.na(def$Veh)])/nrow(def)
NA_stats(def,"Veh")`

```{r VehGraph}
grouped_barplot("Veh", def)
statsummary_discrete("Veh", def)
```


### Pricing Fee
* n_Fixed is a numeric variable based on contract pricing. It has a value of 0 for cost-based, 0.5 or "combination or other", 1 for any fixed price (excluding fixed-price level of effort which is classified as cost-based). (`r summary(def$n_Fixed);
NA_stats(def,"n_Fixed")
sum(def$Action.Obligation[def$n_Fixed==0],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
sum(def$Action.Obligation[def$n_Fixed==0.5],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
sum(def$Action.Obligation[def$n_Fixed==1],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
nrow(def[def$n_Fixed==0,])/nrow(def)
nrow(def[def$n_Fixed==0.5,])/nrow(def)
nrow(def[def$n_Fixed==1,])/nrow(def)


summary(def$PricingFee);
length(def$PricingFee[def$PricingFee =="FFP"])/nrow(def)

length(def$PricingFee[def$PricingFee =="Other FP" & !is.na(def$PricingFee)])/nrow(def)
length(def$PricingFee[def$PricingFee =="Incentive" & !is.na(def$PricingFee)])/nrow(def)
length(def$PricingFee[def$PricingFee =="Combination or Other" & !is.na(def$PricingFee)])/nrow(def)
length(def$PricingFee[def$PricingFee =="Other CB" & !is.na(def$PricingFee)])/nrow(def)
length(def$PricingFee[def$PricingFee =="T&M/LH/FPLOE" & !is.na(def$PricingFee)])/nrow(def)
NA_stats(def,"PricingFee")

`)
NA_stats(def,"n_Incent")`)
* b_UCA is a binary variable with a value of 1 for contracts/task orders that begin as letter contracts or undefinitized contract awards (UCA) and a value of 0 otherwise. `r summary(def$b_UCA);
sum(def$Action.Obligation[def$b_UCA==1],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
length(def$b_UCA[def$b_UCA==1 & !is.na(def$b_UCA)])/nrow(def)
NA_stats(def,"b_UCA")`
* b_Intl is a binary variable with a value of 1 for contracts/task orders with any transactions performed internationally and a value of 0 otherwise. `r summary(def$b_Intl);
sum(def$Action.Obligation[def$b_Intl==1],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
NA_stats(def,"b_Intl")`
* NAICS is a factor reporting the top North American Industrial Classification Code of each contract. 
`r summary(def$NAICS);
NA_stats(def,"NAICS")`
* Agency is a factor reporting the top Contracting Agency of each contract. 
`r summary(def$Agency);
NA_stats(def,"Agency")`
* Office is a factor reporting the top Contracting office of each contract. 
`r summary(def$Office);
NA_stats(def,"Office")`


```{r PricingFeeGraphs}
#n_Fixed(0,1), PricingFee, n_Incent, b_UCA(0,1), b_Intl
#original variable for b_UCA: UCA
#original variable for n_Fixed: FxCb
#original variable for n_Incent: Fee

def$n_Fixed <- factor(def$n_Fixed, c(0,0.5,1))
def$n_Incent <- factor(def$n_Incent, c(0,0.5,1))
def$b_UCA <- factor(def$b_UCA, c(0,1))
grouped_barplot("FxCb", def)
grouped_barplot("Fee", def)
grouped_barplot("PricingFee", def)
grouped_barplot("UCA", def)
statsummary_discrete("PricingFee", def)
statsummary_discrete("UCA", def)
```
### International

```{r International}
#n_Fixed(0,1), PricingFee, n_Incent, b_UCA(0,1), b_Intl
#original variable for b_UCA: UCA
#original variable for n_Fixed: FxCb
#original variable for n_Incent: Fee

grouped_barplot("Intl", def)
statsummary_discrete("Intl", def)
```
### Agency


```{r frequancy bar plot for agency}
#Prepare the dataframe for plot
Agency_Freq <- as.data.frame(table(def$Agency))
Agency_Freq$Percent_Freq <- round(Agency_Freq$Freq/sum(Agency_Freq$Freq),4)*100
colnames(Agency_Freq) <- c("Agency","Count_Freq","Percent_Freq")
Agency_Freq <- Agency_Freq[order(-Agency_Freq$Count_Freq),]
Agency_Freq <- Agency_Freq[1:10,]

#Add detail description to Agency code
Agency_Lookup <- read.csv("https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/Agency_AgencyID.csv")
Agency_Lookup <- Agency_Lookup[,1:2]
colnames(Agency_Lookup) <- c("Agency","Agency_Description")
Agency_Freq <- left_join(Agency_Freq, Agency_Lookup, by = "Agency")
Agency_Freq$Agency <- factor(Agency_Freq$Agency, levels = rev(Agency_Freq$Agency))
Agency_Freq <- Agency_Freq[order(-Agency_Freq$Percent_Freq),]
Agency_Freq$Agency_Description <- factor(Agency_Freq$Agency_Description, 
                                         levels=rev(Agency_Freq$Agency_Description))

#build the frequency bar plot
Frequency_Plot3 <- ggplot(data = Agency_Freq, aes(x=Agency_Description,        y=Percent_Freq)) +
                   geom_bar(stat = "identity", position = "dodge", width = 0.8) +
                   coord_flip() +
                   xlab("Agency") +
                   ylab("Percent of Frequency") +
                   theme_grey() +
                   scale_fill_grey() +
                   ggtitle("Top 10 of the most frequently appeared Agency") +
                   theme(text = element_text(size = 10))
Frequency_Plot3
```


```{r frequancy and obligation percent grouped bar plot for agency}

#Percent grouped bar plot for variable Agency
#Generate new data frame containing frequency information
Agency_Freq <- as.data.frame(table(def$Agency))
Agency_Freq$Percent_Freq <- round(Agency_Freq$Freq/sum(Agency_Freq$Freq),4)*100
colnames(Agency_Freq) <- c("Agency","Count_Freq","Percent_Freq")

#Add detail Agency description according to agency code
Agency_Lookup <- read.csv("https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/Agency_AgencyID.csv")
Agency_Lookup <- Agency_Lookup[,1:2]
colnames(Agency_Lookup) <- c("Agency","Agency_Description")
Agency_Freq <- left_join(Agency_Freq, Agency_Lookup, by = "Agency")
#Add obligation percent information to data frame
Percent_Obli <- c()
for (i in Agency_Freq$Agency) {
  Percent_Obligation <- round(sum(def$Action.Obligation[def$Agency == i], na.rm = TRUE)/sum(def$Action.Obligation, na.rm = TRUE),5)
  Percent_Obli <- c(Percent_Obli, Percent_Obligation)
}
Agency_Freq$Agency_Description <- as.character(Agency_Freq$Agency_Description)
Agency_Freq$Percent_Obli <- Percent_Obli*100

#Get top 5 Agencies that take largest percent obligation
Agency_Freq <- Agency_Freq[order(-Percent_Obli),]
Agency_Freq <- Agency_Freq[1:5,]
percent_freq_rest <- 100 - sum(Agency_Freq$Percent_Freq, na.rm = TRUE)
percent_obli_rest <- 100 - sum(Agency_Freq$Percent_Obli, na.rm = TRUE)

Agency_Freq[6,] <- c("All Other", "NA", percent_freq_rest, "All Other", percent_obli_rest)
Agency_Freq$Agency_Description <- factor(Agency_Freq$Agency_Description, levels = rev(Agency_Freq$Agency_Description))
Agency_Freq[,c(3,5)] <- lapply(Agency_Freq[,c(3,5)], function(x) as.numeric(x))
Agency_Freq <- melt(Agency_Freq, id = c("Agency","Count_Freq", "Agency_Description"))

#Build grouped bar plot
Agency_barplot <- ggplot(data = Agency_Freq, 
                         aes(x = Agency_Description, 
                             y=value, 
                             fill=factor(variable))) + 
                  geom_bar(stat = "identity", 
                           position= "dodge", 
                           width = 0.8) + 
                  xlab("") + 
                  ylab("") + 
                  coord_flip() + 
                  theme_grey() +
                  scale_fill_grey(labels = c("% of records", "% of obligation"),
                                  guide = guide_legend(reverse = TRUE)) +
                  theme(legend.title = element_blank(),
                        legend.position = "bottom",
                        legend.margin = margin(t=-0.8, r=0, b=0.5, l=0, unit = "cm"),
                        legend.text = element_text(margin = margin(r=0.5, unit = "cm")),
                        plot.margin = margin(t=0.3, r=0.5, b=0, l=0.5, unit = "cm")) +
                 ggtitle("Top 5 of the most frequently appeared Agency") 
Agency_barplot                  

```

### NAICS examination

#### NAICS2
```{r NAICS2_Summary, fig.width=7.5 , fig.height=3}

# Add NAICS title
#def$NAICS_Code<-create_naics2(def$NAICS)
def$NAICS_Code<-def$NAICS2


def<-csis360::read_and_join(def,
                            lookup_file = "Lookup_NAICS_code.csv",
                            path="",
                            dir="Lookup\\",
                            by="NAICS_Code",
                            skip_check_var="NAICS_DESCRIPTION"
)

def$NAICS2_label<-paste(def$NAICS_Code,
                             def$NAICS_DESCRIPTION)

def$NAICS2_label[
  def$NAICS2_label==
    "56 Administrative and Support and Waste Management and Remediation Services"
  ]<-"56 Admin./Support/Waste Management and Remediation"
def$NAICS2_label[def$NAICS2_label==
                                    "NA NA"]<-"Unlabeled"

def$NAICS2_label<-factor(def$NAICS2_label)
order<-  rev(levels(def$NAICS2_label))


NAICS2digit<-ggplot(def,
       aes(x=NAICS2_label))+
  geom_bar()+coord_flip()+
  scale_y_continuous(label=scales::comma)+scale_x_discrete(limits=order)+
  labs(x="2-Digit NAICS Code",y="Number of Contracts and Task Orders in Unfiltered Dataset")

NAICS2digit
ggsave(NAICS2digit,file="..//Output\\NAICS2digitCount.png",width=10,height=6,dpi=600)
ggsave(NAICS2digit,file="..//Output\\NAICS2digitCount.eps",width=10,height=6,dpi=600)
```


#### NAICS 6

```{r NAICS6_Summary, fig.width=7.5 , fig.height=3}
NAICS_summary<-def %>% group_by(NAICS,StartCY,def6_HHI_lag1,def6_obl_lag1,def6_ratio_lag1,US6_avg_sal_lag1) %>%
  dplyr::summarise(annual_action_obligation=sum(Action.Obligation),
                   annual_count=length(StartCY)) 

top_NAICS <- NAICS_summary %>% group_by(NAICS) %>% 
  dplyr::summarise(naics_action_obligation=sum(annual_action_obligation),
                   naics_count=sum(annual_count)) 
top_NAICS$naics_dollar_rank<-rank(-top_NAICS$naics_action_obligation)
top_NAICS$naics_count_rank<-rank(-top_NAICS$naics_count)


NAICS_summary<-left_join(NAICS_summary,top_NAICS, by="NAICS")

colnames(NAICS_summary)[colnames(NAICS_summary)=="NAICS"]<-"principalnaicscode"

NAICS_summary$principalnaicscode<-as.character(NAICS_summary$principalnaicscode)
NAICS_summary<-as.data.frame(NAICS_summary)

NAICS_summary<-read_and_join(NAICS_summary,
                        lookup_file = "Lookup_PrincipalNAICScode.csv",
                        path="",
                        dir="Lookup\\",
                        by="principalnaicscode",
                        skip_check_var=c("principalnaicscodeText",
"NAICS_shorthand")
               )




summary(NAICS_summary$NAICS_shorthand)

# View(NAICS_summary)
NAICS_summary$NAICS_shorthand<-swr(NAICS_summary$NAICS_shorthand,nwrap = 25)
NAICS_summary$CY<-NAICS_summary$StartCY-1
NAICS6top<-ggplot(subset(NAICS_summary,naics_dollar_rank<=4 |
                          naics_count_rank<=4),
       aes(x=CY,y=def6_HHI_lag1))+#color=NAICS_Code
  geom_line()+
  scale_y_continuous(label=scales::comma)+ 
  # scale_x_continuous(breaks=c(2006,2009,2011,2014))+
  labs(x="Calendar Year",y="Herfindahl-Herschman Index")+ 
  geom_hline(yintercept=c(1500,2500),linetype="dotted")

NAICS6top_paper<-NAICS6top+ facet_wrap(~NAICS_shorthand,ncol=2)
ggsave(NAICS6top_paper,file="..//Output\\NAICS6top.png",width=4,height=8,dpi=600)
ggsave(NAICS6top_paper,file="..//Output\\NAICS6top.eps",width=4,height=8,dpi=600)

NAICS6top_pp<-NAICS6top+ facet_wrap(~NAICS_shorthand,ncol=4)
NAICS6top_pp
ggsave(NAICS6top_pp,file="..//Output\\NAICS6top_pp.png",width=10.5,height=5.5,dpi=600)
ggsave(NAICS6top_pp,file="..//Output\\NAICS6top_pp.eps",width=10.5,height=5.5,dpi=600)

summary(NAICS_summary$naics_count_rank)


NAICS_summary$NAICS_shorthand<-swr(NAICS_summary$NAICS_shorthand,nwrap = 16)
# NAICS_summary$CY<-factor(paste("'",substring(as.character(NAICS_summary$CY),3,4),sep=""))

NAICS6top8<-ggplot(subset(NAICS_summary,naics_dollar_rank<=8),
       aes(x=CY,y=def6_HHI_lag1))+#color=NAICS_Code
  geom_line()+
  scale_y_continuous(label=scales::comma)+ 
  scale_x_continuous(breaks=c(2007,2012))+
  labs(x="Calendar Year",y="Herfindahl-Herschman Index")+ 
  geom_hline(yintercept=c(1500,2500),linetype="dotted")

NAICS6top8_wide<-NAICS6top8+ facet_grid(.~NAICS_shorthand)
ggsave(NAICS6top8_wide,file="..//Output\\NAICS6top8.png",width=9.5,height=4,dpi=600)
ggsave(NAICS6top8_wide,file="..//Output\\NAICS6top8.eps",width=9.5,height=4,dpi=600)


colnames(NAICS_summary)
NAICS_long<-NAICS_summary[,colnames(NAICS_summary) %in% c( "principalnaicscode",
                                                    "def6_HHI_lag1",
                                                    "def6_obl_lag1",
                                                    "def6_ratio_lag1",
                                                    # "US6_avg_sal_lag1",
                                                    "naics_dollar_rank" ,
                                                    "naics_count_rank",
                                                    "principalnaicscodeText",
                                                     "NAICS_shorthand",
                                                    "CY")]
NAICS_long<-melt(NAICS_long, id=c("principalnaicscode","naics_dollar_rank","naics_count_rank","principalnaicscodeText","CY", "NAICS_shorthand"))



#Drop the ratios and average salaries w/ unique values
# NAICS_long<-NAICS_long[NAICS_long$variable %in% c(),]


levels(NAICS_long$variable)<- list("Herfindahl-\nHerschman Index"=c("def6_HHI_lag1"),
                                   "Defense Obligations"=c("def6_obl_lag1"),
                                   "Defense Obligations\nto U.S. Revenue Ratio"=c("def6_ratio_lag1"))

NAICS_long$high<-2500
NAICS_long$high[NAICS_long$variable!="Herfindahl-\nHerschman Index"]<-NA
NAICS_long$low<-1500
NAICS_long$low[NAICS_long$variable!="Herfindahl-\nHerschman Index"]<-NA


NAICS6long<-ggplot(subset(NAICS_long,naics_dollar_rank<=8),
       aes(x=CY,y=value))+#color=NAICS_Code
  geom_line()+
  scale_y_continuous(label=scales::comma)+ 
  scale_x_continuous(breaks=c(2007,2012))+
  labs(x="Calendar Year",y="Detailed Industry Metric")+
  geom_hline(aes(
           yintercept=high),linetype="dotted")+
  geom_hline(aes(
           yintercept=low),linetype="dotted")    



NAICS6long_wide<-NAICS6long+ facet_grid(variable~NAICS_shorthand,scales="free_y")
ggsave(NAICS6long_wide,file="..//Output\\NAICS6long.png",width=9.5,height=5.5,dpi=600)
ggsave(NAICS6long_wide,file="..//Output\\NAICS6long.eps",width=9.5,height=5.5,dpi=600)

write.csv(NAICS_summary,file="..//Output/NAICS6_summary.csv",row.names = FALSE)
```

#### NAICS 3

```{r NAICS3_Summary, fig.width=7.5 , fig.height=3}
NAICS_summary<-def %>% group_by(NAICS3,StartCY,def3_HHI_lag1,def3_obl_lag1,def3_ratio_lag1,US3_avg_sal_lag1) %>%
  dplyr::summarise(annual_action_obligation=sum(Action.Obligation),
                   annual_count=length(StartCY)) 

top_NAICS <- NAICS_summary %>% group_by(NAICS3) %>% 
  dplyr::summarise(naics_action_obligation=sum(annual_action_obligation),
                   naics_count=sum(annual_count)) 
top_NAICS$naics_dollar_rank<-rank(-top_NAICS$naics_action_obligation)
top_NAICS$naics_count_rank<-rank(-top_NAICS$naics_count)


NAICS_summary<-left_join(NAICS_summary,top_NAICS, by="NAICS3")

colnames(NAICS_summary)[colnames(NAICS_summary)=="NAICS3"]<-"principalnaicscode"

NAICS_summary$principalnaicscode<-as.character(NAICS_summary$principalnaicscode)
NAICS_summary<-as.data.frame(NAICS_summary)
NAICS_summary<-csis360::read_and_join(NAICS_summary,
                        lookup_file = "Lookup_PrincipalNAICScode.csv",
                        path="",
                        dir="Lookup\\",
                        by="principalnaicscode",
                        skip_check_var=c("principalnaicscodeText",
"NAICS_shorthand",
"principalNAICS4DigitCode")

               )

# https://stackoverflow.com/questions/37174316/how-to-fit-long-text-into-ggplot2-facet-titles



# Helper function for string wrapping. 
# Default 20 character target width.
swr <- function(string, nwrap=20) {
  paste(strwrap(string, width=nwrap), collapse="\n")
}
swr <- Vectorize(swr)
summary(NAICS_summary$NAICS_shorthand)

# View(NAICS_summary)
NAICS_summary$NAICS_shorthand<-swr(NAICS_summary$NAICS_shorthand,nwrap = 25)
NAICS_summary$CY<-NAICS_summary$StartCY-1
NAICS3top<-ggplot(subset(NAICS_summary,naics_dollar_rank<=4 |
                          naics_count_rank<=4),
       aes(x=CY,y=def3_HHI_lag1))+#color=NAICS_Code
  geom_line()+
  scale_y_continuous(label=scales::comma)+ 
  # scale_x_continuous(breaks=c(2006,2009,2011,2014))+
  labs(x="Calendar Year",y="Herfindahl-Herschman Index")+ 
  geom_hline(yintercept=c(1500,2500),linetype="dotted")

NAICS3top_paper<-NAICS3top+ facet_wrap(~NAICS_shorthand,ncol=2)
ggsave(NAICS3top_paper,file="..//Output\\NAICS3top.png",width=4,height=8,dpi=600)
ggsave(NAICS3top_paper,file="..//Output\\NAICS3top.eps",width=4,height=8,dpi=600)

NAICS3top_pp<-NAICS3top+ facet_wrap(~NAICS_shorthand,ncol=4)
NAICS3top_pp
ggsave(NAICS3top_pp,file="..//Output\\NAICS3top_pp.png",width=10.5,height=5.5,dpi=600)
ggsave(NAICS3top_pp,file="..//Output\\NAICS3top_pp.eps",width=10.5,height=5.5,dpi=600)

summary(NAICS_summary$naics_count_rank)


NAICS_summary$NAICS_shorthand<-swr(NAICS_summary$NAICS_shorthand,nwrap = 16)
# NAICS_summary$CY<-factor(paste("'",substring(as.character(NAICS_summary$CY),3,4),sep=""))

NAICS3top8<-ggplot(subset(NAICS_summary,naics_dollar_rank<=8),
       aes(x=CY,y=def3_HHI_lag1))+#color=NAICS_Code
  geom_line()+
  scale_y_continuous(label=scales::comma)+ 
  scale_x_continuous(breaks=c(2007,2012))+
  labs(x="Calendar Year",y="Herfindahl-Herschman Index")+ 
  geom_hline(yintercept=c(1500,2500),linetype="dotted")

NAICS3top8_wide<-NAICS3top8+ facet_grid(.~NAICS_shorthand)
ggsave(NAICS3top8_wide,file="..//Output\\NAICS3top8.png",width=9.5,height=4,dpi=600)
ggsave(NAICS3top8_wide,file="..//Output\\NAICS3top8.eps",width=9.5,height=4,dpi=600)

colnames(NAICS_summary)
NAICS_long<-NAICS_summary[,colnames(NAICS_summary) %in% c( "principalnaicscode",
                                                    "def3_HHI_lag1",
                                                    "def3_obl_lag1",
                                                    "def3_ratio_lag1",
                                                    # "US3_avg_sal_lag1",
                                                    "naics_dollar_rank" ,
                                                    "naics_count_rank",
                                                    "principalnaicscodeText",
                                                     "NAICS_shorthand",
                                                    "CY")]
NAICS_long<-melt(NAICS_long, id=c("principalnaicscode","naics_dollar_rank","naics_count_rank","principalnaicscodeText","CY", "NAICS_shorthand"))



#Drop the ratios and average salaries w/ unique values
# NAICS_long<-NAICS_long[NAICS_long$variable %in% c(),]


levels(NAICS_long$variable)<- list("Herfindahl-\nHerschman Index"=c("def3_HHI_lag1"),
                                   "Defense Obligations"=c("def3_obl_lag1"),
                                   "Defense Obligations\nto U.S. Revenue Ratio"=c("def3_ratio_lag1"))

NAICS_long$high<-2500
NAICS_long$high[NAICS_long$variable!="Herfindahl-\nHerschman Index"]<-NA
NAICS_long$low<-1500
NAICS_long$low[NAICS_long$variable!="Herfindahl-\nHerschman Index"]<-NA


NAICS3long<-ggplot(subset(NAICS_long,naics_dollar_rank<=8),
       aes(x=CY,y=value))+#color=NAICS_Code
  geom_line()+
  scale_y_continuous(label=scales::comma)+ 
  scale_x_continuous(breaks=c(2007,2012))+
  labs(x="Calendar Year",y="Detailed Industry Metric")+
  geom_hline(aes(
           yintercept=high),linetype="dotted")+
  geom_hline(aes(
           yintercept=low),linetype="dotted")    



NAICS3long_wide<-NAICS3long+ facet_grid(variable~NAICS_shorthand,scales="free_y")
ggsave(NAICS3long_wide,file="..//Output\\NAICS3long.png",width=9.5,height=5.5,dpi=600)
ggsave(NAICS3long_wide,file="..//Output\\NAICS3long.eps",width=9.5,height=5.5,dpi=600)

write.csv(NAICS_summary,file="..//Output/NAICS3_summary.csv",row.names = FALSE)
```



```{r barplot for top 20 most frequently appeared NAICS}
#Prepare dateframe for plot
NAICS_Freq <- as.data.frame(table(def$NAICS))
NAICS_Freq <- NAICS_Freq[order(-NAICS_Freq$Freq),]
NAICS_Freq_TOP20 <- NAICS_Freq[1:20,]   #Get top 20 NAICS has largest frequency count
NAICS_Freq_TOP20$Percent_Freq <- round(NAICS_Freq_TOP20$Freq/sum(NAICS_Freq$Freq),4)*100
colnames(NAICS_Freq_TOP20) <- c("NAICS_Code", "Count_Freq", "Percent_Freq")

#Get detail description for each NAICS code
NAICS_Lookup <- read.csv(file = "Lookup/Lookup_NAICS_code.csv")
colnames(NAICS_Lookup) <- c("NAICS_Code", "NAICS_DESCRIPTION")
NAICS_Freq_TOP20 <- left_join(NAICS_Freq_TOP20, NAICS_Lookup, by = "NAICS_Code")
NAICS_Freq_TOP20 <- NAICS_Freq_TOP20[order(-NAICS_Freq_TOP20$Percent_Freq),]
NAICS_Freq_TOP20$NAICS_DESCRIPTION <- factor(NAICS_Freq_TOP20$NAICS_DESCRIPTION, levels = rev(NAICS_Freq_TOP20$NAICS_DESCRIPTION))


Frequency_Plot <- ggplot(data = NAICS_Freq_TOP20, 
                         aes(x = NAICS_Freq_TOP20$NAICS_DESCRIPTION, 
                             y = NAICS_Freq_TOP20$Percent_Freq)) +
                  geom_bar(stat = "identity", position = "dodge", width = 0.8) + 
                  coord_flip() +
                  xlab("") + 
                  ylab("Percent of Frequency") + 
                  theme_grey() + 
                  scale_fill_grey() + 
                  ggtitle("Top 20 of the most frequently appeared NAICS") +
                  theme(text = element_text(size = 10))
Frequency_Plot
```

```{r grouped barplot for NAICS most frequency appeared/has the largest percent obligation }
# #Percent frequency/obligation grouped bar plot for variable NAICS
# #Prepare dateframe for plot
# NAICS_Freq <- as.data.frame(table(def$NAICS))
# # NAICS_Freq <- NAICS_Freq[order(-NAICS_Freq$Freq),]
# # NAICS_Freq_TOP20 <- NAICS_Freq[1:20,]   #Get top 20 NAICS has largest frequency count
# NAICS_Freq$Percent_Freq <- round(NAICS_Freq$Freq/sum(NAICS_Freq$Freq),4)*100
# colnames(NAICS_Freq) <- c("NAICS_Code", "Count_Freq", "Percent_Freq")
# 
# #Get detail description for each NAICS code
# NAICS_Lookup <- read.csv(file = "Lookup/Lookup_NAICS_code.csv")
# colnames(NAICS_Lookup) <- c("NAICS_Code", "NAICS_DESCRIPTION")
# NAICS_Freq <- left_join(NAICS_Freq, NAICS_Lookup, by = "NAICS_Code")
# NAICS_Freq <- NAICS_Freq[order(-NAICS_Freq$Percent_Freq),]
# NAICS_Freq$NAICS_DESCRIPTION <- factor(NAICS_Freq$NAICS_DESCRIPTION, levels = rev(NAICS_Freq$NAICS_DESCRIPTION))
# 
# Percent_Obli <- c()
# Total_Obli <- sum(def$Action.Obligation, na.rm = TRUE)
# memory.limit(56000)
# for (i in NAICS_Freq$NAICS_Code) {
#   Percent_Obligation <- round(sum(def$Action.Obligation[def$NAICS == i], na.rm = TRUE)/Total_Obli,5)
#   Percent_Obli <- c(Percent_Obli, Percent_Obligation)
#   print(i)
# }
# NAICS_Freq$Percent_Obli <- Percent_Obli*100

#The above code need more than 30 mins to run, so just load RData in practice
load(file = "Data/NAICS_Freq_all.RData")

NAICS_Freq_top10Freq <- NAICS_Freq[order(-NAICS_Freq$Percent_Freq),]
NAICS_Freq_top10Freq <- NAICS_Freq_top10Freq[1:10, ]
NAICS_Freq_top10Obli <- NAICS_Freq[order(-NAICS_Freq$Percent_Obli),]
NAICS_Freq_top10Obli <- NAICS_Freq_top10Obli[1:10, ]

NAICS_Freq_TOP <- rbind( NAICS_Freq_top10Obli, NAICS_Freq_top10Freq)
NAICS_Freq_TOP <- unique(NAICS_Freq_TOP)  #18 records in total
NAICS_Freq_TOP[,c(1,4)] <- lapply(NAICS_Freq_TOP[,c(1,4)], function(x) as.character(x))
NAICS_Freq_TOP$NAICS_DESCRIPTION <- paste(NAICS_Freq_TOP$NAICS_Code, " - ", NAICS_Freq_TOP$NAICS_DESCRIPTION)

NAICS_Freq_TOP$NAICS_DESCRIPTION <- factor(NAICS_Freq_TOP$NAICS_DESCRIPTION, levels = rev(NAICS_Freq_TOP$NAICS_DESCRIPTION))
NAICS_Freq_TOP <- melt(NAICS_Freq_TOP, id = c("NAICS_Code","Count_Freq","NAICS_DESCRIPTION"))
#NAICS_Freq_TOP <- merge(NAICS_Freq_top20Freq, NAICS_Freq_top20Obli, by= "NAICS_Code", all=TRUE)

NAICS_barPlot <- ggplot(data = NAICS_Freq_TOP, 
                         aes(x = NAICS_DESCRIPTION, 
                             y = value,
                             fill = factor(variable))) +
                  geom_bar(stat = "identity", position = "dodge", width = 0.8) + 
                  coord_flip() +
                  xlab("") + 
                  ylab("") + 
                  theme_grey() + 
                  scale_fill_grey(labels = c("% records", "% obligation"),
                                  guide = guide_legend(reverse = TRUE)) + 
                  ggtitle("Top 18 of the most frequently appeared NAICS") +
                  theme(text = element_text(size = 10),
                        legend.title = element_blank(),
                        legend.position = "bottom",
                        legend.margin = margin(t=-0.8, r=0, b=0.5, l=0, unit = "cm"),
                        legend.text = element_text(margin = margin(r=0.5, unit = "cm")),
                        plot.margin = margin(t=0.3, r=0.5, b=0, l=0.5, unit = "cm"))

NAICS_barPlot
```



```{r barplot for all NAICS2, 21 in total}
#Prepare data for plot
NAICS2_Freq <- as.data.frame(table(def$NAICS2))
NAICS2_Freq$Percent_Freq <- round(NAICS2_Freq$Freq/sum(NAICS2_Freq$Freq),4)*100
colnames(NAICS2_Freq) <- c("NAICS_Code", "Count_Freq", "Percent_Freq")

#Get detail description for NAICS2 code
NAICS_Lookup <- read.csv(file = "Lookup/Lookup_NAICS_code.csv")
colnames(NAICS_Lookup) <- c("NAICS_Code", "NAICS_DESCRIPTION")
NAICS2_Freq <- left_join(NAICS2_Freq, NAICS_Lookup, by = "NAICS_Code")
NAICS2_Freq <- NAICS2_Freq[order(-NAICS2_Freq$Percent_Freq),]
NAICS2_Freq$NAICS_DESCRIPTION <- factor(NAICS2_Freq$NAICS_DESCRIPTION, levels = rev(NAICS2_Freq$NAICS_DESCRIPTION))

Frequency_Plot2 <- ggplot(data = NAICS2_Freq,
                          aes(x = NAICS2_Freq$NAICS_DESCRIPTION, 
                              y = NAICS2_Freq$Percent_Freq)) +
                   geom_bar(stat = "identity", position = "dodge", width = 0.8) + 
                   coord_flip() +
                   xlab("") + 
                   ylab("Percent of Frequency") + 
                   theme_grey() + 
                   scale_fill_grey() + 
                   ggtitle("Percent of Frequency for NAICS2") +
                   theme(text = element_text(size = 10))
Frequency_Plot2
```

```{r grouped percent frequency/obligation barplot for all NAICS2, 21 in total}
#Prepare data for plot
NAICS2_Freq <- as.data.frame(table(def$NAICS2))
NAICS2_Freq$Percent_Freq <- round(NAICS2_Freq$Freq/sum(NAICS2_Freq$Freq),4)*100
colnames(NAICS2_Freq) <- c("NAICS_Code", "Count_Freq", "Percent_Freq")

#Get detail description for NAICS2 code
NAICS_Lookup <- read.csv(file = "Lookup/Lookup_NAICS_code.csv")
colnames(NAICS_Lookup) <- c("NAICS_Code", "NAICS_DESCRIPTION")
NAICS2_Freq <- left_join(NAICS2_Freq, NAICS_Lookup, by = "NAICS_Code")

Percent_Obli <- c()
Total_Obli <- sum(def$Action.Obligation, na.rm = TRUE)
for (i in NAICS2_Freq$NAICS_Code) {
  Percent_Obligation <- round(sum(def$Action.Obligation[def$NAICS2 == i], na.rm = TRUE)/Total_Obli,5)
  Percent_Obli <- c(Percent_Obli, Percent_Obligation)
}

NAICS2_Freq$Percent_Obli <- Percent_Obli * 100
NAICS2_Freq <- NAICS2_Freq[order(-NAICS2_Freq$Percent_Obli),]
NAICS2_Freq[,c(1,3)] <- lapply(NAICS2_Freq[,c(1,3)], function(x) as.character(x))
NAICS2_Freq$NAICS_DESCRIPTION <- paste(NAICS2_Freq$NAICS_Code, " - ", NAICS2_Freq$NAICS_DESCRIPTION)
NAICS2_Freq$NAICS_DESCRIPTION <- factor(NAICS2_Freq$NAICS_DESCRIPTION, levels = rev(NAICS2_Freq$NAICS_DESCRIPTION))
NAICS2_Freq <- melt(NAICS2_Freq, id = c("NAICS_Code", "Count_Freq","NAICS_DESCRIPTION"))
NAICS2_Freq$value <- as.numeric(NAICS2_Freq$value)

NAICS2_barplot <- ggplot(data = NAICS2_Freq,
                          aes(x = NAICS_DESCRIPTION, 
                              y = value,
                              fill = factor(variable))) +
                   geom_bar(stat = "identity", 
                            position = "dodge", 
                            width = 0.8) + 
                   coord_flip() +
                   xlab("") + 
                   ylab("") + 
                   theme_grey() + 
                   scale_fill_grey(labels = c("% records", "% obligation"),
                                  guide = guide_legend(reverse = TRUE)) + 
                   ggtitle("Percent of Frequency and obligation for NAICS2") +
                   theme(text = element_text(size = 10), 
                         legend.title = element_blank(),
                         legend.position = "bottom",
                         legend.margin = margin(t=-0.8, r=0, b=0.5, l=0, unit = "cm"),
                         legend.text = element_text(margin = margin(r=0.5, unit = "cm")),
                         plot.margin = margin(t=0.3, r=0.5, b=0, l=0.5, unit = "cm"))
NAICS2_barplot
```

```{r grouped barplot for variable NAICS3}
Frequency <- as.data.frame(table(def$NAICS3))
Frequency[["Percent_Freq"]] <- round(Frequency[["Freq"]]/sum(Frequency[["Freq"]]),4)*100
colnames(Frequency) <- c("NAICS3", "Count_Freq", "Percent_Freq")
Percent_Obli <- c()
for (i in Frequency[["NAICS3"]]) {
  Percent_Obligation <- round(sum(def[["Action.Obligation"]][def$NAICS3 == i], na.rm = TRUE)/sum(def[["Action.Obligation"]], na.rm = TRUE),5)
    Percent_Obli <- c(Percent_Obli, Percent_Obligation)
  }
Frequency[["Percent_Obli"]] <- Percent_Obli*100
NAICS3_Freq <- Frequency

#Add detail description to unique NAICS3 code
NAICS_Lookup <- read.csv(file = "https://raw.githubusercontent.com/CSISdefense/Vendor/master/Lookup/Lookup_NAICS_code.csv")
colnames(NAICS_Lookup) <- c("NAICS3", "Description")
NAICS3_Freq <- left_join(NAICS3_Freq, NAICS_Lookup, by = "NAICS3")
NAICS3_Freq$Description <- as.character(NAICS3_Freq$Description)
NAICS3_Freq$Description <- paste(NAICS3_Freq$NAICS, " - ", NAICS3_Freq$Description)

#Get the top 15 most frequently appeared NAICS3
NAICS3_Freq_top10Freq <- NAICS3_Freq[order(-NAICS3_Freq$Percent_Freq),]
NAICS3_Freq_top10Freq <- NAICS3_Freq_top10Freq[1:10, ]   
NAICS3_Freq_top10Obli <- NAICS3_Freq[order(-NAICS3_Freq$Percent_Obli),]
NAICS3_Freq_top10Obli <- NAICS3_Freq_top10Obli[1:10, ]
NAICS3_Freq_TOP <- rbind(NAICS3_Freq_top10Obli, NAICS3_Freq_top10Freq)
NAICS3_Freq_TOP <- unique(NAICS3_Freq_TOP)  #15 records in total
NAICS3_Freq_TOP <- NAICS3_Freq_TOP[order(-NAICS3_Freq_TOP$Percent_Obli),]
NAICS3_Freq_TOP$Description <- factor(NAICS3_Freq_TOP$Description, rev(NAICS3_Freq_TOP$Description))

#Reshape the dataframe to long format for plot
NAICS3_Freq_TOP <- melt(NAICS3_Freq_TOP, id = c("NAICS3", "Count_Freq", "Description"))

#Generate the plot and add title manually
part_grouped_barplot("NAICS3", NAICS3_Freq_TOP) + ggtitle("Top 15 of the most frequently appeared NAICS3")
```


```{r grouped percent frequency/obligation barplot for all Office}
#grouped bar plot for variable Office
#Perpare data for plot
#get the detailed desceription for Office by AgencyID and OfficeID
Office_Lookup <- read.delim("https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/office/Office.ContractingOfficeCode.txt")
def_dup <- def
memory.limit(56000)
def_dup <- left_join(def_dup, Office_Lookup, by = c("Agency" = "AgencyID", "Office" = "ContractingOfficeCode"))
Office_Freq <- as.data.frame(table(def_dup$Office, def_dup$ContractingOfficeName))
colnames(Office_Freq) <- c("OfficeID", "OfficeName","Count_Freq")
Office_Freq$Percent_Freq <- round(Office_Freq$Count_Freq/sum(Office_Freq$Count_Freq),4)*100
Office_Freq <- subset(Office_Freq, (Office_Freq$Count_Freq != 0)&(Office_Freq$Percent_Freq!=0))
Office_Freq[,1:2] <- lapply(Office_Freq[,1:2], function(x) as.character(x))
Office_Freq$Office_Full <- ifelse(Office_Freq$OfficeName == "NULL", Office_Freq$OfficeID, Office_Freq$OfficeName)


Percent_Obli <- c()
Total_Obli <- sum(def_dup$Action.Obligation, na.rm = TRUE)
for (i in Office_Freq$OfficeID) {
  Percent_Obligation <- round(sum(def_dup$Action.Obligation[def_dup$Office == i], na.rm = TRUE)/Total_Obli,5)
  Percent_Obli <- c(Percent_Obli, Percent_Obligation)
}
Office_Freq$Percent_Obli <- Percent_Obli * 100

Office_Freq_top10Freq <- Office_Freq[order(-Office_Freq$Percent_Freq),]
Office_Freq_top10Freq <- Office_Freq_top10Freq[1:10, ]  #including NULL category
Office_Freq_top10Obli <- Office_Freq[order(-Office_Freq$Percent_Obli),]
Office_Freq_top10Obli <- Office_Freq_top10Obli[1:10, ]  #including NULL category

Office_Freq_TOP <- rbind(Office_Freq_top10Obli, Office_Freq_top10Freq)
Office_Freq_TOP <- unique(Office_Freq_TOP)  #17 records in total

#Generate a new name column by Combining officeID and officeName
Office_Freq_TOP$Office_Full <- ifelse(Office_Freq_TOP$Office_Full == Office_Freq_TOP$OfficeID, 
                                      Office_Freq_TOP$OfficeID, 
                                      paste(Office_Freq_TOP$OfficeID, 
                                            " - ", 
                                            Office_Freq_TOP$OfficeName))

Office_Freq_TOP$Office_Full <- factor(Office_Freq_TOP$Office_Full, 
                                      levels = rev(Office_Freq_TOP$Office_Full))
Office_Freq_TOP <- melt(Office_Freq_TOP, 
                        id = c("OfficeID", "OfficeName", "Count_Freq", "Office_Full"))

Office_barplot <- ggplot(data = Office_Freq_TOP,
                         aes(x = Office_Full, 
                             y = value,
                             fill = factor(variable))) +
                  geom_bar(stat = "identity", 
                  position = "dodge", 
                  width = 0.8) + 
                  coord_flip() +
                  xlab("") + 
                  ylab("") + 
                  theme_grey() + 
                  scale_fill_grey(labels = c("% of records", "% of obligation"),
                                  guide = guide_legend(reverse = TRUE)) + 
                  ggtitle("Percent of Frequency and obligation for Office") +
                  theme(text = element_text(size = 10), 
                        legend.title = element_blank(),
                        legend.position = "bottom",
                        legend.margin = margin(t=-0.8, r=0, b=0.5, l=0, unit = "cm"),
                        legend.text = element_text(margin = margin(r=0.5, unit = "cm")), 
                        plot.margin = margin(t=0.3, r=0.5, b=0, l=0.5, unit = "cm"))
Office_barplot
```


### Platform Portfolio
```{r Platform, fig.width=6.5 , fig.height=3.25}

library(readr)
annual_platform_summary<-read_csv(file="..//Output//annual_platform_summary.csv")
colnames(annual_platform_summary)[colnames(annual_platform_summary)=="platformPortfolio"]<-"PlatformPortfolio"

platform_no_na<-subset(annual_platform_summary,!is.na(PlatformPortfolio))
labels_and_colors<-csis360::prepare_labels_and_colors(platform_no_na,"PlatformPortfolio")



platform_no_na$plat_short <-swr(platform_no_na$PlatformPortfolio,nwrap = 21)
platform_no_na<-subset(platform_no_na,Fiscal.Year>=2000 & Fiscal.Year<=2017)

 

# plat<-ggplot(platform_no_na,
#        aes(x=Fiscal.Year,y=hh_index))+#color=NAICS_Code
#   geom_line()+
#   scale_y_continuous(label=scales::comma)+ 
#   # scale_x_continuous(breaks=c(2006,2009,2011,2014))+
#   labs(x="Fiscal Year",y="Herfindahl-Herschman Index")+ 
#   geom_hline(yintercept=c(1500,2500),linetype="dotted")+
#   facet_wrap(~plat_short)
# add_preassigned_scales(plat,labels_and_colors = labels_and_colors)

# str(platform_no_na)
# summary(platform_no_na$Fiscal.Year)
#
# undebug(add_preassigned_scales)
plat<-build_plot(
  data=platform_no_na,
  chart_geom = "Line Chart",
  share = FALSE,
  x_var="Fiscal.Year",
  y_var="hh_index", #Name of variable to plot on y-axis
  color_var="PlatformPortfolio",       # name of coloration variable, as string
  facet_var="PlatformPortfolio",        # name of facet variable, as string
  legend=FALSE, #Include a legend
  caption=FALSE, #Include a source caption
  labels_and_colors=labels_and_colors,
  column_key=NULL
)


# add_preassigned_scales(plat, labels_and_colors,  var="PlatformPortfolio"

plat<-plat+geom_hline(yintercept=c(1500,2500),linetype="dotted")+
  labs(x="Fiscal Year",y="Herfindahl-Herschman Indetx")
plat
ggsave(plat+geom_line(aes(x=Fiscal.Year,y=hh_index,color=PlatformPortfolio),size=1),filename="..//Output//platform_hhi.png",height=3.25, width=6.5)
ggsave(plat+geom_line(aes(x=Fiscal.Year,y=hh_index)),filename="..//Output//platform_hhi_bw.png",height=3.25, width=6.5)
ggsave(plat+geom_line(aes(x=Fiscal.Year,y=hh_index,color=PlatformPortfolio),size=1),filename="..//Output//platform_hhi.eps",height=3.25, width=6.5)
ggsave(plat+geom_line(aes(x=Fiscal.Year,y=hh_index)),filename="..//Output//platform_hhi_bw.eps",height=3.25, width=6.5)

```

### Variable examination
```{r VarGraph}


HH1plot<-freq_continuous_plot(def,"def6_HHI_lag1",bins=50)
HH1plot<-HH1plot+geom_vline(xintercept=c(1500,2500))+labs(x="Annual Herfindahl-Hirschman Index (HHI) for NAICS-6 Sector",y="Contract or Task Order Count")
HH1plot
ggsave(HH1plot,file="..//Output//HH1freq.png",width=5.5,height=5.5,dpi=600)
ggsave(HH1plot,file="..//Output//HH1freq.eps",width=5.5,height=5.5,dpi=600)

sum(def$Action.Obligation[def$EffComp=="No Comp."],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
sum(def$Action.Obligation[def$EffComp=="1 Offer"],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
sum(def$Action.Obligation[def$EffComp=="2+ Offers"],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
nrow(def[def$EffComp=="No Comp.",])/nrow(def)

sum(def$Action.Obligation[is.na(def$EffComp)],na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)


# Effplot<-freq_discrete_plot(subset(def,"EffComp"))
# Effplot<-Effplot+labs(x="Effective Competition",y="Contract or Task Order Count")
# ggsave(Effplot,file="..//Output//EffFreq.png",width=5.5,height=5.5,dpi=600)

```

### Computational Sample Creation
```{r Sample}

 load(file="../Data/Clean//def_sample.Rdata")
smp$l_Offr<-na_non_positive_log(smp$UnmodifiedNumberOfOffersReceived)
smp1m$l_Offr<-na_non_positive_log(smp1m$UnmodifiedNumberOfOffersReceived)



complete<-
  !is.na(def$b_Term)&
  !is.na(def$b_CBre)&
  !is.na(def$CompOffr)&
  !is.na(def$cl_Offr)&
  !is.na(def$cl_Ceil)&
  !is.na(def$cl_Days)&
  !is.na(def$Veh) &
  !is.na(def$PricingFee)&
  !is.na(def$b_Intl)&
  !is.na(def$b_UCA)&
  !is.na(def$NAICS)&
  !is.na(def$NAICS3)&
  !is.na(def$Office)&
  !is.na(def$Agency)&
  !is.na(def$StartCY)&
  !is.na(def$cl_def3_HHI_lag1)&
  !is.na(def$cl_def3_ratio_lag1)&
  !is.na(def$cl_def6_HHI_lag1)&
  !is.na(def$cl_def6_obl_lag1)&
  !is.na(def$cl_def6_ratio_lag1)&
  !is.na(def$cl_US6_avg_sal_lag1
           )


summary(complete)
money<-def$Action.Obligation
length(money[!complete])/length(money)
sum(money[!complete],na.rm=TRUE)/sum(money,na.rm=TRUE)
# #8818392  to 8818392
# nrow(def[!complete,])/nrow(def)
# sum(def[!complete,]$Action.Obligation,na.rm=TRUE)/sum(def$Action.Obligation,na.rm=TRUE)
# 
# smp<-def[complete,]
# # 
# smp1m<-smp[sample(nrow(smp),1000000),]
# smp<-smp[sample(nrow(smp),250000),]
# save(file="data//def_sample.Rdata",smp,smp1m)
# write.foreign(df=smp,
#               datafile="Data//def_sample250k.dat",
#               codefile="Data//def_sample250k_code.do",
#               package = "Stata")
# write.foreign(df=smp1m,
#               datafile="Data//def_sample1m.dat",
#               codefile="Data//def_sample1m_code.do",
#               package = "Stata")

# levels(smp$Intl)<- list("Just U.S."=c("Just U.S."), 
#                                 "Any Intl."=c("Any International"))
# levels(smp1m$Intl)<- list("Just U.S."=c("Just U.S."), 
#                                 "Any Intl."=c("Any International"))


```



# Loading Models
## Output: Offers

### Consolidation and Number of Offers

```{r Comp-Cons}
load("..//Output//Comp_Cons_15D.rdata")





if(!exists("Comp_Cons_15D"))
   
     Comp_Cons_15D <- lmer (data=smp,
                         l_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                         # cl_US3_avg_sal_lag1+
                         cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                         cl_US6_avg_sal_lag1 + 
                         cl_Ceil+cl_Days+
                         Veh+
                         PricingFee+UCA+
                         b_Intl+
                         b_UCA:cl_def6_HHI_lag1 +
                         # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                         # cl_def6_HHI_lag1:cl_def6_obl_lag1+
                         b_Intl:Veh+
                         # cl_Ceil:PricingFee+
                         # cl_US6_avg_sal_lag1:PricingFee+
                         # b_UCA:cl_Days+
                         # b_UCA:cl_Ceil+
                         (1 | NAICS3/NAICS) + (1 | Agency/Office) + (1 | StartCY),
                         verbose=1)
  
  
  # save(Comp_Cons_15D,file="..//Output//Comp_Cons_15D.rdata")
  
   Comp_Cons_15D_1m <- lmer (data=smp1m,
                         l_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                         # cl_US3_avg_sal_lag1+
                         cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                         cl_US6_avg_sal_lag1 + 
                         cl_Ceil+cl_Days+
                         Veh+
                         PricingFee+UCA+
                         b_Intl+
                         b_UCA:cl_def6_HHI_lag1 +
                         # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                         # cl_def6_HHI_lag1:cl_def6_obl_lag1+
                         b_Intl:Veh+
                         # cl_Ceil:PricingFee+
                         # cl_US6_avg_sal_lag1:PricingFee+
                         # b_UCA:cl_Days+
                         # b_UCA:cl_Ceil+
                         (1 | NAICS3/NAICS) + (1 | Agency/Office) + (1 | StartCY),
                         verbose=1)
   save(Comp_Cons_15D,Comp_Cons_15D_1m,file="..//Output//Comp_Cons_15D.rdata")



stargazer::stargazer(Comp_Cons_15D,Comp_Cons_15D_1m,type="text",
                       digits=2)

#Considering 
write.csv(exp(summary(Comp_Cons_15D_1m)$coefficients[,1])-1,file="..//Output/exp_Comp_Cons_15D_1m.csv")
Comp_Cons_15D_exp<-log_analysis(Comp_Cons_15D)

glmer_examine(Comp_Cons_15D,display=TRUE)
get_icc(Comp_Cons_15D,summary=TRUE)
```
No failure to converge.

## Output: Ceiling Breach
### Consolidation and Ceiling Breaches

```{r CBre-Cons}

# load("..//Output//CBre_Cons_13B.rdata") Missing
load("..//Output//CBre_Cons_13B_1m.rdata")
CBre_Cons_13B_1m.rdata

if(!exists("CBre_Cons_13B_1m")){
  CBre_Cons_13B_1m <- glmer (data=smp1m,
                          b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                            #cl_US3_avg_sal_lag1+
                            cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                            cl_US6_avg_sal_lag1+
                            cl_Ceil + cl_Days+ 
                            Veh +
                            PricingFee + b_UCA +
                            b_Intl+
                            
                            b_UCA:cl_def6_HHI_lag1 + 
                            b_UCA:cl_Ceil+
                            cl_def6_HHI_lag1:cl_def6_obl_lag1+
                            
                            (1 | NAICS3/NAICS) + 
                            (1 | Agency/Office), 
                          
                          family=binomial(link="logit"),
                          verbose=1)
  save(CBre_Cons_13B_1m,#CBre_Cons_13B,CBre_Cons_13B.restart,
       file="..//Output//CBre_Cons_13B_1m.rdata")
}

if(!exists("CBre_Cons_13B_1m_restart")){
  pars<-get_pars(CBre_Cons_13B_1m)
  CBre_Cons_13B_1m_restart <- update(CBre_Cons_13B_1m, 
                                     start=pars,
                                     verbose=1)
  save(CBre_Cons_13B,
       CBre_Cons_13B.restart,
       CBre_Cons_13B_1m,
       CBre_Cons_13B_1m_restart,
       file="..//Output//CBre_Cons_13B.rdata")
}
glmer_examine(CBre_Cons_13B_1m_restart)




save(CBre_Cons_13B,
     CBre_Cons_13B.devfun,
     CBre_Cons_13_scgrad,
     CBre_Cons_13B.restart,
     CBre_Comp_13B,
     CBre_Comp_13B.devfun,
     CBre_Comp_13B.restart,
     file="..//Output//CBre_Cons_13B.rdata")

source(system.file("utils", "allFit.R", package="lme4"))
CBre_Cons_13B.all <- allFit(CBre_Cons_13B)
CBre_Cons_13B_ss_cons <- summary(CBre_Cons_13B.all)





vif(CBre_Cons_13B_1m)
stargazer::stargazer(CBre_Cons_13B,CBre_Cons_13B_1m,type="text",
                       digits=2)

glmer_examine(CBre_Cons_13B.restart,display=TRUE)
odds_ratio(CBre_Cons_13B.restart,"CBre_Cons_13B")

```
"Model failed to converge with max|grad| = 0.00750942 (tol = 0.001, component 1)"


### Competition and Ceiling Breach
```{r CBre-Comp}
load(file="..//Output//CBre_Comp_13C.rdata")

glmer_examine(CBre_Comp_13C)


## Not Done
if(!exists("CBre_Comp_13C")){
  CBre_Comp_13C <- glmer (data=smp,
                          b_CBre ~CompOffr+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                            cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                            cl_Ceil + cl_Days+
                            Veh  +
                            PricingFee+
                            b_UCA +
                            b_Intl+
                            
                            b_UCA:CompOffr +
                            b_UCA:cl_Ceil+
                            
                            (1 | NAICS3/NAICS) + (1 | Agency/Office),
                          family=binomial(link="logit"),
                          verbose=1)
  
   CBre_Comp_13C_1m <- glmer (data=smp1m,
                          b_CBre ~CompOffr+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                            cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                            cl_Ceil + cl_Days+
                            Veh  +
                            PricingFee+
                            b_UCA +
                            b_Intl+
                            
                            b_UCA:CompOffr +
                            b_UCA:cl_Ceil+
                            
                            (1 | NAICS3/NAICS) + (1 | Agency/Office),
                          family=binomial(link="logit"),
                          verbose=1)
  
  save(CBre_Comp_13C,CBre_Comp_13C_1m,file="..//Output//CBre_Comp_13C.rdata")
  stargazer::stargazer(CBre_Comp_13C,CBre_Comp_13C_1m,type="text",
                       digits=2)
}

glmer_examine(CBre_Comp_13C,display=TRUE)
glmer_examine(CBre_Comp_13C_1m,display=TRUE)
odds_ratio(CBre_Comp_13C,"CBre_Comp_13C")

```
"Model failed to converge with max|grad| = 0.0209168 (tol = 0.001, component 1)"
No restart yet.
### Both and Ceiling Breach
```{r CBre-Both}
load("..//Output//CBre_Cons_Comp_15A.rdata")

stargazer::stargazer(CBre_Cons_Comp_15A,type="text",
                       digits=2)
if(!exists("CBre_Cons_Comp_15A")){
  CBre_Cons_Comp_15A <- glmer (data=smp,
                               b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                                 #cl_US3_avg_sal_lag1+
                                 cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                                 cl_US6_avg_sal_lag1+
                                 CompOffr+
                                   cl_Ceil + cl_Days+ 
                                 Veh +
                                 PricingFee + b_UCA +
                                 b_Intl+
                                 
                                 
                                 
                                 b_UCA:CompOffr +
                                 b_UCA:cl_def6_HHI_lag1 + 
                                 b_UCA:cl_Ceil+
                                 cl_def6_HHI_lag1:cl_def6_obl_lag1+
                                 
                                 (1 | NAICS3/NAICS) + 
                                 (1 | Agency/Office) ,
                               family=binomial(link="logit"),
                               verbose=1)
  
  CBre_Cons_Comp_15A_1m <- glmer (data=smp1m,
                               b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                                 #cl_US3_avg_sal_lag1+
                                 cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                                 cl_US6_avg_sal_lag1+
                                 CompOffr+
                                 cl_Ceil + cl_Days+ 
                                 Veh +
                                 PricingFee + b_UCA +
                                 b_Intl+
                                 
                                 
                                 
                                 b_UCA:CompOffr +
                                 b_UCA:cl_def6_HHI_lag1 + 
                                 b_UCA:cl_Ceil+
                                 cl_def6_HHI_lag1:cl_def6_obl_lag1+
                                 
                                 (1 | NAICS3/NAICS) + 
                                 (1 | Agency/Office) ,
                               family=binomial(link="logit"),
                               verbose=1)
  
  save(CBre_Cons_Comp_15A,CBre_Cons_Comp_15A_1m,file="..//Output//CBre_Cons_Comp_15A.rdata")
}


source(system.file("utils", "allFit.R", package="lme4"))
CBre_Cons_Comp_15A_1m.all <- allFit(CBre_Cons_Comp_15A_1m)
CBre_Cons_Comp_15A_1m_ss_cons <- summary(CBre_Cons_Comp_15A_1m.all)


glmer_examine(CBre_Cons_Comp_15A,display=TRUE)
CBre_Cons_Comp_15A_odds_ratio<-odds_ratio(CBre_Cons_Comp_15A,"CBre_Cons_Comp_15A")
get_icc(CBre_Cons_Comp_15A)
```
[1] "Model failed to converge with max|grad| = 0.0395392 (tol = 0.001, component 1)"

failure to converge in 10000 evaluationsModel failed to converge with max|grad| = 0.00901903 (tol = 0.001, component 1)

## Output: Termination

### Consolidation and Termination

```{r Term-Cons}
load("..//Output//Term_Cons_13E.rdata")


if(!exists("Term_Cons_13F")){
  
  Term_Cons_13F <- glmer (data=smp,
                          b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                            #cl_US3_avg_sal_lag1+
                            cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                            cl_US6_avg_sal_lag1+
                            cl_Ceil + cl_Days+ 
                            Veh +
                            PricingFee + b_UCA +
                            b_Intl+
                            
                            # b_UCA:cl_def6_HHI_lag1 + 
                            b_UCA:cl_Ceil+
                            cl_def6_HHI_lag1:cl_def6_obl_lag1+
                            
                               cl_def3_HHI_lag1:cl_def3_ratio_lag1+  
                            (1 | NAICS3/NAICS) + 
                            (1 | Agency/Office), 
                          family=binomial(link="logit"),
                          verbose=1)
  
  
  # save(Term_Cons_13E,file="..//Output//Term_Cons_13E.rdata")
  
   
    Term_Cons_13F_1m <- glmer (data=smp1m,
                          b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                            #cl_US3_avg_sal_lag1+
                            cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                            cl_US6_avg_sal_lag1+
                            cl_Ceil + cl_Days+ 
                            Veh +
                            PricingFee + b_UCA +
                            b_Intl+
                            
                            # b_UCA:cl_def6_HHI_lag1 + 
                            b_UCA:cl_Ceil+
                            cl_def6_HHI_lag1:cl_def6_obl_lag1+
                            
                               cl_def3_HHI_lag1:cl_def3_ratio_lag1+  
                            (1 | NAICS3/NAICS) + 
                            (1 | Agency/Office), 
                          family=binomial(link="logit"),
                          verbose=1)
    
    save(Term_Cons_13E,Term_Cons_13E_1m,file="..//Output//Term_Cons_13E.rdata")
  
}


glmer_examine(Term_Cons_13E,display=TRUE)
odds_ratio(Term_Cons_13E,"Term_Cons_13E")

```

"Model failed to converge with max|grad| = 0.0498057 (tol = 0.001, component 1)"

### Competition and Terminations

```{r Term-Comp}
load(file="..//Output//Term_Comp_13F.rdata")

if(!exists("Term_Comp_13F")){
  Term_Comp_13F <- glmer (data=smp,
                          b_Term ~CompOffr+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                            cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                            cl_Ceil + cl_Days+
                            Veh  +
                            PricingFee+
                            b_UCA +
                            b_Intl+
                            
                            # b_UCA:CompOffr +
                            b_UCA:cl_Ceil+
                            
                            (1 | NAICS3/NAICS) + (1 | Agency/Office),
                          family=binomial(link="logit"),
                          verbose=1)
  
  
summary(Term_Comp_13E_1m)
  
  
    Term_Comp_13F_1m <- glmer (data=smp1m,
                          b_Term ~CompOffr+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                            cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                            cl_Ceil + cl_Days+
                            Veh  +
                            PricingFee+
                            b_UCA +
                            b_Intl+
                            
                            # b_UCA:CompOffr +
                            b_UCA:cl_Ceil+
                            
                            (1 | NAICS3/NAICS) + (1 | Agency/Office),
                          family=binomial(link="logit"),
                          verbose=1)
  
  Term_Comp_13F<-Term_Comp_13E2
  save(Term_Comp_13F,Term_Comp_13F_1m,file="..//Output//Term_Comp_13F.rdata")
}
stargazer::stargazer(Term_Comp_13E,Term_Comp_13F,type="text",
                       digits=2)
glmer_examine(Term_Comp_13E2,display=TRUE)
odds_ratio(Term_Comp_13E2,"Term_Comp_13E2")
```

[1] "Model failed to converge with max|grad| = 0.046442 (tol = 0.001, component 1)"


### Both and Terminations

```{r Both-Term}
load(file="..//Output//Term_Cons_Comp_14C.rdata") 


if(!exists("Term_Cons_Comp_14C_1m")){
# Term_Cons_Comp_14C <- glmer (data=smp,
#                              b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
#                                #cl_US3_avg_sal_lag1+
#                                cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
#                                cl_US6_avg_sal_lag1+
#                                CompOffr+
#                                cl_Ceil + cl_Days+ 
#                                Veh +
#                                PricingFee + b_UCA +
#                                b_Intl+
#                                
#                                # cl_def6_HHI_lag1:cl_Days+
#                                b_UCA:cl_Ceil+
#                                # b_UCA:cl_def6_HHI_lag1 +
#                                # PricingFee:cl_US6_avg_sal_lag1+
#                                cl_def6_HHI_lag1:cl_def6_obl_lag1  +
#                                # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
#                                cl_def3_HHI_lag1:cl_def3_ratio_lag1+  
#                                
#                                (1 | NAICS3/NAICS) + (1 | Agency/Office)
#                              , family=binomial(link="logit"),verbose=1)


Term_Cons_Comp_14C_1m <- glmer (data=smp1m,
                             b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                               #cl_US3_avg_sal_lag1+
                               cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                               cl_US6_avg_sal_lag1+
                               CompOffr+
                               cl_Ceil + cl_Days+ 
                               Veh +
                               PricingFee + b_UCA +
                               b_Intl+
                               
                               # cl_def6_HHI_lag1:cl_Days+
                               # b_UCA:cl_Ceil+
                               # b_UCA:cl_def6_HHI_lag1 +
                               # PricingFee:cl_US6_avg_sal_lag1+
                               cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                               # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                               cl_def3_HHI_lag1:cl_def3_ratio_lag1+  
                               
                               (1 | NAICS3/NAICS) + (1 | Agency/Office)
                             , family=binomial(link="logit"),verbose=1)



  save(Term_Cons_Comp_14B_1m,file="..//Output//Term_Cons_Comp_14B2_1m.rdata")
  source(system.file("utils", "allFit.R", package="lme4"))
Term_Cons_Comp_14B_1m.all <- allFit(Term_Cons_Comp_14B_1m)
Term_Cons_Comp_14B_1m_ss_cons <- summary(Term_Cons_Comp_14B_1m.all)

Term_Cons_Comp_14C_1m <- glmer (data=smp1m,
                             b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                               #cl_US3_avg_sal_lag1+
                               cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                               cl_US6_avg_sal_lag1+
                               CompOffr+
                               cl_Ceil + cl_Days+ 
                               Veh +
                               PricingFee + b_UCA +
                               b_Intl+
                               
                               # cl_def6_HHI_lag1:cl_Days+
                               b_UCA:cl_Ceil+
                               # b_UCA:cl_def6_HHI_lag1 +
                               # PricingFee:cl_US6_avg_sal_lag1+
                               cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                               # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                               cl_def3_HHI_lag1:cl_def3_ratio_lag1+  
                               
                               (1 | NAICS3/NAICS) + (1 | Agency/Office)
                             , family=binomial(link="logit"),verbose=1)

  
  
stargazer::stargazer(Term_Cons_Comp_14B_1m,type="text",
                       digits=2)

# Term_Cons_Comp_14B_1m <- update(Term_Cons_Comp_14B_1m, . ~ . + b_UCA:cl_Ceil - cl_def6_HHI_lag1:cl_Days)

  # save(Term_Cons_Comp_14B_1m,Term_Cons_Comp_14B2_1m,file="..//Output//Term_Cons_Comp_14B_1m.rdata")


  save(Term_Cons_Comp_14C_1m,file="..//Output//Term_Cons_Comp_14C.rdata")
  
}
glmer_examine(Term_Cons_Comp_14C)
odds_ratio(Term_Cons_Comp_14C,"Term_Cons_Comp_14C")
get_icc(Term_Cons_Comp_14C)

```
[1] "Model failed to converge with max|grad| = 0.0782055 (tol = 0.001, component 1)"

# Tables for Paper
## Competition Model
```{r Output-CBre}

# texreg::htmlreg(list(Term_Cons_08A3,
#                   CBre_Cons_08C),#CBre_Cons_08B2
#                 file="..//Output//ConsModel.html",single.row = TRUE,
#                 custom.model.name=c("Termination",
#                                     "Ceiling Breach"),
#                         stars=c(0.05))




texreg::htmlreg(list(Comp_Cons_15D),file="..//Output//Offr_Model.html",
                single.row = TRUE,
                custom.model.name=c("Concentration"),
                        stars=c(0.1,0.05,0.01,0.001),
                groups = list("Study Variables" = 2:3,
                              "NAICS Characteristics" =4:7,
                              "Contract Characteristics"=8:19,
"Interactions" = 20:24),
                custom.coef.map=list("(Intercept)"="(Intercept)",
                "cl_def3_HHI_lag1"="Log(Subsector HHI)",
"cl_def6_HHI_lag1"="Log(Det. Ind. HHI)",
"CompOffr1 offer"="Comp=1 offer",
"CompOffr2 offers"="Comp=2 offers",
"CompOffr3-4 offers"="Comp=3-4 offers",
"CompOffr5+ offers"="Comp=5+ offers",
"cl_def3_ratio_lag1"="Log(Subsector Ratio)",
"cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
"cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
"cl_US6_avg_sal_lag1"="Log(Det. Ind. U.S. Avg. Salary)",
"cl_Ceil"="Log(Init. Ceiling)",
"cl_Days"="Log(Init. Days)",
"VehS-IDC"="Vehicle=S-IDC",
"VehM-IDC"="Vehicle=M-IDC",
"VehFSS/GWAC"="Vehicle=FSS/GWAC",
"VehBPA/BOA"="Vehicle=BPA/BOA",
"PricingFeeOther FP"="Pricing=Other FP",
"PricingFeeIncentive"="Pricing=Incentive Fee",
"PricingFeeCombination or Other"="Pricing=Combination or Other",
"PricingFeeOther CB"="Pricing=Other CB",
"PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
"b_UCA"="UCA",
"b_Intl"="Performed Abroad",
# # "cl_def6_HHI_lag1:cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
# "cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
# # "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)"),
"cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
# "cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
# "CompOffr1 offer:b_UCA"="Comp=1 offer:UCA",
# "CompOffr2 offers:b_UCA"="Comp=2 offers:UCA",
# "CompOffr3-4 offers:b_UCA"="Comp=3-4 offers:UCA",
# "CompOffr5+ offers:b_UCA"="Comp=5+ offers:UCA"
"VehS-IDC:b_Intl"="Vehicle=S-IDC:Performed Abroad",
"VehM-IDC:b_Intl"="Vehicle=M-IDC:Performed Abroad",
"VehFSS/GWAC:b_Intl"="Vehicle=FSS/GWAC:Performed Abroad",
"VehBPA/BOA:b_Intl"="Vehicle=BPA/BOA:Performed Abroad",
"cl_US6_avg_sal_lag1:PricingFeeOther FP"="Pricing=Other FP:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeIncentive"="Pricing=Incentive Fee:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeCombination or Other"="Pricing=Comb./or Other:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeOther CB"="Pricing=Other CB:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE:Log(Det. Ind. U.S. Avg. Salary)"

),
                bold=0.05,
custom.note="%stars. Logged inputs are rescaled. For this model, sole source contracts and task orders are treated as having 1 offer.",
caption="Table 1: Regression Model of Log(Number of Offfers)",
caption.above=TRUE)


texreg::htmlreg(list(Comp_Cons_15D_1m),file="..//Output//Offr_Model_1m.html",
                single.row = TRUE,
                custom.model.name=c("Concentration"),
                        stars=c(0.1,0.05,0.01,0.001),
                groups = list("Study Variables" = 2:3,
                              "NAICS Characteristics" =4:7,
                              "Contract Characteristics"=8:20,
"Interactions" = 21:25),
                custom.coef.map=list("(Intercept)"="(Intercept)",
                "cl_def3_HHI_lag1"="Log(Subsector HHI)",
"cl_def6_HHI_lag1"="Log(Det. Ind. HHI)",
"CompOffr1 offer"="Comp=1 offer",
"CompOffr2 offers"="Comp=2 offers",
"CompOffr3-4 offers"="Comp=3-4 offers",
"CompOffr5+ offers"="Comp=5+ offers",
"cl_def3_ratio_lag1"="Log(Subsector Ratio)",
"cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
"cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
"cl_US6_avg_sal_lag1"="Log(Det. Ind. U.S. Avg. Salary)",
"cl_Ceil"="Log(Init. Ceiling)",
"cl_Days"="Log(Init. Days)",
"VehS-IDC"="Vehicle=S-IDC",
"VehM-IDC"="Vehicle=M-IDC",
"VehFSS/GWAC"="Vehicle=FSS/GWAC",
"VehBPA/BOA"="Vehicle=BPA/BOA",
"PricingFeeOther FP"="Pricing=Other FP",
"PricingFeeIncentive"="Pricing=Incentive Fee",
"PricingFeeCombination or Other"="Pricing=Combination or Other",
"PricingFeeOther CB"="Pricing=Other CB",
"PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
"b_UCA"="UCA",
"UCAUCA"="UCA",
"b_Intl"="Performed Abroad",
# # "cl_def6_HHI_lag1:cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
# "cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
# # "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)"),
"cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
# "cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
# "CompOffr1 offer:b_UCA"="Comp=1 offer:UCA",
# "CompOffr2 offers:b_UCA"="Comp=2 offers:UCA",
# "CompOffr3-4 offers:b_UCA"="Comp=3-4 offers:UCA",
# "CompOffr5+ offers:b_UCA"="Comp=5+ offers:UCA"
"VehS-IDC:b_Intl"="Vehicle=S-IDC:Performed Abroad",
"VehM-IDC:b_Intl"="Vehicle=M-IDC:Performed Abroad",
"VehFSS/GWAC:b_Intl"="Vehicle=FSS/GWAC:Performed Abroad",
"VehBPA/BOA:b_Intl"="Vehicle=BPA/BOA:Performed Abroad",
"cl_US6_avg_sal_lag1:PricingFeeOther FP"="Pricing=Other FP:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeIncentive"="Pricing=Incentive Fee:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeCombination or Other"="Pricing=Comb./or Other:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeOther CB"="Pricing=Other CB:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE:Log(Det. Ind. U.S. Avg. Salary)"

),
                bold=0.05,
custom.note="%stars. Logged inputs are rescaled. For this model, sole source contracts and task orders are treated as having 1 offer.",
caption="Table 1: Regression Model of Log(Number of Offfers)",
caption.above=TRUE)

get_icc(Comp_Cons_15D_1m)


  # OR_m1SD <- exp(fixef(FM_m1SD))
  # CI_m1SD <- exp(confint(FM_m1SD,parm="beta_")) 
  # 
  # OR_p1SD <- exp(fixef(FM_p1SD))
  # CI_p1SD <- exp(confint(FM_p1SD,parm="beta_")) 
  # 
  # OR.CI<-rbind(cbind(OR,CI), cbind(OR_m1SD,CI_m1SD)[3,], cbind(OR_p1SD,CI_p1SD)[3,])
  # rownames(OR.CI)<-c(rownames(cbind(OR,CI)), "teacher_fan_c_m1SD", "teacher_fan_c_p1SD")
  # OR.CI


gridExtra::grid.arrange(dotplot(ranef(Comp_Cons_15D, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             nrow=1)

```

## Ceiling Breach Model
```{r Output-CBre}
stargazer::stargazer(CBre_Cons_13B_1m,CBre_Comp_13C_1m,CBre_Cons_Comp_15A_1m,type="text",
                       digits=2)
# texreg::htmlreg(list(Term_Cons_08A3,
#                   CBre_Cons_08C),#CBre_Cons_08B2
#                 file="..//Output//ConsModel.html",single.row = TRUE,
#                 custom.model.name=c("Termination",
#                                     "Ceiling Breach"),
#                         stars=c(0.05))


# texreg::htmlreg(list(CBre_Cons_13B,CBre_Comp_13C,CBre_Cons_Comp_15A),file="..//Output//CBre_Model.html",single.row = TRUE,
#                 custom.model.name=c("Consolidation",
#                                     "Competition",
#                                     "Both"),
#                         stars=c(0.05,0.01,0.001))


texreg::htmlreg(list(CBre_Cons_13B.restart,CBre_Comp_13C,CBre_Cons_Comp_15A),file="..//Output//CBre_Model.html",
                single.row = TRUE,
                custom.model.name=c("Concentration",
                                    "Competition",
                                    "Both"),
                        stars=c(0.1,0.05,0.01,0.001),
                groups = list("Study Variables" = 2:7,
                              "NAICS Characteristics" = 8:11,
                              "Contract Characteristics"=12:24,
"Interactions" = 25:31),
                custom.coef.map=list("(Intercept)"="(Intercept)",
                "cl_def3_HHI_lag1"="Log(Subsector HHI)",
"cl_def6_HHI_lag1"="Log(Det. Ind. HHI)",
"CompOffr1 offer"="Comp=1 offer",
"CompOffr2 offers"="Comp=2 offers",
"CompOffr3-4 offers"="Comp=3-4 offers",
"CompOffr5+ offers"="Comp=5+ offers",
"cl_def3_ratio_lag1"="Log(Subsector Ratio)",
"cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
"cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
"cl_US6_avg_sal_lag1"="Log(Det. Ind. U.S. Avg. Salary)",
"cl_Ceil"="Log(Init. Ceiling)",
"cl_Days"="Log(Init. Days)",
"VehS-IDC"="Vehicle=S-IDC",
"VehM-IDC"="Vehicle=M-IDC",
"VehFSS/GWAC"="Vehicle=FSS/GWAC",
"VehBPA/BOA"="Vehicle=BPA/BOA",
"PricingFeeOther FP"="Pricing=Other FP",
"PricingFeeIncentive"="Pricing=Incentive Fee",
"PricingFeeCombination or Other"="Pricing=Combination or Other",
"PricingFeeOther CB"="Pricing=Other CB",
"PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
"b_UCA"="UCA",
"b_Intl"="Performed Abroad",
# "cl_def6_HHI_lag1:cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
"cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
# "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)"),
"cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
"cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
"CompOffr1 offer:b_UCA"="Comp=1 offer:UCA",
"CompOffr2 offers:b_UCA"="Comp=2 offers:UCA",
"CompOffr3-4 offers:b_UCA"="Comp=3-4 offers:UCA",
"CompOffr5+ offers:b_UCA"="Comp=5+ offers:UCA"
),
                bold=0.05,
custom.note="%stars. Logged inputs are rescaled.",
caption="Table 2: Logit Model Results for Ceiling Breaches",
caption.above=TRUE)



texreg::htmlreg(list(CBre_Cons_13B_1m,CBre_Comp_13C_1m,CBre_Cons_Comp_15A_1m),file="..//Output//CBre_Model_1m.html",
                single.row = TRUE,
                custom.model.name=c("Concentration",
                                    "Competition",
                                    "Both"),
                        stars=c(0.1,0.05,0.01,0.001),
                groups = list("Study Variables" = 2:7,
                              "NAICS Characteristics" = 8:11,
                              "Contract Characteristics"=12:24,
"Interactions" = 25:31),
                custom.coef.map=list("(Intercept)"="(Intercept)",
                "cl_def3_HHI_lag1"="Log(Subsector HHI)",
"cl_def6_HHI_lag1"="Log(Det. Ind. HHI)",
"CompOffr1 offer"="Comp=1 offer",
"CompOffr2 offers"="Comp=2 offers",
"CompOffr3-4 offers"="Comp=3-4 offers",
"CompOffr5+ offers"="Comp=5+ offers",
"cl_def3_ratio_lag1"="Log(Subsector Ratio)",
"cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
"cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
"cl_US6_avg_sal_lag1"="Log(Det. Ind. U.S. Avg. Salary)",
"cl_Ceil"="Log(Init. Ceiling)",
"cl_Days"="Log(Init. Days)",
"VehS-IDC"="Vehicle=S-IDC",
"VehM-IDC"="Vehicle=M-IDC",
"VehFSS/GWAC"="Vehicle=FSS/GWAC",
"VehBPA/BOA"="Vehicle=BPA/BOA",
"PricingFeeOther FP"="Pricing=Other FP",
"PricingFeeIncentive"="Pricing=Incentive Fee",
"PricingFeeCombination or Other"="Pricing=Combination or Other",
"PricingFeeOther CB"="Pricing=Other CB",
"PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
"b_UCA"="UCA",
"b_Intl"="Performed Abroad",
# "cl_def6_HHI_lag1:cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
"cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
# "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)"),
"cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
"cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
"CompOffr1 offer:b_UCA"="Comp=1 offer:UCA",
"CompOffr2 offers:b_UCA"="Comp=2 offers:UCA",
"CompOffr3-4 offers:b_UCA"="Comp=3-4 offers:UCA",
"CompOffr5+ offers:b_UCA"="Comp=5+ offers:UCA"
),
                bold=0.05,
custom.note="%stars. Logged inputs are rescaled.",
caption="Table 2: Logit Model Results for Ceiling Breaches",
caption.above=TRUE)




or1<-odds_ratio(CBre_Cons_13B.restart,"CBre_Cons_13B","Concentration","Ceiling Breaches")
or2<-odds_ratio(CBre_Comp_13C,"CBre_Comp_13C","Competition","Ceiling Breaches")
or3<-odds_ratio(CBre_Cons_Comp_15A,"CBre_Cons_Comp_15A","Both","Ceiling Breaches")
comp.or<-rbind(or1,or2,or3)

write.csv(get_study_variables_odds_ratio(comp.or),file="..//Output//ceiling_breach_study_odds_ratio.csv",row.names=FALSE)



or1<-odds_ratio(CBre_Cons_13B_1m,"CBre_Cons_13B_1m","Concentration","Ceiling Breaches")
or2<-odds_ratio(CBre_Comp_13C_1m,"CBre_Comp_13C_1m","Competition","Ceiling Breaches")
or3<-odds_ratio(CBre_Cons_Comp_15A_1m,"CBre_Cons_Comp_15A_1m","Both","Ceiling Breaches")
comp.or<-rbind(or1,or2,or3)

write.csv(get_study_variables_odds_ratio(comp.or),file="..//Output//ceiling_breach_study_odds_ratio_1m.csv",row.names=FALSE)
get_icc(CBre_Cons_Comp_15A_1m)

#https://www.lcampanelli.org/mixed-effects-modeling-lme4/
gridExtra::grid.arrange(dotplot(ranef(CBre_Cons_13B.restart, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             dotplot(ranef(CBre_Comp_13C, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             dotplot(ranef(CBre_Cons_Comp_15A, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             nrow=1)


```


## Terminations Model
```{r Output-CBre}

# texreg::htmlreg(list(Term_Cons_08A3,
#                   CBre_Cons_08C),#CBre_Cons_08B2
#                 file="..//Output//ConsModel.html",single.row = TRUE,
#                 custom.model.name=c("Termination",
#                                     "Ceiling Breach"),
#                         stars=c(0.05))



texreg::htmlreg(list(Term_Cons_13E,Term_Comp_13F,Term_Cons_Comp_14C),file="..//Output//Term_Model.html",
                single.row = TRUE,
                custom.model.name=c("Concentration",
                                    "Competition",
                                    "Both"
                ),
                stars=c(0.1,0.05,0.01,0.001),
                groups = list("Study Variables" = 2:7,
                              "NAICS Characteristics" = 8:11,
                              "Contract Characteristics"=12:24,
                              # "Contract Initial Scope" = 12:13,
                              # "Contract Vehicle (Baseline=Def. Award" = 14:18,
                              # "Contract Pricing (Baseline=FFP)" = 19:24,
                              # "Place of Performance" = 25,
                              "Interactions" = 25:27),
                custom.coef.map=list(
                  "(Intercept)"="(Intercept)",
                  
                  "cl_def3_HHI_lag1"="Log(Subsector HHI)",
                  "cl_def6_HHI_lag1"="Log(Det. Ind. HHI)",
                  
                  "CompOffr1 offer"="Comp=1 offer",
                  "CompOffr2 offers"="Comp=2 offers",
                  "CompOffr3-4 offers"="Comp=3-4 offers",
                  "CompOffr5+ offers"="Comp=5+ offers",
                  "cl_def3_ratio_lag1"="Log(Subsector Ratio)",
                  "cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
                  "cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
                  "cl_US6_avg_sal_lag1"="Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_Ceil"="Log(Init. Ceiling)",
                  "cl_Days"="Log(Init. Days)",
                  "VehS-IDC"="Vehicle=S-IDC",
                  "VehM-IDC"="Vehicle=M-IDC",
                  "VehFSS/GWAC"="Vehicle=FSS/GWAC",
                  "VehBPA/BOA"="Vehicle=BPA/BOA",
                  "PricingFeeOther FP"="Pricing=Other FP",
                  "PricingFeeIncentive"="Pricing=Incentive Fee",
                  "PricingFeeCombination or Other"="Pricing=Combination or Other",
                  "PricingFeeOther CB"="Pricing=Other CB",
                  "PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
                  "b_UCA"="UCA",
                  "b_Intl"="Performed Abroad",
                  "cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
                  "cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
                  "cl_def6_HHI_lag1:cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
                  "cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
                  "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)",
                  "cl_def6_HHI_lag1:cl_def6_ratio_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. Ratio)",
                  "cl_US6_avg_sal_lag1:PricingFeeOther FP"="Pricing=Other FP:Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_US6_avg_sal_lag1:PricingFeeIncentive"="Pricing=Incentive Fee:Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_US6_avg_sal_lag1:PricingFeeCombination or Other"=
                    "Pricing=Comb./or Other:Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_US6_avg_sal_lag1:PricingFeeOther CB"="Pricing=Other CB:Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_US6_avg_sal_lag1:PricingFeeT&M/LH/FPLOE"=
                    "Pricing=T&M/LH/FP:LoE:Log(Det. Ind. U.S. Avg. Salary)"
                  
                ),
                bold=0.05,
                custom.note="%stars. Logged inputs are rescaled.",
                caption="Table 3: Logit Model Results for Terminations",
                caption.above=TRUE)

                       #  b_UCA:cl_Ceil+
                       #  b_UCA:cl_def6_HHI_lag1 +
                       # PricingFee:cl_US6_avg_sal_lag1+


# texreg::htmlreg(list(Term_Cons_13E,Term_Comp_13E2,Term_Cons_Comp_14C,Term_Cons_Comp_14C_1m),file="..//Output//Term_Model_1m.html",
#                 single.row = TRUE,
#                 custom.model.name=c("Concentration",
#                                     "Competition",
#                                     "Both",
#                                     "Both 1m"
texreg::htmlreg(list(Term_Cons_13E_1m,Term_Comp_13F_1m,Term_Cons_Comp_14C_1m),file="..//Output//Term_Model_1m.html",
                single.row = TRUE,
                custom.model.name=c("Concentration",
                                    "Competition",
                                    "Both"
                ),
                stars=c(0.1,0.05,0.01,0.001),
                groups = list("Study Variables" = 2:7,
                              "NAICS Characteristics" = 8:11,
                              "Contract Characteristics"=12:24,
                              # "Contract Initial Scope" = 12:13,
                              # "Contract Vehicle (Baseline=Def. Award" = 14:18,
                              # "Contract Pricing (Baseline=FFP)" = 19:24,
                              # "Place of Performance" = 25,
                              "Interactions" = 25:27),
                custom.coef.map=list(
                  "(Intercept)"="(Intercept)",
                  
                  "cl_def3_HHI_lag1"="Log(Subsector HHI)",
                  "cl_def6_HHI_lag1"="Log(Det. Ind. HHI)",
                  
                  "CompOffr1 offer"="Comp=1 offer",
                  "CompOffr2 offers"="Comp=2 offers",
                  "CompOffr3-4 offers"="Comp=3-4 offers",
                  "CompOffr5+ offers"="Comp=5+ offers",
                  "cl_def3_ratio_lag1"="Log(Subsector Ratio)",
                  "cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
                  "cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
                  "cl_US6_avg_sal_lag1"="Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_Ceil"="Log(Init. Ceiling)",
                  "cl_Days"="Log(Init. Days)",
                  "VehS-IDC"="Vehicle=S-IDC",
                  "VehM-IDC"="Vehicle=M-IDC",
                  "VehFSS/GWAC"="Vehicle=FSS/GWAC",
                  "VehBPA/BOA"="Vehicle=BPA/BOA",
                  "PricingFeeOther FP"="Pricing=Other FP",
                  "PricingFeeIncentive"="Pricing=Incentive Fee",
                  "PricingFeeCombination or Other"="Pricing=Combination or Other",
                  "PricingFeeOther CB"="Pricing=Other CB",
                  "PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
                  "b_UCA"="UCA",
                  "b_Intl"="Performed Abroad",
                  "cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
                  "cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
                  "cl_def6_HHI_lag1:cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
                  "cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
                  "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)",
                  "cl_def6_HHI_lag1:cl_def6_ratio_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. Ratio)",
                  "cl_US6_avg_sal_lag1:PricingFeeOther FP"="Pricing=Other FP:Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_US6_avg_sal_lag1:PricingFeeIncentive"="Pricing=Incentive Fee:Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_US6_avg_sal_lag1:PricingFeeCombination or Other"=
                    "Pricing=Comb./or Other:Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_US6_avg_sal_lag1:PricingFeeOther CB"="Pricing=Other CB:Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_US6_avg_sal_lag1:PricingFeeT&M/LH/FPLOE"=
                    "Pricing=T&M/LH/FP:LoE:Log(Det. Ind. U.S. Avg. Salary)"
                  
                ),
                bold=0.05,
                custom.note="%stars. Logged inputs are rescaled.",
                caption="Table 3: Logit Model Results for Terminations",
                caption.above=TRUE)

                       #  b_UCA:cl_Ceil+
                       #  b_UCA:cl_def6_HHI_lag1 +
                       # PricingFee:cl_US6_avg_sal_lag1+


gridExtra::grid.arrange(dotplot(ranef(Term_Cons_13E, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             dotplot(ranef(Term_Comp_13E2, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             dotplot(ranef(Term_Cons_Comp_14A, condVar = T), strip = T, scales=list(relation='free'))$Agency,
             nrow=1)
dotplot(ranef(Term_Cons_13E, condVar = T), strip = T, scales=list(relation='free'))$NAICS3


or1<-odds_ratio(Term_Cons_13E,"Term_Cons_13E","Concentration","Ceiling Breaches")
or2<-odds_ratio(Term_Comp_13E2,"Term_Comp_13E2","Competition","Ceiling Breaches")
or3<-odds_ratio(Term_Cons_Comp_14C,"Term_Cons_Comp_14C","Both","Ceiling Breaches")
term.or<-rbind(or1,or2,or3)

write.csv(get_study_variables_odds_ratio(term.or),file="..//Output//termination_study_odds_ratio.csv",row.names=FALSE)

or1<-odds_ratio(Term_Cons_13E_1m,"Term_Cons_13E_1m","Concentration","Ceiling Breaches")
  or2<-odds_ratio(Term_Comp_13E2,"Term_Comp_13F_1m","Competition","Ceiling Breaches")
or3<-odds_ratio(Term_Cons_Comp_14C_1m,"Term_Cons_Comp_14C_1m","Both","Ceiling Breaches")
term.or<-rbind(or1,or2,or3)

write.csv(get_study_variables_odds_ratio(term.or),file="..//Output//termination_study_odds_ratio_1m.csv",row.names=FALSE)


```

## Consolidation Odds Ratios

```{r Consolidation}
or_ceil<-odds_ratio(CBre_Cons_Comp_15A,"CBre_Cons_Comp_15A","Both","Ceiling Breaches")
or_term<-odds_ratio(Term_Cons_Comp_14B,"Term_Cons_Comp_14B","Both","Terminations")

cons.or<-rbind(or_ceil,or_term)

write.csv(get_study_variables_odds_ratio(subset(cons.or,variable %in% c("cl_def3_HHI_lag1","cl_def6_HHI_lag1"))),
          file="..//Output//consolidation_odds_ratio.csv",row.names=FALSE)


or_ceil<-odds_ratio(CBre_Cons_Comp_15A_1m,"CBre_Cons_Comp_15A_1m","Both","Ceiling Breaches")
or_term<-odds_ratio(Term_Cons_Comp_14C_1m,"Term_Cons_Comp_14C_1m","Both","Terminations")

cons.or<-rbind(or_ceil,or_term)

write.csv(get_study_variables_odds_ratio(subset(cons.or,variable %in% c("cl_def3_HHI_lag1","cl_def6_HHI_lag1"))),
          file="..//Output//consolidation_odds_ratio_1m.csv",row.names=FALSE)


# centered_description(smp1m$def6_HHI_lag1,"subsector HHI score")
# centered_log_description(smp1m$l_def6_HHI_lag1,"detailed industrial HHI score")
# 
# 
# centered_description(smp1m$def3_HHI_lag1,"subsector HHI score")
# centered_log_description(smp1m$l_def3_HHI_lag1,"detailed industrial HHI score")





```

## Competition Odds Ratios
```{r Competition}

or_ceil<-odds_ratio(CBre_Cons_Comp_15A,"CBre_Cons_Comp_15A","Both","Ceiling Breaches")
or_term<-odds_ratio(Term_Cons_Comp_14B,"CBre_Cons_Comp_15A","Both","Terminations")

comp.or<-rbind(or_ceil,or_term)

write.csv(get_study_variables_odds_ratio(subset(comp.or,!variable %in% c("cl_def3_HHI_lag1","cl_def6_HHI_lag1"))),
          file="..//Output//competition_odds_ratio.csv",row.names=FALSE)



or_ceil<-odds_ratio(CBre_Cons_Comp_15A_1m,"CBre_Cons_Comp_15A_1m","Both","Ceiling Breaches")
or_term<-odds_ratio(Term_Cons_Comp_14C_1m,"CBre_Cons_Comp_15A_1m","Both","Terminations")

comp.or<-rbind(or_ceil,or_term)

write.csv(get_study_variables_odds_ratio(subset(comp.or,!variable %in% c("cl_def3_HHI_lag1","cl_def6_HHI_lag1"))),
          file="..//Output//competition_odds_ratio_1m.csv",row.names=FALSE)



# dotplot(ranef(Term_Cons_13E, condVar = T), strip = T, scales=list(relation='free'))$NAICS3
```

## Residuals Plot


```{r Residuals, fig.width=7.5 , fig.height=8.5}

residual_cbre<-gridExtra::grid.arrange(
  binned_fitted_versus_residuals(CBre_Cons_13B.restart,bins=50)+
    labs(title="Concentration Binned Actuals",caption=NULL,
         x="Estimated Pr(Ceiling Breach)",y="Actual Pr(Ceiling Breach)"),
  residuals_plot(CBre_Cons_13B.restart, bins=50)+labs(title="Concentration Binned Residual Plot"),
  binned_fitted_versus_residuals(CBre_Comp_13C,bins=50)+
    labs(title="Competition Binned Actuals Plot",caption=NULL,
         x="Estimated Pr(Ceiling Breach)",y="Actual Pr(Ceiling Breach)"),
residuals_plot(CBre_Comp_13C, bins=50)+labs(title="Competition Binned Residuals Plot"),
binned_fitted_versus_residuals(CBre_Cons_Comp_15A,bins=50)+
  labs(title="Both Binned Actuals",
       caption=NULL,
         x="Estimated Pr(Ceiling Breach)",y="Actual Pr(Ceiling Breach)"),
residuals_plot(CBre_Cons_Comp_15A, bins=50)+labs(title="Both Binned Residuals Plot"),ncol=2)

residual_cbre
ggsave(residual_cbre,file="..//Output//residual_cbre.png",width=7.5, height=8.5)
ggsave(residual_cbre,file="..//Output//residual_cbre.eps",width=7.5, height=8.5)

residual_term<-gridExtra::grid.arrange(
  binned_fitted_versus_residuals(Term_Cons_13E,bins=50)+
    labs(title="Concentration Binned Actuals",caption=NULL,
         x="Estimated Pr(Termination)",y="Actual Pr(Termination)"),
  residuals_plot(Term_Cons_13E, bins=50)+labs(title="Binned Residual Plot"),
  binned_fitted_versus_residuals(Term_Cons_Comp_14B,bins=50)+
    labs(title="Competition Binned Actuals Plot",caption=NULL,
         x="Estimated Pr(Termination)",y="Actual Pr(Termination)"),
residuals_plot(Term_Cons_Comp_14B, bins=50)+labs(title="Binned Residuals Plot"),
binned_fitted_versus_residuals(Term_Cons_Comp_14B,bins=50)+
  labs(title="Both Binned Actuals",
       caption=NULL,
         x="Estimated Pr(Termination)",y="Actual Pr(Termination)"),
residuals_plot(Term_Cons_Comp_14B, bins=50)+labs(title="Binned Residuals Plot"),ncol=2)


residual_term
ggsave(residual_term,file="..//Output//residual_term.png",width=7.5, height=8.5)
ggsave(residual_term,file="..//Output//residual_term.eps",width=7.5, height=8.5)



# debug(residuals_plot)
gridExtra::grid.arrange(residuals_plot(Term_Cons_13E, bins=50)+labs(title="Concentration Binned Residuals Plot"),
residuals_plot(Term_Comp_13E2, bins=50)+labs(title="Competition Binned Residuals Plot"),
residuals_plot(Term_Cons_Comp_14B, bins=50)+labs(title="Both Binned Residuals Plot"),ncol=1)
```


```{r Residuals_250k, fig.width=7.5 , fig.height=8.5}

residual_cbre<-gridExtra::grid.arrange(
  binned_fitted_versus_residuals(CBre_Cons_13B_1m,bins=50)+
    labs(title="Concentration Binned Actuals",caption=NULL,
         x="Estimated Pr(Ceiling Breach)",y="Actual Pr(Ceiling Breach)"),
  residuals_plot(CBre_Cons_13B_1m, bins=50)+labs(title="Concentration Binned Residual Plot"),
  binned_fitted_versus_residuals(CBre_Comp_13C_1m,bins=50)+
    labs(title="Competition Binned Actuals Plot",caption=NULL,
         x="Estimated Pr(Ceiling Breach)",y="Actual Pr(Ceiling Breach)"),
residuals_plot(CBre_Comp_13C_1m, bins=50)+labs(title="Competition Binned Residuals Plot"),
binned_fitted_versus_residuals(CBre_Cons_Comp_15A_1m,bins=50)+
  labs(title="Both Binned Actuals",
       caption=NULL,
         x="Estimated Pr(Ceiling Breach)",y="Actual Pr(Ceiling Breach)"),
residuals_plot(CBre_Cons_Comp_15A_1m, bins=50)+labs(title="Both Binned Residuals Plot"),ncol=2)

residual_cbre
ggsave(residual_cbre,file="..//Output//residual_cbre_1m.png",width=7.5, height=8.5)
ggsave(residual_cbre,file="..//Output//residual_cbre_1m.eps",width=7.5, height=8.5)

residual_term<-gridExtra::grid.arrange(
  binned_fitted_versus_residuals(Term_Cons_13E_1m,bins=50)+
    labs(title="Concentration Binned Actuals",caption=NULL,
         x="Estimated Pr(Termination)",y="Actual Pr(Termination)"),
  residuals_plot(Term_Cons_13E_1m, bins=50)+labs(title="Binned Residual Plot"),
  binned_fitted_versus_residuals(Term_Comp_13F_1m,bins=50)+
    labs(title="Competition Binned Actuals Plot",caption=NULL,
         x="Estimated Pr(Termination)",y="Actual Pr(Termination)"),
residuals_plot(Term_Comp_13F_1m, bins=50)+labs(title="Binned Residuals Plot"),
binned_fitted_versus_residuals(Term_Cons_Comp_14C_1m,bins=50)+
  labs(title="Both Binned Actuals",
       caption=NULL,
         x="Estimated Pr(Termination)",y="Actual Pr(Termination)"),
residuals_plot(Term_Cons_Comp_14C_1m, bins=50)+labs(title="Binned Residuals Plot"),ncol=2)


residual_term
ggsave(residual_term,file="..//Output//residual_term_1m.png",width=7.5, height=8.5)
ggsave(residual_term,file="..//Output//residual_term_1m.eps",width=7.5, height=8.5)


# debug(residuals_plot)
gridExtra::grid.arrange(residuals_plot(Term_Cons_13E, bins=50)+labs(title="Concentration Binned Residuals Plot"),
residuals_plot(Term_Comp_13E2, bins=50)+labs(title="Competition Binned Residuals Plot"),
residuals_plot(Term_Cons_Comp_14B, bins=50)+labs(title="Both Binned Residuals Plot"),ncol=1)
```