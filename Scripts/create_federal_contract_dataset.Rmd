title: "Federal Contract Statistics Model Complete"
author: "Greg Sanders"
date: "Monday, March 23, 2015"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r setup}
#*************************************Required Libraries******************************************
require(dplyr)
require(grid)
require(reshape2)
require(stringr)
require(ggplot2)
library(Hmisc)
library(readr)
library(csis360)
#*************************************Options*****************************************************
options(error=recover)
options(warn=1)

#*************************************Lookup Files*****************************************************

source("ContractCleanup.r")
source("https://raw.githubusercontent.com/CSISdefense/R-scripts-and-data/master/lookups.r")
source("https://raw.githubusercontent.com/CSISdefense/R-scripts-and-data/master/helper.r")
source("https://raw.githubusercontent.com/CSISdefense/Vendor/master/Scripts/DIIGstat.r")

```

#Combining Source Files
##Sample Criteria
```{r DetailCustomer}
memory.limit(32000)
if(!exists("fed_full") & file.exists("..\\data\\clean\\federal_contract_complete_detail.Rdata")){
  load(file="..\\data\\clean\\federal_contract_complete_detail.Rdata")
} else if(!exists("fed_full")) fed_full<-NULL

debug(input_sample_criteria)
#Limit the start years to those completed 2007-2015. Doing this first to get the size down.
fed_full<-input_sample_criteria(fed_full,  
                               dir="..\\data\\semi_clean\\",
                      file="Contract_SP_ContractSampleCriteriaDetailsCustomer.txt",
                      last_date=as.Date("2015-09-30"),
                      drop_incomplete=TRUE)

fed_full<-subset(fed_full, StartFiscal_Year>=2007   &
                   StartFiscal_Year<=2017
)


fed_full<-fed_full[,!colnames(fed_full) %in% 
    c(
      # "StartFiscal_Year",
      # "SumofObligatedAmount",
    # "IsClosed"             ,
    "LastSignedLastDateToOrder",
     "LastUltimateCompletionDate",
    "UnmodifiedLastDateToOrder",
    # "LastCurrentCompletionDate",
    # "MinOfSignedDate",
    # "MinOfEffectiveDate",
"UnmodifiedContractObligatedAmount.1",
"UnmodifiedContractBaseAndExercisedOptionsValue.1",
"UnmodifiedContractBaseAndAllOptionsValue.2"
    )]

save(file="..\\data\\clean\\federal_contract_complete_detail.Rdata",fed_full)


```


##Initial Scope
```{r Scope}
if(!exists("fed_full")) load(file="..\\data\\clean\\federal_contract_complete_detail.Rdata")

fed_full<-csis360::read_and_join_experiment(data=fed_full
  ,"Contract_SP_ContractUnmodifiedAndOutcomeDetailsCustomer.txt"
  ,path=""
  ,"..\\data\\semi_clean\\"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
)

fed_full<-csis360::standardize_variable_names(fed_full)

colnames(fed_full)[colnames(fed_full)=="IsTerminated"]<-"Term"
if(is.numeric(fed_full$Term)){
    fed_full$Term<-factor(fed_full$Term,
                                levels = c(0,1),
                                labels = c("Unterminated", "Terminated")
    )
}


#failed here.
fed_full$UnmodifiedCurrentCompletionDate<-
  as.POSIXct(strptime(fed_full$UnmodifiedCurrentCompletionDate,"%Y-%m-%d"))

#Calculate the number of days the contract lasts.
fed_full$UnmodifiedDays<-as.numeric(
  difftime(strptime(fed_full$UnmodifiedCurrentCompletionDate,"%Y-%m-%d")
    , strptime(fed_full$MinOfEffectiveDate,"%Y-%m-%d")
    , unit="days"
  ))+1


# 
# CDuration<-as.duration(strptime(fed_full$UnmodifiedCurrentCompletionDate,"%Y-%m-%d")-
#                 strptime(fed_full$MinOfEffectiveDate,"%Y-%m-%d"))
# 
# CPeriod<-as.period(
#     CInterval<-new_interval(ymd(fed_full$UnmodifiedCurrentCompletionDate),
#                 ymd(fed_full$MinOfEffectiveDate))
# 
# 
# 
# summary(dYears)


fed_full<-fed_full[,!colnames(fed_full) %in% 
    c(
  #     UnmodifiedDays,
      # UnmodifiedCurrentCompletionDate
      # "MinOfEffectiveDate",
  "LastUltimateCompletionDate"
    )]

save(file="..\\data\\clean\\federal_contract_complete_detail.Rdata",fed_full)
```

## ContractingDelta
```{r ContractingDelta}
if(!exists("fed_full")) load(file="..\\data\\clean\\federal_contract_complete_detail.Rdata")

fed_full<-csis360::read_and_join_experiment(fed_full,
  "contract_SP_ContractModificationDeltaCustomer.txt",
  "",
  "..\\data\\semi_clean\\",
  by="CSIScontractID",
  new_var_checked=FALSE
)

fed_full<-csis360::standardize_variable_names(fed_full)

fed_full$ChangeOrderObligatedAmount<-text_to_number(fed_full$ChangeOrderObligatedAmount)
fed_full$ChangeOrderBaseAndAllOptionsValue<-text_to_number(fed_full$ChangeOrderBaseAndAllOptionsValue)



#Boolean value for ceiling breaches
#Safety measure to make sure we don't assume it's never NA.
fed_full$CBre <- NA
fed_full$CBre[!is.na(fed_full$SumOfisChangeOrder)] <- "None"
fed_full$CBre[fed_full$ChangeOrderBaseAndAllOptionsValue > 0
              & fed_full$SumOfisChangeOrder>0] <- "Ceiling Breach"
fed_full$CBre<-ordered(fed_full$CBre,levels=c("None","Ceiling Breach"))


#                                               min(subset(
#                                                   fed_full$pChangeOrderObligated,
#                                                   fed_full$pChangeOrderObligated>0)),

fed_full<-fed_full[,!colnames(fed_full) %in% 
    c(
    "ChangeOrderObligatedAmount"             ,
    "ChangeOrderBaseAndExercisedOptionsValue",
#     ChangeOrderBaseAndAllOptionsValue      ,
    "NewWorkObligatedAmount",
    "NewWorkBaseAndExercisedOptionsValue"    ,
    # "NewWorkBaseAndAllOptionsValue",
# "SumOfisChangeOrder",
"MaxOfisChangeOrder",
# "SumOfisNewWork"
"MaxOfisNewWork"
    )]

save(file="..\\data\\clean\\federal_contract_complete_detail.Rdata",fed_full)
```
##Location
```{r Location}
if(!exists("fed_full")) load(file="..\\data\\clean\\federal_contract_complete_detail.Rdata")

fed_full<-csis360::read_and_join_experiment(fed_full,
    "Contract_SP_ContractLocationCustomer.txt"
  ,path=""
  ,dir="..\\data\\semi_clean\\"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
  # ,zip_file="Contract_SP_ContractLocationCustomer.zip"
)

fed_full<-csis360::standardize_variable_names(fed_full)



# fed_full$pIsInternational<-
#   as.double(fed_full$ObligatedAmountPlaceIsInternational)/
#   as.double(fed_full$Action.Obligation)
# length(fed_full$pIsInternational[
#   # is.na(fed_full$pIsInternational)&
#     fed_full$PlaceIsInternational==1
# ])<-0
# summary(fed_full$pIsInternational)
# summary(fed_full$PlaceIsInternational)
# summary(subset(fed_full,is.finite(pIsInternational)))
# 
# ggplot(fed_full, aes(x=ObligatedAmountPlaceIsInternational))+geom_histogram()

# summary(fed_full$ObligatedAmountPlaceIsInternational)
# summary(fed_full$PlaceIsInternational)

fed_full$AnyPlaceInternational[is.na(fed_full$PlaceIsInternational) &
    is.na(fed_full$UnmodifiedPlaceIsInternational)]<-NA

summary(fed_full$AnyPlaceInternational)
summary(fed_full$PlaceIsInternational)
summary(fed_full$UnmodifiedPlaceIsInternational)
summary(factor(fed_full$PlaceCountryISO3))
summary(factor(fed_full$UnmodifiedPlaceCountryISO3))


if(is.numeric(fed_full$AnyPlaceInternational)){
  fed_full$AnyPlaceInternational<-factor(fed_full$AnyPlaceInternational,
    exclude=NULL,
    levels=c(0,1,NA),
    labels=c("Just U.S.","Any International",NA)
  )
}

summary(fed_full$AnyPlaceInternational)
fed_full$UnmodifiedPlaceCountryISO3[is.na(fed_full$UnmodifiedPlaceCountryISO3)]<-
  fed_full$PlaceCountryISO3[is.na(fed_full$UnmodifiedPlaceCountryISO3)]
fed_full$UnmodifiedPlaceCountryISO3<-factor(fed_full$UnmodifiedPlaceCountryISO3)


fed_full$PlaceCountryISO3<-as.character(fed_full$PlaceCountryISO3)
fed_full$VendorCountryISO3<-as.character(fed_full$VendorCountryISO3)
fed_full$OriginCountryISO3<-as.character(fed_full$OriginCountryISO3)

fed_full$PlaceCountryISO3[is.na(fed_full$PlaceCountryISO3)&
                            fed_full$PlaceIsInternational==1]<-"*MF"
fed_full$PlaceCountryISO3[is.na(fed_full$PlaceCountryISO3)&
                              fed_full$AnyPlaceInternational %in% c("Any International",1)]<-"*MU"
  
  fed_full$VendorCountryISO3[is.na(fed_full$VendorCountryISO3)&
                              fed_full$VendorIsInternational==1]<-"*MF"
  fed_full$VendorCountryISO3[is.na(fed_full$VendorCountryISO3)&
                              fed_full$AnyVendorInternational %in% c("Any International",1)]<-"*MU"
  
  
  
  fed_full$OriginCountryISO3[is.na(fed_full$OriginCountryISO3)&
                              fed_full$OriginIsInternational==1]<-"*MF"
  fed_full$OriginCountryISO3[is.na(fed_full$OriginCountryISO3)&
                              fed_full$AnyOriginInternational %in% c("Any International",1)]<-"*MU"
  
  
  
  fed_full$PlaceCountryISO3<-factor(fed_full$PlaceCountryISO3)
  fed_full$VendorCountryISO3<-factor(fed_full$VendorCountryISO3)
  fed_full$OriginCountryISO3<-factor(fed_full$OriginCountryISO3)
  
  
  
  
  fed_full<-fed_full[,!colnames(fed_full) %in% 
      c(
    # "PlaceCountryISO3",
  # "UnmodifiedPlaceCountryISO3",
  "ObligatedAmountPlaceIsInternational"     ,
   # "AnyPlaceInternational",
  "PlaceIsInternational"  ,
  "UnmodifiedPlaceIsInternational",
   # "VendorCountryISO3",
  "UnmodifiedVendorCountryISO3" ,
  "ObligatedAmountVendorIsInternational"  ,
   # "AnyVendorInternational",
  "VendorIsInternational",
  "UnmodifiedVendorIsInternational"         ,
   # "OriginCountryISO3",
  "UnmodifiedOriginCountryISO3",
  "ObligatedAmountOriginIsInternational"    ,
   # "AnyOriginInternational",
  "OriginIsInternational",
  "UnmodifiedOriginIsInternational" ,
  "pIsInternational" #This just isn't working
    )]

fed_full$AnyPlaceInternational<-droplevels(fed_full$AnyPlaceInternational)
save(file="..\\data\\clean\\federal_contract_complete_detail.Rdata",fed_full)


```

##FundingAccount
```{r Location}
# load(file="..\\data\\clean\\federal_contract_complete_detail.Rdata")

fed_full<-csis360::read_and_join_experiment(fed_full,
    "Contract_SP_ContractFundingAccount.txt"
  ,path=""
  ,dir="..\\data\\semi_clean\\"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
  # ,zip_file="Contract_SP_ContractFundingAccount.zip"
)

fed_full<-csis360::standardize_variable_names(fed_full)



fed_full$AnySubAccountCode[is.na(fed_full$SubAccountCode) &
    is.na(fed_full$UnmodifiedSubAccountCode)]<-NA

summary(fed_full$AnySubAccountCode)
summary(factor(fed_full$SubAccountCode))
summary(factor(fed_full$UnmodifiedSubAccountCode))

fed_full$UnmodifiedSubAccountCode[is.na(fed_full$UnmodifiedSubAccountCode)]<-
  fed_full$SubAccountCode[is.na(fed_full$UnmodifiedSubAccountCode)]
fed_full$UnmodifiedSubAccountCode<-factor(fed_full$UnmodifiedSubAccountCode)

fed_full$SubAccountCode<-as.character(fed_full$SubAccountCode)
fed_full$MainAccountCode<-as.character(fed_full$MainAccountCode)
fed_full$TreasuryAgencyCode<-as.character(fed_full$TreasuryAgencyCode)

#Label those records with multiple funding accounts
fed_full$SubAccountCode[is.na(fed_full$SubAccountCode)&
                            fed_full$AnySubAccountCode==1]<-"*M"

fed_full$MainAccountCode[is.na(fed_full$MainAccountCode)&
                            fed_full$AnyMainAccountCode==1]<-"*MUL"




fed_full$TreasuryAgencyCode[is.na(fed_full$TreasuryAgencyCode)&
                            fed_full$AnyTreasuryAgencyCode==1]<-"*M"



fed_full$SubAccountCode<-factor(fed_full$SubAccountCode)
fed_full$MainAccountCode<-factor(fed_full$MainAccountCode)
fed_full$TreasuryAgencyCode<-factor(fed_full$TreasuryAgencyCode)
summary(fed_full$SubAccountCode)
summary(fed_full$AnySubAccountCode)
summary(fed_full$MainAccountCode)
summary(fed_full$AnyMainAccountCode)
summary(fed_full$TreasuryAgencyCode)
summary(fed_full$AnyTreasuryAgencyCode)





fed_full<-fed_full[,!colnames(fed_full) %in% 
    c(
  # "SubAccountCode",
  "UnmodifiedSubAccountCode",
  "AnySubAccountCode",
  "AnyUnmodifiedAnySubAccountCode",
   # "MainAccountCode",
  "UnmodifiedMainAccountCode" ,
   "AnyMainAccountCode",
  "AnyUnmodifiedAnyMainAccountCode"         ,
   # "TreasuryAgencyCode",
  "UnmodifiedTreasuryAgencyCode",
   "AnyTreasuryAgencyCode",
  "AnyUnmodifiedTreasuryAgencyCode"
    )]

save(file="..\\data\\clean\\federal_contract_complete_detail.Rdata",fed_full)


```


##BucketPlatform
```{r BucketPlatform}
#Not used in crisis
# # load(file="..\\data\\clean\\federal_contract_complete_detail.Rdata")
# #Note to identify is.defense here.
# fed_full<-csis360::read_and_join_experiment(data=fed_full
#   ,"Contract_SP_ContractBucketPlatformCustomer.txt"
#   ,path=""
#   ,"..\\data\\semi_clean\\"
#   ,by="CSIScontractID"
#   ,new_var_checked=FALSE
# )
# # 
# # fed_full$ObligatedAmountIsProducts<-text_to_number(fed_full$ObligatedAmountIsProducts)
# # 
# # fed_full$ObligatedAmountIsServices<-text_to_number(fed_full$ObligatedAmountIsServices)
# # 
# # fed_full$ObligatedAmountIsRnD<-text_to_number(fed_full$ObligatedAmountIsRnD)
# # 
# # fed_full$pIsProducts <- fed_full$ObligatedAmountIsProducts/fed_full$Action.Obligation
# # fed_full$pIsProducts[is.na(fed_full$ObligatedAmountIsProducts)] <- 0
# # 
# # fed_full$pIsServices <- fed_full$ObligatedAmountIsServices/fed_full$Action.Obligation
# # fed_full$pIsServices[is.na(fed_full$ObligatedAmountIsServices)] <- 0
# # 
# # fed_full$pIsRnD <- fed_full$ObligatedAmountIsRnD/fed_full$Action.Obligation
# # fed_full$pIsRnD[is.na(fed_full$ObligatedAmountIsRnD)] <- 0
# 
# #Need to update these to the new platform portfolios
# # 
# # 
# # fed_full$ObligatedAmountIsLand<-text_to_number(fed_full$ObligatedAmountIsLand)
# # 
# # fed_full$ObligatedAmountIsVessel<-text_to_number(fed_full$ObligatedAmountIsVessel)
# # 
# # 
# # fed_full$ObligatedAmountIsVessel<-text_to_number(fed_full$ObligatedAmountIsAir)
# # 
# # fed_full$ObligatedAmountIsVessel<-text_to_number(fed_full$ObligatedAmountIsOtherPP)
# # 
# # fed_full$ObligatedAmountIsWnA<-text_to_number(fed_full$ObligatedAmountIsWnA)
# # 
# # fed_full$ObligatedAmountIsMnS<-text_to_number(fed_full$ObligatedAmountIsMnS)
# # 
# # fed_full$ObligatedAmountIsEnC<-text_to_number(fed_full$ObligatedAmountIsEnC)
# # 
# # fed_full$ObligatedAmountIsFRSnC<-text_to_number(fed_full$ObligatedAmountIsFRSnC)
# # 
# # 
# # fed_full$pIsLand <- fed_full$ObligatedAmountIsLand/fed_full$Action.Obligation
# # fed_full$pIsLand[is.nan(fed_full$pIsLand)|is.infinite(fed_full$pIsLand)|is.na(fed_full$ObligatedAmountIsLand)] <- 0
# # 
# # fed_full$pIsVessel <- fed_full$ObligatedAmountIsVessel/fed_full$Action.Obligation
# # fed_full$pIsVessel[is.nan(fed_full$pIsVessel)|is.infinite(fed_full$pIsVessel)|is.na(fed_full$ObligatedAmountIsVessel)] <- 0
# # 
# # fed_full$pIsOtherPP <- fed_full$ObligatedAmountIsOtherPP/fed_full$Action.Obligation
# # fed_full$pIsOtherPP[is.nan(fed_full$pIsOtherPP)|is.infinite(fed_full$pIsOtherPP)|is.na(fed_full$ObligatedAmountIsOtherPP)] <- 0
# # 
# # fed_full$pIsAir <- fed_full$ObligatedAmountIsAir/fed_full$Action.Obligation
# # fed_full$pIsAir[is.nan(fed_full$pIsAir)|is.infinite(fed_full$pIsAir)|is.na(fed_full$ObligatedAmountIsAir)] <- 0
# # 
# # fed_full$pIsEnC <- fed_full$ObligatedAmountIsEnC/fed_full$Action.Obligation
# # fed_full$pIsEnC[is.nan(fed_full$pIsEnC)|is.infinite(fed_full$pIsEnC)|is.na(fed_full$ObligatedAmountIsEnC)] <- 0
# # 
# # fed_full$pIsFRSnC <- fed_full$ObligatedAmountIsFRSnC/fed_full$Action.Obligation
# # fed_full$pIsFRSnC[is.nan(fed_full$pIsFRSnC)|is.infinite(fed_full$pIsFRSnC)|is.na(fed_full$ObligatedAmountIsFRSnC)] <- 0
# # 
# # 
# # fed_full$pIsMnS <- fed_full$ObligatedAmountIsMnS/fed_full$Action.Obligation
# # fed_full$pIsMnS[is.nan(fed_full$pIsMnS)|is.infinite(fed_full$pIsMnS)|is.na(fed_full$ObligatedAmountIsMnS)] <- 0
# 
# 
# # TempList<-c("PlatformPortfolio","UnmodifiedPlatformPortfolio","ObligatedAmountIsAir","ObligatedAmountIsEnC","ObligatedAmountIsFRSnC","ObligatedAmountIsLand","ObligatedAmountIsMnS","ObligatedAmountIsOtherPP","ObligatedAmountIsVessel","ObligatedAmountIsWnA","ProductOrServiceArea","UnmodifiedProductOrServiceArea","SimpleArea","UnmodifiedSimpleArea","ObligatedAmountIsProducts","ObligatedAmountIsServices","ObligatedAmountIsRnD","MaxOfIsPossibleSoftwareEngineering")
# 
# # TempList<-TempList[TempList %in% names(fed_full)]
# # fed_full<-subset(fed_full,select=-c(PlatformPortfolio,
# #                                                       UnmodifiedPlatformPortfolio,
# #                                                       SimpleArea,UnmodifiedSimpleArea ))
# 
# NASimpleArea<-(fed_full$SimpleArea=="Mixed or Unlabeled" | is.na(fed_full$SimpleArea))&
#   !is.na(fed_full$UnmodifiedSimpleArea) & fed_full$UnmodifiedSimpleArea!="NULL"
# fed_full$SimpleArea[NASimpleArea]<-fed_full$UnmodifiedSimpleArea[NASimpleArea]
# # fed_full$SimpleArea[fed_full$SimpleArea=="Mixed or Unlabeled" & fed_full$pIsProducts>0.5]<-"Products"
# # fed_full$SimpleArea[fed_full$SimpleArea=="Mixed or Unlabeled" & fed_full$pIsServices>0.5]<-"Services"
# # fed_full$SimpleArea[fed_full$SimpleArea=="Mixed or Unlabeled" & fed_full$pIsRnD>0.5]<-"R&D"
# 
# 
# 
# # fed_full$PlatformPortfolio.sum[fed_full$pIsLand>=0.75&
# #     fed_full$PlatformPortfolio.sum=="Unlabeled"]<-"Land Vehicles"
# # fed_full$PlatformPortfolio.sum[fed_full$pIsVessel>=0.75&
# #     fed_full$PlatformPortfolio.sum=="Unlabeled"]<-"Ships & Submarines"
# # fed_full$PlatformPortfolio.sum[fed_full$pIsAir>=0.75&
# #     fed_full$PlatformPortfolio.sum=="Unlabeled"]<-"Aircraft and Drones"
# # fed_full$PlatformPortfolio.sum[fed_full$pIsOtherPP>=0.75&
# #     fed_full$PlatformPortfolio.sum=="Unlabeled"]<-"Other"
# # fed_full$PlatformPortfolio.sum[fed_full$pIsWnA>=0.75&
# #     fed_full$PlatformPortfolio.sum=="Unlabeled"]<-"Weapons and Ammunition"
# # fed_full$PlatformPortfolio.sum[fed_full$pIsMnS>=0.75&
# #     fed_full$PlatformPortfolio.sum=="Unlabeled"]<-"Missile and Space Systems"
# # fed_full$PlatformPortfolio.sum[fed_full$pIsEnC>=0.75&
# #     fed_full$PlatformPortfolio.sum=="Unlabeled"]<-"Electronics and Communications"
# # fed_full$PlatformPortfolio.sum[fed_full$pIsFRSnC>=0.75&
# #     fed_full$PlatformPortfolio.sum=="Unlabeled"]<-"Facilities and Construction"
# # 
# # fed_full$SoftwareEng<-factor(fed_full$MaxOfIsPossibleSoftwareEngineering,
# #   levels=c(0,1),
# #   labels=c("Not Software Eng.","Possible Software Eng.")
# # )
# # 
# # fed_full$SoftwareEng[is.na(fed_full$SoftwareEng)&
# #     !is.na(fed_full$SimpleArea)]<-"Not Software Eng."
# 
# 
# 
# fed_full$PlatformPortfolio<-factor(fed_full$PlatformPortfolio)
# fed_full$UnmodifiedPlatformPortfolio<-factor(fed_full$UnmodifiedPlatformPortfolio)
# 
# fed_full$ProductOrServiceArea<-factor(fed_full$ProductOrServiceArea)
# fed_full$UnmodifiedProductOrServiceArea<-factor(fed_full$UnmodifiedProductOrServiceArea)
# 
# fed_full$SimpleArea<-factor(fed_full$SimpleArea)
# fed_full$UnmodifiedSimpleArea<-factor(fed_full$UnmodifiedSimpleArea)
# 
# 
# fed_full<-subset(fed_full,select=-c(
#   # UnmodifiedSimpleArea,
#   # SimpleArea,
#   MaxOfIsPossibleSoftwareEngineering
#   # ObligatedAmountIsProducts,
#   # ObligatedAmountIsServices,
#   # ObligatedAmountIsRnD,
#   # ObligatedAmountIsLand,
#   # ObligatedAmountIsVessel,
#   # ObligatedAmountIsOtherPP,
#   # ObligatedAmountIsAir,
#   # ObligatedAmountIsEnC,
#   # ObligatedAmountIsFRSnC,
#   # ObligatedAmountIsMnS,
#   # ObligatedAmountIsWnA
#   
#   
# ))
# 
# 
# 
# 
# 
# fed_full$SimpleArea<-droplevels(fed_full$SimpleArea)
# 
# 
# save(file="..\\data\\clean\\federal_contract_complete_detail.Rdata",fed_full)

```

##Competition Vehicle
```{r CompetitionVehicle}
# load(file="..\\data\\clean\\federal_contract_complete_detail.Rdata")


##Contract_SP_ContractUnmodifiedCompetitionvehicleCustomer.txt
fed_full<-csis360::read_and_join_experiment(data=fed_full
  ,"Contract_SP_ContractUnmodifiedCompetitionvehicleCustomer.txt"
  ,path=""
  ,"..\\data\\semi_clean\\"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
  ,col_types="dddddddccc"
)

#Contract.SP_ContractCompetitionVehicleCustomer.txt
fed_full<-csis360::read_and_join_experiment(data=fed_full
  ,"Contract_SP_ContractCompetitionVehicleCustomer.txt"
  ,path=""
  ,"..\\data\\semi_clean\\"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
  ,col_types="dddddddddccc"
)


#Number of Offers
fed_full$UnmodifiedNumberOfOffersReceived[fed_full$UnmodifiedNumberOfOffersReceived==0]<-NA
fed_full$NumberOfOffersReceived[fed_full$NumberOfOffersReceived==0]<-NA
fed_full$UnmodifiedNumberOfOffersReceived<-text_to_number(fed_full$UnmodifiedNumberOfOffersReceived)
fed_full$NumberOfOffersReceived<-text_to_number(fed_full$NumberOfOffersReceived)
fed_full$UnmodifiedNumberOfOffersReceived[is.null(fed_full$UnmodifiedNumberOfOffersReceived)]<-NA
fed_full$NumberOfOffersReceived[is.null(fed_full$NumberOfOffersReceived)]<-NA

fed_full$UnmodifiedNumberOfOffersReceived<-impute_unmodified(
  fed_full$UnmodifiedNumberOfOffersReceived,
  fed_full$NumberOfOffersReceived
)



#Competition


#IsSomeCompetition Impute missing values when labeled entries have a consistent value.

fed_full$UnmodifiedIsSomeCompetition<-impute_unmodified(
  fed_full$UnmodifiedIsSomeCompetition,
  fed_full$IsSomeCompetition
)


#Set is some competion = 1 when it is blank and there are multiple offers

fed_full$UnmodifiedIsSomeCompetition[is.na(fed_full$UnmodifiedIsSomeCompetition)&
    !is.na(fed_full$UnmodifiedNumberOfOffersReceived)&
    fed_full$UnmodifiedNumberOfOffersReceived>1
  ]<-1



fed_full$UnmodifiedNumberOfOffersReceived[is.na(fed_full$UnmodifiedNumberOfOffersReceived)&
    !is.na(fed_full$UnmodifiedIsSomeCompetition)&
    fed_full$UnmodifiedIsSomeCompetition==0
  ]<-1


#Produce Comp factor
fed_full$Comp[fed_full$UnmodifiedIsSomeCompetition==0]<-"No Comp."
# fed_full$Comp[fed_full$UnmodifiedIsSomeCompetition=="Comp." &
#                            fed_full$UnmodifiedIsFullAndOpen=="Not Full & Open"]<-"Comp."
# fed_full$Comp[fed_full$UnmodifiedIsSomeCompetition=="Comp." &
#                            fed_full$UnmodifiedIsFullAndOpen=="Comp."]<-"Comp."
fed_full$Comp[fed_full$UnmodifiedIsSomeCompetition==1]<-"Comp."

fed_full$Comp<-factor(fed_full$Comp,
                               levels=c("No Comp.","Comp.")
                                                              )


#Produce EffComp factor

#Competition and Offer  
fed_full$EffComp<-as.character(fed_full$Comp)

fed_full$EffComp[fed_full$Comp=="Comp." & !is.na(fed_full$Comp)]<-
  ifelse(fed_full$UnmodifiedNumberOfOffersReceived[
    fed_full$Comp=="Comp." & !is.na(fed_full$Comp)]>1,"2+ Offers","1 Offer")

fed_full$EffComp<-factor(fed_full$EffComp,
                               levels=c("No Comp.","1 Offer","2+ Offers")
                               )


#Impute missing urgency values
fed_full$UnmodifiedIsUrgency<-impute_unmodified(
  fed_full$UnmodifiedIsUrgency,
  fed_full$IsUrgency
)
#If there's competition, than the urgency exception wasn't used
fed_full$UnmodifiedIsUrgency[is.na(fed_full$UnmodifiedIsUrgency)&
                               !is.na(fed_full$UnmodifiedIsSomeCompetition)&
                               fed_full$UnmodifiedIsSomeCompetition==1]<-0


fed_full$Urg[fed_full$UnmodifiedIsUrgency==0]<-"Not Urgency"
fed_full$Urg[fed_full$UnmodifiedIsUrgency==1]<-"Urgency Except."
fed_full$Urg<-factor(fed_full$Urg,
                               levels=c("Not Urgency","Urgency Except.")
                               )

#Vehicle
#Award_Type_Code Impute missing values when labeled entries have a consistent value.
fed_full$unmodifiedaward_type_code<-impute_unmodified(
  fed_full$unmodifiedaward_type_code,
  fed_full$Award_Type_Code
)

#idv_type_code Impute missing values when labeled entries have a consistent value.
fed_full$unmodifiedidv_type_code<-impute_unmodified(
  fed_full$unmodifiedidv_type_code,
  fed_full$IDV_Type_Code
)


#Unmodifiedmultipleorsingleawardidc Impute missing values when labeled entries have a consistent value.
fed_full$Unmodifiedmultipleorsingleawardidc<-impute_unmodified(
  fed_full$Unmodifiedmultipleorsingleawardidc,
  fed_full$multipleorsingleawardidc
)

#Assign Is IDV
#A = BPA Call, C = Delivery Order
fed_full$IsIDV[!is.na(fed_full$unmodifiedaward_type_code) &
                               fed_full$unmodifiedaward_type_code %in% c("A","C")]<-1
#B = Purchase Order, D = Definitive Contract
fed_full$IsIDV[!is.na(fed_full$unmodifiedaward_type_code) &
                               fed_full$unmodifiedaward_type_code %in% c("B","D")]<-0
fed_full$IsIDV[!is.na(fed_full$unmodifiedidv_type_code)]<-1

if(is.numeric(fed_full$IsIDV)){
  fed_full$IsIDV<-factor(fed_full$IsIDV,levels=c(0,1),labels=c("Def/Pur","IDV"))
}


#Simple Vehicle, which consolidates IDV and award types
fed_full$Veh[
  !is.na(fed_full$unmodifiedaward_type_code) &
    fed_full$unmodifiedaward_type_code %in% c("B","D")]<-"Def/Pur"


fed_full$Veh[
  !is.na(fed_full$unmodifiedidv_type_code) &
    fed_full$unmodifiedidv_type_code %in% c("B") &
    !is.na(fed_full$Unmodifiedmultipleorsingleawardidc)]<-
  paste(fed_full$Unmodifiedmultipleorsingleawardidc[
     !is.na(fed_full$unmodifiedidv_type_code) &
    fed_full$unmodifiedidv_type_code %in% c("B") &
    !is.na(fed_full$Unmodifiedmultipleorsingleawardidc)
  ],"IDC")

#IDV_type_Code D = BOA, E=BPA, Award_Type_code A=BPA Call
fed_full$Veh[
  !is.na(fed_full$unmodifiedidv_type_code) &
    fed_full$unmodifiedidv_type_code %in% c("D","E") |
  !is.na(fed_full$unmodifiedaward_type_code) &
    fed_full$unmodifiedaward_type_code %in% c("A") 
    ]<-
  "BPA/BOA"
#IDV_type_cde A=GWAC C=FSS
fed_full$Veh[
  !is.na(fed_full$unmodifiedidv_type_code)
  & fed_full$unmodifiedidv_type_code 
  %in% c('A','C')]<-"FSS/GWAC"

#Imputing that when Multiple Award/Single Award is known, but IDV_type_code is not
#that the vehicle type is an IDC
fed_full$Veh[
  is.na(fed_full$Veh)&
  is.na(fed_full$unmodifiedidv_type_code) &
    !is.na(fed_full$Unmodifiedmultipleorsingleawardidc)]<-
  paste(fed_full$Unmodifiedmultipleorsingleawardidc[
  is.na(fed_full$Veh)&
  is.na(fed_full$unmodifiedidv_type_code) &
    !is.na(fed_full$Unmodifiedmultipleorsingleawardidc)],"IDC")

fed_full$Veh<-factor(fed_full$Veh)
summary(fed_full$Veh)
#Imputing that when the simple vehicle is a kind of IDV, IsIDV should follow as well
fed_full$IsIDV[
  is.na(fed_full$IsIDV)&
    fed_full$Veh %in% c(
      'BPA/BOA','FSS/GWAC','MULTIPLE AWARD IDC','SINGLE AWARD IDC'
    )]<-"IDV"





fed_full<-fed_full[,!colnames(fed_full) %in% 
    c(
  #     UnmodifiedIsFullAndOpen,
  # "UnmodifiedIsOnlyOneSource",
  "UnmodifiedIsFollowonToCompetedAction",
      "Unmodifiedmultipleorsingleawardidc",
        # "UnmodifiedIsUrgency",
      "Unmodifiedaddmultipleorsingawardidc",
  # "IsFullAndOpen",
  # IsOnlyOneSource 
  # "IsFollowonToCompetedAction"
    "IsUrgency",
      "multipleorsingleawardidc",
      "AddMultipleOrSingleAwardIDC",
  "Award_Type_Code",
  "unmodifiedaward_type_code",
  "IDV_Type_Code",
  # "UnmodifiedNumberOfOffersReceived",
  "unmodifiedidv_type_code",
  "NumberOfOffersReceived"
)]
str(fed_full)
  
save(file="..\\data\\clean\\federal_contract_complete_detail.Rdata",fed_full)

```


##Pricing
```{r Pricing}
# load(file="..\\data\\clean\\federal_contract_complete_detail.Rdata")

fed_full<-csis360::read_and_join_experiment(data=fed_full
  ,"Contract_SP_ContractPricingCustomer.txt"
  ,path=""
  ,"..\\data\\semi_clean\\"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
  ,create_lookup_rdata = TRUE
)

#Process Fixed Or Cost
fed_full$pIsFixedPrice<-percent_obligated(fed_full,
                                          "ObligatedAmountIsFixedPrice",
                                            "Action.Obligation",
                                          "UnmodifiedIsFixedPrice",
                                          "IsFixedPrice")

fed_full$pIsCostBased<-percent_obligated(fed_full,
                                          "ObligatedAmountIsCostBased",
                                            "Action.Obligation",
                                          "UnmodifiedIsCostBased",
                                          "IsCostBased")


fed_full$pIsCombination<-percent_obligated(fed_full,
                                          "ObligatedAmountIsCombination",
                                            "Action.Obligation",
                                          "UnmodifiedIsCombination",
                                          "IsCombination")



fed_full$pIsOtherFee<-percent_obligated(fed_full,
                                          "ObligatedAmountIsOtherFee",
                                            "Action.Obligation",
                                          "UnmodifiedIsOtherFee",
                                          "IsOtherFee")


#Assign FxCb
fed_full$FxCb[fed_full$pIsFixedPrice>0  |
    fed_full$pIsCostBased>0 | 
    fed_full$pIsCombination>0 | 
      fed_full$pIsOtherFee>0]<-"Combination or Other"

fed_full$FxCb[fed_full$pIsFixedPrice>=0.95|(fed_full$IsFixedPrice==1 & (fed_full$pIsCombination<=0.05 | is.na(fed_full$pIsCombination)))]<-"Fixed-Price"
fed_full$FxCb[fed_full$pIsCostBased>=0.95|(fed_full$IsCostBased==1 & (fed_full$pIsCombination<=0.05 | is.na(fed_full$pIsCombination)))]<-"Cost-Based"
fed_full$FxCb<-factor(fed_full$FxCb,levels=c("Fixed-Price","Cost-Based","Combination or Other"))
#Process Fee

View(subset(fed_full,is.na(FxCb) & !is.na(FxCb)))
fed_full$pIsIncentive<-percent_obligated(fed_full,
                                          "ObligatedAmountIsIncentive",
                                            "Action.Obligation",
                                          "UnmodifiedIsIncentive",
                                          "IsIncentive")


fed_full$pIsAwardFee<-percent_obligated(fed_full,
                                          "ObligatedAmountIsAwardFee",
                                            "Action.Obligation",
                                          "UnmodifiedIsAwardFee",
                                          "IsAwardFee")



fed_full$pIsFFPorNoFee<-percent_obligated(fed_full,
                                          "ObligatedAmountIsFFPorNoFee",
                                            "Action.Obligation",
                                          "UnmodifiedIsFFPorNoFee",
                                          "IsFFPorNoFee")


fed_full$pIsFixedFee<-percent_obligated(fed_full,
                                          "ObligatedAmountIsFixedFee",
                                            "Action.Obligation",
                                          "UnmodifiedIsFixedFee",
                                          "IsFixedFee")




#AssignFee

fed_full$Fee[fed_full$pIsAwardFee>0  |
    fed_full$pIsIncentive>0 | 
    fed_full$pIsFFPorNoFee>0 |
      fed_full$pIsFixedFee>0 |
      fed_full$pIsOtherFee>0 |
      fed_full$pIsCombination>0]<-"Combination"

fed_full$Fee[fed_full$pIsAwardFee>=0.9|(fed_full$IsAwardFee==1
  & (fed_full$pIsCombination<=0.05 | is.na(fed_full$pIsCombination))) ]<-"Award Fee"
fed_full$Fee[fed_full$pIsIncentive>=0.9|(fed_full$IsIncentive==1
  & (fed_full$pIsCombination<=0.05 | is.na(fed_full$pIsCombination)))]<-"Incentive"
fed_full$Fee[fed_full$pIsFFPorNoFee>=0.9|(fed_full$IsFFPorNoFee==1
  & (fed_full$pIsCombination<=0.05 | is.na(fed_full$pIsCombination)))]<-"FFP or No Fee"
fed_full$Fee[fed_full$pIsFixedFee>=0.9|(fed_full$IsFixedFee==1
  & (fed_full$pIsCombination<=0.05 | is.na(fed_full$pIsCombination)))]<-"Fixed Fee"
fed_full$Fee[fed_full$pIsOtherFee>=0.9|(fed_full$IsOtherFee==1
  & (fed_full$pIsCombination<=0.05 | is.na(fed_full$pIsCombination)))]<-"Other Fee"


fed_full$Fee<-ordered(fed_full$Fee,
  levels=c("Incentive","Fixed Fee","Award Fee",
    "FFP or No Fee","Other Fee","Combination"))


summary(fed_full$Fee)
summary(fed_full$FxCb)
#Undefinitized Contract Awards
# fed_full$Veh[fed_full$AwardOrIDVcontractActionType == "Letter Contract"]<-"Letter"
# fed_full$Veh[fed_full$AwardOrIDVcontractActionType %in%
#     c("Indefinite Delivery Contract",
#       "Delivery Order")]<-
#   as.character(fed_full$multipleorsingleawardidc[fed_full$AwardOrIDVcontractActionType %in%
#       c("Indefinite Delivery Contract",
#         "Delivery Order")])


fed_full<-csis360::read_and_join_experiment(data=fed_full
  ,"Contract_SP_ContractPricingUCA.txt"
  ,path=""
  ,"..\\data\\semi_clean\\"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
  ,create_lookup_rdata = TRUE
)



#Imput UCA unmodified values when consistent for the remainder of the vehicle
fed_full$UCA<-fed_full$UnmodifiedIsUCA
fed_full$UCA[is.na(fed_full$UnmodifiedIsUCA)&
  !is.na(fed_full$IsUCA)]<-
  fed_full$IsUCA[is.na(fed_full$UnmodifiedIsUCA)&
  !is.na(fed_full$IsUCA)]


fed_full$UCA<-factor(fed_full$UnmodifiedIsUCA,
  levels=c(0,1),
  labels=c("Not UCA","UCA")
)

summary(fed_full$UCA)

#Imputing to make up for absence of 
#There's no obligations in the dataset to UCAs using the regulated vehicle of FSS/GWAC
fed_full$UCA[is.na(fed_full$UCA)&
               fed_full$Veh=="FSS/GWAC"]<-"Not UCA"

summary(fed_full$UCA)

summary(factor(fed_full$UnmodifiedTypeOfContractPricing))


fed_full$UnmodifiedTypeOfContractPricing[is.na(fed_full$UnmodifiedTypeOfContractPricing)&
  !is.na(fed_full$TypeOfContractPricing)]<-
  fed_full$TypeOfContractPricing[is.na(fed_full$UnmodifiedTypeOfContractPricing)&
  !is.na(fed_full$TypeOfContractPricing)]

fed_full$UnmodifiedTypeOfContractPricing   <-factor(fed_full$UnmodifiedTypeOfContractPricing)

summary(fed_full$UCA)
fed_full<-fed_full[,!colnames(fed_full) %in% 
    c(
  'Pricing.Mechanism.Code',
  "UnmodifiedTypeOfContractPricing",
  "IsLabeledPricing",
  "ObligatedAmountIsFixedPrice",
  "IsFixedPrice",
  "UnmodifiedIsFixedPrice",
  "ObligatedAmountIsCostBased",
  "IsCostBased",
  "UnmodifiedIsCostBased",
  "ObligatedAmountIsCombination",
  "IsCombination",
  "UnmodifiedIsCombination",
  "ObligatedAmountIsIncentive",
  "IsIncentive",
  "UnmodifiedIsIncentive",
  "ObligatedAmountIsAwardFee",
  "IsAwardFee",
  "UnmodifiedIsAwardFee",
  "ObligatedAmountIsFFPorNoFee",
  "IsFFPorNoFee",
  "UnmodifiedIsFFPorNoFee",
  "ObligatedAmountIsFixedFee",
  "IsFixedFee",
  "UnmodifiedIsFixedFee",
  "ObligatedAmountIsOtherFee",
  "IsOtherFee",
  "UnmodifiedIsOtherFee",
  "pIsFixedPrice",
  "pIsCostBased",
  "pIsCombination",
  "pIsIncentive",
  "pIsAwardFee",
  "pIsFFPorNoFee",
  "pIsFixedFee",
  "pIsOtherFee",
  # FxCb,
  # Fee,
  "UnmodifiedIsUCA",
  "IsUCA",
  # "UnmodifiedTypeOfContractPricing",
  "TypeOfContractPricing"
    )]

str(fed_full)

save(file="..\\data\\clean\\federal_contract_complete_detail.Rdata",fed_full)
```

## Top PSC Office NAICS
```{r TopPSCofficeNAICS}
# load(file="..\\data\\clean\\federal_contract_complete_detail.Rdata")
fed_full<-plyr::join(fed_full,test)
test<-read_delim("..\\data\\semi_clean\\Contract.SP_ContractTopPSCofficeNAICS.txt",delim="\t",
                 na=c("NA","NULL"),
                 col_types="icdcdcdcd")
                   # c(col_integer(),
                   #   col_character(),
                   #   col_double(),
                   #   col_character(),
                   #   col_double(),
                   #   col_character(),
                   #   col_double(),
                   #   col_character(),
                   #   col_double()))
fed_full<-csis360::read_and_join_experiment(data=fed_full
  ,"Contract_SP_ContractTopPSCofficeNAICS.txt"
  ,path=""
  ,"..\\data\\semi_clean\\"
  ,by="CSIScontractID"
  ,col_types="icdcdcdcd"
  ,new_var_checked=FALSE
)

fed_full$topContractingOfficeAgencyID<-factor(
  fed_full$topContractingOfficeAgencyID
)
fed_full$topContractingOfficeID<-factor(
  fed_full$topContractingOfficeID
)
fed_full$topProductOrServiceCode<-factor(
  fed_full$topProductOrServiceCode
)
fed_full$topPrincipalNAICScode<-factor(
  fed_full$topPrincipalNAICScode
)

fed_full$topProductOrServiceCode[fed_full$topProductOrServiceCode==""]<-NA
fed_full<-fed_full[,!colnames(fed_full) %in% 
    c(
      # "topContractingOfficeAgencyID",
      "topContractingOfficeAgencyIDamount"      ,
      # "topContractingOfficeID",
      "topContractingOfficeAmount"  ,
      # "topProductOrServiceCode",
      "topProductOrServiceAmount"               ,
      # "topPrincipalNAICScode",
      "topPrincipalNAICSamount")]
# load(file="..\\data\\clean\\federal_contract_complete_detail.Rdata")
save(file="..\\data\\clean\\federal_contract_complete_detail.Rdata",fed_full)

```

## Decision Tree
```{r DecisionTree}
# load(file="..\\data\\clean\\federal_contract_complete_detail.Rdata")

fed_full<-csis360::read_and_join_experiment(data=fed_full,
    lookup_file="Contract_SP_ContractBudgetDecisionTree.txt",
  path="",
  directory = "Data/",
  by="CSIScontractID",
  new_var_checked=FALSE
)

# fed<-decision_tree(fed)


fed_full$DisastertransactionGrossObligated<-as.numeric(fed_full$DisastertransactionGrossObligated)
  # fed_full$DisastertransactionGrossObligated[!is.na(fed_full$DisastertransactionGrossObligated) &
  #                                        is.na(as.numeric(fed_full$DisastertransactionGrossObligated))]


#Limit sample to those contracts/task orders with any money obligated (even if deobligated later).
nrow(fed_full[fed_full$GrossObligatedAmount==0 | is.na(fed_full$GrossObligatedAmount),]) #266960
fed_full<-subset(fed_full,!is.na(GrossObligatedAmount) &
                   GrossObligatedAmount>0)

fed_full$OCOstep4grossObligated[is.na(fed_full$OCOstep4grossObligated)]<-0

fed_full$ARRAtransactionGrossObligated[is.na(fed_full$ARRAtransactionGrossObligated)]<-0
fed_full$OCOtransactionGrossObligated[is.na(fed_full$OCOtransactionGrossObligated)]<-0
fed_full$DisastertransactionGrossObligated[is.na(fed_full$DisastertransactionGrossObligated)]<-0
fed_full$ExcludedtransactionGrossObligated[is.na(fed_full$ExcludedtransactionGrossObligated)]<-0

#Counting Ties
nrow(fed_full[
  fed_full$ARRAtransactionGrossObligated==fed_full$OCOstep4grossObligated &
    fed_full$ARRAtransactionGrossObligated>0 
  ,])#0
nrow(fed_full[
    fed_full$OCOstep4grossObligated==fed_full$DisastertransactionGrossObligated  & 
      fed_full$OCOstep4grossObligated>0
    ,])#3
nrow(fed_full[
    fed_full$ARRAtransactionGrossObligated==fed_full$DisastertransactionGrossObligated & 
      fed_full$ARRAtransactionGrossObligated>0
              ,])#0
# View(fed_full[
#     fed_full$OCOstep4grossObligated==fed_full$DisastertransactionGrossObligated  & 
#       fed_full$OCOstep4grossObligated>0
#     ,])

#Assigning uncontroversial.
fed_full$Crisis<-NA
fed_full$Crisis[fed_full$ARRAtransactionGrossObligated==
                     fed_full$GrossObligatedAmount&
                     is.na(fed_full$Crisis)
                   ]<-"ARRA"
fed_full$Crisis[fed_full$OCOtransactionGrossObligated==
                     fed_full$GrossObligatedAmount&
                     is.na(fed_full$Crisis)]<-"OCO"
fed_full$Crisis[fed_full$DisastertransactionGrossObligated==
                     fed_full$GrossObligatedAmount&
                     is.na(fed_full$Crisis)]<-"Disaster"

fed_full$Crisis[fed_full$ExcludedtransactionGrossObligated==
                     fed_full$GrossObligatedAmount & 
                     is.na(fed_full$Crisis)]<-"Excluded"

summary(factor(fed_full$Crisis))

nrow(fed_full[ (fed_full$ARRAtransactionGrossObligated>0  |
    fed_full$DisastertransactionGrossObligated> 0 | 
      fed_full$OCOtransactionGrossObligated>0) & is.na(fed_full$Crisis)
              ,])#17138

length(which(fed_full$ARRAtransactionGrossObligated>0))
fed_full$Crisis[
  fed_full$ARRAtransactionGrossObligated>=
    fed_full$GrossObligatedAmount/2&
    fed_full$ARRAtransactionGrossObligated>fed_full$OCOstep4grossObligated&
    fed_full$ARRAtransactionGrossObligated>fed_full$DisastertransactionGrossObligated&
    is.na(fed_full$Crisis)
  ]<-"ARRA"

length(which(fed_full$DisastertransactionGrossObligated>0))
fed_full$Crisis[
  fed_full$DisastertransactionGrossObligated>=
    fed_full$GrossObligatedAmount/2&
    fed_full$DisastertransactionGrossObligated>fed_full$OCOstep4grossObligated&
    fed_full$DisastertransactionGrossObligated>fed_full$ARRAtransactionGrossObligated&
    is.na(fed_full$Crisis)
  ]<-"Disaster"

length(which(fed_full$OCOtransactionGrossObligated>0))
fed_full$Crisis[
  fed_full$OCOtransactionGrossObligated>=
    fed_full$GrossObligatedAmount/2&
    fed_full$OCOtransactionGrossObligated>=fed_full$DisastertransactionGrossObligated&
    fed_full$OCOtransactionGrossObligated>=fed_full$ARRAtransactionGrossObligated&
    is.na(fed_full$Crisis)
  ]<-"OCO"

length(which(fed_full$ExcludedtransactionGrossObligated>0))
fed_full$Crisis[
  fed_full$ExcludedtransactionGrossObligated>=
    fed_full$GrossObligatedAmount/2&
    fed_full$ExcludedtransactionGrossObligated>fed_full$OCOtransactionGrossObligated&
    is.na(fed_full$Crisis)
  ]<-"Excluded"

nrow(fed_full[fed_full$ARRAtransactionGrossObligated>0 & is.na(fed_full$Crisis),])
nrow(fed_full[fed_full$DisastertransactionGrossObligated>0 & is.na(fed_full$Crisis),])
nrow(fed_full[fed_full$OCOtransactionGrossObligated>0 & is.na(fed_full$Crisis),])

fed_full<-fed_full[,!colnames(fed_full) %in% 
    c(
   "ARRAstep4grossObligated",#Drop
   "OCOstep4grossObligated",
  "Disasterstep4GrossObligated",#Drop
  "ExcludedStep4GrossObligated",#Drop

#  "ARRAtransactionGrossObligated",
#  "OCOtransactionGrossObligated",
# "DisastertransactionGrossObligated",
   "ExcludedtransactionGrossObligated" ,

   "pscOCOcrisisMeanPercent", #Drop
   "FundingAccountOCOmeanPercent",#Drop
   "OfficeOCOcrisisMeanPercent",#Drop
  # "GrossObligatedAmount" 
"MinOfDecisionTree",
"MaxOfDecisionTree",
"MinOfDecisionTreeStep4",
"MaxOfDecisionTreeStep4"
)]

save(file="..\\data\\clean\\federal_contract_complete_detail.Rdata",fed_full)

```

#Final Cleanup and Output
##Applying lookups
```{r PostApply}
load(file="..\\data\\clean\\federal_contract_complete_detail.Rdata")
fed_full<-transition_variable_names_common(fed_full)
# debug(apply_lookups)


fed_full<-apply_lookups(Path,fed_full)


# fed_full<-csis360::read_and_join(
#   fed_full,
#   "Lookup_SubCustomer.csv",
#   by=c("Customer","SubCustomer"),
#   # replace_na_var=NULL,
#   # overlap_var_replaced=TRUE,
#   add_var="SubCustomer.sum"
#   # new_var_checked=TRUE,
#   # skip_check_var="CHPKisCrisisFunding"
#   )

# fed_full$SubCustomer.sum<-factor(fed_full$SubCustomer.sum)
# fed_full$SubCustomer.sum<-droplevels(fed_full$SubCustomer.sum)
# fed_full$SubCustomer.sum<-droplevels(fed_full$SubCustomer.sum)


# fed_full<-csis360::read_and_join(
#   fed_full,
#   "LOOKUP_PlatformPortfolio.csv",
#   by="PlatformPortfolio",
#   # replace_na_var=NULL,
#   # overlap_var_replaced=TRUE,
#   add_var="PlatformPortfolio.sum"
#   # new_var_checked=TRUE,
#   # skip_check_var="CHPKisCrisisFunding"
#   )
# fed_full$PlatformPortfolio.sum<-factor(fed_full$PlatformPortfolio.sum)



save(file="..\\data\\clean\\federal_contract_complete_detail.Rdata",fed_full)
# fed_full<-rename_dataset(fed_full)

```
##Minimal Dataset Output

```{r DatasetOutput}
load(file="..\\data\\clean\\federal_contract_complete_detail.Rdata")
fed<-rename_dataset(fed_full)
rm(fed_full)
fed<-trim_dataset(fed)


#    
# write.table(fed
#   ,file=paste("..\\data\\Federal_contract_CSIScontractID_detail.csv"
#     ,sep=""
#   )
#   #   ,header=TRUE
#   , sep=","
#   , row.names=FALSE
#   , append=FALSE
# )


# summary(fed$Agency[fed$Who=="Uncategorized"])
# def<-fed[fed$Who!="Civilian",]
 save(fed,file="..\\data\\clean\\federal_contract_complete.rdata")
  


```

##Transformed Dataset Output 
```{r transform}
load(file="..\\data\\clean\\federal_contract_complete.rdata")
# undebug(transform_contract)
# debug(transform_contract)
# debug(deflate)
memory.limit(36000)
fed<-transform_contract(fed)


#Customer isn't added in transform_contract as most of our datasets are just DoD
 fed<-read_and_join_experiment(fed,
                                   "Agency_AgencyID.csv",
                                   by=c("Agency"="AgencyID"),
                               path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                               dir="",
                               add_var = "Customer")

contract_transform_verify(fed,dollars_suffix="OMB20_GDP18")

 save(fed,file="..\\data\\clean\\fed_transformed.rdata")
```