---
title: "Defense Contract Statistics Model Complete"
author: "Greg Sanders"
date: "Monday, March 23, 2015"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r Setup}
#*************************************Required Libraries******************************************
require(dplyr)
require(grid)
require(reshape2)
require(stringr)
require(ggplot2)
library(Hmisc)
library(readr)
library(csis360)
#*************************************Options*****************************************************
options(error=recover)
options(warn=1)

#*************************************Lookup Files*****************************************************

Path<-"https://github.com/CSISdefense/R-scripts-and-data/blob/master/"
# Path<-"K:\\2007-01 PROFESSIONAL SERVICES\\R scripts and data\\"
# Path<-"~\\FPDS\\R scripts and data\\"
# Path<-"C:\\Users\\Greg Sanders\\SkyDrive\\Documents\\R Scripts and Data SkyDrive\\"
source("DIIGstat.r")
source("https://raw.githubusercontent.com/CSISdefense/Crisis-Funding/master/Scripts/ContractCleanup.r")
source("https://raw.githubusercontent.com/CSISdefense/R-scripts-and-data/master/lookups.r")
source("https://raw.githubusercontent.com/CSISdefense/R-scripts-and-data/master/helper.r")

```

#Combining Source Files
##Sample Criteria
```{r DetailCustomer}
# if(!exists("def_all")) load(file="..\\data\\clean\\defense_contract_all_detail.Rdata")

if(!exists("def_all")) def_all<-NULL
# debug(input_sample_criteria)
def_all<-input_sample_criteria(def_all,  
                               dir="..\\data\\semi_clean\\",
                      file="Defense_Contract.SP_ContractSampleCriteriaDetailsCustomer.txt",
                      last_date=as.Date("2017-12-31"),
                      drop_incomplete=FALSE)

def_all<-def_all %>% filter(StartFiscal_Year<2018 & StartFiscal_Year>=2007 & Customer=="Defense")
  
#I'm intending to eventually incorporate this into sample criteria
#Although maybe it's faster to keep it as a tiny stand alone file.
def_all<-read_and_join_experiment(def_all,
                                         "Contract.IsParentContractID.txt",
                                         by="CSIScontractID",
                                         # replace_na_var="AgencyID",
                                         add_var=c("IsParentCSIScontractID"),
                                  skip_check_var = "IsParentCSIScontractID",
                                         path ="", 
                                  directory = "..\\data\\semi_clean\\"
)
summary(def_all$IsParentCSIScontractID)

save(file="..\\data\\clean\\defense_contract_all_detail.Rdata",def_all)

```



## Top PSC Office NAICS
```{r TopPSCofficeNAICS}
if(!exists("def_all")) load(file="..\\data\\clean\\defense_contract_all_detail.Rdata")
def_all<-input_contract_psc_office_naics(def_all,        
                                         file="Contract.SP_ContractTopPSCofficeNAICS.txt")


if(!"Customer" %in% colnames(data))
  debug(read_and_join_experiment)
  def_all<-read_and_join_experiment(def_all,
                                    "Agency_AgencyID.csv",
                                    by=c("topContractingOfficeAgencyID"="AgencyID"),
                                    # replace_na_var="AgencyID",
                                    add_var=c("Customer","SubCustomer"),
                                    skip_check_var = "SubCustomer",
                                    path = "https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                                    directory = ""
  )
# def_all<- subset(def_all,Customer=="Defense")
save(file="..\\data\\clean\\defense_contract_all_detail.Rdata",def_all)

summary(factor(def_all$topContractingOfficeAgencyID))
summary(factor(def_all$topPrincipalNAICScode))

summary(factor(def_all$StartFiscal_Year[is.na(def_all$topContractingOfficeAgencyID)]))
summary(factor(def_all$StartFiscal_Year))

```


##Initial Scope
```{r Scope}
if(!exists("def_all")) load(file="..\\data\\clean\\defense_contract_all_detail.Rdata")
# undebug(input_initial_scope)
memory.limit(56000)
def_all<-input_initial_scope(def_all,
                             file="Contract.SP_ContractUnmodifiedScope.txt")


save(file="..\\data\\clean\\defense_contract_all_detail.Rdata",def_all)
```

## Ceiling Breaches

```{r CeilingBreaches}
if(!exists("def_all")) load(file="..\\data\\clean\\defense_contract_all_detail.Rdata")
# debug(read_and_join_experiment)
def_all<-input_contract_ceiling_breach(def_all,
             file="Contract.SP_ContractCeilingBreachCustomer.txt")


sumcheck<-abs(def_all$UnmodifiedCeiling+
  def_all$ChangeOrderCeilingGrowth+
  def_all$ChangeOrderCeilingRescision+
    def_all$AdminCeilingModification+
    def_all$EndingCeilingModification+
    def_all$OtherCeilingModification+
    def_all$SteadyScopeCeilingModification-
    def_all$ContractBaseAndAllOptionsValue)>1

if(any(sumcheck)){
  write.csv(file="..\\output\\ceiling_breach_sumcheck_failures.csv",
    def_all[sumcheck,] %>% dplyr::select(CSIScontractID,
                               UnmodifiedCeiling,
                               ChangeOrderCeilingGrowth,
                               ChangeOrderCeilingRescision,
                               AdminCeilingModification,
                               EndingCeilingModification,
                               SteadyScopeCeilingModification,
                               OtherCeilingModification,
                               ContractBaseAndAllOptionsValue)
  )
  if(any(sumcheck&def_all$UnmodifiedCeiling>0))
    stop("Ceiling Modification Checksum failure.")
  else warning("Checksum failure for entries with na unmodified")
}
rm(sumcheck)


def_all$n_CBre <- def_all$ChangeOrderCeilingGrowth +
  ifelse(def_all$SteadyScopeCeilingModification+def_all$AdminCeilingModification<0,
         def_all$SteadyScopeCeilingModification+def_all$AdminCeilingModification,0)
def_all$n_CBre[def_all$n_CBre<=0 & def_all$ChangeOrderCeilingGrowth>0]<-NA
def_all$n_CBre[def_all$ChangeOrderCeilingGrowth==0]<-0
summary(def_all$n_CBre)



save(file="..\\data\\clean\\defense_contract_all_detail.Rdata",def_all)
```

# Split between def_all and def_detail
```{r Split}
if(!exists("def_all")) load(file="..\\data\\clean\\defense_contract_all_detail.Rdata")
def_detail<-def_all
rm(def_all)

def_detail<-def_detail %>% dplyr::filter(is.na(IsParentCSIScontractID) | IsParentCSIScontractID==0)

save(file="..\\data\\clean\\defense_contract_complete_detail.Rdata",def_detail)

```

##Location
```{r Location}
# load(file="..\\data\\clean\\defense_contract_complete_detail.Rdata")

#Drop contracts starting before the study period and not clearly end within it
def_detail<-def_detail %>% filter(IsComplete==1)
#   subset(def_detail, StartFY>=2007   & year(MinOfSignedDate)<2017 & 
#     (LastCurrentCompletionDate<"2017-01-01" | IsClosed==1)
# )

# load(file="..\\data\\clean\\defense_contract_complete_detail.Rdata")
def_detail<-read_and_join_experiment(def_detail,
    "Contract.SP_ContractLocationCustomer.txt"
  ,path="../"
  ,dir="data/semi_clean/"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
  # ,zip_file="Contract.SP_ContractLocationCustomer.zip"
)


def_detail<-standardize_variable_names(def_detail)



# def_detail$pIsInternational<-
#   as.double(def_detail$ObligatedAmountPlaceIsInternational)/
#   as.double(def_detail$Action_Obligation)
# length(def_detail$pIsInternational[
#   # is.na(def_detail$pIsInternational)&
#     def_detail$PlaceIsInternational==1
# ])<-0
# summary(def_detail$pIsInternational)
# summary(def_detail$PlaceIsInternational)
# summary(subset(def_detail,is.finite(pIsInternational)))
# 
# ggplot(def_detail, aes(x=ObligatedAmountPlaceIsInternational))+geom_histogram()

# summary(def_detail$ObligatedAmountPlaceIsInternational)
# summary(def_detail$PlaceIsInternational)

def_detail$AnyPlaceInternational[is.na(def_detail$PlaceIsInternational) &
    is.na(def_detail$UnmodifiedPlaceIsInternational)]<-NA

summary(def_detail$AnyPlaceInternational)
summary(def_detail$PlaceIsInternational)
summary(def_detail$UnmodifiedPlaceIsInternational)
summary(factor(def_detail$PlaceCountryISO3))
summary(factor(def_detail$UnmodifiedPlaceCountryISO3))


if(is.numeric(def_detail$AnyPlaceInternational)){
  def_detail$AnyPlaceInternational<-factor(def_detail$AnyPlaceInternational,
    exclude=NULL,
    levels=c(0,1,NA),
    labels=c("Just U.S.","Any International",NA)
  )
}

summary(def_detail$AnyPlaceInternational)
def_detail$UnmodifiedPlaceCountryISO3[is.na(def_detail$UnmodifiedPlaceCountryISO3)]<-
  def_detail$PlaceCountryISO3[is.na(def_detail$UnmodifiedPlaceCountryISO3)]
def_detail$UnmodifiedPlaceCountryISO3<-factor(def_detail$UnmodifiedPlaceCountryISO3)


def_detail$AnyPlaceInternational<-droplevels(def_detail$AnyPlaceInternational)

def_detail<-def_detail[,!colnames(def_detail) %in% 
    c(
  # "PlaceCountryISO3",
  # "UnmodifiedPlaceCountryISO3",
  "ObligatedAmountPlaceIsInternational"     ,
   # "AnyPlaceInternational",
  "PlaceIsInternational"  ,
  "UnmodifiedPlaceIsInternational",
   "VendorCountryISO3",
  "UnmodifiedVendorCountryISO3" ,
  "ObligatedAmountVendorIsInternational"  ,
   "AnyVendorInternational",
  "VendorIsInternational",
  "UnmodifiedVendorIsInternational"         ,
   "OriginCountryISO3",
  "UnmodifiedOriginCountryISO3",
  "ObligatedAmountOriginIsInternational"    ,
   "AnyOriginInternational",
  "OriginIsInternational",
  "UnmodifiedOriginIsInternational" ,
  "pIsInternational" #This just isn't working
    )]


save(file="..\\data\\clean\\defense_contract_complete_detail.Rdata",def_detail)


```
  




##Competition Vehicle
```{r CompetitionVehicle}
# load(file="..\\data\\clean\\defense_contract_complete_detail.Rdata")


##Contract_SP_ContractUnmodifiedCompetitionvehicleCustomer.txt
def_detail<-read_and_join_experiment(data=def_detail
  ,"Contract.SP_ContractUnmodifiedCompetitionvehicleCustomer.txt"
  ,path="../"
  ,dir="data/semi_clean/"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
)

#Contract.SP_ContractCompetitionVehicleCustomer.txt
def_detail<-read_and_join_experiment(data=def_detail
  ,"Contract.SP_ContractCompetitionVehicleCustomer.txt"
  ,path="../"
  ,dir="data/semi_clean/"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
)


#Number of Offers
def_detail$UnmodifiedNumberOfOffersReceived[def_detail$UnmodifiedNumberOfOffersReceived==0]<-NA
def_detail$NumberOfOffersReceived[def_detail$NumberOfOffersReceived==0]<-NA
def_detail$UnmodifiedNumberOfOffersReceived<-FactorToNumber(def_detail$UnmodifiedNumberOfOffersReceived)
def_detail$NumberOfOffersReceived<-FactorToNumber(def_detail$NumberOfOffersReceived)
def_detail$UnmodifiedNumberOfOffersReceived[is.null(def_detail$UnmodifiedNumberOfOffersReceived)]<-NA
def_detail$NumberOfOffersReceived[is.null(def_detail$NumberOfOffersReceived)]<-NA

def_detail$UnmodifiedNumberOfOffersReceived<-impute_unmodified(
  def_detail$UnmodifiedNumberOfOffersReceived,
  def_detail$NumberOfOffersReceived
)

def_detail$Offr <- cut2(def_detail$UnmodifiedNumberOfOffersReceived,cuts=c(1,2,3,5))



if (all(levels(def_detail$Offr)==c("  1","  2","[  3,  5)","[  5,999]"))){
  def_detail$Offr<-factor(def_detail$Offr, 
    levels=c("  1","  2","[  3,  5)","[  5,999]"),
    labels=c("1","2","3-4","5+"),
    ordered=TRUE
  )
}




#Competition


#IsSomeCompetition Impute missing values when labeled entries have a consistent value.

def_detail$UnmodifiedIsSomeCompetition<-impute_unmodified(
  def_detail$UnmodifiedIsSomeCompetition,
  def_detail$IsSomeCompetition
)


#Set is some competion = 1 when it is blank and there are multiple offers

def_detail$UnmodifiedIsSomeCompetition[is.na(def_detail$UnmodifiedIsSomeCompetition)&
    !is.na(def_detail$UnmodifiedNumberOfOffersReceived)&
    def_detail$UnmodifiedNumberOfOffersReceived>1
  ]<-1

#Set number of offers =1 when there is a NA and no competition
def_detail$Offr[is.na(def_detail$Offr)&
    !is.na(def_detail$UnmodifiedIsSomeCompetition)&
    def_detail$UnmodifiedIsSomeCompetition==0
  ]<-"1"

def_detail$UnmodifiedNumberOfOffersReceived[is.na(def_detail$UnmodifiedNumberOfOffersReceived)&
    !is.na(def_detail$UnmodifiedIsSomeCompetition)&
    def_detail$UnmodifiedIsSomeCompetition==0
  ]<-1


#Produce Comp factor
def_detail$Comp<-NA
def_detail$Comp[def_detail$UnmodifiedIsSomeCompetition==0]<-"No Comp."
# def_detail$Comp[def_detail$UnmodifiedIsSomeCompetition=="Comp." &
#                            def_detail$UnmodifiedIsFullAndOpen=="Not Full & Open"]<-"Comp."
# def_detail$Comp[def_detail$UnmodifiedIsSomeCompetition=="Comp." &
#                            def_detail$UnmodifiedIsFullAndOpen=="Comp."]<-"Comp."
def_detail$Comp[def_detail$UnmodifiedIsSomeCompetition==1]<-"Comp."

def_detail$Comp<-factor(def_detail$Comp,
                               levels=c("No Comp.","Comp.")
                                                              )


#Produce EffComp factor

#Competition and Offer  
def_detail$EffComp<-as.character(def_detail$Comp)

def_detail$EffComp[def_detail$Comp=="Comp." & !is.na(def_detail$Comp)]<-
  ifelse(def_detail$UnmodifiedNumberOfOffersReceived[
    def_detail$Comp=="Comp." & !is.na(def_detail$Comp)]>1,"2+ Offers","1 Offer")

def_detail$EffComp<-factor(def_detail$EffComp,
                               levels=c("No Comp.","1 Offer","2+ Offers")
                               )


#Impute missing urgency values
def_detail$UnmodifiedIsUrgency<-impute_unmodified(
  def_detail$UnmodifiedIsUrgency,
  def_detail$IsUrgency
)
#If there's competition, than the urgency exception wasn't used
def_detail$UnmodifiedIsUrgency[is.na(def_detail$UnmodifiedIsUrgency)&
                               !is.na(def_detail$UnmodifiedIsSomeCompetition)&
                               def_detail$UnmodifiedIsSomeCompetition==1]<-0

def_detail$Urg<-NA
def_detail$Urg[def_detail$UnmodifiedIsUrgency==0]<-"Not Urgency"
def_detail$Urg[def_detail$UnmodifiedIsUrgency==1]<-"Urgency Except."
def_detail$Urg<-factor(def_detail$Urg,
                               levels=c("Not Urgency","Urgency Except.")
                               )

#Vehicle
#Award_Type_Code Impute missing values when labeled entries have a consistent value.
def_detail$unmodifiedaward_type_code<-impute_unmodified(
  def_detail$unmodifiedaward_type_code,
  def_detail$Award_Type_Code
)

#idv_type_code Impute missing values when labeled entries have a consistent value.
def_detail$unmodifiedidv_type_code<-impute_unmodified(
  def_detail$unmodifiedidv_type_code,
  def_detail$IDV_Type_Code
)


#Unmodifiedmultipleorsingleawardidc Impute missing values when labeled entries have a consistent value.
def_detail$Unmodifiedmultipleorsingleawardidc<-impute_unmodified(
  def_detail$Unmodifiedmultipleorsingleawardidc,
  def_detail$multipleorsingleawardidc
)

#Assign Is IDV
#A = BPA Call, C = Delivery Order
def_detail$IsIDV[!is.na(def_detail$unmodifiedaward_type_code) &
                               def_detail$unmodifiedaward_type_code %in% c("A","C")]<-1
#B = Purchase Order, D = Definitive Contract
def_detail$IsIDV[!is.na(def_detail$unmodifiedaward_type_code) &
                               def_detail$unmodifiedaward_type_code %in% c("B","D")]<-0
def_detail$IsIDV[!is.na(def_detail$unmodifiedidv_type_code)]<-1

if(is.numeric(def_detail$IsIDV)){
  def_detail$IsIDV<-factor(def_detail$IsIDV,levels=c(0,1),labels=c("def_detail/Pur","IDV"))
}


#Simple Vehicle, which consolidates IDV and award types
def_detail$Veh<-NA
def_detail$Veh[
  !is.na(def_detail$unmodifiedaward_type_code) &
    def_detail$unmodifiedaward_type_code %in% c("B","D")]<-"Def/Pur"


def_detail$Veh[
  !is.na(def_detail$unmodifiedidv_type_code) &
    def_detail$unmodifiedidv_type_code %in% c("B") &
    !is.na(def_detail$Unmodifiedmultipleorsingleawardidc)]<-
  paste(def_detail$Unmodifiedmultipleorsingleawardidc[
     !is.na(def_detail$unmodifiedidv_type_code) &
    def_detail$unmodifiedidv_type_code %in% c("B") &
    !is.na(def_detail$Unmodifiedmultipleorsingleawardidc)
  ],"IDC")

#IDV_type_Code D = BOA, E=BPA, Award_Type_code A=BPA Call
def_detail$Veh[
  !is.na(def_detail$unmodifiedidv_type_code) &
    def_detail$unmodifiedidv_type_code %in% c("D","E") |
  !is.na(def_detail$unmodifiedaward_type_code) &
    def_detail$unmodifiedaward_type_code %in% c("A") 
    ]<-
  "BPA/BOA"
#IDV_type_cde A=GWAC C=FSS
def_detail$Veh[
  !is.na(def_detail$unmodifiedidv_type_code)
  & def_detail$unmodifiedidv_type_code 
  %in% c('A','C')]<-"FSS/GWAC"

#Imputing that when Multiple Award/Single Award is known, but IDV_type_code is not
#that the vehicle type is an IDC
def_detail$Veh[
  is.na(def_detail$Veh)&
  is.na(def_detail$unmodifiedidv_type_code) &
    !is.na(def_detail$Unmodifiedmultipleorsingleawardidc)]<-
  paste(def_detail$Unmodifiedmultipleorsingleawardidc[
  is.na(def_detail$Veh)&
  is.na(def_detail$unmodifiedidv_type_code) &
    !is.na(def_detail$Unmodifiedmultipleorsingleawardidc)],"IDC")

def_detail$Veh<-factor(def_detail$Veh)
summary(def_detail$Veh)
#Imputing that when the simple vehicle is a kind of IDV, IsIDV should follow as well
def_detail$IsIDV[
  is.na(def_detail$IsIDV)&
    def_detail$Veh %in% c(
      'BPA/BOA','FSS/GWAC','MULTIPLE AWARD IDC','SINGLE AWARD IDC'
    )]<-"IDV"





def_detail<-def_detail[,!colnames(def_detail) %in% 
    c(
  #     UnmodifiedIsFullAndOpen,
  # "UnmodifiedIsOnlyOneSource",
  "UnmodifiedIsFollowonToCompetedAction",
      "Unmodifiedmultipleorsingleawardidc",
        # "UnmodifiedIsUrgency",
      "Unmodifiedaddmultipleorsingawardidc",
  # "IsFullAndOpen",
  # IsOnlyOneSource 
  # "IsFollowonToCompetedAction"
    "IsUrgency",
      "multipleorsingleawardidc",
      "AddMultipleOrSingleAwardIDC",
  "Award_Type_Code",
  "unmodifiedaward_type_code",
  "IDV_Type_Code",
  # "UnmodifiedNumberOfOffersReceived",
  "unmodifiedidv_type_code",
  "NumberOfOffersReceived"
)]
str(def_detail)
  
save(file="..\\data\\clean\\defense_contract_complete_detail.Rdata",def_detail)

```


##Pricing
```{r Pricing}
#Pricing is absurdly large. 27 variables.
#This needs to be rethought in a future iteration, but I might be able to get by using sufficient ram.
#Key thing to remember, when there's a ton of variables, read_delim sometimes leaves many out of the summary.
gc()
memory.limit(25000)
# load(file="..\\data\\clean\\defense_contract_complete_detail.Rdata")


def_detail<-read_and_join_experiment(data=def_detail
  ,"Contract.SP_ContractPricingCustomer.txt"
  ,path="../"
  ,dir="data/semi_clean/"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
  ,create_lookup_rdata=TRUE
)

#Process Fixed Or Cost
def_detail$pIsFixedPrice<-percent_obligated(def_detail,
                                          "ObligatedAmountIsFixedPrice",
                                            "Action_Obligation",
                                          "UnmodifiedIsFixedPrice",
                                          "IsFixedPrice")

def_detail$pIsCostBased<-percent_obligated(def_detail,
                                          "ObligatedAmountIsCostBased",
                                            "Action_Obligation",
                                          "UnmodifiedIsCostBased",
                                          "IsCostBased")


def_detail$pIsCombination<-percent_obligated(def_detail,
                                          "ObligatedAmountIsCombination",
                                            "Action_Obligation",
                                          "UnmodifiedIsCombination",
                                          "IsCombination")

def_detail$pIsOtherFee<-percent_obligated(def_detail,
                                          "ObligatedAmountIsOtherFee",
                                            "Action_Obligation",
                                          "UnmodifiedIsOtherFee",
                                          "IsOtherFee")


#Assign FxCb
def_detail$FxCb[def_detail$pIsFixedPrice>0  |
    def_detail$pIsCostBased>0 | 
    def_detail$pIsCombination>0 | 
      def_detail$pIsOtherFee>0]<-"Combination or Other"

def_detail$FxCb[def_detail$pIsFixedPrice>=0.95|(def_detail$IsFixedPrice==1 & (def_detail$pIsCombination<=0.05 | is.na(def_detail$pIsCombination)))]<-"Fixed-Price"
def_detail$FxCb[def_detail$pIsCostBased>=0.95|(def_detail$IsCostBased==1 & (def_detail$pIsCombination<=0.05 | is.na(def_detail$pIsCombination)))]<-"Cost-Based"
def_detail$FxCb<-factor(def_detail$FxCb,levels=c("Fixed-Price","Cost-Based","Combination or Other"))
#Process Fee

View(subset(def_detail,is.na(FxCb) & !is.na(FxCb)))
def_detail$pIsIncentive<-percent_obligated(def_detail,
                                          "ObligatedAmountIsIncentive",
                                            "Action_Obligation",
                                          "UnmodifiedIsIncentive",
                                          "IsIncentive")


def_detail$pIsAwardFee<-percent_obligated(def_detail,
                                          "ObligatedAmountIsAwardFee",
                                            "Action_Obligation",
                                          "UnmodifiedIsAwardFee",
                                          "IsAwardFee")



def_detail$pIsFFPorNoFee<-percent_obligated(def_detail,
                                          "ObligatedAmountIsFFPorNoFee",
                                            "Action_Obligation",
                                          "UnmodifiedIsFFPorNoFee",
                                          "IsFFPorNoFee")


def_detail$pIsFixedFee<-percent_obligated(def_detail,
                                          "ObligatedAmountIsFixedFee",
                                            "Action_Obligation",
                                          "UnmodifiedIsFixedFee",
                                          "IsFixedFee")





#AssignFee
def_detail$Fee<-NA
def_detail$Fee[def_detail$pIsAwardFee>0  |
    def_detail$pIsIncentive>0 | 
    def_detail$pIsFFPorNoFee>0 |
      def_detail$pIsFixedFee>0 |
      def_detail$pIsOtherFee>0 |
      def_detail$pIsCombination>0]<-"Combination"

def_detail$Fee[def_detail$pIsAwardFee>=0.9|(def_detail$IsAwardFee==1
  & (def_detail$pIsCombination<=0.05 | is.na(def_detail$pIsCombination))) ]<-"Award Fee"
def_detail$Fee[def_detail$pIsIncentive>=0.9|(def_detail$IsIncentive==1
  & (def_detail$pIsCombination<=0.05 | is.na(def_detail$pIsCombination)))]<-"Incentive"
def_detail$Fee[def_detail$pIsFFPorNoFee>=0.9|(def_detail$IsFFPorNoFee==1
  & (def_detail$pIsCombination<=0.05 | is.na(def_detail$pIsCombination)))]<-"FFP or No Fee"
def_detail$Fee[def_detail$pIsFixedFee>=0.9|(def_detail$IsFixedFee==1
  & (def_detail$pIsCombination<=0.05 | is.na(def_detail$pIsCombination)))]<-"Fixed Fee"
def_detail$Fee[def_detail$pIsOtherFee>=0.9|(def_detail$IsOtherFee==1
  & (def_detail$pIsCombination<=0.05 | is.na(def_detail$pIsCombination)))]<-"Other Fee"


def_detail$Fee<-ordered(def_detail$Fee,
  levels=c("Incentive","Fixed Fee","Award Fee",
    "FFP or No Fee","Other Fee","Combination"))


summary(def_detail$Fee)
summary(def_detail$FxCb)
#Undefinitized Contract Awards
# def_detail$Veh[def_detail$AwardOrIDVcontractActionType == "Letter Contract"]<-"Letter"
# def_detail$Veh[def_detail$AwardOrIDVcontractActionType %in%
#     c("Indefinite Delivery Contract",
#       "Delivery Order")]<-
#   as.character(def_detail$multipleorsingleawardidc[def_detail$AwardOrIDVcontractActionType %in%
#       c("Indefinite Delivery Contract",
#         "Delivery Order")])

memory.limit(32000)

def_detail<-read_and_join_experiment(data=def_detail
  ,"Contract.SP_ContractPricingUCA.txt"
  ,path="../"
  ,dir="data/semi_clean/"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
  ,add_var=c("UnmodifiedIsUCA","IsUCA")
  ,create_lookup_rdata=TRUE
)


#Impute UCA unmodified values when consistent for the remainder of the vehicle
def_detail$UnmodifiedIsUCA[is.na(def_detail$UnmodifiedIsUCA)&
  !is.na(def_detail$IsUCA)]<-
  def_detail$IsUCA[is.na(def_detail$UnmodifiedIsUCA)&
  !is.na(def_detail$IsUCA)]



def_detail$UCA<-factor(def_detail$UnmodifiedIsUCA,
  levels=c(0,1),
  labels=c("Not UCA","UCA")
)

#Imputing to make up for absence of 
#There's no obligations in the dataset to UCAs using the regulated vehicle of FSS/GWAC
def_detail$UCA[is.na(def_detail$UCA)&
               def_detail$Veh=="FSS/GWAC"]<-"Not UCA"
summary(def_detail$UCA)
def_detail<-def_detail[,!colnames(def_detail) %in% 
    c(
  # Pricing.Mechanism.Code,
  "UnmodifiedTypeOfContractPricing",
  "IsLabeledPricing",
  "ObligatedAmountIsFixedPrice",
  "IsFixedPrice",
  "UnmodifiedIsFixedPrice",
  "ObligatedAmountIsCostBased",
  "IsCostBased",
  "UnmodifiedIsCostBased",
  "ObligatedAmountIsCombination",
  "IsCombination",
  "UnmodifiedIsCombination",
  "ObligatedAmountIsIncentive",
  # IsIncentive,
  "UnmodifiedIsIncentive",
  "ObligatedAmountIsAwardFee",
  "IsAwardFee",
  "UnmodifiedIsAwardFee",
  "ObligatedAmountIsFFPorNoFee",
  "IsFFPorNoFee",
  "UnmodifiedIsFFPorNoFee",
  "ObligatedAmountIsFixedFee",
  "IsFixedFee",
  "UnmodifiedIsFixedFee",
  "ObligatedAmountIsOtherFee",
  "IsOtherFee",
  "UnmodifiedIsOtherFee",
  "pIsFixedPrice",
  "pIsCostBased",
  "pIsCombination",
  "pIsIncentive",
  "pIsAwardFee",
  "pIsFFPorNoFee",
  "pIsFixedFee",
  "pIsOtherFee"#,
  # FxCb,
  # Fee,
    )]

str(def_detail)

save(file="..\\data\\clean\\defense_contract_complete_detail.Rdata",def_detail)

```



##BucketPlatform
```{r BucketPlatform}
# load(file="..\\data\\clean\\defense_contract_complete_detail.Rdata")
#Note to identify is.defense here.
def_detail<-read_and_join_experiment(data=def_detail
  ,"Contract.SP_ContractBucketPlatformCustomer.txt"
  ,path="../"
  ,dir="data/semi_clean/"
  ,by="CSIScontractID"
  ,new_var_checked=FALSE
)
# 
# def_detail$ObligatedAmountIsProducts<-FactorToNumber(def_detail$ObligatedAmountIsProducts)
# 
# def_detail$ObligatedAmountIsServices<-FactorToNumber(def_detail$ObligatedAmountIsServices)
# 
# def_detail$ObligatedAmountIsRnD<-FactorToNumber(def_detail$ObligatedAmountIsRnD)
# 
# def_detail$pIsProducts <- def_detail$ObligatedAmountIsProducts/def_detail$Action_Obligation
# def_detail$pIsProducts[is.na(def_detail$ObligatedAmountIsProducts)] <- 0
# 
# def_detail$pIsServices <- def_detail$ObligatedAmountIsServices/def_detail$Action_Obligation
# def_detail$pIsServices[is.na(def_detail$ObligatedAmountIsServices)] <- 0
# 
# def_detail$pIsRnD <- def_detail$ObligatedAmountIsRnD/def_detail$Action_Obligation
# def_detail$pIsRnD[is.na(def_detail$ObligatedAmountIsRnD)] <- 0

#Need to update these to the new platform portfolios
# 
# 
# def_detail$ObligatedAmountIsLand<-FactorToNumber(def_detail$ObligatedAmountIsLand)
# 
# def_detail$ObligatedAmountIsVessel<-FactorToNumber(def_detail$ObligatedAmountIsVessel)
# 
# 
# def_detail$ObligatedAmountIsVessel<-FactorToNumber(def_detail$ObligatedAmountIsAir)
# 
# def_detail$ObligatedAmountIsVessel<-FactorToNumber(def_detail$ObligatedAmountIsOtherPP)
# 
# def_detail$ObligatedAmountIsWnA<-FactorToNumber(def_detail$ObligatedAmountIsWnA)
# 
# def_detail$ObligatedAmountIsMnS<-FactorToNumber(def_detail$ObligatedAmountIsMnS)
# 
# def_detail$ObligatedAmountIsEnC<-FactorToNumber(def_detail$ObligatedAmountIsEnC)
# 
# def_detail$ObligatedAmountIsFRSnC<-FactorToNumber(def_detail$ObligatedAmountIsFRSnC)
# 
# 
# def_detail$pIsLand <- def_detail$ObligatedAmountIsLand/def_detail$Action_Obligation
# def_detail$pIsLand[is.nan(def_detail$pIsLand)|is.infinite(def_detail$pIsLand)|is.na(def_detail$ObligatedAmountIsLand)] <- 0
# 
# def_detail$pIsVessel <- def_detail$ObligatedAmountIsVessel/def_detail$Action_Obligation
# def_detail$pIsVessel[is.nan(def_detail$pIsVessel)|is.infinite(def_detail$pIsVessel)|is.na(def_detail$ObligatedAmountIsVessel)] <- 0
# 
# def_detail$pIsOtherPP <- def_detail$ObligatedAmountIsOtherPP/def_detail$Action_Obligation
# def_detail$pIsOtherPP[is.nan(def_detail$pIsOtherPP)|is.infinite(def_detail$pIsOtherPP)|is.na(def_detail$ObligatedAmountIsOtherPP)] <- 0
# 
# def_detail$pIsAir <- def_detail$ObligatedAmountIsAir/def_detail$Action_Obligation
# def_detail$pIsAir[is.nan(def_detail$pIsAir)|is.infinite(def_detail$pIsAir)|is.na(def_detail$ObligatedAmountIsAir)] <- 0
# 
# def_detail$pIsEnC <- def_detail$ObligatedAmountIsEnC/def_detail$Action_Obligation
# def_detail$pIsEnC[is.nan(def_detail$pIsEnC)|is.infinite(def_detail$pIsEnC)|is.na(def_detail$ObligatedAmountIsEnC)] <- 0
# 
# def_detail$pIsFRSnC <- def_detail$ObligatedAmountIsFRSnC/def_detail$Action_Obligation
# def_detail$pIsFRSnC[is.nan(def_detail$pIsFRSnC)|is.infinite(def_detail$pIsFRSnC)|is.na(def_detail$ObligatedAmountIsFRSnC)] <- 0
# 
# 
# def_detail$pIsMnS <- def_detail$ObligatedAmountIsMnS/def_detail$Action_Obligation
# def_detail$pIsMnS[is.nan(def_detail$pIsMnS)|is.infinite(def_detail$pIsMnS)|is.na(def_detail$ObligatedAmountIsMnS)] <- 0


# TempList<-c("PlatformPortfolio","UnmodifiedPlatformPortfolio","ObligatedAmountIsAir","ObligatedAmountIsEnC","ObligatedAmountIsFRSnC","ObligatedAmountIsLand","ObligatedAmountIsMnS","ObligatedAmountIsOtherPP","ObligatedAmountIsVessel","ObligatedAmountIsWnA","ProductOrServiceArea","UnmodifiedProductOrServiceArea","SimpleArea","UnmodifiedSimpleArea","ObligatedAmountIsProducts","ObligatedAmountIsServices","ObligatedAmountIsRnD","MaxOfIsPossibleSoftwareEngineering")

# TempList<-TempList[TempList %in% names(def_detail)]
# def_detail<-subset(def_detail,select=-c(PlatformPortfolio,
#                                                       UnmodifiedPlatformPortfolio,
#                                                       SimpleArea,UnmodifiedSimpleArea ))

NASimpleArea<-(def_detail$SimpleArea=="Mixed or Unlabeled" | is.na(def_detail$SimpleArea))&
  !is.na(def_detail$UnmodifiedSimpleArea) & def_detail$UnmodifiedSimpleArea!="NULL"
def_detail$SimpleArea[NASimpleArea]<-def_detail$UnmodifiedSimpleArea[NASimpleArea]
# def_detail$SimpleArea[def_detail$SimpleArea=="Mixed or Unlabeled" & def_detail$pIsProducts>0.5]<-"Products"
# def_detail$SimpleArea[def_detail$SimpleArea=="Mixed or Unlabeled" & def_detail$pIsServices>0.5]<-"Services"
# def_detail$SimpleArea[def_detail$SimpleArea=="Mixed or Unlabeled" & def_detail$pIsRnD>0.5]<-"R&D"



# def_detail$PlatformPortfolio.sum[def_detail$pIsLand>=0.75&
#     def_detail$PlatformPortfolio.sum=="Unlabeled"]<-"Land Vehicles"
# def_detail$PlatformPortfolio.sum[def_detail$pIsVessel>=0.75&
#     def_detail$PlatformPortfolio.sum=="Unlabeled"]<-"Ships & Submarines"
# def_detail$PlatformPortfolio.sum[def_detail$pIsAir>=0.75&
#     def_detail$PlatformPortfolio.sum=="Unlabeled"]<-"Aircraft and Drones"
# def_detail$PlatformPortfolio.sum[def_detail$pIsOtherPP>=0.75&
#     def_detail$PlatformPortfolio.sum=="Unlabeled"]<-"Other"
# def_detail$PlatformPortfolio.sum[def_detail$pIsWnA>=0.75&
#     def_detail$PlatformPortfolio.sum=="Unlabeled"]<-"Weapons and Ammunition"
# def_detail$PlatformPortfolio.sum[def_detail$pIsMnS>=0.75&
#     def_detail$PlatformPortfolio.sum=="Unlabeled"]<-"Missile and Space Systems"
# def_detail$PlatformPortfolio.sum[def_detail$pIsEnC>=0.75&
#     def_detail$PlatformPortfolio.sum=="Unlabeled"]<-"Electronics and Communications"
# def_detail$PlatformPortfolio.sum[def_detail$pIsFRSnC>=0.75&
#     def_detail$PlatformPortfolio.sum=="Unlabeled"]<-"Facilities and Construction"
# 
# def_detail$SoftwareEng<-factor(def_detail$MaxOfIsPossibleSoftwareEngineering,
#   levels=c(0,1),
#   labels=c("Not Software Eng.","Possible Software Eng.")
# )
# 
# def_detail$SoftwareEng[is.na(def_detail$SoftwareEng)&
#     !is.na(def_detail$SimpleArea)]<-"Not Software Eng."



def_detail$PlatformPortfolio<-factor(def_detail$PlatformPortfolio)
def_detail$UnmodifiedPlatformPortfolio<-factor(def_detail$UnmodifiedPlatformPortfolio)

def_detail$ProductOrServiceArea<-factor(def_detail$ProductOrServiceArea)
def_detail$UnmodifiedProductOrServiceArea<-factor(def_detail$UnmodifiedProductOrServiceArea)

def_detail$SimpleArea<-factor(def_detail$SimpleArea)
def_detail$UnmodifiedSimpleArea<-factor(def_detail$UnmodifiedSimpleArea)


def_detail<-def_detail[,!colnames(def_detail) %in% c(
  # "UnmodifiedSimpleArea",
  # "SimpleArea",
  "MaxOfIsPossibleSoftwareEngineering",
  # "ObligatedAmountIsProducts",
  # "ObligatedAmountIsServices",
  # "ObligatedAmountIsRnD",
  "ObligatedAmountIsLand",
  "ObligatedAmountIsVessel",
  "ObligatedAmountIsOtherPP",
  "ObligatedAmountIsAir",
  "ObligatedAmountIsEnC",
  "ObligatedAmountIsFRSnC",
  "ObligatedAmountIsMnS",
  "ObligatedAmountIsWnA"
  
  
)]




def_detail$SimpleArea<-droplevels(def_detail$SimpleArea)


save(file="..\\data\\clean\\defense_contract_complete_detail.Rdata",def_detail)

```

#Final Cleanup and Output
##Applying lookups
```{r PostApply}
# debug(apply_lookups)
load(file="..\\data\\clean\\defense_contract_all_detail.Rdata")
def_all<-apply_lookups(Path,def_all)
save(file="..\\data\\clean\\defense_contract_all_detail.Rdata",def_all)


load(file="..\\data\\clean\\defense_contract_complete_detail.Rdata")

#Hitting errors, but nothing vital
debug(apply_lookups)
def_detail<-apply_lookups(Path,def_detail)
save(file="..\\data\\clean\\defense_contract_complete_detail.Rdata",def_detail)


# def_all<-read_and_join(
#   def_all,
#   "Lookup_SubCustomer.csv",
#   by=c("Customer","SubCustomer"),
#   # replace_na_var=NULL,
#   # overlap_var_replaced=TRUE,
#   add_var="SubCustomer.sum"
#   # new_var_checked=TRUE,
#   # skip_check_var="CHPKisCrisisFunding"
#   )

# def_all$SubCustomer.sum<-factor(def_all$SubCustomer.sum)
# def_all$SubCustomer.sum<-droplevels(def_all$SubCustomer.sum)
# def_all$SubCustomer.sum<-droplevels(def_all$SubCustomer.sum)



# def_all<-rename_dataset(def_all)

```
##Dataset Output

```{r DatasetOutput}
#Trim down def_detail
load(file="..\\data\\clean\\defense_contract_complete_detail.Rdata")

def<-rename_dataset(def_detail)
rm(def_detail)
def<-trim_dataset(def)

def<-rename_dataset(def)
def<-trim_dataset(def)
# write.table(def
#   ,file=paste("..\\data\\clean\\defense_contract.csv"
#     ,sep=""
#   )
#     #   ,header=TRUE
#   , sep=","
#   , row.names=FALSE
#   , append=FALSE
# )


save(def,file="..\\data\\clean\\defense_contract_complete.RData")

```

## Dataset Transformation: Monopolies
In this step the datset is pruned and transformed for use in the Monopolies analysis
```{r Dataset_Transformation}

###Data Transformations and Summary
load(file="../data/clean/defense_contract_complete.RData")
def<-def[def$MinOfSignedDate>=as.Date("2008-01-01") & def$MinOfSignedDate<=as.Date("2015-12-31"),]
# debug(transform_contract)
memory.limit(36000)
# debug(deflate)
def<-transform_contract(def)



def$l_Ceil<-na_non_positive_log(def$UnmodifiedCeiling_Then_Year)
def$cl_Ceil<-arm::rescale(def$l_Ceil)
def$l_def6_obl_lag1<-na_non_positive_log(def$def6_obl_lag1)
def$cl_def6_obl_lag1<-arm::rescale(def$l_def6_obl_lag1)
def$l_US6_avg_sal_lag1<-na_non_positive_log(def$US6_avg_sal_lag1)
def$cl_US6_avg_sal_lag1<-arm::rescale(def$l_US6_avg_sal_lag1)

def<-def[!colnames(def) %in% colnames(def)[grep("^l_",colnames(def))]]
def<-def[!colnames(def) %in% colnames(def)[grep("^capped_l_",colnames(def))]]


#l_Offr
def$l_Offr<-na_non_positive_log(def$UnmodifiedNumberOfOffersReceived)
#ObligationWT
if("Action_Obligation_Then_Year" %in% colnames(def)){
  def$ObligationWT_Then_Year<-def$Action_Obligation_Then_Year
  def$ObligationWT_Then_Year[def$ObligationWT_Then_Year<0]<-NA
}

# # head(def)
# debug(transform_contract)
# 
# 

# load(file="..\\data\\clean\\defense_contract_all_detail.Rdata")
# def_update<-def_all
# rm(def_all)
# def_update<-def_update[def_update$MinOfSignedDate>=as.Date("2008-01-01") & def_update$MinOfSignedDate<=as.Date("2015-12-31"),]
# def_update<-def_update %>% dplyr::select(CSIScontractID,IsComplete)
# 
# 
# 
# length(unique((def_serv$ContractingOfficeCode)))
# length(unique((def_serv$Agency)))
# length(unique((def_serv$NAICS)))
# length(unique((def_serv$NAICS3)))
# 
# 
# 
# 
# 
# #********** NAICS - Office hhi
# annual_office_naics_hhi <- read.csv("data//clean//annual_office_naics_hhi.csv", header = TRUE, row.names = "X") %>% 
#   dplyr::select(-c("obligatedAmount","numberOfContracts"))
# 
# #Pulling in join annual_office_naics_hhi
# def_serv <- def_serv %>%
#   mutate("StartFY_lag1" = StartFY - 1) %>%
#   left_join(annual_office_naics_hhi, by = c("Office" = "ContractingOfficeCode", "StartFY_lag1" = "Fiscal_year")) %>%
#   dplyr::select(-c("StartFY_lag1"))
# rm(annual_office_naics_hhi)
# 
# #Pulling in join avg_office_naics_hhi
# avg_office_naics_hhi <- read.csv("data//clean//average_office_naics_hhi.csv", header = TRUE, row.names = "X") %>% 
#   dplyr::select(-c("obligatedAmount","numberOfContracts"))
# def_serv <- def_serv %>%
#   left_join(avg_office_naics_hhi, by = c("Office" = "ContractingOfficeCode"))
# rm(avg_office_naics_hhi)
# 
# #Imputing missing
# summary(def_serv$office_naics_hhi_obl)
# def_serv$office_naics_hhi_obl[is.na(def_serv$office_naics_hhi_obl)]<-def_serv$avg_office_naics_hhi_obl[is.na(def_serv$office_naics_hhi_obl)]
# summary(def_serv$office_naics_hhi_k)
# def_serv$office_naics_hhi_k[is.na(def_serv$office_naics_hhi_k)]<-def_serv$avg_office_naics_hhi_k[is.na(def_serv$office_naics_hhi_k)]
# 
# def_serv$cl_office_naics_hhi_obl <- arm::rescale(na_non_positive_log(def_serv$office_naics_hhi_obl))
# def_serv$cl_office_naics_hhi_k <- arm::rescale(na_non_positive_log(def_serv$office_naics_hhi_k))
# def_serv<- def_serv %>% dplyr::select(-c(avg_office_naics_hhi_obl,avg_office_naics_hhi_k))
# 
str(def)
str(def[,100:ncol(def)])
def$NAICS2<-factor(def$NAICS2)
def$PlaceCountryISO3<-factor(def$PlaceCountryISO3)
def$CSIS_inspection<-factor(def$CSIS_inspection)
def$CSIS_inspection<-factor(def$CSIS_inspection)
def$ProductOrServiceCode<-factor(def$ProductOrServiceCode)
object.size(def)
def<-def[,!colnames(def) %in% c("SIDV","MIDV","FSSGWAC","BPABOA",
                                "capped_cl_Days",
                                "override_unmodified_ceiling","override_unmodified_base",
                                "override_change_order_growth","override_exercised_growth",
                                "qNChg","ProductOrServiceCode1L","ProductOrServiceCode2L",
                                "ProductOrServiceCode2R","ProductOrServiceCode1L1R",
                                "Unseperated","DoDportfolioGroup","AddressLine1",
                                "AddressLine2","AddressLine3","AddressCity",
                                "Depot","FISC","TFBSOrelated","CSIScreatedDate",
                                "CSISmodifieddDate","IsPossibleReclassification",
                                "DoDportfolio","DoDportfolioCategory","DoDportfolioSubCategory",
                                "CanadaSector","VAPortfolio")]

#Unused Office Characteristics
def<-def[,!colnames(def) %in% c("StartDate",
                                "EndDate",
                                "OCOcrisisScore",
                                "OCOcrisisPercent",
                                "OffCri",
                                "OffIntl",
                                "c_OffCri",
                                "Reach",
                                "Reach6"
                                )]

#Not using constant dollars in this study, so dropping to avoid confusion.
def<-def[,!colnames(def) %in% c("n_CBre_OMB20_GDP18",
                                "Action_Obligation_OMB20_GDP18",
                                "UnmodifiedBase_OMB20_GDP18",
                                "UnmodifiedCeiling_OMB20_GDP18",
                                "ln_CBre_OMB20_GDP18")]


#Duplicated columns
if("Where" %in% colnames(def)) def<-def[,!colnames(def) %in% c("PlaceCountryISO3")]



if("cl_Ceil" %in% colnames(def)){
  def$l_Ceil_Then_Year<-log(def$UnmodifiedCeiling_Then_Year)
  def$l_Ceil_Then_Year[is.na(def$cl_Ceil)]<-NA
  def$cl_Ceil_Then_Year<-arm::rescale(def$l_Ceil_Then_Year)
  def<-def %>% dplyr::select(-c(cl_Ceil))
  summary(def$cl_Ceil_Then_Year,l_Ceil_Then_Year)
}



save(file="../data/clean/transformed_def.Rdata",def)


# smp_trans<-smp1m
# smp_trans<-smp_trans %>% group_by() %>% dplyr::select(CSIScontractID)
# smp_trans$IsSmp<-1
# 
# def_united<-full_join(smp_trans,def_update,by="CSIScontractID")



# ggplot(data=def_united,aes(x=factor(IsComplete)))+facet_wrap(~IsOriginal)+geom_bar()
# load(file="../Data/Clean/transformed_def_2018_08_31.Rdata")
# smp_missing<-def_united %>% filter(is.na(IsComplete)| IsComplete==0)
# smp_missing<-left_join(smp_missing,def, by="CSIScontractID")
# summary(def$LastCurrentCompletionDate)


# 
# summary(factor(def_united$IsComplete))
# summary(factor(def_united$IsOriginal))
# 
# 
# 
# now_incomplete_boost<-def_united %>% filter(IsComplete==0 & IsOriginal==1)
# completely_missing_boost<-def_united %>% filter(is.na(IsComplete))
# missing_original<-def_united %>% filter(is.na(IsOriginal) & IsComplete==1)
# now_incomplete_boost<-now_incomplete_boost%>% dplyr::select(CSIScontractID,WhyIncomplete,LastCurrentCompletionDate.x,LastCurrentCompletionDate.y)
# load(file="../Data/Clean/defense_contract_all_detail.RData")
# missing_original<-left_join(missing_original,def_all)
# summary(missing_original$IsClosed[is.na(missing_original$WhyMissing)])
# summary(missing_original$IsTerminated[is.na(missing_original$WhyMissing)])
# summary(missing_original$LastCurrentCompletionDate[is.na(missing_original$WhyMissing)])
# summary(missing_original$MinOfSignedDate[is.na(missing_original$WhyMissing)])
# summary(missing_original$Un[is.na(missing_original$WhyMissing)])
# summary(missing_original$MinOfSignedDate)
# 
# missing_original$WhyMissing<-NA
# missing_original$WhyMissing[(missing_original$IsClosed==1 | missing_original$IsTerminated==1) & 
#                               (is.na(missing_original$LastCurrentCompletionDate) |
#                                missing_original$LastCurrentCompletionDate>=as.Date("2017-01-01"))
#                             ]<-"Close/Term LastCurrent Out of Range"
# missing_original$WhyMissing[(missing_original$IsClosed==1 | missing_original$IsTerminated==1) & 
#                               is.na(missing_original$WhyMissing)
#                             ]<-"Unknown Close/Term"
# missing_original$WhyMissing[(missing_original$IsClosed==0 & missing_original$IsTerminated==0) & 
#                               is.na(missing_original$WhyMissing)
#                             ]<-"Unknown Other"
# 
# summary(factor(missing_original$WhyMissing))
# write.csv(file="..\\data\\semi_clean\\contracts_added_to_population_2019_05_29.csv",missing_original)
# missing_original<-read.csv(file="..\\data\\semi_clean\\contracts_added_to_population_2019_05_29.csv")
# summary(factor(missing_original$WhyMissing))
# sum(missing_original$Action_Obligation.Then.Year[missing_original$WhyMissing=="Close/Term LastCurrent Out of Range"])
# rm(missing_original)

# now_incomplete_boost<-left_join(now_incomplete_boost,def)
# now_incomplete_boost$WhyIncomplete[is.na(now_incomplete_boost$WhyIncomplete)&
#                                      now_incomplete_boost$MaxBoostDate>=as.Date("2017-01-01")]<-"MaxBoostDate>=2017"
# now_incomplete_boost$WhyIncomplete[now_incomplete_boost$LastCurrentCompletionDate>=as.Date("2017-01-01")&
#                                      now_incomplete_boost$IsComplete==0&
#                                      now_incomplete_boost$IsTerminated==0]<-"Not Closed/Term & Last Current>=2017"
# now_incomplete_boost$WhyIncomplete[is.na(now_incomplete_boost$LastCurrentCompletionDate)&
#                                      now_incomplete_boost$IsComplete==0&
#                                      now_incomplete_boost$IsTerminated==0]<-"Not Closed/Term & Last Current is na"
# 
# summary(factor(now_incomplete_boost$WhyIncomplete))
# summary(now_incomplete_boost$Term[now_incomplete_boost$WhyIncomplete=="MaxBoostDate>=2017"])
# summary(now_incomplete_boost$IsClosed[now_incomplete_boost$WhyIncomplete=="MaxBoostDate>=2017"])
# sum(now_incomplete_boost$Action_Obligation[now_incomplete_boost$WhyIncomplete=="MaxBoostDate>=2017"])
# sum(now_incomplete_boost$Action_Obligation.x[now_incomplete_boost$WhyIncomplete=="Not Closed/Term & Last Current is na"])
# sum(now_incomplete_boost$Action_Obligation.x[now_incomplete_boost$WhyIncomplete=="Not Closed/Term & Last Current>=2017"])
# 
# summary(now_incomplete_boost$LastCurrentCompletionDate[now_incomplete_boost$WhyIncomplete=="Not Closed/Term & Last Current>=2017"])
# 
# summary(now_incomplete_boost$LastCurrentCompletionDate)
# summary(now_incomplete_boost$LastCurrentCompletionDate.x)
# summary(now_incomplete_boost$LastCurrentCompletionDate.y)
# 
# 
# now_incomplete_boost<-left_join(now_incomplete_boost,def, by="CSIScontractID")
# summary(now_incomplete_boost$LastCurrentCompletionDate.x[now_incomplete_boost$WhyIncomplete=="Not Closed/Term & Last Current>=2017"])
# summary(now_incomplete_boost$LastCurrentCompletionDate.y[now_incomplete_boost$WhyIncomplete=="Not Closed/Term & Last Current>=2017"])
# summary(def$LastCurrentCompletionDate)
# summary(now_incomplete_boost$IsOriginal)
# 
# summary(now_incomplete_boost$MaxBoostDate[is.na(now_incomplete_boost$WhyIncomplete)])
# summary(now_incomplete_boost$LastCurrentCompletionDate[is.na(now_incomplete_boost$WhyIncomplete)])
# summary(now_incomplete_boost$IsClosed[is.na(now_incomplete_boost$WhyIncomplete)])
# summary(now_incomplete_boost$IsTerminated[is.na(now_incomplete_boost$WhyIncomplete)])
# 
# rm(def)


# summary(now_incomplete_boost$Action_Obligation[is.na(now_incomplete_boost$MaxBoostDate)])
# summary(now_incomplete_boost$UnmodifiedContractBaseAndAllOptionsValue[is.na(now_incomplete_boost$MaxBoostDate)])
# summary(now_incomplete_boost$IsClosed[is.na(now_incomplete_boost$MaxBoostDate)])
# summary(now_incomplete_boost$Action_Obligation)
# completely_missing<-now_incomplete_boost %>% filter(is.na(StartFiscal_Year)) %>% select(CSIScontractID,IsOriginal)
# now_incomplete_boost<-now_incomplete_boost %>%filter(!is.na(StartFiscal_Year)) %>% select(CSIScontractID,IsOriginal)
# now_incomplete_boost<-left_join(now_incomplete_boost, def)
# 
# summary(now_incomplete_boost$Term)
# summary(now_incomplete_boost$IsClosed)


# completely_missing_boost<-left_join(completely_missing_boost,def,by="CSIScontractID")
# write(completely_missing_boost,"")
# # summary(def$UnmodifiedContractBaseAndAllOptionsValue)
# # summary(def$Action_Obligation)
# summary(completely_missing_boost$MinOfSignedDate)
# summary(completely_missing_boost$Agency)
# summary(completely_missing_boost$Action_Obligation)
# summary(completely_missing_boost$LastCurrentCompletionDate)
# summary(completely_missing_boost)

# load(file="next_to_study.rdata")
# save(now_incomplete_boost,file="next_to_study.rdata")
# rm(def) 9134093
# load(file="../data/clean/transformed_def_2018_08_31.Rdata")
# summary(def_united$IsOriginal)
# summary(def_united$IsComplete)
# 
# memory.limit(56000)



# def<-def[!colnames(def) %in% colnames(def)[grep("^l_",colnames(def))]]
# save(file="../Data/Clean/transformed_def.Rdata", def) 
# summary(def$qHighCeiling)
# if (all(levels(def$qHighCeiling)[1:5]==c("[0.00e+00,1.50e+04)",
#                                              "[1.50e+04,1.00e+05)",
#                                              "[1.00e+05,1.00e+06)",
#                                              "[1.00e+06,1.00e+07)",
#                                              "[1.00e+07,7.50e+07)"))){
#       def$qHighCeiling<-factor(def$qHighCeiling,
# 
#                                     levels=c("[0.00e+00,1.50e+04)",
#                                              "[1.50e+04,1.00e+05)",
#                                              "[1.00e+05,1.00e+06)",
#                                              "[1.00e+06,1.00e+07)",
#                                              "[1.00e+07,7.50e+07)",
#                                              levels(term$qHighCeiling)[6]),
#                                     labels=c("[0,15k)",
#                                              "[15k,100k)",
#                                              "[100k,1m)",
#                                              "[1m,10m)",
#                                              "[10m,75m)",
#                                              "[75m+]"),
#                                     ordered=TRUE)
#   }
#Removing l_s just to reduce size. They can be derived easily.

# load("..//Output//naics_join.Rdata")



```