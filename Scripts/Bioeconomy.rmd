---
title: "Bioeconomy"
author: "Greg Sanders"
date: "5/7/2021"
output: html_document
---

```{r setup, include=FALSE}
library(csis360)
library(readr)
library(tidyr)
library(ggplot2)
load(file="../data/Clean/BioEconomy.Rda")
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

## Bioeconomy

```{r Biotechnology}



bio_data$NASbioEconomyPretty<-factor(bio_data$NASbioEconomy,
                              levels=c("Biobased plastic products","Bioeconomy R&D services","Biofuels (ethanol)", "Biologics (enzymes)",
                                       "Biopharmaceuticals/Other pharmaceuticals","Biorefining (food)",
                                       "Crop products","Electromedical instruments","Surgical and Medical Equipment",
                                       "Other biobased chemicals","Other enzymes" ,"NULL" ),
                              labels=c("Biobased plastic\nproducts","Bioeconomy\nR&D services","Biofuels (ethanol)", "Biologics (enzymes)",
                                       "Biopharmaceuticals\n/Other pharmaceuticals","Biorefining (food)",
                                       "Crop products","Electromedical\ninstruments","Surgical and\nMedical Equipment",
                                       "Other biobased\nchemicals","Other enzymes" ,"Bioproduct Outside\nNAS chosen codes")
                              )
bio_data$NASbioEconomyTrans<-factor(bio_data$NASbioEconomy,
                              levels=c("Biobased plastic products","Bioeconomy R&D services","Biofuels (ethanol)", "Biologics (enzymes)",
                                       "Biopharmaceuticals/Other pharmaceuticals","Biorefining (food)",
                                       "Crop products","Electromedical instruments","Surgical and Medical Equipment",
                                       "Other biobased chemicals","Other enzymes" ,"NULL" ),
                              labels=c("Plastic and Rubber\nManufacturing","R&D services\n(Excluding Nanotech)","Fuel Refineries\n(incl. ethanol)", "Biological Product\nManufacturing",
                                       "Pharmaceuticals Prep\nManufacturing","Potential\nBiorefining (food)",
                                       "Crop products","Electromedical\ninstruments","Surgical and\nMedical Equipment",
                                       "Potential biobased\nchemicals. ","Other enzymes" ,"Bioproduct Outside\nNAS chosen codes")
                              )

(all<-build_plot(bio_data,
           x_var="Fiscal.Year",
           y_var="Action_Obligation_OMB20_GDP20",
           color_var="NASbioEconomypt",
           chart_geom="Bar Chart",
           facet_var="NASbioEconomyPretty",
           format=TRUE)+facet_wrap(~NASbioEconomyPretty,scales="free_y")
)
ggsave(file=file.path("..","Output","NASbioEconomy_all.png"))


(all<-build_plot(bio_data %>% dplyr::filter(!is.na(NASbioEconomy)),
           x_var="Fiscal.Year",
           y_var="Action_Obligation_OMB20_GDP20",
           color_var="NASbioEconomypt",
           chart_geom="Bar Chart",
           facet_var="NASbioEconomyTrans",
           format=TRUE)+facet_wrap(~NASbioEconomyTrans,scales="free_y")
)+scale_x_continuous(breaks=c(2000,2010,2020))+labs(main="NAICS Codes in NAS categories",
                             y="Obligated Amount (2020 Constant $)",
                             x="Fiscal Year")
ggsave(file=file.path("..","Output","NASbioEconomy_all.png"))

summary(bio_data$biobased)

(full<-build_plot(bio_data %>% dplyr::filter(NASbioEconomypt=="NAICS Partial Code"),
           x_var="Fiscal.Year",
           y_var="Action_Obligation_OMB20_GDP20",
           color_var="NASbioEconomyPretty",
           chart_geom="Bar Chart",
           facet_var="NASbioEconomyPretty",
           format=TRUE)
)
ggsave(file=file.path("..","Output","NASbioEconomy_full.png"))



build_plot(bio_data %>% dplyr::filter(NASbioEconomypt=="NAICS Partial Code"),
           x_var="Fiscal.Year",
           y_var="Action_Obligation_OMB20_GDP20",
           color_var="biobased",
           chart_geom="Bar Chart",
           facet_var="biobased",
           format=TRUE)

```

## Research

### Biotechnology customer

You can also embed plots, for example:

```{r pressure, echo=FALSE}
bio_data$BioTechCustomer<-factor(bio_data$ContractingCustomer)
levels(bio_data$BioTechCustomer)<-
  list(
    "HHS"    ="HHS"    ,
    "Energy"="Energy",
    "VA"="VA",
    "Defense"="Defense",
    "DHS"="DHS",
    "Other Agencies"=c("GSA","NASA",
                       "NATIONAL ENDOWMENT FOR THE HUMANITIES","Other Agencies",
                       "State and IAP","UNITED STATES INTERNATIONAL DEVELOPMENT FINANCE CO"   ))
bio_data$EnzymeCustomer<-factor(bio_data$ContractingCustomer)
levels(bio_data$EnzymeCustomer)<-
  list(
    "HHS"    ="HHS"    ,
    "VA"="VA",
    "Defense"="Defense",
    "Other Agencies"=c("GSA","NASA","DHS","Energy",
                       "NATIONAL ENDOWMENT FOR THE HUMANITIES","Other Agencies",
                       "State and IAP","UNITED STATES INTERNATIONAL DEVELOPMENT FINANCE CO"   ))

summary(bio_data$EnzymeCustomer)

(a<-    build_plot(bio_data %>% dplyr::filter(NASbioEconomypt=="Other NAICS Code"&
                                       NASbioEconomy=="Bioeconomy R&D services"&
                                         Fiscal.Year>=2008),
           x_var="Fiscal.Year",
           y_var="Action_Obligation_OMB20_GDP20",
           color_var="BioTechCustomer",
           chart_geom="Bar Chart",
           facet_var="BioTechCustomer",
           format=TRUE)+labs(main="Research and Development in Biotechnology",
                             y="Obligated Amount (2020 Constant $)",
                             x="Fiscal Year")+
  theme(legend.position = "None")
)
ggsave(a,file=file.path("..","Output","Biotechnology_Customer.png"))

(a<-    build_plot(bio_data %>% dplyr::filter(#NASbioEconomypt=="Other NAICS Code"&
                                       NASbioEconomy=="Biologics (enzymes)"),
           x_var="Fiscal.Year",
           y_var="Action_Obligation_OMB20_GDP20",
           color_var="EnzymeCustomer",
           chart_geom="Bar Chart",
           facet_var="EnzymeCustomer",
           format=TRUE)+labs(main="Biological (enzymes)",
                             y="Obligated Amount (2020 Constant $),\n Variable Scale",
                             x="Fiscal Year")+facet_wrap(~EnzymeCustomer, scales="free_y")+
  theme(legend.position = "None")
)
ggsave(a,file=file.path("..","Output","Biotproduct_Customer.png"))





(a<-    build_plot(bio_data %>% dplyr::filter(#NASbioEconomypt=="Other NAICS Code"&
                                       NASbioEconomy %in% c("Biologics (enzymes)",
                                       "Biopharmaceuticals/Other pharmaceuticals","Biorefining (food)",
                                       "Crop products","Electromedical instruments","Surgical and Medical Equipment",
                                       "Other biobased chemicals","Other enzymes" )),
           x_var="Fiscal.Year",
           y_var="Action_Obligation_OMB20_GDP20",
           color_var="EnzymeCustomer",
           chart_geom="Bar Chart",
           facet_var="NASbioEconomyTrans",
           format=TRUE)+labs(main="Biological (enzymes)",
                             y="Obligated Amount (2020 Constant $),\n Variable Scale",
                             x="Fiscal Year")+facet_wrap(~NASbioEconomyTrans, scales="free_y",ncol=4)+
  theme(legend.position = "bottom")
)
ggsave(a,file=file.path("..","Output","Bioproduct_Customer.png"))
```
### Life sciences

You can also embed plots, for example:

```{r pressure, echo=FALSE}
summary(factor(bio_data$BioRelated[bio_data$NASbioEconomy=="Bioeconomy R&D services"]))
summary(factor(bio_data$ProductOrServiceCodeText[bio_data$NASbioEconomy=="Bioeconomy R&D services"&
                                                   bio_data$BioRelated=="Bioeconomy"]))


bio_data$LifeScience<-bio_data$BioRelated
bio_data$LifeScience[bio_data$NASbioEconomy=="Bioeconomy R&D services"&
                                                bio_data$NASbioEconomypt=="Other NAICS Code"]<-
  "Biotechnology"
bio_data$LifeScience<-factor(bio_data$LifeScience)
levels(bio_data$LifeScience)<-list("Agricultural Sciences"="Agricultural Sciences",
               "Biomedical and Drugs/Biologicals"="Bioeconomy",
               "Biotechnology"="Biotechnology",
               "Other Medical"="Medical",
               "Other Life Sciences"="Life Sciences")

(a<-    build_plot(bio_data %>% dplyr::filter(NASbioEconomy=="Bioeconomy R&D services"&
                                                (NASbioEconomypt=="Other NAICS Code" |
                                                   !is.na(BioRelated))# &
                                       
                                         # Fiscal.Year>=2008
                                           ),
           x_var="Fiscal.Year",
           y_var="Action_Obligation_OMB20_GDP20",
           color_var="BioTechCustomer",
           chart_geom="Bar Chart",
           facet_var="BioTechCustomer",
           format=TRUE)+labs(main="Research and Development in Life Sciences and Biotechnology",
                             y="Obligated Amount (2020 Constant $)",
                             x="Fiscal Year")+
  theme(legend.position = "None")
)
ggsave(a,file=file.path("..","Output","Life_Science_Customer.png"))

(a<-    build_plot(bio_data %>% dplyr::filter(NASbioEconomy=="Bioeconomy R&D services"&
                                                (NASbioEconomypt=="Other NAICS Code" |
                                                   !is.na(BioRelated))# &
                                       
                                         # Fiscal.Year>=2008
                                           ),
           x_var="Fiscal.Year",
           y_var="Action_Obligation_OMB20_GDP20",
           color_var="LifeScience",
           chart_geom="Bar Chart",
           facet_var="BioTechCustomer",
           format=TRUE)+labs(main="Research and Development in Life Sciences and Biotechnology",
                             y="Contract Obligated Amount (2020 Constant $)",
                             x="Fiscal Year")#+
  # theme(legend.position = "None")
)
ggsave(a,file=file.path("..","Output","Life_Science_Customer.png"))

bio_data$ProductOrServiceCodeText
write.csv(file="..\\output\\GeneralRnDprodcodes.csv",
bio_data %>% filter(NASbioEconomy=="Bioeconomy R&D services"&
                                                NASbioEconomypt!="Other NAICS Code" )%>%
  group_by(productorservicecode,ProductOrServiceCodeText,BioRelated)%>%
  summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20,na.rm=TRUE))
)

```


## BioBased
```{r biobased}
summary(bio_data$biobased)
(a<-    build_plot(bio_data %>% dplyr::filter(biobased=="Biobased"),
           x_var="Fiscal.Year",
           y_var="Action_Obligation_OMB20_GDP20",
           color_var="ContractingCustomer",
           chart_geom="Bar Chart",
           facet_var="ContractingCustomer",
           format=TRUE)+labs(main="Biobased Products",
                             y="Obligated Amount (2020 Constant $),\n Variable Scale",
                             x="Fiscal Year")+#+facet_wrap(~EnzymeCustomer, scales="free_y")+
  theme(legend.position = "None")+facet_wrap(~ContractingCustomer,ncol=5)
+scale_x_continuous(breaks=c(2013,2017,2020)))
ggsave(a,file=file.path("..","Output","Biobased_Customer.png"))
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

#NCES
```{r life rnd}
colnames(life_rnd)[colnames(life_rnd)=="[Broad Fields]"]<-"BroadFields"
life_rnd$Fiscal.Year<-text_to_number(life_rnd$Fiscal.Year)

bf<-format_data_for_plot(life_rnd,
                     fy_var="Fiscal.Year",
                     y_var="value_OMB20_GDP20",
                     color_var="BroadFields"
)                     
# The palette with grey:
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

levels(bf$BroadFields)

(
a<-ggplot(bf %>% filter(BroadFields!="Biological aspects"), aes(x=Fiscal.Year,y=value_OMB20_GDP20,fill=BroadFields))+geom_col()+scale_fill_manual(values=cbPalette)+labs(
  x="Fiscal Year",y="Federal Obligations for R&D\n(thousands, constant 2020 $)",caption="Source: National Center for Science and Engineering Statistics",fill="Broad Field"
)+scale_x_continuous(n.breaks=7)+scale_y_continuous(label=scales::comma)
)
ggsave(a,file=file.path("..","output","NCSES_funds.png"))

```