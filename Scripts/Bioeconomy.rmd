---
title: "Bioeconomy"
author: "Greg Sanders"
date: "5/7/2021"
output: html_document
---

```{r setup, include=FALSE}
library(csis360)
library(readr)
library(tidyr)
library(ggplot2)
bioecon<-read_delim(file.path("..","data","semi_clean","Economic.SP_NASbioeconomy.txt"),delim="\t",na=c("NULL","NA"))
colnames(bioecon)[colnames(bioecon)=="value"]<-"Action_Obligation_OMB20_GDP20"
#kludge while I redownload
# bioecon<-bioecon %>% dplyr::filter(ProductOrServiceCodeText!="GUIDED MISSILE COMPONENTS"|principalnaicscode!=541714)
bioecon<-standardize_variable_names(bioecon)
# lc<-prepare_labels_and_colors(bioecon)
  # bioecon<-read_and_join_experiment(bioecon,
  #                                         lookup_file = "Lookup_PrincipalNAICScode.csv",
  #                                         path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
  #                                         dir="economic\\",
  #                              by=c("NAICS_Code"="principalnaicscode"),
  #                              add_var=c("principalnaicscodeText","NAICS_shorthand"),
  #                              skip_check_var=c("principalnaicscodeText","NAICS_shorthand")

bioecon$NASbioEconomy[bioecon$principalnaicscode=="339112"]<-"Surgical and Medical Equipment"

bioecon$biobased<-factor(bioecon$biobased)
levels(bioecon$biobased)<-list("Biobased"="1","Not Biobased"="0")
summary(bioecon$biobased)

bioecon$NASbioEconomypt<-factor(bioecon$NASbioEconomypt)



bioecon$NASbioEconomypt[bioecon$NASbioEconomy %in% c("Biorefining (food)",
                                       "Crop products")]<-0
levels(bioecon$NASbioEconomypt)<-list("NAICS Partial Code"="1","Other NAICS Code"="0")


summary(bioecon$NASbioEconomypt)
  # bioecon<-read_and_join_experiment(bioecon,
  #                                         lookup_file = "Lookup_PrincipalNAICScode.csv",
  #                                         path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
  #                                         dir="economic\\",
  #                              by=c("NAICS_Code"="principalnaicscode"),
  #                              add_var=c("principalnaicscodeText","NAICS_shorthand"),
  #                              skip_check_var=c("principalnaicscodeText","NAICS_shorthand"))
bioecon<-deflate(bioecon,
                   money_var = "Action_Obligation",
                   deflator_var="OMB20_GDP20"
)
# bioecon 
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r Biotechnology}



bioecon$NASbioEconomyPretty<-factor(bioecon$NASbioEconomy,
                              levels=c("Biobased plastic products","Bioeconomy R&D services","Biofuels (ethanol)", "Biologics (enzymes)",
                                       "Biopharmaceuticals/Other pharmaceuticals","Biorefining (food)",
                                       "Crop products","Electromedical instruments","Surgical and Medical Equipment",
                                       "Other biobased chemicals","Other enzymes" ,"NULL" ),
                              labels=c("Biobased plastic\nproducts","Bioeconomy\nR&D services","Biofuels (ethanol)", "Biologics (enzymes)",
                                       "Biopharmaceuticals\n/Other pharmaceuticals","Biorefining (food)",
                                       "Crop products","Electromedical\ninstruments","Surgical and\nMedical Equipment",
                                       "Other biobased\nchemicals","Other enzymes" ,"Bioproduct Outside\nNAS chosen codes")
                              )
bioecon$NASbioEconomyTrans<-factor(bioecon$NASbioEconomy,
                              levels=c("Biobased plastic products","Bioeconomy R&D services","Biofuels (ethanol)", "Biologics (enzymes)",
                                       "Biopharmaceuticals/Other pharmaceuticals","Biorefining (food)",
                                       "Crop products","Electromedical instruments","Surgical and Medical Equipment",
                                       "Other biobased chemicals","Other enzymes" ,"NULL" ),
                              labels=c("Plastic and Rubber\nManufacturing","R&D services\n(Excluding Nanotech)","Fuel Refineries\n(incl. ethanol)", "Biological Product\nManufacturing",
                                       "Pharmaceuticals Prep\nManufacturing","Potential\nBiorefining (food)",
                                       "Crop products","Electromedical\ninstruments","Surgical and\nMedical Equipment",
                                       "Potential biobased\nchemicals. ","Other enzymes" ,"Bioproduct Outside\nNAS chosen codes")
                              )

(all<-build_plot(bioecon,
           x_var="Fiscal.Year",
           y_var="Action_Obligation_OMB20_GDP20",
           color_var="NASbioEconomypt",
           chart_geom="Bar Chart",
           facet_var="NASbioEconomyPretty",
           format=TRUE)+facet_wrap(~NASbioEconomyPretty,scales="free_y")
)
ggsave(file=file.path("..","Output","NASbioEconomy_all.png"))


(all<-build_plot(bioecon %>% dplyr::filter(!is.na(NASbioEconomy)),
           x_var="Fiscal.Year",
           y_var="Action_Obligation_OMB20_GDP20",
           color_var="NASbioEconomypt",
           chart_geom="Bar Chart",
           facet_var="NASbioEconomyTrans",
           format=TRUE)+facet_wrap(~NASbioEconomyTrans,scales="free_y")
)+scale_x_continuous(breaks=c(2000,2010,2020))+labs(main="NAICS Codes in NAS categories",
                             y="Obligated Amount (2020 Constant $)",
                             x="Fiscal Year")
ggsave(file=file.path("..","Output","NASbioEconomy_all.png"))

summary(bioecon$biobased)

(full<-build_plot(bioecon %>% dplyr::filter(NASbioEconomypt=="NAICSpt Code"),
           x_var="Fiscal.Year",
           y_var="Action_Obligation_OMB20_GDP20",
           color_var="NASbioEconomyPretty",
           chart_geom="Bar Chart",
           facet_var="NASbioEconomyPretty",
           format=TRUE)
)
ggsave(file=file.path("..","Output","NASbioEconomy_full.png"))



build_plot(bioecon %>% dplyr::filter(NASbioEconomypt=="NAICSpt Code"),
           x_var="Fiscal.Year",
           y_var="Action_Obligation_OMB20_GDP20",
           color_var="biobased",
           chart_geom="Bar Chart",
           facet_var="biobased",
           format=TRUE)

```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
bioecon$BioTechCustomer<-factor(bioecon$ContractingCustomer)
levels(bioecon$BioTechCustomer)<-
  list(
    "HHS"    ="HHS"    ,
    "Energy"="Energy",
    "VA"="VA",
    "Defense"="Defense",
    "DHS"="DHS",
    "Other Agencies"=c("GSA","NASA",
                       "NATIONAL ENDOWMENT FOR THE HUMANITIES","Other Agencies",
                       "State and IAP","UNITED STATES INTERNATIONAL DEVELOPMENT FINANCE CO"   ))
bioecon$EnzymeCustomer<-factor(bioecon$ContractingCustomer)
levels(bioecon$EnzymeCustomer)<-
  list(
    "HHS"    ="HHS"    ,
    "VA"="VA",
    "Defense"="Defense",
    "Other Agencies"=c("GSA","NASA","DHS","Energy",
                       "NATIONAL ENDOWMENT FOR THE HUMANITIES","Other Agencies",
                       "State and IAP","UNITED STATES INTERNATIONAL DEVELOPMENT FINANCE CO"   ))

summary(bioecon$EnzymeCustomer)

(a<-    build_plot(bioecon %>% dplyr::filter(NASbioEconomypt=="NAICS entire code"&
                                       NASbioEconomy=="Bioeconomy R&D services"&
                                         Fiscal.Year>=2008),
           x_var="Fiscal.Year",
           y_var="Action_Obligation_OMB20_GDP20",
           color_var="BioTechCustomer",
           chart_geom="Bar Chart",
           facet_var="BioTechCustomer",
           format=TRUE)+labs(main="Research and Development in Biotechnology",
                             y="Obligated Amount (2020 Constant $)",
                             x="Fiscal Year")+
  theme(legend.position = "None")
)
ggsave(a,file=file.path("..","Output","Biotechnology_Customer.png"))

(a<-    build_plot(bioecon %>% dplyr::filter(#NASbioEconomypt=="NAICS entire code"&
                                       NASbioEconomy=="Biologics (enzymes)"),
           x_var="Fiscal.Year",
           y_var="Action_Obligation_OMB20_GDP20",
           color_var="EnzymeCustomer",
           chart_geom="Bar Chart",
           facet_var="EnzymeCustomer",
           format=TRUE)+labs(main="Biological (enzymes)",
                             y="Obligated Amount (2020 Constant $),\n Variable Scale",
                             x="Fiscal Year")+facet_wrap(~EnzymeCustomer, scales="free_y")+
  theme(legend.position = "None")
)
ggsave(a,file=file.path("..","Output","Biotproduct_Customer.png"))





(a<-    build_plot(bioecon %>% dplyr::filter(#NASbioEconomypt=="NAICS entire code"&
                                       NASbioEconomy %in% c("Biologics (enzymes)",
                                       "Biopharmaceuticals/Other pharmaceuticals","Biorefining (food)",
                                       "Crop products","Electromedical instruments","Surgical and Medical Equipment",
                                       "Other biobased chemicals","Other enzymes" )),
           x_var="Fiscal.Year",
           y_var="Action_Obligation_OMB20_GDP20",
           color_var="EnzymeCustomer",
           chart_geom="Bar Chart",
           facet_var="NASbioEconomyTrans",
           format=TRUE)+labs(main="Biological (enzymes)",
                             y="Obligated Amount (2020 Constant $),\n Variable Scale",
                             x="Fiscal Year")+facet_wrap(~NASbioEconomyTrans, scales="free_y",ncol=4)+
  theme(legend.position = "bottom")
)
ggsave(a,file=file.path("..","Output","Bioproduct_Customer.png"))
```


```{r biobased}
summary(bioecon$biobased)
(a<-    build_plot(bioecon %>% dplyr::filter(biobased=="Biobased"),
           x_var="Fiscal.Year",
           y_var="Action_Obligation_OMB20_GDP20",
           color_var="ContractingCustomer",
           chart_geom="Bar Chart",
           facet_var="ContractingCustomer",
           format=TRUE)+labs(main="Biobased Products",
                             y="Obligated Amount (2020 Constant $),\n Variable Scale",
                             x="Fiscal Year")+#+facet_wrap(~EnzymeCustomer, scales="free_y")+
  theme(legend.position = "None")+facet_wrap(~ContractingCustomer,ncol=5)
+scale_x_continuous(breaks=c(2013,2017,2020)))
ggsave(a,file=file.path("..","Output","Biobased_Customer.png"))
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
