---
title: "UAS Text Label"
author: "Greg Sanders"
date: "2022-07-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(RTextTools)
library(readr)
library(csis360)
library(dplyr)

library(tidyr)


OTA_data_current <- read_delim(
  "..//data_raw//OTA_All_Fields.csv",delim = ",",
  col_names = TRUE, guess_max = 500000,na=c("NA","NULL"),skip = 2)



OTA_data_current<-standardize_variable_names(OTA_data_current)

descrip<-data.frame(Description_of_Requirement=unique(OTA_data_current$Description_of_Requirement))

#Create the descrip_row_number 
descrip$descrip_row_number<-seq(1,nrow(descrip))

# descrip<-descrip%>%mutate(descrip_hasp=rlang::hash(descrip$Description_of_Requirement))
#Write the file preserving descrip_row_number (leave this one alone)
write_delim(descrip,file="..//data_raw//OTA_descrip_row_number.csv",delim = ",")#,fileEncoding = "UTF-16LE")
#Add the descrip_row_number back to the main dataframe
OTA_data_current<-read_and_join_experiment(OTA_data_current,
                         path="..//data_raw//",dir="",lookup_file = "OTA_descrip_row_number.csv",
                         add_var="descrip_row_number",
                         # skip_check_var = "Remotely_Crewed",
                         by="Description_of_Requirement")

#I have tested this, importing into excel and saving or importing into google sheets and savings seems to corrupt matters.
#Through dropping of quotes or the like.



OTA_data_current<-read_and_join_experiment(OTA_data_current,
                         path="..//data_raw//",dir="",lookup_file = "OTA_descrip_row_number.csv",
                         add_var="descrip_row_number",
                         # skip_check_var = "Remotely_Crewed",
                         by="Description_of_Requirement")

summary(OTA_data_current$descrip_row_number)

#Instead, adding am auto_number so we can join on that rather than these complex text strings
#IDeally we'd use a reproducible hash, but oen problem at a time.

d<-read_and_join_experiment(descrip,
                         path="..//data//semi_clean//",dir="",lookup_file = "ota_description_UAS.txt",
                         add_var="Remotely_Crewed",
                         # skip_check_var = "Remotely_Crewed",
                         by="Description_of_Requirement")

m<-read_csv(file.path("..","data","semi_clean","contract_MajorProgramCode.csv"))


write_delim(d,file.path("..","data","semi_clean","ota_description_UAS.csv"),na = "",delim=",")
```

# Setup

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

### OTA description UAS labeling

```{r setup}

d<-read_delim(file.path("..","data","semi_clean","ota_description_UAS.csv"),na ="",col_types="ccccc",delim=",")
problems(d)
d<-standardize_variable_names(d)

label_UAS<-function(x,col="Description_of_Requirement"){
  x<-as.data.frame(x)
  # grep("UAS|Unmanned|Uninhabited|Uncrewed|Remotely Crewed",x$Description_of_Requirement)
  x$UAS<-NA
  x$CUAS<-NA
  x$Maritime<-NA
  x$mq<-NA
  x$rq<-NA
  x$UAS[grep("UAS",x[,col])]<-TRUE
  sum(x$UAS,na.rm=TRUE)
  
  x$UAS[grep("QUASAR",x[,col])]<-NA
  x$UAS[grep("QUASI",x[,col])]<-NA
  sum(x$UAS,na.rm=TRUE)
  x$UAS[grep("UAV",x[,col])]<-TRUE
  sum(x$UAS,na.rm=TRUE)
  x$UAS[grep("Unmanned",x[,col],ignore.case = TRUE)]<-TRUE
  sum(x$UAS,na.rm=TRUE)
  x$UAS[grep("Remotely Crewed",x[,col],ignore.case = TRUE)]<-TRUE
  sum(x$UAS,na.rm=TRUE)
  x$UAS[grep("Remotely Piloted",x[,col],ignore.case = TRUE)]<-TRUE
  sum(x$UAS,na.rm=TRUE)
  x$UAS[grep("RPS",x[,col],ignore.case = TRUE)]<-TRUE
  sum(x$UAS,na.rm=TRUE)
  x$UAS[grep("Uninhabited",x[,col],ignore.case = TRUE)]<-TRUE
  sum(x$UAS,na.rm=TRUE)
  
  x$UAS[grep("Uncrewed",x[,col],ignore.case = TRUE)]<-TRUE
  sum(x$UAS,na.rm=TRUE)
  
  # Excluding Counter UAS
  x$CUAS[grep("Counter Unmanned",x[,col],ignore.case = TRUE)]<-TRUE
  sum(x$CUAS,na.rm=TRUE)
  x$CUAS[grep("C-UAS",x[,col],ignore.case = TRUE)]<-TRUE
  x$CUAS[grep("CSUAS",x[,col],ignore.case = TRUE)]<-TRUE
  x$CUAS[grep("Counter UAS",x[,col],ignore.case = TRUE)]<-TRUE
  x$CUAS[grep("Counter-UAS",x[,col],ignore.case = TRUE)]<-TRUE
  
  x$CUAS[grep("Counter-Unmanned",x[,col],ignore.case = TRUE)]<-TRUE
  sum(x$CUAS,na.rm=TRUE)
  
  
  x$Maritime[grep("Unmanned Surface",x[,col],ignore.case = TRUE)]<-TRUE
  x$Maritime[grep("Unmanned Maritime",x[,col],ignore.case = TRUE)]<-TRUE
  
  x$Maritime[grep("UNDERWATER UNMANNED",x[,col],ignore.case = TRUE)]<-TRUE
  x$Maritime[grep("UNMANNED UNDERWATER",x[,col],ignore.case = TRUE)]<-TRUE
  
  x$Maritime[grep("UNMANNED UNDERSEA",x[,col],ignore.case = TRUE)]<-TRUE
  sum(x$CUAS,na.rm=TRUE)
  
  
  x$UAS[x$CUAS==TRUE]<-NA
  
  x$UAS[x$Maritime==TRUE]<-NA
  sum(x$UAS,na.rm=TRUE)
  
  
  
  x$mq[grep("MQ",x[,col],ignore.case = TRUE)]
  x$mq[grep("MQT",x[,col],ignore.case = TRUE)]<-NA
  sum(x$mq,na.rm = TRUE)
  x$rq[grep("RQ",x[,col],ignore.case = TRUE)]
  x$rq[grep("SRQ",x[,col],ignore.case = TRUE)]<-NA
  sum(x$rq,na.rm=TRUE)
  
  x$any_uas<-NA
  x$any_uas<-x$UAS|x$mq|x$rq
  x
}


d<-label_UAS(d,"Description_of_Requirement")
m<-label_UAS(m,"majorprogramcode")

write_delim(d,file.path("..","data","semi_clean","ota_description_UAS.csv"),na = "",delim=",")
write_delim(m,file.path("..","data","semi_clean","contract_MajorProgramCode.csv"),na = "",delim=",")

#UUVSS maritime
#MORFIUS counter-uas uas
#SUAS Small uas
```

### Expanding labels to contracs

You can also embed plots, for example:

```{r contract_expansion}

OTA_data_current <- read_delim(
  "..//data_raw//OTA_All_Fields.csv",delim = ",",
  col_names = TRUE, guess_max = 500000,na=c("NA","NULL"),skip = 2)
OTA_data_current<-standardize_variable_names(OTA_data_current)

OTA_data_current<-read_and_join_experiment(OTA_data_current,
                         path="..//data_raw//",dir="",lookup_file = "OTA_descrip_row_number.csv",
                         add_var="descrip_row_number",
                         # skip_check_var = "Remotely_Crewed",
                         by="Description_of_Requirement")

OTA_data_current<-read_and_join_experiment(OTA_data_current,
                         path="..//data//semi_clean//",dir="",lookup_file = "ota_description_UAS.csv",
                         add_var="Remotely_Crewed",
                         # skip_check_var = "Remotely_Crewed",
                         by="descrip_row_number",
                         col_types = "cnccccccccc")

OTA_data_current$Remotely_Crewed[OTA_data_current$Remotely_Crewed %in% c("","FALSE")]<-NA


sum(text_to_number(OTA_data_current$Action_Obligation)[OTA_data_current$Remotely_Crewed %in% c("UAS","UAS/C-UAS")])


#This is incredibly slow ~20m, perhaps because of all the warning it prints.
# OTA_data_current<-OTA_data_current %>% group_by(`PIIDAgencyID`,PIID,`ReferencedIDVAgencyID`,Referenced_IDV_PIID) %>%
#   mutate(max_rc=max(Remotely_Crewed,na.rm=TRUE),
#          min_rc=min(Remotely_Crewed,na.rm=TRUE))

Remotely_Crewed_CAU<-OTA_data_current %>% filter(Remotely_Crewed %in% c("UAS","UAS/C-UAS"))%>%
  group_by(PIIDAgencyID,PIID,ReferencedIDVAgencyID,Referenced_IDV_PIID,
           Remotely_Crewed) %>% dplyr::summarise()

Remotely_Crewed_CAU$ReferencedIDVAgencyID[is.na(Remotely_Crewed_CAU$ReferencedIDVAgencyID)]<-""

# Training and Readiness Accelerator (TReX) does include UAS, but is a  broader OTA.
Remotely_Crewed_CAU<-Remotely_Crewed_CAU %>% filter(PIID!="W900KK1890005") 

colnames(Remotely_Crewed_CAU)[colnames(Remotely_Crewed_CAU)=="Remotely_Crewed"]<-"Remotely_Crewed_CAU"
write_csv(Remotely_Crewed_CAU,file.path("..","data","semi_clean","ota_CAU_UAS.csv"))


# 
# write.csv(OTA_data_current %>% select(`PIIDAgencyID`,PIID,`ReferencedIDVAgencyID`,Referenced_IDV_PIID,
#                                  Description_of_Requirement,Remotely_Crewed,max_rc,min_rc,Action_Obligation)
#      %>% filter(max_rc=='UAS'|min_rc=="UAS"),"CUA_OTA_check.csv")
# 
# 
# write.csv(OTA_data_current %>% select(`PIIDAgencyID`,PIID,`ReferencedIDVAgencyID`,Referenced_IDV_PIID,
#                                  Description_of_Requirement,Remotely_Crewed,max_rc,min_rc,Action_Obligation,
#                                  ProductOrServiceCode)
#      %>% filter(!is.na(max_rc) | ProductOrServiceCode=="1550"),"CUA_OTA_rc_check.csv")
# 
# summary(factor(OTA_data_current$Remotely_Crewed[OTA_data_current$ProductOrServiceCode=="1550"]))



```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

# Test labeling language
```{r OTA_UAS_test}

OTA_data_current <- read_delim(
  "..//data_raw//OTA_All_Fields.csv",delim = ",",
  col_names = TRUE, guess_max = 500000,na=c("NA","NULL"),skip = 2)
OTA_data_current<-standardize_variable_names(OTA_data_current)
OTA_data_current<-apply_standard_lookups(OTA_data_current)

OTA_data_current$IsRemotelyOperated<-FALSE
OTA_data_current$IsRemotelyOperated[OTA_data_current$ProductOrServiceCode=="1550"]<-TRUE
sum(OTA_data_current$Action_Obligation_OMB23_GDP21[OTA_data_current$IsRemotelyOperated],na.rm=TRUE)

OTA_data_current<-read_and_join_experiment(OTA_data_current,
                         path="..//data_raw//",dir="",lookup_file = "OTA_descrip_row_number.csv",
                         add_var="descrip_row_number",
                         # skip_check_var = "Remotely_Crewed",
                         by="Description_of_Requirement")

OTA_data_current<-read_and_join_experiment(OTA_data_current,
                         path="..//data//semi_clean//",dir="",lookup_file = "ota_description_UAS.csv",
                         add_var="Remotely_Crewed",
                         # skip_check_var = "Remotely_Crewed",
                         by="descrip_row_number",
                         col_types = "cnccccccccc")

OTA_data_current$IsRemotelyOperated[OTA_data_current$Remotely_Crewed %in% c("UAS","UAS/C-UAS")]<-TRUE
sum(OTA_data_current$Action_Obligation_OMB23_GDP21[OTA_data_current$IsRemotelyOperated],na.rm=TRUE)

OTA_data_current$`ReferencedIDVAgencyID`[is.na(OTA_data_current$`ReferencedIDVAgencyID`)]<-""
OTA_data_current<-read_and_join_experiment(OTA_data_current,
                         path="..//data//semi_clean//",dir="",lookup_file = "ota_CAU_UAS.csv",
                         add_var="Remotely_Crewed_CAU",
                         skip_check_var = "Remotely_Crewed_CAU",
                         by=c("PIIDAgencyID","PIID","ReferencedIDVAgencyID","Referenced_IDV_PIID"),col_types="dcccc")

summary(factor(OTA_data_current$Remotely_Crewed_CAU))


OTA_data_current$IsRemotelyOperated[OTA_data_current$Remotely_Crewed_CAU %in% c("UAS","UAS/C-UAS")]<-TRUE

sum(OTA_data_current$Action_Obligation_OMB23_GDP21[OTA_data_current$IsRemotelyOperated],na.rm=TRUE)


```