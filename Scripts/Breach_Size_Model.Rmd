---
title: "Contract Termination"
author: "Greg Sanders"
date: "Wednesday, February 8, 2017"
output:
  html_document:
    keep_md: yes
--- 

Modeling Likelihood of Contract Termination
============================================================================

#Setup
```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(arm)
library(R2WinBUGS)
library(Hmisc)
library(sjstats)
source("DIIGstat.r")
source("NAICS.r")

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40

```

Contracts are classified using a mix of numerical and categorical variables. While the changes in numerical variables are easy to grasp and summarize, a contract may have one line item that is competed and another that is not. As is detailed in the exploration on R&D, we are only considering information available prior to contract start. The percentage of contract obligations that were competed is a valuable benchmark, but is highly influenced by factors that occured after contract start.

##Prepare Data

First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from   FPDS.


###Data Transformations and Sample Loading 

The final sample uses 1 million rows of data, but as a computation shortcut, only a subset of the data is needed to allow for processing of models in minutes rather than hours.

```{r ReadInData, echo = TRUE}
load(file="Data/transformed_def.Rdata")
load(file="data//def_sample.Rdata")
```

### Contract Ceiling Breaches

Contract Ceiling Breaches and the number of change orders can be calculated for the entire sample.  Change orders are determined using the *Reason for Modification* field in FPDS. 


#Level-1 Regression Model

##Study Variable: Competition
Competition has the potential to reduce terminations by giving the government more options in vendors and encouraging better behavior from the contractor that was chosen. 

###Model 01A: No Competition / Number of Offer Categories 

```{r Model01A_CBre}

#Frequency Plot
summary_discrete_plot(smp,"CompOffr")

#Model
CBre_Comp_01A <- glm (data=smp,
                 l_CBre ~ CompOffr)
summary(CBre_Comp_01A)

```

As measured by residual deviance, this variable has slightly less predictive power than random noise. That can likely be attributed to the fact that 5+ offers category has a higher termination rate than 2 and 3-4. In theory, this could be because of non-liner relationship, for example higher number of offers competition may be more vulnerable to aggressive bidding beavior. However, this explaination would likely be better captured by other hidden variables such as competition methods rather than having a direct relationship with an increased number of offers. As a result, we are not testing offers as a categorical variable with dummies. 

Instead, the last variant to be checked is the number of offers directly. This is handled logarithmicly because the differences between number of offers at the bottom end of the scale mtters much more than at the high end of the scale. In this method, contracts that were not open to competition are grouped with contracts that received only a single offer.


Closer examination further undercuts the idea that more offers is associated with a lower termination risk. As measured by deviance, the number offers adds less to the model than random noise. A quick experiment also found that use of number of offer squared only made the model slightly better than noise.

A variety of binned percent terminated graphs found that in the middle range of the number of offers, there is often an increase in the percent terminated. The study team had expected that this phenomenon may prove isolated to a certain type of contracting mechanism or product/service, but that did not prove to be the case.

The difference between single-offer and effective competition is worth exploring, even if it lowers the significance of the starting model. Happily, this decision is supported by the fact that this three category variable offers the greatest reduction in residual deviance. However, lacking a specific theoretical argument for the importance of a greater number of offers, and given the results, the more detailed competition breakdowns will not be used. This may be an issue worth exploring more in a future work.

The greatest distinctiveness can be found in types of indefinite delivery vehicles. Definitive contracts and purchase orders show a higher termination rate as the number of offers increase. However, for single and multiple award IDVs, there's a decline in terminations rates correlated with low levels of competition, that often fades and even reverses as the number of offers increases. However, the results do not seem consistent with am exponential relationship.

## Study Variable Consolidation

### Level 6
#### Model NCS6A: l_def6_HHI_lag1

Expectations is that more consolidation is assoiated with more and larger breachers.
```{r ModelNCS6A_CBre}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(smp1m,"def6_HHI_lag1")
summary_continuous_plot(smp1m,"def6_HHI_lag1",log=TRUE)
summary_continuous_plot(smp1m,"def3_HHI_lag1")
summary_continuous_plot(smp1m,"def3_HHI_lag1",log=TRUE)


#Model
CBre_Cons_NCS6A <- glm (data=smp,
                 l_CBre ~cl_def6_HHI_lag1)
summary(CBre_Cons_NCS6A)


#Plot residuals versus fitted
  stargazer::stargazer(CBre_Comp_01A,CBre_Cons_NCS6A,type="text",
                       digits=2)

```

Expectation is not upheld

#### Model NCS6B: Defense to Overall ratio
The higher the ratio of defense obligations to reciepts in the overall economy, the DoD holds a monosopy over a sector. Given the challenges of monosopy, the a higher ratio estimates a greater  risk of ceiling breaches.
```{r ModelNCS6l_CBre}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(smp1m,"capped_def6_ratio_lag1")
      summary_continuous_plot(smp1m,"capped_def6_ratio_lag1",log=TRUE)

      summary_continuous_plot(smp1m,"capped_def3_ratio_lag1")
      summary_continuous_plot(smp1m,"capped_def3_ratio_lag1",log=TRUE)



#Model
CBre_NCS6B <- glm (data=smp,
                 l_CBre ~cl_def6_ratio_lag1)
glmer_examine(CBre_NCS6B)

# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_NCS6A,CBre_NCS6B,
                       CBre_Comp_01A,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_NCS6A,CBre_NCS6B,bins=20)
summary_residual_compare(CBre_Comp_01B,CBre_Comp_NCS6B,bins=2)


```
The results align with expectations, although the magnitude is minimal.


#### Model NCS3C: cl_def3_obl_lag1
Defense sector obligations are added to better adjust for the fact that larger sectors tend to have lower HHI indices if only because they include a broader range of activities. In addition, Acting somewhat as a proxy for MDAP status, larger sectors may also have a greater risk of cascading problems. Thus greater defense obligations in a given sector are expected to estimate a greater likelihood over ceiling breaches,
Expectations are  unchanged.
```{r ModelNCS3C_CBre}


#Model
CBre_NCS3C <- glm (data=smp,
                 l_CBre ~cl_def3_obl_lag1)
glmer_examine(CBre_NCS3C)


summary(CBre_Comp_NCS3C)
# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
stargazer::stargazer(CBre_Cons_NCS3B,CBre_Cons_NCS3E,CBre_Cons_NCS6F,
                       CBre_Cons_NCS3B,CBre_Cons_NCS3C,type="text",
                       digits=2)



  #Compare to prior at same level
summary_residual_compare(CBre_Cons_NCS3A,CBre_Cons_NCS3C,bins=20)
#Compare to prior at lower level
summary_residual_compare(CBre_Cons_NCS6E,CBre_Cons_NCS3C,bins=20)
```
Size seems to add less to the model at level 3 than level 6.


#### Model NCS3D: Average Salary
Average salary can be an proxy for unobserved skill requirements. We expect that a greater skill requirement will estimate a greater risk of ceiling breaches.
```{r ModelNCS3D_CBre}
#Frequency Plot for unlogged ceiling


summary_continuous_plot(smp,"US3_avg_sal_lag1")
summary_continuous_plot(smp,"l_US3_avg_sal_lag1")

summary_continuous_plot(smp,"US5_avg_sal_lag1")
summary_continuous_plot(smp,"US4_avg_sal_lag1")
summary_continuous_plot(smp,"US3_avg_sal_lag1")
summary_continuous_plot(smp,"US2_avg_sal_lag1")

#Model

CBre_Cons_NCS3D <- glm (data=smp,
                 l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+cl_def3_obl_lag1+
                  cl_US3_avg_sal_lag1+cl_def3_HHI_lag1:cl_def3_obl_lag1 )
glmer_examine(CBre_Cons_NCS3D)


CBre_Comp_NCS3D <- glm (data=smp,
                 l_CBre ~CompOffr+cl_def3_ratio_lag1+cl_def3_obl_lag1+cl_US3_avg_sal_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS3D)



glmer_examine(CBre_Cons_NCS3D)
glmer_examine(CBre_Comp_NCS3D)


CBre_Cons_NCS3D2 <- glm (data=smp,
                 l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1
                  cl_US3_avg_sal_lag1 )#+cl_def3_HHI_lag1:cl_def3_obl_lag1
glmer_examine(CBre_Cons_NCS3D2)


CBre_Comp_NCS3D2 <- glm (data=smp,
                 l_CBre ~CompOffr+cl_def3_ratio_lag1+cl_US3_avg_sal_lag1, #cl_def3_obl_lag1+
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS3D2)


CBre_Cons_NCS3D3 <- glm (data=smp,
                 l_CBre ~cl_def3_HHI_lag1+cl_def3_obl_lag1+#cl_def3_ratio_lag1
                  cl_US3_avg_sal_lag1+cl_def3_HHI_lag1:cl_def3_obl_lag1 )
glmer_examine(CBre_Cons_NCS3D3)
glmer_examine(CBre_Cons_NCS3D3)

CBre_Cons_NCS3D4 <- glm (data=smp,
                 l_CBre ~cl_def3_HHI_lag1+cl_def3_obl_lag1+#cl_def3_ratio_lag1
                  cl_US3_avg_sal_lag1 )#+cl_def3_HHI_lag1:cl_def3_obl_lag1
glmer_examine(CBre_Cons_NCS3D4)
glmer_examine(CBre_Cons_NCS3D4)

CBre_Comp_NCS3D3 <- glm (data=smp,
                 l_CBre ~CompOffr+cl_def3_obl_lag1+cl_US3_avg_sal_lag1, #cl_def3_ratio_lag1
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS3D3)


# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
 stargazer::stargazer(CBre_Cons_NCS3E,CBre_Cons_NCS3D2,CBre_Cons_NCS3D4,CBre_Cons_NCS6G,
                       CBre_Comp_NCS3C,CBre_Comp_NCS3D2,CBre_Comp_NCS3D3,CBre_Comp_NCS6G,
                       type="text",digits=2)


summary_residual_compare(CBre_Cons_NCS3D,CBre_Cons_NCS3D2,bins=20)
summary_residual_compare(CBre_Comp_NCS3C,CBre_Comp_NCS3D2,bins=10)
summary_residual_compare(CBre_Cons_NCS3D2,CBre_Cons_NCS3D4,bins=20)
summary_residual_compare(CBre_Comp_NCS3D2,CBre_Comp_NCS3D3,bins=10)

summary_residual_compare(CBre_Cons_NCS3D,CBre_Cons_NCS3D4,bins=20)
summary_residual_compare(CBre_Comp_NCS3C,CBre_Comp_NCS3D3,bins=10)


```
After sorting out VIF, obligations has more contained residuals and for consolidation a lower deviance. For competition the deviance is lower for when salary is not included and both ratio and defense obligations are.


#### Model NCS6E: Cumulative
```{r ModelNCS6l_CBre}
#Model
CBre_Cons_NCS6E <- glm (data=smp,
                 l_CBre ~cl_def6_HHI_lag1+cl_def6_ratio_lag1)
glmer_examine(CBre_Cons_NCS6E)

CBre_Comp_NCS6E <- glm (data=smp,
                 l_CBre ~CompOffr+cl_def6_ratio_lag1)
glmer_examine(CBre_Comp_NCS6E)
# 


#Plot residuals versus fitted
  stargazer::stargazer(CBre_NCS6B,CBre_Cons_NCS6A,CBre_Cons_NCS6E,
                       CBre_Comp_01A,CBre_Comp_NCS6E,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_NCS6A,CBre_Cons_NCS6E,bins=20)
summary_residual_compare(CBre_Comp_01B,CBre_Comp_NCS6E,bins=2)


```
Introducing ratio notably dimishes the coefficient for competition with 5 offers, which is suggestive that the commercial vendor pool of the sector, rather than the number of competitors per se.


### Level 3
#### Model NCS3A: cl_def3_HHI
```{r ModelNCS3A_CBre}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(smp,"def3_HHI_lag1")
summary_continuous_plot(smp,"def3_HHI_lag1",log=TRUE)

#Model
CBre_Cons_NCS3A <- glm (data=smp,
                 l_CBre ~cl_def3_HHI_lag1)
summary(CBre_Cons_NCS3A)


# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")
# 


#Plot residuals versus fitted
stargazer::stargazer(CBre_Cons_NCS6A,CBre_Cons_NCS6E,
                       CBre_Comp_01A,CBre_Comp_NCS6E,CBre_Cons_NCS3A,
                     type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_NCS6A,CBre_Cons_NCS3A,bins=20)


```

Level 3 HHI seems to slightly out perform level 6.


#### Model NCS3B: Defense to Overall ratio
The higher the ratio of defense obligations to reciepts in the overall economy, the DoD holds a monosopy over a sector. Given the challenges of monosopy, the a higher ratio estimates a greater  risk of ceiling breaches.
```{r ModelNCS3l_CBre}
#Frequency Plot for unlogged ceiling


summary_continuous_plot(smp,"capped_def3_ratio_lag1")
summary_continuous_plot(smp,"capped_def3_ratio_lag1",log=TRUE)

#Model
CBre_NCS3B <- glm (data=smp,
                 l_CBre ~ cl_def3_ratio_lag1)
summary(CBre_NCS3B)
# 
stargazer::stargazer(CBre_Cons_NCS3A,CBre_NCS3B,CBre_Cons_NCS6A,CBre_Cons_NCS6E,
                       CBre_Comp_01A,CBre_Comp_NCS6E,
                     type="text",
                       digits=2)

summary_residual_compare(CBre_NCS6B,CBre_NCS3B,bins=20)



```
The results align with the hypothesis, although the magnitude is small, if larger in magnitude than the level 6 version. 





#### Model NCS3E: Cumulative Model
Consolidation at lessa nd more granular levels may have different effects. Efficiencies are often used to describe sectors, like utilities, with high barriers to entry. Many of these aspects seem like they would already be captured at less granular NAICS levels, e.g. power plants, rather than more specific NAICS levels, like solar vs. coal. As a result, consolidation for more granular NAICS codes should estimate higher rates of ceiling breaches compared to less granular NAICS code.

We'll start by adding in everything from both models and seeing what violates VIF.
```{r ModelNCS3G_CBre}
#Frequency Plot for unlogged ceiling


#Model
CBre_Cons_NCS3G <- glm (data=smp,
                 l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+cl_def3_obl_lag1+
                  cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+cl_def6_HHI_lag1:cl_def6_obl_lag1  )
glmer_examine(CBre_Cons_NCS3G)
vif(CBre_Cons_NCS3G)
#Defense obl 3 have the highest VIF and no coefficient to speak of, dropping it
CBre_Cons_NCS3G2 <- glm (data=smp,
                 l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                  cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                  cl_US6_avg_sal_lag1+cl_def6_HHI_lag1:cl_def6_obl_lag1  )
glmer_examine(CBre_Cons_NCS3G2)
vif(CBre_Cons_NCS3G2)
#Average salary 6 has the highest VIF though but both average salaries are over 2.0 and 3 is more contrary to expectations. Taking it out.
CBre_Cons_NCS3G3 <- glm (data=smp,
                 l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                  #cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                  cl_US6_avg_sal_lag1+cl_def6_HHI_lag1:cl_def6_obl_lag1  )
glmer_examine(CBre_Cons_NCS3G3)
vif(CBre_Cons_NCS3G3)


CBre_Comp_NCS3G <- glm (data=smp,
                 l_CBre ~CompOffr+cl_def3_ratio_lag1+cl_def3_obl_lag1+cl_US3_avg_sal_lag1+
                   CompOffr+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS3G)
vif(CBre_Comp_NCS3G)
#Defense obl 3 have the highest VIF and no coefficient to speak of, dropping it
CBre_Comp_NCS3G2 <- glm (data=smp,
                 l_CBre ~CompOffr+cl_def3_ratio_lag1+cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                   CompOffr+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS3G2)
vif(CBre_Comp_NCS3G2)
#Taking out average salary 3 to keep the models snced up.
CBre_Comp_NCS3G3 <- glm (data=smp,
                 l_CBre ~CompOffr+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                   CompOffr+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS3G3)
vif(CBre_Comp_NCS3G3)


# 
# #Plot the fitted model plot
# CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=0),color="blue")+
#   stat_function(fun = CBre_Comp_02A_curve, 
#                              args=list(Comp=2),color="blue")




#Plot residuals versus fitted
 stargazer::stargazer(CBre_Cons_NCS3E,CBre_Cons_NCS3D2,CBre_Cons_NCS3D4,CBre_Cons_NCS6G,CBre_Cons_NCS3G3,
                       CBre_Comp_NCS3C,CBre_Comp_NCS3D2,CBre_Comp_NCS3D3,CBre_Comp_NCS6G,CBre_Comp_NCS3G3,
                       type="text",digits=2)


summary_residual_compare(CBre_Cons_NCS3D4,CBre_Cons_NCS3G3,bins=20)
summary_residual_compare(CBre_Comp_NCS3D3,CBre_Comp_NCS3G3,bins=10)
summary_residual_compare(CBre_Cons_NCS3D2,CBre_Cons_NCS3G3,bins=20)
summary_residual_compare(CBre_Comp_NCS3D2,CBre_Comp_NCS3G3,bins=10)

summary_residual_compare(CBre_Cons_NCS3D,CBre_Cons_NCS3G3,bins=20)
summary_residual_compare(CBre_Comp_NCS3C,CBre_Comp_NCS3G3,bins=10)
summary_residual_compare(CBre_Cons_NCS6G,CBre_Cons_NCS3G3,bins=20)
summary_residual_compare(CBre_Comp_NCS6G,CBre_Comp_NCS3G3,bins=10)

```
The hypothesis is upheld. Deviance is a little lower and residuals a little higher than the prior forms of consolidation for the level 3 model.  For the level 6 model, deviance is reduced some in both cases.



##Scope Variables
###Model 02A: Cost Ceiling


```{r Model02A_CBre}
#Frequency Plot for unlogged ceiling
summary_continuous_plot(smp,"UnmodifiedContractBaseAndAllOptionsValue",
               bins=1000)
summary_continuous_plot(subset(smp,UnmodifiedContractBaseAndAllOptionsValue<100000000),
               "UnmodifiedContractBaseAndAllOptionsValue",
               bins=1000)

#Frequency Plot for logged ceiling
summary_continuous_plot(smp,"l_Ceil")

#Model
CBre_Cons_02A <- glm (data=smp,
                 l_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil)
glmer_examine(CBre_Cons_02C)

CBre_Comp_02A <- glm (data=smp,
                 l_CBre ~CompOffr + cl_Ceil)
glmer_examine(CBre_Comp_02A)


#Plot the fitted model plot
CBre_Comp_02A_curve<-function(x, Comp){invlogit(cbind(1,Comp,x) %*%  coef(CBre_Comp_02A))}

#Competition curves
fitted_cbre_model(smp,"cl_Ceil") + stat_function(fun = CBre_Comp_02A_curve, 
                             args=list(Comp=0),color="blue")+
  stat_function(fun = CBre_Comp_02A_curve, 
                             args=list(Comp=2),color="blue")



#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_Comp_02A)

#Plot residuals versus fitted
  stargazer::stargazer(CBre_Cons_01F, CBre_Cons_02A,CBre_Comp_01B,CBre_Comp_02A,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_01F,CBre_Cons_02A,CBre_Comp_01B,CBre_Comp_02A,bins=2)


```

Contract ceiling has a significant relationship.






###Model 02B: Maximum Duration


```{r Model02l_CBre}
#Frequency Plot for max duration
summary_continuous_plot(smp,"UnmodifiedDays",
               bins=1000)

#Frequency Plot for logged max duration
summary_continuous_plot(smp,"l_Days")



#Model
CBre_Cons_02B <- glm (data=smp,
                 l_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days + 
                   cl_def6_HHI_lag1:cl_Ceil)
glmer_examine(CBre_Cons_02B)

CBre_Comp_02B <- glm (data=smp,
                 l_CBre ~CompOffr + 
                   cl_Ceil + cl_Days )
glmer_examine(CBre_Comp_02B)


CBre_Comp_02B_curve<-function(x, Comp,Ceil){invlogit(cbind(1,Comp,Ceil,x,Comp*Ceil) %*%  coef(CBre_Comp_02B))}

#Competition Curves
fitted_cbre_model(smp,"cl_Days") + stat_function(fun = CBre_Comp_02B_curve, 
                             args=list(Comp=0,Ceil=0),color="blue")+
  stat_function(fun = CBre_Comp_02B_curve, 
                             args=list(Comp=2,Ceil=0),color="blue")

#Ceiling Curves
fitted_cbre_model(smp,"cl_Days") +  stat_function(fun = CBre_Comp_02B_curve, 
                             args=list(Comp=0,Ceil=0),color="blue")+
  stat_function(fun = CBre_Comp_02B_curve, 
                             args=list(Comp=0,Ceil=1),color="blue")

#Plot the fitted values vs actual results
binned_fitted_versus_cbre_residuals(CBre_Comp_02B)


#Plot residuals versus fitted
residuals_cbre_plot(CBre_Comp_02B)+
  labs(x="Estimated  Pr (Ceiling Breach)")
# debug(binned.resids)
# residuals_cbre_plot(CBre_Comp_02B,"cl_Days")+
  # labs(x="Centered Log(Ceiling)")


  stargazer::stargazer(CBre_Cons_02B,CBre_Comp_02B,type="text",
                       digits=2)

summary_residual_compare(CBre_Cons_02C,CBre_Cons_02B,CBre_Comp_02A,CBre_Comp_02B,bins=20)

```
The initial model results are surprising as ceiling change direction, reducing and correlates with a lower risk of termiation now, although the interaction between competition and ceiling remains roughly the same. The graph of the fitted values shows that this model The next step will be to look at the interaction of ceiling and duration. The difference in deviance for residual difference has more than trippled, an indication of the correlative power of duration. However, the residuals do show a clear pattern that indicates another exponential variable may be necessary. However, the interaction between ceiling and duration is a more important analytical question and will be the next variable added.




##Contract Vehicle
Our dataset includes both stand alone contract awards and task orders that are under larger indefinite delivery vehilces (IDVs). 

###Model 03A: Single-Award, Multi-Award, and Other Indefinite Delivery Vehicles


```{r Model03A_CBre}
#Frequency Plot
summary_discrete_plot(smp,"Veh")


#Create the model
CBre_Cons_03A <- glm (data=smp,
                 l_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   cl_def6_HHI_lag1:cl_Ceil  +
                   cl_def6_HHI_lag1:cl_Days
                 )
glmer_examine(CBre_Cons_03A)


CBre_Comp_03A <- glm (data=smp,
                 l_CBre ~CompOffr + 
                   cl_Ceil + cl_Days+ 
                   Veh
                  
                   #cl_def6_HHI_lag1:cl_Days
                 )
glmer_examine(CBre_Comp_03A)
# 
# #Plot the model and Vehicle for SIDV
# CBre_Comp_03A_SIDV_curve<-function(x, Comp,Ceil,Days,MIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,x,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp) %*%  coef(CBre_Comp_03A))}
# 
# #Competition curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_03A_SIDV_curve, 
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_03A_SIDV_curve, 
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        MIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# CBre_Comp_03A_MIDV_curve<-function(x, Comp,Ceil,Days,SIDV,OIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,x,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp) %*%  coef(CBre_Comp_03A))}
# 
# #Plot the model and Vehicle for MIDV
# #Competition curves
# fitted_cbre_model(smp,"MIDV") +
#   stat_function(fun = CBre_Comp_03A_MIDV_curve, 
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")+
#   stat_function(fun = CBre_Comp_03A_MIDV_curve, 
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        SIDV=0,FSSGWAC=0,BPABOA=0),color="blue")
# 
# CBre_Comp_03A_OIDV_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,x,
#         Comp*Ceil,Days*Ceil,Days*Comp) %*%  coef(CBre_Comp_03A))}
# 
# #Plot the model and Vehicle for OIDV
# #Competition curves
# fitted_cbre_model(smp,"OIDV") +
#   stat_function(fun = CBre_Comp_03A_OIDV_curve, 
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=0),color="blue")+
#   stat_function(fun = CBre_Comp_03A_OIDV_curve, 
#                              args=list(Comp=2,Ceil=0,Days=0,
#                                        SIDV=0,MIDV=0),color="blue")
# 


#Plot the fitted values vs actual results
stargazer::stargazer(CBre_Cons_02H,CBre_Cons_03A,CBre_Comp_02B,CBre_Comp_03A,type="text",
                       digits=2)


summary_residual_compare(CBre_Cons_02H,CBre_Cons_03A,CBre_Comp_02B,CBre_Comp_03A,bins=20)

```

The first check lumps looks at three categories of IDVs, each facing a notably lower a risk of termination. The largest negative coefficient is for single award IDCs, multiple award IDVs second, and other IDVs third. The deviation residual notably creeps up after this addition, though this is likely attributable to a missing data problem rather than the new information not being useful. Unfortunately, while the for both ceiling^2 and duration^2 were notably reduced in magnitude, the residuals show significant patterns, underestimating the risk of termination in the fitted range from around 0.005 to 0.01 and overestimating by 0.02. There's no exponential term that makes sense to add here, which leaves the hope that interactions may address this phenomenon.

This may reflect that the Ceiling and Days entries reflect only the task order and not the larger contract. The next step is to check the intersections with ceiling.



##Type of Contract

The next step adds a measure for whether the contract was cost-based or fixed-price. Prior CSIS research has found that fixed-price contracts do face a higher risk of termination across the board.

###Model 04A: Incentive Fees

In the performance of the defense acquisition system report, the benefits found were reduced cost overruns. That could help avoid terminations, but it's an indirect connection at best. Unfortunately, incentive fees are incredibly rare, which makes them challenging to examine directly.


```{r Model04A_CBre}

#Frequency Plot
summary_discrete_plot(smp,"Fee")



summary(factor(smp$PricingFee))

#Create the model
CBre_Cons_04A <- glm (data=smp,
                 l_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_Ceil+
                PricingFee)
glmer_examine(CBre_Cons_04A)

CBre_Comp_04A <- glm (data=smp,
                 l_CBre ~CompOffr + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_def6_HHI_lag1:cl_Ceil  + 
                 Veh:cl_Days+
                   
                   Veh:cl_Ceil+
                                   PricingFee , 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_04A)
glmer_examine(CBre_Comp_04A)

# 
# # Plot the model and Vehicle 
# CBre_Comp_04A_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(CBre_Comp_04A))}
# 
# #Days curves
# fitted_cbre_model(smp,"n_Incent") +
#   stat_function(fun = CBre_Comp_04A_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,Fixed=1),color="blue")+
#   stat_function(fun = CBre_Comp_04A_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,Fixed=1),color="blue")


# #Plot the fitted values vs actual results
# binned_fitted_versus_cbre_residuals(CBre_Comp_04A)
# 
# #Plot residuals versus fittedO
# residuals_cbre_plot(CBre_Comp_04A)+
#   labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot(CBre_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")

stargazer::stargazer(CBre_Cons_04C,CBre_Cons_04A,
                     CBre_Comp_04C,CBre_Comp_04A,type="text",
                       digits=2)
summary_residual_compare(CBre_Cons_04C,CBre_Cons_04A,
                         CBre_Comp_04C,CBre_Comp_04A,bins=20)

```

The effect of incentive fees are not significant. They do have a noteworthy coefficient, however, given prior research on their ability to prevent cost overruns, their lowered heightened probably of terminations lacks an immdetiate explaintation. There's also a fair amount of unlabeled data, which reduces the samplle size. It's still worth checking the interaction with fixed price, as they are based on a common field in FPDS and the two are closely related in concept.






###Model 04B: Undefinitized Contract Awards
Undefinitized Contract Awards allow for quick action in situations where there is not time or information to establish all of a contracts properties at the time of signing. They have been found by the GAO and the Performance of the Defense Acquisition studies to contain notable risks, primarily relating to cost overruns and thus ceiling breaches. Will these risks also carry into terminations and ceiling breaches?


```{r Model04l_CBre}

#Frequency Plot
summary_discrete_plot(smp,"UCA")



#Create the model
CBre_Cons_04B <- glm (data=smp,
                 l_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   #cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_Ceil+
                PricingFee+ b_UCA +
                   cl_Ceil:PricingFee)
glmer_examine(CBre_Cons_04B)
glmer_examine(CBre_Cons_04B)


#Create the model
CBre_Comp_04B <- glm (data=smp,
l_CBre ~CompOffr + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                    b_UCA +
                   #cl_def6_HHI_lag1:cl_Days +
                 Veh:cl_Days+
                   Veh:cl_Ceil+
                PricingFee+
                   cl_Ceil:PricingFee)
glmer_examine(CBre_Comp_04B)

# Plot the model and Vehicle 
# CBre_Comp_04B_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV) %*%  coef(CBre_Comp_04B))}


#Days curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_04B_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1),color="blue")+
#   stat_function(fun = CBre_Comp_04B_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1),color="blue")
# 
# 
# #Plot the fitted values vs actual results
# binned_fitted_versus_cbre_residuals(CBre_Comp_04B)
# 
# #Plot residuals versus fittedO
# residuals_cbre_plot(CBre_Comp_04B)+
#   labs(x="Estimated  Pr (Ceiling Breach)")

# residuals_cbre_plot(CBre_Comp_02F,"cl_days")+
#   labs(x="Centered Log(Days)")
stargazer::stargazer(CBre_Cons_04G,CBre_Cons_04B,
                     CBre_Comp_04G,CBre_Comp_04B,type="text",
                       digits=2)
summary_residual_compare(CBre_Cons_04G,CBre_Cons_04B,CBre_Comp_04G,CBre_Comp_04B,bins=20)


```


##Place of Performance
###Model 05A: Any International

International contracts may often be in conflict zones and thus experience greater risk. International contracts are exepected to estimate a higher probability of ceiling breaches.
```{r Model05A_Comp}

#Frequency Plot
summary_discrete_plot(smp,"Intl")



#Create the model
CBre_Cons_05A <- glm (data=smp,
l_CBre ~cl_def6_HHI_lag1 + 
                   cl_Ceil + cl_Days+ 
                   Veh +
                   PricingFee + b_UCA +
  b_Intl+
                  
                 Veh:cl_Days+
                   # Veh:cl_def6_HHI_lag1  +
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                b_UCA:cl_def6_HHI_lag1 + 
                  b_UCA:cl_Ceil
                    )
glmer_examine(CBre_Cons_05A)

CBre_Comp_05A <- glm (data=smp,
l_CBre ~CompOffr + 
                   cl_Ceil + cl_Days+ 
                   Veh  +
  PricingFee+ b_UCA +
  b_Intl+
                 Veh:cl_Days+
                   
                   Veh:cl_Ceil+
  cl_Ceil:PricingFee+
  # b_UCA:cl_Ceil+
                   
                b_UCA:CompOffr + 
                  b_UCA:cl_Ceil
                    )
glmer_examine(CBre_Comp_05A)

# Plot the model and Vehicle 
# CBre_Comp_05A_curve<-function(x, Comp,Ceil,Days,SIDV,MIDV,OIDV,Fixed,UCA){invlogit(
#   cbind(1,Comp,Ceil,Days,SIDV,MIDV,OIDV,
#         Comp*Ceil,Days*Ceil,Days*Comp,
#         Fixed,UCA,x,
#         Days*x,Days*MIDV,Days*OIDV,
#         Comp*x,Comp*MIDV,Comp*OIDV,
#         UCA*Comp) %*%  coef(CBre_Comp_05A))}
# 
# #Days curves
# fitted_cbre_model(smp,"SIDV") +
#   stat_function(fun = CBre_Comp_05A_curve,
#                              args=list(Comp=0,Ceil=0,Days=0,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1,UCA=0),color="blue")+
#   stat_function(fun = CBre_Comp_05A_curve,
#                              args=list(Comp=2,Ceil=0,Days=1,
#                                        MIDV=0,SIDV=0,FSSGWAC=0,BPABOA=0,
#                                        Fixed=1,UCA=0),color="blue")


stargazer::stargazer(CBre_Cons_04K,CBre_Cons_05A,
                     CBre_Comp_04K,CBre_Comp_05A,type="text",
                       digits=2)
summary_residual_compare(CBre_Cons_04K,CBre_Cons_05A,CBre_Comp_04K,CBre_Comp_05A,bins=20)



```

International performance of contract had a positive  coefficent as expected.




##What
### Model 06A: NAICS2 and NAICS3/NAICS6 Sector Data
This model includes economic sector at the NAICS3 and NAICS 6 levels.
```{r Model06A}

#Taking out average salary 3 to keep the models snced up.
CBre_Comp_NCS3G3 <- glm (data=smp,
                 l_CBre ~CompOffr+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                   CompOffr+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1, 
                 family=binomial(link="logit"))
glmer_examine(CBre_Comp_NCS3G3)
vif(CBre_Comp_NCS3G3)

CBre_Cons_06A <- glm (data=smp,
                      l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Cons_06A)


CBre_Comp_06A <- glm (data=smp,
                      l_CBre~CompOffr+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:CompOffr + 
                        b_UCA:cl_Ceil+
                        
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Comp_06A)


stargazer::stargazer(CBre_Cons_07A,CBre_Cons_07B,CBre_Cons_06A,CBre_Cons_06A,CBre_Comp_07A,CBre_Comp_07B,CBre_Comp_06A,CBre_Comp_06A,type="text",
                       digits=2)

summary_residual_compare(CBre_Cons_07A,CBre_Cons_06A,CBre_Comp_07A,CBre_Comp_06A,bins=20)

```


## Competition and Consolidation together
### Model 09A: NAICS6 Combination
```{r Model07B}


#Sumamry plot



CBre_Cons_Comp_09A <- glm (data=smp,
                      l_CBre ~cl_def6_HHI_lag1 +cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                    
                       
                          +cl_def6_HHI_lag1:cl_def6_obl_lag1+ 
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:cl_def6_HHI_lag1 + 
                            b_UCA:CompOffr + 
                        b_UCA:cl_Ceil+
                        
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Cons_Comp_09A)




  stargazer::stargazer(CBre_Cons_07A,CBre_Cons_07B,CBre_Comp_07A,CBre_Comp_07B,CBre_Cons_Comp_09A,type="text",
                       digits=2)
  
summary_residual_compare(CBre_Cons_07B,CBre_Cons_Comp_09A,CBre_Comp_07B,CBre_Cons_Comp_09A,bins=100)


```
### Model 09B: NAICS3/NAICS6 Combination
```{r Model09B}


CBre_Cons_Comp_09B <- glm (data=smp,
                      l_CBre ~cl_def3_HHI_lag1+
                        cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+
                        cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+
                        CompOffr+
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:CompOffr + 
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Cons_Comp_09B)



stargazer::stargazer(CBre_Cons_06A,CBre_Comp_06A,CBre_Cons_Comp_09B,type="text",
                       digits=2)

summary_residual_compare(CBre_Cons_06A,CBre_Cons_Comp_09B,CBre_Comp_06A,CBre_Cons_Comp_09B,bins=100)

```

## Interactions
### Model 10A: No Interactions
```{r Model10A}
corrdisp<-Hmisc::rcorr(
  as.matrix(cbind(subset(crisis_smp, select=c(b_UCA,c_OffCri,cl_Ceil,
                                              cl_Days,n_Fixed,b_Intl)),
                  dummies::dummy(crisis_smp$Crisis),
                  dummies::dummy(crisis_smp$NoComp),
                  dummies::dummy(crisis_smp$Reach),
                  dummies::dummy(crisis_smp$Veh),
                  dummies::dummy(crisis_smp$Is.Defense),
                  dummies::dummy(crisis_smp$Simple))))
corrdisp[[1]]

#Sumamry plot
summary_discrete_plot(smp1m,"NAICS2",rotate_text=TRUE)

CBre_Cons_10A <- glm (data=smp,
                      l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        # cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        # b_UCA:cl_def6_HHI_lag1 + 
                        # b_UCA:cl_Ceil+
                        
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Cons_10A)


CBre_Comp_10A <- glm (data=smp,
                      l_CBre~CompOffr+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        # b_UCA:CompOffr + 
                        # b_UCA:cl_Ceil+
                        
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Comp_10A)

  stargazer::stargazer(CBre_Cons_06A,CBre_Cons_10A,CBre_Comp_06A,CBre_Comp_10A,type="text",
                       digits=2)
  
summary_residual_compare(CBre_Cons_06A,CBre_Cons_10A,CBre_Comp_06A,CBre_Comp_10A,bins=20)


```
Removal of the interaction resulted in a comparatively small reduction in deviance and fairly minimal changes in residuals.

### Model 10B: Comp/Cons:UCA
Starting with Competition and UCA. It's strong in both models and thus a natural starting point.
```{r Model10B}
#Sumamry plot
summary_continuous_plot(smp1m,"cl_def6_HHI_lag1","UCA")
summary_discrete_plot(smp1m,"EffComp","UCA")


#Create the model
CBre_Cons_10B <- glm (data=smp,
                      l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        # cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:cl_def6_HHI_lag1 +
                        # b_UCA:cl_Ceil+
                        
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Cons_10B)


CBre_Comp_10B <- glm (data=smp,
                      l_CBre~CompOffr+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:CompOffr +
                        # b_UCA:cl_Ceil+
                        
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Comp_10B)

  stargazer::stargazer(CBre_Comp_10A,CBre_Comp_10B,CBre_Cons_10A,CBre_Cons_10B,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Comp_10A,CBre_Comp_10B,CBre_Cons_10A,CBre_Cons_10B,bins=20)


```
The interaction is significant and competion / low levels of consolidation estimates lower risks associated withUCAs. In diagnostic terms, the residuals for ceiling breaches get a little worse, but the change is marginal and the interaction is relevant to study questions. Keeping it.


### Model 10C: Comp/Cons:Days
The next reintroduction is competition and days. The benefits of competition may reduce over time. We don't have firm expectations for consolidation, so leaving that out.
```{r Model10C}


#Sumamry plot
summary_continuous_plot(smp1m,"cl_Days","EffComp")



CBre_Comp_10C <- glm (data=smp,
                      l_CBre~CompOffr+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:CompOffr +
                        # b_UCA:cl_Ceil+
                        CompOffr:cl_Days +
                       
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Comp_10C)


```

This combination encounters VIF problems for competition Leaving it out.


### Model 10D: Comp/Cons:Ceiling
The next reintroduction is competition and ceiling. Competition and ceiling might have a negative coefficient, because large contracts might encourage bid to win approaches. No expectations for consolidation, so leaving that out.
```{r Model10D}


#Sumamry plot
summary_continuous_plot(smp1m,"cl_Ceil","CompOffr")



CBre_Comp_10D <- glm (data=smp,
                      l_CBre~CompOffr+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:CompOffr +
                        # b_UCA:cl_Ceil+
                        CompOffr:cl_Ceil +
                       
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Comp_10D)


```
This interaction runs afowl of the VIF test on the competition side.


### Model 10E: Comp/Cons:Veh
The next reintroduction is competition and vehicle. Multi-award contracts in particular emphasize competition between the awardees which suggests that it may increase the benefits of competition.


```{r Model10E}


#Sumamry plot
summary_discrete_plot(smp1m,"Veh","cl_def6_HHI_lag1")
summary_discrete_plot(smp1m,"Veh","CompOffr")

#Create the model


CBre_Cons_10E <- glm (data=smp,
                      l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        # cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:cl_def6_HHI_lag1 +
                        # b_UCA:cl_Ceil+
                        Veh:cl_def6_HHI_lag1+
                        
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Cons_10E)


CBre_Comp_10E <- glm (data=smp,
                      l_CBre~CompOffr+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:CompOffr +
                        # b_UCA:cl_Ceil+
                       Veh:CompOffr+
                       
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Comp_10E)



  stargazer::stargazer(CBre_Cons_10D,CBre_Cons_10E,CBre_Comp_10B,CBre_Comp_10E,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_10D,CBre_Cons_10E,CBre_Comp_10B,CBre_Comp_10E,bins=20)


```


Competition and vehicle results are interesting, but run afowl of VIF test. Consolidation is somewhat contrary to expectation and on the cusp of VIF problems, leaving it  out.


### Model 10F: UCA and Ceiling
Larger ceiling UCAs may run into bigger problems. The interaction of UCA and ceiling estimates a higher risk of breaches. 

```{r Model10F}


#Sumamry plot
summary_discrete_plot(smp1m,"Veh","cl_def6_HHI_lag1")
summary_discrete_plot(smp1m,"Veh","CompOffr")

#Create the model


CBre_Cons_10F <- glm (data=smp,
                      l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        # cl_def6_HHI_lag1:cl_def6_obl_lag1  +
               
                        b_UCA:cl_def6_HHI_lag1 +
                        b_UCA:cl_Ceil+
                        # Veh:cl_def6_HHI_lag1+
                        
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Cons_10F)


CBre_Comp_10F <- glm (data=smp,
                      l_CBre~CompOffr+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:CompOffr +
                        b_UCA:cl_Ceil+
                       # Veh:CompOffr+
                       
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Comp_10F)



  stargazer::stargazer(CBre_Cons_10D,CBre_Cons_10F,CBre_Comp_10B,CBre_Comp_10F,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_10D,CBre_Cons_10F,CBre_Comp_10B,CBre_Comp_10F,bins=20)


```
The result runs contrary to expectation, but notably reduces by over 10 points in each case and is largely a wash when it comes to residuals. Leaving it in. One possible rationale is that small UCAs may raise risks because they are under less scrutiny.
### Model 10G: Pricing and Average Wage

Average wage is a proxy for unobserved skill requirements, which in turn is a proxy for complexity. Fixed price contracting may run afoul of in these sectors, due to the greater difficulties of prediction. Labor hours/t&M, will likely are expected to estimate lower risk of problems, but not as low as cost-based. Incentive fee and cost-based are both expected to lower the estimated risk fo breaches.

```{r Model10G}


#Sumamry plot
summary_continuous_plot(smp1m,"cl_US6_avg_sal_lag1","PricingFee")


#Create the model


CBre_Cons_10G <- glm (data=smp,
                      l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        # cl_def6_HHI_lag1:cl_def6_obl_lag1  +
               
                        b_UCA:cl_def6_HHI_lag1 +
                        b_UCA:cl_Ceil+
                        PricingFee:cl_US6_avg_sal_lag1+
                        
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Cons_10G)


CBre_Comp_10G <- glm (data=smp,
                      l_CBre~CompOffr+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:CompOffr +
                        b_UCA:cl_Ceil+
                       PricingFee:cl_US6_avg_sal_lag1+
                       
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Comp_10G)


  stargazer::stargazer(CBre_Cons_10F,CBre_Cons_10G,CBre_Comp_10F,CBre_Comp_10G,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_10D,CBre_Cons_10G,CBre_Comp_10B,CBre_Comp_10G,bins=20)


```
The results run contrary to expectation and are only barely significant for other fixed-price. Leaving this out.

### Model 10H: Def Sec Obl:HHI
Because HHI in smaller sectors tends to be larger, high readings from large sectors may deserve more weight. This interaction is expected to amplify HHI magnitudes.
```{r Model10H}


#Sumamry plot
summary_continuous_plot(smp1m,"cl_US6_avg_sal_lag1","PricingFee")


#Create the model


CBre_Cons_10H <- glm (data=smp,
                      l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        cl_def6_HHI_lag1:cl_def6_obl_lag1  +
               
                        b_UCA:cl_def6_HHI_lag1 +
                        b_UCA:cl_Ceil+
                        # PricingFee:cl_US6_avg_sal_lag1+
                        
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Cons_10H)


  stargazer::stargazer(CBre_Cons_10F,CBre_Cons_10H,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_10F,CBre_Cons_10H,bins=20)


```
Results are not significant and are contrary to expectations, according to AIC, no value is added. Leaving it out.


### Model 10I: Ratio:HHI
Because HHI in smaller sectors tends to be larger, high readings from large sectors may deserve more weight. This interaction is expected to amplify HHI magnitudes.

Likewise, competition may be more effective in more commercial sectors where monosopy is not a problem.
```{r Model10I}


#Sumamry plot
summary_continuous_plot(smp1m,"cl_US6_avg_sal_lag1","PricingFee")


#Create the model


CBre_Cons_10I <- glm (data=smp,
                      l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       # cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        cl_def6_HHI_lag1:cl_def6_ratio_lag1  +
               
                        b_UCA:cl_def6_HHI_lag1 +
                        b_UCA:cl_Ceil+
                        
                        
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Cons_10I)



CBre_Comp_10I <- glm (data=smp,
                      l_CBre~CompOffr+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:CompOffr +
                        b_UCA:cl_Ceil+
                       PricingFee:cl_US6_avg_sal_lag1+
                       CompOffr:cl_def6_ratio_lag1  +
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Comp_10I)


CBre_Comp_10I2 <- glm (data=smp,
                      l_CBre~CompOffr+
                        #cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:CompOffr +
                        b_UCA:cl_Ceil+
                       PricingFee:cl_US6_avg_sal_lag1+
                       CompOffr:cl_def6_ratio_lag1  +
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Comp_10I2)

  stargazer::stargazer(CBre_Cons_10F,CBre_Cons_10H,CBre_Cons_10I,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_10F,CBre_Cons_10I,bins=20)
summary_residual_compare(CBre_Cons_10H,CBre_Cons_10I,bins=20)


```
Significant though contrary to expectation. The next step is to check for the removal of ratio for def3.



### Model 10J: Removing Ratiofor Level 3 NAICS.
Because HHI in smaller sectors tends to be larger, high readings from large sectors may deserve more weight. This interaction is expected to amplify HHI magnitudes.
```{r Model10J}


#Sumamry plot
summary_continuous_plot(smp1m,"cl_US6_avg_sal_lag1","PricingFee")


#Create the model


CBre_Cons_10J <- glm (data=smp,
                      l_CBre ~cl_def3_HHI_lag1+#cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        cl_def6_HHI_lag1:cl_def6_ratio_lag1  +
               
                        b_UCA:cl_def6_HHI_lag1 +
                        b_UCA:cl_Ceil+
                        
                        
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Cons_10J)



CBre_Comp_10J<- glm (data=smp,
                      l_CBre~CompOffr+
                        #cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:CompOffr +
                        b_UCA:cl_Ceil+
               
                       
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Comp_10J)

  stargazer::stargazer(CBre_Cons_10H,CBre_Cons_10J,
                       CBre_Comp_10F,CBre_Comp_10J,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_10H,CBre_Cons_10J,CBre_Comp_10F,CBre_Comp_10J,bins=20)



```

Removing it doesn't appear to do any good. Leaving it in.

### Model 10K: HHI6 and competition

If competition is an instrument for consolidation, than it should be most effective when consolidation is lower.
```{r Model10K}
summary_continuous_plot(smp1m,"cl_def6_HHI_lag1","EffComp")
summary_continuous_plot(smp1m,"cl_def3_HHI_lag1","EffComp")

CBre_Cons_Comp_10K <- glm (data=smp,
                      l_CBre ~cl_def3_HHI_lag1+
                        cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+
                        cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+
                        CompOffr+
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        cl_def6_HHI_lag1:cl_def6_ratio_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:CompOffr + 
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        cl_def6_HHI_lag1:CompOffr  +
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Cons_Comp_10K)


CBre_Cons_Comp_10K2 <- glm (data=smp,
                      l_CBre ~cl_def3_HHI_lag1+
                        cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+
                        cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+
                        CompOffr+
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        # cl_def6_HHI_lag1:cl_def6_ratio_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:CompOffr + 
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        cl_def6_HHI_lag1:CompOffr  +
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Cons_Comp_10K2)


CBre_Cons_Comp_10K3 <- glm (data=smp,
                      l_CBre ~cl_def3_HHI_lag1+
                        cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+
                        cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+
                        CompOffr+
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        #cl_def6_HHI_lag1:cl_def6_ratio_lag1 +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:CompOffr + 
                        # b_UCA:cl_def6_HHI_lag1 +
                        b_UCA:cl_Ceil+
                        cl_def6_HHI_lag1:CompOffr  +
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Cons_Comp_10K3)


CBre_Cons_Comp_10K4<- glm (data=smp,
                      l_CBre ~#cl_def3_HHI_lag1+
                        #cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+
                        cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+
                        CompOffr+
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        # cl_def6_HHI_lag1:cl_def6_ratio_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:CompOffr + 
                        # b_UCA:cl_def6_HHI_lag1 +
                        b_UCA:cl_Ceil+
                        cl_def6_HHI_lag1:CompOffr  +
                        Agency+
                        NAICS2
                      )


CBre_Cons_Comp_10K5<- glm (data=smp,
                      l_CBre ~#cl_def3_HHI_lag1+
                        #cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+
                        cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        # cl_US6_avg_sal_lag1+
                        CompOffr+
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        # cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:CompOffr + 
                        # b_UCA:cl_def6_HHI_lag1 +
                        b_UCA:cl_Ceil+
                        cl_def6_HHI_lag1:CompOffr  +
                        Agency+
                        NAICS2
                      )

glmer_examine(CBre_Cons_Comp_10K5)

```
The interaction ran into VIF challenges even with widescale removal of related variables. Leaving it out.

### Model 10J: Ratio:HHI
Checking this out because of curiosity about the multilevel model results. While both the subsector ratio and the subsector HHI estimate higher risk of ceiling breaches, in combination they still represent a subsector with fewer commercial options and thus are expected to estimate a higher risk of ceiling breaches.
```{r Model10J}


#Sumamry plot
summary_double_continuous(smp,"cl_def3_HHI_lag1","cl_def3_ratio_lag1")
#Create the model


CBre_Cons_10J <- glm (data=smp,
                      l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+     
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       # cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                        cl_def6_HHI_lag1:cl_def6_ratio_lag1  +
                        cl_def3_HHI_lag1:cl_def3_ratio_lag1  +
               
                        b_UCA:cl_def6_HHI_lag1 +
                        b_UCA:cl_Ceil+
                        
                        
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Cons_10J,display=TRUE)



  

summary_residual_compare(CBre_Cons_10I,CBre_Cons_10J,bins=20)


```
Significant though contrary to expectation. The next step is to check for the removal of ratio for def3.




##   Alternate Comp Metrics

### Model 11A: Binned Effective Comp
Switching from an ordinal scaled competition variable to a binned one.

```{r Model11A}




#Create the model




CBre_Comp_11A <- glm (data=smp,
                      l_CBre~EffComp+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:EffComp +
                        b_UCA:cl_Ceil+
                       # PricingFee:cl_US6_avg_sal_lag1+
                       # EffComp:cl_def6_ratio_lag1  +
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Comp_11A)

CBre_Cons_Comp_11A <- glm (data=smp,
                      l_CBre ~cl_def3_HHI_lag1+
                        cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+
                        cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+
                        EffComp+
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        cl_def6_HHI_lag1:cl_def6_ratio_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:EffComp + 
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        # cl_def6_HHI_lag1:EffComp  +
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Cons_Comp_11A)
  
  stargazer::stargazer(CBre_Comp_10F,CBre_Comp_11A,CBre_Cons_Comp_09B,CBre_Cons_Comp_11A,
                       type="text",
                       digits=2)

summary_residual_compare(CBre_Comp_10F,CBre_Comp_11A,
                         CBre_Cons_Comp_09B,CBre_Cons_Comp_11A,bins=100)



```


### Model 11B: Double checking recently failed interactions.
```{r Model11A}




#Create the model




CBre_Comp_11B <- glm (data=smp,
                      l_CBre~EffComp+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:EffComp +
                        b_UCA:cl_Ceil+
                       # PricingFee:cl_US6_avg_sal_lag1+
                       EffComp:cl_def6_ratio_lag1  +
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Comp_11B)

CBre_Cons_Comp_11A <- glm (data=smp,
                      l_CBre ~cl_def3_HHI_lag1+
                        cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+
                        cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+
                        EffComp+
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        cl_def6_HHI_lag1:cl_def6_ratio_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:EffComp + 
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        cl_def6_HHI_lag1:EffComp  +
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Cons_Comp_11A)
  
  stargazer::stargazer(CBre_Comp_10F,CBre_Comp_11A,CBre_Cons_Comp_09B,CBre_Cons_Comp_11A,
                       type="text",
                       digits=2)

summary_residual_compare(CBre_Comp_10F,CBre_Comp_11A,
                         CBre_Cons_Comp_09B,CBre_Cons_Comp_11A,bins=100)



```
VIF problems are still there. Moving on.

### Model 11C: Binned Offers
```{r Model11C}




#Create the model




CBre_Comp_11C <- glm (data=smp,
                      l_CBre~CompOffr+
                        cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        
                        cl_Ceil + cl_Days+ 
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                        
                        b_UCA:CompOffr +
                        b_UCA:cl_Ceil+
                       PricingFee:cl_US6_avg_sal_lag1+
                       # CompOffr:cl_def6_ratio_lag1  +
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Comp_11C)

CBre_Cons_Comp_11C <- glm (data=smp,
                      l_CBre ~cl_def3_HHI_lag1+
                        cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                        #cl_US3_avg_sal_lag1+
                        cl_def6_HHI_lag1+
                        cl_def6_obl_lag1+cl_def6_ratio_lag1+
                        cl_US6_avg_sal_lag1+
                        CompOffr+
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                        
                       
                        cl_def6_HHI_lag1:cl_def6_ratio_lag1  +
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:CompOffr + 
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        # cl_def6_HHI_lag1:CompOffr  +
                        Agency+
                        NAICS2
                      )
glmer_examine(CBre_Cons_Comp_11C)
  
  stargazer::stargazer(CBre_Comp_10F,CBre_Comp_11A,CBre_Comp_11C,
                       CBre_Cons_Comp_09B,CBre_Cons_Comp_11A,CBre_Cons_Comp_11C,
                       type="text",
                       digits=2)

summary_residual_compare(CBre_Comp_10F,CBre_Comp_11C,
                         CBre_Cons_Comp_09B,CBre_Cons_Comp_11C,bins=100)



```
#Multi-Level Model Cons Or Comp

## Agency/Office & NAICS6
###Model 12A: Too many Interactions
This initial run proved a bit premature, as incorporation of Agency as a dummy variable showed that many of the interactions included.
```{r Model12A}
load(file="Output//CBre_Cons_12A.rdata")

if(!exists("CBre_Cons_12A"))
  CBre_Cons_12A <- glmer (data=smp,
                          l_CBre ~cl_def6_HHI_lag1 +cl_def6_ratio_lag1+cl_def6_obl_lag1+
                            cl_US6_avg_sal_lag1+cl_def6_HHI_lag1:cl_def6_obl_lag1+ 
                            cl_Ceil + cl_Days+ 
                            Veh +
                            PricingFee + b_UCA +
                            b_Intl+
                            # Who+ Who is missing
                           
                            Veh:cl_Days+
                            
                            
                            cl_Ceil:PricingFee+
                            
                            b_UCA:cl_def6_HHI_lag1 + 
                            b_UCA:cl_Ceil+
                            # 6
                            
                            # Who:b_Intl+
                            (1 | NAICS) + (1 | Agency/Office)
                          ,
                          verbose=1)
glmer_examine(CBre_Cons_12A)

# CBre_Comp_12A <- glmer (data=smp,
#                       l_CBre ~CompOffr +
#                         cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+ 
#                         cl_Ceil + cl_Days+ 
#                         Veh  +
#                         PricingFee+ b_UCA +
#                         b_Intl+
                        # Who+ Who is missing
                       
                        # Veh:cl_Days+
                        
                        # 
                        # cl_Ceil:PricingFee+
                        # 
                        # b_UCA:cl_def6_HHI_lag1 + 
                        # b_UCA:cl_Ceil+
                        # 6
                        
                       # Who:b_Intl+
#                    (1 | NAICS) + (1 | Agency/Office)
#                       ,
                  # verbose=1)
# glmer_examine(CBre_Comp_12A)
# glmer_examine(CBre_Comp_12A)
# failure to converge in 10000 evaluation
summary_residual_compare(CBre_Cons_07B2,CBre_Cons_12A,CBre_Comp_07B2,CBre_Comp_06A3,bins=20)
save(CBre_Cons_12A,file="Output//CBre_Cons_12A.rdata")
```

The initial attempt to include the pre-existing intercepts and all inputs resulted in a model that initially failed to converge. Conservatively the intercepts have been temporarily removed to be added back in a subsequent step.

### Model 12B: Trimmed 
```{r Model12B}
#Frequency Plot
summary_discrete_plot(smp,"NAICS")

#This is currently running at home

CBre_Cons_12B <- glmer (data=smp,
                        l_CBre ~cl_def6_HHI_lag1 +cl_def6_ratio_lag1+cl_def6_obl_lag1+
                          cl_US6_avg_sal_lag1+
                          cl_Ceil + cl_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                         
                          
                          cl_def6_HHI_lag1:cl_def6_obl_lag1+ 
                          b_UCA:cl_def6_HHI_lag1 + 
                          b_UCA:cl_Ceil+

                          (1 | NAICS) + (1 | Agency/Office)
                        
                        ,
                        verbose=1)

glmer_examine(CBre_Cons_12B)

CBre_Comp_12B <-  glmer (data=smp,
                      l_CBre ~CompOffr +
                        cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        cl_Ceil + cl_Days+
                        Veh  +
                        PricingFee+ b_UCA +
                        b_Intl+
                    
                        b_UCA:CompOffr +
                        b_UCA:cl_Ceil+

                   (1 | NAICS) + (1 | Agency/Office)

                   ,
                  verbose=1)

glmer_examine(CBre_Comp_12B)
save(CBre_Comp_12B,file="CBre_Comp_12B.rdata")
summary_residual_compare(CBre_Cons_07B2,CBre_Cons_12B,CBre_Comp_07B2,CBre_Comp_06A3,bins=20)
```

## Agency/Office & NAICS3/6
###Model 13A: Agency/Office+NAICS6/NAICS3
The North American Industrial Classification system captures the sector of each contract, which are each given a seperate intercept in the model.
```{r Model13A}
load(file="Output//CBre_Cons_13A.rdata")

if(!exists("CBre_Cons_13A"))
  CBre_Cons_13A <- glmer (data=smp,
                          l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                            #cl_US3_avg_sal_lag1+
                            cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                            cl_US6_avg_sal_lag1+
                            cl_Ceil + cl_Days+ 
                            Veh +
                            PricingFee + b_UCA +
                            b_Intl+
                            # Who+
                           
                            Veh:cl_Days+
                            
                            Veh:cl_Ceil+
                            cl_Ceil:PricingFee+
                            cl_def6_HHI_lag1:cl_def6_obl_lag1+
                            b_UCA:cl_def6_HHI_lag1 + 
                            b_UCA:cl_Ceil+
                            # 6
                            b_Intl:Veh+ 
                            (1 | NAICS3/NAICS) + 
                            (1 | Agency/Office) 
                          # Who:b_Intl+
                          # NAICS2
                          ,
                          verbose=1)


glmer_examine(CBre_Cons_13A,display=TRUE)

save(CBre_Cons_13A,file="Output//CBre_Cons_13A.rdata")
```

###Model 13B: Agency/Office+NAICS6/NAICS3 trimmed
```{r Model13B}
load("Output//CBre_Cons_13B.rdata")

CBre_Cons_13B <- glmer (data=smp,
                        l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                          #cl_US3_avg_sal_lag1+
                          cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                          cl_US6_avg_sal_lag1+
                          cl_Ceil + cl_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                          
                          
                          
                          b_UCA:cl_def6_HHI_lag1 + 
                          b_UCA:cl_Ceil+
                          cl_def6_HHI_lag1:cl_def6_obl_lag1+
                          
                          (1 | NAICS3/NAICS) + 
                          (1 | Agency/Office) 
                        
                        ,
                        verbose=1)

glmer_examine(CBre_Cons_13B,display=TRUE)


  CBre_Cons_13B_1m <- glmer (data=smp1m,
                          l_CBre ~cl_def3_HHI_lag1+
                            cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                            #cl_US3_avg_sal_lag1+
                            cl_def6_HHI_lag1+
                            cl_def6_obl_lag1+cl_def6_ratio_lag1+
                            cl_US6_avg_sal_lag1+
                            cl_Ceil + cl_Days+ 
                            Veh +
                            PricingFee + b_UCA +
                            b_Intl+
                            
                            b_UCA:cl_def6_HHI_lag1 + 
                            b_UCA:cl_Ceil+
                            cl_def6_HHI_lag1:cl_def6_obl_lag1+
                            
                            (1 | NAICS3/NAICS) + 
                            (1 | Agency/Office), 
                          
                          family=binomial(link="logit"),
                          verbose=1)
glmer_examine(CBre_Cons_13B_1m,display=TRUE)

save(CBre_Cons_13B,file="Output//CBre_Cons_13B.rdata")
CBre_Comp_13B <- glmer (data=smp,
                        l_CBre~CompOffr+
                          cl_def3_ratio_lag1+
                          #cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                          CompOffr+
                          cl_def6_ratio_lag1+
                          cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                          cl_Ceil + cl_Days+
                          Veh  +
                          PricingFee+
                          b_UCA +
                          b_Intl+
                          
                          b_UCA:CompOffr +
                          b_UCA:cl_Ceil+
                          
                          (1 | NAICS3/NAICS) + (1 | Agency/Office)
                        ,
                        verbose=1)
glmer_examine(CBre_Comp_13B)

stargazer::stargazer(CBre_Cons_14A,CBre_Cons_13B,CBre_Comp_14A.restart,CBre_Comp_13B,type="text",
                     digits=2)



summary_residual_compare(CBre_Cons_14A,CBre_Cons_13B,CBre_Comp_14A.restart,CBre_Comp_13B,bins=20)



any(diag.vals<1e-6)

if(!exists("CBre_Cons_13B.devfun"))
  CBre_Cons_13B.devfun <- update(CBre_Cons_13B, devFunOnly=TRUE)


pars<-get_pars(CBre_Cons_13B)


if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Cons_13B.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Cons_13B.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(CBre_Cons_13_scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Cons_13B@optinfo$derivs

if(!exists("CBre_Cons_13B.restart"))
  CBre_Cons_13B.restart <- update(CBre_Cons_13B, start=pars)
glmer_examine(CBre_Cons_13B.restart)

save(CBre_Cons_13B,
     CBre_Cons_13B.devfun,
     CBre_Cons_13_scgrad,
     CBre_Cons_13B.restart,
     CBre_Comp_13B,
     CBre_Comp_13B.devfun,
     CBre_Comp_13B.restart,
     file="Output//CBre_Cons_13B.rdata")

source(system.file("utils", "allFit.R", package="lme4"))
CBre_Cons_13B.all <- allFit(CBre_Cons_13B)
CBre_Cons_13B_ss_cons <- summary(CBre_Cons_13B.all)

CBre_Comp_13C.all <- allFit(CBre_Comp_13C)
CBre_Comp_13C_ss_cons <- summary(CBre_Cons_13C.all)


#CBre Comp
if(!exists("CBre_Comp_13B.devfun"))
  CBre_Comp_13B.devfun <- update(CBre_Comp_13B, devFunOnly=TRUE)

pars<-get_pars(CBre_Comp_13B)

if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Comp_13B.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Comp_13B.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Comp_13B@optinfo$derivs

if(!exists("CBre_Comp_13B.restart"))
  CBre_Comp_13B.restart <- update(CBre_Comp_13B, start=pars)
glmer_examine(CBre_Comp_13B.restart)


save(CBre_Cons_13B,CBre_Comp_13B,CBre_Cons_13B.restart,CBre_Comp_13B.restart,
     file="Output//CBre_Cons_13B.rdata")

stargazer::stargazer(CBre_Cons_14A,CBre_Cons_13B,CBre_Cons_13B.restart,CBre_Comp_14A.restart,CBre_Comp_13B,type="text",
                     digits=2)



if(!exists("CBre_Cons_13B_1m_restart")){
   pars<-get_pars(CBre_Cons_13B_1m)
   CBre_Cons_13B_1m_restart <- update(CBre_Cons_13B_1m, 
                                      start=pars,
                                      verbose=1)
   save(CBre_Cons_13B,
        CBre_Cons_13B.restart,
        CBre_Cons_13B_1m,
        CBre_Cons_13B_1m_restart,
        file="Output//CBre_Cons_13B.rdata")
 }
stargazer::stargazer(CBre_Cons_13B,CBre_Cons_13B.restart,
                     CBre_Cons_13B_1m_restart,
                     CBre_Cons_13B_1m,type="text",
                     digits=2)
summary_residual_compare(CBre_Cons_13B,CBre_Cons_13B.restart,CBre_Cons_13B_1m,CBre_Cons_13B_1m_restart,bins=50)
glmer_examine(CBre_Cons_13B_1m)
glmer_examine(CBre_Cons_13B_1m_restart)
load("Output//CBre_Comp_13B.rdata")

summary(CBre_Cons_13B_1m_restart)
source(system.file("utils", "allFit.R", package="lme4"))
CBre_Cons_13B_1m_all <- allFit(CBre_Cons_13B_1m_restart)
ss_cons <- summary(CBre_Cons_13B_1m_all)
   save(CBre_Cons_13B,
        CBre_Cons_13B.restart,
        CBre_Cons_13B_1m,
        CBre_Cons_13B_1m_restart,
        CBre_Cons_13B_1m_all,
        file="Output//CBre_Cons_13B.rdata")

summary_residual_compare(CBre_Cons_13B,CBre_Cons_13B.restart,CBre_Comp_14A.restart,CBre_Comp_13B,bins=20)

summary(CBre_Cons_13B.restart)
source(system.file("utils", "allFit.R", package="lme4"))
CBre_Cons_13C.all <- allFit(CBre_Cons_13B.restart)
ss_cons <- summary(CBre_Cons_13C.all)

# str(CBre_Cons_13C.all[[1]])
# stargazer::stargazer(CBre_Cons_13C.all[[1]],
#                 CBre_Cons_13C.all[[2]],
#                 CBre_Cons_13C.all[[3]],
#                 CBre_Cons_13C.all[[4]],
#                 CBre_Cons_13C.all[[5]],
#                 CBre_Cons_13C.all[[6]],
#                 CBre_Cons_13C.all[[7]],type="text",
#                        digits=2)
# 
#               

save(CBre_Cons_13B,CBre_Comp_13B,CBre_Cons_13B.restart,CBre_Cons_13C.all,
     CBre_Comp_13B.restart,
     file="Output//CBre_Cons_13B.rdata")

# fm1.all <- allFit(CBre_Comp_13C)
# ss_comp <- summary(CBre_Comp_13C.all)
```


###Model 13C: Agency/Office+NAICS6/NAICS3 Binned Comp Offers
```{r Model13C}

CBre_Comp_13C <- glmer (data=smp,
                        l_CBre ~CompOffr+cl_def3_ratio_lag1+
                          #cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                          cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                          cl_Ceil + cl_Days+
                          Veh  +
                          PricingFee+
                          b_UCA +
                          b_Intl+
                          
                          b_UCA:CompOffr +
                          b_UCA:cl_Ceil+
                          
                          (1 | NAICS3/NAICS) + (1 | Agency/Office)
                        ,
                        verbose=1)
glmer_examine(CBre_Comp_13C)

CBre_Comp_13C_1m <- glmer (data=smp1m,
                        l_CBre ~CompOffr+cl_def3_ratio_lag1+
                          #cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                          cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                          cl_Ceil + cl_Days+
                          Veh  +
                          PricingFee+
                          b_UCA +
                          b_Intl+
                          
                          b_UCA:CompOffr +
                          b_UCA:cl_Ceil+
                          
                          (1 | NAICS3/NAICS) + (1 | Agency/Office)
                        ,
                        verbose=1)
glmer_examine(CBre_Comp_13C_1m)

save(CBre_Comp_13C,file="Output//CBre_Comp_13C.rdata")

  stargazer::stargazer(CBre_Comp_13B,CBre_Comp_13C,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_14A,CBre_Cons_13C,CBre_Comp_14A.restart,CBre_Comp_13C,bins=20)



any(diag.vals<1e-6)

if(!exists("CBre_Cons_13C.devfun"))
  CBre_Cons_13C.devfun <- update(CBre_Cons_13C, devFunOnly=TRUE)


pars<-get_pars(CBre_Cons_13C)
if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Cons_13C.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Cons_13C.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Cons_13C@optinfo$derivs

if(!exists("CBre_Cons_13C.restart"))
  CBre_Cons_13C.restart <- update(CBre_Cons_13C, start=pars)
glmer_examine(CBre_Cons_13C.restart)




#CBre Comp
if(!exists("CBre_Comp_13C.devfun"))
  CBre_Comp_13C.devfun <- update(CBre_Comp_13C, devFunOnly=TRUE)

pars<-get_pars(CBre_Comp_13C)
if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Comp_13C.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Comp_13C.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Comp_13C@optinfo$derivs

if(!exists("CBre_Comp_13C.restart"))
  CBre_Comp_13C.restart <- update(CBre_Comp_13C, start=pars)
glmer_examine(CBre_Comp_13C.restart)


  save(CBre_Cons_13C,CBre_Comp_13C,CBre_Cons_13C.restart,CBre_Comp_13C.restart,
       file="Output//CBre_Cons_13C.rdata")
  
stargazer::stargazer(CBre_Cons_14A,CBre_Cons_13C,CBre_Cons_13C.restart,CBre_Comp_14A.restart,CBre_Comp_13C,type="text",
                       digits=2)





  
load("Output//CBre_Comp_13C.rdata")

  summary_residual_compare(CBre_Cons_13C,CBre_Cons_13C.restart,CBre_Comp_14A.restart,CBre_Comp_13C,bins=20)


  source(system.file("utils", "allFit.R", package="lme4"))
  CBre_Cons_13C.all <- allFit(CBre_Cons_13C.restart)
  ss_cons <- summary(CBre_Cons_13C.all)
  save(CBre_Cons_13C,CBre_Comp_13C,CBre_Cons_13C.restart,CBre_Cons_13C.all,
       CBre_Comp_13C.restart,
       file="Output//CBre_Cons_13C.rdata")
  
  # fm1.all <- allFit(CBre_Comp_13C)
  # ss_comp <- summary(CBre_Comp_13C.all)
```

###Model 13D: Cluster Means
```{r Model13D}

load("Output//CBre_Cons_13D.rdata")

CBre_Cons_13D <- glmer (data=smp,
                        l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                          #cl_US3_avg_sal_lag1+
                          cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                          cl_US6_avg_sal_lag1+
                          c_office_l_Ceil + c_office_l_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                          b_UCA:cl_def6_HHI_lag1 + 
                          b_UCA:c_office_l_Ceil+
                          cl_def6_HHI_lag1:cl_def6_obl_lag1+
                          
                          (1 | NAICS3/NAICS) + 
                          (1 | Agency/Office) 
                        
                        ,
                        verbose=1)



glmer_examine(CBre_Cons_13D,display=TRUE)


CBre_Comp_13D <- glmer (data=smp,
                        l_CBre ~CompOffr+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                   CompOffr+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        c_office_l_Ceil + c_office_l_Days+
                        Veh  +
                        PricingFee+
                        b_UCA +
                        b_Intl+
                        
                        
                        
                        b_UCA:CompOffr +
                        b_UCA:c_office_l_Ceil+
                        
                        (1 | NAICS3/NAICS) + (1 | Agency/Office)
                      ,
                        verbose=1)
glmer_examine(CBre_Comp_13D)


  stargazer::stargazer(CBre_Cons_13C, CBre_Cons_13D,CBre_Comp_13C,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_13C,CBre_Cons_13D,#CBre_Comp_14A.restart,CBre_Comp_13D,
                         bins=20)

CBre_Cons_13C@devcomp$cmp[[8]]
CBre_Cons_13C@devcomp$cmp

any(diag.vals<1e-6)

if(!exists("CBre_Cons_13D.devfun"))
  CBre_Cons_13D.devfun <- update(CBre_Cons_13D, devFunOnly=TRUE)


pars<-get_pars(CBre_Cons_13D)


if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Cons_13D.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Cons_13D.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Cons_13D@optinfo$derivs

if(!exists("CBre_Cons_13D.restart"))
  CBre_Cons_13D.restart <- update(CBre_Cons_13D, start=pars)
glmer_examine(CBre_Cons_13D.restart)




#CBre Comp
if(!exists("CBre_Comp_13D.devfun"))
  CBre_Comp_13D.devfun <- update(CBre_Comp_13D, devFunOnly=TRUE)


pars<-get_pars(CBre_Comp_13D)



if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Comp_13D.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Comp_13D.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Comp_13D@optinfo$derivs

if(!exists("CBre_Comp_13D.restart"))
  CBre_Comp_13D.restart <- update(CBre_Comp_13D, start=pars)
glmer_examine(CBre_Comp_13D.restart)


  save(CBre_Cons_13D,CBre_Comp_13D,CBre_Cons_13D.restart,CBre_Comp_13D.restart,
       file="Output//CBre_Cons_13D.rdata")
  
stargazer::stargazer(CBre_Cons_13C,CBre_Cons_13D,CBre_Cons_13D.restart,
                    CBre_Comp_13C,CBre_Comp_13D,CBre_Comp_13D.restart,
                    type="text",
                       digits=2)





  save(CBre_Cons_13D,CBre_Comp_13D.devfun,CBre_Cons_13D.restart,
       CBre_Comp_13D,CBre_Comp_13D.devfun,CBre_Comp_13D.restart,
       file="Output//CBre_Cons_13D.rdata")
load("Output//CBre_Comp_13D.rdata")

  summary_residual_compare(CBre_Cons_13D,CBre_Cons_13D.restart,CBre_Comp_13D,CBre_Comp_13D.restart,bins=20)
  summary_residual_compare(CBre_Cons_13C,CBre_Cons_13D.restart,CBre_Comp_13C,CBre_Comp_13D.restart,bins=20)


```
###Model 13E: Interlevel Ceiling Slope
```{r Model13E}

load(file="Output//CBre_Cons_13E.rdata")
CBre_Cons_13E <- glmer (data=smp,
                        l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                          #cl_US3_avg_sal_lag1+
                          cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                          cl_US6_avg_sal_lag1+
                          c_office_l_Ceil + c_office_l_Days+ 
                          Veh +
                          PricingFee + b_UCA +
                          b_Intl+
                          
                          b_UCA:cl_def6_HHI_lag1 + 
                          b_UCA:c_office_l_Ceil+
                          cl_def6_HHI_lag1:cl_def6_obl_lag1+
                          
                          (1 | NAICS3/NAICS) + 
                          (1 | Agency) +
                          (1 + c_office_l_Ceil | Agency:Office) 
                        
                        ,
                        verbose=1)


glmer_examine(CBre_Cons_13E,display=TRUE)
save(CBre_Cons_13E,file="Output//CBre_Cons_13E.rdata")

CBre_Comp_13E <- glmer (data=smp,
                        l_CBre ~CompOffr+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                   CompOffr+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                        c_office_l_Ceil + c_office_l_Days+
                        Veh  +
                        PricingFee+
                        b_UCA +
                        b_Intl+
                        
                        
                        
                        b_UCA:CompOffr +
                        b_UCA:c_office_l_Ceil+
                        
                        (1 | NAICS3/NAICS) +
                                               (1 | Agency) +
                          (1 + c_office_l_Ceil | Agency:Office) 
                      ,
                        verbose=1)
glmer_examine(CBre_Comp_13E,display=TRUE)

save(CBre_Cons_13E,CBre_Comp_13E,file="Output//CBre_13E.rdata")
  stargazer::stargazer(CBre_Cons_13B, CBre_Cons_13D,CBre_Cons_13E,CBre_Comp_13B,type="text",
                       digits=2)
  
  
summary_residual_compare(CBre_Cons_13D,CBre_Cons_13E,#CBre_Comp_14A.restart,CBre_Comp_13E,
                         bins=100)
summary_residual_compare(CBre_Cons_13B,CBre_Cons_13E,#CBre_Comp_14A.restart,CBre_Comp_13E,
                         bins=100)



any(diag.vals<1e-6)

if(!exists("CBre_Cons_13E.devfun"))
  CBre_Cons_13E.devfun <- update(CBre_Cons_13E, devFunOnly=TRUE)


pars<-get_pars(CBre_Cons_13D)

if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Cons_13D.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Cons_13D.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Cons_13D@optinfo$derivs



if(!exists("CBre_Cons_13D.restart"))
  CBre_Cons_13D.restart <- update(CBre_Cons_13D, start=pars)
glmer_examine(CBre_Cons_13D.restart)


#CBre Comp
if(!exists("CBre_Comp_13D.devfun"))
  CBre_Comp_13D.devfun <- update(CBre_Comp_13D, devFunOnly=TRUE)



if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Comp_13D.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Comp_13D.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Comp_13D@optinfo$derivs

if(!exists("CBre_Comp_13D.restart"))
  CBre_Comp_13D.restart <- update(CBre_Comp_13D, start=pars)
glmer_examine(CBre_Comp_13D.restart)


  save(CBre_Cons_13D,CBre_Comp_13D,CBre_Cons_13D.restart,CBre_Comp_13D.restart,
       file="Output//CBre_Cons_13D.rdata")
  
stargazer::stargazer(CBre_Cons_13B,CBre_Cons_13D,CBre_Cons_13D.restart,
                    CBre_Comp_13B,CBre_Comp_13D,CBre_Comp_13D.restart,
                    type="text",
                       digits=2)





  save(CBre_Cons_13D,CBre_Comp_13D.devfun,CBre_Cons_13D.restart,
       CBre_Comp_13D,CBre_Comp_13D.devfun,CBre_Comp_13D.restart,
       file="Output//CBre_Cons_13D.rdata")
load("Output//CBre_Comp_13D.rdata")

  summary_residual_compare(CBre_Cons_13D,CBre_Cons_13D.restart,CBre_Comp_13D,CBre_Comp_13D.restart,bins=20)
  summary_residual_compare(CBre_Cons_13B,CBre_Cons_13D.restart,CBre_Comp_13B,CBre_Comp_13D.restart,bins=20)


```




###Model 13F: Agency/Office+NAICS6/NAICS3 Binned Comp Offers
```{r Model13F}

glmer_examine(CBre_Comp_13F)
save(CBre_Comp_13F,file="Output//CBre_Comp_13F.rdata")

  stargazer::stargazer(CBre_Comp_13B,CBre_Comp_13C,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_14A,CBre_Cons_13C,CBre_Comp_14A.restart,CBre_Comp_13C,bins=20)



any(diag.vals<1e-6)

if(!exists("CBre_Cons_13C.devfun"))
  CBre_Cons_13C.devfun <- update(CBre_Cons_13C, devFunOnly=TRUE)
pars<-get_pars(CBre_Cons_13C)

if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Cons_13C.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Cons_13C.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Cons_13C@optinfo$derivs

if(!exists("CBre_Cons_13C.restart"))
  CBre_Cons_13C.restart <- update(CBre_Cons_13C, start=pars)
glmer_examine(CBre_Cons_13C.restart)



```


#Multi-Level Model Both Cons and Comp 
##Agency/Office & NaICS7
###Model 14A: Base
```{r Model14A}
load("Output//CBre_Cons_Comp_14A.rdata")



CBre_Cons_Comp_14A <- glmer (data=smp,
                      l_CBre ~cl_def6_HHI_lag1 +cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+
                    CompOffr+
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                    
                       
                          +cl_def6_HHI_lag1:cl_def6_obl_lag1+ 
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:cl_def6_HHI_lag1 + 
                            b_UCA:CompOffr + 
                        b_UCA:cl_Ceil+
                        
        (1 | NAICS) + 
                        (1 | Agency/Office) 

                      )
glmer_examine(CBre_Cons_Comp_14A)
save(CBre_Cons_Comp_14A,"Output//CBre_Cons_Comp_14A.rdata")




  stargazer::stargazer(CBre_Cons_13A,CBre_Cons_13B,CBre_Comp_13A.restart,CBre_Comp_13B,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_13A,CBre_Cons_13B,CBre_Comp_13A.restart,CBre_Comp_13B,bins=20)



any(diag.vals<1e-6)

if(!exists("CBre_Cons_13B.devfun"))
  CBre_Cons_13B.devfun <- update(CBre_Cons_13B, devFunOnly=TRUE)
pars<-get_pars(CBre_Cons_13B)

if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Cons_13B.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Cons_13B.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Cons_13B@optinfo$derivs

if(!exists("CBre_Cons_13B.restart"))
  CBre_Cons_13B.restart <- update(CBre_Cons_13B, start=pars)
glmer_examine(CBre_Cons_13B.restart)




#CBre Comp
if(!exists("CBre_Comp_13B.devfun"))
  CBre_Comp_13B.devfun <- update(CBre_Comp_13B, devFunOnly=TRUE)
pars<-get_pars(CBre_Comp_13B)

if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Comp_13B.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Comp_13B.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Comp_13B@optinfo$derivs

if(!exists("CBre_Comp_13B.restart"))
  CBre_Comp_13B.restart <- update(CBre_Comp_13B, start=pars)
glmer_examine(CBre_Comp_13B.restart)


  save(CBre_Cons_13B,CBre_Comp_13B,CBre_Cons_13B.restart,CBre_Comp_13B.restart,
       file="Output//CBre_Cons_13B.rdata")
  
stargazer::stargazer(CBre_Cons_14A,CBre_Cons_13B,CBre_Cons_13B.restart,CBre_Comp_14A.restart,CBre_Comp_13B,type="text",
                       digits=2)





  save(CBre_Cons_13B,CBre_Comp_13B,CBre_Cons_13B.restart,
       file="Output//CBre_Cons_13B.rdata")
load("Output//CBre_Comp_13B.rdata")

  summary_residual_compare(CBre_Cons_13B,CBre_Cons_13B.restart,CBre_Comp_14A.restart,CBre_Comp_13B,bins=20)


  source(system.file("utils", "allFit.R", package="lme4"))
  CBre_Cons_13C.all <- allFit(CBre_Cons_13C)
  ss_cons <- summary(CBre_Cons_13C.all)

  fm1.all <- allFit(CBre_Comp_13C)
  ss_comp <- summary(CBre_Comp_13C.all)
```

###Model 14B: Switch fromCompOffr to CompOffr
```{r Model14B}
load("Output//CBre_Cons_Comp_14B.rdata")



CBre_Cons_Comp_14B <- glmer (data=smp,
                      l_CBre ~cl_def6_HHI_lag1 +cl_def6_ratio_lag1+cl_def6_obl_lag1+
                  cl_US6_avg_sal_lag1+
                    CompOffr+
                        cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                    
                       
                          +cl_def6_HHI_lag1:cl_def6_obl_lag1+ 
                        # Veh:cl_def6_HHI_lag1  +
                        b_UCA:cl_def6_HHI_lag1 + 
                            b_UCA:CompOffr + 
                        b_UCA:cl_Ceil+
                        
        (1 | NAICS) + 
                        (1 | Agency/Office) 

                      )
glmer_examine(CBre_Cons_Comp_14B)
save(CBre_Cons_Comp_14B,"Output//CBre_Cons_Comp_14B.rdata")




  stargazer::stargazer(CBre_Cons_13A,CBre_Cons_13B,CBre_Comp_13A.restart,CBre_Comp_13B,type="text",
                       digits=2)
  
  

summary_residual_compare(CBre_Cons_13A,CBre_Cons_13B,CBre_Comp_13A.restart,CBre_Comp_13B,bins=20)



any(diag.vals<1e-6)

if(!exists("CBre_Cons_13B.devfun"))
  CBre_Cons_13B.devfun <- update(CBre_Cons_13B, devFunOnly=TRUE)

pars<-get_pars(CBre_Cons_13B)
if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Cons_13B.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Cons_13B.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Cons_13B@optinfo$derivs

if(!exists("CBre_Cons_13B.restart"))
  CBre_Cons_13B.restart <- update(CBre_Cons_13B, start=pars)
glmer_examine(CBre_Cons_13B.restart)




#CBre Comp
if(!exists("CBre_Comp_13B.devfun"))
  CBre_Comp_13B.devfun <- update(CBre_Comp_13B, devFunOnly=TRUE)

pars<-get_pars(CBre_Comp_13B)
if (require("numDeriv")) {
  cat("hess:\n"); print(hess <- hessian(CBre_Comp_13B.devfun, unlist(pars)))
  cat("grad:\n"); print(grad <- grad(CBre_Comp_13B.devfun, unlist(pars)))
  cat("scaled gradient:\n")
  print(scgrad <- solve(chol(hess), grad))
}
## compare with internal calculations:
CBre_Comp_13B@optinfo$derivs

if(!exists("CBre_Comp_13B.restart"))
  CBre_Comp_13B.restart <- update(CBre_Comp_13B, start=pars)
glmer_examine(CBre_Comp_13B.restart)


  save(CBre_Cons_13B,CBre_Comp_13B,CBre_Cons_13B.restart,CBre_Comp_13B.restart,
       file="Output//CBre_Cons_13B.rdata")
  
stargazer::stargazer(CBre_Cons_14A,CBre_Cons_13B,CBre_Cons_13B.restart,CBre_Comp_14A.restart,CBre_Comp_13B,type="text",
                       digits=2)





  save(CBre_Cons_13B,CBre_Comp_13B,CBre_Cons_13B.restart,
       file="Output//CBre_Cons_13B.rdata")
load("Output//CBre_Comp_13B.rdata")

  summary_residual_compare(CBre_Cons_13B,CBre_Cons_13B.restart,CBre_Comp_14A.restart,CBre_Comp_13B,bins=20)


  source(system.file("utils", "allFit.R", package="lme4"))
  CBre_Cons_13C.all <- allFit(CBre_Cons_13C)
  ss_cons <- summary(CBre_Cons_13C.all)

  fm1.all <- allFit(CBre_Comp_13C)
  ss_comp <- summary(CBre_Comp_13C.all)
```

## Agency/Office & NAICS3/6
###Model 15A: Models 13B Cons and 13C Comp combined
```{r Model15A}
load("Output//CBre_Cons_Comp_15A.rdata")

CBre_Cons_Comp_15A <- glmer (data=smp,
                 l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                  #cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                  cl_US6_avg_sal_lag1+
                   CompOffr+
                                                cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                   
                       
                        
                        b_UCA:CompOffr +
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        cl_def6_HHI_lag1:cl_def6_obl_lag1+
                         
                        (1 | NAICS3/NAICS) + 
                        (1 | Agency/Office) 

                      ,
                        verbose=1)

save(CBre_Cons_Comp_15A,CBre_Cons_Comp_15A_1m,file="Output//CBre_Cons_Comp_15A.rdata")
glmer_examine(CBre_Cons_Comp_15A)


stargazer::stargazer(CBre_Cons_Comp_15A,CBre_Cons_Comp_15A_1m,type="text",
                       digits=2)
  stargazer::stargazer(CBre_Cons_13B,CBre_Comp_13C,CBre_Cons_Comp_14B,CBre_Cons_Comp_15A,CBre_Cons_Comp_15A_1m,type="text",
                       digits=2)
  
```


###Model 15B: Ratio instead of obligations
```{r Model15B}
load("Output//CBre_Cons_15B.rdata")

CBre_Cons_15B <- glmer (data=smp,
                 l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                  #cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                  cl_US6_avg_sal_lag1+
                                                cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                   
                       
                        
                        
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        cl_def6_ratio_lag1:cl_def6_HHI_lag1+
                         
                        (1 | NAICS3/NAICS) + 
                        (1 | Agency/Office) ,
                 
                 family=binomial(link="logit"),
                        verbose=1)

glmer_examine(CBre_Cons_15B,display=TRUE)

CBre_Cons_Comp_15B <- glmer (data=smp,
                 l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                  #cl_US3_avg_sal_lag1+
                   cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                  cl_US6_avg_sal_lag1+
                   CompOffr+
                                                cl_Ceil + cl_Days+ 
                        Veh +
                        PricingFee + b_UCA +
                        b_Intl+
                   
                       
                        
                        b_UCA:CompOffr +
                        b_UCA:cl_def6_HHI_lag1 + 
                        b_UCA:cl_Ceil+
                        cl_def6_ratio_lag1:cl_def6_HHI_lag1+
                         
                        (1 | NAICS3/NAICS) + 
                        (1 | Agency/Office) ,
                 
                 family=binomial(link="logit"),
                        verbose=1)



glmer_examine(CBre_Cons_Comp_15B,display=TRUE)


  stargazer::stargazer(CBre_Cons_13B,CBre_Comp_13C,CBre_Cons_Comp_14B,CBre_Cons_15B,CBre_Cons_Comp_15A,CBre_Cons_Comp_15B,type="text",
                       digits=2)

save(CBre_Cons_15B,CBre_Cons_Comp_15B,file="Output//CBre_15B.rdata")



```
The new variable proves to not be significant.

## Rare Events Logit
### Model 16A 1-level traditional
```{r Model16A}

# stargazer::stargazer(CBre_Cons_Comp_16A,type="text",
#                        digits=2)
# if(!exists("CBre_Cons_Comp_16A")){
  CBre_Cons_Comp_16A <- glm (data=smp,
                               l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                                 #cl_US3_avg_sal_lag1+
                                 cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                                 cl_US6_avg_sal_lag1+
                                 CompOffr+
                                   cl_Ceil + cl_Days+ 
                                 Veh +
                                 PricingFee + b_UCA +
                                 b_Intl+
                                 
                                 
                                 
                                 b_UCA:CompOffr +
                                 b_UCA:cl_def6_HHI_lag1 + 
                                 b_UCA:cl_Ceil+
                                 cl_def6_HHI_lag1:cl_def6_obl_lag1+
                                 
                                 NAICS3 + 
                                 Agency ,
                               family=binomial(link="logit"))
  
  CBre_Cons_Comp_16A_1m <- glm (data=smp1m,
                               l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                                 #cl_US3_avg_sal_lag1+
                                 cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                                 cl_US6_avg_sal_lag1+
                                 CompOffr+
                                 cl_Ceil + cl_Days+ 
                                 Veh +
                                 PricingFee + b_UCA +
                                 b_Intl+
                                 
                                 
                                 
                                 b_UCA:CompOffr +
                                 b_UCA:cl_def6_HHI_lag1 + 
                                 b_UCA:cl_Ceil+
                                 cl_def6_HHI_lag1:cl_def6_obl_lag1+
                                 
                                 NAICS3+
                                 Agency ,
                               family=binomial(link="logit"))
  
  # save(CBre_Cons_Comp_16A,CBre_Cons_Comp_16A_1m,file="..//Output//CBre_Cons_Comp_16A.rdata")
# }


# source(system.file("utils", "allFit.R", package="lme4"))
# CBre_Cons_Comp_16A_1m.all <- allFit(CBre_Cons_Comp_16A_1m)
# CBre_Cons_Comp_16A_1m_ss_cons <- summary(CBre_Cons_Comp_16A_1m.all)
# 
# 
# glmer_examine(CBre_Cons_Comp_16A,display=TRUE)
# CBre_Cons_Comp_16A_odds_ratio<-odds_ratio(CBre_Cons_Comp_16A,"CBre_Cons_Comp_16A")
# get_icc(CBre_Cons_Comp_16A)
```


### Model 16B 1-level rare events
```{r Model16B}

# stargazer::stargazer(CBre_Cons_Comp_16B,type="text",
#                        digits=2)
# if(!exists("CBre_Cons_Comp_16B")){
  CBre_Cons_Comp_16B <- Zelig::zelig(data=as.data.frame(smp),
                               l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                                 #cl_US3_avg_sal_lag1+
                                 cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                                 cl_US6_avg_sal_lag1+
                                 CompOffr+
                                   cl_Ceil + cl_Days+ 
                                 Veh +
                                 PricingFee + b_UCA +
                                 b_Intl+
                                 
                                 
                                 
                                 b_UCA:CompOffr +
                                 b_UCA:cl_def6_HHI_lag1 + 
                                 b_UCA:cl_Ceil+
                                 cl_def6_HHI_lag1:cl_def6_obl_lag1+
                                 
                                 NAICS3 + 
                                 Agency ,
                               model="relogit")
  
  CBre_Cons_Comp_16B_1m <- Zelig::zelig(data=as.data.frame(smp1m),
                               l_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                                 #cl_US3_avg_sal_lag1+
                                 cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                                 cl_US6_avg_sal_lag1+
                                 CompOffr+
                                 cl_Ceil + cl_Days+ 
                                 Veh +
                                 PricingFee + b_UCA +
                                 b_Intl+
                                 
                                 
                                 
                                 b_UCA:CompOffr +
                                 b_UCA:cl_def6_HHI_lag1 + 
                                 b_UCA:cl_Ceil+
                                 cl_def6_HHI_lag1:cl_def6_obl_lag1+
                                 
                                 NAICS3+
                                 Agency ,
                                model="relogit")
  
  # save(CBre_Cons_Comp_16B,CBre_Cons_Comp_16B_1m,file="..//Output//CBre_Cons_Comp_16B.rdata")
# }
load("..//Output//CBre_Cons_Comp_15A.rdata")
screenreg(list(CBre_Cons_Comp_15A, CBre_Cons_Comp_16A,CBre_Cons_Comp_16B,
               CBre_Cons_Comp_15A_1m,CBre_Cons_Comp_16A_1m,CBre_Cons_Comp_16B_1m))


# source(system.file("utils", "allFit.R", package="lme4"))
# CBre_Cons_Comp_16B_1m.all <- allFit(CBre_Cons_Comp_16B_1m)
# CBre_Cons_Comp_16B_1m_ss_cons <- summary(CBre_Cons_Comp_16B_1m.all)
# 
# 
# glmer_examine(CBre_Cons_Comp_16B,display=TRUE)
# CBre_Cons_Comp_16B_odds_ratio<-odds_ratio(CBre_Cons_Comp_16B,"CBre_Cons_Comp_16B")
# get_icc(CBre_Cons_Comp_16B)
```


