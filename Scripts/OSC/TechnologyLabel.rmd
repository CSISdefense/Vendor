---
title: "hightech Text Label"
author: "Greg Sanders"
date: "2022-07-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(RTextTools)
library(readr)
library(csis360)
library(dplyr)
library(tidyr)
library(openxlsx)

# dir.exists(file.path("..","..","Data","semi_clean","OSC"))
# f<-list.files(file.path("..","..","Data","semi_clean","OSC"))
# 
# file.exists(file.path("..","..","Data","semi_clean","OSC","SelectedLoanDataSet.rda"))
load("..\\..\\Data\\semi_clean\\OSC\\SelectedLoanDataSet.rda")

 
  
  # loan<-loan %>% filter(cfda_title!="DISASTER ASSISTANCE LOANS")

loanEnergy<-standardize_variable_names(loanEnergy)

# View(loan %>% filter(cfda_title=="DISASTER ASSISTANCE LOANS"))

# write.csv(unique(loan$recipient_uei[loan$cfda_title=="DISASTER ASSISTANCE LOANS"]),file="disast_nam.csv")
# 
descrip<-loanEnergy %>% group_by(transaction_description) %>%
  summarise(n=nrow(total_obligated_amount))
load(file="../../Data/Semi_Clean/OSC/exim.rda")  

load(file=file.path("..","..","data","semi_Clean","OSC","sba_programs.rda"))
```

# Setup

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

## Description Label function
```{r labeling_function}

label_keyword<-function(x,keyword,col="transaction_description"){
  x<-as.data.frame(x)
  tags<-unique(keyword$tag)
  if(any(tags %in% colnames(x)))
    tags[tags %in% colnames(x)]
    warning("Tag column(s) already exists")
  if(any("AnyTag" %in% colnames(x))){
    tags[tags %in% colnames(x)]
    warning("AnyTag column already exists")
  }else{
    x$AnyTag<-NA
  }
  for(i in 1:nrow(keyword)){
    if(!keyword$tag[i] %in% colnames(x))
      x[keyword$tag[i]]<-NA
    x[grep(keyword$keyword[i],x[,col],ignore.case = TRUE),keyword$tag[i]]<-TRUE
    x$AnyTag[x[,keyword$tag[i]]==TRUE & !is.na(x[,keyword$tag[i]])]<-TRUE
  }
  x
}


```


# Assign labels



## Description Labeling
```{r DescriptionLabels}

keyword<-read_csv("..//..//data//semi_clean//OSC//osc_keyword_list.csv")
col<-"transaction_description"
labeled<-label_keyword(descrip,keyword)
summary(labeled)

loanEnergy<-left_join(loanEnergy,labeled,by="transaction_description")

#Product label is just the NAICS/SIC category description
label_exim<-label_keyword(exim,keyword,"Product.Description")
# label_exim<-exim

```

### CFDA labeling
```{r CFDSlabels}
loanEnergy$HighTech[loanEnergy$cfda_num %in% c("81.112","81.126","59.058")|
                   loanEnergy$cfda_title %in% c("STEWARDSHIP SCIENCE GRANT PROGRAM",
                                     "FEDERAL LOAN GUARANTEES FOR INNOVATIVE ENERGY TECHNOLOGIES",
                                     "FEDERAL AND STATE TECHNOLOGY PARTNERSHIP PROGRAM")]<-TRUE
loanEnergy$AnyTag[loanEnergy$cfda_num %in% c("81.112","81.126","59.058")|
                   loanEnergy$cfda_title %in% c("STEWARDSHIP SCIENCE GRANT PROGRAM",
                                     "FEDERAL LOAN GUARANTEES FOR INNOVATIVE ENERGY TECHNOLOGIES",
                                     "FEDERAL AND STATE TECHNOLOGY PARTNERSHIP PROGRAM")]<-TRUE

loanEnergy$Renewable[loanEnergy$cfda_num %in% c("81.126")|
                   loanEnergy$cfda_title %in% c("FEDERAL LOAN GUARANTEES FOR INNOVATIVE ENERGY TECHNOLOGIES")]<-TRUE
loanEnergy$AnyTag[loanEnergy$cfda_num %in% c("81.126")|
                   loanEnergy$cfda_title %in% c("FEDERAL LOAN GUARANTEES FOR INNOVATIVE ENERGY TECHNOLOGIES")]<-TRUE

```

### NAICS labels

```{r NAICSlabels}

label_exim<-read_and_join_experiment(label_exim,
                         lookup_file="Lookup_PrincipalNAICScode.csv",
                         directory="economic//",
                         by=c("Primary.Export.Product.NAICS"="principalnaicscode"),
                         add_var=c("CriticalTech"),
                         skip_check_var =c("CriticalTech"),
                         missing_file="naics.csv")
label_exim$CriticalTech[label_exim$CriticalTech==""]<-NA
label_exim$AnyTag[!is.na(label_exim$CriticalTech)]<-TRUE

# sba.504$
# write.csv(sba.504 %>% group_by(NaicsCode,NaicsDescription) %>%summarise(),"naics_all.csv")
test<-as.Date(sba.504$ApprovalDate,"%m/%d/%Y")
if(any(is.na(test)&!is.na(sba.504$ApprovalDate))){
  sba.504$ApprovalDate[is.na(test)&!is.na(sba.504$ApprovalDate)]
  stop("Malformed date")
} else {
  sba.504$ApprovalDate<-test
  sba.504$ApprovalYear<-year(sba.504$ApprovalDate)
  rm(test)
}

sba.504 <- read_and_join_experiment(sba.504,
                         lookup_file="Lookup_PrincipalNAICScode.csv",
                         directory="economic//",
                         by=c("NaicsCode"="principalnaicscode"),
                         add_var=c("CriticalTech"),
                         skip_check_var =c("CriticalTech"),
                         missing_file="naics.csv")
sba.504$AnyTag<-NA
sba.504$AnyTag[!is.na(sba.504$CriticalTech) & sba.504$CriticalTech!=""]<-TRUE
summary(sba.504$AnyTag)




(
sba.504tech<-build_plot(
  data=sba.504,
  chart_geom = "Bar Chart",
  share = TRUE,
  # labels_and_colors=loan_lc,
  # column_key=loan_ck,
  # NA, #VAR.ncol
  x_var="ApprovalYear", 
  # alpha_var="YTD",  #x_var 
  y_var="GrossApproval", #VAR.y.variable
  color_var="CriticalTech", #color_var
  # facet_var="awarding_agency_name", #facet_var
  format=TRUE,
  ytextposition=FALSE
)+#date_x_year_breaks(2000,2020,3,partial_year=2023,partial_label="\nQ1-Q2")+scale_alpha_ordinal(range=c(1,0.5))+
  theme(legend.position = "right")+
  labs(y="Gross Approval")# (Constant 2022 $s)
)


sba.7a <- read_and_join_experiment(sba.7a,
                         lookup_file="Lookup_PrincipalNAICScode.csv",
                         directory="economic//",
                         by=c("NaicsCode"="principalnaicscode"),
                         add_var=c("CriticalTech"),
                         skip_check_var =c("CriticalTech"),
                         missing_file="naics7a.csv")
sba.7a$AnyTag<-NA
sba.7a$AnyTag[!is.na(sba.7a$CriticalTech) & sba.7a$CriticalTech!=""]<-TRUE
summary(sba.7a$AnyTag)




(
sba.7a<-build_plot(
  data=sba.7a,
  chart_geom = "Bar Chart",
  share = TRUE,
  # labels_and_colors=loan_lc,
  # column_key=loan_ck,
  # NA, #VAR.ncol
  x_var="ApprovalFiscalYear", 
  # alpha_var="YTD",  #x_var 
  y_var="GrossApproval", #VAR.y.variable
  color_var="CriticalTech", #color_var
  # facet_var="awarding_agency_name", #facet_var
  format=TRUE,
  ytextposition=FALSE
)+#date_x_year_breaks(2000,2020,3,partial_year=2023,partial_label="\nQ1-Q2")+scale_alpha_ordinal(range=c(1,0.5))+
  theme(legend.position = "right")+
  labs(y="Gross Approval")# (Constant 2022 $s)
)




sba.sbg <- read_and_join_experiment(sba.sbg,
                         lookup_file="Lookup_PrincipalNAICScode.csv",
                         directory="economic//",
                         by=c("PROJECT_NAICS"="principalnaicscode"),
                         add_var=c("CriticalTech"),
                         skip_check_var =c("CriticalTech"),
                         missing_file="naics_sbg.csv")
sba.sbg$AnyTag<-NA
sba.sbg$AnyTag[!is.na(sba.sbg$CriticalTech) & sba.sbg$CriticalTech!=""]<-TRUE
summary(sba.sbg$AnyTag)



sba.sbg$count<-1
(
sba.sbg_contract<-build_plot(
  data=sba.sbg  %>% filter(!is.na(PROJECT_START_DATE)),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=loan_lc,
  # column_key=loan_ck,
  # NA, #VAR.ncol
  x_var="ProjectStartYear", 
  # alpha_var="YTD",  #x_var 
  y_var="LARGEST_CONTRACT", #VAR.y.variable
  color_var="CriticalTech", #color_var
  # facet_var="awarding_agency_name", #facet_var
  format=TRUE,
  ytextposition=FALSE
)+#date_x_year_breaks(2000,2020,3,partial_year=2023,partial_label="\nQ1-Q2")+scale_alpha_ordinal(range=c(1,0.5))+
  theme(legend.position = "right")+
  labs(y="Largest Contract")# (Constant 2022 $s)
)

(
sba.sbg_count<-build_plot(
  data=sba.sbg  %>% filter(!is.na(PROJECT_START_DATE)),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=loan_lc,
  # column_key=loan_ck,
  # NA, #VAR.ncol
  x_var="ProjectStartYear", 
  # alpha_var="YTD",  #x_var 
  y_var="count", #VAR.y.variable
  color_var="CriticalTech", #color_var
  # facet_var="awarding_agency_name", #facet_var
  format=TRUE,
  ytextposition=FALSE
)+#date_x_year_breaks(2000,2020,3,partial_year=2023,partial_label="\nQ1-Q2")+scale_alpha_ordinal(range=c(1,0.5))+
  theme(legend.position = "right")+
  labs(y="Count")# (Constant 2022 $s)
)

sba_unified<-
  rbind(sba.504 %>% mutate(StartYear=ApprovalFiscalYear,Amount=GrossApproval,
                           program="504") %>%
          dplyr::select(StartYear, Amount,CriticalTech,program),
        sba.7a %>% mutate(StartYear=ApprovalFiscalYear,Amount=GrossApproval,
                           program="7(A)") %>%
          dplyr::select(StartYear, Amount,CriticalTech,program),
        sba.sbg %>% mutate(StartYear=ProjectStartYear,Amount=LARGEST_CONTRACT,
                           program="SBG") %>%
          dplyr::select(StartYear, Amount,CriticalTech,program))
        


(
sba_crosscut<-build_plot(
  data=sba_unified  %>% filter(!is.na(StartYear)),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=loan_lc,
  # column_key=loan_ck,
  # NA, #VAR.ncol
  x_var="StartYear", 
  # alpha_var="YTD",  #x_var 
  y_var="Amount", #VAR.y.variable
  color_var="CriticalTech", #color_var
  facet_var="program", #facet_var
  format=TRUE,
  ytextposition=FALSE
)+#date_x_year_breaks(2000,2020,3,partial_year=2023,partial_label="\nQ1-Q2")+scale_alpha_ordinal(range=c(1,0.5))+
  theme(legend.position = "right")+
  labs(y="Gross Amount or Largest Project")# (Constant 2022 $s)
)

save(sba.504,sba.7a,sba.sbg,sbic_providers,file=file.path("..","..","data","semi_Clean","OSC","sba_programs.rda"))

wb<-loadWorkbook(file=file.path("..","..","Output","OSC","selected_assistance_critical_tech.xlsx"))
writeData(wb, sheet="504-foia",sba.504 %>% filter(AnyTag==TRUE & !is.na(AnyTag)))
writeData(wb, sheet="7a-foia",stringi::stri_enc_toutf8(sba.7a) %>% filter(AnyTag==TRUE & !is.na(AnyTag)))
writeData(wb, sheet="sbg-foia",sba.sbg %>% filter(AnyTag==TRUE & !is.na(AnyTag)))
write.csv(file=file.path("..","..","Output","OSC","critical_tech_csv",
foia_sba_critical_tech.csv"),sba.504 %>% filter(AnyTag==TRUE & !is.na(AnyTag)))
write.csv(file=file.path("..","..","Output","OSC","critical_tech_csv",
"foia_sba_7a_critical_tech.csv"),sba.7a %>% filter(AnyTag==TRUE& !is.na(AnyTag)))
write.csv(file=file.path("..","..","Output","OSC","critical_tech_csv",
"foia_sba_sbg_critical_tech.csv"),sba.sbg %>% filter(AnyTag==TRUE& !is.na(AnyTag)))
    saveWorkbook(wb,file=(file.path(path,xlsx)),overwrite = TRUE)

write.csv(file=file.path("..","..","Output","OSC","sbic_providers.csv"),sbic_providers)

```




## Output
```{r TagOutput}
write_csv(loanEnergy %>% filter(AnyTag==TRUE & !is.na(AnyTag)),file="../../data/semi_clean/OSC/USAspending_Energy_OSCtagged.csv",na = "")
write_csv(label_exim %>% filter(AnyTag==TRUE & !is.na(AnyTag)),file="../../data/semi_clean/OSC/EXIMtagged.csv",na = "")
save(loanEnergy,label_exim,file="../../data/semi_clean/OSC/OSCselectedTagged.rda",na = "")
```


### Expanding labels to contracts

You can also embed plots, for example:

```{r contract_expansion}

loan <- read_delim(
  "..//data_raw//OTA_All_Fields.csv",delim = ",",
  col_names = TRUE, guess_max = 500000,na=c("NA","NULL"),skip = 2)
loan<-standardize_variable_names(loan)


loan<-read_and_join_experiment(loan,
                         path="..//data_raw//",dir="",lookup_file = "OTA_descrip_row_number.csv",
                         add_var="descrip_row_number",
                         # skip_check_var = "Remotely_Crewed",
                         by="Description_of_Requirement")

loan<-read_and_join_experiment(loan,
                         path="..//data//semi_clean//",dir="",lookup_file = "ota_description_UAS.csv",
                         add_var="Remotely_Crewed",
                         # skip_check_var = "Remotely_Crewed",
                         by="descrip_row_number",
                         col_types = "cnccccccccc")

loan$Remotely_Crewed[loan$Remotely_Crewed %in% c("","FALSE")]<-NA


sum(text_to_number(loan$Action_Obligation)[loan$Remotely_Crewed %in% c("hightech","hightech/C-hightech")])


#This is incredibly slow ~20m, perhaps because of all the warning it prints.
# loan<-loan %>% group_by(`PIIDAgencyID`,PIID,`ReferencedIDVAgencyID`,Referenced_IDV_PIID) %>%
#   mutate(max_rc=max(Remotely_Crewed,na.rm=TRUE),
#          min_rc=min(Remotely_Crewed,na.rm=TRUE))

Remotely_Crewed_CAU<-loan %>% filter(Remotely_Crewed %in% c("hightech","hightech/C-hightech"))%>%
  group_by(PIIDAgencyID,PIID,ReferencedIDVAgencyID,Referenced_IDV_PIID,
           Remotely_Crewed) %>% dplyr::summarise()

Remotely_Crewed_CAU$ReferencedIDVAgencyID[is.na(Remotely_Crewed_CAU$ReferencedIDVAgencyID)]<-""

# Training and Readiness Accelerator (TReX) does include hightech, but is a  broader OTA.
Remotely_Crewed_CAU<-Remotely_Crewed_CAU %>% filter(PIID!="W900KK1890005") 

colnames(Remotely_Crewed_CAU)[colnames(Remotely_Crewed_CAU)=="Remotely_Crewed"]<-"Remotely_Crewed_CAU"
write_csv(Remotely_Crewed_CAU,file.path("..","data","semi_clean","ota_CAU_UAS.csv"))


# 
# write.csv(loan %>% select(`PIIDAgencyID`,PIID,`ReferencedIDVAgencyID`,Referenced_IDV_PIID,
#                                  Description_of_Requirement,Remotely_Crewed,max_rc,min_rc,Action_Obligation)
#      %>% filter(max_rc=='hightech'|min_rc=="hightech"),"CUA_OTA_check.csv")
# 
# 
# write.csv(loan %>% select(`PIIDAgencyID`,PIID,`ReferencedIDVAgencyID`,Referenced_IDV_PIID,
#                                  Description_of_Requirement,Remotely_Crewed,max_rc,min_rc,Action_Obligation,
#                                  ProductOrServiceCode)
#      %>% filter(!is.na(max_rc) | ProductOrServiceCode=="1550"),"CUA_OTA_rc_check.csv")
# 
# summary(factor(loan$Remotely_Crewed[loan$ProductOrServiceCode=="1550"]))



```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

