---
title: "hightech Text Label"
author: "Greg Sanders"
date: "2022-07-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(RTextTools)
library(readr)
library(ggplot2)
library(csis360)
library(dplyr)
library(tidyr)
library(openxlsx)

# dir.exists(file.path("..","..","Data","semi_clean","OSC"))
# f<-list.files(file.path("..","..","Data","semi_clean","OSC"))
# 
# file.exists(file.path("..","..","Data","semi_clean","OSC","SelectedLoanDataSet.rda"))
load("..\\..\\Data\\semi_clean\\OSC\\SelectedLoanDataSet.rda")

 
  
  # loan<-loan %>% filter(cfda_title!="DISASTER ASSISTANCE LOANS")

# loanSelected<-standardize_variable_names(loanSelected)

# View(loan %>% filter(cfda_title=="DISASTER ASSISTANCE LOANS"))

# write.csv(unique(loan$recipient_uei[loan$cfda_title=="DISASTER ASSISTANCE LOANS"]),file="disast_nam.csv")
# 
descrip<-loanSelected %>% group_by(transaction_description) %>%
  summarise(n=nrow(total_obligated_amount))
load(file="../../Data/Semi_Clean/OSC/exim.rda")  

load(file=file.path("..","..","data","semi_Clean","OSC","sba_programs.rda"))



```

# Setup

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

## Description Label function
```{r labeling_function}

label_keyword<-function(x,keyword,col="transaction_description"){
  x<-as.data.frame(x)
  tags<-unique(keyword$tag)
  if(any(tags %in% colnames(x)))
    tags[tags %in% colnames(x)]
    warning("Tag column(s) already exists")
  if(any("AnyTag" %in% colnames(x))){
    tags[tags %in% colnames(x)]
    warning("AnyTag column already exists")
  }else{
    x$AnyTag<-NA
  }
  for(i in 1:nrow(keyword)){
    if(!keyword$tag[i] %in% colnames(x))
      x[keyword$tag[i]]<-NA
    x[grep(keyword$keyword[i],x[,col],ignore.case = TRUE),keyword$tag[i]]<-TRUE
    x$AnyTag[x[,keyword$tag[i]]==TRUE & !is.na(x[,keyword$tag[i]])]<-TRUE
  }
  x
}


```


# Assign labels



## Description Labeling
```{r DescriptionLabels}

keyword<-read_csv("..//..//data//semi_clean//OSC//osc_keyword_list.csv")
col<-"transaction_description"
labeled<-label_keyword(descrip,keyword)
colnames(loanSelected)
summary(labeled)

loanSelected<-loanSelected[,!colnames(loanSelected) %in%
                             colnames(loanSelected)[grep("\\.x$",colnames(loanSelected))]]
loanSelected<-loanSelected[,!colnames(loanSelected) %in%
                             colnames(loanSelected)[grep("\\.y$",colnames(loanSelected))]]

loanSelected<-loanSelected[,!colnames(loanSelected) %in% 
                                       colnames(labeled)[!colnames(labeled) %in% c("transaction_description","AnyTag")]]
loanSelected<-left_join(loanSelected,labeled,by="transaction_description")

#Product label is just the NAICS/SIC category description
exim<-label_keyword(exim,keyword,"Product.Description")
# exim<-exim


```

### CFDA labeling
```{r CFDSlabels}
loanSelected$HighTech[loanSelected$cfda_num %in% c("81.112","81.126","59.058")|
                   loanSelected$cfda_title %in% c("STEWARDSHIP SCIENCE GRANT PROGRAM",
                                     "FEDERAL LOAN GUARANTEES FOR INNOVATIVE ENERGY TECHNOLOGIES",
                                     "FEDERAL AND STATE TECHNOLOGY PARTNERSHIP PROGRAM")]<-TRUE
loanSelected$AnyTag[loanSelected$cfda_num %in% c("81.112","81.126","59.058")|
                   loanSelected$cfda_title %in% c("STEWARDSHIP SCIENCE GRANT PROGRAM",
                                     "FEDERAL LOAN GUARANTEES FOR INNOVATIVE ENERGY TECHNOLOGIES",
                                     "FEDERAL AND STATE TECHNOLOGY PARTNERSHIP PROGRAM")]<-TRUE

loanSelected$Renewable[loanSelected$cfda_num %in% c("81.126")|
                   loanSelected$cfda_title %in% c("FEDERAL LOAN GUARANTEES FOR INNOVATIVE ENERGY TECHNOLOGIES")]<-TRUE
loanSelected$AnyTag[loanSelected$cfda_num %in% c("81.126")|
                   loanSelected$cfda_title %in% c("FEDERAL LOAN GUARANTEES FOR INNOVATIVE ENERGY TECHNOLOGIES")]<-TRUE



```

### NAICS labels

```{r NAICSlabels}

# 
# write.csv(exim %>% group_by(Primary.Export.Product.NAICS,Product.Description) %>%
#             filter(!is.na(Primary.Export.Product.NAICS))%>% summarise(),"exim_naics_all.csv")
exim<-read_and_join_experiment(exim,
                         lookup_file="Lookup_PrincipalNAICScode.csv",
                         directory="economic//",
                         by=c("Primary.Export.Product.NAICS"="principalnaicscode"),
                         add_var=c("CriticalTech"),
                         skip_check_var =c("CriticalTech"),
                         missing_file="exim_naics.csv")
exim$CriticalTech[exim$CriticalTech==""]<-NA
exim$AnyTag[!is.na(exim$CriticalTech)]<-TRUE

# sba.504$
# write.csv(sba.504 %>% group_by(NaicsCode,NaicsDescription) %>%summarise(),"naics_all.csv")

sba.504 <- read_and_join_experiment(sba.504,
                         lookup_file="Lookup_PrincipalNAICScode.csv",
                         directory="economic//",
                         by=c("NaicsCode"="principalnaicscode"),
                         add_var=c("CriticalTech"),
                         skip_check_var =c("CriticalTech"),
                         missing_file="naics.csv")
sba.504$AnyTag<-NA
sba.504$AnyTag[!is.na(sba.504$CriticalTech) & sba.504$CriticalTech!=""]<-TRUE
summary(sba.504$AnyTag)



sba.7a <- read_and_join_experiment(sba.7a,
                         lookup_file="Lookup_PrincipalNAICScode.csv",
                         directory="economic//",
                         by=c("NaicsCode"="principalnaicscode"),
                         add_var=c("CriticalTech"),
                         skip_check_var =c("CriticalTech"),
                         missing_file="naics7a.csv")
sba.7a$AnyTag<-NA
sba.7a$AnyTag[!is.na(sba.7a$CriticalTech) & sba.7a$CriticalTech!=""]<-TRUE
summary(sba.7a$AnyTag)





sba.sbg <- read_and_join_experiment(sba.sbg,
                         lookup_file="Lookup_PrincipalNAICScode.csv",
                         directory="economic//",
                         by=c("PROJECT_NAICS"="principalnaicscode"),
                         add_var=c("CriticalTech"),
                         skip_check_var =c("CriticalTech"),
                         missing_file="naics_sbg.csv")
sba.sbg$AnyTag<-NA
sba.sbg$AnyTag[!is.na(sba.sbg$CriticalTech) & sba.sbg$CriticalTech!=""]<-TRUE
summary(sba.sbg$AnyTag)





```

### Recipient labeling
```{r Recipient}
loanSelected<-read_and_join_experiment(loanSelected,
                         lookup_file="DOE_LPO_uei.csv",
                         path=file.path("..","..","Data","semi_clean","OSC"),
                         directory="",
                         by=c("recipient_uei"="recipient_uei"),
                         add_var=c("project_name"),
                         skip_check_var =c("project_name"))

if(nrow(loanSelected %>% filter(awarding_agency_name =="Department of Energy"))==0)
   stop("DOE missing from loanSelect")
#Kludge for a missing UEI.
summary(factor(loanSelected$project_name))
loanSelected$project_name[loanSelected$recipient_name=="ULTIUM CELLS LLC"& is.na(loanSelected$recipient_uei)]<-"Ultium Cells"
if(nrow(loanSelected %>% filter(awarding_agency_name =="Department of Energy" & is.na(project_name)))>0){
  view(loanSelected %>% filter(awarding_agency_name =="Department of Energy" & is.na(project_name)))
   stop("Project name missing from some DoE")
}
summary(factor(loanSelected$project_name))

loanSelected<-read_and_join_experiment(loanSelected,
                         lookup_file="DOE_LPO_project",
                         path=file.path("..","..","Data","semi_clean","OSC"),
                         directory="",
                         by=c("project_name"="project_name"),
                         # add_var=c("project_name"),
                         # skip_check_var =c("project_name")
                         )

```

# Output



```{r TagOutput}

wb<-loadWorkbook(file=file.path("..","..","Output","OSC","selected_assistance_critical_tech.xlsx"))
writeData(wb, sheet="504-foia",sba.504 %>% filter(AnyTag==TRUE & !is.na(AnyTag)))
writeData(wb, sheet="7a-foia",sba.7a %>% filter(AnyTag==TRUE & !is.na(AnyTag)))
colnames(sba.7a)
writeData(wb, sheet="sbg-foia",sba.sbg %>% filter(AnyTag==TRUE & !is.na(AnyTag)))
writeData(wb, sheet="ExIm",exim %>% filter(AnyTag==TRUE & !is.na(AnyTag)))
writeData(wb, sheet="USAspending",loanSelected %>% filter(AnyTag==TRUE & !is.na(AnyTag)))
saveWorkbook(wb,file=file.path("..","..","Output","OSC","selected_assistance_critical_tech.xlsx"),overwrite = TRUE)


write.csv(file=file.path("..","..","Output","OSC","critical_tech_csv",
                         "foia_sba_critical_tech.csv"),sba.504 %>% filter(AnyTag==TRUE & !is.na(AnyTag)),
          row.names = FALSE)
write.csv(file=file.path("..","..","Output","OSC","critical_tech_csv",
                         "foia_sba_7a_critical_tech.csv"),sba.7a %>% filter(AnyTag==TRUE& !is.na(AnyTag)),
          row.names = FALSE)
write.csv(file=file.path("..","..","Output","OSC","critical_tech_csv",
                         "foia_sba_sbg_critical_tech.csv"),sba.sbg %>% filter(AnyTag==TRUE& !is.na(AnyTag)),
          row.names = FALSE)

write.csv(file=file.path("..","..","Output","OSC","sbic_providers.csv"),sbic_providers,na="",)

write_csv(loanSelected %>% filter(AnyTag==TRUE &
                                    !is.na(AnyTag)),file="../../data/semi_clean/OSC/USAspending_Energy_OSCtagged.csv",na = "")
write.csv(file=file.path("..","..","Output","OSC","critical_tech_csv",
                         "usaspending_critical_tech.csv"),loanSelected %>% filter(AnyTag==TRUE& !is.na(AnyTag)),row.names = FALSE)

write_csv(exim %>% filter(AnyTag==TRUE & !is.na(AnyTag)),file="../../data/semi_clean/OSC/EXIMtagged.csv",na = "")


save(loanSelected,file="../../data/clean/OSC/SelectedLoanDataSet.rda")
save(exim,file="../../data/semi_clean/OSC/exim.rda")


sba_unified<-
  rbind(sba.504 %>% mutate(StartFiscalYear=ApprovalFiscalYear,
                           Amount=GrossApproval_Then_Year,
                           program="504") %>%
          dplyr::select(StartFiscalYear, Amount,CriticalTech,program,AnyTag),
        sba.7a %>% mutate(StartFiscalYear=ApprovalFiscalYear,
                          Amount=GrossApproval_Then_Year,
                          program="7(A)") %>%
          dplyr::select(StartFiscalYear, Amount,CriticalTech,program,AnyTag),
       sba.sbg %>% mutate(StartFiscalYear=InstanceFiscalYear,
                           Amount=INSTANCE_CONTRACT_AMOUNT_Then_Year,
                           program="SBG") %>%
          dplyr::select(StartFiscalYear, Amount,CriticalTech,program,AnyTag))
sba_unified<-deflate(sba_unified,money_var="Amount",fy_var="StartFiscalYear")




save(sba.504,sba.7a,sba.sbg,sbic_providers,file=file.path("..","..","data","Clean","OSC","sba_programs.rda"))

```


