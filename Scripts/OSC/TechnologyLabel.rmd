---
title: "hightech Text Label"
author: "Greg Sanders"
date: "2022-07-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(RTextTools)
library(readr)
library(csis360)
library(dplyr)

library(tidyr)
dir.exists(file.path("..","..","Data","semi_clean","OSC"))
f<-list.files(file.path("..","..","Data","semi_clean","OSC"))

file.exists(file.path("..","..","Data","semiclean","OSC","FAADCloanDataSet.rda"))
load("..\\..\\Data\\semi_clean\\OSC\\SelectedLoanDataSet.rda")

  cfda<-loanSelected %>% group_by(awarding_agency_name,cfda_num,cfda_title,assistance_type_code) %>% 
      summarise(n=length(assistance_type_code),
            total_outlayed_amount_for_overall_award=sum(total_outlayed_amount_for_overall_award,na.rm=TRUE),
            face_value_of_loan=sum(face_value_of_loan,na.rm=TRUE)) 
  write_csv(cfda,file="../../output/OSC/selected_cfda.csv")
  
  # loan<-loan %>% filter(cfda_title!="DISASTER ASSISTANCE LOANS")

loanSelected<-standardize_variable_names(loanSelected)

# View(loan %>% filter(cfda_title=="DISASTER ASSISTANCE LOANS"))

# write.csv(unique(loan$recipient_uei[loan$cfda_title=="DISASTER ASSISTANCE LOANS"]),file="disast_nam.csv")
# 
descrip<-loanSelected %>% group_by(transaction_description) %>%
  summarise(n=nrow(total_obligated_amount))
load(file="Data/Semi_Clean/OSC/exim.rda")  
```

# Setup

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

## Description Label function
```{r labeling_function}

label_keyword<-function(x,keyword,col="transaction_description"){
  x<-as.data.frame(x)
  tags<-unique(keyword$tag)
  if(any(tags %in% colnames(x)))
    tags[tags %in% colnames(x)]
    warning("Tag column(s) already exists")
  if(any("AnyTag" %in% colnames(x))){
    tags[tags %in% colnames(x)]
    warning("AnyTag column already exists")
  }else{
    x$AnyTag<-NA
  }
  for(i in 1:nrow(keyword)){
    if(!keyword$tag[i] %in% colnames(x))
      x[keyword$tag[i]]<-NA
    x[grep(keyword$keyword[i],x[,col],ignore.case = TRUE),keyword$tag[i]]<-TRUE
    x$AnyTag[x[,keyword$tag[i]]==TRUE & !is.na(x[,keyword$tag[i]])]<-TRUE
  }
  x
}

```


# Assign labels



## Description Labeling
```{r DescriptionLabels}

keyword<-read_csv("..//..//data//semi_clean//OSC//osc_keyword_list.csv")
col<-"transaction_description"
labeled<-label_keyword(descrip,keyword)
summary(labeled)

loanSelected<-left_join(loanSelected,labeled,by="transaction_description")

#Product label is just the NAICS/SIC category description
label_exim<-label_keyword(exim,keyword,"Product.Description")
# label_exim<-exim

```

### CFDA labeling
```{r CFDSlabels}
loanSelected$HighTech[loanSelected$cfda_num %in% c("81.112","81.126","59.058")|
                   loanSelected$cfda_title %in% c("STEWARDSHIP SCIENCE GRANT PROGRAM",
                                     "FEDERAL LOAN GUARANTEES FOR INNOVATIVE ENERGY TECHNOLOGIES",
                                     "FEDERAL AND STATE TECHNOLOGY PARTNERSHIP PROGRAM")]<-TRUE
loanSelected$AnyTag[loanSelected$cfda_num %in% c("81.112","81.126","59.058")|
                   loanSelected$cfda_title %in% c("STEWARDSHIP SCIENCE GRANT PROGRAM",
                                     "FEDERAL LOAN GUARANTEES FOR INNOVATIVE ENERGY TECHNOLOGIES",
                                     "FEDERAL AND STATE TECHNOLOGY PARTNERSHIP PROGRAM")]<-TRUE

loanSelected$Renewable[loanSelected$cfda_num %in% c("81.126")|
                   loanSelected$cfda_title %in% c("FEDERAL LOAN GUARANTEES FOR INNOVATIVE ENERGY TECHNOLOGIES")]<-TRUE
loanSelected$AnyTag[loanSelected$cfda_num %in% c("81.126")|
                   loanSelected$cfda_title %in% c("FEDERAL LOAN GUARANTEES FOR INNOVATIVE ENERGY TECHNOLOGIES")]<-TRUE

```

### NAICS labels

```{r NAICSlabels}

label_exim<-read_and_join_experiment(label_exim,
                         lookup_file="Lookup_PrincipalNAICScode.csv",
                         directory="economic//",
                         by=c("Primary.Export.Product.NAICS"="principalnaicscode"),
                         add_var=c("CriticalTech"),
                         skip_check_var =c("CriticalTech"),
                         missing_file="naics.csv")
label_exim$CriticalTech[label_exim$Primary.Export.Product.NAICS==334410]<-"Microelectronics"
label_exim$CriticalTech[label_exim$CriticalTech==""]<-NA
label_exim$AnyTag[!is.na(label_exim$CriticalTech)]<-TRUE

```


## Output
```{r TagOutput}
write_csv(loanSelected %>% filter(AnyTag==TRUE & !is.na(AnyTag)),file="../../data/semi_clean/OSC/USAspending_selected_OSCtagged.csv")
write_csv(label_exim %>% filter(AnyTag==TRUE & !is.na(AnyTag)),file="../../data/semi_clean/OSC/EXIMtagged.csv")
save(loanSelected,label_exim,file="../../data/semi_clean/OSC/OSCselectedTagged.rda")
```


### Expanding labels to contracts

You can also embed plots, for example:

```{r contract_expansion}

loan <- read_delim(
  "..//data_raw//OTA_All_Fields.csv",delim = ",",
  col_names = TRUE, guess_max = 500000,na=c("NA","NULL"),skip = 2)
loan<-standardize_variable_names(loan)


loan<-read_and_join_experiment(loan,
                         path="..//data_raw//",dir="",lookup_file = "OTA_descrip_row_number.csv",
                         add_var="descrip_row_number",
                         # skip_check_var = "Remotely_Crewed",
                         by="Description_of_Requirement")

loan<-read_and_join_experiment(loan,
                         path="..//data//semi_clean//",dir="",lookup_file = "ota_description_UAS.csv",
                         add_var="Remotely_Crewed",
                         # skip_check_var = "Remotely_Crewed",
                         by="descrip_row_number",
                         col_types = "cnccccccccc")

loan$Remotely_Crewed[loan$Remotely_Crewed %in% c("","FALSE")]<-NA


sum(text_to_number(loan$Action_Obligation)[loan$Remotely_Crewed %in% c("hightech","hightech/C-hightech")])


#This is incredibly slow ~20m, perhaps because of all the warning it prints.
# loan<-loan %>% group_by(`PIIDAgencyID`,PIID,`ReferencedIDVAgencyID`,Referenced_IDV_PIID) %>%
#   mutate(max_rc=max(Remotely_Crewed,na.rm=TRUE),
#          min_rc=min(Remotely_Crewed,na.rm=TRUE))

Remotely_Crewed_CAU<-loan %>% filter(Remotely_Crewed %in% c("hightech","hightech/C-hightech"))%>%
  group_by(PIIDAgencyID,PIID,ReferencedIDVAgencyID,Referenced_IDV_PIID,
           Remotely_Crewed) %>% dplyr::summarise()

Remotely_Crewed_CAU$ReferencedIDVAgencyID[is.na(Remotely_Crewed_CAU$ReferencedIDVAgencyID)]<-""

# Training and Readiness Accelerator (TReX) does include hightech, but is a  broader OTA.
Remotely_Crewed_CAU<-Remotely_Crewed_CAU %>% filter(PIID!="W900KK1890005") 

colnames(Remotely_Crewed_CAU)[colnames(Remotely_Crewed_CAU)=="Remotely_Crewed"]<-"Remotely_Crewed_CAU"
write_csv(Remotely_Crewed_CAU,file.path("..","data","semi_clean","ota_CAU_UAS.csv"))


# 
# write.csv(loan %>% select(`PIIDAgencyID`,PIID,`ReferencedIDVAgencyID`,Referenced_IDV_PIID,
#                                  Description_of_Requirement,Remotely_Crewed,max_rc,min_rc,Action_Obligation)
#      %>% filter(max_rc=='hightech'|min_rc=="hightech"),"CUA_OTA_check.csv")
# 
# 
# write.csv(loan %>% select(`PIIDAgencyID`,PIID,`ReferencedIDVAgencyID`,Referenced_IDV_PIID,
#                                  Description_of_Requirement,Remotely_Crewed,max_rc,min_rc,Action_Obligation,
#                                  ProductOrServiceCode)
#      %>% filter(!is.na(max_rc) | ProductOrServiceCode=="1550"),"CUA_OTA_rc_check.csv")
# 
# summary(factor(loan$Remotely_Crewed[loan$ProductOrServiceCode=="1550"]))



```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

