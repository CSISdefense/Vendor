---
title: "hightech Text Label"
author: "Greg Sanders"
date: "2022-07-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(RTextTools)
library(readr)
library(ggplot2)
library(csis360)
library(dplyr)
library(tidyr)
library(openxlsx)

# dir.exists(file.path("..","..","Data","semi_clean","OSC"))
# f<-list.files(file.path("..","..","Data","semi_clean","OSC"))
# 
# file.exists(file.path("..","..","Data","semi_clean","OSC","SelectedLoanDataSet.rda"))
load("..\\..\\Data\\semi_clean\\OSC\\SelectedLoanDataSet.rda")

 
  
  # loan<-loan %>% filter(cfda_title!="DISASTER ASSISTANCE LOANS")

# loanSelected<-standardize_variable_names(loanSelected)

# View(loan %>% filter(cfda_title=="DISASTER ASSISTANCE LOANS"))

# write.csv(unique(loan$recipient_uei[loan$cfda_title=="DISASTER ASSISTANCE LOANS"]),file="disast_nam.csv")
# 
descrip<-loanSelected %>% group_by(transaction_description) %>%
  summarise(n=nrow(total_obligated_amount))
load(file="../../Data/Semi_Clean/OSC/exim.rda")  

load(file=file.path("..","..","data","semi_Clean","OSC","sba_programs.rda"))



```

# Setup

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

## Description Label function
```{r labeling_function}

label_keyword<-function(x,keyword,col="transaction_description"){
  x<-as.data.frame(x)
  tags<-unique(keyword$tag)
  if(any(tags %in% colnames(x)))
    tags[tags %in% colnames(x)]
    warning("Tag column(s) already exists")
  if(any("AnyTag" %in% colnames(x))){
    tags[tags %in% colnames(x)]
    warning("AnyTag column already exists")
  }else{
    x$AnyTag<-NA
  }
  for(i in 1:nrow(keyword)){
    if(!keyword$tag[i] %in% colnames(x))
      x[keyword$tag[i]]<-NA
    x[grep(keyword$keyword[i],x[,col],ignore.case = TRUE),keyword$tag[i]]<-TRUE
    x$AnyTag[x[,keyword$tag[i]]==TRUE & !is.na(x[,keyword$tag[i]])]<-TRUE
  }
  x
}


```


# Assign labels



## Description Labeling
```{r DescriptionLabels}

keyword<-read_csv("..//..//data//semi_clean//OSC//osc_keyword_list.csv")
col<-"transaction_description"
labeled<-label_keyword(descrip,keyword)
colnames(loanSelected)
summary(labeled)

loanSelected<-loanSelected[,!colnames(loanSelected) %in%
                             colnames(loanSelected)[grep(".x",colnames(loanSelected))]]
loanSelected<-loanSelected[,!colnames(loanSelected) %in%
                             colnames(loanSelected)[grep(".y",colnames(loanSelected))]]

loanSelected<-loanSelected[,!colnames(loanSelected) %in% 
                                       colnames(labeled)[!colnames(labeled) %in% c("transaction_description","AnyTag")]]
loanSelected<-left_join(loanSelected,labeled,by="transaction_description")

#Product label is just the NAICS/SIC category description
exim<-label_keyword(exim,keyword,"Product.Description")
# exim<-exim


```

### CFDA labeling
```{r CFDSlabels}
loanSelected$HighTech[loanSelected$cfda_num %in% c("81.112","81.126","59.058")|
                   loanSelected$cfda_title %in% c("STEWARDSHIP SCIENCE GRANT PROGRAM",
                                     "FEDERAL LOAN GUARANTEES FOR INNOVATIVE ENERGY TECHNOLOGIES",
                                     "FEDERAL AND STATE TECHNOLOGY PARTNERSHIP PROGRAM")]<-TRUE
loanSelected$AnyTag[loanSelected$cfda_num %in% c("81.112","81.126","59.058")|
                   loanSelected$cfda_title %in% c("STEWARDSHIP SCIENCE GRANT PROGRAM",
                                     "FEDERAL LOAN GUARANTEES FOR INNOVATIVE ENERGY TECHNOLOGIES",
                                     "FEDERAL AND STATE TECHNOLOGY PARTNERSHIP PROGRAM")]<-TRUE

loanSelected$Renewable[loanSelected$cfda_num %in% c("81.126")|
                   loanSelected$cfda_title %in% c("FEDERAL LOAN GUARANTEES FOR INNOVATIVE ENERGY TECHNOLOGIES")]<-TRUE
loanSelected$AnyTag[loanSelected$cfda_num %in% c("81.126")|
                   loanSelected$cfda_title %in% c("FEDERAL LOAN GUARANTEES FOR INNOVATIVE ENERGY TECHNOLOGIES")]<-TRUE

wb<-loadWorkbook(file=file.path("..","..","Output","OSC","selected_assistance_critical_tech.xlsx"))
writeData(wb, sheet="USAspending",loanSelected %>% filter(AnyTag==TRUE & !is.na(AnyTag)))
write.csv(file=file.path("..","..","Output","OSC","critical_tech_csv",
                         "usaspending_critical_tech.csv"),loanSelected %>% filter(AnyTag==TRUE& !is.na(AnyTag)),row.names = FALSE)

saveWorkbook(wb,file=(file.path("..","..","Output","OSC","selected_assistance_critical_tech.xlsx")),overwrite = TRUE)




```

### NAICS labels

```{r NAICSlabels}

# 
# write.csv(exim %>% group_by(Primary.Export.Product.NAICS,Product.Description) %>%
#             filter(!is.na(Primary.Export.Product.NAICS))%>% summarise(),"exim_naics_all.csv")
exim<-read_and_join_experiment(exim,
                         lookup_file="Lookup_PrincipalNAICScode.csv",
                         directory="economic//",
                         by=c("Primary.Export.Product.NAICS"="principalnaicscode"),
                         add_var=c("CriticalTech"),
                         skip_check_var =c("CriticalTech"),
                         missing_file="exim_naics.csv")
exim$CriticalTech[exim$CriticalTech==""]<-NA
exim$AnyTag[!is.na(exim$CriticalTech)]<-TRUE

# sba.504$
# write.csv(sba.504 %>% group_by(NaicsCode,NaicsDescription) %>%summarise(),"naics_all.csv")

sba.504 <- read_and_join_experiment(sba.504,
                         lookup_file="Lookup_PrincipalNAICScode.csv",
                         directory="economic//",
                         by=c("NaicsCode"="principalnaicscode"),
                         add_var=c("CriticalTech"),
                         skip_check_var =c("CriticalTech"),
                         missing_file="naics.csv")
sba.504$AnyTag<-NA
sba.504$AnyTag[!is.na(sba.504$CriticalTech) & sba.504$CriticalTech!=""]<-TRUE
summary(sba.504$AnyTag)




(
sba.504tech<-build_plot(
  data=sba.504,
  chart_geom = "Bar Chart",
  share = TRUE,
  # labels_and_colors=loan_lc,
  # column_key=loan_ck,
  # NA, #VAR.ncol
  x_var="ApprovalFiscalYear", 
  # alpha_var="YTD",  #x_var 
  y_var="GrossApproval_OMB24_GDP22", #VAR.y.variable
  color_var="CriticalTech", #color_var
  # facet_var="awarding_agency_name", #facet_var
  format=TRUE,
  ytextposition=FALSE
)+#date_x_year_breaks(2000,2020,3,partial_year=2023,partial_label="\nQ1-Q2")+scale_alpha_ordinal(range=c(1,0.5))+
  theme(legend.position = "right")+
  labs(y="Gross Approval")# (Constant 2022 $s)
)


sba.7a <- read_and_join_experiment(sba.7a,
                         lookup_file="Lookup_PrincipalNAICScode.csv",
                         directory="economic//",
                         by=c("NaicsCode"="principalnaicscode"),
                         add_var=c("CriticalTech"),
                         skip_check_var =c("CriticalTech"),
                         missing_file="naics7a.csv")
sba.7a$AnyTag<-NA
sba.7a$AnyTag[!is.na(sba.7a$CriticalTech) & sba.7a$CriticalTech!=""]<-TRUE
summary(sba.7a$AnyTag)




(
sba.7atech<-build_plot(
  data=sba.7a,
  chart_geom = "Bar Chart",
  share = TRUE,
  # labels_and_colors=loan_lc,
  # column_key=loan_ck,
  # NA, #VAR.ncol
  x_var="ApprovalFiscalYear", 
  # alpha_var="YTD",  #x_var 
  y_var="GrossApproval_OMB24_GDP22", #VAR.y.variable
  color_var="CriticalTech", #color_var
  # facet_var="awarding_agency_name", #facet_var
  format=TRUE,
  ytextposition=FALSE
)+#date_x_year_breaks(2000,2020,3,partial_year=2023,partial_label="\nQ1-Q2")+scale_alpha_ordinal(range=c(1,0.5))+
  theme(legend.position = "right")+
  labs(y="Gross Approval")# (Constant 2022 $s)
)




sba.sbg <- read_and_join_experiment(sba.sbg,
                         lookup_file="Lookup_PrincipalNAICScode.csv",
                         directory="economic//",
                         by=c("PROJECT_NAICS"="principalnaicscode"),
                         add_var=c("CriticalTech"),
                         skip_check_var =c("CriticalTech"),
                         missing_file="naics_sbg.csv")
sba.sbg$AnyTag<-NA
sba.sbg$AnyTag[!is.na(sba.sbg$CriticalTech) & sba.sbg$CriticalTech!=""]<-TRUE
summary(sba.sbg$AnyTag)



sba.sbg$count<-1
(
sba.sbg_contract<-build_plot(
  data=sba.sbg  %>% filter(!is.na(PROJECT_START_DATE)),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=loan_lc,
  # column_key=loan_ck,
  # NA, #VAR.ncol
  x_var="ProjectStartYear", 
  # alpha_var="YTD",  #x_var 
  y_var="LARGEST_CONTRACT_OMB24_GDP22", #VAR.y.variable
  color_var="CriticalTech", #color_var
  # facet_var="awarding_agency_name", #facet_var
  format=TRUE,
  ytextposition=FALSE
)+#date_x_year_breaks(2000,2020,3,partial_year=2023,partial_label="\nQ1-Q2")+scale_alpha_ordinal(range=c(1,0.5))+
  theme(legend.position = "right")+
  labs(y="Largest Contract")# (Constant 2022 $s)
)

(
sba.sbg_count<-build_plot(
  data=sba.sbg  %>% filter(!is.na(PROJECT_START_DATE)),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=loan_lc,
  # column_key=loan_ck,
  # NA, #VAR.ncol
  x_var="ProjectStartYear", 
  # alpha_var="YTD",  #x_var 
  y_var="count", #VAR.y.variable
  color_var="CriticalTech", #color_var
  # facet_var="awarding_agency_name", #facet_var
  format=TRUE,
  ytextposition=FALSE
)+#date_x_year_breaks(2000,2020,3,partial_year=2023,partial_label="\nQ1-Q2")+scale_alpha_ordinal(range=c(1,0.5))+
  theme(legend.position = "right")+
  labs(y="Count")# (Constant 2022 $s)
)



(
sba_crosscut<-build_plot(
  data=sba_unified  %>% filter(!is.na(StartFiscalYear)),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=loan_lc,
  # column_key=loan_ck,
  # NA, #VAR.ncol
  x_var="StartFiscalYear", 
  # alpha_var="YTD",  #x_var 
  y_var="Amount_OMB24_GDP22", #VAR.y.variable
  color_var="CriticalTech", #color_var
  facet_var="program", #facet_var
  format=TRUE,
  ytextposition=FALSE
)+#date_x_year_breaks(2000,2020,3,partial_year=2023,partial_label="\nQ1-Q2")+scale_alpha_ordinal(range=c(1,0.5))+
  theme(legend.position = "right")+
  labs(y="Gross Amount or Largest Project")# (Constant 2022 $s)
)



save(sba.504,sba.7a,sba.sbg,sbic_providers,file=file.path("..","..","data","semi_Clean","OSC","sba_programs.rda"))

wb<-loadWorkbook(file=file.path("..","..","Output","OSC","selected_assistance_critical_tech.xlsx"))
writeData(wb, sheet="504-foia",sba.504 %>% filter(AnyTag==TRUE & !is.na(AnyTag)))
writeData(wb, sheet="7a-foia",sba.7a %>% filter(AnyTag==TRUE & !is.na(AnyTag)))
writeData(wb, sheet="sbg-foia",sba.sbg %>% filter(AnyTag==TRUE & !is.na(AnyTag)))
writeData(wb, sheet="ExIm",exim %>% filter(AnyTag==TRUE & !is.na(AnyTag)))
saveWorkbook(wb,file=(file.path("..","..","Output","OSC","selected_assistance_critical_tech.xlsx")),overwrite = TRUE)


write.csv(file=file.path("..","..","Output","OSC","critical_tech_csv",
                         "foia_sba_critical_tech.csv"),sba.504 %>% filter(AnyTag==TRUE & !is.na(AnyTag)),
          row.names = FALSE)
write.csv(file=file.path("..","..","Output","OSC","critical_tech_csv",
                         "foia_sba_7a_critical_tech.csv"),sba.7a %>% filter(AnyTag==TRUE& !is.na(AnyTag)),
          row.names = FALSE)
write.csv(file=file.path("..","..","Output","OSC","critical_tech_csv",
                         "foia_sba_sbg_critical_tech.csv"),sba.sbg %>% filter(AnyTag==TRUE& !is.na(AnyTag)),
          row.names = FALSE)

write.csv(file=file.path("..","..","Output","OSC","sbic_providers.csv"),sbic_providers)

```

# Output



```{r TagOutput}

wb<-loadWorkbook(file=file.path("..","..","Output","OSC","selected_assistance_critical_tech.xlsx"))
writeData(wb, sheet="504-foia",sba.504 %>% filter(AnyTag==TRUE & !is.na(AnyTag)))
writeData(wb, sheet="7a-foia",sba.7a %>% filter(AnyTag==TRUE & !is.na(AnyTag)))
colnames(sba.7a)
writeData(wb, sheet="sbg-foia",sba.sbg %>% filter(AnyTag==TRUE & !is.na(AnyTag)))
writeData(wb, sheet="ExIm",exim %>% filter(AnyTag==TRUE & !is.na(AnyTag)))
writeData(wb, sheet="USAspending",loanSelected %>% filter(AnyTag==TRUE & !is.na(AnyTag)))
saveWorkbook(wb,file=file.path("..","..","Output","OSC","selected_assistance_critical_tech.xlsx"),overwrite = TRUE)


write.csv(file=file.path("..","..","Output","OSC","critical_tech_csv",
                         "foia_sba_critical_tech.csv"),sba.504 %>% filter(AnyTag==TRUE & !is.na(AnyTag)),
          row.names = FALSE)
write.csv(file=file.path("..","..","Output","OSC","critical_tech_csv",
                         "foia_sba_7a_critical_tech.csv"),sba.7a %>% filter(AnyTag==TRUE& !is.na(AnyTag)),
          row.names = FALSE)
write.csv(file=file.path("..","..","Output","OSC","critical_tech_csv",
                         "foia_sba_sbg_critical_tech.csv"),sba.sbg %>% filter(AnyTag==TRUE& !is.na(AnyTag)),
          row.names = FALSE)

write.csv(file=file.path("..","..","Output","OSC","sbic_providers.csv"),sbic_providers,na="",)

write_csv(loanSelected %>% filter(AnyTag==TRUE &
                                    !is.na(AnyTag)),file="../../data/semi_clean/OSC/USAspending_Energy_OSCtagged.csv",na = "")
write.csv(file=file.path("..","..","Output","OSC","critical_tech_csv",
                         "usaspending_critical_tech.csv"),loanSelected %>% filter(AnyTag==TRUE& !is.na(AnyTag)),row.names = FALSE)

write_csv(exim %>% filter(AnyTag==TRUE & !is.na(AnyTag)),file="../../data/semi_clean/OSC/EXIMtagged.csv",na = "")


save(loanSelected,file="../../data/semi_clean/OSC/SelectedLoanDataSet.rda")
save(exim,file="../../data/semi_clean/OSC/exim.rda")
save(sba.504,sba.7a,sba.sbg,sbic_providers,file=file.path("..","..","data","semi_Clean","OSC","sba_programs.rda"))

```


