---
title: "Defense Acquisition Trends"
output:
  html_document:
    keep_md: yes
    toc: yes
date: "Wednesday, October 6, 2021"
---

# Setup
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from FPDS.

```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(scales)
library(openxlsx)
axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40
if(!exists("platpscintldef"))
  load(file="../data/clean/platpscplatpscintldef.Rda")


if(!exists("platpscdefcd"))
  load(file="../data/clean/platpscdefcd.Rda")
# save.image("../.RData")
```

# Preprocessing 
## Group By PlatformPortfolio
### Project
```{r PreprocessProject}

# summary(factor(platpscintldef$ProjectPlatform))
# 
# colnames(platpscintldef)[colnames(platpscintldef)=="Action_Obligation_Then_Year_Then_Year"]<-
#   "Action_Obligation_Then_Year"
# 
# topplat<-platpscintldef %>% group_by (Project.Name,PlatformPortfolio) %>%
#   #Exclude NA from ranking and then create a recent only dollar amount
#   mutate(Action_Obligation_2023=if_else(is.na(Project.Name),Action_Obligation_OMB25_GDP23,NA),
#     Action_Obligation_2023=if_else(Fiscal_Year>=2023,Action_Obligation_OMB25_GDP23,NA))%>%
#   summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23,na.rm = TRUE),
#             Action_Obligation_2023=sum(Action_Obligation_2023,na.rm = TRUE))%>%
#               group_by (PlatformPortfolio) %>%
#     mutate(rank_total=rank(desc(Action_Obligation_OMB25_GDP23)),
#                         rank_2023=rank(desc(Action_Obligation_2023)))
# topplat %>% arrange(desc(Action_Obligation_OMB25_GDP23))
# 
# 
# topplat$TopProject<-
#   ifelse(topplat$rank_2023<=7 | topplat$rank_total<=7,topplat$Project.Name,NA)
# 
# platpscintldef<-left_join(platpscintldef,topplat %>% dplyr::select(-Action_Obligation_OMB25_GDP23,Action_Obligation_2023),
#                           by=c("Project.Name","PlatformPortfolio"))
# 
# platpscintldef$TopProject[is.na(platpscintldef$TopProject) & !is.na(platpscintldef$Project.Name)]<-
#   "Other Labeled Project"
# 
# 
# summary(factor(platpscintldef$TopProject))
# 
# 
# colnames(platpscintldef)
# platpscintldef
# 
# write.csv(topplat,file=file.path("..","Output","AcqTrends","Topplat.csv"),row.names=FALSE)
# debug(label_top)
platpscintldef<-label_top(platpscintldef,
                    col="Project.Name",
                    n=7,
                    top_name="TopProject",
                    group_list="PlatformPortfolio",
                    recent=2023
                    #retain_rank=TRUE,
                    #write_file=file.path("..","Output","AcqTrends","TopProjectTest.csv")
                    )




```
### PSC
```{r PreprocessPSC}


# platpscintldef<-label_top(platpscintldef,
#                     col="ProductOrServiceCode",
#                     n=7,
#                     top_name="TopPScode",
#                     group_list="PlatformPortfolio",
#                     recent=2023
#                     #retain_rank=TRUE,
#                     #write_file=file.path("..","Output","AcqTrends","TopProjectTest.csv")
#                     )



summary(factor(platpscintldef$ProjectPlatform))

topPSC<-platpscintldef %>% group_by (ProductOrServiceCode,ProductOrServiceCodeText,PlatformPortfolio) %>%
  mutate(Action_Obligation_2023=ifelse(Fiscal_Year>=2023,Action_Obligation_OMB25_GDP23,NA))
  summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE),
            Action_Obligation_2023=sum(Action_Obligation_2023,na.rm=TRUE))%>%
              group_by (PlatformPortfolio) %>%
    mutate(rank_total=rank(desc(Action_Obligation_OMB25_GDP23)),
                        rank_2023=rank(desc(Action_Obligation_2023)))
topPSC %>% arrange(desc(Action_Obligation_OMB25_GDP23))

topPSC$TopPScode<-
  ifelse(topPSC$rank_2023<=7 | topPSC$rank_total<=7,topPSC$ProductOrServiceCode,NA)
topPSC$TopPStext<-
  ifelse(topPSC$rank_2023<=7 | topPSC$rank_total<=7,topPSC$ProductOrServiceCodeText,NA)


platpscintldef<-left_join(platpscintldef,topPSC %>% select(-Action_Obligation_OMB25_GDP23,Action_Obligation_2023),
          by=c("ProductOrServiceCode","PlatformPortfolio"))

platpscintldef$TopPScode[is.na(platpscintldef$TopPScode) & !is.na(platpscintldef$ProductOrServiceCode)]<-
  "Other Labeled PSC"
platpscintldef$TopPStext[is.na(platpscintldef$TopPStext) & !is.na(platpscintldef$ProductOrServiceCode)]<-
  "Other Labeled PSC"

platpscintldef$TopPStext<-factor_wrap(platpscintldef$TopPStext)

summary(factor(platpscintldef$TopPStext))


```

## Group By ProductOrServiceArea
### Place State
```{r PreprocessState}

# platpscintldef$pop_isna<-is.na(platpscintldef$pop_state_code)
# platpscintldef$sc_isna<-is.na(platpscintldef$PlaceStateCode)
# platpscintldef %>% group_by(Fiscal_Year,pop_isna,sc_isna) %>%
#   summarise(n=length(Fiscal_Year))

# summary(factor(platpscintldef$ProductOrServiceArea))


platpscintldef<-label_top(platpscintldef,
                    col="pop_state_code",
                    n=25,
                    top_name="TopStateAbbr",
                    group_list="ProductOrServiceArea",
                    recent=2023
                    #retain_rank=TRUE,
                    #write_file=file.path("..","Output","AcqTrends","TopProjectTest.csv")
                    )


# topState<-platpscintldef %>% group_by (pop_state_code,ProductOrServiceArea) %>%
#   summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
#             Action_Obligation_2023=sum(ifelse(Fiscal_Year==2023,Action_Obligation_OMB25_GDP23,0)))%>%
#               group_by (ProductOrServiceArea) %>%
#     mutate(rank_total=rank(desc(Action_Obligation_OMB25_GDP23)),
#                         rank_2023=rank(desc(Action_Obligation_2023)))
# topState %>% arrange(desc(Action_Obligation_OMB25_GDP23))
# 
# topState$TopStateAbbr<-
#   ifelse(topState$rank_2023<=25 | topState$rank_total<=25,topState$pop_state_code,NA)
# # topState$TopStateName<-
# #   ifelse(topState$rank_2023<=7 | topState$rank_total<=7,topState$PlaceStateCodeText,NA)
# platpscintldef<-platpscintldef[,!colnames(platpscintldef) %in% c("Action_Obligation_OMB25_GDP23.x","Action_Obligation_OMB25_GDP23.y",
#                                    "Action_Obligation_2023.x","Action_Obligation_2023.y",
#   "rank_total.y","rank_total.x","rank_2023.y","rank_2023.x","TopStateAbbr.x","TopStateAbbr.y")]
# 
# platpscintldef<-left_join(platpscintldef,topState %>% select(-Action_Obligation_OMB25_GDP23,Action_Obligation_2023),
#           by=c("pop_state_code","ProductOrServiceArea"))
# 
# platpscintldef$TopStateAbbr[is.na(platpscintldef$TopStateAbbr) & !is.na(platpscintldef$pop_state_code)]<-
#   "Other Labeled State"
# platpscintldef$TopStateName[is.na(platpscintldef$TopStateName) & !is.na(platpscintldef$pop_state_code)]<-
#   "Other Labeled State"


# summary(factor(platpscintldef$TopStateName))


```

### Place Country
```{r PreprocessCountry}



platpscintldef<-label_top(platpscintldef,
                    col="PlaceISOalpha3",
                    n=7,
                    top_name="TopCountryISO",
                    group_list="ProductOrServiceArea",
                    recent=2023
                    #retain_rank=TRUE,
                    #write_file=file.path("..","Output","AcqTrends","TopProjectTest.csv")
                    )

# 
# # summary(factor(platpscintldef$ProductOrServiceArea))
# colnames(platpscintldef)[colnames(platpscintldef)=="Fiscal_Year"]<-"Fiscal_Year"
# topCountry<-platpscintldef %>% group_by (PlaceISOalpha3,ProductOrServiceArea) %>%
#   summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
#             Action_Obligation_2023=sum(ifelse(Fiscal_Year==2023,Action_Obligation_OMB25_GDP23,0)))%>%
#               group_by (ProductOrServiceArea) %>%
#     mutate(rank_total=rank(desc(Action_Obligation_OMB25_GDP23)),
#                         rank_2023=rank(desc(Action_Obligation_2023)))
# topCountry %>% arrange(desc(Action_Obligation_OMB25_GDP23))
# 
# topCountry$TopCountryISO<-
#   ifelse(topCountry$rank_2023<=7 | topCountry$rank_total<=7,topCountry$PlaceISOalpha3,NA)
# # topCountry$TopCountryName<-
# #   ifelse(topCountry$rank_2023<=7 | topCountry$rank_total<=7,topCountry$PlaceCountryCodeText,NA)
# 
# 
# platpscintldef<-left_join(platpscintldef,topCountry %>% select(-Action_Obligation_OMB25_GDP23,Action_Obligation_2023),
#           by=c("PlaceISOalpha3","ProductOrServiceArea"))
# 
# platpscintldef$TopCountryISO[is.na(platpscintldef$TopCountryISO) & !is.na(platpscintldef$PlaceISOalpha3)]<-
#   "Other Labeled Country"
# # platpscintldef$TopCountryName[is.na(platpscintldef$TopCountryName) & !is.na(platpscintldef$PlaceISOalpha3)]<-
# #   "Other Labeled Country"
# 
# 
# # summary(factor(platpscintldef$TopCountryName))


```



# Inflation
## Fuel
```{r Fuel}

# PlaceIsForeign
# full_data$PlaceStateRegion
# replace_nas_with_unlabeled(factor(full_data$PlaceIsForeign,levels=c(1,0),labels=c("Performed Abroad","Performed in the U.S."))

full_data$SimpleArea.fuels<- as.character( full_data$SimpleArea)
full_data$SimpleArea.fuels[full_data$ProductServiceOrRnDarea=="Fuels"]<-"Fuels"
summary(factor(full_data$SimpleArea.fuels))
full_data$SimpleArea.fuels<-factor(full_data$SimpleArea.fuels,
                                           levels=c("Services (Non-R&D)" ,
                                                   "R&D",
                                                   "Products (All)",
                                                   "Fuels",
                                                   "Unlabeled" ),
                                           labels=c("Services (Non-R&D)" ,
                                                   "R&D",
                                                   "Products (Non-Fuels)",
                                                   "Fuels",
                                                   "Unlabeled" ))
summary(factor(full_data$SimpleArea.fuels))
labels_and_colors<-prepare_labels_and_colors(full_data,path="C:\\Users\\gsand\\Repositories\\Lookup-Tables\\style\\")
column_key<-get_column_key(full_data,path="C:\\Users\\gsand\\Repositories\\Lookup-Tables\\style\\")


(
psrfuel<-build_plot(
  data=full_data,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SimpleArea.fuels", #color_var
  # facet_var="TopPStext", #facet_var
  column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  # theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)",
              caption = "Source: FPDS, CSIS Analysis, OMB GDP deflators.")
)

  ggsave600dpi(filename = "..//Output//PSRfuels.png", psrfuel,  
               width=12, height= 5.6, units="in",size=18, lineheight=1.2,
               bg="transparent"
               )

write.csv(file="..//Output//PSRfuels.csv",row.names = FALSE, na = "",
  pivot_wider(psrfuel$data %>% 
                        arrange(dFYear) %>% mutate(Fiscal_Year=lubridate::year(dFYear)),
                      id_cols=c(SimpleArea.fuels),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)%>%
    arrange(SimpleArea.fuels))


(
fuel<-build_plot(
  data=full_data %>% filter(ProductOrServiceArea=="Fuels")%>% 
    mutate(PlaceIsForeign=factor(PlaceIsForeign,levels=c(1,0),labels=c("Performed Abroad","Performed in the U.S."))),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PlaceStateRegion", #color_var
  # facet_var="TopPStext", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  # theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)",
       caption = "Source: FPDS, CSIS Analysis, OMB GDP deflators.")
)


(
fuel<-build_plot(
  data=full_data %>% filter(ProductOrServiceArea=="Fuels")%>% 
    mutate(PlaceIsForeign=factor(PlaceIsForeign,levels=c(1,0),labels=c("Performed Abroad","Performed in the U.S."))),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PlaceIsForeign", #color_var
  # facet_var="TopPStext", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  # theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi("..//Output//Deep_Dives/Inflation/defense_fuel_place.png", fuel+labs(title="DoD Contract Obligations for Fuels", caption="Source: FPDS and CSIS analysis."), 
             width=6.5, height= 3.5, units="in",size=12,lineheight = 1
             )


write.csv(file="..//Output//Deep_Dives/Inflation/defense_fuel_place.csv",row.names = FALSE,na = "",
          fuel$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
          pivot_wider(id_cols=c(PlaceIsForeign),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23))



(
fuel_psc<-build_plot(
  data=platpscintldef %>% filter(ProductOrServiceArea=="Fuels")%>% 
    mutate(PlaceIsForeign=factor(PlaceIsForeign,levels=c(1,0),labels=c("Performed Abroad","Performed in the U.S."))),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="ProductOrServiceCodeText", #color_var
  # facet_var="TopPStext", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  # theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)

```

# Construction
```{r FRSnC}
summary(factor(platpscintldef$ProductOrServiceArea))
# platpscintldef$Fiscal_Year
# 
# topplat<-platpscintldef %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (Project.Name) %>%
#   summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
#             )
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB25_GDP23)),
#                         rank_2023=rank(desc(Action_Obligation_2023)))
# topplat %>% arrange(desc(Action_Obligation_OMB25_GDP23))
# 
# platpscintldef$TopShipProject<-
#   ifelse(platpscintldef$Project.Name %in% topplat$Project.Name[topplat$rank_2023<=7 | topplat$rank_total<=7],
#          platpscintldef$Project.Name,NA)
# platpscintldef$TopShipProject[is.na(platpscintldef$TopShipProject) & !is.na(platpscintldef$Project.Name)]<-
#   "Other Labeled Project"
# summary(factor(platpscintldef$TopShipProject))

(
State<-build_plot(
  data=platpscintldef %>% filter(ProductOrServiceArea=="Construction"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopStateAbbr", #color_var
  facet_var="TopStateAbbr", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)
ggsave(State,file="construction_state.png")
(
State<-build_plot(
  data=platpscintldef %>% filter(ProductOrServiceArea=="Construction"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopStateAbbr", #color_var
  facet_var="TopStateAbbr", #facet_var
  second_var="SubCustomer",
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)


(
Country<-build_plot(
  data=platpscintldef %>% filter(ProductOrServiceArea=="Construction"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopCountryISO", #color_var
  facet_var="TopCountryISO", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)


(
PSC<-build_plot(
  data=platpscintldef %>% filter(PlatformPortfolio=="Construction"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)

```

#FMS 
## Budget



### Topline and TOA (Greenbook)
```{r TOAfms}




if(!exists("platpscintldef"))
  load(file="../data/clean/platpscintl_FPDS.Rda")

View(platpscintldef %>% group_by(Project.Name) %>% summarise() %>% arrange(Project.Name))

platpscintldef %>% filter(Project.Name=="ZBL") %>% group_by(Project.Name,Fiscal_Year) %>% summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23)) %>% arrange(Project.Name, Fiscal_Year)

fpds_annual<-platpscintldef %>% filter(Fiscal_Year<2024) %>% group_by(Fiscal_Year,dFYear,IsFMS,
                                    ContractingCustomer,YTD) %>% summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE),
                                                                       Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))
fpds_annual$Series<-"Contract Obligations"
toa$ContractingCustomer<-"Defense"
toa$Action_Obligation_OMB25_GDP23<-NA
toa$Action_Obligation_Then_Year<-NA
toa$Fiscal_Year<-text_to_number(toa$Fiscal_Year)
toa$YTD<-NA
toa$IsFMS<-0
fpds_annual$Total_Obligation_Authority_Then_Year<-NA
fpds_annual$Total_Obligation_Authority_OMB25_GDP23<-NA
colnames(toa)[!colnames(toa) %in% colnames(fpds_annual)]
colnames(fpds_annual)[!colnames(fpds_annual) %in% colnames(toa)]
fpds_annual<-rbind(as.data.frame(fpds_annual),as.data.frame(toa))# %>% dplyr::select(-fiscal_quarter_YTD)

fpds_annual$FMS<-as.character(fpds_annual$IsFMS)
fpds_annual$FMS[fpds_annual$Fiscal_Year<2012 | is.na(fpds_annual$IsFMS)]<-"Obligations (reliable\nFMS labels not available)"
fpds_annual$FMS[!is.na(fpds_annual$Total_Obligation_Authority_OMB25_GDP23)]<-"Obligations (no FMS)"
fpds_annual$FMS<-factor(fpds_annual$FMS)
levels(fpds_annual$FMS)<-list("Obligations (includes FMS)"=c("1","Obligations (includes FMS)"),
                              "Obligations (no FMS)"=c("0","Obligations (no FMS)"),
                              "Obligations (reliable\nFMS labels not available)"="Obligations (reliable\nFMS labels not available)")
fpds_annual$Topline<-"Total Obligation Authority"

fa_lc<-prepare_labels_and_colors(fpds_annual,path="offline")
fa_ck<-get_column_key(fpds_annual,path="offline")


(toplineTOA<-build_plot(data=fpds_annual %>% filter(Fiscal_Year>=1990),#rbind(quarterly,q2021,e2021),
                     chart_geom="Bar Chart",
                     x_var="dFYear",#alpha_var="YTD",
                     y_var="Action_Obligation_OMB25_GDP23",
           color_var="FMS",
               labels_and_colors=fa_lc,
  column_key=fa_ck
       )+
    geom_path(aes(x=dFYear,y=Total_Obligation_Authority_OMB25_GDP23,color=Topline))+
    scale_color_manual(name="Budget",values="black")+
  # scale_alpha_discrete(range=c(0.4,1))+
    labs(x="Fiscal Year",y="Constant FY 2023 $",fill="Contract",color="Budget",
         title="DOD Contract Obligations and Total Obligation Authority, FY 1990-FY 2025 Q2",
         caption="Source: FPDS, FY 2024 DoD Greenbook, CSIS Analysis")+
    theme(legend.position = "right")+
    date_x_year_breaks(1990,2028,3)#,partial_year=2024,partial_label="\nQ1")
)


ggsave600dpi(toplineTOA,file=file.path("..","Output","AcqTrends","topline_toa_annual.png"),  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )


output_TY<-toplineTOA$data %>%
  mutate(source=ifelse(!is.na(Total_Obligation_Authority_Then_Year),
                       "TOA","Contract"),
         Dollars=ifelse(source=="Budget",
                        Total_Obligation_Authority_Then_Year,Action_Obligation_Then_Year))%>%
  filter(Fiscal_Year>=1990)%>%
          format_data_for_plot(
                               fy_var="Fiscal_Year",
                               y_var="Dollars",
                               color_var="source",
                               facet="FMS",
                               # labels_and_colors = ota_lc,
                               group=TRUE) %>%
            arrange(Fiscal_Year) 


output_TY<-deflate(output_TY,money_var = "Dollars",deflator_var="OMB25_GDP23",path="offline")

# 
# output_TY<-toplineTOA$data %>%
#   mutate(source=ifelse(!is.na(Total_Obligation_Authority_Then_Year),
#                        "TOA","Contract"),
#          Dollars=ifelse(source=="TOA",
#                         Total_Obligation_Authority_Then_Year,Action_Obligation_Then_Year))%>%
#   filter(Fiscal_Year>=1990)%>%
#           format_data_for_plot(
#                                fy_var="Fiscal_Year",
#                                y_var="Then_Year_Dollars",
#                                color_var="source",
#                                facet="FMS",
#                                # labels_and_colors = ota_lc,
#                                group=TRUE) %>%
#             arrange(Fiscal_Year) 

#+theme(plot.margin =margin(t=0,b=0,l=0.1,r=0.25,"inches"))
log_plot(plot=toplineTOA, 
         df=output_TY   ,y_var="Dollars_OMB25_GDP23",#%>% filter(Fiscal_YQ<=2025.2),
                     filename="acq_fig2_1_toa_annual",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="2-1 TOA",path="../output/AcqTrends/", height=3,excel_formulas = TRUE,
                     startRow=1,startCol=13,format=TRUE,var_list=c("source","FMS"),
         output_doc_svg=TRUE
         )

log_plot(plot=toplineTOA, df=output_TY,y_var="Dollars_OMB25_GDP23",
                     filename="nps_figXX_toa_fms",xlsx="DoD_2025_NPS.xlsx",
                     sheet="1 TOA",path="../output/AcqTrends/NPS2025/",
         second_path=online_path,
         height=3,include_YTD=FALSE,
                     format=TRUE,excel_y_var=TRUE,excel_formulas = TRUE,
         output_slide_png=TRUE,var_list=c("source","FMS")
         )


```


### Topline and Outlays (Public Budget Data)
```{r OutlayFMS}

if(!exists("platpscintldef"))
  load(file="../data/clean/platpscintl_FPDS.Rda")

fpds_annual<-platpscintldef %>% filter(Fiscal_Year<2024) %>% 
  group_by(Fiscal_Year,dFYear,IsFMS,ContractingCustomer,YTD) %>% 
  summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE),
            Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))

fpds_annual$Series<-"Contract Obligations"
outlay$ContractingCustomer<-"Defense"
outlay$Action_Obligation_OMB25_GDP23<-NA
outlay$Action_Obligation_Then_Year<-NA
outlay$Fiscal_Year<-text_to_number(outlay$Fiscal_Year)
outlay$YTD<-NA
outlay$IsFMS<-0
fpds_annual$Outlays_Then_Year<-NA
fpds_annual$Outlays_OMB25_GDP23<-NA
colnames(outlay)[!colnames(outlay) %in% colnames(fpds_annual)]
colnames(fpds_annual)[!colnames(fpds_annual) %in% colnames(outlay)]
fpds_annual<-rbind(as.data.frame(fpds_annual),as.data.frame(outlay))# %>% dplyr::select(-fiscal_quarter_YTD)

fpds_annual$FMS<-as.character(fpds_annual$IsFMS)
fpds_annual$FMS[fpds_annual$Fiscal_Year<2012 | is.na(fpds_annual$IsFMS)]<-"Obligations (reliable\nFMS labels not available)"
fpds_annual$FMS[!is.na(fpds_annual$Outlays_OMB25_GDP23)]<-"Obligations (no FMS)"
fpds_annual$FMS<-factor(fpds_annual$FMS)
levels(fpds_annual$FMS)<-list("Obligations (includes FMS)"=c("1","Obligations (includes FMS)"),
                              "Obligations (no FMS)"=c("0","Obligations (no FMS)"),
                              "Obligations (reliable\nFMS labels not available)"="Obligations (reliable\nFMS labels not available)")
fpds_annual$Topline<-"Outlays"


fa_lc<-prepare_labels_and_colors(fpds_annual,path="offline")
fa_ck<-get_column_key(fpds_annual,path="offline")

(toplineOutlay<-build_plot(data=fpds_annual %>% filter(Fiscal_Year>=1990),#rbind(quarterly,q2021,e2021),
                     chart_geom="Bar Chart",
                     x_var="dFYear",#alpha_var="YTD",
                     y_var="Action_Obligation_OMB25_GDP23",
           color_var="FMS",
           labels_and_colors = fa_lc,
           column_key = fa_ck
       )+
    geom_path(aes(x=dFYear,y=Outlays_OMB25_GDP23,color=Topline))+
    scale_color_manual(name="Budget",values="black")+
  # scale_alpha_discrete(range=c(0.4,1))+
    labs(x="Fiscal Year",y="Constant FY 2023 $",fill="Contract",color="Budget",
         caption="Source: FPDS, FY 2025 Office of Management\nand Budget Public Historical Tables, CSIS Analysis",
         title="DOD Contract Obligations and Outlays, FY 1990-FY 2025 Q2")+
    theme(legend.position = "right")+
    date_x_year_breaks(1990,2029,3)#,partial_year=2024,partial_label="\nQ1")
)


ggsave600dpi(toplineOutlay,file=file.path("..","Output","AcqTrends","toplineOutlay_outlay_annual.png"),  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )


output_TY<-toplineOutlay$data %>%
  mutate(source=ifelse(!is.na(Outlays_Then_Year),
                       "Outlays","Contract"),
         Dollars=ifelse(source=="Outlays",
                        Outlays_Then_Year,Action_Obligation_Then_Year))%>%
  filter(Fiscal_Year>=1990)%>%
          format_data_for_plot(
                               fy_var="Fiscal_Year",
                               y_var="Dollars",
                               color_var="source",
                               facet="FMS",
                               # labels_and_colors = ota_lc,
                               group=TRUE) %>%
            arrange(Fiscal_Year) 


output_TY<-deflate(output_TY,money_var = "Dollars",deflator_var="OMB25_GDP23",path="offline")

#+theme(plot.margin =margin(t=0,b=0,l=0.1,r=0.25,"inches"))
log_plot(plot=toplineOutlay, 
         df=output_TY   , y_var="Dollars_OMB25_GDP23",#%>% filter(Fiscal_YQ<=2025.2),
                     filename="acq_fig2_1_outlay_annual",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="1 Outlay",path="../output/AcqTrends/", height=3,
         excel_formulas = TRUE,
                     startRow=1,startCol=13,format=TRUE,var_list=c("source","FMS"),
         output_doc_svg=TRUE
         )


log_plot(plot=toplineOutlay, df=output_TY,y_var="Dollars_OMB25_GDP23",
                     filename="nps_fig01_outlay_fms",xlsx="DoD_2025_NPS.xlsx",
                     sheet="1 Outlay",path="../output/AcqTrends/NPS2025/",second_path=online_path,
         height=3,include_YTD=FALSE,
                     format=TRUE,excel_y_var=TRUE,excel_formulas = TRUE,
         output_slide_png=TRUE,var_list=c("source","FMS"),suppress_doc_svg_text = "title"
         )
summary(factor(platpscintldef$IsJSF))
View(platpscintldef %>% group_by(Fiscal_Year,IsFMS,IsJSF) %>% filter(IsJSF=="JSF (F-35)") %>%
  summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE)))
```

##Top Line FMS
###FMS identification
```{r contract_identification}



# undebug(build_plot)

(contract_identification <-  build_plot(data=platpscintldef %>% filter(ContractingCustomer=="Defense"),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="foreign_funding_description",
                            facet_var="IsFMS",
                            # second_var="StateRegion",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Constant 2022 $ Obligated",
       caption="Source: FPDS; CSIS analysis.")+
    guides(fill=guide_legend(ncol=3)))

ggsave600dpi(contract_identification,file="../output/figure_03_contract_identification.png",size=12,lineheight=1, height =5, width=9)



```


### Pricing FMS
```{r FPDS_pricingUCA}
summary(def_data$IsFMS)
def_data$ProductOrService<-factor(def_data$SimpleArea)
levels(def_data$ProductOrService)<-list("Products"="Products (All)",
                                         "Services & R&D"=c("R&D","Services (Non-R&D)"),
                                         "Unlabeled"="Unlabeled")


def_data<- def_data %>%      group_by(Fiscal_Year,IsFMS) %>%
                               dplyr::mutate(Action_FMS_Share=Action_Obligation_OMB25_GDP23/
                                           sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))%>% 
                               group_by(Fiscal_Year,IsFMS,ProductOrService) %>%
                               dplyr::mutate(Action_FMS_PS_Share=Action_Obligation_OMB25_GDP23/
                                           sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))%>% 
                               group_by(Fiscal_Year,IsFMS,SimpleArea) %>%
                               dplyr::mutate(Action_FMS_PSR_Share=Action_Obligation_OMB25_GDP23/
                                           sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))



# undebug(build_plot)
# undebug(build_plot)
(fpds_pricing <-  build_plot(data=def_data %>% filter(Fiscal_Year>=2012 & Fiscal_YQ<=2025.2),
                            chart_geom="Line Chart",
                            x_var="dFYear",
                            y_var="Action_FMS_Share",
                            color_var="IsFMS",
                            facet_var="PricingUCA",
                            # second_var="StateRegion",
                            labels_and_colors=def_lc,
                            column_key=def_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE,
                            alpha_var="YTD",
)+date_x_year_breaks(2012,2022,2)+#,partial_year=2024,partial_label="\nQ1")
    theme(legend.position = "right")+
    facet_wrap( ~PricingUCA)+
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)))



# undebug(format_data_for_plot)
(fpds_pricing_bar <-  build_plot(data=def_data %>% filter(Fiscal_Year>=2012 & Fiscal_YQ<=2025.2),
                            chart_geom="Bar Chart",
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PricingUCA",
                            facet_var="IsFMS",
                            # second_var="StateRegion",
                            labels_and_colors=def_lc,
                            column_key=def_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE,
                            alpha_var="YTD",
)+date_x_year_breaks(2012,2022,3)+#,partial_year=2024,partial_label="\nQ1")
    theme(legend.position = "right")+
    facet_grid( IsFMS~. , scales="free_y"))

# +
#   labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
#        y="Constant 2023 $ Obligated (Variable Y-Scale)",
#        caption="Source: FPDS and CSIS analysis.")+
#     theme(legend.position = "right"))

(fpds_pricing_psr <-  build_plot(data=def_data %>% filter(Fiscal_Year>=2012 & Fiscal_YQ<=2025.2) %>%
                                   filter(SimpleArea!="Unlabeled" & IsFMS!="Unlabeled" & !is.na(IsFMS)),
                            chart_geom="Line Chart",
                            x_var="dFYear",
                            y_var="Action_FMS_PSR_Share",
                            color_var="IsFMS",
                            facet_var="PricingUCA",
                            second_var="SimpleArea",
                            labels_and_colors=def_lc,
                            column_key=def_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE,
                            alpha_var="YTD",
)+date_x_year_breaks(2012,2022,3)+#,partial_year=2024,partial_label="\nQ1")
    theme(legend.position = "right")+
    facet_grid(SimpleArea~PricingUCA)+
    scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
    labs(caption="Note: Excludes unlabeled product or service and unlabeled FMS.\nSource: FPDS and CSIS analysis."))#+

     # theme(strip.text.y = element_text(angle=0)))


# debug(buildaC_plot)
(fpds_pricing_psr_bar <-  build_plot(data=def_data  %>% filter(SimpleArea!="Unlabeled"&
                                                                    IsFMS!="Unlabeled" & 
                                                                  !is.na(IsFMS))%>%
                                       filter(Fiscal_Year>=2012 & Fiscal_YQ<=2025.2),
                            chart_geom="Bar Chart",
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PricingUCA",
                            facet_var="IsFMS",
                            second_var="ProductOrService",
                            labels_and_colors=def_lc,
                            column_key=def_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE,
                            alpha_var="YTD",
)+date_x_year_breaks(2012,2022,3)+#,partial_year=2024,partial_label="\nQ1")
    theme(legend.position = "right")+
    facet_grid( IsFMS~ProductOrService , scales="free_y")+
    labs(caption="Note: Excludes unlabeled product or service and unlabeled FMS.\nSource: FPDS and CSIS analysis."))
# 
# ggsave600dpi(fpds_pricing_psr_bar, filename = "..//output//figure_07_fpds_pricing_psr_bar.png", 
#        width = 9,
#        height = 4.5,
#        size = 12, lineheight=1)

log_plot(plot=fpds_pricing_psr_bar, df=def_data  %>% filter(Fiscal_YQ<=2025.2),
                     filename="acq_fig7_3_FMS_ps_pricing",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="7-3 FMSprice",path="../output/AcqTrends/", height=3.5,
                     startRow=1,startCol=15,format=TRUE,var_list=c("IsFMS","ProductOrService","PricingUCA.sum","PricingUCA")
         )


```

# FMS or International

## Service Category
```{r FPDS_vendor_Intl}

summary(factor(platpscintldef$SimpleArea))
# undebug(format_data_for_plot)
(fmsintl_service <-  build_plot(data=platpscintldef%>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign) &
                                                                            Fiscal_Year>2011 & !is.na(IsFMS)&
                                                                  SimpleArea=="Services"),#IsFMS==TRUE                             
                                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="ProductOrServiceArea",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )+labs(title="Services FMS or Performed Internationally")#, scales="free_y"#, scales="free_y"
  )
summary(platpscintldef$dFYear)

write.csv(file="..//Output//fmsintl_service.csv",row.names = FALSE,na = "",
          fmsintl_service$data%>%# mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlaceIsForeign,IsFMS,ProductOrServiceArea),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)%>% arrange(PlaceIsForeign,IsFMS,ProductOrServiceArea))

ggsave600dpi(fmsintl_service,file="../output/fmsintl_service.png",
             size = 12, lineheight=1, height =6, width=9)


(fmsintl_service_vendor <-  build_plot(data=platpscintldef%>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign) &
                                                                            Fiscal_Year>2011 & !is.na(IsFMS)&
                                                                  SimpleArea=="Services"),#IsFMS==TRUE                             
                                            chart_geom="Bar Chart",
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="ProductOrServiceArea",
                            facet_var="IsFMSplaceIntl",
                            second_var="VendorSize_Intl",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( IsFMSplaceIntl~VendorSize_Intl , scales="free_y", space="free_y")+labs(title="Services FMS or Performed Internationally")+
    theme(  strip.text.y=element_text(angle=0))
  )


write.csv(file="..//Output//fmsintl_service_vendor.csv",row.names = FALSE,na = "",
          fmsintl_service_vendor$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(IsFMSplaceIntl,VendorSize_Intl,ProductOrServiceArea),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)%>% arrange(IsFMSplaceIntl,VendorSize_Intl,ProductOrServiceArea))

ggsave600dpi(fmsintl_service_vendor,file="../output/fmsintl_service_vendor.png",
             size = 12, lineheight=1, height =6, width=9)

```



# JSF 

### JSF-MDAP-FMS
```{r FPDS_JSF}

summary(factor(platpscintldef$Shiny.VendorSize[platpscintldef$VendorIsForeign==1]))
summary(platpscintldef$IsFMS)
summary(factor(platpscintldef$IsJSF))

platpscintldef<-platpscintldef %>% mutate(
  FMSJSF=case_when(
    IsFMS==1 & IsJSF =="JSF (F-35)" ~ "Includes FMS (JSF)",
    IsFMS==1 & IsJSF =="JSF (F-35)" ~ "Includes FMS (JSF)"
  )
)

# undebug(format_data_for_plot)
(fms_jsf <-  build_plot(data=platpscintldef %>% filter(Fiscal_Year>2011),
                                       #IsFMS==TRUE 
                                       chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="IsFMS",
                            facet_var="IsJSF",
                            # second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsJSF)#, scales="free_y"
  )



ggsave600dpi(fms_jsf,file="../output/jsf_vendor_intl_place.png",
             size = 12, lineheight=1, height =4.5, width=9)




```
### JSF National Origin
```{r FPDS_JSF}

summary(factor(platpscintldef$Shiny.VendorSize[platpscintldef$VendorIsForeign==1]))
summary(platpscintldef$VendorSize_Intl)

# undebug(format_data_for_plot)
(jsf_vendor_intl_place <-  build_plot(data=platpscintldef %>% filter(IsJSF=="JSF (F-35)"& Fiscal_Year>2011),
                                       #IsFMS==TRUE 
                                       chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="VendorSize_Intl",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )#, scales="free_y"
  )


write.csv(file="..//Output//jsf_vendor_intl_place.csv",row.names = FALSE,na = "",
          jsf_vendor_intl_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(VendorSize_Intl,IsFMS, PlaceIsForeign),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)%>% arrange(PlaceIsForeign,IsFMS,VendorSize_Intl))

ggsave600dpi(jsf_vendor_intl_place,file="../output/jsf_vendor_intl_place.png",
             size = 12, lineheight=1, height =4.5, width=9)


# platpscintldef$Shiny.VendorSize
# undebug(format_data_for_plot)
(jsf_manufacture_intl_place <-  build_plot(data=platpscintldef%>% filter(IsJSF=="JSF (F-35)"& Fiscal_Year>2011),              
                                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )#, scales="free_y"
  )


write.csv(file="..//Output//jsf_manufacture_intl_place.csv",row.names = FALSE,na = "",
          jsf_manufacture_intl_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlaceIsForeign,IsFMS, PlaceOfManufacture_Sum),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)%>% arrange(PlaceIsForeign,IsFMS,PlaceOfManufacture_Sum))

ggsave600dpi(jsf_manufacture_intl_place,file="../output/jsf_manufacture_intl_place.png",
             size = 12, lineheight=1, height =4.5, width=9)

platpscintldef$OriginISOalpha3
(jsf_manufacture_intl_place <-  build_plot(data=platpscintldef%>% filter(IsJSF=="JSF (F-35)"& Fiscal_Year>2011),              
                                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="OriginISOalpha3",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            # labels_and_colors=intl_lc,
                            # column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )#, scales="free_y"
  )



```


### JSF Place
```{r FPDS_vendor_Intl}


# undebug(format_data_for_plot)
(fpds_manufacture_intl_place <-  build_plot(data=platpscintldef%>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign) &
                                                                            Fiscal_Year>2011 & !is.na(IsFMS)),#IsFMS==TRUE                             
                                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="IsFMSplaceIntl",
                            second_var="IsJSF",
                            # labels_and_colors=intl_lc,
                            # column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")#+
    # facet_grid( IsJSF+PlaceIsForeign )#, scales="free_y"
  )


```

### FMS Vendor Size/Intl and Place No JSF
```{r FPDS_vendor_Intl}


summary(factor(platpscintldef$Shiny.VendorSize[platpscintldef$VendorIsForeign==1]))
summary(platpscintldef$VendorSize_Intl)

# undebug(format_data_for_plot)
(fpds_vendor_intl_place <-  build_plot(data=platpscintldef %>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign)&
                                                                      !is.na(IsFMS)& Fiscal_Year>2011),
                                       #IsFMS==TRUE 
                                       chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="VendorSize_Intl",
                            facet_var="IsJSF",
                            second_var="IsFMSplaceIntl",
                            # labels_and_colors=intl_lc,
                            # column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid(IsFMSplaceIntl~IsJSF, scales="free_y", space="free_y")
  )


summary(factor(platpscintldef$Shiny.VendorSize[platpscintldef$VendorIsForeign==1]))
summary(platpscintldef$VendorSize_Intl)

# undebug(format_data_for_plot)
(fpds_vendor_intl_place_noJSF <-  build_plot(data=platpscintldef %>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign)&
                                                                      !is.na(IsFMS)& Fiscal_Year>2011&
                                                                            IsJSF %in% c("Other Project","Unknown Project")),
                                       #IsFMS==TRUE 
                                       chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="VendorSize_Intl",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )+labs(title="FMS or Performed Internationally, No JSF")#, scales="free_y"
  )


write.csv(file="..//Output//FMS_vendorplaceintl_noJSF.csv",row.names = FALSE,na = "",
          fpds_vendor_intl_place_noJSF$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(VendorSize_Intl,IsFMS, PlaceIsForeign),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)%>% arrange(PlaceIsForeign,IsFMS,VendorSize_Intl))

ggsave600dpi(fpds_vendor_intl_place_noJSF,file="../output/FMS_vendorplaceintl_noJSF.png",
             size = 12, lineheight=1, height =4.5, width=9)


# platpscintldef$Shiny.VendorSize
(fpds_vendor_place_noJSF <-  build_plot(data=platpscintldef %>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign)&
                                                                      !is.na(IsFMS)&Fiscal_Year>2011&
                                                                            IsJSF %in% c("Other Project","Unknown Project") ),#IsFMS==TRUE  
                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="Shiny.VendorSize",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )+labs(title="FMS or Performed Internationally, No JSF")#, scales="free_y"#, scales="free_y"
  )

ggsave600dpi(fpds_vendor_place_noJSF,file="../output/FMS_vendorplace_noJSF.png",
             size = 12, lineheight=1, height =4.5, width=9)


write.csv(file="..//Output//FMS_vendorplace_noJSF.csv",row.names = FALSE,na = "",
          fpds_vendor_place_noJSF$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(Shiny.VendorSize,PlaceIsForeign,IsFMS),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)%>% arrange(PlaceIsForeign,Shiny.VendorSize,IsFMS))


```


#International


###FMS identification
```{r contract_identification}

summary(def_data$foreign_funding_description)

# undebug(build_plot)

(contract_identification <-  build_plot(data=def_data ,
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="foreign_funding_description",
                            facet_var="IsFMS",
                            # second_var="StateRegion",
                            # labels_and_colors=intl_lc,
                            # column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.")+
    guides(fill=guide_legend(ncol=3)))

ggsave600dpi(contract_identification,file="../Output//AcqTrends/figure_03_contract_identification.png",size=12,lineheight=1, height =5, width=9)



```

#### Contract identification
```{r contract_identification}

summary(def_data$PlaceOfManufacture_Sum)

# undebug(build_plot)

(contract_identification <-  build_plot(data=def_data ,
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="SimpleArea",
                            # second_var="StateRegion",
                            labels_and_colors=def_lc,
                            column_key=def_ck,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.")+
    guides(fill=guide_legend(ncol=3)))


(contract_identification <-  build_plot(data=def_data %>% filter(!is.na(PlaceIsForeign)),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="PlaceIsForeign",
                            # second_var="StateRegion",
                            labels_and_colors=def_lc,
                            column_key=def_ck,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    facet_grid(  PlaceIsForeign~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s,\nVariable Axis)",
       caption="Source: FPDS and CSIS analysis.")+
    guides(fill=guide_legend(ncol=3)))


(contract_identification <-  build_plot(data=def_data%>% filter(Fiscal_Year>=2000) ,
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="VendorIsForeign",
                            # second_var="StateRegion",
                            labels_and_colors=def_lc,
                            column_key=def_ck,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.")+
    guides(fill=guide_legend(ncol=3)))


ggsave600dpi(contract_identification,file="../Output//AcqTrends/figure_03_contract_identification.png",size=12,lineheight=1, height =5, width=9)



```

###Buy America

#### Waiver Type

```{r contract_identification}

summary(def_data$PlaceOfManufactureText)
def_data$PlaceOfManufactureText20<-factor_wrap(def_data$PlaceOfManufactureText)
# undebug(build_plot)
summary(factor(def_data$PlaceOfManufactureText20))

write.csv(def_data %>% group_by(PlaceOfManufactureText,PlaceIsForeign,VendorIsForeign,OriginIsForeign) %>%
  summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23)) %>% pivot_wider(names_from=PlaceOfManufactureText,
                                                                                       values_from=Action_Obligation_OMB25_GDP23),
  file="waiver_crossref.csv")
  


def_data$OriginManufactureVendor<-NA
# def_data$OriginManufactureVendor[def_data$PlaceOfManufacture_Sum=="Manufactured Outside U.S."]<-"Foreign Manufacture or Origin"
def_data$OriginManufactureVendor[def_data$OriginIsForeign==1]<-"Foreign Manufacture or Origin"
def_data$OriginManufactureVendor[is.na(def_data$OriginManufactureVendor)]<-
  def_data$PlaceOfManufactureText[is.na(def_data$OriginManufactureVendor)]


 def_data<-csis360::read_and_join_experiment(def_data,
                                          "Location_PlaceOfManufacture.csv",
                                          by="PlaceOfManufacture",
                                          add_var=c("PlaceOfManufactureText","PlaceOfManufacture_Sum",
                                                    "PlaceOfManufacture_DoD"),
                                          skip_check_var = c("PlaceOfManufactureText","PlaceOfManufacture_Sum",
                                                             "PlaceOfManufacture_DoD"),
                                          path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                                          # path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\",
                                          # path="C:\\Users\\gsand\\Repositories\\Lookup-Tables\\",
                                          # path="F:\\Users\\gsanders\\Documents\\Repositories\\Lookup-Tables\\",
                                          dir="location/",
                                          case_sensitive = FALSE
    )
 
 # debug(factor_wrap)
 def_data$OriginManufactureVendor20<-factor_wrap(def_data$OriginManufactureVendor)
 
def_data$Service<-factor(def_data$SimpleArea)
levels(def_data$Service)<-list("Products"="Products (All)",
                                "Services and R&D"=c("R&D", "Services (Non-R&D)"),
                                "Unlabeled"="Unlabeled")
 
def_data$OriginManufactureVendor<-def_data$PlaceOfManufacture_DoD

 def_data$OriginManufactureVendor[is.na(def_data$OriginManufactureVendor)&                                    
                                     (def_data$Service=="Services and R&D" | 
                                        def_data$PlaceOfManufactureText=="NOT A MANUFACTURED END PRODUCT") &
                                     (def_data$VendorIsForeign==1 | def_data$OriginIsForeign==1)]<-"Not MFG, Foreign Vendor or Origin"
 def_data$OriginManufactureVendor[def_data$OriginManufactureVendor=="U.S. Manufactured" &
                                    (def_data$VendorIsForeign==1 | def_data$OriginIsForeign==1)]<-"U.S. Manufactured, Foreign Vendor or Origin"

  def_data %>% filter(OriginManufactureVendor=="Unlabeled Waiver" &
                         Service=="Services and R&D" )  %>% group_by(VendorIsForeign,OriginIsForeign) %>%
    summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))
 
 
 def_data %>% filter(PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1) %>%
   filter(is.na(OriginManufactureVendor))%>%
   group_by(PlaceOfManufactureText,OriginManufactureVendor,Service,PlaceIsForeign,VendorIsForeign,OriginIsForeign) %>%
  summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23)) 

 # def_data$OriginManufactureVendor[is.na(def_data$OriginManufactureVendor)&
 #                                     def_data$VendorIsForeign==1&def_data$OriginIsForeign==0]<-"U.S. Origin Intl Vendor"
 # 
 # def_data$OriginManufactureVendor[is.na(def_data$OriginManufactureVendor)&
 #                                     def_data$VendorIsForeign==0&def_data$OriginIsForeign==1]<-"Intl Vendor U.S. Origin"
 #  
 # def_data$OriginManufactureVendor[is.na(def_data$OriginManufactureVendor)&
 #                                     def_data$VendorIsForeign==1&def_data$OriginIsForeign==1]<-"Intl Vendor Intl Origin"
 # 
 # def_data$OriginManufactureVendor[def_data$OriginManufactureVendor=="Unlabeled Waiver" &
 #                                     def_data$Service=="Services and R&D" &
 #                                     def_data$VendorIsForeign==0&def_data$OriginIsForeign==1]<-"Intl Vendor U.S. Origin"
 #  
 # def_data$OriginManufactureVendor[def_data$OriginManufactureVendor=="Unlabeled Waiver" & 
 #                                     def_data$Service=="Services and R&D" &
 #                                     def_data$VendorIsForeign==1&def_data$OriginIsForeign==1]<-"Intl Vendor Intl Origin"
 # 
 #  def_data$OriginManufactureVendor[def_data$OriginManufactureVendor=="Unlabeled Waiver" & 
 #                                     def_data$Service=="Services and R&D" &
 #                                     def_data$VendorIsForeign==1&def_data$OriginIsForeign==0]<-"U.S. Origin Intl Vendor"
 #  
  
  def_data %>% filter(OriginManufactureVendor=="Unlabeled Waiver" &
                         Service=="Services and R&D" )  %>% group_by(VendorIsForeign,OriginIsForeign) %>%
    summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))
  
   def_data %>% filter(is.na(OriginManufactureVendor) &
                         Service=="Services and R&D" )  %>% group_by(VendorIsForeign,OriginIsForeign) %>%
    summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))
  
  labels_and_colors<-prepare_labels_and_colors(def_data)
  column_key<-get_column_key(def_data)
  
  
(waiverdetail <-  build_plot(data=def_data %>% filter(PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1)  %>%filter(!is.na(SimpleArea) & SimpleArea!="Unlabeled"),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="dFYear",alpha_var="YTD",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_DoD",
                            facet_var="SimpleArea",
                            # second_var="OriginIsForeign",
                            # labels_and_colors=def_lc,
                            # column_key=def_ck,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    facet_grid(  SimpleArea~.)+
  labs(x="Fiscal Year",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.")+
    theme(legend.position = "right")
    # guides(fill=guide_legend(ncol=2)
)

  ggsave600dpi(waiverdetail,file="../Output//AcqTrends/waiverdetail.png",size=14,lineheight=1, height =5.75, width=7)


  
  
  
    write.csv(file="..//Output//AcqTrends//waiverdetail.csv",row.names = FALSE, na = "",
            waiverdetail$data %>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
              pivot_wider(id_cols=c(PlaceOfManufacture_DoD,SimpleArea),
                          names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)
            %>% arrange(PlaceOfManufacture_DoD,SimpleArea))

```
##### Simple Waiver Type
```{r SimpleWaiver}
def_data$PlaceOfManufacture_DoD09<-def_data$PlaceOfManufacture_DoD
def_data %>% filter(OriginManufactureVendor=="Unlabeled Waiver" &
                         ProductOrService=="Services and R&D" )  %>% group_by(VendorIsForeign,OriginIsForeign) %>%
    summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))
  
   def_data %>% filter(is.na(OriginManufactureVendor) &
                         ProductOrService=="Services and R&D" )  %>% group_by(VendorIsForeign,OriginIsForeign) %>%
    summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))
  
  
 def_data$PlaceOfManufacture_DoD09[is.na(def_data$PlaceOfManufacture_DoD09)&                                    
                                     (def_data$ProductOrService=="Services and R&D" | 
                                        def_data$PlaceOfManufactureText=="NOT A MANUFACTURED END PRODUCT") &
                                     (def_data$VendorIsForeign==1 | def_data$OriginIsForeign==1)&
                                    def_data$PlaceIsForeign==1]<-"Not MFG, Foreign Place of Performance"
 def_data$PlaceOfManufacture_DoD09[def_data$PlaceOfManufacture_DoD09=="U.S. Manufactured" &
                                    (def_data$VendorIsForeign==1 | def_data$OriginIsForeign==1)]<-
   "U.S. Manufactured, Foreign Vendor or Origin"
 def_data$PlaceOfManufacture_DoD09[is.na(def_data$PlaceOfManufacture_DoD09)&                                    
                                     (def_data$ProductOrService=="Services and R&D" | 
                                        def_data$PlaceOfManufactureText=="NOT A MANUFACTURED END PRODUCT") &
                                     (def_data$VendorIsForeign==1 | def_data$OriginIsForeign==1)&
                                    def_data$PlaceIsForeign==0]<-"Not MFG, U.S. Place of Performance"
  def_data$PlaceOfManufacture_DoD09[def_data$PlaceOfManufacture_DoD09=="Foreign MFG, Perfomed, or Content, Unlabeled Waiver"]<-NA
 
def_data$PlaceOfManufacture_DoD09<-factor_wrap(def_data$PlaceOfManufacture_DoD09,nwrap=45)
 
  
  labels_and_colors<-prepare_labels_and_colors(def_data)
  column_key<-get_column_key(def_data)
  
(waiversimple <-  build_plot(data=def_data %>% filter(PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1)  %>%
                               filter(!is.na(SimpleArea) & SimpleArea!="Unlabeled")%>%
                               filter(Fiscal_Year>=2009 & Fiscal_YQ<=2025.2),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="dFYear",alpha_var="YTD",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_DoD09",
                            facet_var="ProductOrService",
                            # second_var="OriginIsForeign",
                            labels_and_colors=def_lc,
                            column_key=def_ck,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    facet_grid(  ProductOrService~.)+
  labs(x="Fiscal Year",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.",
       title="DoD Contracts with International\nVendors, Manufacture, or Origin")+
    theme(legend.position = "right")+
    date_x_year_breaks(2009,2022,2)+#,partial_year=2024,partial_label="\nQ1")
    theme(plot.margin = margin(t=0.2,r=0.25,b=0.1,l=0.1,"inches"))
    # guides(fill=guide_legend(ncol=2)
)

  ggsave600dpi(waiversimple,file="../Output//AcqTrends/waiversimple.png",size=14,lineheight=1, height =5.75, width=7)
  ggsave600dpi(waiversimple,file="../Output//AcqTrends/waiversimple.svg",size=14,lineheight=1, height =5.75, width=7)


log_plot(plot=waiversimple, df=def_data   %>% filter(Fiscal_YQ<=2025.2 & 
                                                        PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1),
                     filename="acq_fig7_4_ManufacturePlace",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="7-4 PS_MFG",path="../output/AcqTrends/", height=4,
                     startRow=1,startCol=12,format=TRUE,var_list=c("ProductOrService","PlaceOfManufacture_DoD09")
         )
  
  

    write.csv(file="..//Output//AcqTrends//waiversimple.csv",row.names = FALSE, na = "",
            waiversimple$data %>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
              pivot_wider(id_cols=c(PlaceOfManufacture_DoD09,ProductOrService),
                          names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)
            %>% arrange(PlaceOfManufacture_DoD09,ProductOrService))
    
    write.csv(def_data %>% filter(PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1)  %>%
                               filter(!is.na(SimpleArea) & SimpleArea!="Unlabeled")%>%
                               filter(Fiscal_Year>=2009),"intl_data.csv")
    
    
    
```


#### Waiverplace
```{r WaiverPlace}
  labels_and_colors<-prepare_labels_and_colors(def_data)
  column_key<-get_column_key(def_data)
  
  (waiverally <-  build_plot(data=def_data %>% filter(PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1) ,
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_DoD09",
                            facet_var="PlaceAcquisitionCooperation",
                            # second_var="StateRegion",
                            # labels_and_colors=def_lc,
                            # column_key=def_ck,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.")+
    theme(legend.position = "right")
    # guides(fill=guide_legend(ncol=2)
)
             




```
#### Place
```{r buy_america_place}

levels(factor(def_data$PlaceStateRegion))
def_data$PlaceStateRegion<-factor(def_data$PlaceStateRegion)
def_data$PlaceStateRegionSum<-factor(def_data$PlaceStateRegion)
levels(def_data$PlaceStateRegionSum)<-
  list("United States"="United States",
       "East Asia and Pacific"="East Asia and Pacific"  ,
       "Europe and Eurasia"="Europe and Eurasia"     ,
       "Near East"="Near East",
       "South and Central Asia"="South and Central Asia",
       "Rest of World"=c("Western Hemisphere","Non-Regional","Africa")
       )


summary(def_data$PlaceStateRegionSum)

def_data$PlaceOfManufactureText20<-factor_wrap(def_data$PlaceOfManufactureText)
# undebug(build_plot)
summary(factor(def_data$PlaceOfManufactureText20))
(placeregion <-  build_plot(data=def_data %>% filter((PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1)&!is.na(PlaceStateRegion)
                                                     ),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="dFYear",alpha_var="YTD",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="OriginManufactureVendor20",
                            facet_var="PlaceStateRegionSum",
                            # second_var="StateRegion",
                            labels_and_colors=def_lc,
                            column_key=def_ck,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    facet_grid(.~  PlaceStateRegionSum)+
  labs(x="Fiscal Year",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.")+
    
    theme(legend.position = "bottom")+scale_x_date(breaks=as.Date(c(paste(seq(2000,2021,3),"-01-01",sep=""))),
                                                   date_labels="'%y")#date_breaks = "3 years"
    # guides(fill=guide_legend(ncol=2)
           )

ggsave600dpi(placeregion,file="../Output//AcqTrends/place_of_manufacture_place_regionwaiver.png",size=14,lineheight=1, height =6, width=12)



summary(def_data$vendor)
def_data$PlaceMutualAcquisition
(placeregion <-  build_plot(data=def_data %>% filter((PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1)&!is.na(PlaceStateRegion)
                                                     ),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="PlaceMutualAcquisition",
                            # second_var="StateRegion",
                            labels_and_colors=def_lc,
                            column_key=def_ck,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.")+
    theme(legend.position = "bottom")
    # guides(fill=guide_legend(ncol=2)
           )
def_data$PlaceAcquisitionCooperation

(placeregion <-  build_plot(data=def_data %>% filter((PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1)&!is.na(PlaceStateRegion)
                                                     ),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="PlaceAcquisitionCooperation",
                            # second_var="StateRegion",
                            labels_and_colors=def_lc,
                            column_key=def_ck,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.")+
    theme(legend.position = "bottom")
    # guides(fill=guide_legend(ncol=2)
           )


def_data$place


(vendorregion <-  build_plot(data=def_data %>% filter(PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1) ,
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="VendorStateRegion",
                            # second_var="VendorRegion",
                            # labels_and_colors=def_lc,
                            # column_key=def_ck,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.")+
    theme(legend.position = "bottom")
    # guides(fill=guide_legend(ncol=2)
           )


(originregion <-  build_plot(data=def_data %>% filter(PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1) ,
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="dFYear",alpha_var="YTD",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="OriginStateRegion",
                            # second_var="VendorRegion",
                            # labels_and_colors=def_lc,
                            # column_key=def_ck,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.")+
    theme(legend.position = "bottom")
    # guides(fill=guide_legend(ncol=2)
           )


ggsave600dpi(waiver,file="../Output//AcqTrends/place_of_manufacture_waiver.png",size=8,lineheight=1, height =5, width=9)


(contract_identification <-  build_plot(data=def_data %>% filter(!is.na(PlaceIsForeign)),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="PlaceIsForeign",
                            # second_var="StateRegion",
                            labels_and_colors=def_lc,
                            column_key=def_ck,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    facet_grid(  PlaceIsForeign~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s,\nVariable Axis)",
       caption="Source: FPDS and CSIS analysis.")+
    guides(fill=guide_legend(ncol=3)))






```
###Korea

```{r}

(korea <-  build_plot(data=def_data %>% filter(PlaceISOalpha3=="KOR" |
                                                  VendorISOalpha3=="KOR" |
                                                  OriginISOalpha3=="KOR"),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="SimpleArea",
                            # second_var="StateRegion",
                            labels_and_colors=def_lc,
                            column_key=def_ck,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.")+
    theme(legend.position = "bottom")
    # guides(fill=guide_legend(ncol=2)
)

def_data$IsFMS
(korea <-  build_plot(data=def_data %>% filter(PlaceISOalpha3=="KOR" |
                                                  VendorISOalpha3=="KOR" |
                                                  OriginISOalpha3=="KOR"),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufactureText20",
                            facet_var="IsFMS",
                            # second_var="StateRegion",
                            # labels_and_colors=def_lc,
                            column_key=def_ck,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.")+
    theme(legend.position = "bottom")
    # guides(fill=guide_legend(ncol=2)
)

PlaceOfManufactureText20
```



### NTIB
#### OTA 
```{r FPDS_vendor_Intl}
ntibisoalpha3<-c("AUS","CAN","GBR")#"NZL",

ota_def$VendorNTIB<-"All Other"
ota_def$VendorNTIB[ota_def$VendorAddressISOalpha3=="USA"]<-"United States"
ota_def$VendorNTIB[ota_def$VendorAddressISOalpha3=="AUS"]<-"Australia"
ota_def$VendorNTIB[ota_def$VendorAddressISOalpha3=="NZL"]<-"New Zealand"
ota_def$VendorNTIB[ota_def$VendorAddressISOalpha3=="CAN"]<-"Canada"
ota_def$VendorNTIB[ota_def$VendorAddressISOalpha3=="GBR"]<-"United Kingdom"


summary(factor(ota_def$VendorNTIB))
# undebug(format_data_for_plot)

summary(ota_def$dFYear)

(ntibintl_plat <-  build_plot(data=ota_def%>% filter((#PlaceISOalpha3 %in% ntibisoalpha3|
                                                                  VendorAddressISOalpha3 %in% ntibisoalpha3) &
                                                                            Fiscal_Year>2011 & !is.na(VendorAddressISOalpha3)),#VendorAddressISOalpha3==TRUE                             
                                            chart_geom="Bar Chart",
                            x_var="dFYear",alpha_var="YTD",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlatformPortfolioUAV",
                            facet_var="VendorNTIB",
                            # second_var="PlaceIsForeign",
                            labels_and_colors=ota_lc,
                            column_key=ota_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( VendorNTIB~. )+labs(title="OTA obligations by Platform for Vendors with Addreses\nin Australia, Canada, and the United Kingdom",
                                    y="Action Obligation (Constant 2023 $s")#, scales="free_y"#, scales="free_y"
  )+scale_x_date("Fiscal Year",labels = scales::date_format("'%y"))

(ntibintl_cust <-  build_plot(data=ota_def%>% filter((#PlaceISOalpha3 %in% ntibisoalpha3|
                                                                  VendorAddressISOalpha3 %in% ntibisoalpha3) &
                                                                            Fiscal_Year>2011 & !is.na(VendorAddressISOalpha3)),#VendorAddressISOalpha3==TRUE                             
                                            chart_geom="Bar Chart",
                            x_var="dFYear",alpha_var="YTD",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="SubCustomer.OTA",
                            facet_var="VendorNTIB",
                            # second_var="PlaceIsForeign",
                            labels_and_colors=ota_lc,
                            column_key=ota_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( VendorNTIB~. )+labs(title="OTA obligations by Customer for Vendors with Addreses\nin Australia, Canada, and the United Kingdom",
                                    y="Action Obligation (Constant 2023 $s")#, scales="free_y"#, scales="free_y"
  )+scale_x_date("Fiscal Year",labels = scales::date_format("'%y"))
summary(ota_def$dFYear)


write.csv(file="..//Output//AcqTrends//ota//ntibintl_plat.csv",row.names = FALSE,na = "",
          ntibintl_plat$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(VendorNTIB,PlatformPortfolioUAV),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)%>% arrange(VendorNTIB,PlatformPortfolioUAV))

ggsave600dpi(ntibintl_plat,file="../Output//AcqTrends/ota/ntibintl_plat.png",
             size = 12, lineheight=1, height =5.5, width=6.5)

ggsave600dpi(ntibintl_cust,file="../Output//AcqTrends/ota/ntibintl_cust.png",
             size = 12, lineheight=1, height =5.5, width=6.5)


```
