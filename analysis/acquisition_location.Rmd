---
title: "Defense Acquisition Trends"
output:
  html_document:
    keep_md: yes
    toc: yes
date: "Wednesday, October 6, 2021"
---

# Setup
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from FPDS.

```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(scales)
library(openxlsx)
axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40
if(!exists("platpscintldef"))
  load(file="../data/clean/platpscintl_FPDS.Rda")


if(!exists("platpscdefcd"))
  load(file="../data/clean/platpscdefcd.Rda")
# save.image("../.RData")
```

# Preprocessing 
## Ukraine cut
```{r Location}
colnames(platpscdefcd)

ukraine_list<-c("1320","1305",
"2350","1410",
"1377","1055",
"1336","1440",
"1390","1337",
"1338","1420",
"1425","1427",
"1430","1450")

if(!"UkraineDIBrelevant" %in% colnames(platpscdefcd))
  platpscdefcd<-read_and_join_experiment(platpscdefcd, "ProjectIDUkraineDIBrelevant.csv",
                                           dir="..\\data\\semi_clean\\",path="",
                                         by="ProjectID",
                                           add_var=c("Project.Name","UkraineDIBrelevant"),
                                           skip_check_var=c("Project.Name","UkraineDIBrelevant"))

ukrplatpsc<-platpscdefcd %>% filter((ProductOrServiceCode %in% ukraine_list
                                      | UkraineDIBrelevant =="Always") & Fiscal_Year>=2022 &
                                        (is.na(UkraineDIBrelevant) | UkraineDIBrelevant !="Never"))
  # summarise(Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22))





```

## Project
```{r PreprocessProject}

summary(factor(platpscintldef$ProjectPlatform))

colnames(platpscintldef)[colnames(platpscintldef)=="Action_Obligation_Then_Year_Then_Year"]<-
  "Action_Obligation_Then_Year"

colnames(platpscintldef)[colnames(platpscintldef)=="Action_Obligation_Then_Year_OMB23_GDP21"]<-
  "Action_Obligation_OMB24_GDP22"

topplat<-platpscintldef %>% group_by (Project.Name,PlatformPortfolio) %>%
  summarise(Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22),
            Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB24_GDP22,0)))%>%
              group_by (PlatformPortfolio) %>%
    mutate(rank_total=rank(desc(Action_Obligation_OMB24_GDP22)),
                        rank_2020=rank(desc(Action_Obligation_2020)))
topplat %>% arrange(desc(Action_Obligation_OMB24_GDP22))


topplat$TopProject<-
  ifelse(topplat$rank_2020<=7 | topplat$rank_total<=7,topplat$Project.Name,NA)

platpscintldef<-left_join(platpscintldef,topplat %>% select(-Action_Obligation_OMB24_GDP22,Action_Obligation_2020),
          by=c("Project.Name","PlatformPortfolio"))

platpscintldef$TopProject[is.na(platpscintldef$TopProject) & !is.na(platpscintldef$Project.Name)]<-
  "Other Labeled Project"


summary(factor(platpscintldef$TopProject))


```
## PSC
```{r PreprocessPSC}

summary(factor(platpscintldef$ProjectPlatform))

topPSC<-platpscintldef %>% group_by (ProductOrServiceCode,ProductOrServiceCodeText,PlatformPortfolio) %>%
  summarise(Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22),
            Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB24_GDP22,0)))%>%
              group_by (PlatformPortfolio) %>%
    mutate(rank_total=rank(desc(Action_Obligation_OMB24_GDP22)),
                        rank_2020=rank(desc(Action_Obligation_2020)))
topPSC %>% arrange(desc(Action_Obligation_OMB24_GDP22))

topPSC$TopPScode<-
  ifelse(topPSC$rank_2020<=7 | topPSC$rank_total<=7,topPSC$ProductOrServiceCode,NA)
topPSC$TopPStext<-
  ifelse(topPSC$rank_2020<=7 | topPSC$rank_total<=7,topPSC$ProductOrServiceCodeText,NA)


platpscintldef<-left_join(platpscintldef,topPSC %>% select(-Action_Obligation_OMB24_GDP22,Action_Obligation_2020),
          by=c("ProductOrServiceCode","PlatformPortfolio"))

platpscintldef$TopPScode[is.na(platpscintldef$TopPScode) & !is.na(platpscintldef$ProductOrServiceCode)]<-
  "Other Labeled PSC"
platpscintldef$TopPStext[is.na(platpscintldef$TopPStext) & !is.na(platpscintldef$ProductOrServiceCode)]<-
  "Other Labeled PSC"

platpscintldef$TopPStext<-factor_wrap(platpscintldef$TopPStext)

summary(factor(platpscintldef$TopPStext))


```

## Place State
```{r PreprocessState}

# platpscintldef$pop_isna<-is.na(platpscintldef$pop_state_code)
# platpscintldef$sc_isna<-is.na(platpscintldef$PlaceStateCode)
# platpscintldef %>% group_by(Fiscal_Year,pop_isna,sc_isna) %>%
#   summarise(n=length(Fiscal_Year))

# summary(factor(platpscintldef$CrisisProductOrServiceArea))

topState<-platpscintldef %>% group_by (pop_state_code,CrisisProductOrServiceArea) %>%
  summarise(Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22),
            Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB24_GDP22,0)))%>%
              group_by (CrisisProductOrServiceArea) %>%
    mutate(rank_total=rank(desc(Action_Obligation_OMB24_GDP22)),
                        rank_2020=rank(desc(Action_Obligation_2020)))
topState %>% arrange(desc(Action_Obligation_OMB24_GDP22))

topState$TopStateAbbr<-
  ifelse(topState$rank_2020<=25 | topState$rank_total<=25,topState$pop_state_code,NA)
# topState$TopStateName<-
#   ifelse(topState$rank_2020<=7 | topState$rank_total<=7,topState$PlaceStateCodeText,NA)
platpscintldef<-platpscintldef[,!colnames(platpscintldef) %in% c("Action_Obligation_OMB24_GDP22.x","Action_Obligation_OMB24_GDP22.y",
                                   "Action_Obligation_2020.x","Action_Obligation_2020.y",
  "rank_total.y","rank_total.x","rank_2020.y","rank_2020.x","TopStateAbbr.x","TopStateAbbr.y")]

platpscintldef<-left_join(platpscintldef,topState %>% select(-Action_Obligation_OMB24_GDP22,Action_Obligation_2020),
          by=c("pop_state_code","CrisisProductOrServiceArea"))

platpscintldef$TopStateAbbr[is.na(platpscintldef$TopStateAbbr) & !is.na(platpscintldef$pop_state_code)]<-
  "Other Labeled State"
# platpscintldef$TopStateName[is.na(platpscintldef$TopStateName) & !is.na(platpscintldef$pop_state_code)]<-
#   "Other Labeled State"


# summary(factor(platpscintldef$TopStateName))


```

## Place Country
```{r PreprocessCountry}

# summary(factor(platpscintldef$CrisisProductOrServiceArea))
colnames(platpscintldef)[colnames(platpscintldef)=="Fiscal_Year"]<-"Fiscal_Year"
topCountry<-platpscintldef %>% group_by (PlaceISOalpha3,CrisisProductOrServiceArea) %>%
  summarise(Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22),
            Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB24_GDP22,0)))%>%
              group_by (CrisisProductOrServiceArea) %>%
    mutate(rank_total=rank(desc(Action_Obligation_OMB24_GDP22)),
                        rank_2020=rank(desc(Action_Obligation_2020)))
topCountry %>% arrange(desc(Action_Obligation_OMB24_GDP22))

topCountry$TopCountryISO<-
  ifelse(topCountry$rank_2020<=7 | topCountry$rank_total<=7,topCountry$PlaceISOalpha3,NA)
# topCountry$TopCountryName<-
#   ifelse(topCountry$rank_2020<=7 | topCountry$rank_total<=7,topCountry$PlaceCountryCodeText,NA)


platpscintldef<-left_join(platpscintldef,topCountry %>% select(-Action_Obligation_OMB24_GDP22,Action_Obligation_2020),
          by=c("PlaceISOalpha3","CrisisProductOrServiceArea"))

platpscintldef$TopCountryISO[is.na(platpscintldef$TopCountryISO) & !is.na(platpscintldef$PlaceISOalpha3)]<-
  "Other Labeled Country"
# platpscintldef$TopCountryName[is.na(platpscintldef$TopCountryName) & !is.na(platpscintldef$PlaceISOalpha3)]<-
#   "Other Labeled Country"


# summary(factor(platpscintldef$TopCountryName))


```

# Ukraine
## ProdServ
```{r ukr_psc}

wb <- loadWorkbook("..//Output//Munitions//Weapons_Systems_in_Ukr_Supp.xlsx")
writeData(wb, sheet = "PSC", startRow = 2, startCol = 1,
          ukrplatpsc %>% group_by(
            ProductServiceOrRnDarea,ProductOrServiceCode,ProductOrServiceCodeText)%>%
            # arrange(ProductServiceOrRnDarea,ProductOrServiceCode,ProductOrServiceCodeText))%>%
  summarise(Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22)))
saveWorkbook(wb,file="..//Output//Munitions//Weapons_Systems_in_Ukr_Supp.xlsx",overwrite = TRUE)


```

## Platform and Project
```{r ukr_psc}
ukrplatpsc$Project.Name[ukrplatpsc$ProjectID==466]<-"PIM"

ukrplatpsc$ProjPSC<-ifelse(is.na(ukrplatpsc$Project.Name),
                           paste(ukrplatpsc$ProductOrServiceCode,ukrplatpsc$ProductOrServiceCodeText,sep="-"),
                           ukrplatpsc$Project.Name)

wb <- loadWorkbook("..//Output//Munitions//Weapons_Systems_in_Ukr_Supp.xlsx")
writeData(wb, sheet = "Plat", startRow = 1, startCol = 1,
          ukrplatpsc %>% group_by(
            PlatformPortfolio,ProjectID,Project.Name)%>%
  summarise(Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22)))
saveWorkbook(wb,file="..//Output//Munitions//Weapons_Systems_in_Ukr_Supp.xlsx",overwrite = TRUE)


wb <- loadWorkbook("..//Output//Munitions//Weapons_Systems_in_Ukr_Supp.xlsx")
writeData(wb, sheet = "Plat", startRow = 1, startCol = 6,
          ukrplatpsc %>% group_by(
            PlatformPortfolio,ProjectID,ProjPSC)%>%
  summarise(Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22)))
saveWorkbook(wb,file="..//Output//Munitions//Weapons_Systems_in_Ukr_Supp.xlsx",overwrite = TRUE)


```

## Vendor CD
```{r ukr_vendor_CD}

wb <- loadWorkbook("..//Output//Munitions//Weapons_Systems_in_Ukr_Supp.xlsx")
writeData(wb, sheet = "State", startRow = 2, startCol = 1,
          ukrplatpsc %>% group_by(
            VendorIsForeign,VendorStateCode)%>%
            # arrange(ProductServiceOrRnDarea,ProductOrServiceCode,ProductOrServiceCodeText))%>%
  summarise(Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22)))
saveWorkbook(wb,file="..//Output//Munitions//Weapons_Systems_in_Ukr_Supp.xlsx",overwrite = TRUE)

ukrplatpsc$VendorCD<-ifelse(nchar(ukrplatpsc$prime_award_transaction_recipient_cd_current)<=2 &
                              ukrplatpsc$VendorIsForeign==0,
                            paste(ukrplatpsc$VendorStateCode,ukrplatpsc$prime_award_transaction_recipient_cd_current,sep="-"),
                                  ukrplatpsc$prime_award_transaction_recipient_cd_current)

wb <- loadWorkbook("..//Output//Munitions//Weapons_Systems_in_Ukr_Supp.xlsx")
writeData(wb, sheet = "State", startRow = 2, startCol = 5,
          ukrplatpsc %>% group_by(
            VendorIsForeign,VendorStateCode,VendorCD)%>%
            # arrange(ProductServiceOrRnDarea,ProductOrServiceCode,ProductOrServiceCodeText))%>%
  summarise(Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22)))
saveWorkbook(wb,file="..//Output//Munitions//Weapons_Systems_in_Ukr_Supp.xlsx",overwrite = TRUE)


```

## Place CD
```{r ukr_place_CD}


wb <- loadWorkbook("..//Output//Munitions//Weapons_Systems_in_Ukr_Supp.xlsx")
writeData(wb, sheet = "Place", startRow = 2, startCol = 1,
          ukrplatpsc %>% group_by(
            PlaceIsForeign,pop_state_code)%>%
  summarise(Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22)))
saveWorkbook(wb,file="..//Output//Munitions//Weapons_Systems_in_Ukr_Supp.xlsx",overwrite = TRUE)

ukrplatpsc$VendorCD<-ifelse(nchar(ukrplatpsc$prime_award_transaction_place_of_performance_cd_current)<=2 &
                              ukrplatpsc$PlaceIsForeign==0,
                            paste(ukrplatpsc$pop_state_code,ukrplatpsc$prime_award_transaction_place_of_performance_cd_current,sep="-"),
                                  ukrplatpsc$prime_award_transaction_place_of_performance_cd_current)

wb <- loadWorkbook("..//Output//Munitions//Weapons_Systems_in_Ukr_Supp.xlsx")
writeData(wb, sheet = "Place", startRow = 2, startCol = 5,
          ukrplatpsc %>% group_by(
            PlaceIsForeign,pop_state_code,VendorCD)%>%
  summarise(Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22)))
saveWorkbook(wb,file="..//Output//Munitions//Weapons_Systems_in_Ukr_Supp.xlsx",overwrite = TRUE)


```


# Top Projects Annual

```{r TopProject}
summary(platpscintldef$PlatformPortfolio[platpscintldef$ProductOrServiceCode=='AC11'])

topoverall<-platpscintldef %>% group_by (Project.Name,Fiscal_Year) %>%
  summarise(Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22))%>%
              group_by (Fiscal_Year) %>%
    mutate(rank_annual=rank(desc(Action_Obligation_OMB24_GDP22))) %>%
  arrange(desc(Fiscal_Year) ,desc(Action_Obligation_OMB24_GDP22))


topoverall$TopProject<-
  ifelse(topoverall$rank_annual<=11,topoverall$Project.Name,NA)
#11 because NA counts as one.


topoverall$TopProject[is.na(topoverall$TopProject) & !is.na(topoverall$Project.Name)]<-
  "Other Labeled Project"


write.csv(topoverall %>% group_by(TopProject,Fiscal_Year) %>%
            summarise(Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22))%>%
            arrange(desc(Fiscal_Year) ,desc(Action_Obligation_OMB24_GDP22))
          
          ,file="TopAnnualDoDproject.csv",row.names = FALSE)


# platpscintldef<-left_join(platpscintldef,topplat %>% select(-Action_Obligation_OMB24_GDP22,Action_Obligation_2020),
#           by=c("Project.Name","PlatformPortfolio"))


```



# International
##FMS 
#### Service Category
```{r FPDS_vendor_Intl}

summary(factor(platpscintldef$SimpleArea))
# undebug(format_data_for_plot)
(fmsintl_service <-  build_plot(data=platpscintldef%>% filter((PlaceIsForeign==1|VendorIsForeign==TRUE)&!is.na(PlaceIsForeign) &
                                                                            Fiscal_Year>2011 & !is.na(IsFMS)&
                                                                  SimpleArea=="Services"),#IsFMS==TRUE                             
                                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB24_GDP22",
                            color_var="CrisisProductOrServiceArea",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )+labs(title="Services FMS or Performed Internationally")#, scales="free_y"#, scales="free_y"
  )
summary(platpscintldef$dFYear)

write.csv(file="..//Output//fmsintl_service.csv",row.names = FALSE,na = "",
          fmsintl_service$data%>%# mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlaceIsForeign,IsFMS,CrisisProductOrServiceArea),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22)%>% arrange(PlaceIsForeign,IsFMS,CrisisProductOrServiceArea))

ggsave600dpi(fmsintl_service,file="../output/fmsintl_service.png",
             size = 12, lineheight=1, height =6, width=9)


(fmsintl_service_vendor <-  build_plot(data=platpscintldef%>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign) &
                                                                            Fiscal_Year>2011 & !is.na(IsFMS)&
                                                                  SimpleArea=="Services"),#IsFMS==TRUE                             
                                            chart_geom="Bar Chart",
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB24_GDP22",
                            color_var="CrisisProductOrServiceArea",
                            facet_var="IsFMSplaceIntl",
                            second_var="VendorSize_Intl",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( IsFMSplaceIntl~VendorSize_Intl , scales="free_y", space="free_y")+labs(title="Services FMS or Performed Internationally")+
    theme(  strip.text.y=element_text(angle=0))
  )


write.csv(file="..//Output//fmsintl_service_vendor.csv",row.names = FALSE,na = "",
          fmsintl_service_vendor$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(IsFMSplaceIntl,VendorSize_Intl,CrisisProductOrServiceArea),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22)%>% arrange(IsFMSplaceIntl,VendorSize_Intl,CrisisProductOrServiceArea))

ggsave600dpi(fmsintl_service_vendor,file="../output/fmsintl_service_vendor.png",
             size = 12, lineheight=1, height =6, width=9)

```

#### NTIB
```{r FPDS_vendor_Intl}
ntibisoalpha3<-c("AUS","CAN","GBR")#"NZL",
platpscintldef$VendorNTIB<-"All Other"
platpscintldef$VendorNTIB[platpscintldef$VendorISOalpha3=="USA"]<-"United States"
platpscintldef$VendorNTIB[platpscintldef$VendorISOalpha3=="AUS"]<-"Australia"
platpscintldef$VendorNTIB[platpscintldef$VendorISOalpha3=="NZL"]<-"New Zealand"
platpscintldef$VendorNTIB[platpscintldef$VendorISOalpha3=="CAN"]<-"Canada"
platpscintldef$VendorNTIB[platpscintldef$VendorISOalpha3=="GBR"]<-"United Kingdom"


summary(factor(platpscintldef$VendorNTIB))
# undebug(format_data_for_plot)

summary(platpscintldef$dFYear)

(ntibintl <-  build_plot(data=platpscintldef%>% filter((#PlaceISOalpha3 %in% ntibisoalpha3|
                                                                  VendorISOalpha3 %in% ntibisoalpha3)&!is.na(PlaceIsForeign) &
                                                                            Fiscal_Year>2011 & !is.na(VendorISOalpha3)),#VendorISOalpha3==TRUE                             
                                            chart_geom="Bar Chart",
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB24_GDP22",
                            color_var="CrisisProductOrServiceArea",
                            facet_var="VendorNTIB",
                            second_var="PlaceIsForeign",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( VendorNTIB~. )+labs(title="Present NTIB Vendor",
                                    y="Action Obligation (Constant 2022 $s")#, scales="free_y"#, scales="free_y"
  )+scale_x_date("Fiscal Year",labels = date_format("'%y"))

write.csv(file="..//Output//ntibintl_contract.csv",row.names = FALSE,na = "",
          ntibintl$data%>%# mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlaceIsForeign,VendorNTIB,CrisisProductOrServiceArea),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22)%>% arrange(PlaceIsForeign,VendorNTIB,CrisisProductOrServiceArea))

ggsave600dpi(ntibintl,file="../output/ntibintl.png",
             size = 12, lineheight=1, height =5.5, width=12)


# (ntibintl_vendor <-  build_plot(data=platpscintldef%>% filter((PlaceISOalpha3 %in% ntibisoalpha3|VendorISOalpha3 %in% ntibisoalpha3)&!is.na(PlaceIsForeign) &
#                                                                             Fiscal_Year>2011 & !is.na(VendorISOalpha3)),#VendorISOalpha3==TRUE                             
#                                             chart_geom="Bar Chart",
#                             x_var="dFYear",
#                             y_var="Action_Obligation_OMB24_GDP22",
#                             color_var="CrisisProductOrServiceArea",
#                             facet_var="PlaceIsForeign",
#                             second_var="VendorSize_Intl",
#                             labels_and_colors=intl_lc,
#                             column_key=intl_ck,
#                             legend=TRUE,
#                             caption=FALSE,
#                             format=TRUE)+theme(legend.position = "right")+
#     facet_grid( PlaceIsForeign~VendorSize_Intl , scales="free_y", space="free_y")+labs(title="Vendor or Performed Internationally")+
#     theme(  strip.text.y=element_text(angle=0))
#   )
# 
# write.csv(file="..//Output//ntibintl_vendor.csv",row.names = FALSE,na = "",
#           ntibintl_vendor$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
#             pivot_wider(id_cols=c(VendorNTIB,VendorSize_Intl,CrisisProductOrServiceArea),
#                         names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22)%>% arrange(VendorNTIB,VendorSize_Intl,CrisisProductOrServiceArea))

# ggsave600dpi(ntibintl_vendor,file="../output/ntibintl_vendor.png",
#              size = 12, lineheight=1, height =6, width=9)

```


###FMS identification
```{r contract_identification}



# undebug(build_plot)

(contract_identification <-  build_plot(data=platpscintldef %>% filter(ContractingCustomer=="Defense"),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB24_GDP22",
                            color_var="foreign_funding_description",
                            facet_var="IsFMS",
                            # second_var="StateRegion",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Constant 2020 $ Obligated",
       caption="Source: FPDS; CSIS analysis.")+
    guides(fill=guide_legend(ncol=3)))

ggsave600dpi(contract_identification,file="../output/figure_03_contract_identification.png",size=12,lineheight=1, height =5, width=9)



```
#### Service Category
```{r FPDS_vendor_Intl}

summary(factor(platpscintldef$SimpleArea))
# undebug(format_data_for_plot)
(fmsintl_service <-  build_plot(data=platpscintldef%>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign) &
                                                                            Fiscal_Year>2011 & !is.na(IsFMS)&
                                                                  SimpleArea=="Services"),#IsFMS==TRUE                             
                                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB24_GDP22",
                            color_var="CrisisProductOrServiceArea",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )+labs(title="Services FMS or Performed Internationally")#, scales="free_y"#, scales="free_y"
  )
summary(platpscintldef$dFYear)

write.csv(file="..//Output//fmsintl_service.csv",row.names = FALSE,na = "",
          fmsintl_service$data%>%# mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlaceIsForeign,IsFMS,CrisisProductOrServiceArea),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22)%>% arrange(PlaceIsForeign,IsFMS,CrisisProductOrServiceArea))

ggsave600dpi(fmsintl_service,file="../output/fmsintl_service.png",
             size = 12, lineheight=1, height =6, width=9)


(fmsintl_service_vendor <-  build_plot(data=platpscintldef%>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign) &
                                                                            Fiscal_Year>2011 & !is.na(IsFMS)&
                                                                  SimpleArea=="Services"),#IsFMS==TRUE                             
                                            chart_geom="Bar Chart",
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB24_GDP22",
                            color_var="CrisisProductOrServiceArea",
                            facet_var="IsFMSplaceIntl",
                            second_var="VendorSize_Intl",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( IsFMSplaceIntl~VendorSize_Intl , scales="free_y", space="free_y")+labs(title="Services FMS or Performed Internationally")+
    theme(  strip.text.y=element_text(angle=0))
  )


write.csv(file="..//Output//fmsintl_service_vendor.csv",row.names = FALSE,na = "",
          fmsintl_service_vendor$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(IsFMSplaceIntl,VendorSize_Intl,CrisisProductOrServiceArea),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22)%>% arrange(IsFMSplaceIntl,VendorSize_Intl,CrisisProductOrServiceArea))

ggsave600dpi(fmsintl_service_vendor,file="../output/fmsintl_service_vendor.png",
             size = 12, lineheight=1, height =6, width=9)

```
### JSF International
```{r FPDS_JSF}

summary(factor(platpscintldef$Shiny.VendorSize[platpscintldef$VendorIsForeign==1]))
summary(platpscintldef$VendorSize_Intl)

# undebug(format_data_for_plot)
(jsf_vendor_intl_place <-  build_plot(data=platpscintldef %>% filter(IsJSF=="JSF (F-35)"& Fiscal_Year>2011),
                                       #IsFMS==TRUE 
                                       chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB24_GDP22",
                            color_var="VendorSize_Intl",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )#, scales="free_y"
  )


write.csv(file="..//Output//jsf_vendor_intl_place.csv",row.names = FALSE,na = "",
          jsf_vendor_intl_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(VendorSize_Intl,IsFMS, PlaceIsForeign),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22)%>% arrange(PlaceIsForeign,IsFMS,VendorSize_Intl))

ggsave600dpi(jsf_vendor_intl_place,file="../output/jsf_vendor_intl_place.png",
             size = 12, lineheight=1, height =4.5, width=9)


# platpscintldef$Shiny.VendorSize
# undebug(format_data_for_plot)
(jsf_manufacture_intl_place <-  build_plot(data=platpscintldef%>% filter(IsJSF=="JSF (F-35)"& Fiscal_Year>2011),              
                                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB24_GDP22",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )#, scales="free_y"
  )


write.csv(file="..//Output//jsf_manufacture_intl_place.csv",row.names = FALSE,na = "",
          jsf_manufacture_intl_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlaceIsForeign,IsFMS, PlaceOfManufacture_Sum),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22)%>% arrange(PlaceIsForeign,IsFMS,PlaceOfManufacture_Sum))

ggsave600dpi(jsf_manufacture_intl_place,file="../output/jsf_manufacture_intl_place.png",
             size = 12, lineheight=1, height =4.5, width=9)

platpscintldef$OriginISOalpha3
(jsf_manufacture_intl_place <-  build_plot(data=platpscintldef%>% filter(IsJSF=="JSF (F-35)"& Fiscal_Year>2011),              
                                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB24_GDP22",
                            color_var="OriginISOalpha3",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            # labels_and_colors=intl_lc,
                            # column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )#, scales="free_y"
  )



```


  ### FMS Vendor Size/Intl and Place
```{r FPDS_vendor_Intl}

summary(factor(platpscintldef$Shiny.VendorSize[platpscintldef$VendorIsForeign==1]))
summary(platpscintldef$VendorSize_Intl)

# undebug(format_data_for_plot)
(fpds_vendor_intl_place <-  build_plot(data=platpscintldef %>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign)&
                                                                      !is.na(IsFMS)& Fiscal_Year>2011),
                                       #IsFMS==TRUE 
                                       chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB24_GDP22",
                            color_var="VendorSize_Intl",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )+labs(title="FMS or Performed Internationally, Including JSF")#, scales="free_y"
  )


write.csv(file="..//Output//FMS_vendorplaceintl_all.csv",row.names = FALSE,na = "",
          fpds_vendor_intl_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(VendorSize_Intl,IsFMS, PlaceIsForeign),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22)%>% arrange(PlaceIsForeign,IsFMS,VendorSize_Intl))

ggsave600dpi(fpds_vendor_intl_place,file="../output/FMS_vendorplaceintl_all.png",
             size = 12, lineheight=1, height =4.5, width=9)


# platpscintldef$Shiny.VendorSize
(fpds_vendor_place <-  build_plot(data=platpscintldef %>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign)&
                                                                      !is.na(IsFMS)&Fiscal_Year>2011 ),#IsFMS==TRUE  
                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB24_GDP22",
                            color_var="Shiny.VendorSize",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )+labs(title="FMS or Performed Internationally, Including JSF")#, scales="free_y"#, scales="free_y"
  )

ggsave600dpi(fpds_vendor_place,file="../output/FMS_vendorplace_all.png",
             size = 12, lineheight=1, height =4.5, width=9)


write.csv(file="..//Output//FMS_vendorplace_all.csv",row.names = FALSE,na = "",
          fpds_vendor_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(Shiny.VendorSize,PlaceIsForeign,IsFMS),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22)%>% arrange(PlaceIsForeign,Shiny.VendorSize,IsFMS))


```

### FMS Vendor Size/Intl and Place No JSF
```{r FPDS_vendor_Intl}

summary(factor(platpscintldef$Shiny.VendorSize[platpscintldef$VendorIsForeign==1]))
summary(platpscintldef$VendorSize_Intl)

# undebug(format_data_for_plot)
(fpds_vendor_intl_place_noJSF <-  build_plot(data=platpscintldef %>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign)&
                                                                      !is.na(IsFMS)& Fiscal_Year>2011&
                                                                            IsJSF %in% c("Other Project","Unknown Project")),
                                       #IsFMS==TRUE 
                                       chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB24_GDP22",
                            color_var="VendorSize_Intl",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )+labs(title="FMS or Performed Internationally, No JSF")#, scales="free_y"
  )


write.csv(file="..//Output//FMS_vendorplaceintl_noJSF.csv",row.names = FALSE,na = "",
          fpds_vendor_intl_place_noJSF$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(VendorSize_Intl,IsFMS, PlaceIsForeign),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22)%>% arrange(PlaceIsForeign,IsFMS,VendorSize_Intl))

ggsave600dpi(fpds_vendor_intl_place_noJSF,file="../output/FMS_vendorplaceintl_noJSF.png",
             size = 12, lineheight=1, height =4.5, width=9)


# platpscintldef$Shiny.VendorSize
(fpds_vendor_place_noJSF <-  build_plot(data=platpscintldef %>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign)&
                                                                      !is.na(IsFMS)&Fiscal_Year>2011&
                                                                            IsJSF %in% c("Other Project","Unknown Project") ),#IsFMS==TRUE  
                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB24_GDP22",
                            color_var="Shiny.VendorSize",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )+labs(title="FMS or Performed Internationally, No JSF")#, scales="free_y"#, scales="free_y"
  )

ggsave600dpi(fpds_vendor_place_noJSF,file="../output/FMS_vendorplace_noJSF.png",
             size = 12, lineheight=1, height =4.5, width=9)


write.csv(file="..//Output//FMS_vendorplace_noJSF.csv",row.names = FALSE,na = "",
          fpds_vendor_place_noJSF$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(Shiny.VendorSize,PlaceIsForeign,IsFMS),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22)%>% arrange(PlaceIsForeign,Shiny.VendorSize,IsFMS))


```

### JSF FMS Vendor Size/Intl and Place
```{r FPDS_vendor_Intl}

summary(factor(platpscintldef$Shiny.VendorSize[platpscintldef$VendorIsForeign==1]))
summary(platpscintldef$VendorSize_Intl)

# undebug(format_data_for_plot)
(fpds_vendor_intl_place <-  build_plot(data=platpscintldef %>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign)&
                                                                      !is.na(IsFMS)& Fiscal_Year>2011),
                                       #IsFMS==TRUE 
                                       chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB24_GDP22",
                            color_var="VendorSize_Intl",
                            facet_var="IsJSF",
                            second_var="IsFMSplaceIntl",
                            # labels_and_colors=intl_lc,
                            # column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid(IsFMSplaceIntl~IsJSF, scales="free_y", space="free_y")
  )


write.csv(file="..//Output//FMS_vendorplaceintl.csv",row.names = FALSE,na = "",
          fpds_vendor_intl_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(VendorSize_Intl,IsFMS, PlaceIsForeign),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22)%>% arrange(PlaceIsForeign,IsFMS,VendorSize_Intl))

ggsave600dpi(fpds_vendor_intl_place,file="../output/FMS_vendorplaceintl.png",
             size = 12, lineheight=1, height =4.5, width=9)


# platpscintldef$Shiny.VendorSize
(fpds_vendor_place <-  build_plot(data=platpscintldef %>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign)&
                                                                      !is.na(IsFMS)&Fiscal_Year>2011 ),#IsFMS==TRUE  
                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB24_GDP22",
                            color_var="Shiny.VendorSize",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )#, scales="free_y"
  )

ggsave600dpi(fpds_vendor_place,file="../output/FMS_vendorplace.png",
             size = 12, lineheight=1, height =4.5, width=9)


write.csv(file="..//Output//FMS_vendorplace.csv",row.names = FALSE,na = "",
          fpds_vendor_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(Shiny.VendorSize,PlaceIsForeign,IsFMS),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22)%>% arrange(PlaceIsForeign,Shiny.VendorSize,IsFMS))


```



#### Place
```{r FPDS_vendor_Intl}


# undebug(format_data_for_plot)
(fpds_manufacture_intl_place <-  build_plot(data=platpscintldef%>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign) &
                                                                            Fiscal_Year>2011 & !is.na(IsFMS)),#IsFMS==TRUE                             
                                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB24_GDP22",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )+labs(title="FMS or Performed Internationally, Including JSF")#, scales="free_y"#, scales="free_y"
  )


write.csv(file="..//Output//FMS_BAAplaceintl_all.csv",row.names = FALSE,na = "",
          fpds_manufacture_intl_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlaceIsForeign,IsFMS, PlaceOfManufacture_Sum),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22)%>% arrange(PlaceIsForeign,IsFMS,PlaceOfManufacture_Sum))

ggsave600dpi(fpds_manufacture_intl_place,file="../output/FMS_BAAplaceintl_all.png",
             size = 12, lineheight=1, height =4.5, width=9)

```


#### Place No JSF
```{r FPDS_vendor_Intl}

summary(factor(platpscintldef$IsJSF))
# undebug(format_data_for_plot)
(fpds_manufacture_intl_place_noJSF <-  build_plot(data=platpscintldef%>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign) &
                                                                            Fiscal_Year>2011 & !is.na(IsFMS)&
                                                                            IsJSF %in% c("Other Project","Unknown Project")),#IsFMS==TRUE                             
                                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB24_GDP22",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )+labs(title="FMS or Performed Internationally, No JSF")#, scales="free_y"#, scales="free_y"
  )


write.csv(file="..//Output//FMS_BAAplaceintl_noJSF.csv",row.names = FALSE,na = "",
          fpds_manufacture_intl_place_noJSF$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlaceIsForeign,IsFMS, PlaceOfManufacture_Sum),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22)%>% arrange(PlaceIsForeign,IsFMS,PlaceOfManufacture_Sum))

ggsave600dpi(fpds_manufacture_intl_place_noJSF,file="../output/FMS_BAAplaceintl_noJSF.png",
             size = 12, lineheight=1, height =4.5, width=9)

```

#### JSF Place
```{r FPDS_vendor_Intl}


# undebug(format_data_for_plot)
(fpds_manufacture_intl_place <-  build_plot(data=platpscintldef%>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign) &
                                                                            Fiscal_Year>2011 & !is.na(IsFMS)),#IsFMS==TRUE                             
                                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB24_GDP22",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="IsFMSplaceIntl",
                            second_var="IsJSF",
                            # labels_and_colors=intl_lc,
                            # column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")#+
    # facet_grid( IsJSF+PlaceIsForeign )#, scales="free_y"
  )


write.csv(file="..//Output//FMS_BAAplaceintl.csv",row.names = FALSE,na = "",
          fpds_manufacture_intl_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlaceIsForeign,IsFMS, PlaceOfManufacture_Sum),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22)%>% arrange(PlaceIsForeign,IsFMS,PlaceOfManufacture_Sum))
```




#### Service Category
```{r FPDS_vendor_Intl}

summary(factor(platpscintldef$SimpleArea))
# undebug(format_data_for_plot)
(fmsintl_service <-  build_plot(data=platpscintldef%>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign) &
                                                                            Fiscal_Year>2011 & !is.na(IsFMS)&
                                                                  SimpleArea=="Services"),#IsFMS==TRUE                             
                                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB24_GDP22",
                            color_var="CrisisProductOrServiceArea",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )+labs(title="Services FMS or Performed Internationally")#, scales="free_y"#, scales="free_y"
  )
summary(platpscintldef$dFYear)

write.csv(file="..//Output//fmsintl_service.csv",row.names = FALSE,na = "",
          fmsintl_service$data%>%# mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlaceIsForeign,IsFMS,CrisisProductOrServiceArea),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22)%>% arrange(PlaceIsForeign,IsFMS,CrisisProductOrServiceArea))

ggsave600dpi(fmsintl_service,file="../output/fmsintl_service.png",
             size = 12, lineheight=1, height =6, width=9)


(fmsintl_service_vendor <-  build_plot(data=platpscintldef%>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign) &
                                                                            Fiscal_Year>2011 & !is.na(IsFMS)&
                                                                  SimpleArea=="Services"),#IsFMS==TRUE                             
                                            chart_geom="Bar Chart",
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB24_GDP22",
                            color_var="CrisisProductOrServiceArea",
                            facet_var="IsFMSplaceIntl",
                            second_var="VendorSize_Intl",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( IsFMSplaceIntl~VendorSize_Intl , scales="free_y", space="free_y")+labs(title="Services FMS or Performed Internationally")+
    theme(  strip.text.y=element_text(angle=0))
  )


write.csv(file="..//Output//fmsintl_service_vendor.csv",row.names = FALSE,na = "",
          fmsintl_service_vendor$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(IsFMSplaceIntl,VendorSize_Intl,CrisisProductOrServiceArea),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22)%>% arrange(IsFMSplaceIntl,VendorSize_Intl,CrisisProductOrServiceArea))

ggsave600dpi(fmsintl_service_vendor,file="../output/fmsintl_service_vendor.png",
             size = 12, lineheight=1, height =6, width=9)

```


## HIMARS

```{r}

(
HimarsPSR<-build_plot(
  data=platpscintldef %>% filter(Project.Name=='MLRS'),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)")
)

ggsave600dpi("..//Output//Deep_Dives//Himars//Himars_psr.png", HimarsPSR, 
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )

ggsave600dpi("..//Output//Deep_Dives//Himars//Himars_psr.emf", HimarsPSR, 
             width=6.5, height= 3, units="in",size=11, lineheight=1.2
             )

output_TY<-platpscintldef %>% group_by(Shiny.VendorSize,Fiscal_Year,Project.Name)%>% filter(Project.Name=='MLRS') %>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
  arrange(Fiscal_Year) %>%
          pivot_wider(id_cols=c(Project.Name,Shiny.VendorSize),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)
write.csv(file="..//Output//Deep_Dives//Himars//Himars_psr.csv",row.names = FALSE, na = "",
          output_TY)



# wb <- loadWorkbook("..//Output//DoD_Acq_Trends_Contracts.xlsx", create = TRUE)
# addWorksheet(wb, name = "Area")
#  writeData(wb, output_TY, sheet = "Area", startRow = 14, startCol = 14)
# saveWorkbook(wb)


```

