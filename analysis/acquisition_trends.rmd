---
title: "Defense Acquisition Trends"
output:
  html_document:
    keep_md: yes
    toc: yes
date: "Wednesday, October 6, 2021"
---

# Setup
First we load the data. The dataset used is a U.S. DOD Contracting dataset derived from FPDS.

```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(scales)
library(svglite)
library(readxl)
library(openxlsx)


axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

local_path<-get_local_lookup_path()

main.text.size<-1
note.text.size<-1.40
if(!exists("def_data"))
  load(file="FPDS_chart_maker/unaggregated_def.Rda")


# if(!"Action_Obligation_OMB25_GDP23" %in% colnames(def_data))
#   def_data<-deflate(def_data, "Action_Obligation_Then_Year",deflator_var="OMB25_GDP23",path="offline")
# colnames(def_data)[colnames(def_data)=="Action_Obligation_Then_Year_Then_Year"]<-"Action_Obligation_Then_Year"




if(!exists("ota_def")|!exists("def_kota"))
  load(file="../data/clean/Defense_OTA.Rda")


# if(!"Action_Obligation_OMB25_GDP23" %in% colnames(ota_def))
#   ota_def<-deflate(ota_def, "Action_Obligation_Then_Year",deflator_var="OMB25_GDP23")
# colnames(ota_def)[colnames(ota_def)=="Action_Obligation_Then_Year_Then_Year"]<-"Action_Obligation_Then_Year"




#Manual import Greenbook data
toa<-readxl::read_excel(path=file.path("..","data_raw","FY24 6-1_DoD TOA by Title.xlsx"),skip=4)
request<-readxl::read_excel(path=file.path("..","data_raw","FY24 1-1.xlsx"),skip=3)
toa<-toa[sapply(toa[,2],function(x) substr(x,start=1,stop=21))==
            "Total Current Dollars" & !is.na(toa[,2]),c(-1,-3)]
colnames(toa)<-gsub("FY ","",colnames(toa))
colnames(toa)<-gsub("\r\nEnacted","",colnames(toa))
colnames(toa)[colnames(toa)=="...2"]<-"Series"
toa<-pivot_longer(toa,  cols=-Series, names_to="Fiscal_Year", values_to="Total_Obligation_Authority")
toa$Total_Obligation_Authority<-toa$Total_Obligation_Authority*1000000
# debug(deflate)
toa<-deflate(toa,money_var = "Total_Obligation_Authority",deflator_var="OMB25_GDP23",path="offline")
toa$dFYear<-as.Date(paste(toa$Fiscal_Year,1,1,sep="-"))

#Manual import Public Budget Data
outlay<-readxl::read_excel(path=file.path("..","data_raw","hist03z2_fy2025.xlsx"),skip=2,
                           na = c("...........","..........","N/A"))
# outlay<-outlay[sapply(outlay[,2],function(x) substr(x,start=1,stop=21))==
#             "Total Current Dollars" & !is.na(outlay[,2]),c(-1,-3)]

colnames(outlay)<-gsub(" estimate","",colnames(outlay))
# View(outlay %>% filter(!is.na(outlay$`1962`)&is.na(text_to_number(outlay$`1962`))))
colnames(outlay)[colnames(outlay)=="Function and Subfunction"]<-"Series"
outlay<- outlay %>% filter(Series %in% c("051 Subtotal, Department of Defense-Military"))
#Could later add RDT&E, Procurement, and O&M to PSR
outlay<-pivot_longer(outlay,  cols=-Series, names_to="Fiscal_Year", values_to="Outlays")
if(nrow(outlay %>% filter(!is.na(outlay$Outlays)&is.na(text_to_number(outlay$Outlays))))>0)
   stop("Probably an NA value to remove")
outlay$Outlays<-text_to_number(outlay$Outlays)
outlay$Outlays<-outlay$Outlays*1000000
# debug(deflate)
outlay<-deflate(outlay,money_var = "Outlays",deflator_var="OMB25_GDP23",path="offline")
outlay$dFYear<-as.Date(paste(outlay$Fiscal_Year,1,1,sep="-"))



online_path<-file.path(get_local_sharepoint_path("DIIG Teamsite - Shared Documents"),"2024 - Acquisition Trends","Data and Figures")

max(def_data$Fiscal_YQ)
max(def_data$Fiscal_YQ)


load(file="../data/clean/Defense_OTA.Rda")
```

# Topline

## Topline Quarterly
```{r toplineq}




(toplineq<-build_plot(data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<=2024.1),#rbind(quarterly,q2021,e2021),
                     chart_geom="Bar Chart",
                     x_var="dFYear",alpha_var="YTD",
                     y_var="Action_Obligation_OMB25_GDP23",
           color_var="fiscal_quarter_YTD",
           format = TRUE,
           labels_and_colors = def_lc,
           column_key=def_ck
       )+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nOct–Nov")
       theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi(toplineq,file=file.path("..","Output","AcqTrends","toplineq.svg"),  
             width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
             )

ggsave600dpi(toplineq,file=file.path("..","Output","AcqTrends","toplineq.png"),  
             width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",
             filename="toplineqr_keynote.svg", toplineq+
               labs(title="DOD Contract Obligations, 2000–2024 Oct-Nov"),
             width=13, height= 5.5, units="in", size=20, lineheight = 0.75
             )

log_plot(plot=toplineq, df=def_data   %>% filter(Fiscal_YQ<=2025.2),
                     filename="acq_fig2_2_fq",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="2-2 FYQ",path="../output/AcqTrends/", height=3.25,
                     startRow=1,startCol=12,format=TRUE,#var_list=c("Source","fiscal_quarter_YTD")
         )

```

### Quarterly Plat Breakout
```{r QuartPlatBreakout} 
platform_levels<-levels(factor(def_data$PlatformPortfolio))
for(p in platform_levels){
  file_p<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",p)))
  (Breakout<-build_plot(
    data=def_data %>% filter(Fiscal_Year>=2000&Fiscal_YQ<=2025.2&PlatformPortfolio==p),
                     chart_geom="Bar Chart",
                     x_var="dFYear",alpha_var="YTD",
                     y_var="Action_Obligation_OMB25_GDP23",
           color_var="fiscal_quarter_YTD",
           format = TRUE,
           labels_and_colors = def_lc,
           column_key=def_ck
       )+
      date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nOct–Nov")   theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",title=p)
)
  
  if(!dir.exists(file.path("../output/AcqTrends/Platform",file_p)))
    dir.create(file.path("../output/AcqTrends/Platform",file_p))
  undebug(log_plot)
  log_plot(plot=Breakout, df=def_data  %>% filter(Fiscal_YQ<=2025.2&PlatformPortfolio==p),
           filename=paste(file_p,"FYQ",sep="_"),xlsx=paste("DoD",file_p,"Contracts.xlsx",sep="_"),
           sheet="FYQ",path=file.path("../output/AcqTrends/Platform/",file_p), height=3.5,
           startRow=1,startCol=13,format=TRUE,var_list=c("Vehicle.AwardTask","Vehicle.sum7"),
           output_doc_png=TRUE,excel_y_var=TRUE
           )
  
}
```
### Quarterly Cust Breakout
```{r QuartCustBreakout} 
subcustomer_levels<-levels(factor(def_data$SubCustomer.sum))
for(c in subcustomer_levels){
  file_c<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",c)))
  (Breakout<-build_plot(
    data=def_data %>% filter(Fiscal_Year>=2000&SubCustomer.sum==c& Fiscal_YQ<=2025.2),
                    chart_geom="Bar Chart",
                     x_var="dFYear",alpha_var="YTD",
                     y_var="Action_Obligation_OMB25_GDP23",
           color_var="fiscal_quarter_YTD",
           format = TRUE,
           labels_and_colors = def_lc,
           column_key=def_ck
       )+
      date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nOct–Nov")   theme(legend.position = "right")+
     labs(y="Obligations (Constant 2023 $s)",title=c))
  
  if(!dir.exists(file.path("../output/AcqTrends/Customer",file_c)))
    dir.create(file.path("../output/AcqTrends/Customer",file_c))
  
  log_plot(plot=Breakout, df=def_data  %>% filter(Fiscal_YQ<=2025.2&SubCustomer.sum==c),
           filename=paste(file_c,"FYQ",sep="_"),xlsx=paste(file_c,"Contracts.xlsx",sep="_"),
           sheet="FYQ",path=file.path("../output/AcqTrends/Customer/",file_c), height=3.5,
           startRow=1,startCol=13,format=TRUE,var_list=c("Vehicle.AwardTask","Vehicle.sum7"),
           output_doc_png=TRUE,excel_y_var=TRUE
           )
  
}
```


## Topline Competition
```{r ToplineComp}
def_data %>% group_by(Fiscal_Year) %>% summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))
def_data %>% filter(Fiscal_Year==2021) %>% group_by(Competition.sum) %>% summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))

(
ToplineCompMulti<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=1991&Fiscal_YQ<=2025.2),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # 
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Obligations (Constant 2023 $s)")+
    date_x_year_breaks(1992,2022, by=2)#,partial_year=2024,partial_label="\nOct–Nov")
)

(
ToplineComp<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=1997&Fiscal_YQ<=2025.2),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.sum", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # 
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Obligations (Constant 2023 $s)")+
    date_x_year_breaks(1998,2022,2)#)#,partial_year=2024,partial_label="\nOct–Nov")
)



(
ToplineCompLine<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=1997&Fiscal_YQ<=2025.2),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.sum", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Obligations (Constant 2023 $s)")+
    date_x_year_breaks(1998,2022, by=2)
)

def_data %>% filter(Competition.sum =="Unlabeled" & Fiscal_Year>=2019) %>% group_by(CompetitionClassification)%>%
  summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_comp.png", ToplineComp,  
             width=11, height= 5.5, units="in",size=14, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_comp.emf", ToplineComp+theme(legend.position = "right"),  
             width=6.5, height= 3, units="in",size=11, lineheight=1.2
             )


ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_comp_multi.png", ToplineCompMulti,  
             width=11, height= 5.5, units="in",size=14, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_comp_multi.svg", ToplineCompMulti,  
             width=6.5, height= 4, units="in",size=12, lineheight=1.2
             )



ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_comp_multi.emf", ToplineCompMulti+theme(legend.position = "right"),  
             width=6.5, height= 3, units="in",size=11, lineheight=1.2
             )


ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_comp_square.png", ToplineComp,  
             width=6, height= 5, units="in",size=14, lineheight=1.2
             )


log_plot(plot=ToplineComp, df=def_data %>% filter(Fiscal_YQ<=2025.2),
                     filename="acq_fig6_5_competition",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="6-5 Comp",path="../output/AcqTrends/", height=3.5,
                     startRow=1,startCol=12,format=TRUE, excel_formulas = TRUE, excel_share = TRUE,
         include_YTD=FALSE,second_path = online_path#,var_list=c("Vehicle.AwardTask","Vehicle.sum7"),z
         )
```



### Missing Competition
```{r UnlabeledComp}

(
UnlabeledComp<-build_plot(
  data=def_data %>% filter(Competition.sum =="Unlabeled"),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="CompetitionClassification", #color_var
  facet_var="Vehicle.sum7", #facet_var
  # column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

def_data %>% filter(Competition.sum =="Unlabeled" & Fiscal_Year>=2019) %>% group_by(CompetitionClassification)%>%
  summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))

ggsave600dpi(path="..//Output//AcqTrends//",filename="unlabeled_comp.png", UnlabeledComp,  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )



write.csv(file="..//Output//AcqTrends//unlabeled_competition.csv",row.names = FALSE, na = "",
          UnlabeledComp$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(CompetitionClassification,Vehicle.sum7),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)
          %>% arrange(CompetitionClassification,Vehicle.sum7))



```





## MultiYear Setup
```{r MultiyearSetup}
    def_data<-def_data%>% mutate(multiyearcontracttext=factor(multiyearcontract,levels=c("0","1"),
                              labels=c("Not Multi-Year","Multi-Year Contract")))

def_data$multiyearcontracttext[is.na(def_data$multiyearcontract)&
                             def_data$Vehicle %in% c("BOA","BPA","FSS","GWAC","PO","DO") ]<-"Not Multi-Year"
  # "MULTIPLE AWARD IDC"  "SINGLE AWARD IDC"   "Unlabeled IDC"        "DCA"    "DO"   


# def_data %>% group_by(Vehicle) %>%
#   dplyr::summarise(multiyearcontracttext=sum(
#     ifelse(multiyearcontracttext=="Multi-Year Contract",Action_Obligation_OMB25_GDP23,0),na.rm=TRUE))



def_data<-def_data %>% group_by(Fiscal_Year,Vehicle.sum7)%>%
  mutate(pPlatFYear=Action_Obligation_OMB25_GDP23/sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))
```

### Topline Multi-Year
```{r Multi-Year}
def_data<-def_data%>% mutate(multiyearcontracttext=factor(multiyearcontract,levels=c("0","1"),
                              labels=c("Not Multi-Year","Multi-Year Contract")))


(
MultiYear<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<=2025.2),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="multiyearcontract", #color_var
  # facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")+
  date_x_year_breaks(2000,2022,2)#)#,partial_year=2024,partial_label="\nOct–Nov")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_Multiyear.png", MultiYear, 
             width=11, height= 5.5, units="in",size=14,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_Multiyear.svg", MultiYear+
  labs(y="Obligations\n(Constant 2023 $s)"),#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 2.25, units="in",size=11,lineheight = 1.2
             )


# def_data %>% filter(SubCustomer.sum=="Army", PlatformPortfolio=="Other Products", Fiscal_Year==2021) %>%
#   group_by(AnyMultiyearText,Competition.multisum) %>% summarise(
#     COVID19obligated=sum(COVID19obligated,na.rm=TRUE),
#     Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
#     Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year),
#     
#   )

```




## Topline Vehicle
```{r ToplineVehicle}


def_data %>% filter(Vehicle=="Unlabeled Indefinite Delivery Contract (IDC)" ) %>% group_by(ClassifyNumberOfOffers,No.Competition.sum)%>%
  summarise(n=length(Vehicle))


(
ToplineVehicle7<-build_plot(
  data=def_data %>% filter(!is.na(Vehicle.AwardTask)),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Vehicle.sum7", #color_var
  facet_var="Vehicle.AwardTask", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",
       caption="Note: Unlabeled not shown. Source: FPDS and CSIS analysis.")
)


(
ToplineVehicle<-build_plot(
  data=def_data %>% filter(!is.na(Vehicle.AwardTask)),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Vehicle.sum", #color_var
  facet_var="Vehicle.AwardTask", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",
       caption="Note: Unlabeled not shown. Source: FPDS and CSIS analysis.")
)


ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_vehicle7.png", ToplineVehicle7, 
             width=13, height= 4.5, units="in",size=11
             )

write.csv(file="..//Output//AcqTrends//topline_vehicle7.csv",row.names = FALSE, na = "",
          ToplineVehicle7$data%>% 
            mutate(Fiscal_Year=lubridate::year(dFYear),
                   bAction_Obligation_OMB25_GDP23=Action_Obligation_OMB25_GDP23/1000000000)%>%
            pivot_wider(id_cols=c(Vehicle.sum7,Vehicle.AwardTask),
                        names_from=Fiscal_Year,values_from=bAction_Obligation_OMB25_GDP23)%>%
            arrange(Vehicle.sum7,Vehicle.AwardTask))


ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_vehicle.png", ToplineVehicle, 
             width=13, height= 4.5, units="in",size=11
             )

write.csv(file="..//Output//AcqTrends//topline_vehicle.csv",row.names = FALSE, na = "",
          ToplineVehicle$data%>% mutate(Fiscal_Year=lubridate::year(dFYear),
                                       bAction_Obligation_OMB25_GDP23=Action_Obligation_OMB25_GDP23/1000000000)%>%
            pivot_wider(id_cols=c(Vehicle.sum,Vehicle.AwardTask),
                        names_from=Fiscal_Year,values_from=bAction_Obligation_OMB25_GDP23)%>%
            arrange(Vehicle.sum,Vehicle.AwardTask))

log_plot(plot=ToplineVehicle7, df=def_data %>% filter(Fiscal_YQ<=2025.2),
                     filename="acq_fig4_X_vehicle",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="4-X Veh",path="../output/AcqTrends/", height=4,
                     startRow=1,startCol=14,format=TRUE,
         var_list=c("Vehicle.AwardTask","Vehicle.sum7"))

```

### Vehicle Transactions
```{r ToplineVehicleTrans}


def_data %>% filter(Vehicle=="Unlabeled Indefinite Delivery Contract (IDC)" ) %>% group_by(ClassifyNumberOfOffers,No.Competition.sum)%>%
  summarise(n=length(Vehicle))


(
ToplineVehicle7<-build_plot(
  data=def_data %>% filter(!is.na(Vehicle.AwardTask)&Fiscal_YQ<=2025.2),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="transactioncount", #VAR.y.variable
  color_var="Vehicle.sum7", #color_var
  facet_var="Vehicle.AwardTask", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="umber of Transaction",
       caption="Note: Unlabeled not shown. Source: FPDS and CSIS analysis.")
)


(
SingleAward<-build_plot(
  data=def_data %>% filter(!is.na(Vehicle.AwardTask)&Fiscal_YQ<=2025.2&
                             Vehicle.sum7=="Single-Awd." & SubCustomer.JPO=="DLA"&
                             SimpleArea=="Products (All)"&
                             ProductServiceOrRnDarea %in% 
                             c("Clothing & Subsistence" ,"Fuels","Other")
                             ),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="transactioncount", #VAR.y.variable
  color_var="ProductServiceOrRnDarea", #color_var
  facet_var="ProductServiceOrRnDarea", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Number of Transactions",
       caption="Note: Unlabeled not shown. Source: FPDS and CSIS analysis.")
)
ggsave600dpi(path="..//Output//AcqTrends//",filename="dla_select_singleaward_transactions.png", SingleAward, 
             width=13, height= 4.5, units="in",size=11
             )



(
ToplineVehicle<-build_plot(
  data=def_data %>% filter(!is.na(Vehicle.AwardTask)),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="transactioncount", #VAR.y.variable
  color_var="Vehicle.sum", #color_var
  facet_var="Vehicle.AwardTask", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="umber of Transaction",
       caption="Note: Unlabeled not shown. Source: FPDS and CSIS analysis.")
)


ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_vehicle7_transactions.png", ToplineVehicle7, 
             width=13, height= 4.5, units="in",size=11
             )


ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_vehicle_transactions.png", ToplineVehicle, 
             width=13, height= 4.5, units="in",size=11
             )


```

### Vehicle Plat Breakout
```{r VehPlatBreakout} 
platform_levels<-levels(factor(def_data$PlatformPortfolio))
for(p in platform_levels){
  file_p<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",p)))
  (Breakout<-build_plot(
    data=def_data %>% filter(Fiscal_Year>=2000&Fiscal_YQ<=2025.2&PlatformPortfolio==p),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Vehicle.sum7", #color_var
  facet_var="Vehicle.AwardTask", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "right")+
    labs(y="Obligations (Constant 2023 $s)",title=p))

  if(!dir.exists(file.path("../output/AcqTrends/Platform",file_p)))
    dir.create(file.path("../output/AcqTrends/Platform",file_p))
  undebug(log_plot)
  log_plot(plot=Breakout, df=def_data  %>% filter(Fiscal_YQ<=2025.2&PlatformPortfolio==p),
           filename=paste(file_p,"vehicle",sep="_"),xlsx=paste("DoD",file_p,"Contracts.xlsx",sep="_"),
           sheet="Veh",path=file.path("../output/AcqTrends/Platform/",file_p), height=3.5,
           startRow=1,startCol=14,format=TRUE,var_list=c("Vehicle.AwardTask","Vehicle.sum7"),
           output_doc_png=TRUE,excel_y_var=TRUE
           )
  
}
```

### Vehicle Cust Breakout
```{r VehCustBreakout} 
subcustomer_levels<-levels(factor(def_data$SubCustomer.sum))
for(c in subcustomer_levels){
  file_c<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",c)))
  (Breakout<-build_plot(
    data=def_data %>% filter(Fiscal_Year>=2000&SubCustomer.sum==c& Fiscal_YQ<=2025.2),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Vehicle.sum7", #color_var
  facet_var="Vehicle.AwardTask", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "right")+
    labs(y="Obligations (Constant 2023 $s)",title=c))
  
  if(!dir.exists(file.path("../output/AcqTrends/Customer",file_c)))
    dir.create(file.path("../output/AcqTrends/Customer",file_c))
  
  log_plot(plot=Breakout, df=def_data  %>% filter(Fiscal_YQ<=2025.2&SubCustomer.sum==c),
           filename=paste(file_c,"vehicle",sep="_"),xlsx=paste(file_c,"Contracts.xlsx",sep="_"),
           sheet="Veh",path=file.path("../output/AcqTrends/Customer/",file_c), height=3.5,
           startRow=1,startCol=14,format=TRUE,var_list=c("Vehicle.AwardTask","Vehicle.sum7"),
           output_doc_png=TRUE,excel_y_var=TRUE
           )
  
}
```

### Vehicle Cost 
```{r VehCost} 

(
CAS<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2001 & Fiscal_YQ<=2025.2) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="costaccountingstandardsclause", #color_var
  facet_var="Vehicle.sum7", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")
)
  

```

### Vehicle Multi-Year 
```{r VehicleMultiyear}
def_data %>% group_by(Vehicle,multiyearcontracttext) %>%
  dplyr::summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))

    def_data<-def_data%>% mutate(multiyearcontracttext=factor(multiyearcontract,levels=c("0","1"),
                              labels=c("Not Multi-Year","Multi-Year Contract")))

def_data<-def_data %>% group_by(Fiscal_Year,Vehicle.sum7)%>%
  mutate(pVehFYear=Action_Obligation_OMB25_GDP23/sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))

levels(factor(def_data$Vehicle))

(
VehicleMultiYear<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<=2025.2),
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="multiyearcontracttext", #color_var
  facet_var="Vehicle",
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

(
VehicleMultiYearShare<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Vehicle.sum7!="Unlabeled"&
                             (is.na(multiyearcontract)|multiyearcontract==1)),
  chart_geom = "Line Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="pVehFYear", #VAR.y.variable
  color_var="multiyearcontracttext", #color_var
  facet_var="Vehicle.sum7",
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Share of Obligations")+
    scale_y_continuous(labels = scales::percent)
)


ggsave600dpi(path="..//Output//AcqTrends//",filename="Vehicle_MultiYear.png", VehicleMultiYear,  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="Vehicle_MultiYearShare.png", VehicleMultiYearShare,  
             width=6.5, height= 4, units="in",size=12, lineheight=1.2
             )

# write.csv(file="..//Output//AcqTrends//VehicleMultiYearShare.csv",row.names = FALSE, na = "",
#   pivot_wider(VehicleMultiYearShare$data %>% 
#                         arrange(dFYear) %>% mutate(Fiscal_Year=lubridate::year(dFYear)),
#                       id_cols=c(Vehicle.sum7,multiyearcontracttext),
#                       names_from=Fiscal_Year,values_from=pPlatFYear)%>%
#   arrange(Vehicle.sum7,multiyearcontracttext))
#   


```

## Topline Pricing
```{r ToplinePricing}

# def_data$PricingUCA.sumlong<-def_data$PricingUCA.sum
# levels(def_data$PricingUCA.sumlong)<-list("Firm Fixed-Price"="FFP",
#                                            "Less Common"="Less Common",
#                                            "Incentive"="Incentive",
#                                            "Other Cost-Based"="Other CB",
#                                            "Undefinitized\nContract Award"="UCA",
#                                            "Unclear"="Unclear"   )
(
ToplinePricing<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<=2025.2),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingUCA", #color_var
  facet_var="PricingUCA.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE,
  alpha_var="YTD",
)+date_x_year_breaks(2000,2023,7)+#,partial_year=2024,partial_label="\nQ1")
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+facet_wrap(~PricingUCA.sum,nrow=1)+
  labs(y="Obligations\n(Constant 2023 $s)",
       title="DOD Contract Obligations by Pricing Mechanism, FY 2000–FY 2025 Q2",
       caption="Note: CB=Cost-Based, FFP=Firm Fixed Price, FP=Fixed-Price, FPLOE=Fixed-Price Level-of-Effort,\nLH=Labor Hours,T&M=Time & Materials, UCA=Undefinitized Contract Award\nSource: FPDS and CSIS analysis.")
)





ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_pricing.png", ToplinePricing,  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )


log_plot(plot=ToplinePricing+theme(plot.margin = margin(t=0,r=0.25,b=0.1,l=0.1,"inches")), df=def_data  %>% filter(Fiscal_YQ<=2025.2),
                     filename="aila_fig54_pricing",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="4-1 Price",path="../output/AcqTrends/", height=3.5,second_path=online_path,
         output_slide_png = TRUE,
                     format=TRUE,var_list=c("PricingUCA.sum","PricingUCA"),
         excel_formula=TRUE, excel_y_var = TRUE
         )

```


### Pricing UCA
```{r ToplinePricingUCA}


(
ToplinePricing<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<=2025.2),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var = "YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingUCA", #color_var
  facet_var="PricingUCA.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2023,6,partial_year=2025,partial_label="\nQ1-Q2")+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+facet_wrap(~PricingUCA.sum,nrow=1)+
  labs(y="Obligations\n(Constant 2023 $s)",
       title="DOD Contract Obligations by Pricing Mechanism, FY 2000–FY 2025 Q2",
       caption="Note: CB=Cost-Based, FFP=Firm Fixed Price, FP=Fixed-Price, FPLOE=Fixed-Price Level-of-Effort,\nLH=Labor Hours,T&M=Time & Materials, UCA=Undefinitized Contract Award\nSource: FPDS and CSIS analysis.")
)


  ggsave600dpi(path="..//Output//AcqTrends//",filename="Topline_PricingUCA.png", ToplinePricing,  
               width=6.5, height= 3, units="in",size=12, lineheight=1.2
               )
  
  
  ggsave600dpi(path="..//Output//AcqTrends//",filename="Topline_PricingUCA.svg", ToplinePricing,  
               width=12, height= 5.5, units="in",size=, lineheight=1.2
               )



(
ToplinePricingLine<-build_plot(
  data=def_data %>% filter(Fiscal_YQ <= 2025.2 & Fiscal_Year>=2000),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=hist_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingUCA.sum", #color_var
  # facet_var="PricingUCA.sumlong", #facet_var
  column_key=hist_ck,
  format=TRUE,
  ytextposition=FALSE
)+#+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right",
        plot.caption = element_text(hjust = 0,face="plain"))+
    date_x_year_breaks(2000,2023,5,partial_year=2025,partial_label="\nQ1-Q2")+
    # xlim(c(as.Date("1979-01-01"), as.Date("2023-12-30")))+
    # coord_cartesian(xlim = c(as.Date("1980-01-01"), as.Date("2022-01-01"))
  labs(y="Share of Obligations",caption="Source: Federal Procurement Data System (FPDS) and CSIS analysis.")
)


  ggsave600dpi(path="..//Output//AcqTrends//",filename="Topline_PricingUCA_Share.png", PricingHistory,  
               width=6.5, height= 3, units="in",size=12, lineheight=1.2
               )
  
  
  ggsave600dpi(path="..//Output//AcqTrends//",filename="Topline_PricingUCA_Share.svg", PricingHistory,  
               width=12, height= 5.5, units="in",size=, lineheight=1.2
               )

log_plot(plot=ToplinePricing, df=def_data  %>% filter(Fiscal_YQ<=2025.2 & Fiscal_Year>=2000), 
                     filename="acq_fig8_2_pricing_uca",xlsx="DoD_2025_NPS.xlsx",
                     sheet="8-2 PriceUCA",path="../output/AcqTrends/NPS2025/", height=3.5,
                     format=TRUE,#,var_list=c("PricingInflation",
         excel_y_var =TRUE,
         excel_share =TRUE,
         output_slide_png=TRUE
         )


```
### Pricing R&D UCA History
```{r ToplinePricingRnD}

(
ToplinePricing<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_Year<2025 & SimpleArea=="R&D") ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingUCA", #color_var
  facet_var="PricingUCA.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE,
  alpha_var="YTD",
)+date_x_year_breaks(2000,2023,6,partial_year=2025,partial_label="\nQ1-Q2")+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+facet_wrap(~PricingUCA.sum,nrow=1)+
  labs(y="Obligations\n(Constant 2023 $s)",
       title="DOD R&D Contract Obligations by Pricing Mechanism, FY 2000–FY 2025 Q2",
       caption="Note: CB=Cost-Based, FFP=Firm Fixed Price, FP=Fixed-Price, FPLOE=Fixed-Price Level-of-Effort,\nLH=Labor Hours,T&M=Time & Materials, UCA=Undefinitized Contract Award\nSource: FPDS and CSIS analysis.")
)


  ggsave600dpi(path="..//Output//AcqTrends//",filename="RnD_PricingUCA.png", ToplinePricing,  
               width=6.5, height= 3, units="in",size=12, lineheight=1.2
               )
  
  
  ggsave600dpi(path="..//Output//AcqTrends//",filename="RnD_PricingUCA.svg", ToplinePricing,  
               width=12, height= 5.5, units="in",size=, lineheight=1.2
               )



(
PricingHistory<-build_plot(
  data=def_data %>% filter(Fiscal_Year < 2025 & Fiscal_Year>=2000 & SimpleArea=="R&D"),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=hist_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingUCA.sum", #color_var
  # facet_var="PricingUCA.sumlong", #facet_var
  column_key=hist_ck,
  format=TRUE,
  ytextposition=FALSE
)+#+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right",
        plot.caption = element_text(hjust = 0,face="plain"))+
    date_x_year_breaks(2000,2023,6,partial_year=2025,partial_label="\nQ1-Q2")+
    # xlim(c(as.Date("1979-01-01"), as.Date("2023-12-30")))+
    # coord_cartesian(xlim = c(as.Date("1980-01-01"), as.Date("2022-01-01"))
  labs(y="Share of Obligations",caption="Source: Federal Procurement Data System (FPDS) and CSIS analysis.")
)


  ggsave600dpi(path="..//Output//AcqTrends//",filename="RnD_PricingUCA_Share.png", PricingHistory,  
               width=6.5, height= 3, units="in",size=12, lineheight=1.2
               )
  
  
  ggsave600dpi(path="..//Output//AcqTrends//",filename="RnD_PricingUCA_Share.svg", PricingHistory,  
               width=12, height= 5.5, units="in",size=, lineheight=1.2
               )

log_plot(plot=PricingHistory, df=def_data  %>% filter(Fiscal_Year<2025&Fiscal_Year>=2000 & SimpleArea=="R&D"),
                     filename="acq_fig8_2_pricing_uca",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="8-2 RnD PriceUCA",path="../output/AcqTrends/", height=3.5,
                     format=TRUE,#,var_list=c("PricingInflation",
         excel_y_var =TRUE,
         excel_share =TRUE
         )


```


### Pricing Inflation
```{r ToplinePricingInflation}

(
PricingHistory<-build_plot(
  data=def_data %>% filter(Fiscal_Year < 2025),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=hist_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingInflation", #color_var
  # facet_var="PricingUCA.sumlong", #facet_var
  column_key=hist_ck,
  format=TRUE,
  ytextposition=FALSE
)+#+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right",
        plot.caption = element_text(hjust = 0,face="plain"))+
    date_x_year_breaks(1980,2022,5)+#,partial_year=2024,partial_label="\nQ1")
    # xlim(c(as.Date("1979-01-01"), as.Date("2023-12-30")))+
    # coord_cartesian(xlim = c(as.Date("1980-01-01"), as.Date("2022-01-01"))
  labs(y="Share of Obligations",caption="Source: Federal Procurement Data System (FPDS) and CSIS analysis.")
)


  ggsave600dpi(path="..//Output//AcqTrends//",filename="Topline_Pricing_History.png", PricingHistory,  
               width=6.5, height= 3, units="in",size=12, lineheight=1.2
               )
  
  
  ggsave600dpi(path="..//Output//AcqTrends//",filename="Topline_Pricing_History.svg", PricingHistory,  
               width=12, height= 5.5, units="in",size=, lineheight=1.2
               )

log_plot(plot=PricingHistory, df=def_data  %>% filter(Fiscal_YQ<=2025.2),
                     filename="acq_fig8_2_pricing_history",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="8-2 PriceHist",path="../output/AcqTrends/", height=3.5,
                     format=TRUE#,var_list=c("PricingInflation")
         )


```


### Pricing FMS
```{r FPDS_pricingUCA}
summary(def_data$IsFMS)
def_data$ProductOrService<-factor(def_data$SimpleArea)
levels(def_data$ProductOrService)<-list("Products"="Products (All)",
                                         "Services & R&D"=c("R&D","Services (Non-R&D)"),
                                         "Unlabeled"="Unlabeled")


def_data<- def_data %>%      group_by(Fiscal_Year,IsFMS) %>%
                               dplyr::mutate(Action_FMS_Share=Action_Obligation_OMB25_GDP23/
                                           sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))%>% 
                               group_by(Fiscal_Year,IsFMS,ProductOrService) %>%
                               dplyr::mutate(Action_FMS_PS_Share=Action_Obligation_OMB25_GDP23/
                                           sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))%>% 
                               group_by(Fiscal_Year,IsFMS,SimpleArea) %>%
                               dplyr::mutate(Action_FMS_PSR_Share=Action_Obligation_OMB25_GDP23/
                                           sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))



# undebug(build_plot)
# undebug(build_plot)
(fpds_pricing <-  build_plot(data=def_data %>% filter(Fiscal_Year>=2012 & Fiscal_YQ<=2025.2),
                            chart_geom="Line Chart",
                            x_var="dFYear",
                            y_var="Action_FMS_Share",
                            color_var="IsFMS",
                            facet_var="PricingUCA",
                            # second_var="StateRegion",
                            labels_and_colors=def_lc,
                            column_key=def_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE,
                            alpha_var="YTD",
)+date_x_year_breaks(2012,2022,2)+#,partial_year=2024,partial_label="\nQ1")
    theme(legend.position = "right")+
    facet_wrap( ~PricingUCA)+
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)))



# undebug(format_data_for_plot)
(fpds_pricing_bar <-  build_plot(data=def_data %>% filter(Fiscal_Year>=2012 & Fiscal_YQ<=2025.2),
                            chart_geom="Bar Chart",
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PricingUCA",
                            facet_var="IsFMS",
                            # second_var="StateRegion",
                            labels_and_colors=def_lc,
                            column_key=def_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE,
                            alpha_var="YTD",
)+date_x_year_breaks(2012,2022,3)+#,partial_year=2024,partial_label="\nQ1")
    theme(legend.position = "right")+
    facet_grid( IsFMS~. , scales="free_y"))

# +
#   labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
#        y="Constant 2023 $ Obligated (Variable Y-Scale)",
#        caption="Source: FPDS and CSIS analysis.")+
#     theme(legend.position = "right"))

(fpds_pricing_psr <-  build_plot(data=def_data %>% filter(Fiscal_Year>=2012 & Fiscal_YQ<=2025.2) %>%
                                   filter(SimpleArea!="Unlabeled" & IsFMS!="Unlabeled" & !is.na(IsFMS)),
                            chart_geom="Line Chart",
                            x_var="dFYear",
                            y_var="Action_FMS_PSR_Share",
                            color_var="IsFMS",
                            facet_var="PricingUCA",
                            second_var="SimpleArea",
                            labels_and_colors=def_lc,
                            column_key=def_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE,
                            alpha_var="YTD",
)+date_x_year_breaks(2012,2022,3)+#,partial_year=2024,partial_label="\nQ1")
    theme(legend.position = "right")+
    facet_grid(SimpleArea~PricingUCA)+
    scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
    labs(caption="Note: Excludes unlabeled product or service and unlabeled FMS.\nSource: FPDS and CSIS analysis."))#+

     # theme(strip.text.y = element_text(angle=0)))


# debug(buildaC_plot)
(fpds_pricing_psr_bar <-  build_plot(data=def_data  %>% filter(SimpleArea!="Unlabeled"&
                                                                    IsFMS!="Unlabeled" & 
                                                                  !is.na(IsFMS))%>%
                                       filter(Fiscal_Year>=2012 & Fiscal_YQ<=2025.2),
                            chart_geom="Bar Chart",
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PricingUCA",
                            facet_var="IsFMS",
                            second_var="ProductOrService",
                            labels_and_colors=def_lc,
                            column_key=def_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE,
                            alpha_var="YTD",
)+date_x_year_breaks(2012,2022,3)+#,partial_year=2024,partial_label="\nQ1")
    theme(legend.position = "right")+
    facet_grid( IsFMS~ProductOrService , scales="free_y")+
    labs(caption="Note: Excludes unlabeled product or service and unlabeled FMS.\nSource: FPDS and CSIS analysis."))
# 
# ggsave600dpi(fpds_pricing_psr_bar, filename = "..//output//figure_07_fpds_pricing_psr_bar.png", 
#        width = 9,
#        height = 4.5,
#        size = 12, lineheight=1)

log_plot(plot=fpds_pricing_psr_bar, df=def_data  %>% filter(Fiscal_YQ<=2025.2),
                     filename="acq_fig7_3_FMS_ps_pricing",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="7-3 FMSprice",path="../output/AcqTrends/", height=3.5,
                     startRow=1,startCol=15,format=TRUE,var_list=c("IsFMS","ProductOrService","PricingUCA.sum","PricingUCA")
         )


```

### Pricing Plat Breakout
```{r PricingPlatBreakout} 
platform_levels<-levels(factor(def_data$PlatformPortfolio))
for(p in platform_levels){
  file_p<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",p)))
  (Breakout<-build_plot(
    data=def_data %>% filter(Fiscal_Year>=2000&Fiscal_YQ<=2025.2&PlatformPortfolio==p),
    chart_geom = "Bar Chart",
    share = FALSE,
    labels_and_colors=def_lc,
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
    color_var="PricingUCA", #color_var
    facet_var="PricingUCA.sumlong", #facet_var
    column_key=def_ck,
    format=TRUE,
    ytextposition=FALSE,
    alpha_var="YTD",
  )+date_x_year_breaks(2000,2023,6)+#,partial_year=2024,partial_label="\nQ1")
    theme(legend.position = "right")+
    labs(y="Obligations (Constant 2023 $s)",title=p))

  if(!dir.exists(file.path("../output/AcqTrends/Platform",file_p)))
    dir.create(file.path("../output/AcqTrends/Platform",file_p))
  undebug(log_plot)
  log_plot(plot=Breakout, df=def_data  %>% filter(Fiscal_YQ<=2025.2&PlatformPortfolio==p),
           filename=paste(file_p,"pricing",sep="_"),xlsx=paste("DoD",file_p,"Contracts.xlsx",sep="_"),
           sheet="Price",path=file.path("../output/AcqTrends/Platform/",file_p), height=3.5,
           startRow=1,startCol=14,format=TRUE,var_list=c("PricingUCA.sumlong","PricingUCA"),
           output_doc_png=TRUE,excel_y_var=TRUE
           )
  
}
```

### Pricing Cust Breakout
```{r PriceCustBreakout} 
subcustomer_levels<-levels(factor(def_data$SubCustomer.sum))
for(c in subcustomer_levels){
  file_c<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",c)))
  (Breakout<-build_plot(
    data=def_data %>% filter(Fiscal_Year>=2000&SubCustomer.sum==c& Fiscal_YQ<=2025.2),
    chart_geom = "Bar Chart",
    share = FALSE,
    labels_and_colors=def_lc,
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
    color_var="PricingUCA", #color_var
    facet_var="PricingUCA.sumlong", #facet_var
    column_key=def_ck,
    format=TRUE,
    ytextposition=FALSE,
    alpha_var="YTD",
  )+date_x_year_breaks(2000,2023,6)+#,partial_year=2024,partial_label="\nQ1")
    theme(legend.position = "right")+
    labs(y="Obligations (Constant 2023 $s)",title=c))
  
  if(!dir.exists(file.path("../output/AcqTrends/Customer",file_c)))
    dir.create(file.path("../output/AcqTrends/Customer",file_c))
  
  log_plot(plot=Breakout, df=def_data  %>% filter(Fiscal_YQ<=2025.2&SubCustomer.sum==c),
           filename=paste(file_c,"pricing",sep="_"),xlsx=paste(file_c,"Contracts.xlsx",sep="_"),
           sheet="Price",path=file.path("../output/AcqTrends/Customer/",file_c), height=3.5,
           startRow=1,startCol=14,format=TRUE,var_list=c("PricingUCA.sumlong","PricingUCA"),
           output_doc_png=TRUE,excel_y_var=TRUE
           )
  
}
```

## Topline Commercial
```{r ToplineCommercial}
def_data$AnyCommercialText<-factor(def_data$AnyCommercial)
levels(def_data$AnyCommercialText)<-list(
  "Not Classified\nas Commercial"="N",
  "Non-development\nor Commercial Similar"= "NonDev",
  "Any Commercial\nClassification"="Y"
  
)

(
Commercial<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<=2025.2),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="AnyCommercialText", #color_var
  # facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")+
  date_x_year_breaks(2000,2022,2)#)#,partial_year=2024,partial_label="\nOct–Nov")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_commercial.png", Commercial, 
             width=11, height= 5.5, units="in",size=14,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_commercial.svg", Commercial+
  labs(y="Obligations\n(Constant 2023 $s)"),#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 2.25, units="in",size=11,lineheight = 1.2
             )


log_plot(plot=Commercial+labs(y="Obligations\n(Constant 2023 $s)"), df=def_data %>% filter(Fiscal_YQ<=2025.2),
                     filename="acq_fig5_4_commercial",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="5-4 Comm",path="../output/AcqTrends/", height=2.5,
                     startRow=1,startCol=12,format=TRUE,#var_list=c("SimpleArea","Competition.multisum")
         )


def_data %>% filter(SubCustomer.sum=="Army", PlatformPortfolio=="Other Products", Fiscal_Year==2021) %>%
  group_by(AnyCommercialText,Competition.multisum) %>% summarise(
    COVID19obligated=sum(COVID19obligated,na.rm=TRUE),
    Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
    Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year),
    
  )

```

## Topline Duration
```{r Duration}

def_data$CurrentDurationIsYear<-factor(def_data$CurrentDurationCategory)
levels(def_data$CurrentDurationIsYear)<-list(
   "<=1 year" =c("<=2 Months", ">2-7 Months"  ,">7-12 Months"),
   ">1 year"=c(">1-2 Years",   ">2-4 Years",  ">4 years")
)
def_data$UnmodifiedUltimateDurationIsYear<-factor(def_data$UnmodifiedUltimateDurationCategory)
levels(def_data$UnmodifiedUltimateDurationIsYear)<-list(
   "<=1 year" =c("<=2 Months", ">2-7 Months"  ,">7-12 Months"),
   ">1 year"=c(">1-2 Years",   ">2-4 Years",  ">4 years")
)

(
CurDuration<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<=2025.2),
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="CurrentDurationCategory", #color_var
  # facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Share of Obligations")+
     date_x_year_breaks(2007,2023,2)#)#,partial_year=2024,partial_label="\nOct–Nov")

)

(
UnmDuration<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<=2025.2),
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="UnmodifiedUltimateDurationCategory", #color_var
  # facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Share of Obligations",
       title="Market Share of DOD Contracts by Initial Award\nor Task Order Ultimate Duration, FY 2007-FY 2023")+
      date_x_year_breaks(2007,2023,2)#)#,partial_year=2024,partial_label="\nOct–Nov")

)


ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_CurDuration.png", CurDuration, 
             width=11, height= 5.5, units="in",size=14,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_CurDuration.svg", CurDuration,#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 3, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_UnmDuration.png", UnmDuration,#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 3, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_UnmDuration.svg", UnmDuration,#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 3, units="in",size=11,lineheight = 1.2
             )

write.csv(file="..//Output//AcqTrends//then_year_csv//topline_CurDuration_current.csv",row.names = FALSE, na = "",
          def_data %>% group_by(CurrentDurationCategory,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(CurrentDurationCategory),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(CurrentDurationCategory))


log_plot(plot=UnmDuration, df=def_data  %>% filter(Fiscal_YQ<=2025.2),
                     filename="acq_fig8_3_UmdDuration",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="8-3 Dur",path="../output/AcqTrends/", height=3.5,
                     startRow=1,startCol=12,format=TRUE,
         output_slide_png = TRUE, suppress_doc_svg_text = "title"
         #,var_list=c("PricingInflation"),
         )


log_plot(plot=UnmDuration, df=def_data  %>% filter(Fiscal_YQ<=2025.2),
                     filename="nps_fig06_UmdDuration",xlsx="DoD_2025_NPS.xlsx",
                     sheet="9 Dur",path="../output/AcqTrends/NPS2025/",second_path=online_path,
         height=2.75,include_YTD=FALSE,suppress_doc_svg_text = "title",output_slide_png=TRUE,
                     startRow=1,format=TRUE,excel_y_var=TRUE,excel_formulas = TRUE
         )
```


## GFE Setup
```{r GFE}

def_data$gfe_gfp_value<-factor(def_data$gfe_gfp_code)
levels(def_data$gfe_gfp_value)<-list(
   "No Government Furnished"="N",
  "Transaction uses\nGovernment Furnished\nEquipment or Property"="Y"
 
)

```



### GFE Competition
```{r GFEcomp}
summary(def_data$gfe_gfp_code)
(
GFEcomp<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<=2025.2) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="No.Competition.sum", #color_var
  facet_var="gfe_gfp_value", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")+
    scale_x_date(breaks=as.Date(c(paste(seq(2000,2021,3),"-01-01",sep=""))),
                                                   date_labels="'%y")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="comp_GFE.png", GFEcomp, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="comp_GFE.svg", GFEcomp, 
             width=6.5, height= 4.5, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="comp_GFE.emf", GFEcomp, 
             width=6.5, height= 4.5, units="in",size=11,lineheight = 1.2
             )


# write.csv(file="..//Output//AcqTrends//platform_GFE.csv",row.names = FALSE, na = "",
#           pivot_wider(GFEplat$data,id_cols=c(PlatformPortfolio,gfe_gfp_value),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23))

write.csv(file="..//Output//AcqTrends//platform_GFE_current.csv",row.names = FALSE, na = "",
          def_data %>% group_by(PlatformPortfolio,gfe_gfp_value,Fiscal_Year)%>%
            filter(Fiscal_Year>=2004 & Fiscal_YQ<=2025.2)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(PlatformPortfolio,gfe_gfp_value),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(def_data$ContractingSubCustomer)
```


## Topline Cost Accounting
```{r CostAccounting}


(
CAS<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2001 & Fiscal_YQ<=2025.2) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="costaccountingstandardsclause", #color_var
  facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)


(
CAS<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<=2025.2) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="costaccountingstandardsclause", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)


(
CAS<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<=2025.2) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.sum", #color_var
  facet_var="costaccountingstandardsclause", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)


(
CAS<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<=2025.2) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="AnyCommercial", #color_var
  facet_var="costaccountingstandardsclause", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)


```



#Product/Service/R&D

## Topline Product/Service/R&D
```{r ToplinePSR}

(
ToplinePSR<-build_plot(
  data=def_data %>% filter(Fiscal_YQ<=2025.2 & !is.na(SimpleArea) & SimpleArea!="Unlabeled"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  alpha_var="YTD",
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SimpleArea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",
       caption="Note: Unlabeled product, service, and R&D areas not shown.\nSource: FPDS and CSIS analysis.")+
  date_x_year_breaks(1990,2020,5,partial_year=2025,partial_label="\nQ1-Q2",)
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_psr.png", ToplinePSR, 
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_psr.svg", ToplinePSR, 
             width=6.5, height= 3, units="in",size=11, lineheight=1.2
             )

log_plot(plot=ToplinePSR+facet_wrap(~SimpleArea), df=def_data %>% filter(Fiscal_YQ<=2025.2),
                     filename="acq_fig3_1_area",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="3-1 Area",path="../output/AcqTrends/", height=3.5,
                     startRow=1,startCol=12,format=TRUE,#var_list=c("SimpleArea","Competition.multisum"),
         excel_y_var = TRUE,excel_formulas = TRUE
         )

```

## PSR OTA
```{r ToplinePSRota}
if(!exists("def_kota"))
  load(file="../data/clean/def_kota.Rda")


(
OTAPSR<-build_plot(
  data=def_kota %>% filter(Fiscal_Year>=2015 & Fiscal_YQ<=2025.2 &
                                 !is.na(AreaType) & AreaType!="Unlabeled") ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=kota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  alpha_var="YTD",
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="AreaType", #color_var
  facet_var="SimpleAreaType", #facet_var
  column_key=kota_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",
       caption="Note: Unlabeled contract product, service, and R&D areas\nas well as unlabeled OTA agreement types not shown.\nSource: FPDS and CSIS analysis.",
       title="Defense Contract Obligations by Product, Service, and R&D and\nOTA Obligations by Agreement Type, FY 2015–FY 2025 Q2")+facet_wrap(~SimpleAreaType, nrow=1)+
  date_x_year_breaks(2015,2024,3)#,partial_year=2024,partial_label="\nQ1",)
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="OTA_psr.png", OTAPSR, 
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="OTA_psr.svg", OTAPSR, 
             width=6.5, height= 3, units="in",size=11, lineheight=1.2
             )

log_plot(plot=OTAPSR, df=def_kota %>% filter(Fiscal_YQ<=2025.2),
                     filename="nps_fig02_kota_areatype",xlsx="DoD_2025_Prelim.xlsx",
                     sheet="2 KOta",path="../output/AcqTrends/NPS2025/",#second_path=online_path,
         height=3,include_YTD=FALSE,output_slide_png=TRUE,suppress_doc_svg_text = "title",
                     startRow=1,format=TRUE,excel_y_var=TRUE,excel_formulas = TRUE,
         output_doc_svg=TRUE
         )

```

## PSR Plat Breakout
```{r PSRplatBreakout} 
platform_levels<-levels(factor(def_data$PlatformPortfolio))
for(p in platform_levels){
  file_p<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",p)))
  (Breakout<-build_plot(
    data=def_data %>% filter(Fiscal_Year>=2000&PlatformPortfolio==p& Fiscal_YQ<=2025.2),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  alpha_var="YTD",
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SimpleArea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",title=p)+
  date_x_year_breaks(1990,2020,5,partial_year=2025,partial_label="\nQ1-Q2")
)

  if(!dir.exists(file.path("../output/AcqTrends/Platform",file_p)))
    dir.create(file.path("../output/AcqTrends/Platform",file_p))
  
  log_plot(plot=Breakout, df=def_data  %>% filter(Fiscal_YQ<=2025.2&PlatformPortfolio==p),
           filename=paste(file_p,"PSR",sep="_"),xlsx=paste("DoD",file_p,"Contracts.xlsx",sep="_"),
           sheet="PSR",path=file.path("../output/AcqTrends/Platform/",file_p), height=3.5,
           startRow=1,startCol=13,format=TRUE,#,var_list=c("PricingUCA.sumlong","PricingUCA"),
           output_doc_png=TRUE,excel_y_var=TRUE
           )
  
}
```

## PSR Cust Breakout
```{r PSRcustBreakout} 
subcustomer_levels<-levels(factor(def_data$SubCustomer.sum))
for(c in subcustomer_levels){
  file_c<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",c)))
  (Breakout<-build_plot(
    data=def_data %>% filter(Fiscal_Year>=2000&SubCustomer.sum==c& Fiscal_YQ<=2025.2),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  alpha_var="YTD",
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SimpleArea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",title=c)+
  date_x_year_breaks(1990,2020,5,partial_year=2025,partial_label="\nQ1-Q2")
)

  if(!dir.exists(file.path("../output/AcqTrends/Customer",file_c)))
    dir.create(file.path("../output/AcqTrends/Customer",file_c))
  
  log_plot(plot=Breakout, df=def_data  %>% filter(Fiscal_YQ<=2025.2&SubCustomer.sum==c),
           filename=paste(file_c,"PSR",sep="_"),xlsx=paste(file_c,"Contracts.xlsx",sep="_"),
           sheet="PSR",path=file.path("../output/AcqTrends/Customer/",file_c), height=3.5,
           startRow=1,startCol=13,format=TRUE,#,var_list=c("PricingUCA.sumlong","PricingUCA"),
           output_doc_png=TRUE,excel_y_var=TRUE
           )
  
}
```

## PSR Quarterly
```{r PSR_Q}

(
PSR_Q<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000&  Fiscal_YQ<=2024.1 & SimpleArea!="Unlabeled"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="fiscal_quarter_YTD", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2023,3)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="PSR_Q.png", PSR_Q, 
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="PSR_Q.svg", PSR_Q, 
             width=6.5, height= 3, units="in",size=11, lineheight=1.2
             )


output_TY<-def_data %>% filter(Fiscal_YQ<=2025.2) %>% group_by(SimpleArea,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(SimpleArea),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)
write.csv(file="..//Output//AcqTrends//PSR_Q.csv",row.names = FALSE, na = "",
          output_TY)


# wb <- loadWorkbook("..//Output//AcqTrends//DoD_Acq_Trends_Contracts.xlsx")
# createSheet(wb, name = "Area")
# writeData(wb, output_TY, sheet = "Area", startRow = 14, startCol = 14)
# saveWorkbook(wb,file="..//Output//AcqTrends//DoD_Acq_Trends_Contracts.xlsx",overwrite = TRUE)

```


## R&D phase
```{r RnD}

(
RnDphase<-build_plot(
  data=def_data %>% filter(Fiscal_YQ<=2025.2) %>% filter(SimpleArea=="R&D"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="ProductServiceOrRnDarea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="psr_RnDPhase.png", RnDphase, 
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )

log_plot(plot=RnDphase, df=def_data %>% filter(Fiscal_YQ<=2025.2) %>% filter(SimpleArea=="R&D"),
                     filename="acq_fig5_1_RnD",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="5-1 RnD",path="../output/AcqTrends/", height=3,
                     startRow=1,startCol=12,format=TRUE,#var_list=c("SimpleArea","Competition.multisum"),
         output_doc_svg=TRUE
         )

```



## R&D Phase+OTA    
```{r PhaseAndOTA}

contract_merge<-def_data %>% filter(Fiscal_YQ<=2025.2) %>%
  group_by(Fiscal_Year,
                         ProductServiceOrRnDarea,
                         SimpleArea)%>%
  dplyr::summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
                   Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year))

# 


#   format_data_for_plot(contract_data,
#                      fy_var="Fiscal_Year", #x_var
#                      y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
#                      color_var="ProductServiceOrRnDarea", #color_var
#                      facet_var = "SimpleArea",
#                      labels_and_colors = labels_and_colors
# )
# ota_merge<-format_data_for_plot(ota_def,
#                      fy_var="Fiscal_Year", #x_var
#                      y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
#                      color_var="ProductServiceOrRnDarea", #color_var
#                      facet_var = "SimpleArea",
#                      labels_and_colors = labels_and_colors
# )

ota_merge<-ota_def%>%filter(Fiscal_Year >=2015 & Fiscal_Year <=2022) %>%
  group_by(Fiscal_Year,SimpleArea)%>%
  dplyr::summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
                   Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year)
                   )

#   format_data_for_plot(ota_def,
#                      fy_var="Fiscal_Year", #x_var
#                      y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
#                      color_var="ProductServiceOrRnDarea", #color_var
#                      facet_var = "SimpleArea",
#                      labels_and_colors = labels_and_colors
# )

ota_merge$ProductServiceOrRnDarea<-"Other Transaction Authority (OTA) R&D Agreements"
colnames(ota_merge)[colnames(ota_merge)=="Fiscal_Year"]<-"Fiscal_Year"
merge<-rbind(ota_merge,contract_merge)
merge$dFYear<-as.Date(paste(merge$Fiscal_Year,"1","1",sep="-"))
(
RnDphasePlusOTA<-build_plot(
  data=merge %>% filter(SimpleArea=="R&D" & Fiscal_Year >=2015),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=prepare_labels_and_colors(merge),
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="ProductServiceOrRnDarea", #color_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE,
  first_color_on_bottom = TRUE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)+scale_x_date(date_labels="'%y",date_breaks="1 year")

ggsave600dpi(path="..//Output//AcqTrends//",filename="RnDPhasePlusOTA.png", RnDphasePlusOTA+labs(caption="Source: FPDS and CSIS analysis."),
             width=5, height= 4.75, units="in",size=11, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="RnDPhasePlusOTA.svg", RnDphasePlusOTA+labs(caption="Source: FPDS and CSIS analysis."),
             width=5, height= 4.75, units="in",size=11, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="RnDPhasePlusOTA.emf", RnDphasePlusOTA+labs(caption="Source: FPDS and CSIS analysis."),
             width=5, height= 4.75, units="in",size=11, lineheight=1.2
             )

#                            
# 
# write.csv(file="..//Output//AcqTrends//RnDPhasePlusOTA.csv",row.names = FALSE, na = "",
#           RnDphasePlusOTA$data%>% mutate(Fiscal_Year=year(dFYear)) %>%
#           pivot_wider(id_cols=c(ProductServiceOrRnDarea),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)%>%
#             arrange(ProductServiceOrRnDarea))
# #             
# #  



write.csv(file="..//Output//AcqTrends//RnDPhasePlusOTA_current.csv",row.names = FALSE, na = "",
          merge %>% filter(SimpleArea=="R&D") %>%
            format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",
                                 color_var = "ProductServiceOrRnDarea",
                                 labels_and_colors=prepare_labels_and_colors(merge)) %>%
            pivot_wider(id_cols=c(ProductServiceOrRnDarea),
                        names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(ProductServiceOrRnDarea))

```

## Phase: Contract and OTA
```{r PhaseBoth}

contract_merge<-def_data%>%filter(Fiscal_Year >=2015 & Fiscal_YQ<2022) %>%
  group_by(Fiscal_Year,
                         ProductServiceOrRnDarea,
                         SimpleArea)%>%
  dplyr::summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))

# 
#   format_data_for_plot(contract_data,
#                      fy_var="Fiscal_Year", #x_var
#                      y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
#                      color_var="ProductServiceOrRnDarea", #color_var
#                      facet_var = "SimpleArea",
#                      labels_and_colors = labels_and_colors
# )
# ota_merge<-format_data_for_plot(ota_def,
#                      fy_var="Fiscal_Year", #x_var
#                      y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
#                      color_var="ProductServiceOrRnDarea", #color_var
#                      facet_var = "SimpleArea",
#                      labels_and_colors = labels_and_colors
# )

ota_merge<-standardize_variable_names(ota_def)%>%filter(Fiscal_Year >=2015) %>%
  group_by(Fiscal_Year,
                         ProductServiceOrRnDarea,
                         SimpleArea)%>%
  dplyr::summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))


#   format_data_for_plot(ota_def,
#                      fy_var="Fiscal_Year", #x_var
#                      y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
#                      color_var="ProductServiceOrRnDarea", #color_var
#                      facet_var = "SimpleArea",
#                      labels_and_colors = labels_and_colors
# )

ota_merge$Authority<-"OTA"
colnames(ota_merge)[colnames(ota_merge)=="Fiscal_Year"]<-"Fiscal_Year"
contract_merge$Authority<-"Contract"
merge<-rbind(ota_merge,contract_merge)

(
RnDphase<-build_plot(
  data=merge %>% filter(SimpleArea=="R&D"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=prepare_labels_and_colors(merge),#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\"
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Authority", #color_var
  facet_var="ProductServiceOrRnDarea", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="contractota_RnDPhase.png", RnDphase,
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )
#                            
# 
write.csv(file="..//Output//AcqTrends//contractota_RnDPhase.csv",row.names = FALSE, na = "",
          pivot_wider(RnDphase$data,id_cols=c(ProductServiceOrRnDarea,Authority),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)%>%
            arrange(ProductServiceOrRnDarea,Authority))
#             
# 
# write.csv(file="..//Output//AcqTrends//psr_RnDPhase_current.csv",row.names = FALSE, na = "",
#           def_data %>% filter(SimpleArea=="R&D") %>%
#             format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "ProductServiceOrRnDarea",
#                                  labels_and_colors=def_lc) %>%
#           pivot_wider(id_cols=c(ProductServiceOrRnDarea),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
#             arrange(ProductServiceOrRnDarea))

```

## Services
```{r Services}
summary(factor(def_data$ServicesCategory.sum))
(
Services<-build_plot(
  data=def_data %>% filter(SimpleArea=="Services (Non-R&D)" & Fiscal_YQ<=2025.2),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="ProductServiceOrRnDarea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  date_x_year_breaks(1990,2020,5)+#,partial_year=2024,partial_label="\nQ1")
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="psr_Services.png", Services, 
             width=12, height= 6, units="in",size=14, lineheight=1.2
             )
              
ggsave600dpi(path="..//Output//AcqTrends//",filename="psr_Services.svg", Services, 
             width=6.5, height= 3.25, units="in",size=10, lineheight=1.2
             )             


            
log_plot(plot=Services, df=def_data  %>% filter(Fiscal_YQ<=2025.2 &SimpleArea=="Services (Non-R&D)"),
                     filename="acq_fig3_3_services",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="3-3 Serv",path="../output/AcqTrends/", height=3.5,
                     startRow=1,startCol=12,format=TRUE,#,var_list=c("SimpleArea","Competition.multisum")
         )

```

## PSR Pricing
```{r PSR_pricing}


(
PSRpricing_dollar<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ < 2024 & !is.na(SimpleArea) & SimpleArea!="Unlabeled"),
  chart_geom = "Bar Chart",
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingUCA.sum", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE,
  share=FALSE
)+theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",caption="Source: FPDS and CSIS analysis.",
       title="DOD Contract Obligations by Pricing Mechanism, FY 2000–FY 2025 Q2")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="psr_pricing_dollar.png", PSRpricing_dollar, 
             width=6.5, height= 5, units="in",size=11, lineheight=1.2
             )


(
SimpleVendor_share<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 &Fiscal_YQ<=2025.2 & !is.na(SimpleArea) & SimpleArea!="Unlabeled"),
  chart_geom = "Bar Chart",
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingUCA.sum", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE,
  share=TRUE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",caption="Source: FPDS and CSIS analysis.")
)


ggsave600dpi(path="..//Output//AcqTrends//",filename="psr_pricing_share.png", SimpleVendor_share, 
             width=6.5, height= 5, units="in",size=11, lineheight=1.2
             )


log_plot(plot=Services, df=def_data  %>% filter(Fiscal_YQ<=2025.2 &SimpleArea=="Services (Non-R&D)"),
                     filename="aila30_pricing",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="PSR-price",path="../output/AcqTrends/", height=3.5,
                     format=TRUE,output_slide_png=TRUE #,var_list=c("SimpleArea","Competition.multisum")
         )
```

## PSR Vendor size 
```{r PSR_vendorsize}


(
SimpleVendor_dollar<-build_plot(
  data=def_data %>% filter(Fiscal_Year<=2021 & !is.na(SimpleArea) & SimpleArea!="Unlabeled"),
  chart_geom = "Bar Chart",
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE,
  share=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April of 2020\n and thus did not make the cutofff for inclusion in FY2020.\nMcDonnell Douglas is grouped with the Big-5.")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="psr_vendorsize_dollar.png", SimpleVendor_dollar, 
             width=6.5, height= 5, units="in",size=11, lineheight=1.2
             )


(
SimpleVendor_share<-build_plot(
  data=def_data %>% filter(Fiscal_Year<=2021 & !is.na(SimpleArea) & SimpleArea!="Unlabeled"),
  chart_geom = "Bar Chart",
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE,
  share=TRUE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",caption="Source: FPDS and CSIS analysis.")
)


ggsave600dpi(path="..//Output//AcqTrends//",filename="psr_vendorsize_share.png", SimpleVendor_share, 
             width=6.5, height= 5, units="in",size=11, lineheight=1.2
             )

```



## PSR Competition
```{r PSRcomp_plat}
summary(def_data$SimpleArea)


(
PSRComp_bar<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=1991 & Fiscal_YQ<=2025.2 & SimpleArea!="Unlabeled"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Obligations (Constant 2023 $s)",
       title="DOD Contract Obligations by Extent of Competition, FY 1991–FY 2025 Q2")+
    date_x_year_breaks(1991,2023,by=6,partial_year=2025,partial_label="\nQ1-Q2")
)


(
PSRComp_line<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=1991 & Fiscal_YQ<=2025.2 & SimpleArea!="Unlabeled"),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",y="Share of Obligations")+
    date_x_year_breaks(1991,2023,by=6,partial_year=2025,partial_label="\nQ1-Q2")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="PSRComp_line.png", PSRComp_line, 
             width=6.5, height= 5, units="in",size=12, lineheight=1.2
             )


ggsave("..//Output//AcqTrends//PSRComp_both.svg", 
             gridExtra::grid.arrange(
               PSRComp_bar+labs(caption = NULL,x=NULL,title=NULL)+theme(legend.position = "none"),
               PSRComp_line), 
             width=6.5, height= 5, units="in"
)

ggsave("..//Output//AcqTrends//NPS2025//PSRComp_both_keynote.png", 
             gridExtra::grid.arrange(
               PSRComp_bar+labs(
                  y="Obligations\n(Const. 2023 $s)",
               caption = NULL,x=NULL)+theme(legend.position = "none",text=element_text(size=20)),
               PSRComp_line+labs(y="Share of\nObl.")+theme(text=element_text(size=20),
               plot.caption = element_text(size=round(20 * 5/6,0))
               )),
             width=13, height= 5.5, units="in" #, size=20, lineheight = 0.75
             )

ggsave("..//Output//AcqTrends//NPS2025//acq_fig6_6_PSR_competition.svg", 
             gridExtra::grid.arrange(
               PSRComp_bar+labs(
                 title=NULL,
                  y="Obligations\n(Constant 2023 $s)",
               caption = NULL,x=NULL)+theme(legend.position = "none",text=element_text(size=12),
                                            plot.margin = margin(t=0,b=0,l=0.1,r=0.5,unit="inches")),
               PSRComp_line+labs(y="Share of\nObligations",caption=NULL)+theme(text=element_text(size=12),
               plot.caption = element_text(size=round(20 * 5/6,0)),
                                           plot.margin = margin(t=0,b=0,l=0.1,r=0.5,unit="inches"))),
             width=6.5, height= 4.5, units="in" #, size=20, lineheight = 0.75
             )

# 
# ggsave(file.path(online_path,"acq_fig6_6_PSR_competition_slide.png"), 
#              gridExtra::grid.arrange(
#                PSRComp_bar+labs(
#                   y="Obligations\n(Constant 2023 $s)",
#                caption = NULL,x=NULL)+theme(legend.position = "none",text=element_text(size=12),
#                                             plot.margin = margin(t=0,b=0,l=0.1,r=0.5,unit="inches")),
#                PSRComp_line+labs(y="Share of\nObligations",caption=NULL)+theme(text=element_text(size=20),
#                plot.caption = element_text(size=round(20 * 5/6,0)),
#                                            plot.margin = margin(t=0,b=0,l=0.1,r=0.5,unit="inches"))),
#              width=13, height= 5.5, units="in" #, size=20, lineheight = 0.75
#              )

ggsave(file.path(online_path,"acq_fig6_6_PSR_competition_slide.png"), 
             gridExtra::grid.arrange(
               PSRComp_bar+labs(
                  y="Obligations\n(Constant 2023 $s)",
               caption = NULL,x=NULL)+theme(legend.position = "none",text=element_text(size=12),
                                            plot.margin = margin(t=0,b=0,l=0.1,r=0.5,unit="inches")),
               PSRComp_line+labs(y="Share of\nObligations",caption=NULL)+theme(text=element_text(size=20),
               plot.caption = element_text(size=round(20 * 5/6,0)),
                                           plot.margin = margin(t=0,b=0,l=0.1,r=0.5,unit="inches"))),
             width=13, height= 5.5, units="in" #, size=20, lineheight = 0.75
             )

log_plot(plot=PSRComp_bar, df=def_data  %>% filter(Fiscal_YQ<=2025.2),
                     filename="acq_fig6_6_PSR_competition",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="6-6 PSRcomp",path="../output/AcqTrends/", height=3.5,
                     startRow=1,startCol=13,format=TRUE,var_list=c("SimpleArea","Competition.multisum"),
         output_doc_svg=FALSE,excel_y_var = TRUE, excel_formulas = TRUE, excel_share = TRUE,
         include_YTD=FALSE#,second_path = online_path
         )
```
## PSR Multi-Year
```{r PSRmultiyear}

(
PSRMultiYear<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 ),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="multiyearcontracttext", #color_var
  facet_var="SimpleArea",
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

def_data<-def_data %>% group_by(Fiscal_Year,SimpleArea)%>%
  mutate(pPlatFYear=Action_Obligation_OMB25_GDP23/sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))
(
PSRMultiYearShare<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & SimpleArea!="Unlabeled"&
                             (is.na(multiyearcontract)|multiyearcontract==1)),
  chart_geom = "Line Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="pPlatFYear", #VAR.y.variable
  color_var="multiyearcontracttext", #color_var
  facet_var="SimpleArea",
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Share of Obligations")+
    scale_y_continuous(labels = scales::percent)
)


ggsave600dpi(path="..//Output//AcqTrends//",filename="PSR_MultiYear.png", PSRMultiYear,  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="PSR_MultiYearShare.png", PSRMultiYearShare,  
             width=6.5, height= 4, units="in",size=12, lineheight=1.2
             )

# write.csv(file="..//Output//AcqTrends//PSRMultiYearShare.csv",row.names = FALSE, na = "",
#   pivot_wider(PSRMultiYearShare$data %>% select(-YTD) %>%
#                         arrange(dFYear) %>% mutate(Fiscal_Year=lubridate::year(dFYear)),
#                       id_cols=c(SimpleArea,multiyearcontracttext),
#                       names_from=Fiscal_Year,values_from=pPlatFYear)%>%
#   arrange(SimpleArea,multiyearcontracttext))
#   


```


# SubCustomer
## Topline SubCustomer 
```{r SubCustomer}

(
SubCustomer<-build_plot(
  data=def_data %>% filter(Fiscal_YQ<=2025.2),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SubCustomer.JPO", #color_var
  facet_var="SubCustomer.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",
       title="DOD Contract Obligations by DOD Component, FY 1990-FY 2025 Q2") +date_x_year_breaks(1990,2020,5,partial_year=2025,partial_label="\nQ1-Q2")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_subcustomer.png", SubCustomer, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_subcustomer.svg", SubCustomer+facet_wrap(~SubCustomer.sum,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

log_plot(plot=SubCustomer+facet_wrap(~SubCustomer.sum,nrow=1)+
           date_x_year_breaks(1990,2014,8,partial_year=2025,partial_label="\nQ1-Q2"),
         df=def_data %>% filter(Fiscal_YQ<=2025.2),
                     filename="nps_fig04_component",xlsx="DoD_2025_NPS.xlsx",
                     sheet="4 Cust",path="../output/AcqTrends/NPS2025/",second_path=online_path,
         height=3,include_YTD=FALSE,suppress_doc_svg_text="title",
                     startRow=1,format=TRUE,excel_y_var=TRUE,excel_formulas = TRUE,
         output_slide_png=TRUE
         )

```

## SubCustomer Plat Breakout
```{r SubCustomerPlatBreakout} 
platform_levels<-levels(factor(def_data$PlatformPortfolio))
for(p in platform_levels){
  file_p<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",p)))
  (Breakout<-build_plot(
    data=def_data %>% filter(Fiscal_Year>=2000&PlatformPortfolio==p& Fiscal_YQ<=2025.2),
chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SubCustomer.JPO", #color_var
  facet_var="SubCustomer.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)") +date_x_year_breaks(1990,2020,5,partial_year=2025,partial_label="\nQ1-Q2")
)
  if(!dir.exists(file.path("../output/AcqTrends/Platform",file_p)))
    dir.create(file.path("../output/AcqTrends/Platform",file_p))
  
  log_plot(plot=Breakout, df=def_data  %>% filter(Fiscal_YQ<=2025.2&PlatformPortfolio==p),
           filename=paste(file_p,"subcustomer",sep="_"),xlsx=paste("DoD",file_p,"Contracts.xlsx",sep="_"),
           sheet="Cust",path=file.path("../output/AcqTrends/Platform/",file_p), height=3.5,
           startRow=1,startCol=13,format=TRUE,#,var_list=c("PricingUCA.sumlong","PricingUCA"),
           output_doc_png=TRUE,excel_y_var=TRUE
           )
  
}
```

## SubCustomer Covid19
```{r SubCustomerCovid19}
cust_covid<-def_data %>% filter(Fiscal_YQ<=2025.2) %>% group_by(SubCustomer.JPO,SubCustomer.sum,Fiscal_Year) %>%
  summarise(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm = TRUE),
            COVID19obligated=sum(COVID19obligated,na.rm = TRUE))%>%
  mutate(Action_other=Action_Obligation_Then_Year-COVID19obligated) 

cust_covid %<>% select(-Action_Obligation_Then_Year) %>%
  pivot_longer(cols=c(COVID19obligated,Action_other),  
               names_to = "Covid",values_to="Action_Obligation") %>%
  mutate(SubCustomer.COVID=ifelse(Covid=="COVID19obligated","COVID19 Related",
                                  as.character(SubCustomer.JPO)))

cust_covid %<>% deflate( money_var="Action_Obligation",fy_var="Fiscal_Year")



(
SubCustomerCovid<-build_plot(
  data=cust_covid,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SubCustomer.COVID", #color_var
  facet_var="SubCustomer.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="subcustomer_covid.png", SubCustomerCovid, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="subcustomer_covid.svg", SubCustomerCovid+facet_wrap(~SubCustomer.sum,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

write.csv(file="..//Output//AcqTrends//subcustomer_covid.csv",row.names = FALSE, na = "",
          pivot_wider(SubCustomerCovid$data,id_cols=c(SubCustomer.sum,SubCustomer.COVID),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23))

write.csv(file="..//Output//AcqTrends//subcustomer_covid.csv",row.names = FALSE, na = "",
          cust_covid %>% group_by(SubCustomer.sum,SubCustomer.COVID,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(SubCustomer.sum,SubCustomer.COVID),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))


```

## SubCustomer Product/Service/R&D
```{r SubCustomerPSR}

(
SubCustomerPSR<-build_plot(
  data=def_data,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SimpleArea", #color_var
  facet_var="SubCustomer.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2023 $s)")
)

# ggsave600dpi(path="..//Output//AcqTrends//",filename="subcustomer_PSR.png", SubCustomerPSR, 
#              width=6.5, height= 4, units="in",size=11
#              )
ggsave600dpi(path="..//Output//AcqTrends//",filename="subcustomer_PSR.png", SubCustomerPSR, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )
```

## SubCustomer Competition
```{r SubCustomerComp}
def_data$SubCustomer.platform
(
SubCustomerComp_line<-build_plot(
  data=def_data %>% filter(Fiscal_YQ<=2025.2),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.effective.only", #color_var
  facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2023 $s)")
)

# ggsave600dpi(path="..//Output//AcqTrends//",filename="subcustomer_PSR.png", SubCustomerPSR, 
#              width=6.5, height= 4, units="in",size=11
#              )
ggsave600dpi(path="..//Output//AcqTrends//",filename="subcustomer_Comp_line.png", SubCustomerComp_line, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )

(
SubCustomerComp_bar<-build_plot(
  data=def_data %>% filter(Fiscal_YQ<=2025.2),
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="subcustomer_Comp_bar.png", SubCustomerComp_bar, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )


# write.csv(file="..//Output//AcqTrends//subcustomer_competition.csv",row.names = FALSE, na = "",
#           SubCustomerComp_line$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
#             pivot_wider(id_cols=c(SubCustomer.platform,Competition.effective.only),
#                         names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)%>%
#             arrange(SubCustomer.platform,Competition.effective.only))

```

## SubCustomer Pricing History
```{r SubCustomerPricing}
summary(factor(def_data$SubCustomer.platform))
(
PricingHistoryCust<-build_plot(
  data=def_data %>% filter(!SubCustomer.platform %in%
                                  c("DECA (Largely Unreported)","Uncategorized")&
                                  Fiscal_YQ<=2025.2),
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=hist_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingInflation", #color_var
  facet_var="SubCustomer.platform", #facet_var
  column_key=hist_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(1980,2023,10)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",
       caption="Note: Uncategorized customer not shown.\nSource: FPDS and CSIS analysis.")
)

# ggsave600dpi(path="..//Output//AcqTrends//",filename="SubCustomer_Pricing_History.png", PricingHistory, 
#              width=6.5, height= 4, units="in",size=11
#              )


ggsave600dpi(path="..//Output//AcqTrends//",filename="SubCustomer_Pricing_History.png", PricingHistoryCust,  
             width=6.5, height= 3, units="in",size=12, lineheight=1.2
             )


ggsave600dpi(path="..//Output//AcqTrends//",filename="SubCustomer_Pricing_History.svg", PricingHistoryCust,  
             width=6.5, height= 3, units="in",size=12, lineheight=1.2
             )

log_plot(plot=PricingHistoryCust, df=def_data  %>% filter(!SubCustomer.platform %in%
                                  c("DECA (Largely Unreported)","Uncategorized")&
                                  Fiscal_YQ<=2025.2),
                     filename="acq_pricing_history_subcust",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="PriceHistSubCust",path="../output/AcqTrends/", height=3.5,
                     format=TRUE#,var_list=c("PricingInflation")
         )

```


## SubCustomer Commercial
```{r SubCustomerCommercial}
def_data$AnyCommercialText<-factor(def_data$AnyCommercial)
levels(def_data$AnyCommercialText)<-list(
  "Not Classified\nas Commercial"="N",
  "Non-development\nor Commercial Similar"= "NonDev",
  "Any Commercial\nClassification"="Y"
  
)

(
CommercialCust<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<=2025.2),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="AnyCommercialText", #color_var
  facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")+
      date_x_year_breaks(2000,2023,6)#,partial_year=2024,partial_label="\nQ1")
    

)
 

ggsave600dpi(path="..//Output//AcqTrends//",filename="subcustomer_commercial.png", CommercialCust, 
             width=6, height= 5.5, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="subcustomer_commercial.svg", CommercialCust,#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",
             filename="subcustomer_commercial_keynote.png", CommercialCust+
               labs(title="DOD Contract Obligations by  Commercial Categorization, FY 2000–FY 2025 Q2"),
             width=13, height= 5.5, units="in", size=20, lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="subcustomer_commercial_keynote.svg", CommercialCust+
               labs(title="DOD Contract Obligations by  Commercial Categorization, FY 2000–FY 2025 Q2"),
             width=13, height= 5.5, units="in", size=20, lineheight = 1.2
             )


log_plot(plot=CommercialCust, df=def_data %>% filter(Fiscal_YQ<=2025.2),
                     filename="acq_fig5_5_subcustomer_commercial",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="5-5 CustComm",path="../output/AcqTrends/", height=4,
                     startRow=1,startCol=13,format=TRUE,
         var_list=c("SubCustomer.platform","AnyCommercialText"),
         output_doc_svg=TRUE
         )
log_plot(plot=CommercialCust, df=def_data %>% filter(Fiscal_YQ<=2025.2),
                     filename="nps_figXX_commercial_subcustomer",xlsx="DoD_2025_NPS.xlsx",
                     sheet="5 Comm",path="../output/AcqTrends/NPS2025/",second_path=online_path,
         height=4,include_YTD=FALSE,suppress_doc_svg_text="title",output_slide_png=TRUE,
                     startRow=1,format=TRUE,excel_y_var=TRUE,excel_formulas = TRUE,
         output_doc_svg=TRUE
         )


```

## Subcustomer GFE
```{r GFE subcustomer}

(
GFEcust<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<=2025.2) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="gfe_gfp_value", #color_var
  facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")+
      date_x_year_breaks(2000,2022,2)#,partial_year=2024,partial_label="\nOct–Nov")

)



```



# Platform
## Topline  Platform
```{r Platform}
(
Platform<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=1990 & Fiscal_YQ<=2025.2),
  chart_geom = "Line Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PlatformPortfolio", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE,
  hide_unlabeled =TRUE
)+date_x_year_breaks(1990,2020,8,partial_year=2025,partial_label="\nQ1-Q2") +  
      facet_wrap(.~PlatformPortfolio ,nrow=2)+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)",
       title="DOD Contract Obligations by Platform Portfolio, FY 1990-FY 2025 Q2")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_platform.png", Platform, 
             width=12, height= 6, units="in",size=14,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_platform.svg", Platform, 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_platform.emf", Platform+geom_line(
  size=1,aes(x=dFYear,y=Action_Obligation_OMB25_GDP23,color=PlatformPortfolio)),
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )


(
Platform_Bar<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=1990 & Fiscal_YQ<=2025.2),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PlatformPortfolio", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE,
  hide_unlabeled =TRUE
)+date_x_year_breaks(1990,2020,8,partial_year=2025,partial_label="\nQ1-Q2") +  
    facet_wrap(.~PlatformPortfolio ,nrow=2)+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)",
       title="DOD Contract Obligations by Platform Portfolio, FY 1990-FY 2025 Q2")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_platform_bar.png", Platform_Bar, 
             width=11, height= 5.5, units="in",size=14,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_platform_bar.emf", Platform_Bar,
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_platform_bar_keynote.svg", Platform_Bar+
               labs(title="DOD Contract Obligations by Platform Portfolio, FY 2000–FY 2025 Q2"),
             width=13, height= 5.5, units="in", size=20, lineheight = 0.75
             )

log_plot(plot=Platform_Bar+theme(plot.margin = margin(t=0,r=0.25,b=0.1,l=0.1,"inches")), df=def_data   %>% filter(Fiscal_YQ<=2025.2),
                     filename="nps_fig03_platform",xlsx="DoD_2025_NPS.xlsx",
                     sheet="3 Plat",path="../output/AcqTrends/NPS2025/",#second_path=online_path,
         height=3.5,include_YTD=FALSE,suppress_doc_svg_text="title",output_slide_png=TRUE,
                     startRow=1,format=TRUE,excel_y_var=TRUE,excel_formulas = TRUE,
         output_doc_svg=TRUE
         )


```

## Plat Cust Breakout
```{r PlatCustBreakout} 
subcustomer_levels<-levels(factor(def_data$SubCustomer.sum))
for(c in subcustomer_levels){
  file_c<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",c)))
  (Breakout<-build_plot(
    data=def_data %>% filter(Fiscal_Year>=2000&SubCustomer.sum==c& Fiscal_YQ<=2025.2),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PlatformPortfolio", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(1990,2020,8,partial_year=2025,partial_label="\nQ1-Q2") +  
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)
  
  if(!dir.exists(file.path("../output/AcqTrends/Customer",file_c)))
    dir.create(file.path("../output/AcqTrends/Customer",file_c))
  
  log_plot(plot=Breakout, df=def_data  %>% filter(Fiscal_YQ<=2025.2&SubCustomer.sum==c),
           filename=paste(file_c,"platform",sep="_"),xlsx=paste(file_c,"Contracts.xlsx",sep="_"),
           sheet="Plat",path=file.path("../output/AcqTrends/Customer/",file_c), height=3.5,
           startRow=1,startCol=13,format=TRUE,#,var_list=c("PricingUCA.sumlong","PricingUCA"),
           output_doc_png=TRUE,excel_y_var=TRUE
           )
  
}
```



## Platform by Service
```{r PlatformService}
for(s in c("Army","Navy","Air Force")){
  
  (
    Platform<-build_plot(
      data=def_data %>% filter(SubCustomer.sum==s),
      chart_geom = "Line Chart",
      share = FALSE,
      labels_and_colors=def_lc,
      # NA, #VAR.ncol
      x_var="dFYear",alpha_var="YTD", #x_var
      y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
      color_var="PlatformPortfolio", #color_var
      facet_var="PlatformPortfolio", #facet_var
      column_key=def_ck,
      format=TRUE,
      ytextposition=FALSE
    )+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
      # theme(strip.text.y = element_text(angle=0))+
      # theme(axis.text.x = element_text(angle=90))+
      #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
      #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
      #             )+labs(title=NULL,
      # x="Fiscal Year",
      # y="Percent of Obligations",
      # color="Competition")+
      theme(legend.position = "none")+
      labs(y="Obligations (Constant 2023 $s)")
  )
  
  ggsave600dpi(paste("..//Output//AcqTrends//",s,"_platform.png",sep=""), Platform, 
               width=12, height= 6, units="in",size=14,lineheight = 1.2
  )
  
  ggsave600dpi(paste("..//Output//AcqTrends//",s,"_platform.svg",sep=""), Platform, 
               width=6.5, height= 4, units="in",size=11,lineheight = 1.2
  )
  
  ggsave600dpi(paste("..//Output//AcqTrends//",s,"_platform.emf",sep=""), Platform+geom_line(
    size=1,aes(x=dFYear,y=Action_Obligation_OMB25_GDP23,color=PlatformPortfolio)),
    width=6.5, height= 4, units="in",size=11,lineheight = 1.2
  )
}
# 
# (
# Platform_Bar<-build_plot(
#   data=def_data,
#   chart_geom = "Bar Chart",
#   share = FALSE,
#   labels_and_colors=def_lc,
#   # NA, #VAR.ncol
#   x_var="dFYear",alpha_var="YTD", #x_var
#   y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
#   color_var="PlatformPortfolio", #color_var
#   facet_var="PlatformPortfolio", #facet_var
#   column_key=def_ck,
#   format=TRUE,
#   ytextposition=FALSE
# )+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
#   # theme(strip.text.y = element_text(angle=0))+
#  # theme(axis.text.x = element_text(angle=90))+
#  #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
#  #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
#  #             )+labs(title=NULL,
#   # x="Fiscal Year",
#   # y="Percent of Obligations",
#   # color="Competition")+
#   theme(legend.position = "none")+
#   labs(y="Obligations (Constant 2023 $s)")
# )
# 
# ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_platform_bar.png", Platform_Bar, 
#              width=12, height= 6, units="in",size=12,lineheight = 1.2
#              )
# 
# ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_platform_bar.emf", Platform_Bar,
#              width=6.5, height= 4, units="in",size=11,lineheight = 1.2
#              )
# 
# write.csv(file="..//Output//AcqTrends//topline_platform_current.csv",row.names = FALSE, na = "",
#           def_data %>% group_by(PlatformPortfolio,Fiscal_Year)%>%
#             dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
#           pivot_wider(id_cols=c(PlatformPortfolio),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%arrange(PlatformPortfolio))
# 
# wb <- loadWorkbook("..//Output//AcqTrends//DoD_Acq_Trends_Contracts.xlsx")
# createSheet(wb, name = "Platform Portfolio")
# writeData(wb, output_TY, sheet = "Platform Portfolio", startRow = 15, startCol = 13)
# saveWorkbook(wb,file="..//Output//AcqTrends//DoD_Acq_Trends_Contracts.xlsx",overwrite = TRUE)

```

## Platform SubCustomer
```{r PlatformSubCustomer}

(
PlatformSubCustomer<-build_plot(
  data=def_data,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SubCustomer.platform", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="platform_subcustomer.png", PlatformSubCustomer, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

```

## Platform PSR
```{r PlatformPSR}

(
PlatformPSR<-build_plot(
  data=def_data,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SimpleArea", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="platform_PSR.png", PlatformPSR, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

```


## Platform Products
```{r PlatformProduct}
summary(def_data$SimpleArea)
(
PlatformProducts<-build_plot(
  data=def_data %>% filter(SimpleArea=="Products (All)"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SimpleArea", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="platform_products.png", PlatformProducts, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

write.csv(file="..//Output//AcqTrends//platform_products_cur.csv",row.names = FALSE, na = "",
          def_data%>% filter(SimpleArea=="Products (All)") %>% 
            mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            group_by(PlatformPortfolio, SimpleArea,Fiscal_Year) %>%
            summarise(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE)) %>%
            pivot_wider(id_cols=c(PlatformPortfolio, SimpleArea),
                        names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(PlatformPortfolio,SimpleArea))



```

## Platform R&D
```{r PlatformRnD}
(
PlatformRnD<-build_plot(
  data=def_data %>% filter(SimpleArea=="R&D"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SimpleArea", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="PlatformRnD.png", PlatformRnD, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

```
  
## Platform Quarter
```{r PlatformQ}
(
PlatformQ<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2013 & Fiscal_YQ<=2025.2),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="fiscal_quarter_YTD", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2013,2020,4)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

(
OnMQ<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<=2025.2 &
                             PlatformPortfolio=="Ordnance and Missiles"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="fiscal_quarter_YTD", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2020,8)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
    theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)


ggsave600dpi(path="..//Output//AcqTrends//",filename="PlatformQ.png", PlatformQ, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="PlatformQ_slide.svg", PlatformQ+
               labs(title="DOD Contract Obligations by Platform Portfolio, FY2013-FY2024 Oct-Nov")+
               theme(plot.title = element_text(margin=margin(t=0.1,r=0,b=0.1,l=0,"inches")),
                     plot.margin = margin(t=0,r=0.1,b=0.1,l=0.1,"inches")), 
             width=10, height= 5.5, units="in", size=11, lineheight = 0.75
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="PlatformQ_keynote.svg", PlatformQ+
               labs(title="Ordnance & Missile Contract Obligations, FY 2000–FY 2025 Q2"),
             width=9, height= 5.5, units="in", size=20, lineheight = 0.75
             )


ggsave600dpi(path="..//Output//AcqTrends//",filename="OnMQ_keynote.png", OnMQ+
               labs(title="Ordnance & Missile Contract Obligations, FY 2000–FY 2025 Q2"),
             width=9, height= 5.5, units="in", size=20, lineheight = 0.75
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="OnMQ_keynote.svg", OnMQ+
               labs(title="Ordnance & Missile Contract Obligations, FY 2000–FY 2025 Q2"),
             width=9, height= 5.5, units="in", size=20, lineheight = 0.75
             )



ggsave600dpi(path="..//Output//AcqTrends//",filename="OnMQ.png", OnMQ, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )


output_TY<-def_data %>% group_by(PlatformPortfolio,Fiscal_Year,fiscal_quarter_YTD)%>%
  filter(Fiscal_Year>=2000 & as.character(fiscal_quarter_YTD)<=1)%>%
            dplyr::summarize(Action_Obligation_Then_Year=
                               sum(Action_Obligation_Then_Year,na.rm=TRUE),
                             max_fq=max(as.character(fiscal_quarter_YTD)))%>%
          pivot_wider(id_cols=c(PlatformPortfolio,max_fq),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
  arrange(PlatformPortfolio,max_fq)

write.csv(file="..//Output//AcqTrends//platform_YTD_current.csv",row.names = FALSE, na = "",
          output_TY)



output_TY<-def_data %>% group_by(PlatformPortfolio,Fiscal_Year,fiscal_quarter_YTD)%>%
  filter(Fiscal_Year>=2000)%>%
            dplyr::summarize(Action_Obligation_Then_Year=
                               sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(PlatformPortfolio,fiscal_quarter_YTD),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
  arrange(PlatformPortfolio,fiscal_quarter_YTD)

write.csv(file="..//Output//AcqTrends//platform_quarter_current.csv",row.names = FALSE, na = "",
          output_TY)

```


## Platform Vendor
```{r PlatformVendor}

(
PlatformVendor_share<-build_plot(
  data=def_data %>% filter(PlatformPortfolio!="Unlabeled" & Fiscal_Year<=2020) ,
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Percent of Obligations",
    caption="Note: McDonnell Douglas is grouped with the Big-5.\nSource: FPDS and CSIS analysis.")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="platform_vendor_share.png", PlatformVendor_share, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )



(
PlatformVendor_dollar<-build_plot(
  data=def_data %>% filter(PlatformPortfolio!="Unlabeled" & Fiscal_Year<=2020) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Percent of Obligations",
    caption="Note: The merger of Raytheon and United Technologies took place in April of 2020 and thus did not\nmake the cutoff for inclusion in FY2020. McDonnell Douglas is grouped with the Big-5.\n\nSource: FPDS and CSIS analysis.")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="platform_vendor_dollar.png", PlatformVendor_dollar, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

write.csv(file="..//Output//AcqTrends//platform_vendor.csv",row.names = FALSE, na = "",
          PlatformVendor_dollar$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlatformPortfolio,Shiny.VendorSize),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)%>%
            arrange(PlatformPortfolio,Shiny.VendorSize))


```



## Platform Comp
```{r PlatformComp}
# labels_and_colors<-def_lc
# column_key<-def_ck
(
PlatformComp_bar<-build_plot(
  data=def_data %>% filter(PlatformPortfolio!="Unlabeled"  &Fiscal_Year>=1991 & Fiscal_YQ<=2025.2),
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = scales::date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")#+
  # labs(y="Obligations (Constant 2023 $s)")
)

(
PlatformComp_bar2007<-build_plot(
  data=def_data %>% filter(PlatformPortfolio!="Unlabeled"  &Fiscal_Year>=2007 & Fiscal_YQ<=2025.2),
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2007,2023,4)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")#+
  # labs(y="Obligations (Constant 2023 $s)")
)


(
PlatformComp_line<-build_plot(
  data=def_data %>% filter(PlatformPortfolio!="Unlabeled" &Fiscal_Year>=1992 & Fiscal_YQ<=2025.2),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.effective.only", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = scales::date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")#+
  # labs(y="Obligations (Constant 2023 $s)")
)


ggsave600dpi(path="..//Output//AcqTrends//",filename="platform_comp_bar.png", PlatformComp_bar, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )


ggsave600dpi(path="..//Output//AcqTrends//",filename="platform_comp_line.png", PlatformComp_line, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

# write.csv(file="..//Output//AcqTrends//platform_comp.csv",row.names = FALSE, na = "",
#           PlatformComp_line$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
#             pivot_wider(id_cols=c(PlatformPortfolio,Competition.effective.only),
#                         names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)%>%
#             arrange(PlatformPortfolio,Competition.effective.only))


```




### Platform Only One Source 
```{r PlatNoComp}
summary(def_data$gfe_gfp_code)
(
PlatNoComp<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<=2025.2 & !is.na(PlatformPortfolio)&
                             PlatformPortfolio!="Unlabeled") ,
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="No.Competition.sum", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")+
    scale_x_date(breaks=as.Date(c(paste(seq(2000,2021,3),"-01-01",sep=""))),
                                                   date_labels="'%y")
)
```

## Platform Commercial
```{r PlatformCommercial}
def_data$AnyCommercialText<-factor(def_data$AnyCommercial)
levels(def_data$AnyCommercialText)<-list(
  "Not Classified\nas Commercial"="N",
  "Non-Development\nor Commercial Similar"= "NonDev",
  "Any Commercial\nClassification"="Y"
  
)


(
CommercialPlat<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="AnyCommercialText", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="platform_commercial.png", CommercialPlat, 
             width=6, height= 5.5, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="platform_commercial.svg", CommercialPlat,#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="platform_commercial.emf", CommercialPlat,#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )


write.csv(file="..//Output//AcqTrends//platform_commercial.csv",row.names = FALSE, na = "",
          CommercialPlat$data%>%mutate(Fiscal_Year=year(dFYear)) %>%
          pivot_wider(id_cols=c(PlatformPortfolio,AnyCommercialText),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23))

write.csv(file="..//Output//AcqTrends//platform_commercial_current.csv",row.names = FALSE, na = "",
          def_data %>% group_by(PlatformPortfolio,AnyCommercialText,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(PlatformPortfolio,AnyCommercialText),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(PlatformPortfolio,AnyCommercialText))

```



## Platform Multi-Year
```{r PlatformMultiyear}

    def_data<-def_data%>% mutate(multiyearcontracttext=factor(multiyearcontract,levels=c("0","1"),
                              labels=c("Not Multi-Year","Multi-Year Contract")))



def_data<-def_data %>% group_by(Fiscal_Year,PlatformPortfolio)%>%
  mutate(pPlatFYear=Action_Obligation_OMB25_GDP23/sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))

(
PlatformMultiYear<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<=2025.2 &  (multiyearcontract==1)
                           & !is.na(PlatformPortfolio)&
                              PlatformPortfolio!="Unlabeled"),
  chart_geom = "Line Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  # color_var="SubCustomer.JPO", #color_var
  facet_var="PlatformPortfolio",
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2023,7,partial_year=2025,partial_label="\nQ1-Q2")+ 
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)",
       title="DOD Contract Obligations to Multi-Year Procuement\nby Platform, FY 2000–FY 2025 Q2",
       caption="Note: When the multi-year column is blank, transactions are treated as not multiyear. Unlabeled platform not shown.\nSource: FPDS and CSIS analysis.")
)



(
PlatformMultiYearSubCust<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<=2025.2 &  (multiyearcontract==1)
                           & !is.na(PlatformPortfolio)&
                              PlatformPortfolio!="Unlabeled"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SubCustomer.JPO", #color_var
  facet_var="PlatformPortfolio",
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2023,7,partial_year=2025,partial_label="\nQ1-Q2")+ 
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2023 $s)",
       title="DOD Contract Obligations to Multi-Year Procuement\nby Platform and Component, FY 2000–FY 2025 Q2",
       caption="Note: When the multi-year column is blank, transactions are treated as not multiyear. Unlabeled platform not shown.\nSource: FPDS and CSIS analysis.")
)

def_data<-def_data %>% group_by(Fiscal_Year,PlatformPortfolio)%>%
  mutate(pPlatFYear=Action_Obligation_OMB25_GDP23/sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))
(
PlatformMultiYearShare<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<=2025.2 &
                             (multiyearcontract==1)&
                              !is.na(PlatformPortfolio)&
                              PlatformPortfolio!="Unlabeled"), #is.na(multiyearcontract)|
  chart_geom = "Line Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",
  alpha_var="YTD", #x_var
  y_var="pPlatFYear", #VAR.y.variable
  # color_var="multiyearcontracttext", #color_var
  facet_var="PlatformPortfolio",
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2023,7,partial_year=2025,partial_label="\nQ1-Q2")+ 
    
  theme(legend.position = "none")+
  labs(y="Share of Portfolio Obligations\nGoing to Multi-Year Contracts",
       caption="Note: When the multi-year column is blank, transactions are treated as not multiyear. Unlabeled platform not shown.\nSource: FPDS and CSIS analysis.",
       title="Share of DOD Contract Obligations to Multi-Year Procuement\nby Platform, FY 2000–FY 2025 Q2")+
    scale_y_continuous(labels = scales::percent)
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="Platform_MultiYear.png", PlatformMultiYear,  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="Platform_MultiYearShare.png", PlatformMultiYearShare+facet_wrap(PlatformPortfolio~.,nrow=2)+
                labs(y="Share of Obligations",
       caption="When the multi-year column is empty, transactions are treated as not multiyear.\nSource: FPDS and CSIS analysis."),  
             width=13, height= 5.5, units="in",size=20, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="Platform_MultiYearShare_keynote.png", 
               PlatformMultiYearShare+labs(
                 title="DOD Share of Contract Obligations to Multi-Year Contracts, FY 2000–FY 2025 Q2")+
                 facet_wrap(PlatformPortfolio~.,nrow=2)+
                labs(y="Share of Obligations",
       caption="Note: When the multi-year column is empty, transactions are treated as not multiyear.\nSource: FPDS and CSIS analysis."),#+geom_line(aes(x=dFYear,y=pPlatFYear,group=YTD,linetype=YTD),linewidth=2),  
             width=13, height= 5.5, units="in",size=20, lineheight=1.2
             )


  
log_plot(PlatformMultiYearShare, def_data %>% filter(Fiscal_YQ<=2025.2) ,
                     filename="acq_fig4_2_multiyear",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="4-2 Multi",path="../output/AcqTrends/", height=3.5,excel_y_var = TRUE,excel_formulas = FALSE,
                     startRow=1,startCol=13,format=TRUE,y_var="Action_Obligation_OMB25_GDP23",
         var_list=c("PlatformPortfolio","multiyearcontracttext"),
         )


log_plot(plot=PlatformMultiYearSubCust+facet_wrap(PlatformPortfolio~.,nrow=2),
         df=def_data %>% filter(Fiscal_Year>=2000 &Fiscal_YQ<=2025.2),
                     filename="nps_fig07b_multiyearCust",xlsx="DoD_2025_NPS.xlsx",
                     sheet="7b MultCust",path="../output/AcqTrends/NPS2025/",
         second_path = online_path,
         height=3.5,include_YTD=FALSE,csv_then_year = FALSE,excel_then_year = FALSE,
                     format=TRUE,excel_y_var=TRUE,excel_formulas = TRUE,
         suppress_doc_svg_text="title",output_slide_png=TRUE
         #,var_list=c("multiyearcontract","PlatformPortfolio")
         )

ggsave600dpi(path="..//Output//AcqTrends//NPS2025/",filename="nps_fig07c_multiyear_slide.png", PlatformMultiYear+facet_wrap(PlatformPortfolio~.,nrow=2),  second_path = online_path,
             width=13, height= 5.5, units="in",size=20, lineheight=1.2
)


log_plot(plot=PlatformMultiYearShare+facet_wrap(PlatformPortfolio~.,nrow=2),
         df=def_data %>% filter(Fiscal_Year>=2000 &Fiscal_YQ<=2025.2),
                     filename="nps_fig07a_multiyear",xlsx="DoD_2025_NPS.xlsx",
                     sheet="7a Mult",path="../output/AcqTrends/NPS2025/",
         second_path = online_path,y_var="Action_Obligation_OMB25_GDP23",
         height=3.5,include_YTD=FALSE,csv_then_year = FALSE,excel_then_year = FALSE,
                     startRow=1,format=TRUE,excel_y_var=TRUE,excel_formulas = TRUE,
         suppress_doc_svg_text="title",output_slide_png=TRUE,
         output_doc_svg=TRUE,var_list=c("multiyearcontract","PlatformPortfolio")
         )

```


## Platform GFE
```{r GFEplatform}
def_data<-def_data %>% group_by(Fiscal_Year,PlatformPortfolio)%>%
  mutate(pPlatFYear=Action_Obligation_OMB25_GDP23/sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))
def_data$gfe_gfp_code
(
PlatformGFEshare<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<=2025.2 & gfe_gfp_code=="Y"&
                             !is.na(PlatformPortfolio) & PlatformPortfolio!="Unlabeled") ,
  chart_geom = "Line Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  # color_var="gfe_gfp_value", #color_var
  y_var="pPlatFYear", #VAR.y.variable
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  date_x_year_breaks(2007,2023,4)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "bottom")+
  labs(y="Share of Portfolio Obligations\nwith Government Furnished Equipment or Property"
       # caption="Note: When the multi-year column is blank, transactions are treated as not multiyear.\nSource: FPDS and CSIS analysis."
       )+
    scale_y_continuous(labels = scales::percent)
)

log_plot(PlatformGFEshare, def_data%>% filter(Fiscal_Year>=2007 & Fiscal_YQ<=2025.2 & gfe_gfp_code=="Y"&
                             !is.na(PlatformPortfolio) & PlatformPortfolio!="Unlabeled") ,
                     filename="acq_fig4_3_gfe",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="4-3 GFE",path="../output/AcqTrends/", height=3,excel_y_var = TRUE,excel_formulas = FALSE,
                     startRow=1,startCol=13,format=TRUE,y_var="Action_Obligation_OMB25_GDP23"
         # var_list=c("PlatformPortfolio","gfe_gfp_value"),
         )

log_plot(PlatformGFEshare+
           labs(y="Share of Obligations\nwith Government Furnished\nEquipment or Property",
                caption=NULL) , def_data%>% 
           filter(Fiscal_Year>=2007 & Fiscal_YQ<=2025.2 & gfe_gfp_code=="Y"&
                    !is.na(PlatformPortfolio) & PlatformPortfolio!="Unlabeled"),
                     filename="nps_figXX_gfe_plat",xlsx="DoD_2025_NPS.xlsx",
         sheet="9 GFE",
          path="../output/AcqTrends/NPS2025/",second_path=online_path,
         height=3,include_YTD=FALSE,excel_then_year = FALSE, csv_then_year = FALSE,
                     startRow=1,format=TRUE,excel_y_var=TRUE,excel_formulas = TRUE,
         output_doc_svg=TRUE
         )
         

ggsave(file=file.path(online_path,"acq_fig4_3_com_gfe.svg"),
       gridExtra::grid.arrange(
         PlatformComp_bar2007+labs(
           title=NULL,
           y="Share of Obligations by \nExtent of Competition\n",
           caption = NULL,x=NULL)+theme(legend.position = "bottom",text=element_text(size=12),
                                        plot.margin = margin(t=0,b=0,l=0.1,r=0.5,unit="inches")),
         PlatformGFEshare+labs(
           y="Share of Obligations\nwith Government Furnished\nEquipment or Property",caption=NULL)+theme(text=element_text(size=12),
                                                                                                                                        plot.caption = element_text(size=round(20 * 5/6,0)),
                                                                                                                                        plot.margin =
                                                                                                                                          margin(t=0,b=0,l=0.1,r=0.5,unit="inches")),
         layout_matrix = rbind(1,1,1,2,2)),
       width=6.5, height= 6.5, units="in") #, size=20, lineheight = 0.75

```


# Vendor Size


## Topline Vendor Size
```{r ToplineVendor}

(
ToplineVendor<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=1991& Fiscal_YQ<=2025.2  ),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  alpha_var="YTD",
  # facet_var="Competition.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
  # first_color_on_bottom = TRUE
)+date_x_year_breaks(1990,2020,5,partial_year=2025,partial_label="\nQ1-Q2")+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(title="DOD Contract Obligations by Vendor Size, FY 2000-FY 2025 Q2",
    y="Obligations (Constant 2023 $s)",
       caption="Source: FPDS and CSIS analysis.")
)

(
ToplineVendor_line<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=1991&Fiscal_YQ<=2025.2),
  chart_geom = "Line Chart",
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  # facet_var="Competition.sum", #facet_var
  alpha_var="YTD",
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE,
  share=TRUE#,
  # first_color_on_bottom = TRUE
)+date_x_year_breaks(1990,2014,8,partial_year=2025,partial_label="\nQ1-Q2")+
    
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April of 2020\n and thus did not make the cutofff for inclusion in FY2020.")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_vendor_wide.png", ToplineVendor+
  labs(y="Obligations (Constant 2023 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=12, height= 6, units="in",size=12,lineheight=1
             )


ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_vendor_cq.png", ToplineVendor+
  labs(y="Obligations (Constant 2023 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April\nof 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_vendor_cq.svg", ToplineVendor+
  labs(y="Obligations (Constant 2023 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April\nof 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_vendor.png", ToplineVendor, 
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_vendor.eps", ToplineVendor+
  labs(y="Obligations (Constant 2023 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April\nof 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )



log_plot(plot=ToplineVendor, df=def_data  %>% filter(Fiscal_YQ<=2025.2 ),
                     filename="acq_fig6_X_vendor",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="6-X Vend",path="../output/AcqTrends/", height=3.5,
                     startRow=1,startCol=12,format=TRUE,#,var_list=c("SimpleArea","Competition.multisum")
         )



```




## Vendor Size Plat Breakout
```{r VendorSizePlatBreakout} 
platform_levels<-levels(factor(def_data$PlatformPortfolio))
for(p in platform_levels){
  file_p<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",p)))
  (Breakout<-build_plot(
    data=def_data %>% filter(Fiscal_Year>=2000&PlatformPortfolio==p& Fiscal_YQ<=2025.2),
chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  # facet_var="SubCustomer.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)") +date_x_year_breaks(1990,2020,5,partial_year=2025,partial_label="\nQ1-Q2")
)
  if(!dir.exists(file.path("../output/AcqTrends/Platform",file_p)))
    dir.create(file.path("../output/AcqTrends/Platform",file_p))
  
  log_plot(plot=Breakout, df=def_data  %>% filter(Fiscal_YQ<=2025.2&PlatformPortfolio==p),
           filename=paste(file_p,"vendor",sep="_"),xlsx=paste("DoD",file_p,"Contracts.xlsx",sep="_"),
           sheet="vend",path=file.path("../output/AcqTrends/Platform/",file_p), height=3.5,
           startRow=1,format=TRUE,#,var_list=c("PricingUCA.sumlong","PricingUCA"),
           output_doc_png=TRUE,excel_y_var=TRUE
           )
  
}
```



## Vendor Size Vehicle
```{r VendorSizeVehicle}


(
VendorSizeVehicle<-build_plot(
  data=def_data %>% filter(Fiscal_Year<=2021 & Fiscal_Year>2000 & Shiny.VendorSize!="Unlabeled"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Vehicle.sum", #color_var
  facet_var="Shiny.VendorSize", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = scales::date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",
       caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April 2020 and thus did not make the cutofff for inclusion in FY2020.")
)


(
VendorSizeVehicleSum<-build_plot(
  data=def_data %>% filter(Fiscal_Year<=2021 & Fiscal_Year>2000 & !Shiny.VendorSize=="Unlabeled"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Vehicle.AwardTask", #color_var
  facet_var="Shiny.VendorSize", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+facet_wrap(~Shiny.VendorSize, nrow=1)+
  labs(y="Obligations (Constant 2023 $s)",
       caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April 2020 and thus did not make the cutofff for inclusion in FY2020.\nUnlabeled vendor size excluded.")
)

(
VendorSizeVehicleSumLine<-build_plot(
  data=def_data %>% filter(Fiscal_Year<=2021 & Fiscal_Year>2000 & !is.na(Shiny.VendorSize)&
                              Shiny.VendorSize!="Unlabeled"),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Vehicle.AwardTask", #color_var
  facet_var="Shiny.VendorSize", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",
       caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April 2020 and thus did not make the cutofff for inclusion in FY2020.")+facet_wrap(~Shiny.VendorSize, nrow=1)
)


ggsave600dpi(path="..//Output//AcqTrends//",filename="vendorsize_vehicle.png", VendorSizeVehicle+
  labs(y="Obligations (Constant 2023 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies is took place in \nApril 2020 and thus did not make the cutofff for inclusion in FY2020.\nUnlabeled vendor size excluded."),
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="vendorsize_vehicle.svg", VendorSizeVehicle+
  labs(y="Obligations (Constant 2023 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies is took place in \nApril 2020 and thus did not make the cutofff for inclusion in FY2020\nUnlabeled vendor size excluded.."),
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="vendorsize_awardtaskshare.svg", VendorSizeVehicleSumLine
+
  labs(caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies is took place in \nApril 2020 and thus did not make the cutofff for inclusion in FY2020.\nUnlabeled vendor size excluded."),
             width=6.5, height= 3.25, units="in",size=11,lineheight=1
             )


ggsave600dpi(path="..//Output//AcqTrends//",filename="vendorsize_awardtask.svg", VendorSizeVehicleSum
+
  labs(y="Obligations (Constant 2023 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies is took place in \nApril 2020 and thus did not make the cutofff for inclusion in FY2020.\nUnlabeled vendor size excluded."),
             width=6.5, height= 3.25, units="in",size=11,lineheight=1
             )

write.csv(file="..//Output//AcqTrends//vendorsize_vehicle_current.csv",row.names = FALSE, na = "",
          def_data %>% group_by(Shiny.VendorSize,Vehicle.sum,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(Shiny.VendorSize,Vehicle.sum),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(Shiny.VendorSize,Vehicle.sum))


write.csv(file="..//Output//AcqTrends//vendorsize_AwardTask_current.csv",row.names = FALSE, na = "",
          def_data %>% group_by(Shiny.VendorSize,Vehicle.AwardTask,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(Shiny.VendorSize,Vehicle.AwardTask),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(Shiny.VendorSize,Vehicle.AwardTask))

```

## Vendor Size Commercial
```{r SizePlatform}



(
ToplineVendor_line<-build_plot(
  data=def_data %>% filter(Fiscal_YQ<=2025.2 &  Fiscal_Year>=2000 & !is.na(SimpleArea) & SimpleArea!="Unlabeled"),
  chart_geom = "Line Chart",
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  facet_var="AnyCommercial", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE,
  share=TRUE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April of 2020\n and thus did not make the cutofff for inclusion in FY2020.")
)

(
ToplineVendor_line<-build_plot(
  data=def_data %>% filter(Fiscal_YQ<=2025.2 &  Fiscal_Year>=2000 & !is.na(SimpleArea) & SimpleArea!="Unlabeled"),
  chart_geom = "Bar Chart",
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="AnyCommercial", #color_var
  facet_var="Shiny.VendorSize", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE,
  share=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April of 2020\n and thus did not make the cutofff for inclusion in FY2020.")
)



```


## Vendor Size Pricing
```{r VendorSizePricing}
def_data$PricingUCA.1year<-as.character(def_data$PricingUCA.sum)
def_data$PricingUCA.1year[def_data$CurrentDurationIsYear=="<=1 year"]<-"<=1 Year (All Types)"



(
VendorSizePricing<-build_plot(
  data=def_data %>% filter(Fiscal_YQ<=2025.2 & Fiscal_Year>2000 & Shiny.VendorSize!="Unlabeled" &
                             PricingUCA.sum!="Unclear"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingUCA.sum", #color_var
  facet_var="Shiny.VendorSize", #facet_var
  # second_var="CurrentDurationIsYear",
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",
       caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April 2020 and thus did not make the cutofff for inclusion in FY2020.")
)


  
def_lc<-prepare_labels_and_colors(def_data,path=local_path)

(
VendorSizePricing20212022share<-build_plot(
  data=def_data %>% filter(Fiscal_Year %in% c(2021, 2022)& Shiny.VendorSize!="Unlabeled" & CurrentDurationIsYear!="Unlabeled"&
                             PricingUCA.sum!="Unclear"),
  chart_geom = "Bar Chart",
  share = TRUE,
  # NA, #VAR.ncol
  x_var="PricingUCA.1year", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingUCA.1year", #color_var
  facet_var="Shiny.VendorSize", #facet_var
  second_var="Fiscal_Year",
  labels_and_colors=def_lc,
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+coord_flip()+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = scales::percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
    scale_y_continuous(breaks=c(0,0.2,0.4), labels=scales::percent)+
  theme(legend.position = "none",
        plot.caption = element_text(hjust = 0,face="plain"),
        axis.text.x=element_text(angle=0))+
    
  labs(y="Share of Obligations",
       x="Pricing Mechanism for Contracts\nPlanned to Last More Than a Year",
       caption="Note: Categories are mutully exclusive. Less than 0.1 percent of data is unlabeled and not shown.\nSource: FPDS and CSIS analysis.")
)

log_plot(plot=VendorSizePricing20212022share+
               facet_grid(Fiscal_Year~Shiny.VendorSize), df=def_data   ,x_var="Fiscal_Year",
                     filename="acq_fig8_1_vend_price",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="8-1 VendPrice",path="../output/AcqTrends/", height=3.5,
                     format=TRUE,excel_y_var=TRUE,excel_formulas=TRUE,
               var_list=c("Shiny.VendorSize","PricingUCA.1year"),
         output_doc_svg=TRUE
         )

ggsave600dpi(path="..//Output//AcqTrends//",filename="vendorsize_pricing.png", VendorSizePricing+
  labs(y="Obligations (Constant 2023 $s)",caption="Source: FPDS and CSIS analysis."),
             width=6, height= 5, units="in",size=12,lineheight=1
             )


write.csv(file="..//Output//AcqTrends//vendorsize_pricing_current.csv",row.names = FALSE, na = "",
          def_data %>% group_by(Shiny.VendorSize,PricingUCA.sum,Fiscal_Year)%>%
            filter(Fiscal_Year>=2000 & Fiscal_YQ<=2025.2)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(Shiny.VendorSize,PricingUCA.sum),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(Shiny.VendorSize,PricingUCA.sum))


write.csv(file="..//Output//AcqTrends//VendorSize_Pricing2021.csv",row.names = FALSE, na = "",
          def_data %>% group_by(Shiny.VendorSize,PricingUCA.1year,Fiscal_Year)%>%
            filter(Fiscal_Year>=2007 & Fiscal_YQ<=2025.2) %>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(Shiny.VendorSize,PricingUCA.1year),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(Shiny.VendorSize,PricingUCA.1year))



```







