---
title: "Defense Acquisition Trends"
output:
  html_document:
    keep_md: yes
    toc: yes
date: "Wednesday, October 6, 2021"
---

# Setup
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from FPDS.

```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(scales)
library(svglite)
library(readxl)

library(openxlsx)

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

local_path<-get_local_lookup_path()

main.text.size<-1
note.text.size<-1.40
if(!exists("full_data"))
  load(file="FPDS_chart_maker//unaggregated_FPDS.Rda")


if(!exists("def_data"))
  load(file="FPDS_chart_maker/unaggregated_def.Rda")

def_data<-deflate(def_data, "Action_Obligation_Then_Year",deflator_var="OMB25_GDP23")
def_data<-deflate(platpscintldef, "Action_Obligation_Then_Year",deflator_var="OMB25_GDP23")
load(file="../data/clean/Defense_OTA.Rda")


if(!"Action_Obligation_OMB25_GDP23" %in% colnames(ota_def))
  ota_def<-deflate(ota_def, "Action_Obligation_Then_Year",deflator_var="OMB25_GDP23")
colnames(ota_def)[colnames(ota_def)=="Action_Obligation_Then_Year_Then_Year"]<-"Action_Obligation_Then_Year"


if(!"Action_Obligation_OMB25_GDP23" %in% colnames(def_data))
  def_data<-deflate(def_data, "Action_Obligation_Then_Year",deflator_var="OMB25_GDP23")
colnames(def_data)[colnames(def_data)=="Action_Obligation_Then_Year_Then_Year"]<-"Action_Obligation_Then_Year"



#Kludge
toa<-readxl::read_excel(path=file.path("..","data_raw","FY24 6-1_DoD TOA by Title.xlsx"),skip=4)
request<-readxl::read_excel(path=file.path("..","data_raw","FY24 1-1.xlsx"),skip=3)
toa<-toa[sapply(toa[,2],function(x) substr(x,start=1,stop=21))==
            "Total Current Dollars" & !is.na(toa[,2]),c(-1,-3)]


colnames(toa)<-gsub("FY ","",colnames(toa))
colnames(toa)<-gsub("\r\nEnacted","",colnames(toa))
colnames(toa)[colnames(toa)=="...2"]<-"Series"
toa<-pivot_longer(toa,  cols=-Series, names_to="Fiscal_Year", values_to="Total_Obligation_Authority")
toa$Total_Obligation_Authority<-toa$Total_Obligation_Authority*1000000
toa<-deflate(toa,money_var = "Total_Obligation_Authority",deflator_var="OMB25_GDP23")
toa$dFYear<-as.Date(paste(toa$Fiscal_Year,1,1,sep="-"))

online_path<-file.path(get_local_sharepoint_path("DIIG Teamsite - Shared Documents"),"2024 - Acquisition Trends","Data and Figures")

max(full_data$Fiscal_YQ)
max(def_data$Fiscal_YQ)


load(file="../data/clean/Defense_OTA.Rda")
```

# Topline

## Topline Quarterly
```{r toplineq}




(toplineq<-build_plot(data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<=2024.1),#rbind(quarterly,q2021,e2021),
                     chart_geom="Bar Chart",
                     x_var="dFYear",alpha_var="YTD",
                     y_var="Action_Obligation_OMB25_GDP23",
           color_var="fiscal_quarter",
           format = TRUE,
           labels_and_colors = def_lc,
           column_key=def_ck
       )+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nOct–Nov")
       theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")
)

ggsave600dpi(toplineq,file=file.path("..","Output","AcqTrends","toplineq.svg"),  
             width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
             )

ggsave600dpi(toplineq,file=file.path("..","Output","AcqTrends","toplineq.png"),  
             width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,
             filename="toplineqr_keynote.svg", toplineq+
               labs(title="DOD Contract Obligations, 2000–2024 Oct-Nov"),
             width=13, height= 5.5, units="in", size=20, lineheight = 0.75
             )

log_plot(plot=toplineq, df=def_data   %>% filter(Fiscal_YQ<2024),
                     filename="acq_fig2_2_fq",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="2-2 FYQ",path="../output/AcqTrends/",second_path=online_path, height=3.25,
                     startRow=1,startCol=12,format=TRUE,#var_list=c("Source","fiscal_quarter")
         )

```

### Quarterly Plat Breakout
```{r QuartPlatBreakout} 
platform_levels<-levels(factor(def_data$PlatformPortfolio))
for(p in platform_levels){
  file_p<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",p)))
  (Breakout<-build_plot(
    data=def_data %>% filter(Fiscal_Year>=2000&Fiscal_YQ<2024&PlatformPortfolio==p),
                     chart_geom="Bar Chart",
                     x_var="dFYear",alpha_var="YTD",
                     y_var="Action_Obligation_OMB25_GDP23",
           color_var="fiscal_quarter",
           format = TRUE,
           labels_and_colors = def_lc,
           column_key=def_ck
       )+
      date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nOct–Nov")   theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)",title=p)
)
  
  if(!dir.exists(file.path("../output/AcqTrends/Platform",file_p)))
    dir.create(file.path("../output/AcqTrends/Platform",file_p))
  undebug(log_plot)
  log_plot(plot=Breakout, df=def_data  %>% filter(Fiscal_YQ<2024&PlatformPortfolio==p),
           filename=paste(file_p,"FYQ",sep="_"),xlsx=paste("DoD",file_p,"Contracts.xlsx",sep="_"),
           sheet="FYQ",path=file.path("../output/AcqTrends/Platform/",file_p), height=3.5,
           startRow=1,startCol=13,format=TRUE,var_list=c("Vehicle.AwardTask","Vehicle.sum7"),
           output_doc_png=TRUE,excel_y_var=TRUE
           )
  
}
```

### Quarterly Cust Breakout
```{r QuartCustBreakout} 
subcustomer_levels<-levels(factor(def_data$SubCustomer.sum))
for(c in subcustomer_levels){
  file_c<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",c)))
  (Breakout<-build_plot(
    data=def_data %>% filter(Fiscal_Year>=2000&SubCustomer.sum==c& Fiscal_YQ<2024),
                    chart_geom="Bar Chart",
                     x_var="dFYear",alpha_var="YTD",
                     y_var="Action_Obligation_OMB25_GDP23",
           color_var="fiscal_quarter",
           format = TRUE,
           labels_and_colors = def_lc,
           column_key=def_ck
       )+
      date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nOct–Nov")   theme(legend.position = "right")+
     labs(y="Obligations (Constant 2022 $s)",title=c))
  
  if(!dir.exists(file.path("../output/AcqTrends/Customer",file_c)))
    dir.create(file.path("../output/AcqTrends/Customer",file_c))
  
  log_plot(plot=Breakout, df=def_data  %>% filter(Fiscal_YQ<2024&SubCustomer.sum==c),
           filename=paste(file_c,"FYQ",sep="_"),xlsx=paste(file_c,"Contracts.xlsx",sep="_"),
           sheet="FYQ",path=file.path("../output/AcqTrends/Customer/",file_c), height=3.5,
           startRow=1,startCol=13,format=TRUE,var_list=c("Vehicle.AwardTask","Vehicle.sum7"),
           output_doc_png=TRUE,excel_y_var=TRUE
           )
  
}
```


## Topline and TOA
```{r TOAannual}


fpds_annual<-platpscintldef %>% filter(Fiscal_Year<2024) %>% group_by(Fiscal_Year,dFYear,IsFMS,
                                    ContractingCustomer,YTD) %>% summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE),
                                                                       Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))
fpds_annual$Series<-"Contract Obligations"
toa$ContractingCustomer<-"Defense"
toa$Action_Obligation_OMB25_GDP23<-NA
toa$Action_Obligation_Then_Year<-NA
toa$Fiscal_Year<-text_to_number(toa$Fiscal_Year)
toa$YTD<-NA
toa$IsFMS<-0
fpds_annual$Total_Obligation_Authority_Then_Year<-NA
fpds_annual$Total_Obligation_Authority_OMB25_GDP23<-NA
colnames(toa)[!colnames(toa) %in% colnames(fpds_annual)]
colnames(fpds_annual)[!colnames(fpds_annual) %in% colnames(toa)]
fpds_annual<-rbind(as.data.frame(fpds_annual),as.data.frame(toa))# %>% dplyr::select(-fiscal_quarter)

fpds_annual$FMS<-as.character(fpds_annual$IsFMS)
fpds_annual$FMS[fpds_annual$Fiscal_Year<2012 | is.na(fpds_annual$IsFMS)]<-"Obligations (reliable\nFMS labels not available)"
fpds_annual$FMS[!is.na(fpds_annual$Total_Obligation_Authority_OMB25_GDP23)]<-"Obligations (no FMS)"
fpds_annual$FMS<-factor(fpds_annual$FMS)
levels(fpds_annual$FMS)<-list("Obligations (includes FMS)"=c("1","Obligations (includes FMS)"),
                              "Obligations (no FMS)"=c("0","Obligations (no FMS)"),
                              "Obligations (reliable\nFMS labels not available)"="Obligations (reliable\nFMS labels not available)")
fpds_annual$TOA<-"Total Obligation Authority"


(topline<-build_plot(data=fpds_annual %>% filter(Fiscal_Year>=1990),#rbind(quarterly,q2021,e2021),
                     chart_geom="Bar Chart",
                     x_var="dFYear",#alpha_var="YTD",
                     y_var="Action_Obligation_OMB25_GDP23",
           color_var="FMS"
       )+
    geom_path(aes(x=dFYear,y=Total_Obligation_Authority_OMB25_GDP23,color=TOA))+
  # scale_alpha_discrete(range=c(0.4,1))+
    labs(x="Fiscal Year",y="Constant FY 2022 $",fill="Contract",color="Budget",
         caption="Source: FPDS, FY 2024 DoD Greenbook, CSIS Analysis")+
    theme(legend.position = "right")+
    date_x_year_breaks(1990,2028,3)#,partial_year=2024,partial_label="\nQ1")
)


ggsave600dpi(topline,file=file.path("..","Output","AcqTrends","topline_toa_annual.png"),  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )

ggsave600dpi(topline,file=file.path("..","Output","AcqTrends","topline_toa_annual.emf"),  
             width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
             )

output_TY<-topline$data %>%
  mutate(source=ifelse(!is.na(Total_Obligation_Authority_Then_Year),
                       "TOA","Contract"),
         Then_Year_Dollars=ifelse(source=="TOA",
                        Total_Obligation_Authority_Then_Year,Action_Obligation_Then_Year))%>%
  filter(Fiscal_Year>=1990)%>%
          format_data_for_plot(
                               fy_var="Fiscal_Year",
                               y_var="Then_Year_Dollars",
                               color_var="source",
                               facet="FMS",
                               # labels_and_colors = ota_lc,
                               group=TRUE) %>%
            arrange(Fiscal_Year) 

#+theme(plot.margin =margin(t=0,b=0,l=0.1,r=0.25,"inches"))
log_plot(plot=topline, 
         df=output_TY   ,y_var="Then_Year_Dollars",#%>% filter(Fiscal_YQ<2024),
                     filename="acq_fig2_1_toa_annual",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="2-1 TOA",path="../output/AcqTrends/",second_path=online_path, height=3,excel_formulas = TRUE,
                     startRow=1,startCol=13,format=TRUE,var_list=c("source","FMS"),
         output_doc_svg=TRUE
         )


```



## Topline Competition
```{r ToplineComp}
def_data %>% group_by(Fiscal_Year) %>% summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))
def_data %>% filter(Fiscal_Year==2021) %>% group_by(Competition.sum) %>% summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))

(
ToplineCompMulti<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=1991&Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # 
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Obligations (Constant 2022 $s)")+
    date_x_year_breaks(1992,2022, by=2)#,partial_year=2024,partial_label="\nOct–Nov")
)

(
ToplineComp<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=1997&Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.sum", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # 
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Obligations (Constant 2022 $s)")+
    date_x_year_breaks(1998,2022,2)#)#,partial_year=2024,partial_label="\nOct–Nov")
)



(
ToplineCompLine<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=1997&Fiscal_YQ<2024),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.sum", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Obligations (Constant 2022 $s)")+
    date_x_year_breaks(1998,2022, by=2)
)

def_data %>% filter(Competition.sum =="Unlabeled" & Fiscal_Year>=2019) %>% group_by(CompetitionClassification)%>%
  summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_comp.png", ToplineComp,  
             width=11, height= 5.5, units="in",size=14, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_comp.emf", ToplineComp+theme(legend.position = "right"),  
             width=6.5, height= 3, units="in",size=11, lineheight=1.2
             )


ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_comp_multi.png", ToplineCompMulti,  
             width=11, height= 5.5, units="in",size=14, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_comp_multi.svg", ToplineCompMulti,  
             width=6.5, height= 4, units="in",size=12, lineheight=1.2
             )



ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_comp_multi.emf", ToplineCompMulti+theme(legend.position = "right"),  
             width=6.5, height= 3, units="in",size=11, lineheight=1.2
             )


ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_comp_square.png", ToplineComp,  
             width=6, height= 5, units="in",size=14, lineheight=1.2
             )

write.csv(file="..//Output//AcqTrends//topline_competition.csv",row.names = FALSE, na = "",
          ToplineComp$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(Competition.sum),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23))

log_plot(plot=ToplineComp, df=def_data %>% filter(Fiscal_YQ<2024),
                     filename="acq_fig6_5_competition",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="6-5 Comp",path="../output/AcqTrends/",second_path=online_path, height=3.5,
                     startRow=1,startCol=12,format=TRUE#,var_list=c("Vehicle.AwardTask","Vehicle.sum7")
         )
```



### Missing Competition
```{r UnlabeledComp}

(
UnlabeledComp<-build_plot(
  data=def_data %>% filter(Competition.sum =="Unlabeled"),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="CompetitionClassification", #color_var
  facet_var="Vehicle.sum7", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")
)

def_data %>% filter(Competition.sum =="Unlabeled" & Fiscal_Year>=2019) %>% group_by(CompetitionClassification)%>%
  summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="unlabeled_comp.png", UnlabeledComp,  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )



write.csv(file="..//Output//AcqTrends//unlabeled_competition.csv",row.names = FALSE, na = "",
          # ToplineComp$data%>% mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(UnlabeledComp$data,id_cols=c(CompetitionClassification,Vehicle.sum7),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)
          %>% arrange(CompetitionClassification,Vehicle.sum7))



```







## Topline Vehicle
```{r ToplineVehicle}


full_data %>% filter(Vehicle=="Unlabeled Indefinite Delivery Contract (IDC)" ) %>% group_by(ClassifyNumberOfOffers,No.Competition.sum)%>%
  summarise(n=length(Vehicle))


(
ToplineVehicle7<-build_plot(
  data=full_data %>% filter(!is.na(Vehicle.AwardTask)),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Vehicle.sum7", #color_var
  facet_var="Vehicle.AwardTask", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)",
       caption="Note: Unlabeled not shown. Source: FPDS and CSIS analysis.")
)


(
ToplineVehicle<-build_plot(
  data=full_data %>% filter(!is.na(Vehicle.AwardTask)),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Vehicle.sum", #color_var
  facet_var="Vehicle.AwardTask", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)",
       caption="Note: Unlabeled not shown. Source: FPDS and CSIS analysis.")
)


ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_vehicle7.png", ToplineVehicle7, 
             width=13, height= 4.5, units="in",size=11
             )

write.csv(file="..//Output//AcqTrends//topline_vehicle7.csv",row.names = FALSE, na = "",
          ToplineVehicle7$data%>% 
            mutate(Fiscal_Year=lubridate::year(dFYear),
                   bAction_Obligation_OMB25_GDP23=Action_Obligation_OMB25_GDP23/1000000000)%>%
            pivot_wider(id_cols=c(Vehicle.sum7,Vehicle.AwardTask),
                        names_from=Fiscal_Year,values_from=bAction_Obligation_OMB25_GDP23)%>%
            arrange(Vehicle.sum7,Vehicle.AwardTask))


ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_vehicle.png", ToplineVehicle, 
             width=13, height= 4.5, units="in",size=11
             )

write.csv(file="..//Output//AcqTrends//topline_vehicle.csv",row.names = FALSE, na = "",
          ToplineVehicle$data%>% mutate(Fiscal_Year=lubridate::year(dFYear),
                                       bAction_Obligation_OMB25_GDP23=Action_Obligation_OMB25_GDP23/1000000000)%>%
            pivot_wider(id_cols=c(Vehicle.sum,Vehicle.AwardTask),
                        names_from=Fiscal_Year,values_from=bAction_Obligation_OMB25_GDP23)%>%
            arrange(Vehicle.sum,Vehicle.AwardTask))

log_plot(plot=ToplineVehicle7, df=def_data %>% filter(Fiscal_YQ<2024),
                     filename="acq_fig4_X_vehicle",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="4-X Veh",path="../output/AcqTrends/",second_path=online_path, height=4,
                     startRow=1,startCol=14,format=TRUE,
         var_list=c("Vehicle.AwardTask","Vehicle.sum7"))

```


### Vehicle Plat Breakout
```{r VehPlatBreakout} 
platform_levels<-levels(factor(def_data$PlatformPortfolio))
for(p in platform_levels){
  file_p<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",p)))
  (Breakout<-build_plot(
    data=def_data %>% filter(Fiscal_Year>=2000&Fiscal_YQ<2024&PlatformPortfolio==p),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Vehicle.sum7", #color_var
  facet_var="Vehicle.AwardTask", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "right")+
    labs(y="Obligations (Constant 2022 $s)",title=p))

  if(!dir.exists(file.path("../output/AcqTrends/Platform",file_p)))
    dir.create(file.path("../output/AcqTrends/Platform",file_p))
  undebug(log_plot)
  log_plot(plot=Breakout, df=def_data  %>% filter(Fiscal_YQ<2024&PlatformPortfolio==p),
           filename=paste(file_p,"vehicle",sep="_"),xlsx=paste("DoD",file_p,"Contracts.xlsx",sep="_"),
           sheet="Veh",path=file.path("../output/AcqTrends/Platform/",file_p), height=3.5,
           startRow=1,startCol=14,format=TRUE,var_list=c("Vehicle.AwardTask","Vehicle.sum7"),
           output_doc_png=TRUE,excel_y_var=TRUE
           )
  
}
```

### Vehicle Cust Breakout
```{r VehCustBreakout} 
subcustomer_levels<-levels(factor(def_data$SubCustomer.sum))
for(c in subcustomer_levels){
  file_c<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",c)))
  (Breakout<-build_plot(
    data=def_data %>% filter(Fiscal_Year>=2000&SubCustomer.sum==c& Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Vehicle.sum7", #color_var
  facet_var="Vehicle.AwardTask", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "right")+
    labs(y="Obligations (Constant 2022 $s)",title=c))
  
  if(!dir.exists(file.path("../output/AcqTrends/Customer",file_c)))
    dir.create(file.path("../output/AcqTrends/Customer",file_c))
  
  log_plot(plot=Breakout, df=def_data  %>% filter(Fiscal_YQ<2024&SubCustomer.sum==c),
           filename=paste(file_c,"vehicle",sep="_"),xlsx=paste(file_c,"Contracts.xlsx",sep="_"),
           sheet="Veh",path=file.path("../output/AcqTrends/Customer/",file_c), height=3.5,
           startRow=1,startCol=14,format=TRUE,var_list=c("Vehicle.AwardTask","Vehicle.sum7"),
           output_doc_png=TRUE,excel_y_var=TRUE
           )
  
}
```

### Vehicle Cost 
```{r VehCost} 

(
CAS<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2001 & Fiscal_YQ<2024) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="costaccountingstandardsclause", #color_var
  facet_var="Vehicle.sum7", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")
)
  

```


## Topline Pricing
```{r ToplinePricing}

def_data$PricingUCA.sumlong<-def_data$PricingUCA.sum
levels(def_data$PricingUCA.sumlong)<-list("Firm Fixed-Price"="FFP",
                                           "Less Common"="Less Common",
                                           "Incentive"="Incentive",
                                           "Other Cost-Based"="Other CB",
                                           "Undefinitized\nContract Award"="UCA",
                                           "Unclear"="Unclear"   )
(
ToplinePricing<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingUCA", #color_var
  facet_var="PricingUCA.sumlong", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE,
  alpha_var="YTD",
)+date_x_year_breaks(2000,2023,7)+#,partial_year=2024,partial_label="\nQ1")
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")
)





ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_pricing.png", ToplinePricing,  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )



  ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,
               filename="topline_pricing_keynote.svg", ToplinePricing+
               # facet_wrap(~SubCustomer.sum,nrow=1)+
               labs(title="DOD Contract Obligations by Pricing Mechanism, 2000–2023"), 
             width=13, height= 5.5, units="in", size=20, lineheight = 0.75
             )  


log_plot(plot=ToplinePricing+theme(plot.margin = margin(t=0,r=0.25,b=0.1,l=0.1,"inches")), df=def_data  %>% filter(Fiscal_YQ<2024),
                     filename="acq_fig4_1_pricing",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="4-1 Price",path="../output/AcqTrends/",second_path=online_path, height=3.5,
                     startRow=1,startCol=13,format=TRUE,var_list=c("PricingUCA.sumlong","PricingUCA")
         )

```


### Pricing History
```{r ToplinePricing}
if(!exists("pricing"))
  load(file="../data/clean/pricing_historical.Rda")

hist_lc<-prepare_labels_and_colors(pricing %>% select(-ContractingOfficeName,-PricingMechanism))#,path=local_path
hist_ck<-get_column_key(pricing)#,path=local_path
pricing$Fiscal_YQ<-pricing$Fiscal_Year
pricing$YTD<-"Full Year"
PricingUpdate<-rbind(pricing[pricing$Fiscal_Year<2022,colnames(pricing) %in% colnames(def_data)],
                     def_data[def_data$Fiscal_Year>=2022,
                              colnames(def_data) %in% colnames(pricing)]
                     )


(
PricingHistory<-build_plot(
  data=PricingUpdate %>% filter(Fiscal_YQ < 2024),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=hist_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingInflation", #color_var
  # facet_var="PricingUCA.sumlong", #facet_var
  column_key=hist_ck,
  format=TRUE,
  ytextposition=FALSE
)+#+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right",
        plot.caption = element_text(hjust = 0,face="plain"))+
    date_x_year_breaks(1980,2022,5)+#,partial_year=2024,partial_label="\nQ1")
    # xlim(c(as.Date("1979-01-01"), as.Date("2023-12-30")))+
    # coord_cartesian(xlim = c(as.Date("1980-01-01"), as.Date("2022-01-01"))
  labs(y="Share of Obligations",caption="Source: Federal Procurement Data System (FPDS) and CSIS analysis.")
)


  ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="Topline_Pricing_History.png", PricingHistory,  
               width=6.5, height= 3, units="in",size=12, lineheight=1.2
               )
  
  
  ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="Topline_Pricing_History.svg", PricingHistory,  
               width=6.5, height= 3, units="in",size=12, lineheight=1.2
               )

log_plot(plot=PricingHistory, df=PricingUpdate  %>% filter(Fiscal_YQ<2024),
                     filename="acq_fig8_2_pricing_history",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="8-2 PriceHist",path="../output/AcqTrends/",second_path=online_path, height=3.5,
                     format=TRUE#,var_list=c("PricingInflation")
         )


```


### Pricing FMS
```{r FPDS_pricingUCA}
summary(full_data$IsFMS)
full_data$ProductOrService<-factor(full_data$SimpleArea)
levels(full_data$ProductOrService)<-list("Products"="Products (All)",
                                         "Services & R&D"=c("R&D","Services (Non-R&D)"),
                                         "Unlabeled"="Unlabeled")


full_data<- full_data %>%      group_by(Fiscal_Year,IsFMS) %>%
                               dplyr::mutate(Action_FMS_Share=Action_Obligation_OMB25_GDP23/
                                           sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))%>% 
                               group_by(Fiscal_Year,IsFMS,ProductOrService) %>%
                               dplyr::mutate(Action_FMS_PS_Share=Action_Obligation_OMB25_GDP23/
                                           sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))%>% 
                               group_by(Fiscal_Year,IsFMS,SimpleArea) %>%
                               dplyr::mutate(Action_FMS_PSR_Share=Action_Obligation_OMB25_GDP23/
                                           sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))



# undebug(build_plot)
# undebug(build_plot)
(fpds_pricing <-  build_plot(data=full_data %>% filter(Fiscal_Year>=2012 & Fiscal_YQ<2024),
                            chart_geom="Line Chart",
                            x_var="dFYear",
                            y_var="Action_FMS_Share",
                            color_var="IsFMS",
                            facet_var="PricingUCA",
                            # second_var="StateRegion",
                            labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE,
                            alpha_var="YTD",
)+date_x_year_breaks(2012,2022,2)+#,partial_year=2024,partial_label="\nQ1")
    theme(legend.position = "right")+
    facet_wrap( ~PricingUCA)+
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)))



# undebug(format_data_for_plot)
(fpds_pricing_bar <-  build_plot(data=full_data %>% filter(Fiscal_Year>=2012 & Fiscal_YQ<2024),
                            chart_geom="Bar Chart",
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PricingUCA",
                            facet_var="IsFMS",
                            # second_var="StateRegion",
                            labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE,
                            alpha_var="YTD",
)+date_x_year_breaks(2012,2022,3)+#,partial_year=2024,partial_label="\nQ1")
    theme(legend.position = "right")+
    facet_grid( IsFMS~. , scales="free_y"))

# +
#   labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
#        y="Constant 2022 $ Obligated (Variable Y-Scale)",
#        caption="Source: FPDS and CSIS analysis.")+
#     theme(legend.position = "right"))

(fpds_pricing_psr <-  build_plot(data=full_data %>% filter(Fiscal_Year>=2012 & Fiscal_YQ<2024) %>%
                                   filter(SimpleArea!="Unlabeled" & IsFMS!="Unlabeled" & !is.na(IsFMS)),
                            chart_geom="Line Chart",
                            x_var="dFYear",
                            y_var="Action_FMS_PSR_Share",
                            color_var="IsFMS",
                            facet_var="PricingUCA",
                            second_var="SimpleArea",
                            labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE,
                            alpha_var="YTD",
)+date_x_year_breaks(2012,2022,3)+#,partial_year=2024,partial_label="\nQ1")
    theme(legend.position = "right")+
    facet_grid(SimpleArea~PricingUCA)+
    scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
    labs(caption="Note: Excludes unlabeled product or service and unlabeled FMS.\nSource: FPDS and CSIS analysis."))#+

     # theme(strip.text.y = element_text(angle=0)))


# debug(buildaC_plot)
(fpds_pricing_psr_bar <-  build_plot(data=full_data  %>% filter(SimpleArea!="Unlabeled"&
                                                                    IsFMS!="Unlabeled" & 
                                                                  !is.na(IsFMS))%>%
                                       filter(Fiscal_Year>=2012 & Fiscal_YQ<2024),
                            chart_geom="Bar Chart",
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PricingUCA",
                            facet_var="IsFMS",
                            second_var="ProductOrService",
                            labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE,
                            alpha_var="YTD",
)+date_x_year_breaks(2012,2022,3)+#,partial_year=2024,partial_label="\nQ1")
    theme(legend.position = "right")+
    facet_grid( IsFMS~ProductOrService , scales="free_y")+
    labs(caption="Note: Excludes unlabeled product or service and unlabeled FMS.\nSource: FPDS and CSIS analysis."))
# 
# ggsave600dpi(fpds_pricing_psr_bar, filename = "..//output//figure_07_fpds_pricing_psr_bar.png", 
#        width = 9,
#        height = 4.5,
#        size = 12, lineheight=1)

log_plot(plot=fpds_pricing_psr_bar, df=full_data  %>% filter(Fiscal_YQ<2024),
                     filename="acq_fig7_3_FMS_ps_pricing",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="7-3 FMSprice",path="../output/AcqTrends/",second_path=online_path, height=3.5,
                     startRow=1,startCol=15,format=TRUE,var_list=c("IsFMS","ProductOrService","PricingUCA.sum","PricingUCA")
         )


```

### Pricing Plat Breakout
```{r PricingPlatBreakout} 
platform_levels<-levels(factor(def_data$PlatformPortfolio))
for(p in platform_levels){
  file_p<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",p)))
  (Breakout<-build_plot(
    data=def_data %>% filter(Fiscal_Year>=2000&Fiscal_YQ<2024&PlatformPortfolio==p),
    chart_geom = "Bar Chart",
    share = FALSE,
    labels_and_colors=labels_and_colors,
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
    color_var="PricingUCA", #color_var
    facet_var="PricingUCA.sumlong", #facet_var
    column_key=column_key,
    format=TRUE,
    ytextposition=FALSE,
    alpha_var="YTD",
  )+date_x_year_breaks(2000,2023,6)+#,partial_year=2024,partial_label="\nQ1")
    theme(legend.position = "right")+
    labs(y="Obligations (Constant 2022 $s)",title=p))

  if(!dir.exists(file.path("../output/AcqTrends/Platform",file_p)))
    dir.create(file.path("../output/AcqTrends/Platform",file_p))
  undebug(log_plot)
  log_plot(plot=Breakout, df=def_data  %>% filter(Fiscal_YQ<2024&PlatformPortfolio==p),
           filename=paste(file_p,"pricing",sep="_"),xlsx=paste("DoD",file_p,"Contracts.xlsx",sep="_"),
           sheet="Price",path=file.path("../output/AcqTrends/Platform/",file_p), height=3.5,
           startRow=1,startCol=14,format=TRUE,var_list=c("PricingUCA.sumlong","PricingUCA"),
           output_doc_png=TRUE,excel_y_var=TRUE
           )
  
}
```

### Pricing Cust Breakout
```{r PriceCustBreakout} 
subcustomer_levels<-levels(factor(def_data$SubCustomer.sum))
for(c in subcustomer_levels){
  file_c<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",c)))
  (Breakout<-build_plot(
    data=def_data %>% filter(Fiscal_Year>=2000&SubCustomer.sum==c& Fiscal_YQ<2024),
    chart_geom = "Bar Chart",
    share = FALSE,
    labels_and_colors=labels_and_colors,
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
    color_var="PricingUCA", #color_var
    facet_var="PricingUCA.sumlong", #facet_var
    column_key=column_key,
    format=TRUE,
    ytextposition=FALSE,
    alpha_var="YTD",
  )+date_x_year_breaks(2000,2023,6)+#,partial_year=2024,partial_label="\nQ1")
    theme(legend.position = "right")+
    labs(y="Obligations (Constant 2022 $s)",title=c))
  
  if(!dir.exists(file.path("../output/AcqTrends/Customer",file_c)))
    dir.create(file.path("../output/AcqTrends/Customer",file_c))
  
  log_plot(plot=Breakout, df=def_data  %>% filter(Fiscal_YQ<2024&SubCustomer.sum==c),
           filename=paste(file_c,"pricing",sep="_"),xlsx=paste(file_c,"Contracts.xlsx",sep="_"),
           sheet="Price",path=file.path("../output/AcqTrends/Customer/",file_c), height=3.5,
           startRow=1,startCol=14,format=TRUE,var_list=c("PricingUCA.sumlong","PricingUCA"),
           output_doc_png=TRUE,excel_y_var=TRUE
           )
  
}
```

## Topline Commercial
```{r Commercial}
def_data$AnyCommercialText<-factor(def_data$AnyCommercial)
levels(def_data$AnyCommercialText)<-list(
  "Not Classified\nas Commercial"="N",
  "Non-development\nor Commercial Similar"= "NonDev",
  "Any Commercial\nClassification"="Y"
  
)

(
Commercial<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="AnyCommercialText", #color_var
  # facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")+
  date_x_year_breaks(2000,2022,2)#)#,partial_year=2024,partial_label="\nOct–Nov")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_commercial.png", Commercial, 
             width=11, height= 5.5, units="in",size=14,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_commercial.svg", Commercial+
  labs(y="Obligations\n(Constant 2022 $s)"),#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 2.25, units="in",size=11,lineheight = 1.2
             )


log_plot(plot=Commercial+labs(y="Obligations\n(Constant 2022 $s)"), df=def_data %>% filter(Fiscal_YQ<2024),
                     filename="acq_fig5_4_commercial",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="5-4 Comm",path="../output/AcqTrends/",second_path=online_path, height=2.5,
                     startRow=1,startCol=12,format=TRUE,#var_list=c("SimpleArea","Competition.multisum")
         )


def_data %>% filter(SubCustomer.sum=="Army", PlatformPortfolio=="Other Products", Fiscal_Year==2021) %>%
  group_by(AnyCommercialText,Competition.multisum) %>% summarise(
    COVID19obligated=sum(COVID19obligated,na.rm=TRUE),
    Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
    Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year),
    
  )

```

## Topline Duration
```{r Duration}

def_data$CurrentDurationIsYear<-factor(def_data$CurrentDurationCategory)
levels(def_data$CurrentDurationIsYear)<-list(
   "<=1 year" =c("<=2 Months", ">2-7 Months"  ,">7-12 Months"),
   ">1 year"=c(">1-2 Years",   ">2-4 Years",  ">4 years")
)
def_data$UnmodifiedUltimateDurationIsYear<-factor(def_data$UnmodifiedUltimateDurationCategory)
levels(def_data$UnmodifiedUltimateDurationIsYear)<-list(
   "<=1 year" =c("<=2 Months", ">2-7 Months"  ,">7-12 Months"),
   ">1 year"=c(">1-2 Years",   ">2-4 Years",  ">4 years")
)

(
CurDuration<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="CurrentDurationCategory", #color_var
  # facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Share of Obligations")+
     date_x_year_breaks(2007,2023,2)#)#,partial_year=2024,partial_label="\nOct–Nov")

)

(
UnmDuration<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="UnmodifiedUltimateDurationCategory", #color_var
  # facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Share of Obligations")+
      date_x_year_breaks(2007,2023,2)#)#,partial_year=2024,partial_label="\nOct–Nov")

)


ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_CurDuration.png", CurDuration, 
             width=11, height= 5.5, units="in",size=14,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_CurDuration.svg", CurDuration,#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 3, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_UnmDuration.png", UnmDuration,#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 3, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_UnmDuration.svg", UnmDuration,#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 3, units="in",size=11,lineheight = 1.2
             )

write.csv(file="..//Output//AcqTrends//then_year_csv//topline_CurDuration_current.csv",row.names = FALSE, na = "",
          def_data %>% group_by(CurrentDurationCategory,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(CurrentDurationCategory),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(CurrentDurationCategory))


log_plot(plot=UnmDuration, df=def_data  %>% filter(Fiscal_YQ<2024),
                     filename="acq_fig8_3_UmdDuration",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="8-3 Dur",path="../output/AcqTrends/",second_path=online_path, height=3.5,
                     startRow=1,startCol=12,format=TRUE#,var_list=c("PricingInflation")
         )

```

## Topline Multiyear
```{r Multiyear}
def_data<-def_data%>% mutate(multiyearcontracttext=factor(multiyearcontract,levels=c("0","1"),
                              labels=c("Not Multiyear","Multiyear Contract")))


(
Multiyear<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="multiyearcontract", #color_var
  # facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")+
  date_x_year_breaks(2000,2022,2)#)#,partial_year=2024,partial_label="\nOct–Nov")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_Multiyear.png", Multiyear, 
             width=11, height= 5.5, units="in",size=14,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_Multiyear.svg", Multiyear+
  labs(y="Obligations\n(Constant 2022 $s)"),#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 2.25, units="in",size=11,lineheight = 1.2
             )


# full_data %>% filter(SubCustomer.sum=="Army", PlatformPortfolio=="Other Products", Fiscal_Year==2021) %>%
#   group_by(AnyMultiyearText,Competition.multisum) %>% summarise(
#     COVID19obligated=sum(COVID19obligated,na.rm=TRUE),
#     Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
#     Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year),
#     
#   )

```


```{r ToplinePricing}
    full_data<-full_data%>% mutate(multiyearcontracttext=factor(multiyearcontract,levels=c("0","1"),
                              labels=c("Not Multiyear","Multiyear Contract")))

full_data$multiyearcontracttext[is.na(full_data$multiyearcontract)&
                             full_data$Vehicle %in% c("BOA","BPA","FSS","GWAC","PO","DO") ]<-"Not Multiyear"
  # "MULTIPLE AWARD IDC"  "SINGLE AWARD IDC"   "Unlabeled IDC"        "DCA"    "DO"   


# full_data %>% group_by(Vehicle) %>%
#   dplyr::summarise(multiyearcontracttext=sum(
#     ifelse(multiyearcontracttext=="Multiyear Contract",Action_Obligation_OMB25_GDP23,0),na.rm=TRUE))



full_data<-full_data %>% group_by(Fiscal_Year,Vehicle.sum7)%>%
  mutate(pPlatFYear=Action_Obligation_OMB25_GDP23/sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))
```
### Multiyear Vehicle
```{r VehicleMultiyear}
def_data %>% group_by(Vehicle,multiyearcontracttext) %>%
  dplyr::summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))

    def_data<-def_data%>% mutate(multiyearcontracttext=factor(multiyearcontract,levels=c("0","1"),
                              labels=c("Not Multiyear","Multiyear Contract")))

def_data<-def_data %>% group_by(Fiscal_Year,PlatformPortfolio)%>%
  mutate(pPlatFYear=Action_Obligation_OMB25_GDP23/sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))

levels(factor(def_data$Vehicle))

(
VehicleMultiYear<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="multiyearcontracttext", #color_var
  facet_var="Vehicle",
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")
)

(
VehicleMultiYearShare<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Vehicle.sum7!="Unlabeled"&
                             (is.na(multiyearcontract)|multiyearcontract==1)),
  chart_geom = "Line Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="pVehFYear", #VAR.y.variable
  color_var="multiyearcontracttext", #color_var
  facet_var="Vehicle.sum7",
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Share of Obligations")+
    scale_y_continuous(labels = percent)
)


ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="Vehicle_MultiYear.png", VehicleMultiYear,  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="Vehicle_MultiYearShare.png", VehicleMultiYearShare,  
             width=6.5, height= 4, units="in",size=12, lineheight=1.2
             )

write.csv(file="..//Output//AcqTrends//VehicleMultiYearShare.csv",row.names = FALSE, na = "",
  pivot_wider(VehicleMultiYearShare$data %>% 
                        arrange(dFYear) %>% mutate(Fiscal_Year=lubridate::year(dFYear)),
                      id_cols=c(Vehicle.sum7,multiyearcontracttext),
                      names_from=Fiscal_Year,values_from=pPlatFYear)%>%
  arrange(Vehicle.sum7,multiyearcontracttext))
  


```

## Topline GFE
```{r GFE}

def_data$gfe_gfp_value<-factor(def_data$gfe_gfp_code)
levels(def_data$gfe_gfp_value)<-list(
   "No Government Furnished"="N",
  "Transaction uses\nGovernment Furnished\nEquipment or Property"="Y"
 
)

```



### GFE Competition
```{r GFEcomp}
summary(def_data$gfe_gfp_code)
(
GFEcomp<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="No.Competition.sum", #color_var
  facet_var="gfe_gfp_value", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")+
    scale_x_date(breaks=as.Date(c(paste(seq(2000,2021,3),"-01-01",sep=""))),
                                                   date_labels="'%y")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="platform_GFE.png", GFEplat, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="platform_GFE.svg", GFEplat, 
             width=6.5, height= 4.5, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="platform_GFE.emf", GFEplat, 
             width=6.5, height= 4.5, units="in",size=11,lineheight = 1.2
             )


# write.csv(file="..//Output//AcqTrends//platform_GFE.csv",row.names = FALSE, na = "",
#           pivot_wider(GFEplat$data,id_cols=c(PlatformPortfolio,gfe_gfp_value),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23))

write.csv(file="..//Output//AcqTrends//platform_GFE_current.csv",row.names = FALSE, na = "",
          def_data %>% group_by(PlatformPortfolio,gfe_gfp_value,Fiscal_Year)%>%
            filter(Fiscal_Year>=2004 & Fiscal_YQ<2024)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(PlatformPortfolio,gfe_gfp_value),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(def_data$ContractingSubCustomer)
```


## Topline Cost Accounting
```{r SubCustomer}


(
CAS<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2001 & Fiscal_YQ<2024) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="costaccountingstandardsclause", #color_var
  facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")
)


(
CAS<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="costaccountingstandardsclause", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")
)


(
CAS<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.detail", #color_var
  facet_var="costaccountingstandardsclause", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")
)


(
CAS<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="AnyCommercial", #color_var
  facet_var="costaccountingstandardsclause", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_subcustomer.png", SubCustomer, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_subcustomer.svg", SubCustomer+facet_wrap(~SubCustomer.sum,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_subcustomer.emf", SubCustomer+facet_wrap(~SubCustomer.sum,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )


write.csv(file="..//Output//AcqTrends//topline_subcustomer.csv",row.names = FALSE, na = "",
          pivot_wider(SubCustomer$data,id_cols=c(SubCustomer.sum,SubCustomer.platform),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23))

write.csv(file="..//Output//AcqTrends//topline_subcustomer_current.csv",row.names = FALSE, na = "",
          def_data %>% group_by(SubCustomer.sum,ContractingSubCustomer,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(SubCustomer.sum,ContractingSubCustomer),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(def_data$ContractingSubCustomer)
```

## Topline Energy Efficient
```{r SubCustomer}



(
EE<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="EnergyEfficient", #color_var
  facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")
)


(
EE<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="EnergyEfficient", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")
)



ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_subcustomer.png", SubCustomer, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_subcustomer.svg", SubCustomer+facet_wrap(~SubCustomer.sum,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_subcustomer.emf", SubCustomer+facet_wrap(~SubCustomer.sum,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )


write.csv(file="..//Output//AcqTrends//topline_subcustomer.csv",row.names = FALSE, na = "",
          pivot_wider(SubCustomer$data,id_cols=c(SubCustomer.sum,SubCustomer.platform),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23))

write.csv(file="..//Output//AcqTrends//topline_subcustomer_current.csv",row.names = FALSE, na = "",
          def_data %>% group_by(SubCustomer.sum,ContractingSubCustomer,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(SubCustomer.sum,ContractingSubCustomer),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(def_data$ContractingSubCustomer)
```

#Product/Service/R&D

## Topline Product/Service/R&D
```{r ToplinePSR}

(
ToplinePSR<-build_plot(
  data=def_data %>% filter(Fiscal_YQ<2024 & !is.na(SimpleArea) & SimpleArea!="Unlabeled"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  # alpha_var="YTD",
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SimpleArea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)",
       caption="Note: Unlabeled product, service, and R&D areas not shown.\nSource: FPDS and CSIS analysis.")+
  date_x_year_breaks(1990,2020,5)#,partial_year=2024,partial_label="\nQ1",)
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_psr.png", ToplinePSR, 
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_psr.svg", ToplinePSR, 
             width=6.5, height= 3, units="in",size=11, lineheight=1.2
             )

log_plot(plot=ToplinePSR+facet_wrap(~SimpleArea), df=def_data %>% filter(Fiscal_YQ<2024),
                     filename="acq_fig3_1_area",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="3-1 Area",path="../output/AcqTrends/",second_path=online_path, height=3.5,
                     startRow=1,startCol=12,format=TRUE,#var_list=c("SimpleArea","Competition.multisum"),
         excel_y_var = TRUE,excel_formulas = TRUE
         )

```

## PSR OTA
```{r ToplinePSR}




(
OTAPSR<-build_plot(
  data=def_kota %>% filter(Fiscal_Year>=2015 & Fiscal_YQ<2024 &
                                 !is.na(AreaType) & AreaType!="Unlabeled") ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=kota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  # alpha_var="YTD",
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="AreaType", #color_var
  facet_var="SimpleAreaType", #facet_var
  column_key=kota_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)",
       caption="Note: Unlabeled contract product, service, and R&D areas\nas well as unlabeled OTA agreement types not shown.\nSource: FPDS and CSIS analysis.")+facet_wrap(~SimpleAreaType, nrow=1)+
  date_x_year_breaks(2015,2023,2)#,partial_year=2024,partial_label="\nQ1",)
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="OTA_psr.png", OTAPSR, 
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="OTA_psr.svg", OTAPSR, 
             width=6.5, height= 3, units="in",size=11, lineheight=1.2
             )

log_plot(plot=OTAPSR, df=def_kota %>% filter(Fiscal_YQ<2024),
                     filename="acq_fig3_1a_kota_areatype",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="3-1a K&Ota",path="../output/AcqTrends/",second_path=online_path, height=3.5,
                     startRow=1,startCol=12,format=TRUE,#var_list=c("SimpleArea","Competition.multisum"),
         excel_y_var = TRUE,excel_formulas = TRUE
         )

```

## PSR Plat Breakout
```{r PSRplatBreakout} 
platform_levels<-levels(factor(def_data$PlatformPortfolio))
for(p in platform_levels){
  file_p<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",p)))
  (Breakout<-build_plot(
    data=def_data %>% filter(Fiscal_Year>=2000&PlatformPortfolio==p& Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  alpha_var="YTD",
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SimpleArea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)",title=p)+
  date_x_year_breaks(1990,2020,5)#,partial_year=2024,partial_label="\nQ1")
)

  if(!dir.exists(file.path("../output/AcqTrends/Platform",file_p)))
    dir.create(file.path("../output/AcqTrends/Platform",file_p))
  
  log_plot(plot=Breakout, df=def_data  %>% filter(Fiscal_YQ<2024&PlatformPortfolio==p),
           filename=paste(file_p,"PSR",sep="_"),xlsx=paste("DoD",file_p,"Contracts.xlsx",sep="_"),
           sheet="PSR",path=file.path("../output/AcqTrends/Platform/",file_p), height=3.5,
           startRow=1,startCol=13,format=TRUE,#,var_list=c("PricingUCA.sumlong","PricingUCA"),
           output_doc_png=TRUE,excel_y_var=TRUE
           )
  
}
```

## PSR Cust Breakout
```{r PSRcustBreakout} 
subcustomer_levels<-levels(factor(def_data$SubCustomer.sum))
for(c in subcustomer_levels){
  file_c<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",c)))
  (Breakout<-build_plot(
    data=def_data %>% filter(Fiscal_Year>=2000&SubCustomer.sum==c& Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  alpha_var="YTD",
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SimpleArea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)",title=c)+
  date_x_year_breaks(1990,2020,5)#,partial_year=2024,partial_label="\nQ1")
)

  if(!dir.exists(file.path("../output/AcqTrends/Customer",file_c)))
    dir.create(file.path("../output/AcqTrends/Customer",file_c))
  
  log_plot(plot=Breakout, df=def_data  %>% filter(Fiscal_YQ<2024&SubCustomer.sum==c),
           filename=paste(file_c,"PSR",sep="_"),xlsx=paste(file_c,"Contracts.xlsx",sep="_"),
           sheet="PSR",path=file.path("../output/AcqTrends/Customer/",file_c), height=3.5,
           startRow=1,startCol=13,format=TRUE,#,var_list=c("PricingUCA.sumlong","PricingUCA"),
           output_doc_png=TRUE,excel_y_var=TRUE
           )
  
}
```

## PSR Quarterly
```{r PSR_Q}

(
PSR_Q<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000&  Fiscal_YQ<=2024.1 & SimpleArea!="Unlabeled"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="fiscal_quarter", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2023,3)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="PSR_Q.png", PSR_Q, 
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="PSR_Q.svg", PSR_Q, 
             width=6.5, height= 3, units="in",size=11, lineheight=1.2
             )


output_TY<-def_data %>% filter(Fiscal_YQ<2024) %>% group_by(SimpleArea,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(SimpleArea),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)
write.csv(file="..//Output//AcqTrends//PSR_Q.csv",row.names = FALSE, na = "",
          output_TY)


# wb <- loadWorkbook("..//Output//AcqTrends//DoD_Acq_Trends_Contracts.xlsx")
# createSheet(wb, name = "Area")
# writeData(wb, output_TY, sheet = "Area", startRow = 14, startCol = 14)
# saveWorkbook(wb,file="..//Output//AcqTrends//DoD_Acq_Trends_Contracts.xlsx",overwrite = TRUE)

```


## R&D phase
```{r RnD}

(
RnDphase<-build_plot(
  data=def_data %>% filter(Fiscal_YQ<2024) %>% filter(SimpleArea=="R&D"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="ProductServiceOrRnDarea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="psr_RnDPhase.png", RnDphase, 
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )

log_plot(plot=RnDphase, df=def_data %>% filter(Fiscal_YQ<2024) %>% filter(SimpleArea=="R&D"),
                     filename="acq_fig5_1_RnD",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="5-1 RnD",path="../output/AcqTrends/",second_path=online_path, height=3,
                     startRow=1,startCol=12,format=TRUE,#var_list=c("SimpleArea","Competition.multisum"),
         output_doc_svg=TRUE
         )

```



## R&D Phase+OTA    
```{r PhaseAndOTA}

contract_merge<-def_data %>% filter(Fiscal_YQ<2024) %>%
  group_by(Fiscal_Year,
                         ProductServiceOrRnDarea,
                         SimpleArea)%>%
  dplyr::summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
                   Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year))

# 


#   format_data_for_plot(contract_data,
#                      fy_var="Fiscal_Year", #x_var
#                      y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
#                      color_var="ProductServiceOrRnDarea", #color_var
#                      facet_var = "SimpleArea",
#                      labels_and_colors = labels_and_colors
# )
# ota_merge<-format_data_for_plot(ota_def,
#                      fy_var="Fiscal_Year", #x_var
#                      y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
#                      color_var="ProductServiceOrRnDarea", #color_var
#                      facet_var = "SimpleArea",
#                      labels_and_colors = labels_and_colors
# )

ota_merge<-ota_def%>%filter(Fiscal_Year >=2015 & Fiscal_Year <=2022) %>%
  group_by(Fiscal_Year,SimpleArea)%>%
  dplyr::summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
                   Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year)
                   )

#   format_data_for_plot(ota_def,
#                      fy_var="Fiscal_Year", #x_var
#                      y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
#                      color_var="ProductServiceOrRnDarea", #color_var
#                      facet_var = "SimpleArea",
#                      labels_and_colors = labels_and_colors
# )

ota_merge$ProductServiceOrRnDarea<-"Other Transaction Authority (OTA) R&D Agreements"
colnames(ota_merge)[colnames(ota_merge)=="Fiscal_Year"]<-"Fiscal_Year"
merge<-rbind(ota_merge,contract_merge)
merge$dFYear<-as.Date(paste(merge$Fiscal_Year,"1","1",sep="-"))
(
RnDphasePlusOTA<-build_plot(
  data=merge %>% filter(SimpleArea=="R&D" & Fiscal_Year >=2015),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=prepare_labels_and_colors(merge),
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="ProductServiceOrRnDarea", #color_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE,
  reverse_color = TRUE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")
)+scale_x_date(date_labels="'%y",date_breaks="1 year")

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="RnDPhasePlusOTA.png", RnDphasePlusOTA+labs(caption="Source: FPDS and CSIS analysis."),
             width=5, height= 4.75, units="in",size=11, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="RnDPhasePlusOTA.svg", RnDphasePlusOTA+labs(caption="Source: FPDS and CSIS analysis."),
             width=5, height= 4.75, units="in",size=11, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="RnDPhasePlusOTA.emf", RnDphasePlusOTA+labs(caption="Source: FPDS and CSIS analysis."),
             width=5, height= 4.75, units="in",size=11, lineheight=1.2
             )

#                            
# 
# write.csv(file="..//Output//AcqTrends//RnDPhasePlusOTA.csv",row.names = FALSE, na = "",
#           RnDphasePlusOTA$data%>% mutate(Fiscal_Year=year(dFYear)) %>%
#           pivot_wider(id_cols=c(ProductServiceOrRnDarea),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)%>%
#             arrange(ProductServiceOrRnDarea))
# #             
# #  



write.csv(file="..//Output//AcqTrends//RnDPhasePlusOTA_current.csv",row.names = FALSE, na = "",
          merge %>% filter(SimpleArea=="R&D") %>%
            format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",
                                 color_var = "ProductServiceOrRnDarea",
                                 labels_and_colors=prepare_labels_and_colors(merge)) %>%
            pivot_wider(id_cols=c(ProductServiceOrRnDarea),
                        names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(ProductServiceOrRnDarea))

```

## Phase: Contract and OTA
```{r PhaseBoth}

contract_merge<-def_data%>%filter(Fiscal_Year >=2015 & Fiscal_YQ<2022) %>%
  group_by(Fiscal_Year,
                         ProductServiceOrRnDarea,
                         SimpleArea)%>%
  dplyr::summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))

# 
#   format_data_for_plot(contract_data,
#                      fy_var="Fiscal_Year", #x_var
#                      y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
#                      color_var="ProductServiceOrRnDarea", #color_var
#                      facet_var = "SimpleArea",
#                      labels_and_colors = labels_and_colors
# )
# ota_merge<-format_data_for_plot(ota_def,
#                      fy_var="Fiscal_Year", #x_var
#                      y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
#                      color_var="ProductServiceOrRnDarea", #color_var
#                      facet_var = "SimpleArea",
#                      labels_and_colors = labels_and_colors
# )

ota_merge<-standardize_variable_names(ota_def)%>%filter(Fiscal_Year >=2015) %>%
  group_by(Fiscal_Year,
                         ProductServiceOrRnDarea,
                         SimpleArea)%>%
  dplyr::summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))


#   format_data_for_plot(ota_def,
#                      fy_var="Fiscal_Year", #x_var
#                      y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
#                      color_var="ProductServiceOrRnDarea", #color_var
#                      facet_var = "SimpleArea",
#                      labels_and_colors = labels_and_colors
# )

ota_merge$Authority<-"OTA"
colnames(ota_merge)[colnames(ota_merge)=="Fiscal_Year"]<-"Fiscal_Year"
contract_merge$Authority<-"Contract"
merge<-rbind(ota_merge,contract_merge)

(
RnDphase<-build_plot(
  data=merge %>% filter(SimpleArea=="R&D"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=prepare_labels_and_colors(merge),#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\"
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Authority", #color_var
  facet_var="ProductServiceOrRnDarea", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="contractota_RnDPhase.png", RnDphase,
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )
#                            
# 
write.csv(file="..//Output//AcqTrends//contractota_RnDPhase.csv",row.names = FALSE, na = "",
          pivot_wider(RnDphase$data,id_cols=c(ProductServiceOrRnDarea,Authority),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)%>%
            arrange(ProductServiceOrRnDarea,Authority))
#             
# 
# write.csv(file="..//Output//AcqTrends//psr_RnDPhase_current.csv",row.names = FALSE, na = "",
#           def_data %>% filter(SimpleArea=="R&D") %>%
#             format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "ProductServiceOrRnDarea",
#                                  labels_and_colors=labels_and_colors) %>%
#           pivot_wider(id_cols=c(ProductServiceOrRnDarea),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
#             arrange(ProductServiceOrRnDarea))

```

## Services
```{r Services}
summary(factor(def_data$ServicesCategory.sum))
(
Services<-build_plot(
  data=full_data %>% filter(SimpleArea=="Services (Non-R&D)" & Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="ProductServiceOrRnDarea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  date_x_year_breaks(1990,2020,5)+#,partial_year=2024,partial_label="\nQ1")
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="psr_Services.png", Services, 
             width=12, height= 6, units="in",size=14, lineheight=1.2
             )
              
ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="psr_Services.svg", Services, 
             width=6.5, height= 3.25, units="in",size=10, lineheight=1.2
             )             


            
log_plot(plot=Services, df=full_data  %>% filter(Fiscal_YQ<2024 &SimpleArea=="Services (Non-R&D)"),
                     filename="acq_fig3_3_services",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="3-3 Serv",path="../output/AcqTrends/",second_path=online_path, height=3.5,
                     startRow=1,startCol=12,format=TRUE,#,var_list=c("SimpleArea","Competition.multisum")
         )

```

## PSR Pricing
```{r PSR_pricing}


(
PSRpricing_dollar<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ < 2024 & !is.na(SimpleArea) & SimpleArea!="Unlabeled"),
  chart_geom = "Bar Chart",
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingUCA.sum", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE,
  share=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="psr_pricing_dollar.png", PSRpricing_dollar, 
             width=6.5, height= 5, units="in",size=11, lineheight=1.2
             )


(
SimpleVendor_share<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 &Fiscal_YQ<2024 & !is.na(SimpleArea) & SimpleArea!="Unlabeled"),
  chart_geom = "Bar Chart",
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingUCA.sum", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE,
  share=TRUE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.")
)


ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="psr_pricing_share.png", SimpleVendor_share, 
             width=6.5, height= 5, units="in",size=11, lineheight=1.2
             )

```

## PSR Vendor size 
```{r PSR_vendorsize}


(
SimpleVendor_dollar<-build_plot(
  data=def_data %>% filter(Fiscal_Year<=2021 & !is.na(SimpleArea) & SimpleArea!="Unlabeled"),
  chart_geom = "Bar Chart",
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE,
  share=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April of 2020\n and thus did not make the cutofff for inclusion in FY2020.\nMcDonnell Douglas is grouped with the Big-5.")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="psr_vendorsize_dollar.png", SimpleVendor_dollar, 
             width=6.5, height= 5, units="in",size=11, lineheight=1.2
             )


(
SimpleVendor_share<-build_plot(
  data=def_data %>% filter(Fiscal_Year<=2021 & !is.na(SimpleArea) & SimpleArea!="Unlabeled"),
  chart_geom = "Bar Chart",
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE,
  share=TRUE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April of 2020\n and thus did not make the cutofff for inclusion in FY2020\n McDonnell Douglas is grouped with the Big-5.")
)


ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="psr_vendorsize_share.png", SimpleVendor_share, 
             width=6.5, height= 5, units="in",size=11, lineheight=1.2
             )

```

## PSR Competition
```{r PSRcomp_plat}
summary(def_data$SimpleArea)
(
PSRComp_line<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=1991 & Fiscal_YQ<2024 & SimpleArea!="Unlabeled"),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # 
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Obligations (Constant 2022 $s)")+
    date_x_year_breaks(1993,2023,by=6)#,partial_year=2024,partial_label="\nQ1")
)



(
PSRComp_bar<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=1991 & Fiscal_YQ<2024 & SimpleArea!="Unlabeled"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Obligations (Constant 2022 $s)")+
    date_x_year_breaks(1993,2023,by=6)#,partial_year=2024,partial_label="\nQ1")
)


(
PSRComp_line<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=1991 & Fiscal_YQ<2024 & SimpleArea!="Unlabeled"),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # 
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",y="Share of Obligations")+
    date_x_year_breaks(1993,2023,by=6)#,partial_year=2024,partial_label="\nQ1")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="PSRComp_line.png", PSRComp_line, 
             width=6.5, height= 5, units="in",size=12, lineheight=1.2
             )



write.csv(file="..//Output//AcqTrends//PSRComp_cur.csv",row.names = FALSE, na = "",
          def_data %>% group_by(Competition.multisum,SimpleArea,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(SimpleArea,Competition.multisum),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>% arrange(SimpleArea,Competition.multisum))

ggsave("..//Output//AcqTrends//PSRComp_both.png", 
             gridExtra::grid.arrange(
               PSRComp_bar+labs(caption = NULL,x=NULL)+theme(legend.position = "none"),
               PSRComp_line), 
             width=6.5, height= 5, units="in"
)



ggsave("..//Output//AcqTrends//PSRComp_both_keynote.png", 
             gridExtra::grid.arrange(
               PSRComp_bar+labs(
                 title="DOD Contract Obligations by Extent of Competition, 2000–2023",
                  y="Obligations\n(Const. 2022 $s)",
               caption = NULL,x=NULL)+theme(legend.position = "none",text=element_text(size=20)),
               PSRComp_line+labs(y="Share of\nObl.")+theme(text=element_text(size=20),
               plot.caption = element_text(size=round(20 * 5/6,0))
               )),
             width=13, height= 5.5, units="in" #, size=20, lineheight = 0.75
             )

ggsave("..//Output//AcqTrends//PSRComp_both_keynote.svg", 
             gridExtra::grid.arrange(
               PSRComp_bar+labs(
                 title="DOD Contract Obligations by Extent of Competition, 2000–2023",
                  y="Obligations\n(Const. 2022 $s)",
               caption = NULL,x=NULL)+theme(legend.position = "none",text=element_text(size=20)),
               PSRComp_line+labs(y="Share of\nObl.")+theme(text=element_text(size=20),
               plot.caption = element_text(size=round(20 * 5/6,0))
               )),
             width=13, height= 5.5, units="in" #, size=20, lineheight = 0.75
             )

ggsave(file.path(online_path,"PSRComp_both_keynote.svg"), 
             gridExtra::grid.arrange(
               PSRComp_bar+labs(
                 title="DOD Contract Obligations by Extent of Competition, 2000–2023",
                  y="Obligations\n(Const. 2022 $s)",
               caption = NULL,x=NULL)+theme(legend.position = "none",text=element_text(size=20)),
               PSRComp_line+labs(y="Share of\nObl.")+theme(text=element_text(size=20),
               plot.caption = element_text(size=round(20 * 5/6,0))
               )),
             width=13, height= 5.5, units="in" #, size=20, lineheight = 0.75
             )

ggsave("..//Output//AcqTrends//acq_fig6_6_PSR_competition.svg", 
             gridExtra::grid.arrange(
               PSRComp_bar+labs(
                 title=NULL,
                  y="Obligations\n(Constant 2022 $s)",
               caption = NULL,x=NULL)+theme(legend.position = "none",text=element_text(size=12),
                                            plot.margin = margin(t=0,b=0,l=0.1,r=0.5,unit="inches")),
               PSRComp_line+labs(y="Share of\nObligations",caption=NULL)+theme(text=element_text(size=12),
               plot.caption = element_text(size=round(20 * 5/6,0)),
                                           plot.margin = margin(t=0,b=0,l=0.1,r=0.5,unit="inches"))),
             width=6.5, height= 4.5, units="in" #, size=20, lineheight = 0.75
             )

ggsave(file.path(online_path,"acq_fig6_6_PSR_competition.svg"), 
             gridExtra::grid.arrange(
               PSRComp_bar+labs(
                 title=NULL,
                  y="Obligations\n(Constant 2022 $s)",
               caption = NULL,x=NULL)+theme(legend.position = "none",text=element_text(size=12),
                                            plot.margin = margin(t=0,b=0,l=0.1,r=0.5,unit="inches")),
               PSRComp_line+labs(y="Share of\nObligations",caption=NULL)+theme(text=element_text(size=12),
               plot.caption = element_text(size=round(20 * 5/6,0)),
                                           plot.margin = margin(t=0,b=0,l=0.1,r=0.5,unit="inches"))),
             width=6.5, height= 4.5, units="in" #, size=20, lineheight = 0.75
             )

log_plot(plot=PSRComp_bar, df=def_data  %>% filter(Fiscal_YQ<2024),
                     filename="acq_fig6_6_PSR_competition",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="6-6 PSRcomp",path="../output/AcqTrends/",second_path=online_path, height=3.5,
                     startRow=1,startCol=13,format=TRUE,var_list=c("SimpleArea","Competition.multisum"),
         output_doc_svg=FALSE
         )
```
## PSR Multiyear
```{r ToplinePricing}

(
PSRMultiYear<-build_plot(
  data=full_data %>% filter(Fiscal_Year>=2000 ),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="multiyearcontracttext", #color_var
  facet_var="SimpleArea",
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")
)

full_data<-full_data %>% group_by(Fiscal_Year,SimpleArea)%>%
  mutate(pPlatFYear=Action_Obligation_OMB25_GDP23/sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))
(
PSRMultiYearShare<-build_plot(
  data=full_data %>% filter(Fiscal_Year>=2000 & SimpleArea!="Unlabeled"&
                             (is.na(multiyearcontract)|multiyearcontract==1)),
  chart_geom = "Line Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="pPlatFYear", #VAR.y.variable
  color_var="multiyearcontracttext", #color_var
  facet_var="SimpleArea",
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Share of Obligations")+
    scale_y_continuous(labels = percent)
)


ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="PSR_MultiYear.png", PSRMultiYear,  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="PSR_MultiYearShare.png", PSRMultiYearShare,  
             width=6.5, height= 4, units="in",size=12, lineheight=1.2
             )

write.csv(file="..//Output//AcqTrends//PSRMultiYearShare.csv",row.names = FALSE, na = "",
  pivot_wider(PSRMultiYearShare$data %>% 
                        arrange(dFYear) %>% mutate(Fiscal_Year=lubridate::year(dFYear)),
                      id_cols=c(SimpleArea,multiyearcontracttext),
                      names_from=Fiscal_Year,values_from=pPlatFYear)%>%
  arrange(SimpleArea,multiyearcontracttext))
  


```


# SubCustomer
## Topline SubCustomer 
```{r SubCustomer}

(
SubCustomer<-build_plot(
  data=def_data %>% filter(Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SubCustomer.JPO", #color_var
  facet_var="SubCustomer.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)") +date_x_year_breaks(1990,2020,5)#,partial_year=2024,partial_label="\nQ1")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_subcustomer.png", SubCustomer, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_subcustomer.svg", SubCustomer+facet_wrap(~SubCustomer.sum,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_subcustomer_keynote.svg", SubCustomer+
               facet_wrap(~SubCustomer.sum,nrow=1)+
               labs(title="DOD Contract Obligations by Component, 1990–2023")+
               date_x_year_breaks(1990,2020,8),#,partial_year=2024,partial_label="\nQ1"), 
             width=13, height= 5.5, units="in", size=20, lineheight = 0.75
             )

log_plot(plot=SubCustomer+facet_wrap(~SubCustomer.sum,nrow=1)+
           date_x_year_breaks(1990,2020,8),#,partial_year=2024,partial_label="\nQ1"),
         df=def_data %>% filter(Fiscal_YQ<2024),
                     filename="acq_fig2_3_subcustomer",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="2-3 Cust",path="../output/AcqTrends/",second_path=online_path, height=3.5,
                     startRow=1,startCol=13,format=TRUE,var_list=c("SubCustomer.sum","SubCustomer.JPO")
         )

```

## SuCustomer Plat Breakout
```{r CustomerPlatBreakout} 
platform_levels<-levels(factor(def_data$PlatformPortfolio))
for(p in platform_levels){
  file_p<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",p)))
  (Breakout<-build_plot(
    data=def_data %>% filter(Fiscal_Year>=2000&PlatformPortfolio==p& Fiscal_YQ<2024),
chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SubCustomer.JPO", #color_var
  facet_var="SubCustomer.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)") +date_x_year_breaks(1990,2020,5)#,partial_year=2024,partial_label="\nQ1")
)
  if(!dir.exists(file.path("../output/AcqTrends/Platform",file_p)))
    dir.create(file.path("../output/AcqTrends/Platform",file_p))
  
  log_plot(plot=Breakout, df=def_data  %>% filter(Fiscal_YQ<2024&PlatformPortfolio==p),
           filename=paste(file_p,"subcustomer",sep="_"),xlsx=paste("DoD",file_p,"Contracts.xlsx",sep="_"),
           sheet="Cust",path=file.path("../output/AcqTrends/Platform/",file_p), height=3.5,
           startRow=1,startCol=13,format=TRUE,#,var_list=c("PricingUCA.sumlong","PricingUCA"),
           output_doc_png=TRUE,excel_y_var=TRUE
           )
  
}
```

## SubCustomer Covid19
```{r SubCustomer}
cust_covid<-def_data %>% filter(Fiscal_YQ<2024) %>% group_by(SubCustomer.JPO,SubCustomer.sum,Fiscal_Year) %>%
  summarise(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm = TRUE),
            COVID19obligated=sum(COVID19obligated,na.rm = TRUE))%>%
  mutate(Action_other=Action_Obligation_Then_Year-COVID19obligated) 

cust_covid %<>% select(-Action_Obligation_Then_Year) %>%
  pivot_longer(cols=c(COVID19obligated,Action_other),  
               names_to = "Covid",values_to="Action_Obligation") %>%
  mutate(SubCustomer.COVID=ifelse(Covid=="COVID19obligated","COVID19 Related",
                                  as.character(SubCustomer.JPO)))

cust_covid %<>% deflate( money_var="Action_Obligation",fy_var="Fiscal_Year")



(
SubCustomerCovid<-build_plot(
  data=cust_covid,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SubCustomer.COVID", #color_var
  facet_var="SubCustomer.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="subcustomer_covid.png", SubCustomerCovid, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="subcustomer_covid.svg", SubCustomerCovid+facet_wrap(~SubCustomer.sum,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

write.csv(file="..//Output//AcqTrends//subcustomer_covid.csv",row.names = FALSE, na = "",
          pivot_wider(SubCustomerCovid$data,id_cols=c(SubCustomer.sum,SubCustomer.COVID),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23))

write.csv(file="..//Output//AcqTrends//subcustomer_covid.csv",row.names = FALSE, na = "",
          cust_covid %>% group_by(SubCustomer.sum,SubCustomer.COVID,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(SubCustomer.sum,SubCustomer.COVID),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))


```

## SubCustomer Product/Service/R&D
```{r SubCustomerPSR}

(
SubCustomerPSR<-build_plot(
  data=full_data,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SimpleArea", #color_var
  facet_var="SubCustomer.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2022 $s)")
)

# ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="subcustomer_PSR.png", SubCustomerPSR, 
#              width=6.5, height= 4, units="in",size=11
#              )
ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="subcustomer_PSR.png", SubCustomerPSR, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )
```

## SubCustomer Competition
```{r SubCustomerComp}
def_data$SubCustomer.platform
(
SubCustomerComp_line<-build_plot(
  data=def_data %>% filter(Fiscal_YQ<2024),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.effective.only", #color_var
  facet_var="SubCustomer.platform", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2022 $s)")
)

# ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="subcustomer_PSR.png", SubCustomerPSR, 
#              width=6.5, height= 4, units="in",size=11
#              )
ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="subcustomer_Comp_line.png", SubCustomerComp_line, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )

(
SubCustomerComp_bar<-build_plot(
  data=def_data %>% filter(Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  facet_var="SubCustomer.platform", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2022 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="subcustomer_Comp_bar.png", SubCustomerComp_bar, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )


write.csv(file="..//Output//AcqTrends//subcustomer_competition.csv",row.names = FALSE, na = "",
          SubCustomerComp_line$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(SubCustomer.platform,Competition.effective.only),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)%>%
            arrange(SubCustomer.platform,Competition.effective.only))

```

## SubCustomer Pricing History
```{r SubCustomerPricing}
summary(factor(PricingUpdate$SubCustomer.platform))
(
PricingHistoryCust<-build_plot(
  data=PricingUpdate %>% filter(!SubCustomer.platform %in%
                                  c("DECA (Largely Unreported)","Uncategorized")&
                                  Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=hist_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingInflation", #color_var
  facet_var="SubCustomer.platform", #facet_var
  column_key=hist_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(1980,2023,10)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)",
       caption="Note: Uncategorized customer not shown.\nSource: FPDS and CSIS analysis.")
)

# ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="SubCustomer_Pricing_History.png", PricingHistory, 
#              width=6.5, height= 4, units="in",size=11
#              )


ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="SubCustomer_Pricing_History.png", PricingHistoryCust,  
             width=6.5, height= 3, units="in",size=12, lineheight=1.2
             )


ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="SubCustomer_Pricing_History.svg", PricingHistoryCust,  
             width=6.5, height= 3, units="in",size=12, lineheight=1.2
             )

log_plot(plot=PricingHistoryCust, df=PricingUpdate  %>% filter(!SubCustomer.platform %in%
                                  c("DECA (Largely Unreported)","Uncategorized")&
                                  Fiscal_YQ<2024),
                     filename="acq_pricing_history_subcust",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="PriceHistSubCust",path="../output/AcqTrends/",second_path=online_path, height=3.5,
                     format=TRUE#,var_list=c("PricingInflation")
         )

```


## SubCustomer Commercial
```{r Commercial}
def_data$AnyCommercialText<-factor(def_data$AnyCommercial)
levels(def_data$AnyCommercialText)<-list(
  "Not Classified\nas Commercial"="N",
  "Non-development\nor Commercial Similar"= "NonDev",
  "Any Commercial\nClassification"="Y"
  
)

(
CommercialCust<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="AnyCommercialText", #color_var
  facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")+
      date_x_year_breaks(2000,2023,6)#,partial_year=2024,partial_label="\nQ1")
    

)
 

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="subcustomer_commercial.png", CommercialCust, 
             width=6, height= 5.5, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="subcustomer_commercial.svg", CommercialCust,#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,
             filename="subcustomer_commercial_keynote.png", CommercialCust+
               labs(title="DOD Contract Obligations by  Commercial Categorization, 2000–2023"),
             width=13, height= 5.5, units="in", size=20, lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="subcustomer_commercial_keynote.svg", CommercialCust+
               labs(title="DOD Contract Obligations by  Commercial Categorization, 2000–2023"),
             width=13, height= 5.5, units="in", size=20, lineheight = 1.2
             )


log_plot(plot=CommercialCust, df=def_data %>% filter(Fiscal_YQ<2024),
                     filename="acq_fig5_5_subcustomer_commercial",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="5-5 CustComm",path="../output/AcqTrends/",second_path=online_path, height=4,
                     startRow=1,startCol=13,format=TRUE,
         var_list=c("SubCustomer.platform","AnyCommercialText"),
         output_doc_svg=TRUE
         )

```

## Subcustomer GFE
```{r GFE subcustomer}

(
GFEcust<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="gfe_gfp_value", #color_var
  facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")+
      date_x_year_breaks(2000,2022,2)#,partial_year=2024,partial_label="\nOct–Nov")

)



```

# Platform
## Topline  Platform
```{r Platform}
(
Platform<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=1990 & Fiscal_YQ<2024),
  chart_geom = "Line Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PlatformPortfolio", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(1990,2020,8)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2022 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_platform.png", Platform, 
             width=12, height= 6, units="in",size=14,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_platform.svg", Platform, 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_platform.emf", Platform+geom_line(
  size=1,aes(x=dFYear,y=Action_Obligation_OMB25_GDP23,color=PlatformPortfolio)),
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )


(
Platform_Bar<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=1990 & Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PlatformPortfolio", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(1990,2020,8)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2022 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_platform_bar.png", Platform_Bar, 
             width=11, height= 5.5, units="in",size=14,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_platform_bar.emf", Platform_Bar,
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_platform_bar_keynote.svg", Platform_Bar+
               labs(title="DOD Contract Obligations by Platform Portfolio, 2000–2023"),
             width=13, height= 5.5, units="in", size=20, lineheight = 0.75
             )


log_plot(plot=Platform_Bar+theme(plot.margin = margin(t=0,r=0.25,b=0.1,l=0.1,"inches")), df=def_data   %>% filter(Fiscal_YQ<2024),
                     filename="acq_fig3_2_platform",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="3-2 Plat",path="../output/AcqTrends/",second_path=online_path, height=3.5,
                     startRow=1,startCol=12,format=TRUE#var_list=c("Source","fiscal_quarter"),
         )

```

## Plat Cust Breakout
```{r PlatCustBreakout} 
subcustomer_levels<-levels(factor(def_data$SubCustomer.sum))
for(c in subcustomer_levels){
  file_c<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",c)))
  (Breakout<-build_plot(
    data=def_data %>% filter(Fiscal_Year>=2000&SubCustomer.sum==c& Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PlatformPortfolio", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(1990,2020,8)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2022 $s)")
)
  
  if(!dir.exists(file.path("../output/AcqTrends/Customer",file_c)))
    dir.create(file.path("../output/AcqTrends/Customer",file_c))
  
  log_plot(plot=Breakout, df=def_data  %>% filter(Fiscal_YQ<2024&SubCustomer.sum==c),
           filename=paste(file_c,"platform",sep="_"),xlsx=paste(file_c,"Contracts.xlsx",sep="_"),
           sheet="Plat",path=file.path("../output/AcqTrends/Customer/",file_c), height=3.5,
           startRow=1,startCol=13,format=TRUE,#,var_list=c("PricingUCA.sumlong","PricingUCA"),
           output_doc_png=TRUE,excel_y_var=TRUE
           )
  
}
```



## Platform by Service
```{r Platform}
for(s in c("Army","Navy","Air Force")){
  
  (
    Platform<-build_plot(
      data=full_data %>% filter(SubCustomer.sum==s),
      chart_geom = "Line Chart",
      share = FALSE,
      labels_and_colors=labels_and_colors,
      # NA, #VAR.ncol
      x_var="dFYear",#alpha_var="YTD", #x_var
      y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
      color_var="PlatformPortfolio", #color_var
      facet_var="PlatformPortfolio", #facet_var
      column_key=column_key,
      format=TRUE,
      ytextposition=FALSE
    )+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
      # theme(strip.text.y = element_text(angle=0))+
      # theme(axis.text.x = element_text(angle=90))+
      #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
      #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
      #             )+labs(title=NULL,
      # x="Fiscal Year",
      # y="Percent of Obligations",
      # color="Competition")+
      theme(legend.position = "none")+
      labs(y="Obligations (Constant 2022 $s)")
  )
  
  ggsave600dpi(paste("..//Output//AcqTrends//",s,"_platform.png",sep=""), Platform, 
               width=12, height= 6, units="in",size=14,lineheight = 1.2
  )
  
  ggsave600dpi(paste("..//Output//AcqTrends//",s,"_platform.svg",sep=""), Platform, 
               width=6.5, height= 4, units="in",size=11,lineheight = 1.2
  )
  
  ggsave600dpi(paste("..//Output//AcqTrends//",s,"_platform.emf",sep=""), Platform+geom_line(
    size=1,aes(x=dFYear,y=Action_Obligation_OMB25_GDP23,color=PlatformPortfolio)),
    width=6.5, height= 4, units="in",size=11,lineheight = 1.2
  )
}
# 
# (
# Platform_Bar<-build_plot(
#   data=full_data,
#   chart_geom = "Bar Chart",
#   share = FALSE,
#   labels_and_colors=labels_and_colors,
#   # NA, #VAR.ncol
#   x_var="dFYear",#alpha_var="YTD", #x_var
#   y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
#   color_var="PlatformPortfolio", #color_var
#   facet_var="PlatformPortfolio", #facet_var
#   column_key=column_key,
#   format=TRUE,
#   ytextposition=FALSE
# )+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
#   # theme(strip.text.y = element_text(angle=0))+
#  # theme(axis.text.x = element_text(angle=90))+
#  #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
#  #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
#  #             )+labs(title=NULL,
#   # x="Fiscal Year",
#   # y="Percent of Obligations",
#   # color="Competition")+
#   theme(legend.position = "none")+
#   labs(y="Obligations (Constant 2022 $s)")
# )
# 
# ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_platform_bar.png", Platform_Bar, 
#              width=12, height= 6, units="in",size=12,lineheight = 1.2
#              )
# 
# ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_platform_bar.emf", Platform_Bar,
#              width=6.5, height= 4, units="in",size=11,lineheight = 1.2
#              )
# 
# write.csv(file="..//Output//AcqTrends//topline_platform_current.csv",row.names = FALSE, na = "",
#           full_data %>% group_by(PlatformPortfolio,Fiscal_Year)%>%
#             dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
#           pivot_wider(id_cols=c(PlatformPortfolio),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%arrange(PlatformPortfolio))
# 
# wb <- loadWorkbook("..//Output//AcqTrends//DoD_Acq_Trends_Contracts.xlsx")
# createSheet(wb, name = "Platform Portfolio")
# writeData(wb, output_TY, sheet = "Platform Portfolio", startRow = 15, startCol = 13)
# saveWorkbook(wb,file="..//Output//AcqTrends//DoD_Acq_Trends_Contracts.xlsx",overwrite = TRUE)

```

## Platform SubCustomer
```{r PlatformSubCustomer}

(
PlatformSubCustomer<-build_plot(
  data=full_data,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SubCustomer.platform", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2022 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="platform_subcustomer.png", PlatformSubCustomer, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

```

## Platform PSR
```{r PlatformPSR}

(
PlatformPSR<-build_plot(
  data=full_data,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SimpleArea", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2022 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="platform_PSR.png", PlatformPSR, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

```


## Platform Products
```{r PlatformPSR}
summary(full_data$SimpleArea)
(
PlatformProducts<-build_plot(
  data=full_data %>% filter(SimpleArea=="Products (All)"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SimpleArea", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2022 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="platform_products.png", PlatformProducts, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

write.csv(file="..//Output//AcqTrends//platform_products_cur.csv",row.names = FALSE, na = "",
          full_data%>% filter(SimpleArea=="Products (All)") %>% 
            mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            group_by(PlatformPortfolio, SimpleArea,Fiscal_Year) %>%
            summarise(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE)) %>%
            pivot_wider(id_cols=c(PlatformPortfolio, SimpleArea),
                        names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(PlatformPortfolio,SimpleArea))



```

## Platform R&D
```{r PlatformPSR}
(
PlatformRnD<-build_plot(
  data=def_data %>% filter(SimpleArea=="R&D"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SimpleArea", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2022 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="PlatformRnD.png", PlatformRnD, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

```
  
## Platform Quarter
```{r PlatformQ}
(
PlatformQ<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2013 & Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="fiscal_quarter", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2013,2020,4)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")
)

(
OnMQ<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<2024 &
                             PlatformPortfolio=="Ordnance and Missiles"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="fiscal_quarter", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2020,8)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
    theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")
)


ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="PlatformQ.png", PlatformQ, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="PlatformQ_slide.svg", PlatformQ+
               labs(title="Defense Contract Obligations by Platform Portfolio, FY2013-FY2024 Oct-Nov")+
               theme(plot.title = element_text(margin=margin(t=0.1,r=0,b=0.1,l=0,"inches")),
                     plot.margin = margin(t=0,r=0.1,b=0.1,l=0.1,"inches")), 
             width=10, height= 5.5, units="in", size=11, lineheight = 0.75
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="PlatformQ_keynote.svg", PlatformQ+
               labs(title="Ordnance & Missile Contract Obligations, 2000–2023"),
             width=9, height= 5.5, units="in", size=20, lineheight = 0.75
             )


ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="OnMQ_keynote.png", OnMQ+
               labs(title="Ordnance & Missile Contract Obligations, 2000–2023"),
             width=9, height= 5.5, units="in", size=20, lineheight = 0.75
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="OnMQ_keynote.svg", OnMQ+
               labs(title="Ordnance & Missile Contract Obligations, 2000–2023"),
             width=9, height= 5.5, units="in", size=20, lineheight = 0.75
             )



ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="OnMQ.png", OnMQ, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )


output_TY<-def_data %>% group_by(PlatformPortfolio,Fiscal_Year,fiscal_quarter)%>%
  filter(Fiscal_Year>=2000 & as.character(fiscal_quarter)<=1)%>%
            dplyr::summarize(Action_Obligation_Then_Year=
                               sum(Action_Obligation_Then_Year,na.rm=TRUE),
                             max_fq=max(as.character(fiscal_quarter)))%>%
          pivot_wider(id_cols=c(PlatformPortfolio,max_fq),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
  arrange(PlatformPortfolio,max_fq)

write.csv(file="..//Output//AcqTrends//platform_YTD_current.csv",row.names = FALSE, na = "",
          output_TY)



output_TY<-def_data %>% group_by(PlatformPortfolio,Fiscal_Year,fiscal_quarter)%>%
  filter(Fiscal_Year>=2000)%>%
            dplyr::summarize(Action_Obligation_Then_Year=
                               sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(PlatformPortfolio,fiscal_quarter),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
  arrange(PlatformPortfolio,fiscal_quarter)

write.csv(file="..//Output//AcqTrends//platform_quarter_current.csv",row.names = FALSE, na = "",
          output_TY)

```


## Platform Vendor
```{r PlatformVendor}

(
PlatformVendor_share<-build_plot(
  data=full_data %>% filter(PlatformPortfolio!="Unlabeled" & Fiscal_Year<=2020) ,
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Percent of Obligations",
    caption="Note: McDonnell Douglas is grouped with the Big-5.\nSource: FPDS and CSIS analysis.")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="platform_vendor_share.png", PlatformVendor_share, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )



(
PlatformVendor_dollar<-build_plot(
  data=full_data %>% filter(PlatformPortfolio!="Unlabeled" & Fiscal_Year<=2020) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Percent of Obligations",
    caption="Note: The merger of Raytheon and United Technologies took place in April of 2020 and thus did not\nmake the cutoff for inclusion in FY2020. McDonnell Douglas is grouped with the Big-5.\n\nSource: FPDS and CSIS analysis.")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="platform_vendor_dollar.png", PlatformVendor_dollar, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

write.csv(file="..//Output//AcqTrends//platform_vendor.csv",row.names = FALSE, na = "",
          PlatformVendor_dollar$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlatformPortfolio,Shiny.VendorSize),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)%>%
            arrange(PlatformPortfolio,Shiny.VendorSize))


```

## Platform Vendor International
```{r PlatformVendorIntl}

(
PlatformVendorIntl_share<-build_plot(
  data=full_data %>% filter(PlatformPortfolio!="Unlabeled" & Fiscal_YQ<2024 & Fiscal_YQ>=2000) ,
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="VendorSize_Intl", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,6)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Percent of Obligations",
    caption="Source: FPDS and CSIS analysis.")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="platform_vendor_intl_share.png", PlatformVendorIntl_share, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )



(
PlatformVendorIntl_dollar<-build_plot(
  data=full_data %>% filter(PlatformPortfolio!="Unlabeled" & Fiscal_YQ<2024 & Fiscal_YQ>=2000) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="VendorSize_Intl", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,6)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Percent of Obligations",
    caption="Source: FPDS and CSIS analysis.")
)

log_plot(plot=PlatformVendorIntl_dollar, df=full_data  %>% filter(Fiscal_YQ<2024),
                     filename="acq_fig6_2_plat_vendor_intl",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="6-2 PlatVend",path="../output/AcqTrends/",second_path=online_path, height=5,
         excel_y_var = TRUE, excel_formulas = TRUE,
                     format=TRUE,#,var_list=c("SimpleArea","Competition.multisum")
         )

```


## Platform Comp
```{r PlatformComp}
# labels_and_colors<-def_lc
# column_key<-def_ck
(
PlatformComp_bar<-build_plot(
  data=def_data %>% filter(PlatformPortfolio!="Unlabeled"  &Fiscal_Year>=1991 & Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = scales::date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")#+
  # labs(y="Obligations (Constant 2022 $s)")
)

(
PlatformComp_bar2007<-build_plot(
  data=def_data %>% filter(PlatformPortfolio!="Unlabeled"  &Fiscal_Year>=2007 & Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2007,2023,4)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")#+
  # labs(y="Obligations (Constant 2022 $s)")
)


(
PlatformComp_line<-build_plot(
  data=def_data %>% filter(PlatformPortfolio!="Unlabeled" &Fiscal_Year>=1992 & Fiscal_YQ<2024),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.effective.only", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = scales::date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")#+
  # labs(y="Obligations (Constant 2022 $s)")
)


ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="platform_comp_bar.png", PlatformComp_bar, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )


ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="platform_comp_line.png", PlatformComp_line, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

write.csv(file="..//Output//AcqTrends//platform_comp.csv",row.names = FALSE, na = "",
          PlatformComp_line$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlatformPortfolio,Competition.effective.only),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)%>%
            arrange(PlatformPortfolio,Competition.effective.only))


```




### Platform Only One Source 
```{r PlatNoComp}
summary(def_data$gfe_gfp_code)
(
PlatNoComp<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024 & !is.na(PlatformPortfolio)&
                             PlatformPortfolio!="Unlabeled") ,
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="No.Competition.sum", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")+
    scale_x_date(breaks=as.Date(c(paste(seq(2000,2021,3),"-01-01",sep=""))),
                                                   date_labels="'%y")
)
```

## Platform Commercial
```{r Commercial}
def_data$AnyCommercialText<-factor(def_data$AnyCommercial)
levels(def_data$AnyCommercialText)<-list(
  "Not Classified\nas Commercial"="N",
  "Non-Development\nor Commercial Similar"= "NonDev",
  "Any Commercial\nClassification"="Y"
  
)


(
CommercialPlat<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="AnyCommercialText", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="platform_commercial.png", CommercialPlat, 
             width=6, height= 5.5, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="platform_commercial.svg", CommercialPlat,#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="platform_commercial.emf", CommercialPlat,#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )


write.csv(file="..//Output//AcqTrends//platform_commercial.csv",row.names = FALSE, na = "",
          CommercialPlat$data%>%mutate(Fiscal_Year=year(dFYear)) %>%
          pivot_wider(id_cols=c(SubCustomer.platform,AnyCommercialText),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23))

write.csv(file="..//Output//AcqTrends//platform_commercial_current.csv",row.names = FALSE, na = "",
          def_data %>% group_by(PlatformPortfolio,AnyCommercialText,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(PlatformPortfolio,AnyCommercialText),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(PlatformPortfolio,AnyCommercialText))

```



## Platform Multiyear
```{r PlatformMultiyear}

    def_data<-def_data%>% mutate(multiyearcontracttext=factor(multiyearcontract,levels=c("0","1"),
                              labels=c("Not Multiyear","Multiyear Contract")))



def_data<-def_data %>% group_by(Fiscal_Year,PlatformPortfolio)%>%
  mutate(pPlatFYear=Action_Obligation_OMB25_GDP23/sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))

(
PlatformMultiYear<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<2024 ),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="multiyearcontracttext", #color_var
  facet_var="PlatformPortfolio",
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,6)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)")
)

def_data<-def_data %>% group_by(Fiscal_Year,PlatformPortfolio)%>%
  mutate(pPlatFYear=Action_Obligation_OMB25_GDP23/sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))
(
PlatformMultiYearShare<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<2024 &
                             (multiyearcontract==1)&
                              !is.na(PlatformPortfolio)&
                              PlatformPortfolio!="Unlabeled"), #is.na(multiyearcontract)|
  chart_geom = "Line Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",
  alpha_var="YTD", #x_var
  y_var="pPlatFYear", #VAR.y.variable
  # color_var="multiyearcontracttext", #color_var
  facet_var="PlatformPortfolio",
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,6)+#,partial_year=2024,partial_label="\nQ1")   
    
  theme(legend.position = "bottom")+
  labs(y="Share of Portfolio Obligations\nGoing to Multiyear Contracts",
       caption="Note: When the multiyear column is blank, transactions are treated as not multiyear.\nSource: FPDS and CSIS analysis.")+
    scale_y_continuous(labels = percent)
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="Platform_MultiYear.png", PlatformMultiYear,  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="Platform_MultiYearShare.png", PlatformMultiYearShare+facet_wrap(PlatformPortfolio~.,nrow=2)+
                labs(y="Share of Obligations",
       caption="Other products / services / R&D not shown. When the multiyear column is empty, transactions are treated as not multiyear.\nSource: FPDS and CSIS analysis."),  
             width=12, height= 6, units="in",size=16, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="Platform_MultiYearShare_keynote.png", 
               PlatformMultiYearShare+labs(
                 title="DOD Share of Contract Obligations to Multiyear Contracts, 2000–2023")+
                 facet_wrap(PlatformPortfolio~.,nrow=2)+
                labs(y="Share of Obligations",
       caption="Note: When the multiyear column is empty, transactions are treated as not multiyear.\nSource: FPDS and CSIS analysis.")+geom_line(aes(x=dFYear,y=pPlatFYear,group=YTD,linetype=YTD),linewidth=2),  
             width=13, height= 5.5, units="in",size=20, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="Platform_MultiYearShare_keynote.svg", 
               PlatformMultiYearShare+labs(
                 title="DOD Share of Contract Obligations to Multiyear Contracts, 2000–2023")+
                 facet_wrap(PlatformPortfolio~.,nrow=2)+
                labs(y="Share of Obligations",
       caption="Note: When the multiyear column is empty, transactions are treated as not multiyear.\nSource: FPDS and CSIS analysis."),  
             width=13, height= 5.5, units="in",size=20, lineheight=1.2
             )

write.csv(file="..//Output//AcqTrends//PlatformMultiYearShare.csv",row.names = FALSE, na = "",
  pivot_wider(PlatformMultiYearShare$data %>% 
                        arrange(dFYear) %>% mutate(Fiscal_Year=lubridate::year(dFYear)),
                      id_cols=c(PlatformPortfolio,YTD),
                      names_from=Fiscal_Year,values_from=pPlatFYear)%>%
  arrange(PlatformPortfolio))
  
log_plot(PlatformMultiYearShare, full_data %>% filter(Fiscal_YQ<2024) ,
                     filename="acq_fig4_2_multiyear",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="4-2 Multi",path="../output/AcqTrends/",second_path=online_path, height=3.5,excel_y_var = TRUE,excel_formulas = FALSE,
                     startRow=1,startCol=13,format=TRUE,y_var="Action_Obligation_OMB25_GDP23",
         var_list=c("PlatformPortfolio","multiyearcontracttext"),
         )

```

## Platform  Ukraine
```{r Platform}

ukr_data$IsUkraine<-ifelse(ukr_data$nationalinterestactioncode=="O22U" &
                             !is.na(ukr_data$nationalinterestactioncode=="O22U"),"UKRAINE MISSION SUPPORT","All Other")

ukr_data %>% group_by(nationalinterestactioncode)%>%
  filter(Fiscal_Year==2022) %>% summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))

(
Platform_Ukr_Bar<-build_plot(
  data=ukr_data %>% filter(Fiscal_Year>=1990),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ukr_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="IsUkraine", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=ukr_ck,
  format=TRUE,
  ytextposition=FALSE
)+  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2022 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="Munitions//ukraine_platform_bar.png", Platform_Ukr_Bar, 
             width=11, height= 5.5, units="in",size=14,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="Munitions//ukraine_platform_bar.emf", Platform_Ukr_Bar,
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

output_TY<-ukr_data %>% group_by(PlatformPortfolio,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(PlatformPortfolio,IsUkraine),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%arrange(PlatformPortfolio,IsUkraine)

write.csv(file="..//Output//AcqTrends//Munitions//ukraine_platform_current.csv",row.names = FALSE, na = "",
          output_TY)

# wb <- loadWorkbook("..//Output//AcqTrends//DoD_Acq_Trends_Contracts.xlsx")
# createSheet(wb, name = "Platform Portfolio")
# writeData(wb, output_TY, sheet = "Platform Portfolio", startRow = 15, startCol = 1)
# saveWorkbook(wb,file="..//Output//AcqTrends//DoD_Acq_Trends_Contracts.xlsx",overwrite = TRUE)
# rm(wb)

```


## Platform GFE
```{r GFEplatform}
def_data<-full_data %>% group_by(Fiscal_Year,PlatformPortfolio)%>%
  mutate(pPlatFYear=Action_Obligation_OMB24_GDP22/sum(Action_Obligation_OMB24_GDP22,na.rm=TRUE))
def_data$gfe_gfp_code
(
PlatformGFEshare<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024 & gfe_gfp_code=="Y"&
                             !is.na(PlatformPortfolio) & PlatformPortfolio!="Unlabeled") ,
  chart_geom = "Line Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  # color_var="gfe_gfp_value", #color_var
  y_var="pPlatFYear", #VAR.y.variable
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  date_x_year_breaks(2007,2023,4)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "bottom")+
  labs(y="Share of Portfolio Obligations\nWith Government Furnished Equipment or Property"
       # caption="Note: When the multiyear column is blank, transactions are treated as not multiyear.\nSource: FPDS and CSIS analysis."
       )+
    scale_y_continuous(labels = percent)
)

log_plot(PlatformGFEshare, def_data%>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024 & gfe_gfp_code=="Y"&
                             !is.na(PlatformPortfolio) & PlatformPortfolio!="Unlabeled") ,
                     filename="acq_fig4_3_gfe",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="4-3 GFE",path="../output/AcqTrends/",second_path=online_path, height=3,excel_y_var = TRUE,excel_formulas = FALSE,
                     startRow=1,startCol=13,format=TRUE,y_var="Action_Obligation_OMB24_GDP22"
         # var_list=c("PlatformPortfolio","gfe_gfp_value"),
         )

ggsave(file=file.path(online_path,"acq_fig4_3_com_gfe.svg"),
       gridExtra::grid.arrange(
         PlatformComp_bar2007+labs(
           title=NULL,
           y="Share of Obligations by \nExtent of Compatition\n",
           caption = NULL,x=NULL)+theme(legend.position = "bottom",text=element_text(size=12),
                                        plot.margin = margin(t=0,b=0,l=0.1,r=0.5,unit="inches")),
         PlatformGFEshare+labs(
           y="Share of Obligations\nWith Government Furnished\nEquipment or Property",caption=NULL)+theme(text=element_text(size=12),
                                                                                                                                        plot.caption = element_text(size=round(20 * 5/6,0)),
                                                                                                                                        plot.margin =
                                                                                                                                          margin(t=0,b=0,l=0.1,r=0.5,unit="inches")),
         layout_matrix = rbind(1,1,1,2,2)),
       width=6.5, height= 6.5, units="in") #, size=20, lineheight = 0.75

```


# Vendor Size


## Topline Vendor Size
```{r ToplineVendor}

(
ToplineVendor<-build_plot(
  data=full_data %>% filter(Fiscal_Year>=1991& Fiscal_YQ<2024  ),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(1990,2020,5)+#,partial_year=2024,partial_label="\nQ1")
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)",
       caption="Source: FPDS and CSIS analysis.")
)

(
ToplineVendor_line<-build_plot(
  data=full_data %>% filter(Fiscal_Year>=1991&Fiscal_YQ<2024),
  chart_geom = "Line Chart",
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE,
  share=TRUE
)+date_x_year_breaks(1990,2019,5)+#,partial_year=2024,partial_label="\nQ1")
    
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April of 2020\n and thus did not make the cutofff for inclusion in FY2020.")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_vendor_wide.png", ToplineVendor+
  labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=12, height= 6, units="in",size=12,lineheight=1
             )


ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_vendor_cq.png", ToplineVendor+
  labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April\nof 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_vendor_cq.svg", ToplineVendor+
  labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April\nof 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_vendor.png", ToplineVendor, 
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_vendor.eps", ToplineVendor+
  labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April\nof 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )



log_plot(plot=ToplineVendor, df=full_data  %>% filter(Fiscal_YQ<2024 ),
                     filename="acq_fig6_X_vendor",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="6-X Vend",path="../output/AcqTrends/",second_path=online_path, height=3.5,
                     startRow=1,startCol=12,format=TRUE,#,var_list=c("SimpleArea","Competition.multisum")
         )


```



### Topline Vendor International
```{r ToplineVendor}


(
ToplineVendorIntl<-build_plot(
  data=full_data %>% filter(Fiscal_Year>=2000& Fiscal_YQ<=2023.2 ),# & Fiscal_Year<=2021
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="VendorSize_Intl", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE,
  reverse_color=TRUE
)+scale_x_date("Fiscal Year",labels = scales::date_format("'%y"))+
  date_x_year_breaks(2000,2022,3,partial_year=2023,partial_label="\nQ1–Q2")+
    
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)",
       caption="Source: FPDS and CSIS analysis.")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_vendor_intl_square.png", ToplineVendorIntl+
  labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis."), 
             width=6, height= 5, units="in",size=12,lineheight=1
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,
             filename="topline_vendor_intl_keynote.svg", ToplineVendorIntl+
               labs(title="DOD Contract Obligations, 2000–2023 Q2"),
             width=9, height= 5.5, units="in", size=20, lineheight = 0.75
             )

log_plot(plot=ToplineVendorIntl, df=full_data  %>% filter(Fiscal_YQ<=2023.2),
                     filename="acq_fig6_1_vendor_intl",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="6-1 VendIntl",path="../output/AcqTrends/",second_path=online_path, height=3.5,
         excel_y_var = TRUE, excel_formulas = TRUE,
                     format=TRUE,#,var_list=c("SimpleArea","Competition.multisum")
         )

```

## Big 5 Breakout
```{r ToplineVendor}

big5<-read.delim(file.path("..","data","semi_clean","Defense_Vendor.sp_TopVendorHistoryCustomer.txt"),sep="\t")
big5<-read_and_join_experiment(big5,lookup_file="Lookup_ParentID.csv",
                               path="C:\\Users\\gsand\\Repositories\\Lookup-Tables\\",
                                 # "https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                               dir="vendor/",           
                               add_var = c("Top6","IsPreTop6"),#"USAID region",
                               by=c("ParentID"="ParentID"),
                               skip_check_var=c("Top6","IsPreTop6"),
                               # missing_file="missing_DSCA_iso.csv"
)
big5<-big5 %>% filter(Top6==1|IsPreTop6==1)
big5$Big5<-big5$ParentID
big5$Big5[big5$JointVenture==1]<-"Big 5 Joint Venture"
big5$Big5[big5$Big5=="LOCKHEED"]<-"LOCKHEED MARTIN"
big5$Big5[big5$Big5=="GRUMMAN"]<-"NORTHROP GRUMMAN"
big5$SumOfobligatedAmount<-text_to_number(big5$SumOfobligatedAmount)
big5_wide <-big5 %>% group_by(Big5,Fiscal_Year) %>% filter(Fiscal_Year>=1990) %>%
  summarise(Action_Obligation=sum(SumOfobligatedAmount,na.rm=TRUE)) %>%
  pivot_wider(id_cols=Big5,names_from=Fiscal_Year,values_from=Action_Obligation) 

write.csv(big5_wide,file=file.path("..","Output","AcqTrends","big5_wide.csv"),row.names=FALSE)

(
ToplineVendor<-build_plot(
  data=full_data %>% filter(Fiscal_Year<=2020),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"),date_breaks = "2 years")+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)",
       caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April 2020 and thus did not make the cutofff for inclusion in FY2020.")
)

(
ToplineVendor_line<-build_plot(
  data=full_data %>% filter(Fiscal_Year<=2020),
  chart_geom = "Line Chart",
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE,
  share=TRUE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April of 2020\n and thus did not make the cutofff for inclusion in FY2020.")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_vendor_wide.png", ToplineVendor+
  labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=12, height= 6, units="in",size=12,lineheight=1
             )


ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_vendor_cq.png", ToplineVendor+
  labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April\nof 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_vendor_cq.svg", ToplineVendor+
  labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April\nof 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_vendor.png", ToplineVendor, 
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_vendor.eps", ToplineVendor+
  labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April\nof 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )


write.csv(file="..//Output//AcqTrends//topline_vendor_cur.csv",row.names = FALSE, na = "",
          full_data %>% group_by(Shiny.VendorSize,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(Shiny.VendorSize),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>% arrange(Shiny.VendorSize))


write.csv(file="..//Output//AcqTrends//topline_vendor.csv",row.names = FALSE, na = "",
          ToplineVendor$data%>% mutate(Fiscal_Year=lubridate::year(dFYear),
                                       bAction_Obligation_OMB25_GDP23=Action_Obligation_OMB25_GDP23/1000000000)%>%
            pivot_wider(id_cols=c(Shiny.VendorSize),
                        names_from=Fiscal_Year,values_from=bAction_Obligation_OMB25_GDP23)%>%arrange(Shiny.VendorSize))

```

## Vendor Size Plat Breakout
```{r CustomerPlatBreakout} 
platform_levels<-levels(factor(def_data$PlatformPortfolio))
for(p in platform_levels){
  file_p<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",p)))
  (Breakout<-build_plot(
    data=full_data %>% filter(Fiscal_Year>=2000&PlatformPortfolio==p& Fiscal_YQ<2024),
chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  # facet_var="SubCustomer.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)") +date_x_year_breaks(1990,2020,5)#,partial_year=2024,partial_label="\nQ1")
)
  if(!dir.exists(file.path("../output/AcqTrends/Platform",file_p)))
    dir.create(file.path("../output/AcqTrends/Platform",file_p))
  
  log_plot(plot=Breakout, df=full_data  %>% filter(Fiscal_YQ<2024&PlatformPortfolio==p),
           filename=paste(file_p,"vendor",sep="_"),xlsx=paste("DoD",file_p,"Contracts.xlsx",sep="_"),
           sheet="vend",path=file.path("../output/AcqTrends/Platform/",file_p), height=3.5,
           startRow=1,format=TRUE,#,var_list=c("PricingUCA.sumlong","PricingUCA"),
           output_doc_png=TRUE,excel_y_var=TRUE
           )
  
}
```



## Vendor Size Vehicle
```{r ToplineVendor}


(
VendorSizeVehicle<-build_plot(
  data=full_data %>% filter(Fiscal_Year<=2021 & Fiscal_Year>2000 & Shiny.VendorSize!="Unlabeled"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Vehicle.sum", #color_var
  facet_var="Shiny.VendorSize", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = scales::date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)",
       caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April 2020 and thus did not make the cutofff for inclusion in FY2020.")
)


(
VendorSizeVehicleSum<-build_plot(
  data=full_data %>% filter(Fiscal_Year<=2021 & Fiscal_Year>2000 & !Shiny.VendorSize=="Unlabeled"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Vehicle.AwardTask", #color_var
  facet_var="Shiny.VendorSize", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+facet_wrap(~Shiny.VendorSize, nrow=1)+
  labs(y="Obligations (Constant 2022 $s)",
       caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April 2020 and thus did not make the cutofff for inclusion in FY2020.\nUnlabeled vendor size excluded.")
)

(
VendorSizeVehicleSumLine<-build_plot(
  data=full_data %>% filter(Fiscal_Year<=2021 & Fiscal_Year>2000 & !is.na(Shiny.VendorSize)&
                              Shiny.VendorSize!="Unlabeled"),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Vehicle.AwardTask", #color_var
  facet_var="Shiny.VendorSize", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)",
       caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April 2020 and thus did not make the cutofff for inclusion in FY2020.")+facet_wrap(~Shiny.VendorSize, nrow=1)
)


ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="vendorsize_vehicle.png", VendorSizeVehicle+
  labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies is took place in \nApril 2020 and thus did not make the cutofff for inclusion in FY2020.\nUnlabeled vendor size excluded."),
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="vendorsize_vehicle.svg", VendorSizeVehicle+
  labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies is took place in \nApril 2020 and thus did not make the cutofff for inclusion in FY2020\nUnlabeled vendor size excluded.."),
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="vendorsize_awardtaskshare.svg", VendorSizeVehicleSumLine
+
  labs(caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies is took place in \nApril 2020 and thus did not make the cutofff for inclusion in FY2020.\nUnlabeled vendor size excluded."),
             width=6.5, height= 3.25, units="in",size=11,lineheight=1
             )


ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="vendorsize_awardtask.svg", VendorSizeVehicleSum
+
  labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies is took place in \nApril 2020 and thus did not make the cutofff for inclusion in FY2020.\nUnlabeled vendor size excluded."),
             width=6.5, height= 3.25, units="in",size=11,lineheight=1
             )

write.csv(file="..//Output//AcqTrends//vendorsize_vehicle_current.csv",row.names = FALSE, na = "",
          full_data %>% group_by(Shiny.VendorSize,Vehicle.sum,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(Shiny.VendorSize,Vehicle.sum),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(Shiny.VendorSize,Vehicle.sum))


write.csv(file="..//Output//AcqTrends//vendorsize_AwardTask_current.csv",row.names = FALSE, na = "",
          full_data %>% group_by(Shiny.VendorSize,Vehicle.AwardTask,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(Shiny.VendorSize,Vehicle.AwardTask),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(Shiny.VendorSize,Vehicle.AwardTask))

```

## Vendor Size Commercial
```{r SizePlatform}



(
ToplineVendor_line<-build_plot(
  data=def_data %>% filter(Fiscal_YQ<2024 &  Fiscal_Year>=2000 & !is.na(SimpleArea) & SimpleArea!="Unlabeled"),
  chart_geom = "Line Chart",
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  facet_var="AnyCommercial", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE,
  share=TRUE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April of 2020\n and thus did not make the cutofff for inclusion in FY2020.")
)

(
ToplineVendor_line<-build_plot(
  data=def_data %>% filter(Fiscal_YQ<2024 &  Fiscal_Year>=2000 & !is.na(SimpleArea) & SimpleArea!="Unlabeled"),
  chart_geom = "Bar Chart",
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="AnyCommercial", #color_var
  facet_var="Shiny.VendorSize", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE,
  share=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April of 2020\n and thus did not make the cutofff for inclusion in FY2020.")
)



```


## Vendor Size Pricing
```{r VendorSizePricing}
full_data$PricingUCA.1year<-as.character(full_data$PricingUCA.sum)
full_data$PricingUCA.1year[full_data$CurrentDurationIsYear=="<=1 year"]<-"<=1 Year (All Types)"



(
VendorSizePricing<-build_plot(
  data=full_data %>% filter(Fiscal_YQ<2024 & Fiscal_Year>2000 & Shiny.VendorSize!="Unlabeled" &
                             PricingUCA.sum!="Unclear"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingUCA.sum", #color_var
  facet_var="Shiny.VendorSize", #facet_var
  # second_var="CurrentDurationIsYear",
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2022 $s)",
       caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April 2020 and thus did not make the cutofff for inclusion in FY2020.")
)


  
def_lc<-prepare_labels_and_colors(full_data,path=local_path)

(
VendorSizePricing20212022share<-build_plot(
  data=full_data %>% filter(Fiscal_Year %in% c(2021, 2022)& Shiny.VendorSize!="Unlabeled" & CurrentDurationIsYear!="Unlabeled"&
                             PricingUCA.sum!="Unclear"),
  chart_geom = "Bar Chart",
  share = TRUE,
  # NA, #VAR.ncol
  x_var="PricingUCA.1year", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingUCA.1year", #color_var
  facet_var="Shiny.VendorSize", #facet_var
  second_var="Fiscal_Year",
  labels_and_colors=def_lc,
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+coord_flip()+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
    scale_y_continuous(breaks=c(0,0.2,0.4), labels=scales::percent)+
  theme(legend.position = "none",
        plot.caption = element_text(hjust = 0,face="plain"),
        axis.text.x=element_text(angle=0))+
    
  labs(y="Share of Obligations",
       x="Pricing Mechanism for Contracts\nPlanned to Last More Than a Year",
       caption="Note: Categories are mutully exclusive. Less than 0.1 percent of data is unlabeled and not shown.\nSource: FPDS and CSIS analysis.")
)

log_plot(plot=VendorSizePricing20212022share+
               facet_grid(Fiscal_Year~Shiny.VendorSize), df=full_data   ,x_var="Fiscal_Year",
                     filename="acq_fig8_1_vend_price",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="8-1 VendPrice",path="../output/AcqTrends/",second_path=online_path, height=3.5,
                     format=TRUE,excel_y_var=TRUE,excel_formulas=TRUE,
               var_list=c("Shiny.VendorSize","PricingUCA.1year"),
         output_doc_svg=TRUE
         )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="vendorsize_pricing.png", VendorSizePricing+
  labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis."),
             width=6, height= 5, units="in",size=12,lineheight=1
             )


write.csv(file="..//Output//AcqTrends//vendorsize_pricing_current.csv",row.names = FALSE, na = "",
          full_data %>% group_by(Shiny.VendorSize,PricingUCA.sum,Fiscal_Year)%>%
            filter(Fiscal_Year>=2000 & Fiscal_YQ<2024)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(Shiny.VendorSize,PricingUCA.sum),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(Shiny.VendorSize,PricingUCA.sum))


write.csv(file="..//Output//AcqTrends//VendorSize_Pricing2021.csv",row.names = FALSE, na = "",
          full_data %>% group_by(Shiny.VendorSize,PricingUCA.1year,Fiscal_Year)%>%
            filter(Fiscal_Year>=2007 & Fiscal_YQ<2024) %>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(Shiny.VendorSize,PricingUCA.1year),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(Shiny.VendorSize,PricingUCA.1year))



```







#International


###FMS identification
```{r contract_identification}

summary(full_data$foreign_funding_description)

# undebug(build_plot)

(contract_identification <-  build_plot(data=full_data ,
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="foreign_funding_description",
                            facet_var="IsFMS",
                            # second_var="StateRegion",
                            # labels_and_colors=intl_lc,
                            # column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.")+
    guides(fill=guide_legend(ncol=3)))

ggsave600dpi(contract_identification,file="../Output//AcqTrends/figure_03_contract_identification.png",size=12,lineheight=1, height =5, width=9)



```

#### Contract identification
```{r contract_identification}

summary(full_data$PlaceOfManufacture_Sum)

# undebug(build_plot)

(contract_identification <-  build_plot(data=full_data ,
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="SimpleArea",
                            # second_var="StateRegion",
                            labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.")+
    guides(fill=guide_legend(ncol=3)))


(contract_identification <-  build_plot(data=full_data %>% filter(!is.na(PlaceIsForeign)),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="PlaceIsForeign",
                            # second_var="StateRegion",
                            labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    facet_grid(  PlaceIsForeign~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s,\nVariable Axis)",
       caption="Source: FPDS and CSIS analysis.")+
    guides(fill=guide_legend(ncol=3)))


(contract_identification <-  build_plot(data=full_data%>% filter(Fiscal_Year>=2000) ,
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="VendorIsForeign",
                            # second_var="StateRegion",
                            labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.")+
    guides(fill=guide_legend(ncol=3)))


ggsave600dpi(contract_identification,file="../Output//AcqTrends/figure_03_contract_identification.png",size=12,lineheight=1, height =5, width=9)



```

###Buy America

#### Waiver Type

```{r contract_identification}

summary(full_data$PlaceOfManufactureText)
full_data$PlaceOfManufactureText20<-factor_wrap(full_data$PlaceOfManufactureText)
# undebug(build_plot)
summary(factor(full_data$PlaceOfManufactureText20))

write.csv(full_data %>% group_by(PlaceOfManufactureText,PlaceIsForeign,VendorIsForeign,OriginIsForeign) %>%
  summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23)) %>% pivot_wider(names_from=PlaceOfManufactureText,
                                                                                       values_from=Action_Obligation_OMB25_GDP23),
  file="waiver_crossref.csv")
  


full_data$OriginManufactureVendor<-NA
# full_data$OriginManufactureVendor[full_data$PlaceOfManufacture_Sum=="Manufactured Outside U.S."]<-"Foreign Manufacture or Origin"
full_data$OriginManufactureVendor[full_data$OriginIsForeign==1]<-"Foreign Manufacture or Origin"
full_data$OriginManufactureVendor[is.na(full_data$OriginManufactureVendor)]<-
  full_data$PlaceOfManufactureText[is.na(full_data$OriginManufactureVendor)]


 full_data<-csis360::read_and_join_experiment(full_data,
                                          "Location_PlaceOfManufacture.csv",
                                          by="PlaceOfManufacture",
                                          add_var=c("PlaceOfManufactureText","PlaceOfManufacture_Sum",
                                                    "PlaceOfManufacture_DoD"),
                                          skip_check_var = c("PlaceOfManufactureText","PlaceOfManufacture_Sum",
                                                             "PlaceOfManufacture_DoD"),
                                          path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                                          # path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\",
                                          # path="C:\\Users\\gsand\\Repositories\\Lookup-Tables\\",
                                          # path="F:\\Users\\gsanders\\Documents\\Repositories\\Lookup-Tables\\",
                                          dir="location/",
                                          case_sensitive = FALSE
    )
 
 # debug(factor_wrap)
 full_data$OriginManufactureVendor20<-factor_wrap(full_data$OriginManufactureVendor)
 
full_data$Service<-factor(full_data$SimpleArea)
levels(full_data$Service)<-list("Products"="Products (All)",
                                "Services and R&D"=c("R&D", "Services (Non-R&D)"),
                                "Unlabeled"="Unlabeled")
 
full_data$OriginManufactureVendor<-full_data$PlaceOfManufacture_DoD

 full_data$OriginManufactureVendor[is.na(full_data$OriginManufactureVendor)&                                    
                                     (full_data$Service=="Services and R&D" | 
                                        full_data$PlaceOfManufactureText=="NOT A MANUFACTURED END PRODUCT") &
                                     (full_data$VendorIsForeign==1 | full_data$OriginIsForeign==1)]<-"Not MFG, Foreign Vendor or Origin"
 full_data$OriginManufactureVendor[full_data$OriginManufactureVendor=="U.S. Manufactured" &
                                    (full_data$VendorIsForeign==1 | full_data$OriginIsForeign==1)]<-"U.S. Manufactured, Foreign Vendor or Origin"

  full_data %>% filter(OriginManufactureVendor=="Unlabeled Waiver" &
                         Service=="Services and R&D" )  %>% group_by(VendorIsForeign,OriginIsForeign) %>%
    summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))
 
 
 full_data %>% filter(PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1) %>%
   filter(is.na(OriginManufactureVendor))%>%
   group_by(PlaceOfManufactureText,OriginManufactureVendor,Service,PlaceIsForeign,VendorIsForeign,OriginIsForeign) %>%
  summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23)) 

 # full_data$OriginManufactureVendor[is.na(full_data$OriginManufactureVendor)&
 #                                     full_data$VendorIsForeign==1&full_data$OriginIsForeign==0]<-"U.S. Origin Intl Vendor"
 # 
 # full_data$OriginManufactureVendor[is.na(full_data$OriginManufactureVendor)&
 #                                     full_data$VendorIsForeign==0&full_data$OriginIsForeign==1]<-"Intl Vendor U.S. Origin"
 #  
 # full_data$OriginManufactureVendor[is.na(full_data$OriginManufactureVendor)&
 #                                     full_data$VendorIsForeign==1&full_data$OriginIsForeign==1]<-"Intl Vendor Intl Origin"
 # 
 # full_data$OriginManufactureVendor[full_data$OriginManufactureVendor=="Unlabeled Waiver" &
 #                                     full_data$Service=="Services and R&D" &
 #                                     full_data$VendorIsForeign==0&full_data$OriginIsForeign==1]<-"Intl Vendor U.S. Origin"
 #  
 # full_data$OriginManufactureVendor[full_data$OriginManufactureVendor=="Unlabeled Waiver" & 
 #                                     full_data$Service=="Services and R&D" &
 #                                     full_data$VendorIsForeign==1&full_data$OriginIsForeign==1]<-"Intl Vendor Intl Origin"
 # 
 #  full_data$OriginManufactureVendor[full_data$OriginManufactureVendor=="Unlabeled Waiver" & 
 #                                     full_data$Service=="Services and R&D" &
 #                                     full_data$VendorIsForeign==1&full_data$OriginIsForeign==0]<-"U.S. Origin Intl Vendor"
 #  
  
  full_data %>% filter(OriginManufactureVendor=="Unlabeled Waiver" &
                         Service=="Services and R&D" )  %>% group_by(VendorIsForeign,OriginIsForeign) %>%
    summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))
  
   full_data %>% filter(is.na(OriginManufactureVendor) &
                         Service=="Services and R&D" )  %>% group_by(VendorIsForeign,OriginIsForeign) %>%
    summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))
  
  labels_and_colors<-prepare_labels_and_colors(full_data)
  column_key<-get_column_key(full_data)
  
  
(waiverdetail <-  build_plot(data=full_data %>% filter(PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1)  %>%filter(!is.na(SimpleArea) & SimpleArea!="Unlabeled"),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="dFYear",alpha_var="YTD",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_DoD",
                            facet_var="SimpleArea",
                            # second_var="OriginIsForeign",
                            # labels_and_colors=labels_and_colors,
                            # column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    facet_grid(  SimpleArea~.)+
  labs(x="Fiscal Year",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.")+
    theme(legend.position = "right")
    # guides(fill=guide_legend(ncol=2)
)

  ggsave600dpi(waiverdetail,file="../Output//AcqTrends/waiverdetail.png",size=14,lineheight=1, height =5.75, width=7)


  
  
  
    write.csv(file="..//Output//AcqTrends//waiverdetail.csv",row.names = FALSE, na = "",
            waiverdetail$data %>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
              pivot_wider(id_cols=c(PlaceOfManufacture_DoD,SimpleArea),
                          names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)
            %>% arrange(PlaceOfManufacture_DoD,SimpleArea))

```
##### Simple Waiver Type
```{r SimpleWaiver}
full_data$PlaceOfManufacture_DoD09<-full_data$PlaceOfManufacture_DoD
full_data %>% filter(OriginManufactureVendor=="Unlabeled Waiver" &
                         ProductOrService=="Services and R&D" )  %>% group_by(VendorIsForeign,OriginIsForeign) %>%
    summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))
  
   full_data %>% filter(is.na(OriginManufactureVendor) &
                         ProductOrService=="Services and R&D" )  %>% group_by(VendorIsForeign,OriginIsForeign) %>%
    summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))
  
  
 full_data$PlaceOfManufacture_DoD09[is.na(full_data$PlaceOfManufacture_DoD09)&                                    
                                     (full_data$ProductOrService=="Services and R&D" | 
                                        full_data$PlaceOfManufactureText=="NOT A MANUFACTURED END PRODUCT") &
                                     (full_data$VendorIsForeign==1 | full_data$OriginIsForeign==1)&
                                    full_data$PlaceIsForeign==1]<-"Not MFG, Foreign Place of Performance"
 full_data$PlaceOfManufacture_DoD09[full_data$PlaceOfManufacture_DoD09=="U.S. Manufactured" &
                                    (full_data$VendorIsForeign==1 | full_data$OriginIsForeign==1)]<-
   "U.S. Manufactured, Foreign Vendor or Origin"
 full_data$PlaceOfManufacture_DoD09[is.na(full_data$PlaceOfManufacture_DoD09)&                                    
                                     (full_data$ProductOrService=="Services and R&D" | 
                                        full_data$PlaceOfManufactureText=="NOT A MANUFACTURED END PRODUCT") &
                                     (full_data$VendorIsForeign==1 | full_data$OriginIsForeign==1)&
                                    full_data$PlaceIsForeign==0]<-"Not MFG, U.S. Place of Performance"
  full_data$PlaceOfManufacture_DoD09[full_data$PlaceOfManufacture_DoD09=="Foreign MFG, Perfomed, or Content, Unlabeled Waiver"]<-NA
 
full_data$PlaceOfManufacture_DoD09<-factor_wrap(full_data$PlaceOfManufacture_DoD09,nwrap=45)
 
  
  labels_and_colors<-prepare_labels_and_colors(full_data)
  column_key<-get_column_key(full_data)
  
(waiversimple <-  build_plot(data=full_data %>% filter(PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1)  %>%
                               filter(!is.na(SimpleArea) & SimpleArea!="Unlabeled")%>%
                               filter(Fiscal_Year>=2009 & Fiscal_YQ<2024),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="dFYear",alpha_var="YTD",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_DoD09",
                            facet_var="ProductOrService",
                            # second_var="OriginIsForeign",
                            labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    facet_grid(  ProductOrService~.)+
  labs(x="Fiscal Year",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.",
       title="DoD Contracts with International\nVendors, Manufacture, or Origin")+
    theme(legend.position = "right")+
    date_x_year_breaks(2009,2022,2)+#,partial_year=2024,partial_label="\nQ1")
    theme(plot.margin = margin(t=0.2,r=0.25,b=0.1,l=0.1,"inches"))
    # guides(fill=guide_legend(ncol=2)
)

  ggsave600dpi(waiversimple,file="../Output//AcqTrends/waiversimple.png",size=14,lineheight=1, height =5.75, width=7)
  ggsave600dpi(waiversimple,file="../Output//AcqTrends/waiversimple.svg",size=14,lineheight=1, height =5.75, width=7)


log_plot(plot=waiversimple, df=full_data   %>% filter(Fiscal_YQ<2024 & 
                                                        PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1),
                     filename="acq_fig7_4_ManufacturePlace",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="7-4 PS_MFG",path="../output/AcqTrends/",second_path=online_path, height=4,
                     startRow=1,startCol=12,format=TRUE,var_list=c("ProductOrService","PlaceOfManufacture_DoD09")
         )
  
  

    write.csv(file="..//Output//AcqTrends//waiversimple.csv",row.names = FALSE, na = "",
            waiversimple$data %>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
              pivot_wider(id_cols=c(PlaceOfManufacture_DoD09,ProductOrService),
                          names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)
            %>% arrange(PlaceOfManufacture_DoD09,ProductOrService))
    
    write.csv(full_data %>% filter(PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1)  %>%
                               filter(!is.na(SimpleArea) & SimpleArea!="Unlabeled")%>%
                               filter(Fiscal_Year>=2009),"intl_data.csv")
    
    
    
```


#### Waiverplace
```{r WaiverPlace}
  labels_and_colors<-prepare_labels_and_colors(full_data)
  column_key<-get_column_key(full_data)
  
  (waiverally <-  build_plot(data=full_data %>% filter(PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1) ,
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_DoD09",
                            facet_var="PlaceAcquisitionCooperation",
                            # second_var="StateRegion",
                            # labels_and_colors=labels_and_colors,
                            # column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.")+
    theme(legend.position = "right")
    # guides(fill=guide_legend(ncol=2)
)
             




```
#### Place
```{r buy_america_place}

levels(factor(full_data$PlaceStateRegion))
full_data$PlaceStateRegion<-factor(full_data$PlaceStateRegion)
full_data$PlaceStateRegionSum<-factor(full_data$PlaceStateRegion)
levels(full_data$PlaceStateRegionSum)<-
  list("United States"="United States",
       "East Asia and Pacific"="East Asia and Pacific"  ,
       "Europe and Eurasia"="Europe and Eurasia"     ,
       "Near East"="Near East",
       "South and Central Asia"="South and Central Asia",
       "Rest of World"=c("Western Hemisphere","Non-Regional","Africa")
       )


summary(full_data$PlaceStateRegionSum)

full_data$PlaceOfManufactureText20<-factor_wrap(full_data$PlaceOfManufactureText)
# undebug(build_plot)
summary(factor(full_data$PlaceOfManufactureText20))
(placeregion <-  build_plot(data=full_data %>% filter((PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1)&!is.na(PlaceStateRegion)
                                                     ),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="dFYear",alpha_var="YTD",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="OriginManufactureVendor20",
                            facet_var="PlaceStateRegionSum",
                            # second_var="StateRegion",
                            labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    facet_grid(.~  PlaceStateRegionSum)+
  labs(x="Fiscal Year",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.")+
    
    theme(legend.position = "bottom")+scale_x_date(breaks=as.Date(c(paste(seq(2000,2021,3),"-01-01",sep=""))),
                                                   date_labels="'%y")#date_breaks = "3 years"
    # guides(fill=guide_legend(ncol=2)
           )

ggsave600dpi(placeregion,file="../Output//AcqTrends/place_of_manufacture_place_regionwaiver.png",size=14,lineheight=1, height =6, width=12)



summary(full_data$vendor)
full_data$PlaceMutualAcquisition
(placeregion <-  build_plot(data=full_data %>% filter((PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1)&!is.na(PlaceStateRegion)
                                                     ),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="PlaceMutualAcquisition",
                            # second_var="StateRegion",
                            labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.")+
    theme(legend.position = "bottom")
    # guides(fill=guide_legend(ncol=2)
           )
full_data$PlaceAcquisitionCooperation

(placeregion <-  build_plot(data=full_data %>% filter((PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1)&!is.na(PlaceStateRegion)
                                                     ),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="PlaceAcquisitionCooperation",
                            # second_var="StateRegion",
                            labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.")+
    theme(legend.position = "bottom")
    # guides(fill=guide_legend(ncol=2)
           )


full_data$place


(vendorregion <-  build_plot(data=full_data %>% filter(PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1) ,
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="VendorStateRegion",
                            # second_var="VendorRegion",
                            # labels_and_colors=labels_and_colors,
                            # column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.")+
    theme(legend.position = "bottom")
    # guides(fill=guide_legend(ncol=2)
           )


(originregion <-  build_plot(data=full_data %>% filter(PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1) ,
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="dFYear",alpha_var="YTD",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="OriginStateRegion",
                            # second_var="VendorRegion",
                            # labels_and_colors=labels_and_colors,
                            # column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.")+
    theme(legend.position = "bottom")
    # guides(fill=guide_legend(ncol=2)
           )


ggsave600dpi(waiver,file="../Output//AcqTrends/place_of_manufacture_waiver.png",size=8,lineheight=1, height =5, width=9)


(contract_identification <-  build_plot(data=full_data %>% filter(!is.na(PlaceIsForeign)),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="PlaceIsForeign",
                            # second_var="StateRegion",
                            labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    facet_grid(  PlaceIsForeign~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s,\nVariable Axis)",
       caption="Source: FPDS and CSIS analysis.")+
    guides(fill=guide_legend(ncol=3)))






```
###Korea

```{r}

(korea <-  build_plot(data=full_data %>% filter(PlaceISOalpha3=="KOR" |
                                                  VendorISOalpha3=="KOR" |
                                                  OriginISOalpha3=="KOR"),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="SimpleArea",
                            # second_var="StateRegion",
                            labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.")+
    theme(legend.position = "bottom")
    # guides(fill=guide_legend(ncol=2)
)

full_data$IsFMS
(korea <-  build_plot(data=full_data %>% filter(PlaceISOalpha3=="KOR" |
                                                  VendorISOalpha3=="KOR" |
                                                  OriginISOalpha3=="KOR"),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlaceOfManufactureText20",
                            facet_var="IsFMS",
                            # second_var="StateRegion",
                            # labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS and CSIS analysis.")+
    theme(legend.position = "bottom")
    # guides(fill=guide_legend(ncol=2)
)

PlaceOfManufactureText20
```



### NTIB
#### OTA 
```{r FPDS_vendor_Intl}
ntibisoalpha3<-c("AUS","CAN","GBR")#"NZL",

ota_def$VendorNTIB<-"All Other"
ota_def$VendorNTIB[ota_def$VendorAddressISOalpha3=="USA"]<-"United States"
ota_def$VendorNTIB[ota_def$VendorAddressISOalpha3=="AUS"]<-"Australia"
ota_def$VendorNTIB[ota_def$VendorAddressISOalpha3=="NZL"]<-"New Zealand"
ota_def$VendorNTIB[ota_def$VendorAddressISOalpha3=="CAN"]<-"Canada"
ota_def$VendorNTIB[ota_def$VendorAddressISOalpha3=="GBR"]<-"United Kingdom"


summary(factor(ota_def$VendorNTIB))
# undebug(format_data_for_plot)

summary(ota_def$dFYear)

(ntibintl_plat <-  build_plot(data=ota_def%>% filter((#PlaceISOalpha3 %in% ntibisoalpha3|
                                                                  VendorAddressISOalpha3 %in% ntibisoalpha3) &
                                                                            Fiscal_Year>2011 & !is.na(VendorAddressISOalpha3)),#VendorAddressISOalpha3==TRUE                             
                                            chart_geom="Bar Chart",
                            x_var="dFYear",alpha_var="YTD",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="PlatformPortfolioUAV",
                            facet_var="VendorNTIB",
                            # second_var="PlaceIsForeign",
                            labels_and_colors=ota_lc,
                            column_key=ota_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( VendorNTIB~. )+labs(title="OTA obligations by Platform for Vendors with Addreses\nin Australia, Canada, and the United Kingdom",
                                    y="Action Obligation (Constant 2022 $s")#, scales="free_y"#, scales="free_y"
  )+scale_x_date("Fiscal Year",labels = scales::date_format("'%y"))

(ntibintl_cust <-  build_plot(data=ota_def%>% filter((#PlaceISOalpha3 %in% ntibisoalpha3|
                                                                  VendorAddressISOalpha3 %in% ntibisoalpha3) &
                                                                            Fiscal_Year>2011 & !is.na(VendorAddressISOalpha3)),#VendorAddressISOalpha3==TRUE                             
                                            chart_geom="Bar Chart",
                            x_var="dFYear",alpha_var="YTD",
                            y_var="Action_Obligation_OMB25_GDP23",
                            color_var="SubCustomer.OTA",
                            facet_var="VendorNTIB",
                            # second_var="PlaceIsForeign",
                            labels_and_colors=ota_lc,
                            column_key=ota_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( VendorNTIB~. )+labs(title="OTA obligations by Customer for Vendors with Addreses\nin Australia, Canada, and the United Kingdom",
                                    y="Action Obligation (Constant 2022 $s")#, scales="free_y"#, scales="free_y"
  )+scale_x_date("Fiscal Year",labels = scales::date_format("'%y"))
summary(ota_def$dFYear)


write.csv(file="..//Output//AcqTrends//ota//ntibintl_plat.csv",row.names = FALSE,na = "",
          ntibintl_plat$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(VendorNTIB,PlatformPortfolioUAV),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)%>% arrange(VendorNTIB,PlatformPortfolioUAV))

ggsave600dpi(ntibintl_plat,file="../Output//AcqTrends/ota/ntibintl_plat.png",
             size = 12, lineheight=1, height =5.5, width=6.5)

ggsave600dpi(ntibintl_cust,file="../Output//AcqTrends/ota/ntibintl_cust.png",
             size = 12, lineheight=1, height =5.5, width=6.5)


```
