---
title: "Defense Acquisition Trends"
output:
  html_document:
    keep_md: yes
    toc: yes
date: "Wednesday, October 6, 2021"
---

# Setup
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from FPDS.

```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(scales)
library(lubridate)
library(svglite)
library(readxl)
library(XLConnect)

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40
if(!exists("full_data"))
  # load(file="..//data//clean//unaggregated_FPDS_2020.Rda")
load(file="FPDS_chart_maker//unaggregated_FPDS.Rda")

# full_data<-deflate(full_data, "Action_Obligation_Then_Year",deflator_var="OMB23_GDP21")

load(file="../data/semi_clean/Defense_OTA.Rda")

toa<-readxl::read_excel(path=file.path("..","data_raw","FY22 PB Green Book Table 6-1.xlsx"),skip=4)
# toa<-toa["Total Current Dollars ..............................................................." ==toa[,2] & !is.na(toa[,2]),]#%in% c(toa[,1],toa[,2],toa[,3]),]



load(file="../analysis/FPDS_chart_maker/unaggregated_def.Rda")
platpscintldef<-deflate(platpscintldef, "Action_Obligation_Then_Year",deflator_var="OMB23_GDP21")
colnames(platpscintldef)[colnames(platpscintldef)=="Action_Obligation_Then_Year_OMB23_GDP21"]<-"Action_Obligation_OMB23_GDP21"
colnames(platpscintldef)[colnames(platpscintldef)=="Action_Obligation_Then_Year_Then_Year"]<-"Action_Obligation_Then_Year"

ota_def<-deflate(ota_def, "Dollars_Obligated_Then_Year",deflator_var="OMB23_GDP21")
colnames(ota_def)[colnames(ota_def)=="Dollars_Obligated_Then_Year_OMB23_GDP21"]<-"Dollars_Obligated_OMB23_GDP21"
colnames(ota_def)[colnames(ota_def)=="Dollars_Obligated_Then_Year_Then_Year"]<-"Dollars_Obligated_Then_Year"

#Kludge
toa<-toa[11,c(-1,-3)]
colnames(toa)<-gsub("FY ","",colnames(toa))
colnames(toa)[colnames(toa)=="...2"]<-"Series"
toa<-pivot_longer(toa,  cols=-Series, names_to="Fiscal_Year", values_to="Total_Obligation_Authority")
toa$Total_Obligation_Authority<-toa$Total_Obligation_Authority*1000000
toa<-deflate(toa,money_var = "Total_Obligation_Authority",deflator_var="OMB20_GDP20")
toa$dFYear<-as.Date(paste(toa$Fiscal_Year,1,1,sep="-"))
labels_and_colors<-prepare_labels_and_colors(full_data)
```
## Quarterly YTD

```{r}
write.csv(
  full_data %>% group_by(SubCustomer.sum,PlatformPortfolio,SimpleArea,Competition.sum,
                       VendorSize,Fiscal_Year) %>% filter(Fiscal_Year<=2020) %>%
  summarise(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE),
            Action_Obligation_OMB23_GDP21=sum(Action_Obligation_Then_Year,na.rm=TRUE)),"contracting.csv",row.names = FALSE)
  

```

Read in quarterly data from the CSIS database and the current year data from SAM.gov.

```{r EstimatePrep}
y2021<-read.csv(file.path("..","Data_Raw","SAM","Defense_Agency_SignedDate_2021.csv"),skip = 2)
y2021<-standardize_variable_names(y2021)
y2021$Date.Signed<-as.Date(y2021$Date.Signed,"%m/%d/%Y")

q2021<-y2021 %>% mutate(fiscal_quarter=lubridate::quarter(Date.Signed,fiscal_start=10),
                        ContractingCustomer=ifelse(Contracting.Department.ID=="9700","Defense","Non-Defense")) %>%
  group_by(Fiscal_Year,fiscal_quarter,ContractingCustomer) %>%
  dplyr::summarize(Action_Obligation=sum(csis360::text_to_number(Dollars.Obligated),na.rm=TRUE),
            minSD=min(Date.Signed),
            maxSD=max(Date.Signed))%>% filter(fiscal_quarter<=3)

q2021<-q2021 %>% dplyr::select(Fiscal_Year,fiscal_quarter,Action_Obligation,ContractingCustomer)
# colnames(q2021)[colnames(q2021)=="Fiscal_Year"]<-"Fiscal_Year"
# colnames(q2021)[colnames(q2021)=="Fiscal_Year"]<-"Fiscal_Year"


quarterly<-read.csv(file.path("..","Data","Semi_Clean","Defense_Contract.FiscalQuarter.csv"),na.strings = "NULL")
quarterly<-standardize_variable_names(quarterly)
quarterly<-remove_bom(quarterly)
quarterly$fiscal_quarter<-as.numeric(quarterly$fiscal_quarter)-1
quarterly <- quarterly %>% filter(Fiscal_Year>=2000)  %>% arrange(Fiscal_Year,fiscal_quarter)
if(any(is.na(quarterly$Fiscal_Year))) stop("NA Quarters")

quarterlyYTD<-rbind(as.data.frame(quarterly),as.data.frame(q2021 ))
quarterlyYTD<-deflate(quarterlyYTD,money_var = "Action_Obligation",deflator_var="OMB20_GDP20")
colnames(quarterlyYTD)
toa$fiscal_quarter<-NA
toa$Action_Obligation_Then_Year<-NA
toa$Action_Obligation_OMB23_GDP21<-NA
toa$ContractingCustomer<-"Defense"
quarterlyYTD$Total_Obligation_Authority_OMB20_GDP20<-NA
quarterlyYTD$Total_Obligation_Authority_Then_Year<-NA
quarterlyYTD<-rbind(quarterlyYTD,toa %>% dplyr::select(-Series, -dFYear))

```

## Estimate last quarter
Create a univariate model that estimates the fourth quarter based on the first three quarters.

This isn't a perfect representation, as the spending in the first three quarters will continue to fluctuate even well after the 90 day delay for DoD has expired. In theory, there could be slightly greater precision by tracking the first three quarters at a consistent point in each year. However, that's not a level of history that can be straightforwardly reconstructed.  
```{r Model}


a<-quarterlyYTD %>% group_by(Fiscal_Year) %>% filter(Fiscal_Year<2021 & !is.na(fiscal_quarter))%>% dplyr::summarise(
  q1toq3=sum(ifelse(fiscal_quarter<=3,Action_Obligation_OMB23_GDP21,0)),
  q4=sum(ifelse(fiscal_quarter==4,Action_Obligation_OMB23_GDP21,0)),
             total=sum(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21))
)
a$NewAdmin<-0
a$NewAdmin[a$Fiscal_Year %in% c(2001,2009,2017,2021)]<-1

m<-lm(data=a,q4~q1toq3)
m2<-lm(data=a,q4~q1toq3+NewAdmin)
summary(m)
summary(m2)
# plot(m)

q1to13_2021<-sum(ifelse(quarterlyYTD$fiscal_quarter<=3 & !is.na(quarterlyYTD$fiscal_quarter) & quarterlyYTD$Fiscal_Year==2021,quarterlyYTD$Action_Obligation_OMB23_GDP21,0))

cvalues<-data.frame(q1toq3=q1to13_2021)

p<-predict(m,cvalues,interval="prediction")
e2021<-data.frame(Fiscal_Year=2021,
           fiscal_quarter=4,
           Action_Obligation_Then_Year=NA,
           Action_Obligation_OMB23_GDP21=NA,
           yest=p[1]+q1to13_2021,
           lwr=p[2]+q1to13_2021,
           upr=p[3]+q1to13_2021,
           ContractingCustomer="Defense",
           Actual="Estimate",
           Total_Obligation_Authority_OMB20_GDP20=NA,
           Total_Obligation_Authority_Then_Year=NA
           )
rm(q1to13_2021,cvalues)
```
The first three years made a pretty good estimator. However, adding a variable based on whether it was the first year of a new adminsitration added nothing to the model.

# Topline

## TOA Topline Quarterly
```{r TOA}

quarterlyYTD$Actual<-"Actual"
quarterlyYTD$lwr<-NA
quarterlyYTD$upr<-NA
quarterlyYTD$yest<-NA

# build_plot(data=rbind(quarterly,q2021,e2021),
#            x_var="Fiscal_Year",
#            y_var="Action_Obligation_OMB23_GDP21",
#            color_var = "fiscal_quarter",
#            facet_var="Actual",
#            chart_geom="Bar Chart")+facet_wrap(~)
quarterlyEst<-rbind(quarterlyYTD,e2021)
quarterlyEst$Actual<-factor(quarterlyEst$Actual,levels=c("Estimate","Actual"))
quarterlyEst$fiscal_quarter<-factor(quarterlyEst$fiscal_quarter,c("4","3","2","1"))
quarterlyEst$dFYear<-as.Date(paste("1/1/",as.character(quarterlyEst$Fiscal_Year),sep=""),"%m/%d/%Y")

(topline_q<-ggplot(data=quarterlyEst %>% filter(Fiscal_Year>=2000) #rbind(quarterly,q2021,e2021),
      )+geom_col( aes(x=dFYear,
           y=Action_Obligation_OMB23_GDP21/1000000000,
           # alpha=Actual,
           fill = fiscal_quarter
       ))+
    geom_path(aes(x=dFYear,y=Total_Obligation_Authority_OMB20_GDP20/1000000000),group="Quarter")+
  # scale_alpha_discrete(range=c(0.4,1))+
  geom_errorbar(aes(x=dFYear,ymin=lwr/1000000000,ymax=upr/1000000000,y=yest/1000000000,color = fiscal_quarter))+
    geom_point(aes(x=dFYear,ymin=lwr/1000000000,ymax=upr/1000000000,y=yest/1000000000,color = fiscal_quarter))+
    scale_color_discrete("Estimate")+
    labs(x="Fiscal Year",y="Constant FY 2020 $ Billions",fill="Quarter")
)

write.csv(file="..//Output//toa_topline.csv",row.names = FALSE,na="",
          quarterlyEst %>% mutate(fiscal_quarter=ifelse(!is.na(Total_Obligation_Authority_OMB20_GDP20),"TOA",fiscal_quarter),
                                            Dollars_GDP20=ifelse(fiscal_quarter=="TOA",
                                                                 Total_Obligation_Authority_OMB20_GDP20,Action_Obligation_OMB23_GDP21))%>%
            filter(Fiscal_Year>=2000)%>%
          format_data_for_plot(
                               fy_var="Fiscal_Year",
                               y_var="Dollars_GDP20",
                               color_var="fiscal_quarter",
                               # facet="SubCustomer",
                               # labels_and_colors = ota_lc,
                               group=TRUE) %>%
            arrange(Fiscal_Year) %>%
            mutate(Dollars_GDP20=Dollars_GDP20/1000000000)%>%
          pivot_wider(id_cols=c(fiscal_quarter),
                      names_from=Fiscal_Year,values_from=Dollars_GDP20) %>% 
            
            # mutate(PlatformPortfolio=factor(PlatformPortfolio,levels=ota_lc$variable[ota_lc$column=="PlatformPortfolio"]))%>%
            # mutate(PlatformPortfolio=factor(PlatformPortfolio,levels=levels(fiscal_quarter),
            #                                 labels=gsub("\\n"," ",levels(PlatformPortfolio))))%>%
                   arrange(fiscal_quarter))


ggsave600dpi(topline_q,file=file.path("..","Output","toa_quarterly.png"),  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )
```
## TOA annual
```{r TOAannual}


fpds_annual<-full_data %>% group_by(Fiscal_Year,dFYear,IsFMS,
                                    ContractingCustomer) %>% summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21,na.rm=TRUE),
                                                                      Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))
fpds_annual$Series<-"Contract Obligations"
toa$Fiscal_Year<-text_to_number(toa$Fiscal_Year)
toa$IsFMS<-0
fpds_annual$Total_Obligation_Authority_Then_Year<-NA
fpds_annual$Total_Obligation_Authority_OMB20_GDP20<-NA
fpds_annual<-rbind(as.data.frame(fpds_annual),as.data.frame(toa) %>% dplyr::select(-fiscal_quarter))
colnames(toa)[!colnames(toa) %in% colnames(fpds_annual)]
colnames(fpds_annual)[!colnames(fpds_annual) %in% colnames(toa)]

fpds_annual$FMS<-as.character(fpds_annual$IsFMS)
fpds_annual$FMS[fpds_annual$Fiscal_Year<2012]<-"Obligations (before reliable\nFMS labels available)"
fpds_annual$FMS[!is.na(fpds_annual$Total_Obligation_Authority_OMB20_GDP20)]<-"Obligations (no FMS)"
fpds_annual$FMS<-factor(fpds_annual$FMS)
levels(fpds_annual$FMS)<-list("Obligations (includes FMS)"=c("1","Obligations (includes FMS)"),
                              "Obligations (no FMS)"=c("0","Obligations (no FMS)"),
                              "Obligations (before reliable\nFMS labels available)"="Obligations (before reliable\nFMS labels available)")
fpds_annual$TOA<-"Total Obligation Authority"


(topline<-build_plot(data=fpds_annual %>% filter(Fiscal_Year>=1990),#rbind(quarterly,q2021,e2021),
                     chart_geom="Bar Chart",
                     x_var="dFYear",
                     y_var="Action_Obligation_OMB23_GDP21",
           color_var="FMS"
       )+
    geom_path(aes(x=dFYear,y=Total_Obligation_Authority_OMB20_GDP20,color=TOA))+
  # scale_alpha_discrete(range=c(0.4,1))+
    labs(x="Fiscal Year",y="Constant FY 2020 $ Billions",fill="Contract",color="Budget",
         caption="Source: FPDS, FY 2022 DoD Greenbook, CSIS Analysis")+
    theme(legend.position = "right")+
    scale_x_date(breaks=as.Date(c(paste(seq(1990,2021,3),"-01-01",sep=""))),
                                                   date_labels="'%y")
)

output_TY<-topline$data %>% mutate(source=ifelse(!is.na(Total_Obligation_Authority_Then_Year),"TOA","Contract"),
                                            Dollars=ifelse(source=="TOA",
                                                                 Total_Obligation_Authority_Then_Year,Action_Obligation_Then_Year))%>%
            filter(Fiscal_Year>=1990)%>%
          format_data_for_plot(
                               fy_var="Fiscal_Year",
                               y_var="Dollars",
                               color_var="source",
                               facet="FMS",
                               # labels_and_colors = ota_lc,
                               group=TRUE) %>%
            arrange(Fiscal_Year) %>%
          pivot_wider(id_cols=c(source,FMS),
                      names_from=Fiscal_Year,values_from=Dollars) %>% 
            
            # mutate(PlatformPortfolio=factor(PlatformPortfolio,levels=ota_lc$variable[ota_lc$column=="PlatformPortfolio"]))%>%
            # mutate(PlatformPortfolio=factor(PlatformPortfolio,levels=levels(fiscal_quarter),
            #                                 labels=gsub("\\n"," ",levels(PlatformPortfolio))))%>%
                   arrange(source,FMS)

ggsave600dpi(topline,file=file.path("..","Output","topline_toa_annual.png"),  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )

ggsave600dpi(topline,file=file.path("..","Output","topline_toa_annual.emf"),  
             width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
             )

write.csv(file="..//Output//toa_annual.csv",row.names = FALSE,na="",output_TY
          )




wb <- loadWorkbook("..//Output//DoD_Acq_Trends_Contracts.xlsx", create = TRUE)
createSheet(wb, name = "TOA")
writeWorksheet(wb, output_TY, sheet = "TOA", startRow = 2, startCol = 1)
saveWorkbook(wb)
rm(wb)
xlcFreeMemory()



```

## Topline Competition
```{r ToplineComp}
full_data %>% group_by(Fiscal_Year) %>% summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21))
full_data %>% filter(Fiscal_Year==2021) %>% group_by(Competition.sum) %>% summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21))

(
ToplineCompMulti<-build_plot(
  data=full_data %>% filter(Fiscal_Year>=1991),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # 
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Obligations (Constant 2021 $s)")
)

(
ToplineComp<-build_plot(
  data=full_data %>% filter(Fiscal_Year>=1997),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Competition.sum", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # 
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Obligations (Constant 2021 $s)")
)



(
ToplineCompLine<-build_plot(
  data=full_data %>% filter(Fiscal_Year>=1997),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Competition.sum", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Obligations (Constant 2021 $s)")
)

full_data %>% filter(Competition.sum =="Unlabeled" & Fiscal_Year>=2019) %>% group_by(CompetitionClassification)%>%
  summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21))

ggsave600dpi("..//Output//topline_comp.png", ToplineComp,  
             width=11, height= 5.5, units="in",size=14, lineheight=1.2
             )

ggsave600dpi("..//Output//topline_comp.emf", ToplineComp+theme(legend.position = "right"),  
             width=6.5, height= 3, units="in",size=11, lineheight=1.2
             )

ggsave600dpi("..//Output//topline_comp.svg", ToplineComp,  
             width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
             )


ggsave600dpi("..//Output//topline_comp_multi.png", ToplineCompMulti,  
             width=11, height= 5.5, units="in",size=14, lineheight=1.2
             )

ggsave600dpi("..//Output//topline_comp_multi.svg", ToplineCompMulti,  
             width=6.5, height= 4, units="in",size=12, lineheight=1.2
             )



ggsave600dpi("..//Output//topline_comp_multi.emf", ToplineCompMulti+theme(legend.position = "right"),  
             width=6.5, height= 3, units="in",size=11, lineheight=1.2
             )


ggsave600dpi("..//Output//topline_comp_square.png", ToplineComp,  
             width=6, height= 5, units="in",size=14, lineheight=1.2
             )


write.csv(file="..//Output//topline_competition.csv",row.names = FALSE, na = "",
          ToplineComp$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(Competition.sum),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21))


write.csv(file="..//Output//topline_competition_cur.csv",row.names = FALSE, na = "",
          full_data %>% group_by(Competition.sum,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(Competition.sum),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>% arrange(Competition.sum))


```



### Missing Competition
```{r UnlabeledComp}

(
UnlabeledComp<-build_plot(
  data=full_data %>% filter(Competition.sum =="Unlabeled"),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="CompetitionClassification", #color_var
  facet_var="Vehicle.sum7", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)")
)

full_data %>% filter(Competition.sum =="Unlabeled" & Fiscal_Year>=2019) %>% group_by(CompetitionClassification)%>%
  summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21))

ggsave600dpi("..//Output//unlabeled_comp.png", UnlabeledComp,  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )



write.csv(file="..//Output//unlabeled_competition.csv",row.names = FALSE, na = "",
          # ToplineComp$data%>% mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(UnlabeledComp$data,id_cols=c(CompetitionClassification,Vehicle.sum7),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21)
          %>% arrange(CompetitionClassification,Vehicle.sum7))



```


## Topline Vendor Size
```{r ToplineVendor}

(
ToplineVendor<-build_plot(
  data=full_data %>% filter(Fiscal_Year<=2020),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"),date_breaks = "2 years")+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)",
       caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April 2020 and thus did not make the cutofff for inclusion in FY2020.")
)

(
ToplineVendor_line<-build_plot(
  data=full_data %>% filter(Fiscal_Year<=2020),
  chart_geom = "Line Chart",
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE,
  share=TRUE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)",caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April of 2020\n and thus did not make the cutofff for inclusion in FY2020.")
)

ggsave600dpi("..//Output//topline_vendor_wide.png", ToplineVendor+
  labs(y="Obligations (Constant 2021 $s)",caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=12, height= 6, units="in",size=12,lineheight=1
             )


ggsave600dpi("..//Output//topline_vendor_cq.png", ToplineVendor+
  labs(y="Obligations (Constant 2021 $s)",caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April\nof 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

ggsave600dpi("..//Output//topline_vendor_cq.svg", ToplineVendor+
  labs(y="Obligations (Constant 2021 $s)",caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April\nof 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

ggsave600dpi("..//Output//topline_vendor.png", ToplineVendor, 
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

ggsave600dpi("..//Output//topline_vendor.eps", ToplineVendor+
  labs(y="Obligations (Constant 2021 $s)",caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April\nof 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )


write.csv(file="..//Output//topline_vendor_cur.csv",row.names = FALSE, na = "",
          full_data %>% group_by(Shiny.VendorSize,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(Shiny.VendorSize),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>% arrange(Shiny.VendorSize))


write.csv(file="..//Output//topline_vendor.csv",row.names = FALSE, na = "",
          ToplineVendor$data%>% mutate(Fiscal_Year=lubridate::year(dFYear),
                                       bAction_Obligation_OMB23_GDP21=Action_Obligation_OMB23_GDP21/1000000000)%>%
            pivot_wider(id_cols=c(Shiny.VendorSize),
                        names_from=Fiscal_Year,values_from=bAction_Obligation_OMB23_GDP21)%>%arrange(Shiny.VendorSize))

```





### Topline Vendor International
```{r ToplineVendor}


(
ToplineVendorIntl<-build_plot(
  data=full_data %>% filter(Fiscal_Year<=2020),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="VendorSize_Intl", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)",
       caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April 2020 and thus did not make the cutofff for inclusion in FY2020.")
)

ggsave600dpi("..//Output//topline_vendor_intl_square.png", ToplineVendorIntl+
  labs(y="Obligations (Constant 2021 $s)",caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies is took place in \nApril 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=6, height= 5, units="in",size=12,lineheight=1
             )



```

### Big 5 Breakout
```{r ToplineVendor}

big5<-read.delim(file.path("..","data","semi_clean","Defense_Vendor.sp_TopVendorHistoryCustomer.txt"),sep="\t")
big5<-read_and_join_experiment(big5,lookup_file="Lookup_ParentID.csv",
                               path="C:\\Users\\gsand\\Repositories\\Lookup-Tables\\",
                                 # "https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                               dir="vendor/",           
                               add_var = c("Top6","IsPreTop6"),#"USAID region",
                               by=c("ParentID"="ParentID"),
                               skip_check_var=c("Top6","IsPreTop6"),
                               # missing_file="missing_DSCA_iso.csv"
)
big5<-big5 %>% filter(Top6==1|IsPreTop6==1)
big5$Big5<-big5$ParentID
big5$Big5[big5$JointVenture==1]<-"Big 5 Joint Venture"
big5$Big5[big5$Big5=="LOCKHEED"]<-"LOCKHEED MARTIN"
big5$Big5[big5$Big5=="GRUMMAN"]<-"NORTHROP GRUMMAN"
big5$SumOfobligatedAmount<-text_to_number(big5$SumOfobligatedAmount)
big5_wide <-big5 %>% group_by(Big5,Fiscal_Year) %>% filter(Fiscal_Year>=1990) %>%
  summarise(Action_Obligation=sum(SumOfobligatedAmount,na.rm=TRUE)) %>%
  pivot_wider(id_cols=Big5,names_from=Fiscal_Year,values_from=Action_Obligation)

(
ToplineVendor<-build_plot(
  data=full_data %>% filter(Fiscal_Year<=2020),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"),date_breaks = "2 years")+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)",
       caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April 2020 and thus did not make the cutofff for inclusion in FY2020.")
)

(
ToplineVendor_line<-build_plot(
  data=full_data %>% filter(Fiscal_Year<=2020),
  chart_geom = "Line Chart",
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE,
  share=TRUE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)",caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April of 2020\n and thus did not make the cutofff for inclusion in FY2020.")
)

ggsave600dpi("..//Output//topline_vendor_wide.png", ToplineVendor+
  labs(y="Obligations (Constant 2021 $s)",caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=12, height= 6, units="in",size=12,lineheight=1
             )


ggsave600dpi("..//Output//topline_vendor_cq.png", ToplineVendor+
  labs(y="Obligations (Constant 2021 $s)",caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April\nof 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

ggsave600dpi("..//Output//topline_vendor_cq.svg", ToplineVendor+
  labs(y="Obligations (Constant 2021 $s)",caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April\nof 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

ggsave600dpi("..//Output//topline_vendor.png", ToplineVendor, 
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

ggsave600dpi("..//Output//topline_vendor.eps", ToplineVendor+
  labs(y="Obligations (Constant 2021 $s)",caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April\nof 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )


write.csv(file="..//Output//topline_vendor_cur.csv",row.names = FALSE, na = "",
          full_data %>% group_by(Shiny.VendorSize,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(Shiny.VendorSize),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>% arrange(Shiny.VendorSize))


write.csv(file="..//Output//topline_vendor.csv",row.names = FALSE, na = "",
          ToplineVendor$data%>% mutate(Fiscal_Year=lubridate::year(dFYear),
                                       bAction_Obligation_OMB23_GDP21=Action_Obligation_OMB23_GDP21/1000000000)%>%
            pivot_wider(id_cols=c(Shiny.VendorSize),
                        names_from=Fiscal_Year,values_from=bAction_Obligation_OMB23_GDP21)%>%arrange(Shiny.VendorSize))

```



## Topline Vehicle
```{r ToplineVehicle}

(
ToplineVehicle<-build_plot(
  data=full_data,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="SimpleArea", #color_var
  facet_var="Vehicle.sum7", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)")
)

full_data %>% filter(Vehicle=="Unlabeled Indefinite Delivery Contract (IDC)" ) %>% group_by(ClassifyNumberOfOffers,No.Competition.sum)%>%
  summarise(n=length(Vehicle))


(
ToplineVehicle<-build_plot(
  data=full_data %>% filter(!is.na(Vehicle.AwardTask)),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Vehicle.sum7", #color_var
  facet_var="Vehicle.AwardTask", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)",
       caption="Note: Unlabeled not shown. Source: FPDS; CSIS analysis.")
)


(
ToplineVehicle<-build_plot(
  data=full_data %>% filter(!is.na(Vehicle.AwardTask)),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Vehicle.sum", #color_var
  facet_var="Vehicle.AwardTask", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)",
       caption="Note: Unlabeled not shown. Source: FPDS; CSIS analysis.")
)



ggsave600dpi("..//Output//topline_vehicle.png", ToplineVehicle, 
             width=13, height= 4.5, units="in",size=11
             )

write.csv(file="..//Output//topline_vehicle.csv",row.names = FALSE, na = "",
          ToplineVehicle$data%>% mutate(Fiscal_Year=lubridate::year(dFYear),
                                       bAction_Obligation_OMB23_GDP21=Action_Obligation_OMB23_GDP21/1000000000)%>%
            pivot_wider(id_cols=c(Vehicle.sum,Vehicle.AwardTask),
                        names_from=Fiscal_Year,values_from=bAction_Obligation_OMB23_GDP21)%>%arrange(Vehicle.sum,Vehicle.AwardTask))

```


## Topline Pricing
```{r ToplinePricing}
full_data$PricingUCA.sumlong<-full_data$PricingUCA.sum
levels(full_data$PricingUCA.sumlong)<-list("Firm-Fixed-Price"="FFP",
                                           "Less Common"="Less Common",
                                           "Incentive"="Incentive",
                                           "Other Cost-Based"="Other CB",
                                           "Undefinitized\nContract Award"="UCA",
                                           "Unclear"="Unclear"   )
(
ToplinePricing<-build_plot(
  data=full_data,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="PricingUCA", #color_var
  facet_var="PricingUCA.sumlong", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)")
)

# ggsave600dpi("..//Output//topline_pricing.png", ToplinePricing, 
#              width=6.5, height= 4, units="in",size=11
#              )


ggsave600dpi("..//Output//topline_pricing.png", ToplinePricing,  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )

write.csv(file="..//Output//topline_pricing.csv",row.names = FALSE, na = "",
  arrange(pivot_wider(ToplinePricing$data %>% 
                        arrange(dFYear) %>% mutate(Fiscal_Year=lubridate::year(dFYear)),
                      id_cols=c(PricingUCA.sumlong,PricingUCA),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21),PricingUCA.sumlong)%>%
    arrange(PricingUCA.sumlong,PricingUCA))


```


## Topline Commercial
```{r Commercial}
def_data$AnyCommercialText<-factor(def_data$AnyCommercial)
levels(def_data$AnyCommercialText)<-list(
  "Not Classified\nas Commercial"="N",
  "Non-Development\nor Commercial Similar"= "NonDev",
  "Any Commercial\nClassification"="Y"
  
)

(
Commercial<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="AnyCommercialText", #color_var
  # facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)")+
    scale_x_date(breaks=as.Date(c(paste(seq(2000,2021,5),"-01-01",sep=""))),
                                                   date_labels="'%y")
)

ggsave600dpi("..//Output//topline_commercial.png", Commercial, 
             width=11, height= 5.5, units="in",size=14,lineheight = 1.2
             )

ggsave600dpi("..//Output//topline_commercial.svg", Commercial,#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 3, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi("..//Output//topline_commercial.emf", Commercial,#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 3, units="in",size=11,lineheight = 1.2
             )


write.csv(file="..//Output//topline_commercial_current.csv",row.names = FALSE, na = "",
          def_data %>% group_by(AnyCommercialText,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(AnyCommercialText),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(AnyCommercialText))

summary(full_data$ContractingSubCustomer)
def_data$

def_data %>% filter(SubCustomer.sum=="Army", PlatformPortfolio=="Other Products", Fiscal_Year==2021) %>%
  group_by(AnyCommercialText,Competition.multisum) %>% summarise(
    COVID19obligated=sum(COVID19obligated,na.rm=TRUE),
    Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
    Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year),
    
  )

```

#Product/Service/R&D

## Topline Product/Service/R&D
```{r ToplinePSR}

(
ToplinePSR<-build_plot(
  data=full_data,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="SimpleArea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)")
)

ggsave600dpi("..//Output//topline_psr.png", ToplinePSR, 
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )

ggsave600dpi("..//Output//topline_psr.emf", ToplinePSR, 
             width=6.5, height= 3, units="in",size=11, lineheight=1.2
             )


output_TY<-full_data %>% group_by(SimpleArea,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(SimpleArea),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)
write.csv(file="..//Output//topline_psr.csv",row.names = FALSE, na = "",
          output_TY)


wb <- loadWorkbook("..//Output//DoD_Acq_Trends_Contracts.xlsx", create = TRUE)
createSheet(wb, name = "Area")
writeWorksheet(wb, output_TY, sheet = "Area", startRow = 14, startCol = 14)
saveWorkbook(wb)

```


## R&D phase
```{r RnD}

(
RnDphase<-build_plot(
  data=full_data %>% filter(SimpleArea=="R&D"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="ProductServiceOrRnDarea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)")
)

ggsave600dpi("..//Output//psr_RnDPhase.png", RnDphase, 
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )
                           

write.csv(file="..//Output//psr_RnDPhase.csv",row.names = FALSE, na = "",
          pivot_wider(RnDphase$data,id_cols=c(ProductServiceOrRnDarea),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21)%>%
            arrange(ProductServiceOrRnDarea))
            

output_TY<-full_data %>% filter(SimpleArea=="R&D") %>%
            format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "ProductServiceOrRnDarea",
                                 labels_and_colors=labels_and_colors) %>%
          pivot_wider(id_cols=c(ProductServiceOrRnDarea),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(ProductServiceOrRnDarea)

write.csv(file="..//Output//psr_RnDPhase_current.csv",row.names = FALSE, na = "",
          output_TY)

wb <- loadWorkbook("..//Output//DoD_Acq_Trends_Contracts.xlsx", create = TRUE)
createSheet(wb, name = "R&D")
writeWorksheet(wb, output_TY, sheet = "R&D", startRow = 15, startCol = 13)
saveWorkbook(wb)

```


## R&D phase Count
```{r RnD}

(
RnDphase<-build_plot(
  data=full_data %>% filter(SimpleArea=="R&D"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="ProductServiceOrRnDarea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)")
)

ggsave600dpi("..//Output//psr_RnDPhase.png", RnDphase, 
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )
                           

write.csv(file="..//Output//psr_RnDPhase.csv",row.names = FALSE, na = "",
          pivot_wider(RnDphase$data,id_cols=c(ProductServiceOrRnDarea),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21)%>%
            arrange(ProductServiceOrRnDarea))
            

write.csv(file="..//Output//psr_RnDPhase_current.csv",row.names = FALSE, na = "",
          full_data %>% filter(SimpleArea=="R&D") %>%
            format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "ProductServiceOrRnDarea",
                                 labels_and_colors=labels_and_colors) %>%
          pivot_wider(id_cols=c(ProductServiceOrRnDarea),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(ProductServiceOrRnDarea))

```

## R&D Phase+OTA    
```{r PhaseAndOTA}

contract_merge<-full_data %>%
  group_by(Fiscal_Year,
                         ProductServiceOrRnDarea,
                         SimpleArea)%>%
  dplyr::summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
                   Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year))

# 


#   format_data_for_plot(contract_data,
#                      fy_var="Fiscal_Year", #x_var
#                      y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
#                      color_var="ProductServiceOrRnDarea", #color_var
#                      facet_var = "SimpleArea",
#                      labels_and_colors = labels_and_colors
# )
# ota_merge<-format_data_for_plot(ota_def,
#                      fy_var="Fiscal_Year", #x_var
#                      y_var="Dollars_Obligated_OMB23_GDP21", #VAR.y.variable
#                      color_var="ProductServiceOrRnDarea", #color_var
#                      facet_var = "SimpleArea",
#                      labels_and_colors = labels_and_colors
# )
ota_def<-standardize_variable_names(ota_def)
ota_merge<-ota_def%>%filter(Fiscal_Year >=2015 & Fiscal_Year <=2021) %>%
  group_by(Fiscal_Year,SimpleArea)%>%
  dplyr::summarise(Action_Obligation_OMB23_GDP21=sum(Dollars_Obligated_OMB23_GDP21),
                   Action_Obligation_Then_Year=sum(Dollars_Obligated_Then_Year)
                   )

#   format_data_for_plot(ota_def,
#                      fy_var="Fiscal_Year", #x_var
#                      y_var="Dollars_Obligated_OMB23_GDP21", #VAR.y.variable
#                      color_var="ProductServiceOrRnDarea", #color_var
#                      facet_var = "SimpleArea",
#                      labels_and_colors = labels_and_colors
# )

ota_merge$ProductServiceOrRnDarea<-"Other Transaction Authority (OTA) R&D Agreements"
colnames(ota_merge)[colnames(ota_merge)=="Fiscal_Year"]<-"Fiscal_Year"
merge<-rbind(ota_merge,contract_merge)
merge$dFYear<-as.Date(paste(merge$Fiscal_Year,"1","1",sep="-"))
(
RnDphasePlusOTA<-build_plot(
  data=merge %>% filter(SimpleArea=="R&D" & Fiscal_Year >=2015),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=prepare_labels_and_colors(merge),
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="ProductServiceOrRnDarea", #color_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE,
  reverse_color = TRUE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)")
)+scale_x_date(date_labels="'%y",date_breaks="1 year")

ggsave600dpi("..//Output//RnDPhasePlusOTA.png", RnDphasePlusOTA+labs(caption="Source: FPDS and CSIS analysis."),
             width=5, height= 4.75, units="in",size=11, lineheight=1.2
             )

ggsave600dpi("..//Output//RnDPhasePlusOTA.svg", RnDphasePlusOTA+labs(caption="Source: FPDS and CSIS analysis."),
             width=5, height= 4.75, units="in",size=11, lineheight=1.2
             )

ggsave600dpi("..//Output//RnDPhasePlusOTA.emf", RnDphasePlusOTA+labs(caption="Source: FPDS and CSIS analysis."),
             width=5, height= 4.75, units="in",size=11, lineheight=1.2
             )

#                            
# 
# write.csv(file="..//Output//RnDPhasePlusOTA.csv",row.names = FALSE, na = "",
#           RnDphasePlusOTA$data%>% mutate(Fiscal_Year=year(dFYear)) %>%
#           pivot_wider(id_cols=c(ProductServiceOrRnDarea),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21)%>%
#             arrange(ProductServiceOrRnDarea))
# #             
# #  



write.csv(file="..//Output//RnDPhasePlusOTA_current.csv",row.names = FALSE, na = "",
          merge %>% filter(SimpleArea=="R&D") %>%
            format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",
                                 color_var = "ProductServiceOrRnDarea",
                                 labels_and_colors=prepare_labels_and_colors(merge)) %>%
            pivot_wider(id_cols=c(ProductServiceOrRnDarea),
                        names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(ProductServiceOrRnDarea))

```

## Phase: Contract and OTA
```{r PhaseBoth}

contract_merge<-full_data%>%filter(Fiscal_Year >=2015) %>%
  group_by(Fiscal_Year,
                         ProductServiceOrRnDarea,
                         SimpleArea)%>%
  dplyr::summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21))

# 
#   format_data_for_plot(contract_data,
#                      fy_var="Fiscal_Year", #x_var
#                      y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
#                      color_var="ProductServiceOrRnDarea", #color_var
#                      facet_var = "SimpleArea",
#                      labels_and_colors = labels_and_colors
# )
# ota_merge<-format_data_for_plot(ota_def,
#                      fy_var="Fiscal_Year", #x_var
#                      y_var="Dollars_Obligated_OMB23_GDP21", #VAR.y.variable
#                      color_var="ProductServiceOrRnDarea", #color_var
#                      facet_var = "SimpleArea",
#                      labels_and_colors = labels_and_colors
# )

ota_merge<-standardize_variable_names(ota_def)%>%filter(Fiscal_Year >=2015) %>%
  group_by(Fiscal_Year,
                         ProductServiceOrRnDarea,
                         SimpleArea)%>%
  dplyr::summarise(Action_Obligation_OMB23_GDP21=sum(Dollars_Obligated_OMB23_GDP21))


#   format_data_for_plot(ota_def,
#                      fy_var="Fiscal_Year", #x_var
#                      y_var="Dollars_Obligated_OMB23_GDP21", #VAR.y.variable
#                      color_var="ProductServiceOrRnDarea", #color_var
#                      facet_var = "SimpleArea",
#                      labels_and_colors = labels_and_colors
# )

ota_merge$Authority<-"OTA"
colnames(ota_merge)[colnames(ota_merge)=="Fiscal_Year"]<-"Fiscal_Year"
contract_merge$Authority<-"Contract"
merge<-rbind(ota_merge,contract_merge)

(
RnDphase<-build_plot(
  data=merge %>% filter(SimpleArea=="R&D"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=prepare_labels_and_colors(merge),#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\"
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Authority", #color_var
  facet_var="ProductServiceOrRnDarea", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)")
)

ggsave600dpi("..//Output//contractota_RnDPhase.png", RnDphase,
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )
#                            
# 
write.csv(file="..//Output//contractota_RnDPhase.csv",row.names = FALSE, na = "",
          pivot_wider(RnDphase$data,id_cols=c(ProductServiceOrRnDarea,Authority),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21)%>%
            arrange(ProductServiceOrRnDarea,Authority))
#             
# 
# write.csv(file="..//Output//psr_RnDPhase_current.csv",row.names = FALSE, na = "",
#           full_data %>% filter(SimpleArea=="R&D") %>%
#             format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "ProductServiceOrRnDarea",
#                                  labels_and_colors=labels_and_colors) %>%
#           pivot_wider(id_cols=c(ProductServiceOrRnDarea),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
#             arrange(ProductServiceOrRnDarea))

```

## Services
```{r Services}

(
Services<-build_plot(
  data=full_data %>% filter(SimpleArea=="Services (Non-R&D)"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="ProductServiceOrRnDarea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)")
)

ggsave600dpi("..//Output//psr_Services.png", Services, 
             width=12, height= 6, units="in",size=14, lineheight=1.2
             )
              
ggsave600dpi("..//Output//psr_Services.svg", Services, 
             width=6.5, height= 3.25, units="in",size=10, lineheight=1.2
             )             

write.csv(file="..//Output//psr_Services.csv",row.names = FALSE, na = "",
          pivot_wider(Services$data,id_cols=c(ProductServiceOrRnDarea),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21)%>%
            arrange(ProductServiceOrRnDarea))
            
output_TY<-full_data %>% 
  format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "ServicesCategory.detail",
                                 labels_and_colors=labels_and_colors) %>%
          pivot_wider(id_cols=c(ServicesCategory.detail),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(ServicesCategory.detail)

write.csv(file="..//Output//psr_Services_current.csv",row.names = FALSE, na = "",
          output_TY)

wb <- loadWorkbook("..//Output//DoD_Acq_Trends_Contracts.xlsx", create = TRUE)
createSheet(wb, name = "Area")
writeWorksheet(wb, output_TY, sheet = "Area", startRow = 2, startCol = 14)
createSheet(wb, name = "Services")
writeWorksheet(wb, output_TY %>% filter(!ServicesCategory.detail %in% c("Products","Fuels","R&D","Unlabeled")), sheet = "Services", startRow = 2, startCol = 14)
saveWorkbook(wb)

```


### P/S/R Vendor size 
```{r}


(
SimpleVendor_dollar<-build_plot(
  data=full_data %>% filter(Fiscal_Year<=2020 & !is.na(SimpleArea) & SimpleArea!="Unlabeled"),
  chart_geom = "Bar Chart",
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE,
  share=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)",caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April of 2020\n and thus did not make the cutofff for inclusion in FY2020.\nMcDonnell Douglas is grouped with the Big-5.")
)

ggsave600dpi("..//Output//psr_vendorsize_dollar.png", SimpleVendor_dollar, 
             width=6.5, height= 5, units="in",size=11, lineheight=1.2
             )


(
SimpleVendor_share<-build_plot(
  data=full_data %>% filter(Fiscal_Year<=2020 & !is.na(SimpleArea) & SimpleArea!="Unlabeled"),
  chart_geom = "Bar Chart",
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE,
  share=TRUE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)",caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April of 2020\n and thus did not make the cutofff for inclusion in FY2020\n McDonnell Douglas is grouped with the Big-5.")
)


ggsave600dpi("..//Output//psr_vendorsize_share.png", SimpleVendor_share, 
             width=6.5, height= 5, units="in",size=11, lineheight=1.2
             )

```

### Simple Area Competition
```{r comp_plat}

(
PSRComp_line<-build_plot(
  data=full_data %>% filter(Fiscal_Year>=1991 & SimpleArea!="Unlabeled"),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # 
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Obligations (Constant 2021 $s)")+scale_x_date(date_breaks = "4 years",date_labels = "'%y")
)



(
PSRComp_bar<-build_plot(
  data=full_data %>% filter(Fiscal_Year>=1991 & SimpleArea!="Unlabeled"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # 
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Obligations (Constant 2021 $s)")+scale_x_date(date_breaks = "4 years",date_labels = "'%y")
)


(
PSRComp_line<-build_plot(
  data=full_data %>% filter(Fiscal_Year>=1991 & SimpleArea!="Unlabeled"),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # 
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Obligations (Constant 2021 $s)")+scale_x_date(date_breaks = "4 years",date_labels = "'%y")
)

ggsave600dpi("..//Output/PSRComp_line.png", PSRComp_line, 
             width=6.5, height= 5, units="in",size=12, lineheight=1.2
             )
```



# SubCustomer
## Topline SubCustomer 
```{r SubCustomer}

(
SubCustomer<-build_plot(
  data=full_data,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="SubCustomer.platform", #color_var
  facet_var="SubCustomer.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)")
)

ggsave600dpi("..//Output//topline_subcustomer.png", SubCustomer, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi("..//Output//topline_subcustomer.svg", SubCustomer+facet_wrap(~SubCustomer.sum,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi("..//Output//topline_subcustomer.emf", SubCustomer+facet_wrap(~SubCustomer.sum,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )


write.csv(file="..//Output//topline_subcustomer.csv",row.names = FALSE, na = "",
          pivot_wider(SubCustomer$data,id_cols=c(SubCustomer.sum,SubCustomer.platform),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21))

write.csv(file="..//Output//topline_subcustomer_current.csv",row.names = FALSE, na = "",
          full_data %>% group_by(SubCustomer.sum,ContractingSubCustomer,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(SubCustomer.sum,ContractingSubCustomer),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(full_data$ContractingSubCustomer)
```

## SubCustomer Product/Service/R&D
```{r SubCustomerPSR}

(
SubCustomerPSR<-build_plot(
  data=full_data,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="SimpleArea", #color_var
  facet_var="SubCustomer.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2021 $s)")
)

# ggsave600dpi("..//Output//subcustomer_PSR.png", SubCustomerPSR, 
#              width=6.5, height= 4, units="in",size=11
#              )
ggsave600dpi("..//Output//subcustomer_PSR.png", SubCustomerPSR, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )
```

## SubCustomer Competition
```{r SubCustomerComp}
full_data$SubCustomer.platform
(
SubCustomerComp_line<-build_plot(
  data=full_data,
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Competition.effective.only", #color_var
  facet_var="SubCustomer.platform", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2021 $s)")
)

# ggsave600dpi("..//Output//subcustomer_PSR.png", SubCustomerPSR, 
#              width=6.5, height= 4, units="in",size=11
#              )
ggsave600dpi("..//Output//subcustomer_Comp_line.png", SubCustomerComp_line, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )

(
SubCustomerComp_bar<-build_plot(
  data=full_data,
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  facet_var="SubCustomer.platform", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2021 $s)")
)

ggsave600dpi("..//Output//subcustomer_Comp_bar.png", SubCustomerComp_bar, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )


write.csv(file="..//Output//subcustomer_competition.csv",row.names = FALSE, na = "",
          SubCustomerComp_line$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(SubCustomer.platform,Competition.effective.only),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21)%>%
            arrange(SubCustomer.platform,Competition.effective.only))

```



# Platform
## Topline  Platform
```{r Platform}

(
Platform<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=1990),
  chart_geom = "Line Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="PlatformPortfolio", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2021 $s)")
)

ggsave600dpi("..//Output//topline_platform.png", Platform, 
             width=12, height= 6, units="in",size=14,lineheight = 1.2
             )

ggsave600dpi("..//Output//topline_platform.svg", Platform, 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi("..//Output//topline_platform.emf", Platform+geom_line(
  size=1,aes(x=dFYear,y=Action_Obligation_OMB23_GDP21,color=PlatformPortfolio)),
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )


(
Platform_Bar<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=1990),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="PlatformPortfolio", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2021 $s)")
)

ggsave600dpi("..//Output//topline_platform_bar.png", Platform_Bar, 
             width=11, height= 5.5, units="in",size=14,lineheight = 1.2
             )

ggsave600dpi("..//Output//topline_platform_bar.emf", Platform_Bar,
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

output_TY<-full_data %>% group_by(PlatformPortfolio,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(PlatformPortfolio),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%arrange(PlatformPortfolio)

write.csv(file="..//Output//topline_platform_current.csv",row.names = FALSE, na = "",
          output_TY)

wb <- loadWorkbook("..//Output//DoD_Acq_Trends_Contracts.xlsx", create = TRUE)
createSheet(wb, name = "Platform Portfolio")
writeWorksheet(wb, output_TY, sheet = "Platform Portfolio", startRow = 15, startCol = 1)
saveWorkbook(wb)
rm(wb)

```

## Platform by Service
```{r Platform}
for(s in c("Army","Navy","Air Force")){
  
  (
    Platform<-build_plot(
      data=full_data %>% filter(SubCustomer.sum==s),
      chart_geom = "Line Chart",
      share = FALSE,
      labels_and_colors=labels_and_colors,
      # NA, #VAR.ncol
      x_var="dFYear", #x_var
      y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
      color_var="PlatformPortfolio", #color_var
      facet_var="PlatformPortfolio", #facet_var
      column_key=column_key,
      format=TRUE,
      ytextposition=FALSE
    )+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
      # theme(strip.text.y = element_text(angle=0))+
      # theme(axis.text.x = element_text(angle=90))+
      #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
      #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
      #             )+labs(title=NULL,
      # x="Fiscal Year",
      # y="Percent of Obligations",
      # color="Competition")+
      theme(legend.position = "none")+
      labs(y="Obligations (Constant 2021 $s)")
  )
  
  ggsave600dpi(paste("..//Output//",s,"_platform.png",sep=""), Platform, 
               width=12, height= 6, units="in",size=14,lineheight = 1.2
  )
  
  ggsave600dpi(paste("..//Output//",s,"_platform.svg",sep=""), Platform, 
               width=6.5, height= 4, units="in",size=11,lineheight = 1.2
  )
  
  ggsave600dpi(paste("..//Output//",s,"_platform.emf",sep=""), Platform+geom_line(
    size=1,aes(x=dFYear,y=Action_Obligation_OMB23_GDP21,color=PlatformPortfolio)),
    width=6.5, height= 4, units="in",size=11,lineheight = 1.2
  )
}
# 
# (
# Platform_Bar<-build_plot(
#   data=full_data,
#   chart_geom = "Bar Chart",
#   share = FALSE,
#   labels_and_colors=labels_and_colors,
#   # NA, #VAR.ncol
#   x_var="dFYear", #x_var
#   y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
#   color_var="PlatformPortfolio", #color_var
#   facet_var="PlatformPortfolio", #facet_var
#   column_key=column_key,
#   format=TRUE,
#   ytextposition=FALSE
# )+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
#   # theme(strip.text.y = element_text(angle=0))+
#  # theme(axis.text.x = element_text(angle=90))+
#  #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
#  #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
#  #             )+labs(title=NULL,
#   # x="Fiscal Year",
#   # y="Percent of Obligations",
#   # color="Competition")+
#   theme(legend.position = "none")+
#   labs(y="Obligations (Constant 2021 $s)")
# )
# 
# ggsave600dpi("..//Output//topline_platform_bar.png", Platform_Bar, 
#              width=12, height= 6, units="in",size=12,lineheight = 1.2
#              )
# 
# ggsave600dpi("..//Output//topline_platform_bar.emf", Platform_Bar,
#              width=6.5, height= 4, units="in",size=11,lineheight = 1.2
#              )
# 
# write.csv(file="..//Output//topline_platform_current.csv",row.names = FALSE, na = "",
#           full_data %>% group_by(PlatformPortfolio,Fiscal_Year)%>%
#             dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
#           pivot_wider(id_cols=c(PlatformPortfolio),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%arrange(PlatformPortfolio))
# 
# wb <- loadWorkbook("..//Output//DoD_Acq_Trends_Contracts.xlsx", create = TRUE)
# createSheet(wb, name = "Platform Portfolio")
# writeWorksheet(wb, output_TY, sheet = "Platform Portfolio", startRow = 15, startCol = 13)
# saveWorkbook(wb)

```

## Platform SubCustomer
```{r PlatformSubCustomer}

(
PlatformSubCustomer<-build_plot(
  data=full_data,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="SubCustomer.platform", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2021 $s)")
)

ggsave600dpi("..//Output//platform_subcustomer.png", PlatformSubCustomer, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

```

## Platform PSR
```{r PlatformPSR}

(
PlatformPSR<-build_plot(
  data=full_data,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="SimpleArea", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2021 $s)")
)

ggsave600dpi("..//Output//platform_PSR.png", PlatformPSR, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

```

## Platform R&D
```{r PlatformPSR}
(
PlatformRnD<-build_plot(
  data=full_data %>% filter(SimpleArea=="R&D"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="SimpleArea", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2021 $s)")
)

ggsave600dpi("..//Output//PlatformRnD.png", PlatformPSR, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

```



## Platform Vendor
```{r PlatformVendor}

(
PlatformVendor_share<-build_plot(
  data=full_data %>% filter(PlatformPortfolio!="Unlabeled" & Fiscal_Year<=2020) ,
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Percent of Obligations",
    caption="Note: McDonnell Douglas is grouped with the Big-5.\nSource: FPDS; CSIS analysis")
)

ggsave600dpi("..//Output//platform_vendor_share.png", PlatformVendor_share, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )



(
PlatformVendor_dollar<-build_plot(
  data=full_data %>% filter(PlatformPortfolio!="Unlabeled" & Fiscal_Year<=2020) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Percent of Obligations",
    caption="Note: The merger of Raytheon and United Technologies took place in April of 2020 and thus did not\nmake the cutoff for inclusion in FY2020. McDonnell Douglas is grouped with the Big-5.\n\nSource: FPDS; CSIS Analysis")
)

ggsave600dpi("..//Output//platform_vendor_dollar.png", PlatformVendor_dollar, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

```


### Size Platform
```{r SizePlatform}



(
ToplineVendor_line<-build_plot(
  data=full_data %>% filter(Fiscal_Year<=2020 & !is.na(SimpleArea) & SimpleArea!="Unlabeled"),
  chart_geom = "Line Chart",
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE,
  share=TRUE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)",caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April of 2020\n and thus did not make the cutofff for inclusion in FY2020.")
)

(
ToplineVendor_line<-build_plot(
  data=full_data %>% filter(Fiscal_Year<=2020 & !is.na(SimpleArea) & SimpleArea!="Unlabeled"),
  chart_geom = "Bar Chart",
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE,
  share=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)",caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April of 2020\n and thus did not make the cutofff for inclusion in FY2020.")
)


```


## Platform Comp
```{r PlatformComp}
# labels_and_colors<-def_lc
# column_key<-def_ck
(
PlatformComp_bar<-build_plot(
  data=def_data %>% filter(PlatformPortfolio!="Unlabeled"  &Fiscal_Year>=1991),
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = scales::date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")#+
  # labs(y="Obligations (Constant 2021 $s)")
)


(
PlatformComp_line<-build_plot(
  data=def_data %>% filter(PlatformPortfolio!="Unlabeled" &Fiscal_Year>=1991),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Competition.effective.only", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = scales::date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")#+
  # labs(y="Obligations (Constant 2021 $s)")
)


ggsave600dpi("..//Output//platform_comp_bar.png", PlatformComp_bar, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )


ggsave600dpi("..//Output//platform_comp_line.png", PlatformComp_line, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

write.csv(file="..//Output//platform_comp_line.csv",row.names = FALSE, na = "",
          PlatformComp_line$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlatformPortfolio,Competition.effective.only),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21)%>%
            arrange(PlatformPortfolio,Competition.effective.only))


```


## Platform Commercial
```{r Commercial}
def_data$AnyCommercialText<-factor(def_data$AnyCommercial)
levels(def_data$AnyCommercialText)<-list(
  "Not Classified\nas Commercial"="N",
  "Non-Development\nor Commercial Similar"= "NonDev",
  "Any Commercial\nClassification"="Y"
  
)

(
CommercialCust<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="AnyCommercialText", #color_var
  facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)")+
    scale_x_date(breaks=as.Date(c(paste(seq(2000,2021,5),"-01-01",sep=""))),
                                                   date_labels="'%y")
)

# (
# Commercial<-build_plot(
#   data=def_data %>% filter(Fiscal_Year>=2000),
#   chart_geom = "Bar Chart",
#   share = FALSE,
#   labels_and_colors=def_lc,
#   # NA, #VAR.ncol
#   x_var="Fiscal_Year", #x_var
#   y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
#   color_var="AnyCommercial", #color_var
#   facet_var="ContractingSubCustomer", #facet_var
#   column_key=def_ck,
#   format=TRUE,
#   ytextposition=FALSE
# )+
#   # theme(strip.text.y = element_text(angle=0))+
#  # theme(axis.text.x = element_text(angle=90))+
#  #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
#  #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
#  #             )+labs(title=NULL,
#   # x="Fiscal Year",
#   # y="Percent of Obligations",
#   # color="Competition")+
#   theme(legend.position = "right")+
#   labs(y="Obligations (Constant 2021 $s)")
# )
# 

(
CommercialPlat<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="AnyCommercialText", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)")
)

ggsave600dpi("..//Output//subcustomer_commercial.png", CommercialCust, 
             width=6, height= 5.5, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi("..//Output//subcustomer_commercial.svg", CommercialCust,#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi("..//Output//subcustomer_commercial.emf", CommercialCust,#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )


write.csv(file="..//Output//topline_subcustomer.csv",row.names = FALSE, na = "",
          pivot_wider(SubCustomer$data,id_cols=c(SubCustomer.sum,SubCustomer.platform),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21))

write.csv(file="..//Output//subcustomer_commercial_current.csv",row.names = FALSE, na = "",
          def_data %>% group_by(SubCustomer.platform,AnyCommercialText,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(SubCustomer.platform,AnyCommercialText),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(SubCustomer.platform,AnyCommercialText))

summary(def_data$ContractingSubCustomer)
```


# Vendor Size
### Vendor Size Vehicle
```{r ToplineVendor}


(
VendorSizeVehicle<-build_plot(
  data=full_data %>% filter(Fiscal_Year<=2020 & Fiscal_Year>2000 & Shiny.VendorSize!="Unlabeled"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Vehicle.sum", #color_var
  facet_var="Shiny.VendorSize", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)",
       caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April 2020 and thus did not make the cutofff for inclusion in FY2020.")
)


(
VendorSizeVehicleSum<-build_plot(
  data=full_data %>% filter(Fiscal_Year<=2020 & Fiscal_Year>2000 & !Shiny.VendorSize=="Unlabeled"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Vehicle.AwardTask", #color_var
  facet_var="Shiny.VendorSize", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+facet_wrap(~Shiny.VendorSize, nrow=1)+
  labs(y="Obligations (Constant 2021 $s)",
       caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April 2020 and thus did not make the cutofff for inclusion in FY2020.\nUnlabeled vendor size excluded.")
)

(
VendorSizeVehicleSumLine<-build_plot(
  data=full_data %>% filter(Fiscal_Year<=2020 & Fiscal_Year>2000 & !is.na(Shiny.VendorSize)),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Vehicle.AwardTask", #color_var
  facet_var="Shiny.VendorSize", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)",
       caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April 2020 and thus did not make the cutofff for inclusion in FY2020.")+facet_wrap(~Shiny.VendorSize, nrow=1)
)


ggsave600dpi("..//Output//vendorsize_vehicle.png", VendorSizeVehicle+
  labs(y="Obligations (Constant 2021 $s)",caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies is took place in \nApril 2020 and thus did not make the cutofff for inclusion in FY2020.\nUnlabeled vendor size excluded."),
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

ggsave600dpi("..//Output//vendorsize_vehicle.svg", VendorSizeVehicle+
  labs(y="Obligations (Constant 2021 $s)",caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies is took place in \nApril 2020 and thus did not make the cutofff for inclusion in FY2020\nUnlabeled vendor size excluded.."),
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

ggsave600dpi("..//Output//vendorsize_awardtask.svg", VendorSizeVehicleSum
+
  labs(y="Obligations (Constant 2021 $s)",caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies is took place in \nApril 2020 and thus did not make the cutofff for inclusion in FY2020.\nUnlabeled vendor size excluded."),
             width=6.5, height= 3.25, units="in",size=11,lineheight=1
             )


write.csv(file="..//Output//vendorsize_vehicle_current.csv",row.names = FALSE, na = "",
          def_data %>% group_by(Shiny.VendorSize,Vehicle.sum,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(Shiny.VendorSize,Vehicle.sum),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(Shiny.VendorSize,Vehicle.sum))


write.csv(file="..//Output//vendorsize_AwardTask_current.csv",row.names = FALSE, na = "",
          def_data %>% group_by(Shiny.VendorSize,Vehicle.AwardTask,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(Shiny.VendorSize,Vehicle.AwardTask),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(Shiny.VendorSize,Vehicle.AwardTask))

```

## Size Commercial
```{r SizePlatform}



(
ToplineVendor_line<-build_plot(
  data=def_data %>% filter(Fiscal_Year<=2020 &  Fiscal_Year>=2000 & !is.na(SimpleArea) & SimpleArea!="Unlabeled"),
  chart_geom = "Line Chart",
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  facet_var="AnyCommercial", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE,
  share=TRUE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)",caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April of 2020\n and thus did not make the cutofff for inclusion in FY2020.")
)

(
ToplineVendor_line<-build_plot(
  data=def_data %>% filter(Fiscal_Year<=2020 &  Fiscal_Year>=2000 & !is.na(SimpleArea) & SimpleArea!="Unlabeled"),
  chart_geom = "Bar Chart",
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="AnyCommercial", #color_var
  facet_var="Shiny.VendorSize", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE,
  share=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)",caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April of 2020\n and thus did not make the cutofff for inclusion in FY2020.")
)


```


### Vendor Size Pricing
```{r ToplineVendor}


(
VendorSizeVehicle<-build_plot(
  data=full_data %>% filter(Fiscal_Year<=2020 & Fiscal_Year>2000 & Shiny.VendorSize!="Unlabeled"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="PricingUCA.sum", #color_var
  facet_var="Shiny.VendorSize", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)",
       caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April 2020 and thus did not make the cutofff for inclusion in FY2020.")
)


(
VendorSizeVehicle<-build_plot(
  data=full_data %>% filter(Fiscal_Year<=2020 & Fiscal_Year>2000 & !is.na(VendorSize_Intl)),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="PricingUCA.sum", #color_var
  facet_var="VendorSize_Intl", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)",
       caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April 2020 and thus did not make the cutofff for inclusion in FY2020.]nUnlabeled vendor size excluded.")
)

(
VendorSizeVehicle<-build_plot(
  data=full_data %>% filter(Fiscal_Year<=2020 & Fiscal_Year>2000),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="PricingUCA.sum", #color_var
  facet_var="VendorSize_Intl", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)",
       caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April 2020 and thus did not make the cutofff for inclusion in FY2020.")
)

# ggsave600dpi("..//Output//topline_vendor_intl_square.png", ToplineVendorIntl+
#   labs(y="Obligations (Constant 2021 $s)",caption="Source: FPDS; CSIS analysis.\nNote: The merger of Raytheon and United Technologies is took place in \nApril 2020 and thus did not make the cutofff for inclusion in FY2020."), 
#              width=6, height= 5, units="in",size=12,lineheight=1
#              )



```
# GFE
```{r GFE}

def_data$gfe_gfp_value<-factor(def_data$gfe_gfp_code)
levels(def_data$gfe_gfp_value)<-list(
   "No Government Furnished"="N",
  "Transaction uses\nGovernment Furnished\nEquipment or Property"="Y"
 
)

(
GFEcust<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="gfe_gfp_value", #color_var
  facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)")+
    scale_x_date(breaks=as.Date(c(paste(seq(2000,2021,5),"-01-01",sep=""))),
                                                   date_labels="'%y")
)


(
GFEplat<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="gfe_gfp_value", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2021 $s)")+
    scale_x_date(breaks=as.Date(c(paste(seq(2000,2021,4),"-01-01",sep=""))),
                                                   date_labels="'%y")
)


(
GFEcomp<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Competition.detail", #color_var
  facet_var="gfe_gfp_value", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)")+
    scale_x_date(breaks=as.Date(c(paste(seq(2000,2021,3),"-01-01",sep=""))),
                                                   date_labels="'%y")
)

ggsave600dpi("..//Output//platform_GFE.png", GFEplat, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi("..//Output//platform_GFE.svg", GFEplat, 
             width=6.5, height= 4.5, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi("..//Output//platform_GFE.emf", GFEplat, 
             width=6.5, height= 4.5, units="in",size=11,lineheight = 1.2
             )


# write.csv(file="..//Output//platform_GFE.csv",row.names = FALSE, na = "",
#           pivot_wider(GFEplat$data,id_cols=c(PlatformPortfolio,gfe_gfp_value),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21))

write.csv(file="..//Output//platform_GFE_current.csv",row.names = FALSE, na = "",
          def_data %>% group_by(PlatformPortfolio,gfe_gfp_value,Fiscal_Year)%>%filter(Fiscal_Year>=2004)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(PlatformPortfolio,gfe_gfp_value),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(full_data$ContractingSubCustomer)
```


# Cost Accounting
```{r SubCustomer}


(
CAS<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="costaccountingstandardsclause", #color_var
  facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)")
)


(
CAS<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="costaccountingstandardsclause", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)")
)


(
CAS<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="Competition.detail", #color_var
  facet_var="costaccountingstandardsclause", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)")
)


(
CAS<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="AnyCommercial", #color_var
  facet_var="costaccountingstandardsclause", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)")
)

ggsave600dpi("..//Output//topline_subcustomer.png", SubCustomer, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi("..//Output//topline_subcustomer.svg", SubCustomer+facet_wrap(~SubCustomer.sum,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi("..//Output//topline_subcustomer.emf", SubCustomer+facet_wrap(~SubCustomer.sum,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )


write.csv(file="..//Output//topline_subcustomer.csv",row.names = FALSE, na = "",
          pivot_wider(SubCustomer$data,id_cols=c(SubCustomer.sum,SubCustomer.platform),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21))

write.csv(file="..//Output//topline_subcustomer_current.csv",row.names = FALSE, na = "",
          full_data %>% group_by(SubCustomer.sum,ContractingSubCustomer,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(SubCustomer.sum,ContractingSubCustomer),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(full_data$ContractingSubCustomer)
```

# Energy Efficient
```{r SubCustomer}



(
EE<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="EnergyEfficient", #color_var
  facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)")
)


(
EE<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
  color_var="EnergyEfficient", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2021 $s)")
)



ggsave600dpi("..//Output//topline_subcustomer.png", SubCustomer, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi("..//Output//topline_subcustomer.svg", SubCustomer+facet_wrap(~SubCustomer.sum,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi("..//Output//topline_subcustomer.emf", SubCustomer+facet_wrap(~SubCustomer.sum,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )


write.csv(file="..//Output//topline_subcustomer.csv",row.names = FALSE, na = "",
          pivot_wider(SubCustomer$data,id_cols=c(SubCustomer.sum,SubCustomer.platform),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21))

write.csv(file="..//Output//topline_subcustomer_current.csv",row.names = FALSE, na = "",
          full_data %>% group_by(SubCustomer.sum,ContractingSubCustomer,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(SubCustomer.sum,ContractingSubCustomer),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(full_data$ContractingSubCustomer)
```

#International


###FMS identification
```{r contract_identification}

summary(full_data$foreign_funding_description)

# undebug(build_plot)

(contract_identification <-  build_plot(data=full_data ,
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB23_GDP21",
                            color_var="foreign_funding_description",
                            facet_var="IsFMS",
                            # second_var="StateRegion",
                            # labels_and_colors=intl_lc,
                            # column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS; CSIS analysis.")+
    guides(fill=guide_legend(ncol=3)))

ggsave600dpi(contract_identification,file="../output/figure_03_contract_identification.png",size=12,lineheight=1, height =5, width=9)



```
###Buy America
```{r contract_identification}

summary(full_data$PlaceOfManufacture_Sum)

# undebug(build_plot)

(contract_identification <-  build_plot(data=full_data ,
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB23_GDP21",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="SimpleArea",
                            # second_var="StateRegion",
                            labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS; CSIS analysis.")+
    guides(fill=guide_legend(ncol=3)))


(contract_identification <-  build_plot(data=full_data %>% filter(!is.na(PlaceIsForeign)),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB23_GDP21",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="PlaceIsForeign",
                            # second_var="StateRegion",
                            labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    facet_grid(  PlaceIsForeign~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s,\nVariable Axis)",
       caption="Source: FPDS; CSIS analysis.")+
    guides(fill=guide_legend(ncol=3)))


(contract_identification <-  build_plot(data=full_data ,
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB23_GDP21",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="VendorIsForeign",
                            # second_var="StateRegion",
                            labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS; CSIS analysis.")+
    guides(fill=guide_legend(ncol=3)))


ggsave600dpi(contract_identification,file="../output/figure_03_contract_identification.png",size=12,lineheight=1, height =5, width=9)



```
#### Waiver Type

```{r contract_identification}

summary(full_data$PlaceOfManufactureText)
full_data$PlaceOfManufactureText20<-factor_wrap(full_data$PlaceOfManufactureText)
# undebug(build_plot)
summary(factor(full_data$PlaceOfManufactureText20))

write.csv(full_data %>% group_by(PlaceOfManufactureText,PlaceIsForeign,VendorIsForeign,OriginIsForeign) %>%
  summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21)) %>% pivot_wider(names_from=PlaceOfManufactureText,
                                                                                       values_from=Action_Obligation_OMB23_GDP21),
  file="waiver_crossref.csv")
  


full_data$OriginManufactureVendor<-NA
# full_data$OriginManufactureVendor[full_data$PlaceOfManufacture_Sum=="Manufactured Outside U.S."]<-"Foreign Manufacture or Origin"
full_data$OriginManufactureVendor[full_data$OriginIsForeign==1]<-"Foreign Manufacture or Origin"
full_data$OriginManufactureVendor[is.na(full_data$OriginManufactureVendor)]<-
  full_data$PlaceOfManufactureText[is.na(full_data$OriginManufactureVendor)]


 full_data<-csis360::read_and_join_experiment(full_data,
                                          "Location_PlaceOfManufacture.csv",
                                          by="PlaceOfManufacture",
                                          add_var=c("PlaceOfManufactureText","PlaceOfManufacture_Sum",
                                                    "PlaceOfManufacture_DoD"),
                                          skip_check_var = c("PlaceOfManufactureText","PlaceOfManufacture_Sum",
                                                             "PlaceOfManufacture_DoD"),
                                          # path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                                          # path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\",
                                          path="C:\\Users\\gsand\\Repositories\\Lookup-Tables\\",
                                          # path="F:\\Users\\gsanders\\Documents\\Repositories\\Lookup-Tables\\",
                                          dir="location/",
                                          case_sensitive = FALSE
    )
 
 # debug(factor_wrap)
 full_data$OriginManufactureVendor20<-factor_wrap(full_data$OriginManufactureVendor)
 
full_data$Service<-factor(full_data$SimpleArea)
levels(full_data$Service)<-list("Products"="Products (All)",
                                "Services and R&D"=c("R&D", "Services (Non-R&D)"),
                                "Unlabeled"="Unlabeled")
 
full_data$OriginManufactureVendor<-full_data$PlaceOfManufacture_DoD

 full_data$OriginManufactureVendor[is.na(full_data$OriginManufactureVendor)&                                    
                                     (full_data$Service=="Services and R&D" | 
                                        full_data$PlaceOfManufactureText=="NOT A MANUFACTURED END PRODUCT") &
                                     (full_data$VendorIsForeign==1 | full_data$OriginIsForeign==1)]<-"Not MFG, Foreign Vendor or Origin"
 full_data$OriginManufactureVendor[full_data$OriginManufactureVendor=="U.S. Manufactured" &
                                    (full_data$VendorIsForeign==1 | full_data$OriginIsForeign==1)]<-"U.S. Manufactured, Foreign Vendor or Origin"

  full_data %>% filter(OriginManufactureVendor=="Unlabeled Waiver" &
                         Service=="Services and R&D" )  %>% group_by(VendorIsForeign,OriginIsForeign) %>%
    summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21))
 
 
 full_data %>% filter(PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1) %>%
   filter(is.na(OriginManufactureVendor))%>%
   group_by(PlaceOfManufactureText,OriginManufactureVendor,Service,PlaceIsForeign,VendorIsForeign,OriginIsForeign) %>%
  summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21)) 

 # full_data$OriginManufactureVendor[is.na(full_data$OriginManufactureVendor)&
 #                                     full_data$VendorIsForeign==1&full_data$OriginIsForeign==0]<-"U.S. Origin Intl Vendor"
 # 
 # full_data$OriginManufactureVendor[is.na(full_data$OriginManufactureVendor)&
 #                                     full_data$VendorIsForeign==0&full_data$OriginIsForeign==1]<-"Intl Vendor U.S. Origin"
 #  
 # full_data$OriginManufactureVendor[is.na(full_data$OriginManufactureVendor)&
 #                                     full_data$VendorIsForeign==1&full_data$OriginIsForeign==1]<-"Intl Vendor Intl Origin"
 # 
 # full_data$OriginManufactureVendor[full_data$OriginManufactureVendor=="Unlabeled Waiver" &
 #                                     full_data$Service=="Services and R&D" &
 #                                     full_data$VendorIsForeign==0&full_data$OriginIsForeign==1]<-"Intl Vendor U.S. Origin"
 #  
 # full_data$OriginManufactureVendor[full_data$OriginManufactureVendor=="Unlabeled Waiver" & 
 #                                     full_data$Service=="Services and R&D" &
 #                                     full_data$VendorIsForeign==1&full_data$OriginIsForeign==1]<-"Intl Vendor Intl Origin"
 # 
 #  full_data$OriginManufactureVendor[full_data$OriginManufactureVendor=="Unlabeled Waiver" & 
 #                                     full_data$Service=="Services and R&D" &
 #                                     full_data$VendorIsForeign==1&full_data$OriginIsForeign==0]<-"U.S. Origin Intl Vendor"
 #  
  
  full_data %>% filter(OriginManufactureVendor=="Unlabeled Waiver" &
                         Service=="Services and R&D" )  %>% group_by(VendorIsForeign,OriginIsForeign) %>%
    summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21))
  
   full_data %>% filter(is.na(OriginManufactureVendor) &
                         Service=="Services and R&D" )  %>% group_by(VendorIsForeign,OriginIsForeign) %>%
    summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21))
  
  
  
  
(waiverdetail <-  build_plot(data=full_data %>% filter(PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1)  %>%filter(!is.na(SimpleArea) & SimpleArea!="Unlabeled"),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB23_GDP21",
                            color_var="PlaceOfManufacture_DoD",
                            facet_var="SimpleArea",
                            # second_var="OriginIsForeign",
                            # labels_and_colors=labels_and_colors,
                            # column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    facet_grid(  SimpleArea~.)+
  labs(x="Fiscal Year",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS; CSIS analysis.")+
    theme(legend.position = "right")
    # guides(fill=guide_legend(ncol=2)
)

  ggsave600dpi(waiverdetail,file="../output/waiverdetail.png",size=14,lineheight=1, height =5.75, width=7)


  
  
  
    write.csv(file="..//Output//waiverdetail.csv",row.names = FALSE, na = "",
            waiverdetail$data %>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
              pivot_wider(id_cols=c(PlaceOfManufacture_DoD,SimpleArea),
                          names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21)
            %>% arrange(PlaceOfManufacture_DoD,SimpleArea))

```
##### Simple Waiver Type
```{r SimpleWaiver}
full_data$PlaceOfManufacture_DoD09<-full_data$PlaceOfManufacture_DoD
full_data %>% filter(OriginManufactureVendor=="Unlabeled Waiver" &
                         Service=="Services and R&D" )  %>% group_by(VendorIsForeign,OriginIsForeign) %>%
    summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21))
  
   full_data %>% filter(is.na(OriginManufactureVendor) &
                         Service=="Services and R&D" )  %>% group_by(VendorIsForeign,OriginIsForeign) %>%
    summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21))
  
  
 full_data$PlaceOfManufacture_DoD09[is.na(full_data$PlaceOfManufacture_DoD09)&                                    
                                     (full_data$Service=="Services and R&D" | 
                                        full_data$PlaceOfManufactureText=="NOT A MANUFACTURED END PRODUCT") &
                                     (full_data$VendorIsForeign==1 | full_data$OriginIsForeign==1)&
                                    full_data$PlaceIsForeign==1]<-"Not MFG, Foreign Place of Performance"
 full_data$PlaceOfManufacture_DoD09[full_data$PlaceOfManufacture_DoD09=="U.S. Manufactured" &
                                    (full_data$VendorIsForeign==1 | full_data$OriginIsForeign==1)]<-
   "U.S. Manufactured, Foreign Vendor or Origin"
 full_data$PlaceOfManufacture_DoD09[is.na(full_data$PlaceOfManufacture_DoD09)&                                    
                                     (full_data$Service=="Services and R&D" | 
                                        full_data$PlaceOfManufactureText=="NOT A MANUFACTURED END PRODUCT") &
                                     (full_data$VendorIsForeign==1 | full_data$OriginIsForeign==1)&
                                    full_data$PlaceIsForeign==0]<-"Not MFG, U.S. Place of Performance"
  full_data$PlaceOfManufacture_DoD09[full_data$PlaceOfManufacture_DoD09=="Foreign MFG, Perfomed, or Content, Unlabeled Waiver"]<-NA
 
full_data$PlaceOfManufacture_DoD09<-factor_wrap(full_data$PlaceOfManufacture_DoD09,nwrap=45)
 
  
(waiversimple <-  build_plot(data=full_data %>% filter(PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1)  %>%
                               filter(!is.na(SimpleArea) & SimpleArea!="Unlabeled")%>%
                               filter(Fiscal_Year>=2009),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB23_GDP21",
                            color_var="PlaceOfManufacture_DoD09",
                            facet_var="Service",
                            # second_var="OriginIsForeign",
                            # labels_and_colors=labels_and_colors,
                            # column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    facet_grid(  Service~.)+
  labs(x="Fiscal Year",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS; CSIS analysis.",
       title="DoD Contracts with International\nVendors, Manufacture, or Origin")+
    theme(legend.position = "right")
    # guides(fill=guide_legend(ncol=2)
)

  ggsave600dpi(waiversimple,file="../output/waiversimple.png",size=14,lineheight=1, height =5.75, width=7)
  ggsave600dpi(waiversimple,file="../output/waiversimple.svg",size=14,lineheight=1, height =5.75, width=7)


  
  
  
    write.csv(file="..//Output//waiversimple.csv",row.names = FALSE, na = "",
            waiversimple$data %>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
              pivot_wider(id_cols=c(PlaceOfManufacture_DoD09,Service),
                          names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21)
            %>% arrange(PlaceOfManufacture_DoD09,Service))
```


#### Waiverplace
```{r WaiverPlace}
  (waiverally <-  build_plot(data=full_data %>% filter(PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1) ,
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB23_GDP21",
                            color_var="OriginManufactureVendor20",
                            facet_var="PlaceAcquisitionCooperation",
                            # second_var="StateRegion",
                            # labels_and_colors=labels_and_colors,
                            # column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS; CSIS analysis.")+
    theme(legend.position = "right")
    # guides(fill=guide_legend(ncol=2)
)
             

(placemanufacture <-  build_plot(data=full_data %>% filter(!is.na(PlaceIsForeign)),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB23_GDP21",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="PlaceIsForeign",
                            # second_var="StateRegion",
                            labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    facet_grid(  PlaceIsForeign~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s,\nVariable Axis)",
       caption="Source: FPDS; CSIS analysis.")+
    guides(fill=guide_legend(ncol=3)))




(vendormanufacture <-  build_plot(data=full_data ,
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB23_GDP21",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="VendorIsForeign",
                            # second_var="StateRegion",
                            labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS; CSIS analysis.")+
    guides(fill=guide_legend(ncol=3)))





```
#### Place
```{r buy_america_place}

levels(factor(full_data$PlaceStateRegion))
full_data$PlaceStateRegion<-factor(full_data$PlaceStateRegion)
full_data$PlaceStateRegionSum<-factor(full_data$PlaceStateRegion)
levels(full_data$PlaceStateRegionSum)<-
  list("United States"="United States",
       "East Asia and Pacific"="East Asia and Pacific"  ,
       "Europe and Eurasia"="Europe and Eurasia"     ,
       "Near East"="Near East",
       "South and Central Asia"="South and Central Asia",
       "Rest of World"=c("Western Hemisphere","Non-Regional","Africa")
       )


summary(full_data$PlaceStateRegionSum)

full_data$PlaceOfManufactureText20<-factor_wrap(full_data$PlaceOfManufactureText)
# undebug(build_plot)
summary(factor(full_data$PlaceOfManufactureText20))
(placeregion <-  build_plot(data=full_data %>% filter((PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1)&!is.na(PlaceStateRegion)
                                                     ),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB23_GDP21",
                            color_var="OriginManufactureVendor20",
                            facet_var="PlaceStateRegionSum",
                            # second_var="StateRegion",
                            labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    facet_grid(.~  PlaceStateRegionSum)+
  labs(x="Fiscal Year",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS; CSIS analysis.")+
    
    theme(legend.position = "bottom")+scale_x_date(breaks=as.Date(c(paste(seq(2000,2021,3),"-01-01",sep=""))),
                                                   date_labels="'%y")#date_breaks = "3 years"
    # guides(fill=guide_legend(ncol=2)
           )

ggsave600dpi(placeregion,file="../output/place_of_manufacture_place_regionwaiver.png",size=14,lineheight=1, height =6, width=12)



summary(full_data$vendor)
full_data$PlaceMutualAcquisition
(placeregion <-  build_plot(data=full_data %>% filter((PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1)&!is.na(PlaceStateRegion)
                                                     ),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB23_GDP21",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="PlaceMutualAcquisition",
                            # second_var="StateRegion",
                            labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS; CSIS analysis.")+
    theme(legend.position = "bottom")
    # guides(fill=guide_legend(ncol=2)
           )
full_data$PlaceAcquisitionCooperation

(placeregion <-  build_plot(data=full_data %>% filter((PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1)&!is.na(PlaceStateRegion)
                                                     ),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB23_GDP21",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="PlaceAcquisitionCooperation",
                            # second_var="StateRegion",
                            labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS; CSIS analysis.")+
    theme(legend.position = "bottom")
    # guides(fill=guide_legend(ncol=2)
           )


full_data$place


(vendorregion <-  build_plot(data=full_data %>% filter(PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1) ,
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB23_GDP21",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="VendorStateRegion",
                            # second_var="VendorRegion",
                            # labels_and_colors=labels_and_colors,
                            # column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS; CSIS analysis.")+
    theme(legend.position = "bottom")
    # guides(fill=guide_legend(ncol=2)
           )


(originregion <-  build_plot(data=full_data %>% filter(PlaceOfManufacture_Sum %in% c("In U.S. but Foreign Services or Content",
                                                                          "Manufactured Outside U.S.",
                                                                          "Performed/Manufactured Outside U.S.")|
                                                   VendorIsForeign==1|OriginIsForeign==1) ,
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB23_GDP21",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="OriginStateRegion",
                            # second_var="VendorRegion",
                            # labels_and_colors=labels_and_colors,
                            # column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS; CSIS analysis.")+
    theme(legend.position = "bottom")
    # guides(fill=guide_legend(ncol=2)
           )


ggsave600dpi(waiver,file="../output/place_of_manufacture_waiver.png",size=8,lineheight=1, height =5, width=9)


(contract_identification <-  build_plot(data=full_data %>% filter(!is.na(PlaceIsForeign)),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB23_GDP21",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="PlaceIsForeign",
                            # second_var="StateRegion",
                            labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    facet_grid(  PlaceIsForeign~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s,\nVariable Axis)",
       caption="Source: FPDS; CSIS analysis.")+
    guides(fill=guide_legend(ncol=3)))






```
###Korea

```{r}

(korea <-  build_plot(data=full_data %>% filter(PlaceISOalpha3=="KOR" |
                                                  VendorISOalpha3=="KOR" |
                                                  OriginISOalpha3=="KOR"),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB23_GDP21",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="SimpleArea",
                            # second_var="StateRegion",
                            labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS; CSIS analysis.")+
    theme(legend.position = "bottom")
    # guides(fill=guide_legend(ncol=2)
)

full_data$IsFMS
(korea <-  build_plot(data=full_data %>% filter(PlaceISOalpha3=="KOR" |
                                                  VendorISOalpha3=="KOR" |
                                                  OriginISOalpha3=="KOR"),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB23_GDP21",
                            color_var="PlaceOfManufactureText20",
                            facet_var="IsFMS",
                            # second_var="StateRegion",
                            # labels_and_colors=labels_and_colors,
                            column_key=column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Obligations (Constant FY 2020 $s)",
       caption="Source: FPDS; CSIS analysis.")+
    theme(legend.position = "bottom")
    # guides(fill=guide_legend(ncol=2)
)

PlaceOfManufactureText20
```



#Vendor Count
## Defense Count
```{r EntityCount}

ec<-read.delim(file.path("../Data/semi_clean/Vendor_sp_EntityCountHistoryCustomer.txt"), header=TRUE,  na.strings = c("", "NULL"))
ec<-remove_bom(ec)
ec<-standardize_variable_names(ec)
ec$dFYear<-as.Date(paste("1/1/",as.character(ec$Fiscal_Year),sep=""),"%m/%d/%Y")


ec<-csis360::read_and_join(ec,
  "EntitySizeCode.csv",
  by="EntitySizeCode",
  add_var="EntitySmall",
  path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
  dir="vendor/"
)

# def_eid_fyear<-read.delim(file.path("../Data/semi_clean/Defense_Vendor.SP_EntityIDhistory.txt"), header=TRUE,  na.strings = c("", "NULL"))
# def_eid_fyear<-remove_bom(def_eid_fyear)
# def_eid_fyear$EntityCount<-1
# def_eid_fyear<-standardize_variable_names(def_eid_fyear)
# def_eid_fyear$dFYear<-as.Date(paste("1/1/",as.character(def_eid_fyear$Fiscal_Year),sep=""),"%m/%d/%Y")

# eid_lc<-prepare_labels_and_colors(ec,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
ec<-replace_nas_with_unlabeled(ec,"EntitySmall","Unlabeled Vendor")
ec<-replace_nas_with_unlabeled(ec,"EntitySizeText","Unlabeled Vendor")

eid_lc<-prepare_labels_and_colors(ec)
  
  (edef<-build_plot(ec %>% filter(Fiscal_Year>=2005 & Customer=="Defense"),
             chart_geom = "Line Chart",
             x_var="dFYear",
             y_var="EntityCount",
             color_var="IsEntityAbove2018constant10ThousandThreshold",
             # labels_and_colors = eid_lc,
             format=TRUE)+labs(x="Fiscal Year",y="Vendor Count")
  )
  summary(factor(ec$EntitySmall))
  summary(ec$EntitySmall)
  (edef<-build_plot(ec %>% filter(Fiscal_Year>=2005 & Customer=="Defense"&
                                    IsEntityAbove2018constant10ThousandThreshold==1),
             chart_geom = "Line Chart",
             x_var="dFYear",
             y_var="EntityCount",
             color_var="EntitySmall",
             labels_and_colors = eid_lc,
             format=TRUE)+labs(x="Fiscal Year",y="Vendor Count")
  )
  
  
  (edefbar<-build_plot(ec %>% filter(Fiscal_Year>=2005 & Customer=="Defense"&
                                    IsEntityAbove2018constant10ThousandThreshold==1),
             chart_geom = "Bar Chart",
             x_var="dFYear",
             y_var="EntityCount",
             color_var="EntitySmall",
             labels_and_colors = eid_lc,
             format=TRUE)+labs(x="Fiscal Year",y="Vendor Count")+
      scale_x_date(#date_breaks="3 years",
                   breaks = c(as.Date("2005/1/1"),
                                   as.Date("2008/1/1"),
                              as.Date("2011/1/1"),
                              as.Date("2014/1/1"),
                              as.Date("2017/1/1"),
                                   as.Date("2020/1/1")),date_labels = "'%y")
      #coord_cartesian(xlim=c(as.Date("2004/10/1"),as.Date("2020/9/30")))
  )
  
  # 
  # (edef<-build_plot(def_eid_fyear %>% filter(Fiscal_Year>=2005),
  #            chart_geom = "Line Chart",
  #            x_var="dFYear",
  #            y_var="EntityCount",
  #            # color_var="Small",
  #            labels_and_colors = eid_lc,
  #            format=TRUE)+labs(x="Fiscal Year",y="Vendor Count")
  # )
  ggsave600dpi(file.path("..","Output","def_entity_count_bar.png"), edefbar+ theme(legend.position = "right"),#guides(fill = guide_legend(nrow = 2)), 
               width=6.5, height= 3, units="in",size=11,lineheight = 0.75
               )
  
  ggsave600dpi(file.path("..","Output","def_entity_count_bar.svg"), edefbar+ theme(legend.position = "right"),#guides(fill = guide_legend(nrow = 2)), 
               width=6.5, height= 3, units="in",size=11,lineheight = 0.75
               )
  # ggsave600dpi(file.path("..","Output","def_entity_count.png"), edef, 
  #              width=6.5, height= 4, units="in",size=11,lineheight = 0.75
  #              )
  
  
    write.csv(file=file.path("..","Output","def_entity_count.csv"),row.names = FALSE, na = "",
              edefbar$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
                pivot_wider(id_cols=c(EntitySmall),
                            names_from=Fiscal_Year,values_from=EntityCount)%>% arrange(EntitySmall))
  
  ec$thresh<-factor(ec$IsEntityAbove2016constantOneMillionThreshold,
                     levels=c(0,1), labels=c("Vendor only receives smaller contracts","Vendor receives contracts over $1 million in 2016 $"))
  (eplat<-build_plot(ec %>% filter(Fiscal_Year>=2005 &
                                      IsEntityAbove2018constant10ThousandThreshold==1&
                                     Customer=="Defense"),
             chart_geom = "Bar Chart",
             x_var="dFYear",
             y_var="EntityCount",
             color_var="thresh",
             # second_var="",
             # labels_and_colors = eid_lc,
             format=TRUE)+labs(x="Fiscal Year",y="Vendor Count")
  )+labs(color="Vendor receives over $1 million threshold in 2016 $s")
  
  (build_plot(ec %>% filter(Fiscal_Year>=2005 &
                                      IsEntityAbove2018constant10ThousandThreshold==1&
                                     Customer=="Defense"),
             chart_geom = "Bar Chart",
             x_var="dFYear",
             y_var="Action_Obligation",
             color_var="EntitySizeText",
             facet_var="IsEntityAbove2016constantOneMillionThreshold",
             labels_and_colors = eid_lc,
             format=TRUE)+labs(x="Fiscal Year",y="Vendor Count")
  )#+facet_wrap(~PlatformPortfolio,scale="free_y")
  
  (build_plot(ec %>% filter(Fiscal_Year>=2005 &
                                      IsEntityAbove2018constant10ThousandThreshold==1&
                                     Customer=="Defense"),
             chart_geom = "Bar Chart",
             x_var="dFYear",
             y_var="Action_Obligation",
             color_var="EntitySizeText",
             facet_var="IsEntityAbove2016constantOneMillionThreshold",
             labels_and_colors = eid_lc,
             share=TRUE,
             format=TRUE)+labs(x="Fiscal Year",y="Vendor Count")
  )#+facet_wrap(~PlatformPortfolio,scale="free_y")
  
  
  ec %>% filter() %>% group_by(IsEntityAbove2016constantOneMillionThreshold,Fiscal_Year) %>%
            dplyr::summarise(act=sum(Action_Obligation))%>%group_by(Fiscal_Year)%>%mutate(act=act/sum(act))
  
  
  
```
## Platform
```{r PlatEntityCount}

ecp<-read.delim(file.path("../Data/semi_clean/Defense_Vendor_sp_EntityCountHistoryPlatformCustomer.txt"), header=TRUE,  na.strings = c("", "NULL"))
ecp<-remove_bom(ecp)
ecp<-standardize_variable_names(ecp)
ecp$dFYear<-as.Date(paste("1/1/",as.character(ecp$Fiscal_Year),sep=""),"%m/%d/%Y")



ecp<-csis360::read_and_join(ecp,
  "EntitySizeCode.csv",
  by="EntitySizeCode",
  add_var="EntitySmall",
  path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
  dir="vendor/"
)
def_eid_fyear_plat<-read.delim(file.path("../Data/semi_clean/Defense_Vendor.SP_EntityIDhistoryPlatform.txt"), header=TRUE,  na.strings = c("", "NULL"))
def_eid_fyear_plat<-remove_bom(def_eid_fyear_plat)
def_eid_fyear_plat<-standardize_variable_names(def_eid_fyear_plat)
def_eid_fyear_plat$EntityCount<-1
def_eid_fyear_plat$dFYear<-as.Date(paste("1/1/",as.character(def_eid_fyear_plat$Fiscal_Year),sep=""),"%m/%d/%Y")

ecp_lc<-prepare_labels_and_colors(ecp)
# ecp_lc<-prepare_labels_and_colors(ecp,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
ecp$EntitySizeText<-factor(ecp$EntitySizeText)






ecp$thresh<-factor(ecp$IsEntityAbove2016constantOneMillionThreshold,
                   levels=c(0,1), labels=c("Vendor only receives smaller contracts","Vendor receives contracts over $1 million in 2016 $"))
(eplat<-build_plot(ecp %>% filter(Fiscal_Year>=2005 &
                                    IsEntityAbove2018constant10ThousandThreshold==1),
           chart_geom = "Bar Chart",
           x_var="dFYear",
           y_var="EntityCount",
           color_var="thresh",
           facet_var="PlatformPortfolio",
           # second_var="",
           # labels_and_colors = ecp_lc,
           format=TRUE)+labs(x="Fiscal Year",y="Vendor Count")
)+labs(color="Vendor receives over $1 million threshold in 2016 $s")
(eplatbar<-build_plot(ecp %>% filter(Fiscal_Year>=2005 &
                                    IsEntityAbove2018constant10ThousandThreshold==1),
           chart_geom = "Bar Chart",
           x_var="dFYear",
           y_var="EntityCount",
           color_var="EntitySmall",
           facet_var="PlatformPortfolio",
           # second_var="",
           labels_and_colors = ecp_lc,
           format=TRUE)+labs(x="Fiscal Year",y="Vendor Count")
)+facet_wrap(~PlatformPortfolio,scale="free_y")

(eplatbar<-build_plot(ecp %>% filter(Fiscal_Year>=2005 &
                                    IsEntityAbove2018constant10ThousandThreshold==1),
           chart_geom = "Bar Chart",
           x_var="dFYear",
           y_var="EntityCount",
           color_var="EntitySmall",
           facet_var="PlatformPortfolio",
           # second_var="",
           labels_and_colors = ecp_lc,
           format=TRUE)+labs(x="Fiscal Year",y="Vendor Count")
)+facet_wrap(~PlatformPortfolio,ncol=6)+scale_x_date("Fiscal Year",labels = date_format("'%y"),date_breaks = "3 years")

(eplatline<-build_plot(ecp %>% filter(Fiscal_Year>=2005 &
                                    IsEntityAbove2018constant10ThousandThreshold==1),
           chart_geom = "Line Chart",
           x_var="dFYear",
           y_var="EntityCount",
           # color_var="PlatformPortfolio",
           facet_var="PlatformPortfolio",
           # second_var="",
           labels_and_colors = ecp_lc,
           format=TRUE)+labs(x="Fiscal Year",y="Vendor Count")+
    facet_wrap(~PlatformPortfolio,ncol=6)+scale_x_date("Fiscal Year",labels = date_format("'%y"),date_breaks = "3 years")
)

write.csv(file=file.path("..","Output","def_entity_count_plat.csv"),row.names = FALSE, na = "",
          eplatline$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlatformPortfolio),
                        names_from=Fiscal_Year,values_from=EntityCount))

ggsave600dpi(file=file.path("..","Output","def_entity_count_plat_line.png"), eplatline, 
             width=6.5, height= 4, units="in",size=9,lineheight = 0.75
             )

(eplat<-build_plot(ecp %>% filter(Fiscal_Year>=2005 &
                                    IsEntityAbove2018constant10ThousandThreshold==1),
           chart_geom = "Bar Chart",
           x_var="dFYear",
           y_var="Action_Obligation",
           color_var="EntitySizeText",
           facet_var="IsEntityAbove2016constantOneMillionThreshold",
           second_var="PlatformPortfolio",
           # labels_and_colors = ecp_lc,
           format=TRUE)+labs(x="Fiscal Year",y="Vendor Count")
)#+facet_wrap(~PlatformPortfolio,scale="free_y")



ecp %>% group_by(IsEntityAbove2016constantOneMillionThreshold,Fiscal_Year) %>%
          dplyr::summarise(act=sum(Action_Obligation))%>%group_by(Fiscal_Year)%>%mutate(act=act/sum(act))

(eplat<-build_plot(def_eid_fyear_plat %>% dplyr::filter(Fiscal_Year>=2005),
           chart_geom = "Line Chart",
           x_var="dFYear",
           y_var="EntityCount",
           facet_var="PlatformPortfolio",
           # color_var="PlatformPortfolio",
           labels_and_colors = eid_lc,
           format=TRUE)+facet_wrap(~PlatformPortfolio)+labs(x="Fiscal Year",y="Vendor Count")
)
ggsave600dpi(file.path("..","Output","def_entity_count_plat.png"), eplat, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )



```

## SubCustomer
```{r SubCustEntityCount}

ecsub<-read.delim(file.path("../Data/semi_clean/Vendor_sp_EntityCountHistorySubCustomer.txt"), header=TRUE,  na.strings = c("", "NULL"))
ecsub<-remove_bom(ecsub)
ecsub<-standardize_variable_names(ecsub)
ecsub$dFYear<-as.Date(paste("1/1/",as.character(ecsub$Fiscal_Year),sep=""),"%m/%d/%Y")



ecsub<-csis360::read_and_join(ecsub,
  "EntitySizeCode.csv",
  by="EntitySizeCode",
  add_var="EntitySmall",
  path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
  dir="vendor/"
)

eid_lc<-prepare_labels_and_colors(def_eid_fyear_plat)


(esub<-build_plot(ecsub  %>% filter(Fiscal_Year>=2005 & IsEntityAbove2018constant10ThousandThreshold==1),
           chart_geom = "Line Chart",
           x_var="dFYear",
           y_var="EntityCount",
           facet_var="SubCustomer",
           color_var="EntitySmall",
           labels_and_colors = ecp_lc,
           format=TRUE)+labs(x="Fiscal Year",y="Vendor Count")
)+facet_wrap(~SubCustomer,scale="free_y")


ggsave600dpi(file.path("..","Output","def_entity_count_plat.png"), eplat, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )


write.csv(file=file.path("..","Output","def_entity_count_subcust.csv"),row.names = FALSE, na = "",
          esub$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(SubCustomer,EntitySmall),
                        names_from=Fiscal_Year,values_from=EntityCount))
```



