---
title: "Monopoly Results Summary"
output:
  html_document:
    keep_md: yes
    toc: yes
date: "Wednesday, February 8, 2017"
---

#Setup
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from   FPDS.


```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(arm)
library(R2WinBUGS)
library(knitr)
library(foreign)
library(stargazer)
library(texreg)
library(reshape2)
source("..\\scripts\\DIIGstat.r")

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40

load("..\\data\\clean\\transformed_def.Rdata")
load("..//data//clean//def_sample.Rdata")
memory.limit(56000)
```



## Data Exploration

### Economic
#### NAICS 2

```{r grouped percent frequency/obligation barplot for all NAICS2, 21 in total}
#Prepare data for plot
NAICS2_Freq <- as.data.frame(table(def$NAICS2))
NAICS2_Freq$Percent_Freq <- round(NAICS2_Freq$Freq/sum(NAICS2_Freq$Freq),4)*100
colnames(NAICS2_Freq) <- c("NAICS_Code", "Count_Freq", "Percent_Freq")

#Get detail description for NAICS2 code
NAICS2_Freq<-read_and_join_experiment(NAICS2_Freq,
                                           lookup_file = "Lookup_PrincipalNAICScode.csv",
                                      path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                                      dir="economic\\",
                                      by=c("NAICS_Code"="principalnaicscode"),
                                      add_var = "principalnaicscodeText"
                                      )

Percent_Obli <- c()
Total_Obli <- sum(def$Action_Obligation_Then_Year, na.rm = TRUE)
for (i in NAICS2_Freq$NAICS_Code) {
  Percent_Obligation <- round(sum(def$Action_Obligation_Then_Year[def$NAICS2 == i], na.rm = TRUE)/Total_Obli,5)
  Percent_Obli <- c(Percent_Obli, Percent_Obligation)
}

NAICS2_Freq$Percent_Obli <- Percent_Obli * 100
NAICS2_Freq <- NAICS2_Freq[order(-NAICS2_Freq$Percent_Obli),]
NAICS2_Freq[,c(1,3)] <- lapply(NAICS2_Freq[,c(1,3)], function(x) as.character(x))
NAICS2_Freq$principalnaicscodeText <- paste(NAICS2_Freq$NAICS_Code, " - ", NAICS2_Freq$principalnaicscodeText)
NAICS2_Freq$principalnaicscodeText <- factor(NAICS2_Freq$principalnaicscodeText, levels = rev(NAICS2_Freq$principalnaicscodeText))
NAICS2_Freq <- melt(NAICS2_Freq, id = c("NAICS_Code", "Count_Freq","principalnaicscodeText"))
NAICS2_Freq$value <- as.numeric(NAICS2_Freq$value)

NAICS2_barplot <- ggplot(data = NAICS2_Freq,
                          aes(x = principalnaicscodeText, 
                              y = value,
                              fill = factor(variable))) +
                   geom_bar(stat = "identity", 
                            position = "dodge", 
                            width = 0.8) + 
                   coord_flip() +
                   xlab("") + 
                   ylab("") + 
                   theme_grey() + 
                   scale_fill_grey(labels = c("% records", "% obligation"),
                                  guide = guide_legend(reverse = TRUE)) + 
                   ggtitle("Percent of Frequency and obligation for NAICS2") +
                   theme(text = element_text(size = 10), 
                         legend.title = element_blank(),
                         legend.position = "bottom",
                         legend.margin = margin(t=-0.8, r=0, b=0.5, l=0, unit = "cm"),
                         legend.text = element_text(margin = margin(r=0.5, unit = "cm")),
                         plot.margin = margin(t=0.3, r=0.5, b=0, l=0.5, unit = "cm"))
NAICS2_barplot
```

#### NAICS 3

```{r NAICS3_Summary, fig.width=7.5 , fig.height=3}
NAICS_summary<-def %>% group_by(NAICS3,StartCY,def3_HHI_lag1,def3_obl_lag1,def3_ratio_lag1,US3_avg_sal_lag1) %>%
  dplyr::summarise(annual_action_obligation=sum(Action_Obligation_Then_Year),
                   annual_count=length(StartCY)) 

top_NAICS <- NAICS_summary %>% group_by(NAICS3) %>% 
  dplyr::summarise(naics_action_obligation=sum(annual_action_obligation),
                   naics_count=sum(annual_count)) 
top_NAICS$naics_dollar_rank<-rank(-top_NAICS$naics_action_obligation)
top_NAICS$naics_count_rank<-rank(-top_NAICS$naics_count)

#If statement there to prevent adding it a second time in  reruns.
if(!"naics_dollar_rank" %in% colnames(NAICS_summary))
  NAICS_summary<-left_join(NAICS_summary,top_NAICS, by="NAICS3")




NAICS_summary<-as.data.frame(NAICS_summary)
NAICS_summary$NAICS3<-as.character(NAICS_summary$NAICS3)
NAICS_summary<-read_and_join_experiment(NAICS_summary,
                                      lookup_file = "Lookup_PrincipalNAICScode.csv",
                                      path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                                      dir="economic\\",
                                      by=c("NAICS3"="principalnaicscode"),
                                      skip_check_var=c("principalnaicscodeText",
                                                       "NAICS_shorthand",
                                                       "principalNAICS4DigitCode")
                                      )

# https://stackoverflow.com/questions/37174316/how-to-fit-long-text-into-ggplot2-facet-titles



# Helper function for string wrapping. 
#  20 character target width.
swr <- function(string, nwrap=20) {
  paste(strwrap(string, width=nwrap), collapse="\n")
}
swr <- Vectorize(swr)
summary(NAICS_summary$NAICS_shorthand)

# View(NAICS_summary)
NAICS_summary$NAICS_shorthand<-swr(NAICS_summary$NAICS_shorthand,nwrap = 25)
NAICS_summary$CY<-NAICS_summary$StartCY-1
NAICS3top<-ggplot(subset(NAICS_summary,naics_dollar_rank<=4 |
                          naics_count_rank<=4),
       aes(x=CY,y=def3_HHI_lag1))+#color=NAICS_Code
  geom_line()+
  scale_y_continuous(label=scales::comma)+ 
  # scale_x_continuous(breaks=c(2006,2009,2011,2014))+
  labs(x="Calendar Year",y="Herfindahl-Herschman Index")+ 
  geom_hline(yintercept=c(1500,2500),linetype="dotted")

NAICS3top_paper<-NAICS3top+ facet_wrap(~NAICS_shorthand,ncol=2)
ggsave(NAICS3top_paper,file="..//Output\\NAICS3top.png",width=4,height=8,dpi=600)
ggsave(NAICS3top_paper,file="..//Output\\NAICS3top.eps",width=4,height=8,dpi=600)

NAICS3top_pp<-NAICS3top+ facet_wrap(~NAICS_shorthand,ncol=4)
NAICS3top_pp
ggsave(NAICS3top_pp,file="..//Output\\NAICS3top_pp.png",width=10.5,height=5.5,dpi=600)
ggsave(NAICS3top_pp,file="..//Output\\NAICS3top_pp.eps",width=10.5,height=5.5,dpi=600)

summary(NAICS_summary$naics_count_rank)


NAICS_summary$NAICS_shorthand<-swr(NAICS_summary$NAICS_shorthand,nwrap = 16)
# NAICS_summary$CY<-factor(paste("'",substring(as.character(NAICS_summary$CY),3,4),sep=""))

NAICS3top8<-ggplot(subset(NAICS_summary,naics_dollar_rank<=8),
       aes(x=CY,y=def3_HHI_lag1))+#color=NAICS_Code
  geom_line()+
  scale_y_continuous(label=scales::comma)+ 
  scale_x_continuous(breaks=c(2007,2012))+
  labs(x="Calendar Year",y="Herfindahl-Herschman Index")+ 
  geom_hline(yintercept=c(1500,2500),linetype="dotted")

NAICS3top8_wide<-NAICS3top8+ facet_grid(.~NAICS_shorthand)
ggsave(NAICS3top8_wide,file="..//Output\\NAICS3top8.png",width=9.5,height=4,dpi=600)
ggsave(NAICS3top8_wide,file="..//Output\\NAICS3top8.eps",width=9.5,height=4,dpi=600)

colnames(NAICS_summary)
NAICS_long<-NAICS_summary[,colnames(NAICS_summary) %in% c( "NAICS3",
                                                    "def3_HHI_lag1",
                                                    "def3_obl_lag1",
                                                    "def3_ratio_lag1",
                                                    # "US3_avg_sal_lag1",
                                                    "naics_dollar_rank" ,
                                                    "naics_count_rank",
                                                    "principalnaicscodeText",
                                                     "NAICS_shorthand",
                                                    "CY")]
NAICS_long<-melt(NAICS_long, id=c("NAICS3","naics_dollar_rank","naics_count_rank","principalnaicscodeText","CY", "NAICS_shorthand"))



#Drop the ratios and average salaries w/ unique values
# NAICS_long<-NAICS_long[NAICS_long$variable %in% c(),]


levels(NAICS_long$variable)<- list("Herfindahl-\nHerschman Index"=c("def3_HHI_lag1"),
                                   "Defense Obligations"=c("def3_obl_lag1"),
                                   "Defense Obligations\nto U.S. Revenue Ratio"=c("def3_ratio_lag1"))

NAICS_long$high<-2500
NAICS_long$high[NAICS_long$variable!="Herfindahl-\nHerschman Index"]<-NA
NAICS_long$low<-1500
NAICS_long$low[NAICS_long$variable!="Herfindahl-\nHerschman Index"]<-NA

(
NAICS3long_wide<-ggplot(subset(NAICS_long,naics_dollar_rank<=8),
       aes(x=CY,y=value))+#color=NAICS_Code
  geom_line()+
  scale_y_continuous(label=scales::comma)+ 
  scale_x_continuous(breaks=c(2007,2012))+
  labs(x="Calendar Year",y="Detailed Industry Metric")+
  geom_hline(aes(
           yintercept=high),linetype="dotted")+
  geom_hline(aes(
           yintercept=low),linetype="dotted") + 
  facet_grid(variable~NAICS_shorthand,scales="free_y")   
)

ggsave(NAICS3long_wide,file="..//Output\\NAICS3long.png",width=9.5,height=5.5,dpi=600)
ggsave(NAICS3long_wide,file="..//Output\\NAICS3long.eps",width=9.5,height=5.5,dpi=600)

write.csv(NAICS_summary,file="..//Output/NAICS3_summary.csv",row.names = FALSE)
```







#### NAICS 6



```{r NAICS6_Summary, fig.width=7.5 , fig.height=3}
NAICS_summary<-def %>% group_by(NAICS,StartCY,def6_HHI_lag1,def6_obl_lag1,def6_ratio_lag1,US6_avg_sal_lag1) %>%
  dplyr::summarise(annual_action_obligation=sum(Action_Obligation_Then_Year),
                   annual_count=length(StartCY)) 

top_NAICS <- NAICS_summary %>% group_by(NAICS) %>% 
  dplyr::summarise(naics_action_obligation=sum(annual_action_obligation),
                   naics_count=sum(annual_count)) 
top_NAICS$naics_dollar_rank<-rank(-top_NAICS$naics_action_obligation)
top_NAICS$naics_count_rank<-rank(-top_NAICS$naics_count)


NAICS_summary<-left_join(NAICS_summary,top_NAICS, by="NAICS")

colnames(NAICS_summary)[colnames(NAICS_summary)=="NAICS"]<-"principalnaicscode"

NAICS_summary$principalnaicscode<-as.character(NAICS_summary$principalnaicscode)
NAICS_summary<-as.data.frame(NAICS_summary)

NAICS_summary<-read_and_join(NAICS_summary,
                        lookup_file = "Lookup_PrincipalNAICScode.csv",
                        path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                                      dir="economic\\",
                        by="principalnaicscode",
                        skip_check_var=c("principalnaicscodeText",
                                         "NAICS_shorthand")
               )




summary(NAICS_summary$NAICS_shorthand)

# View(NAICS_summary)
NAICS_summary$NAICS_shorthand<-swr(NAICS_summary$NAICS_shorthand,nwrap = 25)
NAICS_summary$CY<-NAICS_summary$StartCY-1
NAICS6top<-ggplot(subset(NAICS_summary,naics_dollar_rank<=4 |
                          naics_count_rank<=4),
       aes(x=CY,y=def6_HHI_lag1))+#color=NAICS_Code
  geom_line()+
  scale_y_continuous(label=scales::comma)+ 
  # scale_x_continuous(breaks=c(2006,2009,2011,2014))+
  labs(x="Calendar Year",y="Herfindahl-Herschman Index")+ 
  geom_hline(yintercept=c(1500,2500),linetype="dotted")

(NAICS6top_paper<-NAICS6top+ facet_wrap(~NAICS_shorthand,ncol=2))
ggsave(NAICS6top_paper,file="..//Output\\NAICS6top.png",width=4,height=8,dpi=600)
ggsave(NAICS6top_paper,file="..//Output\\NAICS6top.eps",width=4,height=8,dpi=600)

(NAICS6top_pp<-NAICS6top+ facet_wrap(~NAICS_shorthand,ncol=4))
ggsave(NAICS6top_pp,file="..//Output\\NAICS6top_pp.png",width=10.5,height=5.5,dpi=600)
ggsave(NAICS6top_pp,file="..//Output\\NAICS6top_pp.eps",width=10.5,height=5.5,dpi=600)

summary(NAICS_summary$naics_count_rank)


NAICS_summary$NAICS_shorthand<-swr(NAICS_summary$NAICS_shorthand,nwrap = 16)
# NAICS_summary$CY<-factor(paste("'",substring(as.character(NAICS_summary$CY),3,4),sep=""))

NAICS6top8<-ggplot(subset(NAICS_summary,naics_dollar_rank<=8),
       aes(x=CY,y=def6_HHI_lag1))+#color=NAICS_Code
  geom_line()+
  scale_y_continuous(label=scales::comma)+ 
  scale_x_continuous(breaks=c(2007,2012))+
  labs(x="Calendar Year",y="Herfindahl-Herschman Index")+ 
  geom_hline(yintercept=c(1500,2500),linetype="dotted")

NAICS6top8_wide<-NAICS6top8+ facet_grid(.~NAICS_shorthand)
ggsave(NAICS6top8_wide,file="..//Output\\NAICS6top8.png",width=9.5,height=4,dpi=600)
ggsave(NAICS6top8_wide,file="..//Output\\NAICS6top8.eps",width=9.5,height=4,dpi=600)


colnames(NAICS_summary)
NAICS_long<-NAICS_summary[,colnames(NAICS_summary) %in% c( "principalnaicscode",
                                                    "def6_HHI_lag1",
                                                    "def6_obl_lag1",
                                                    "def6_ratio_lag1",
                                                    # "US6_avg_sal_lag1",
                                                    "naics_dollar_rank" ,
                                                    "naics_count_rank",
                                                    "principalnaicscodeText",
                                                     "NAICS_shorthand",
                                                    "CY")]
NAICS_long<-melt(NAICS_long, id=c("principalnaicscode","naics_dollar_rank","naics_count_rank","principalnaicscodeText","CY", "NAICS_shorthand"))



#Drop the ratios and average salaries w/ unique values
# NAICS_long<-NAICS_long[NAICS_long$variable %in% c(),]


levels(NAICS_long$variable)<- list("Herfindahl-\nHerschman Index"=c("def6_HHI_lag1"),
                                   "Defense Obligations"=c("def6_obl_lag1"),
                                   "Defense Obligations\nto U.S. Revenue Ratio"=c("def6_ratio_lag1"))

NAICS_long$high<-2500
NAICS_long$high[NAICS_long$variable!="Herfindahl-\nHerschman Index"]<-NA
NAICS_long$low<-1500
NAICS_long$low[NAICS_long$variable!="Herfindahl-\nHerschman Index"]<-NA

(

NAICS6long_wide<-ggplot(subset(NAICS_long,naics_dollar_rank<=8),
       aes(x=CY,y=value))+#color=NAICS_Code
  geom_line()+
  scale_y_continuous(label=scales::comma)+ 
  scale_x_continuous(breaks=c(2007,2012))+
  labs(x="Calendar Year",y="Detailed Industry Metric")+
  geom_hline(aes(
           yintercept=high),linetype="dotted")+
  geom_hline(aes(
           yintercept=low),linetype="dotted")    + 
    facet_grid(variable~NAICS_shorthand,scales="free_y")

)

ggsave(NAICS6long_wide,file="..//Output\\NAICS6long.png",width=9.5,height=5.5,dpi=600)
ggsave(NAICS6long_wide,file="..//Output\\NAICS6long.eps",width=9.5,height=5.5,dpi=600)

write.csv(NAICS_summary,file="..//Output/NAICS6_summary.csv",row.names = FALSE)
```






### Office
```{r grouped percent frequency/obligation barplot for all Office}
#grouped bar plot for variable Office
#Perpare data for plot
Office_Freq <- def %>% group_by(Agency, Office) %>%
  dplyr::summarise(
    Count_Freq=length(CSIScontractID),
    Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE)
  )

Office_Freq$Percent_Obligation <- Office_Freq$Action_Obligation_Then_Year/
                                          sum(Office_Freq$Action_Obligation_Then_Year,na.rm=TRUE)

Office_Freq$Percent_Freq <- Office_Freq$Count_Freq/
                                          sum(Office_Freq$Count_Freq,na.rm=TRUE)

#get the detailed desceription for Office by AgencyID and OfficeID

Office_Freq<-read_and_join_experiment(Office_Freq,
                                      lookup_file = "Office.ContractingOfficeCode.txt",
                                      path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                                      dir="office/",
                                      by=c("Agency"="AgencyID",
                                       "Office"="ContractingOfficeCode"   
                                      ),
                                      add_var = "ContractingOfficeName",
                                      skip_check_var = "ContractingOfficeName")


colnames(Office_Freq)[colnames(Office_Freq)=="ContractingOfficeName"] <- "OfficeName"

# Office_Freq[,1:2] <- lapply(Office_Freq[,1:2], function(x) as.character(x))
#Generate a new name column by Combining Office and officeName
Office_Freq$Office_Full <- ifelse(is.na(Office_Freq$OfficeName), Office_Freq$Office, 
                                  paste(Office_Freq$Office, 
                                            sep=" - ", Office_Freq$OfficeName))


# Office_Freq$Percent_Obli <- Percent_Obli * 100

Office_Freq_top10Freq <- Office_Freq[order(-Office_Freq$Percent_Freq),]
Office_Freq_top10Freq <- Office_Freq_top10Freq[1:10, ]  #including NULL category
Office_Freq_top10Obli <- Office_Freq[order(-Office_Freq$Percent_Obligation),]
Office_Freq_top10Obli <- Office_Freq_top10Obli[1:10, ]  #including NULL category

Office_Freq_TOP <- rbind(Office_Freq_top10Obli, Office_Freq_top10Freq)
Office_Freq_TOP <- unique(Office_Freq_TOP)  #17 records in total

Office_Freq_TOP$Office_Full <- factor(Office_Freq_TOP$Office_Full, 
                                      levels = rev(Office_Freq_TOP$Office_Full))
Office_Freq_TOP <- melt(Office_Freq_TOP, 
                        id = c("Agency","Office", "OfficeName", "Office_Full", "Count_Freq", "Action_Obligation_Then_Year"))

Office_barplot <- ggplot(data = Office_Freq_TOP,
                         aes(x = Office_Full, 
                             y = value,
                             fill = factor(variable))) +
                  geom_bar(stat = "identity", 
                  position = "dodge", 
                  width = 0.8) + 
                  coord_flip() +
                  xlab("") + 
                  ylab("") + 
                  theme_grey() + 
                  scale_fill_grey(labels = c("% of records", "% of obligation"),
                                  guide = guide_legend(reverse = TRUE)) + 
                  ggtitle("Percent of Frequency and obligation for Office") +
                  theme(text = element_text(size = 10), 
                        legend.title = element_blank(),
                        legend.position = "bottom",
                        legend.margin = margin(t=-0.8, r=0, b=0.5, l=0, unit = "cm"),
                        legend.text = element_text(margin = margin(r=0.5, unit = "cm")), 
                        plot.margin = margin(t=0.3, r=0.5, b=0, l=0.5, unit = "cm"))
Office_barplot
```


### Platform Portfolio
```{r Platform, fig.width=6.5 , fig.height=3.25}

library(readr)
annual_platform_summary<-read_csv(file="..//Output//annual_platform_summary.csv")
colnames(annual_platform_summary)[colnames(annual_platform_summary)=="platformPortfolio"]<-"PlatformPortfolio"

platform_no_na<-subset(annual_platform_summary,!is.na(PlatformPortfolio))
labels_and_colors<-csis360::prepare_labels_and_colors(platform_no_na,"PlatformPortfolio")



platform_no_na$plat_short <-swr(platform_no_na$PlatformPortfolio,nwrap = 21)
platform_no_na<-subset(platform_no_na,Fiscal.Year>=2000 & Fiscal.Year<=2017)

 

# plat<-ggplot(platform_no_na,
#        aes(x=Fiscal.Year,y=hh_index))+#color=NAICS_Code
#   geom_line()+
#   scale_y_continuous(label=scales::comma)+ 
#   # scale_x_continuous(breaks=c(2006,2009,2011,2014))+
#   labs(x="Fiscal Year",y="Herfindahl-Herschman Index")+ 
#   geom_hline(yintercept=c(1500,2500),linetype="dotted")+
#   facet_wrap(~plat_short)
# add_preassigned_scales(plat,labels_and_colors = labels_and_colors)

# str(platform_no_na)
# summary(platform_no_na$Fiscal.Year)
#
# undebug(add_preassigned_scales)
plat<-build_plot(
  data=platform_no_na,
  chart_geom = "Line Chart",
  share = FALSE,
  x_var="Fiscal.Year",
  y_var="hh_index", #Name of variable to plot on y-axis
  color_var="PlatformPortfolio",       # name of coloration variable, as string
  facet_var="PlatformPortfolio",        # name of facet variable, as string
  legend=FALSE, #Include a legend
  caption=FALSE, #Include a source caption
  labels_and_colors=labels_and_colors,
  column_key=NULL
)


# add_preassigned_scales(plat, labels_and_colors,  var="PlatformPortfolio"

plat<-plat+geom_hline(yintercept=c(1500,2500),linetype="dotted")+
  labs(x="Fiscal Year",y="Herfindahl-Herschman Indetx")
plat
ggsave(plat+geom_line(aes(x=Fiscal.Year,y=hh_index,color=PlatformPortfolio),size=1),filename="..//Output//platform_hhi.png",height=3.25, width=6.5)
ggsave(plat+geom_line(aes(x=Fiscal.Year,y=hh_index)),filename="..//Output//platform_hhi_bw.png",height=3.25, width=6.5)
ggsave(plat+geom_line(aes(x=Fiscal.Year,y=hh_index,color=PlatformPortfolio),size=1),filename="..//Output//platform_hhi.eps",height=3.25, width=6.5)
ggsave(plat+geom_line(aes(x=Fiscal.Year,y=hh_index)),filename="..//Output//platform_hhi_bw.eps",height=3.25, width=6.5)

```

### Variable examination
```{r VarGraph}


HH1plot<-freq_continuous_plot(def,"def6_HHI_lag1",bins=50)
HH1plot<-HH1plot+geom_vline(xintercept=c(1500,2500))+labs(x="Annual Herfindahl-Hirschman Index (HHI) for NAICS-6 Sector",y="Contract or Task Order Count")
HH1plot
ggsave(HH1plot,file="..//Output//HH1freq.png",width=5.5,height=5.5,dpi=600)
ggsave(HH1plot,file="..//Output//HH1freq.eps",width=5.5,height=5.5,dpi=600)

sum(def$Action_Obligation_Then_Year[def$EffComp=="No Comp."],na.rm=TRUE)/sum(def$Action_Obligation_Then_Year,na.rm=TRUE)
sum(def$Action_Obligation_Then_Year[def$EffComp=="1 Offer"],na.rm=TRUE)/sum(def$Action_Obligation_Then_Year,na.rm=TRUE)
sum(def$Action_Obligation_Then_Year[def$EffComp=="2+ Offers"],na.rm=TRUE)/sum(def$Action_Obligation_Then_Year,na.rm=TRUE)
nrow(def[def$EffComp=="No Comp.",])/nrow(def)

sum(def$Action_Obligation_Then_Year[is.na(def$EffComp)],na.rm=TRUE)/sum(def$Action_Obligation_Then_Year,na.rm=TRUE)


# Effplot<-freq_discrete_plot(subset(def,"EffComp"))
# Effplot<-Effplot+labs(x="Effective Competition",y="Contract or Task Order Count")
# ggsave(Effplot,file="..//Output//EffFreq.png",width=5.5,height=5.5,dpi=600)

```




# Loading Models
## Output: Offers

### Consolidation and Number of Offers

```{r Comp-Cons}
load("..//Output//Comp_Cons_15D.rdata")


if(!exists("Comp_Cons_15D")){
   
     Comp_Cons_15D <- lmer (data=smp,
                         l_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                         # cl_US3_avg_sal_lag1+
                         cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                         cl_US6_avg_sal_lag1 + 
                         cl_Ceil_Then_Year+cl_Days+
                         Veh+
                         PricingFee+UCA+
                         b_Intl+
                         b_UCA:cl_def6_HHI_lag1 +
                         # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                         # cl_def6_HHI_lag1:cl_def6_obl_lag1+
                         b_Intl:Veh+
                         # cl_Ceil_Then_Year:PricingFee+
                         # cl_US6_avg_sal_lag1:PricingFee+
                         # b_UCA:cl_Days+
                         # b_UCA:cl_Ceil_Then_Year+
                         (1 | NAICS3/NAICS) + (1 | Agency/Office) + (1 | StartCY),
                         verbose=1)

  # save(Comp_Cons_15D,file="..//Output//Comp_Cons_15D.rdata")
  
   Comp_Cons_15D_1m <- lmer (data=smp1m,
                         l_Offr ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                         # cl_US3_avg_sal_lag1+
                         cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+
                         cl_US6_avg_sal_lag1 + 
                         cl_Ceil_Then_Year+cl_Days+
                         Veh+
                         PricingFee+UCA+
                         b_Intl+
                         b_UCA:cl_def6_HHI_lag1 +
                         # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                         # cl_def6_HHI_lag1:cl_def6_obl_lag1+
                         b_Intl:Veh+
                         # cl_Ceil_Then_Year:PricingFee+
                         # cl_US6_avg_sal_lag1:PricingFee+
                         # b_UCA:cl_Days+
                         # b_UCA:cl_Ceil_Then_Year+
                         (1 | NAICS3/NAICS) + (1 | Agency/Office) + (1 | StartCY),
                         verbose=1)
   save(Comp_Cons_15D,Comp_Cons_15D_1m,file="..//Output//Comp_Cons_15D.rdata")

}

stargazer::stargazer(Comp_Cons_15D,Comp_Cons_15D_1m,type="text",
                       digits=2)

#Considering 
write.csv(exp(summary(Comp_Cons_15D_1m)$coefficients[,1])-1,file="..//Output/exp_Comp_Cons_15D_1m.csv")
# Comp_Cons_15D_exp<-log_analysis(Comp_Cons_15D)

glmer_examine(Comp_Cons_15D,display=TRUE)
get_icc(Comp_Cons_15D)
```
No failure to converge.

## Output: Ceiling Breach
### Consolidation and Ceiling Breaches

```{r CBre-Cons}

# load("..//Output//CBre_Cons_13B.rdata") Missing
load("..//Output//CBre_Cons_13B_1m.rdata")

if(!exists("CBre_Cons_13B_1m")){
  CBre_Cons_13B_1m <- glmer (data=smp1m,
                          b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                            #cl_US3_avg_sal_lag1+
                            cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                            cl_US6_avg_sal_lag1+
                            cl_Ceil_Then_Year + cl_Days+ 
                            Veh +
                            PricingFee + b_UCA +
                            b_Intl+
                            
                            b_UCA:cl_def6_HHI_lag1 + 
                            b_UCA:cl_Ceil_Then_Year+
                            cl_def6_HHI_lag1:cl_def6_obl_lag1+
                            
                            (1 | NAICS3/NAICS) + 
                            (1 | Agency/Office), 
                          
                          family=binomial(link="logit"),
                          verbose=1)
  save(CBre_Cons_13B_1m,#CBre_Cons_13B,CBre_Cons_13B.restart,
       file="..//Output//CBre_Cons_13B_1m.rdata")
}

# if(!exists("CBre_Cons_13B_1m_restart")){
#   pars<-get_pars(CBre_Cons_13B_1m)
#   CBre_Cons_13B_1m_restart <- update(CBre_Cons_13B_1m, 
#                                      start=pars,
#                                      verbose=1)
#   save(CBre_Cons_13B,
#        CBre_Cons_13B.restart,
#        CBre_Cons_13B_1m,
#        CBre_Cons_13B_1m_restart,
#        file="..//Output//CBre_Cons_13B.rdata")
# }
# glmer_examine(CBre_Cons_13B_1m_restart)




# save(CBre_Cons_13B,
#      CBre_Cons_13B.devfun,
#      CBre_Cons_13_scgrad,
#      CBre_Cons_13B.restart,
#      CBre_Comp_13B,
#      CBre_Comp_13B.devfun,
#      CBre_Comp_13B.restart,
#      file="..//Output//CBre_Cons_13B.rdata")

# source(system.file("utils", "allFit.R", package="lme4"))
# CBre_Cons_13B.all <- allFit(CBre_Cons_13B)
# CBre_Cons_13B_ss_cons <- summary(CBre_Cons_13B.all)





vif(CBre_Cons_13B_1m)
stargazer::stargazer(CBre_Cons_13B_1m,type="text", #CBre_Cons_13B
                       digits=2)

glmer_examine(CBre_Cons_13B_1m,display=TRUE)


```
"Model failed to converge with max|grad| = 0.00750942 (tol = 0.001, component 1)"


### Competition and Ceiling Breach
```{r CBre-Comp}
load(file="..//Output//CBre_Comp_13C.rdata")

glmer_examine(CBre_Comp_13C)


## Not Done
if(!exists("CBre_Comp_13C")){
  CBre_Comp_13C <- glmer (data=smp,
                          b_CBre ~CompOffr+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                            cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                            cl_Ceil_Then_Year + cl_Days+
                            Veh  +
                            PricingFee+
                            b_UCA +
                            b_Intl+
                            
                            b_UCA:CompOffr +
                            b_UCA:cl_Ceil_Then_Year+
                            
                            (1 | NAICS3/NAICS) + (1 | Agency/Office),
                          family=binomial(link="logit"),
                          verbose=1)
  
   CBre_Comp_13C_1m <- glmer (data=smp1m,
                          b_CBre ~CompOffr+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                            cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                            cl_Ceil_Then_Year + cl_Days+
                            Veh  +
                            PricingFee+
                            b_UCA +
                            b_Intl+
                            
                            b_UCA:CompOffr +
                            b_UCA:cl_Ceil_Then_Year+
                            
                            (1 | NAICS3/NAICS) + (1 | Agency/Office),
                          family=binomial(link="logit"),
                          verbose=1)
  
  save(CBre_Comp_13C,CBre_Comp_13C_1m,file="..//Output//CBre_Comp_13C.rdata")
  stargazer::stargazer(CBre_Comp_13C,CBre_Comp_13C_1m,type="text",
                       digits=2)
}

glmer_examine(CBre_Comp_13C,display=TRUE)
glmer_examine(CBre_Comp_13C_1m,display=TRUE)


```
"Model failed to converge with max|grad| = 0.0209168 (tol = 0.001, component 1)"
No restart yet.
### Both and Ceiling Breach
```{r CBre-Both}
load("..//Output//CBre_Cons_Comp_15A.rdata")

stargazer::stargazer(CBre_Cons_Comp_15A,type="text",
                       digits=2)
if(!exists("CBre_Cons_Comp_15A")){
  CBre_Cons_Comp_15A <- glmer (data=smp,
                               b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                                 #cl_US3_avg_sal_lag1+
                                 cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                                 cl_US6_avg_sal_lag1+
                                 CompOffr+
                                   cl_Ceil_Then_Year + cl_Days+ 
                                 Veh +
                                 PricingFee + b_UCA +
                                 b_Intl+
                                 
                                 
                                 
                                 b_UCA:CompOffr +
                                 b_UCA:cl_def6_HHI_lag1 + 
                                 b_UCA:cl_Ceil_Then_Year+
                                 cl_def6_HHI_lag1:cl_def6_obl_lag1+
                                 
                                 (1 | NAICS3/NAICS) + 
                                 (1 | Agency/Office) ,
                               family=binomial(link="logit"),
                               verbose=1)
  
  CBre_Cons_Comp_15A_1m <- glmer (data=smp1m,
                               b_CBre ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                                 #cl_US3_avg_sal_lag1+
                                 cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                                 cl_US6_avg_sal_lag1+
                                 CompOffr+
                                 cl_Ceil_Then_Year + cl_Days+ 
                                 Veh +
                                 PricingFee + b_UCA +
                                 b_Intl+
                                 
                                 
                                 
                                 b_UCA:CompOffr +
                                 b_UCA:cl_def6_HHI_lag1 + 
                                 b_UCA:cl_Ceil_Then_Year+
                                 cl_def6_HHI_lag1:cl_def6_obl_lag1+
                                 
                                 (1 | NAICS3/NAICS) + 
                                 (1 | Agency/Office) ,
                               family=binomial(link="logit"),
                               verbose=1)
  
  save(CBre_Cons_Comp_15A,CBre_Cons_Comp_15A_1m,file="..//Output//CBre_Cons_Comp_15A.rdata")
}


# source(system.file("utils", "allFit.R", package="lme4"))
# CBre_Cons_Comp_15A_1m.all <- allFit(CBre_Cons_Comp_15A_1m)
# CBre_Cons_Comp_15A_1m_ss_cons <- summary(CBre_Cons_Comp_15A_1m.all)


glmer_examine(CBre_Cons_Comp_15A,display=TRUE)
CBre_Cons_Comp_15A_odds_ratio<-odds_ratio(CBre_Cons_Comp_15A,"CBre_Cons_Comp_15A",walds = TRUE)
get_icc(CBre_Cons_Comp_15A)
```
[1] "Model failed to converge with max|grad| = 0.0395392 (tol = 0.001, component 1)"

failure to converge in 10000 evaluationsModel failed to converge with max|grad| = 0.00901903 (tol = 0.001, component 1)

## Output Size Of Breach

### Organially Developed
```{r Model5A}
if(file.exists("..//Output//ln_CBre_15A.rdata")) load(file="..//Output//ln_CBre_15A.rdata")

if(!exists("ln_CBre_Cons_15A"))
  ln_CBre_Cons_15A <- lmer (data=def_breach,
                            ln_CBre_Then_Year ~cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                              cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                              cl_Ceil_Then_Year+ cl_Days+
                              Veh+
                              PricingFee+b_UCA+
                              b_Intl +
                              b_UCA:cl_def6_HHI_lag1+
                              cl_US6_avg_sal_lag1:PricingFee+
                              (1 | NAICS3/NAICS) + 
                              (1 | Agency/Office),
                            verbose=TRUE)
glmer_examine(ln_CBre_Cons_15A)


if(!exists("ln_CBre_Comp_15A"))
  ln_CBre_Comp_15A <- lmer (data=def_breach,
                            ln_CBre_Then_Year ~CompOffr+
                              cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                              cl_def3_ratio_lag1+
                              cl_Ceil_Then_Year+ cl_Days+
                              Veh+
                              PricingFee+b_UCA+
                              b_Intl +
                              b_UCA:CompOffr+
                              cl_US6_avg_sal_lag1:PricingFee+
                              (1 | NAICS3/NAICS) + 
                              (1 | Agency/Office),
                              verbose=TRUE)
glmer_examine(ln_CBre_Comp_15A)

if(!exists("ln_CBre_Cons_Comp_15A"))
  ln_CBre_Cons_Comp_15A <- lmer (data=def_breach,
                                 ln_CBre_Then_Year ~CompOffr+cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                                   cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                                   cl_Ceil_Then_Year+ cl_Days+
                                   Veh+
                                   PricingFee+b_UCA+
                                   b_Intl +
                                   b_UCA:CompOffr+
                                   b_UCA:cl_def6_HHI_lag1+
                                   cl_US6_avg_sal_lag1:PricingFee+
                                   (1 | NAICS3/NAICS) + 
                                   (1 | Agency/Office),
                                 verbose=TRUE)
glmer_examine(ln_CBre_Cons_Comp_15A)

```

### Logit Match
Second model, exactly matching the model used in ceiling breach logit.

```{r Model15B}
if(file.exists("..//Output//ln_CBre_15B.rdata")) load(file="..//Output//ln_CBre_15B.rdata")

if(!exists("ln_CBre_Cons_15B"))
  ln_CBre_Cons_15B <- lmer (data=def_breach,
                            ln_CBre_Then_Year ~cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                              cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                              cl_Ceil_Then_Year+ cl_Days+
                              Veh+
                              PricingFee+b_UCA+
                              b_Intl +
                              b_UCA:cl_def6_HHI_lag1+
                              b_UCA:cl_Ceil_Then_Year+
                              cl_def6_HHI_lag1:cl_def6_obl_lag1+
                              (1 | NAICS3/NAICS) + 
                              (1 | Agency/Office),
                            verbose=TRUE)
glmer_examine(ln_CBre_Cons_15B)


if(!exists("ln_CBre_Comp_15B"))
  ln_CBre_Comp_15B <- lmer (data=def_breach,
                            ln_CBre_Then_Year ~CompOffr+
                              cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                              cl_def3_ratio_lag1+
                              cl_Ceil_Then_Year+ cl_Days+
                              Veh+
                              PricingFee+b_UCA+
                              b_Intl +
                              b_UCA:CompOffr+
                              b_UCA:cl_Ceil_Then_Year+
                              (1 | NAICS3/NAICS) + 
                              (1 | Agency/Office),
                              verbose=TRUE)
glmer_examine(ln_CBre_Comp_15B)

if(!exists("ln_CBre_Cons_Comp_15B"))
  ln_CBre_Cons_Comp_15B <- lmer (data=def_breach,
                                 ln_CBre_Then_Year ~CompOffr+cl_def6_HHI_lag1+cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                                   cl_def3_HHI_lag1+cl_def3_ratio_lag1+
                                   cl_Ceil_Then_Year+ cl_Days+
                                   Veh+
                                   PricingFee+b_UCA+
                                   b_Intl +
                                   b_UCA:CompOffr+
                                   b_UCA:cl_def6_HHI_lag1+
                                   b_UCA:cl_Ceil_Then_Year+
                                   cl_def6_HHI_lag1:cl_def6_obl_lag1+
                                   (1 | NAICS3/NAICS) + 
                                   (1 | Agency/Office),
                                 verbose=TRUE)
glmer_examine(ln_CBre_Cons_Comp_15B)


stargazer::stargazer(ln_CBre_Cons_15B,ln_CBre_Comp_15B,ln_CBre_Cons_Comp_15B,type="text",
                       digits=2)


# save(ln_CBre_Cons_15B,ln_CBre_Comp_15B,ln_CBre_Cons_Comp_15B,file="..//Output//ln_CBre_15B.rdata")```
```


## Output: Termination

### Consolidation and Termination

```{r Term-Cons}
load("..//Output//Term_Cons_13E.rdata")


if(!exists("Term_Cons_13E_1m")){
  
  Term_Cons_13F <- glmer (data=smp,
                          b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                            #cl_US3_avg_sal_lag1+
                            cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                            cl_US6_avg_sal_lag1+
                            cl_Ceil_Then_Year + cl_Days+ 
                            Veh +
                            PricingFee + b_UCA +
                            b_Intl+
                            
                            # b_UCA:cl_def6_HHI_lag1 + 
                            b_UCA:cl_Ceil_Then_Year+
                            cl_def6_HHI_lag1:cl_def6_obl_lag1+
                            
                               cl_def3_HHI_lag1:cl_def3_ratio_lag1+  
                            (1 | NAICS3/NAICS) + 
                            (1 | Agency/Office), 
                          family=binomial(link="logit"),
                          verbose=1)
  
  
  # save(Term_Cons_13E,file="..//Output//Term_Cons_13E.rdata")
  
   
    Term_Cons_13F_1m <- glmer (data=smp1m,
                          b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                            #cl_US3_avg_sal_lag1+
                            cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                            cl_US6_avg_sal_lag1+
                            cl_Ceil_Then_Year + cl_Days+ 
                            Veh +
                            PricingFee + b_UCA +
                            b_Intl+
                            
                            # b_UCA:cl_def6_HHI_lag1 + 
                            b_UCA:cl_Ceil_Then_Year+
                            cl_def6_HHI_lag1:cl_def6_obl_lag1+
                            
                               cl_def3_HHI_lag1:cl_def3_ratio_lag1+  
                            (1 | NAICS3/NAICS) + 
                            (1 | Agency/Office), 
                          family=binomial(link="logit"),
                          verbose=1)
    
    save(Term_Cons_13E,Term_Cons_13E_1m,file="..//Output//Term_Cons_13E.rdata")
  
}


glmer_examine(Term_Cons_13E_1m,display=TRUE)
odds_ratio(Term_Cons_13E_1m,"Term_Cons_13E",walds = TRUE)

```

"Model failed to converge with max|grad| = 0.0498057 (tol = 0.001, component 1)"

### Competition and Terminations

```{r Term-Comp}
load(file="..//Output//Term_Comp_13F.rdata")

if(!exists("Term_Comp_13F_1m")){
  Term_Comp_13F <- glmer (data=smp,
                          b_Term ~CompOffr+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                            cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                            cl_Ceil_Then_Year + cl_Days+
                            Veh  +
                            PricingFee+
                            b_UCA +
                            b_Intl+
                            
                            # b_UCA:CompOffr +
                            b_UCA:cl_Ceil_Then_Year+
                            
                            (1 | NAICS3/NAICS) + (1 | Agency/Office),
                          family=binomial(link="logit"),
                          verbose=1)
  
  
summary(Term_Comp_13E_1m)
  
  
    Term_Comp_13F_1m <- glmer (data=smp1m,
                          b_Term ~CompOffr+cl_def3_ratio_lag1+#cl_US3_avg_sal_lag1+#cl_def3_obl_lag1+
                            cl_def6_ratio_lag1+cl_def6_obl_lag1+cl_US6_avg_sal_lag1+
                            cl_Ceil_Then_Year + cl_Days+
                            Veh  +
                            PricingFee+
                            b_UCA +
                            b_Intl+
                            
                            # b_UCA:CompOffr +
                            b_UCA:cl_Ceil_Then_Year+
                            
                            (1 | NAICS3/NAICS) + (1 | Agency/Office),
                          family=binomial(link="logit"),
                          verbose=1)
  
  Term_Comp_13F<-Term_Comp_13E2
  save(Term_Comp_13F,Term_Comp_13F_1m,file="..//Output//Term_Comp_13F.rdata")
}
stargazer::stargazer(Term_Comp_13F_1m,type="text",
                       digits=2)
glmer_examine(Term_Comp_13F_1m,display=TRUE)
odds_ratio(Term_Comp_13F_1m,"Term_Comp_13F_1m",walds = TRUE)
```

[1] "Model failed to converge with max|grad| = 0.046442 (tol = 0.001, component 1)"


### Both and Terminations

```{r Both-Term}
load(file="..//Output//Term_Cons_Comp_14C.rdata") 
load(file="..//Output//Term_Cons_Comp_14B_1m.rdata") 
stargazer(Term_Cons_Comp_14C_1m,type="text",
                         digits=2)

if(!exists("Term_Cons_Comp_14C_1m")){
  # Term_Cons_Comp_14C <- glmer (data=smp,
  #                              b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
  #                                #cl_US3_avg_sal_lag1+
  #                                cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
  #                                cl_US6_avg_sal_lag1+
  #                                CompOffr+
  #                                cl_Ceil_Then_Year + cl_Days+ 
  #                                Veh +
  #                                PricingFee + b_UCA +
  #                                b_Intl+
  #                                
  #                                # cl_def6_HHI_lag1:cl_Days+
  #                                b_UCA:cl_Ceil_Then_Year+
  #                                # b_UCA:cl_def6_HHI_lag1 +
  #                                # PricingFee:cl_US6_avg_sal_lag1+
  #                                cl_def6_HHI_lag1:cl_def6_obl_lag1  +
  #                                # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
  #                                cl_def3_HHI_lag1:cl_def3_ratio_lag1+  
  #                                
  #                                (1 | NAICS3/NAICS) + (1 | Agency/Office)
  #                              , family=binomial(link="logit"),verbose=1)
  
  
  Term_Cons_Comp_14C_1m <- glmer (data=smp1m,
                                  b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                                    #cl_US3_avg_sal_lag1+
                                    cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                                    cl_US6_avg_sal_lag1+
                                    CompOffr+
                                    cl_Ceil_Then_Year + cl_Days+ 
                                    Veh +
                                    PricingFee + b_UCA +
                                    b_Intl+
                                    
                                    # cl_def6_HHI_lag1:cl_Days+
                                    # b_UCA:cl_Ceil_Then_Year+
                                    # b_UCA:cl_def6_HHI_lag1 +
                                    # PricingFee:cl_US6_avg_sal_lag1+
                                    cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                                    # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                                    cl_def3_HHI_lag1:cl_def3_ratio_lag1+  
                                    
                                    (1 | NAICS3/NAICS) + (1 | Agency/Office)
                                  , family=binomial(link="logit"),verbose=1)
  
  
  
  save(Term_Cons_Comp_14B_1m,file="..//Output//Term_Cons_Comp_14B2_1m.rdata")
  source(system.file("utils", "allFit.R", package="lme4"))
  Term_Cons_Comp_14B_1m.all <- allFit(Term_Cons_Comp_14B_1m)
  Term_Cons_Comp_14B_1m_ss_cons <- summary(Term_Cons_Comp_14B_1m.all)
  
  Term_Cons_Comp_14C_1m <- glmer (data=smp1m,
                                  b_Term ~cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+
                                    #cl_US3_avg_sal_lag1+
                                    cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+
                                    cl_US6_avg_sal_lag1+
                                    CompOffr+
                                    cl_Ceil_Then_Year + cl_Days+ 
                                    Veh +
                                    PricingFee + b_UCA +
                                    b_Intl+
                                    
                                    # cl_def6_HHI_lag1:cl_Days+
                                    b_UCA:cl_Ceil_Then_Year+
                                    # b_UCA:cl_def6_HHI_lag1 +
                                    # PricingFee:cl_US6_avg_sal_lag1+
                                    cl_def6_HHI_lag1:cl_def6_obl_lag1  +
                                    # cl_def6_HHI_lag1:cl_def6_ratio_lag1+
                                    cl_def3_HHI_lag1:cl_def3_ratio_lag1+  
                                    
                                    (1 | NAICS3/NAICS) + (1 | Agency/Office)
                                  , family=binomial(link="logit"),verbose=1)
  
  
  
  stargazer::stargazer(Term_Cons_Comp_14B_1m,type="text",
                       digits=2)
  
  # Term_Cons_Comp_14B_1m <- update(Term_Cons_Comp_14B_1m, . ~ . + b_UCA:cl_Ceil_Then_Year - cl_def6_HHI_lag1:cl_Days)
  
  # save(Term_Cons_Comp_14B_1m,Term_Cons_Comp_14B2_1m,file="..//Output//Term_Cons_Comp_14B_1m.rdata")
  
  
  save(Term_Cons_Comp_14C_1m,file="..//Output//Term_Cons_Comp_14C.rdata")
  
}
glmer_examine(Term_Cons_Comp_14C_1m)
odds_ratio(Term_Cons_Comp_14C_1m,"Term_Cons_Comp_14C_1m",walds = TRUE)
get_icc(Term_Cons_Comp_14C_1m)

```
[1] "Model failed to converge with max|grad| = 0.0782055 (tol = 0.001, component 1)"

# Tables for Paper

## Models and Dep Var OR
### Competition Model
```{r Output-Comp}

# texreg::htmlreg(list(Term_Cons_08A3,
#                   CBre_Cons_08C),#CBre_Cons_08B2
#                 file="..//Output//ConsModel.html",single.row = TRUE,
#                 custom.model.name=c("Termination",
#                                     "Ceiling Breach"),
#                         stars=c(0.05))




# texreg::htmlreg(list(Comp_Cons_15D),file="..//Output//Offr_Model.html",
#                 single.row = TRUE,
#                 custom.model.name=c("Concentration"),
#                 stars=c(0.1,0.05,0.01,0.001),
#                 groups = list("Study Variables" = 2:3,
#                               "NAICS Characteristics" =4:7,
#                               "Contract Characteristics"=8:19,
#                               "Interactions" = 20:24),
#                 custom.coef.map=list("(Intercept)"="(Intercept)",
#                                      "cl_def3_HHI_lag1"="Log(Subsector HHI)",
#                                      "cl_def6_HHI_lag1"="Log(Det. Ind. HHI)",
#                                      "CompOffr1 offer"="Comp=1 offer",
#                                      "CompOffr2 offers"="Comp=2 offers",
#                                      "CompOffr3-4 offers"="Comp=3-4 offers",
#                                      "CompOffr5+ offers"="Comp=5+ offers",
#                                      "cl_def3_ratio_lag1"="Log(Subsector Ratio)",
#                                      "cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
#                                      "cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
#                                      "cl_US6_avg_sal_lag1"="Log(Det. Ind. U.S. Avg. Salary)",
#                                      "cl_Ceil"="Log(Init. Ceiling)",
#                                      "cl_Ceil_Then_Year"="Log(Init. Ceiling)",
#                                      "cl_Days"="Log(Init. Days)",
#                                      "VehS-IDC"="Vehicle=S-IDC",
#                                      "VehM-IDC"="Vehicle=M-IDC",
#                                      "VehFSS/GWAC"="Vehicle=FSS/GWAC",
#                                      "VehBPA/BOA"="Vehicle=BPA/BOA",
#                                      "PricingFeeOther FP"="Pricing=Other FP",
#                                      "PricingFeeIncentive"="Pricing=Incentive Fee",
#                                      "PricingFeeCombination or Other"="Pricing=Combination or Other",
#                                      "PricingFeeOther CB"="Pricing=Other CB",
#                                      "PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
#                                      "b_UCA"="UCA",
#                                      "b_Intl"="Performed Abroad",
#                                      # # "cl_def6_HHI_lag1:cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
#                                      # "cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
#                                      # # "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)"),
#                                      "cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
#                                      # "cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
#                                      # "cl_Ceil_Then_Year:b_UCA"="Log(Init. Ceiling):UCA",
#                                      # "CompOffr1 offer:b_UCA"="Comp=1 offer:UCA",
#                                      # "CompOffr2 offers:b_UCA"="Comp=2 offers:UCA",
#                                      # "CompOffr3-4 offers:b_UCA"="Comp=3-4 offers:UCA",
#                                      # "CompOffr5+ offers:b_UCA"="Comp=5+ offers:UCA"
#                                      "VehS-IDC:b_Intl"="Vehicle=S-IDC:Performed Abroad",
#                                      "VehM-IDC:b_Intl"="Vehicle=M-IDC:Performed Abroad",
#                                      "VehFSS/GWAC:b_Intl"="Vehicle=FSS/GWAC:Performed Abroad",
#                                      "VehBPA/BOA:b_Intl"="Vehicle=BPA/BOA:Performed Abroad",
#                                      "cl_US6_avg_sal_lag1:PricingFeeOther FP"="Pricing=Other FP:Log(Det. Ind. U.S. Avg. Salary)",
#                                      "cl_US6_avg_sal_lag1:PricingFeeIncentive"="Pricing=Incentive Fee:Log(Det. Ind. U.S. Avg. Salary)",
#                                      "cl_US6_avg_sal_lag1:PricingFeeCombination or Other"="Pricing=Comb./or Other:Log(Det. Ind. U.S. Avg. Salary)",
#                                      "cl_US6_avg_sal_lag1:PricingFeeOther CB"="Pricing=Other CB:Log(Det. Ind. U.S. Avg. Salary)",
#                                      "cl_US6_avg_sal_lag1:PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE:Log(Det. Ind. U.S. Avg. Salary)"
#                                      
#                 ),
#                 bold=0.05,
#                 custom.note="%stars. Logged inputs are rescaled. For this model, sole source contracts and task orders are treated as having 1 offer.",
#                 caption="Table 1: Regression Model of Log(Number of Offfers)",
#                 caption.above=TRUE)


texreg::htmlreg(list(Comp_Cons_15D_1m),file="..//Output//Offr_Model_1m.html",
                single.row = TRUE,
                custom.model.name=c("Concentration"),
                stars=c(0.1,0.05,0.01,0.001),
                groups = list("Study Variables" = 2:3,
                              "NAICS Characteristics" =4:7,
                              "Contract Characteristics"=8:20,
                              "Interactions" = 21:25),
                custom.coef.map=list("(Intercept)"="(Intercept)",
                                     "cl_def3_HHI_lag1"="Log(Subsector HHI)",
                                     "cl_def6_HHI_lag1"="Log(Det. Ind. HHI)",
                                     "CompOffr1 offer"="Comp=1 offer",
                                     "CompOffr2 offers"="Comp=2 offers",
                                     "CompOffr3-4 offers"="Comp=3-4 offers",
                                     "CompOffr5+ offers"="Comp=5+ offers",
                                     "cl_def3_ratio_lag1"="Log(Subsector Ratio)",
                                     "cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
                                     "cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
                                     "cl_US6_avg_sal_lag1"="Log(Det. Ind. U.S. Avg. Salary)",
                                     "cl_Ceil"="Log(Init. Ceiling)",
                                     "cl_Ceil_Then_Year"="Log(Init. Ceiling)",
                                     "cl_Days"="Log(Init. Days)",
                                     "VehS-IDC"="Vehicle=S-IDC",
                                     "VehM-IDC"="Vehicle=M-IDC",
                                     "VehFSS/GWAC"="Vehicle=FSS/GWAC",
                                     "VehBPA/BOA"="Vehicle=BPA/BOA",
                                     "PricingFeeOther FP"="Pricing=Other FP",
                                     "PricingFeeIncentive"="Pricing=Incentive Fee",
                                     "PricingFeeCombination or Other"="Pricing=Combination or Other",
                                     "PricingFeeOther CB"="Pricing=Other CB",
                                     "PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
                                     "b_UCA"="UCA",
                                     "UCAUCA"="UCA",
                                     "b_Intl"="Performed Abroad",
                                     # # "cl_def6_HHI_lag1:cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
                                     # "cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
                                     # # "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)"),
                                     "cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
                                     # "cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",                                     
                                     # "cl_Ceil_Then_Year:b_UCA"="Log(Init. Ceiling):UCA",
                                     # "CompOffr1 offer:b_UCA"="Comp=1 offer:UCA",
                                     # "CompOffr2 offers:b_UCA"="Comp=2 offers:UCA",
                                     # "CompOffr3-4 offers:b_UCA"="Comp=3-4 offers:UCA",
                                     # "CompOffr5+ offers:b_UCA"="Comp=5+ offers:UCA"
                                     "VehS-IDC:b_Intl"="Vehicle=S-IDC:Performed Abroad",
                                     "VehM-IDC:b_Intl"="Vehicle=M-IDC:Performed Abroad",
                                     "VehFSS/GWAC:b_Intl"="Vehicle=FSS/GWAC:Performed Abroad",
                                     "VehBPA/BOA:b_Intl"="Vehicle=BPA/BOA:Performed Abroad",
                                     "cl_US6_avg_sal_lag1:PricingFeeOther FP"="Pricing=Other FP:Log(Det. Ind. U.S. Avg. Salary)",
                                     "cl_US6_avg_sal_lag1:PricingFeeIncentive"="Pricing=Incentive Fee:Log(Det. Ind. U.S. Avg. Salary)",
                                     "cl_US6_avg_sal_lag1:PricingFeeCombination or Other"="Pricing=Comb./or Other:Log(Det. Ind. U.S. Avg. Salary)",
                                     "cl_US6_avg_sal_lag1:PricingFeeOther CB"="Pricing=Other CB:Log(Det. Ind. U.S. Avg. Salary)",
                                     "cl_US6_avg_sal_lag1:PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE:Log(Det. Ind. U.S. Avg. Salary)"
                                     
                ),
                bold=0.05,
                custom.note="%stars. Logged inputs are rescaled. For this model, sole source contracts and task orders are treated as having 1 offer.",
                caption="Table 1: Regression Model of Log(Number of Offfers)",
                caption.above=TRUE)

get_icc(Comp_Cons_15D_1m)


# OR_m1SD <- exp(fixef(FM_m1SD))
# CI_m1SD <- exp(confint(FM_m1SD,parm="beta_")) 
# 
# OR_p1SD <- exp(fixef(FM_p1SD))
# CI_p1SD <- exp(confint(FM_p1SD,parm="beta_")) 
# 
# OR.CI<-rbind(cbind(OR,CI), cbind(OR_m1SD,CI_m1SD)[3,], cbind(OR_p1SD,CI_p1SD)[3,])
# rownames(OR.CI)<-c(rownames(cbind(OR,CI)), "teacher_fan_c_m1SD", "teacher_fan_c_p1SD")
# OR.CI


# gridExtra::grid.arrange(dotplot(ranef(Comp_Cons_15D, condVar = T), strip = T, scales=list(relation='free'))$Agency,
#                         nrow=1)

```

### Likelihood Ceiling Breach Model
```{r Output-CBre-Likelihood}
stargazer::stargazer(CBre_Cons_13B_1m,CBre_Comp_13C_1m,CBre_Cons_Comp_15A_1m,type="text",
                       digits=2)
# texreg::htmlreg(list(Term_Cons_08A3,
#                   CBre_Cons_08C),#CBre_Cons_08B2
#                 file="..//Output//ConsModel.html",single.row = TRUE,
#                 custom.model.name=c("Termination",
#                                     "Ceiling Breach"),
#                         stars=c(0.05))


# texreg::htmlreg(list(CBre_Cons_13B,CBre_Comp_13C,CBre_Cons_Comp_15A),file="..//Output//CBre_Model.html",single.row = TRUE,
#                 custom.model.name=c("Consolidation",
#                                     "Competition",
#                                     "Both"),
#                         stars=c(0.05,0.01,0.001))


# texreg::htmlreg(list(CBre_Cons_13B.restart,CBre_Comp_13C,CBre_Cons_Comp_15A),file="..//Output//CBre_Model.html",
#                 single.row = TRUE,
#                 custom.model.name=c("Concentration",
#                                     "Competition",
#                                     "Both"),
#                         stars=c(0.1,0.05,0.01,0.001),
#                 groups = list("Study Variables" = 2:7,
#                               "NAICS Characteristics" = 8:11,
#                               "Contract Characteristics"=12:24,
# "Interactions" = 25:31),
#                 custom.coef.map=list("(Intercept)"="(Intercept)",
#                 "cl_def3_HHI_lag1"="Log(Subsector HHI)",
# "cl_def6_HHI_lag1"="Log(Det. Ind. HHI)",
# "CompOffr1 offer"="Comp=1 offer",
# "CompOffr2 offers"="Comp=2 offers",
# "CompOffr3-4 offers"="Comp=3-4 offers",
# "CompOffr5+ offers"="Comp=5+ offers",
# "cl_def3_ratio_lag1"="Log(Subsector Ratio)",
# "cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
# "cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
# "cl_US6_avg_sal_lag1"="Log(Det. Ind. U.S. Avg. Salary)",
# "cl_Ceil"="Log(Init. Ceiling)",
# "cl_Ceil_Then_Year"="Log(Init. Ceiling)",
# "cl_Days"="Log(Init. Days)",
# "VehS-IDC"="Vehicle=S-IDC",
# "VehM-IDC"="Vehicle=M-IDC",
# "VehFSS/GWAC"="Vehicle=FSS/GWAC",
# "VehBPA/BOA"="Vehicle=BPA/BOA",
# "PricingFeeOther FP"="Pricing=Other FP",
# "PricingFeeIncentive"="Pricing=Incentive Fee",
# "PricingFeeCombination or Other"="Pricing=Combination or Other",
# "PricingFeeOther CB"="Pricing=Other CB",
# "PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
# "b_UCA"="UCA",
# "b_Intl"="Performed Abroad",
# # "cl_def6_HHI_lag1:cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
# "cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
# # "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)"),
# "cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
# "cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
# "cl_Ceil_Then_Year:b_UCA"="Log(Init. Ceiling):UCA",
# "CompOffr1 offer:b_UCA"="Comp=1 offer:UCA",
# "CompOffr2 offers:b_UCA"="Comp=2 offers:UCA",
# "CompOffr3-4 offers:b_UCA"="Comp=3-4 offers:UCA",
# "CompOffr5+ offers:b_UCA"="Comp=5+ offers:UCA"
# ),
#                 bold=0.05,
# custom.note="%stars. Logged inputs are rescaled.",
# caption="Table 2: Logit Model Results for Ceiling Breaches",
# caption.above=TRUE)



texreg::htmlreg(list(CBre_Cons_13B_1m,CBre_Comp_13C_1m,CBre_Cons_Comp_15A_1m),file="..//Output//CBre_Model_1m.html",
                single.row = TRUE,
                custom.model.name=c("Concentration",
                                    "Competition",
                                    "Both"),
                        stars=c(0.1,0.05,0.01,0.001),
                groups = list("Study Variables" = 2:7,
                              "NAICS Characteristics" = 8:11,
                              "Contract Characteristics"=12:24,
                              "Interactions" = 25:31),
                custom.coef.map=list("(Intercept)"="(Intercept)",
                "cl_def3_HHI_lag1"="Log(Subsector HHI)",
"cl_def6_HHI_lag1"="Log(Det. Ind. HHI)",
"CompOffr1 offer"="Comp=1 offer",
"CompOffr2 offers"="Comp=2 offers",
"CompOffr3-4 offers"="Comp=3-4 offers",
"CompOffr5+ offers"="Comp=5+ offers",
"cl_def3_ratio_lag1"="Log(Subsector Ratio)",
"cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
"cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
"cl_US6_avg_sal_lag1"="Log(Det. Ind. U.S. Avg. Salary)",
"cl_Ceil"="Log(Init. Ceiling)",
"cl_Ceil_Then_Year"="Log(Init. Ceiling)",
"cl_Days"="Log(Init. Days)",
"VehS-IDC"="Vehicle=S-IDC",
"VehM-IDC"="Vehicle=M-IDC",
"VehFSS/GWAC"="Vehicle=FSS/GWAC",
"VehBPA/BOA"="Vehicle=BPA/BOA",
"PricingFeeOther FP"="Pricing=Other FP",
"PricingFeeIncentive"="Pricing=Incentive Fee",
"PricingFeeCombination or Other"="Pricing=Combination or Other",
"PricingFeeOther CB"="Pricing=Other CB",
"PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
"b_UCA"="UCA",
"b_Intl"="Performed Abroad",
# "cl_def6_HHI_lag1:cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
"cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
# "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)"),
"cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
"cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
"cl_Ceil_Then_Year:b_UCA"="Log(Init. Ceiling):UCA",
"CompOffr1 offer:b_UCA"="Comp=1 offer:UCA",
"CompOffr2 offers:b_UCA"="Comp=2 offers:UCA",
"CompOffr3-4 offers:b_UCA"="Comp=3-4 offers:UCA",
"CompOffr5+ offers:b_UCA"="Comp=5+ offers:UCA"
),
                bold=0.05,
custom.note="%stars. Logged inputs are rescaled.",
caption="Table 2: Logit Model Results for Ceiling Breaches",
caption.above=TRUE)




# or1<-odds_ratio(CBre_Cons_13B.restart,"CBre_Cons_13B","Concentration","Ceiling Breaches",walds = TRUE)
# or2<-odds_ratio(CBre_Comp_13C,"CBre_Comp_13C","Competition","Ceiling Breaches",walds = TRUE)
# or3<-odds_ratio(CBre_Cons_Comp_15A,"CBre_Cons_Comp_15A","Both","Ceiling Breaches",walds = TRUE)
# comp.or<-rbind(or1,or2,or3)

# write.csv(get_study_variables_odds_ratio(comp.or),file="..//Output//ceiling_breach_study_odds_ratio.csv",row.names=FALSE)



or1<-odds_ratio(CBre_Cons_13B_1m,"CBre_Cons_13B_1m","Concentration","Ceiling Breaches",walds = TRUE)
or2<-odds_ratio(CBre_Comp_13C_1m,"CBre_Comp_13C_1m","Competition","Ceiling Breaches",walds = TRUE)
or3<-odds_ratio(CBre_Cons_Comp_15A_1m,"CBre_Cons_Comp_15A_1m","Both","Ceiling Breaches",walds = TRUE)
comp.or<-rbind(or1,or2,or3)

write.csv(get_study_variables_odds_ratio(comp.or),file="..//Output//ceiling_breach_study_odds_ratio_1m.csv",row.names=FALSE)
get_icc(CBre_Cons_Comp_15A_1m)

#https://www.lcampanelli.org/mixed-effects-modeling-lme4/
# gridExtra::grid.arrange(dotplot(ranef(CBre_Cons_13B.restart, condVar = T), strip = T, scales=list(relation='free'))$Agency,
#              dotplot(ranef(CBre_Comp_13C, condVar = T), strip = T, scales=list(relation='free'))$Agency,
#              dotplot(ranef(CBre_Cons_Comp_15A, condVar = T), strip = T, scales=list(relation='free'))$Agency,
#              nrow=1)


```

texreg::htmlreg(list(ln_CBre_Cons_15B,ln_CBre_Comp_15B,ln_CBre_Cons_Comp_15B),file="..//Output//Breach_Contract_Model_15B.html",
                single.row = TRUE)

### Size Ceiling Breach Model
```{r Output-CBre-Likelihood}

stargazer::stargazer(ln_CBre_Cons_15A,ln_CBre_Comp_15A,ln_CBre_Cons_Comp_15A,type="text",
                       digits=2)

stargazer::stargazer(ln_CBre_Cons_15B,ln_CBre_Comp_15B,ln_CBre_Cons_Comp_15B,type="text",
                       digits=2)


texreg::htmlreg(list(ln_CBre_Cons_15A,ln_CBre_Comp_15A,ln_CBre_Cons_Comp_15A),file="..//Output//Breach_Contract_Model_15A.html",
                single.row = TRUE,
                custom.model.name=c("Concentration",
                                    "Competition",
                                    "Both"),
                        stars=c(0.1,0.05,0.01,0.001),
                groups = list("Study Variables" = 2:7,
                              "NAICS Characteristics" = 8:11,
                              "Contract Characteristics"=12:24,
                              "Interactions" = 25:34),
                custom.coef.map=list("(Intercept)"="(Intercept)",
                "cl_def3_HHI_lag1"="Log(Subsector HHI)",
"cl_def6_HHI_lag1"="Log(Det. Ind. HHI)",
"CompOffr1 offer"="Comp=1 offer",
"CompOffr2 offers"="Comp=2 offers",
"CompOffr3-4 offers"="Comp=3-4 offers",
"CompOffr5+ offers"="Comp=5+ offers",
"cl_def3_ratio_lag1"="Log(Subsector Ratio)",
"cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
"cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
"cl_US6_avg_sal_lag1"="Log(Det. Ind. U.S. Avg. Salary)",
"cl_Ceil"="Log(Init. Ceiling)",
"cl_Ceil_Then_Year"="Log(Init. Ceiling)",
"cl_Days"="Log(Init. Days)",
"VehS-IDC"="Vehicle=S-IDC",
"VehM-IDC"="Vehicle=M-IDC",
"VehFSS/GWAC"="Vehicle=FSS/GWAC",
"VehBPA/BOA"="Vehicle=BPA/BOA",
"PricingFeeOther FP"="Pricing=Other FP",
"PricingFeeIncentive"="Pricing=Incentive Fee",
"PricingFeeCombination or Other"="Pricing=Combination or Other",
"PricingFeeOther CB"="Pricing=Other CB",
"PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
"b_UCA"="UCA",
"b_Intl"="Performed Abroad",
# "cl_def6_HHI_lag1:cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
"cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
# "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)"),
"cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
"cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
"cl_Ceil_Then_Year:b_UCA"="Log(Init. Ceiling):UCA",
"CompOffr1 offer:b_UCA"="Comp=1 offer:UCA",
"CompOffr2 offers:b_UCA"="Comp=2 offers:UCA",
"CompOffr3-4 offers:b_UCA"="Comp=3-4 offers:UCA",
"CompOffr5+ offers:b_UCA"="Comp=5+ offers:UCA",
"cl_US6_avg_sal_lag1:PricingFeeOther FP"="Pricing=Other FP:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeIncentive"="Pricing=Incentive Fee:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeCombination or Other"=
"Pricing=Comb./or Other:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeOther CB"="Pricing=Other CB:Log(Det. Ind. U.S. Avg. Salary)",
"cl_US6_avg_sal_lag1:PricingFeeT&M/LH/FPLOE"=
"Pricing=T&M/LH/FP:LoE:Log(Det. Ind. U.S. Avg. Salary)"

),
                bold=0.05,
custom.note="%stars. Logged inputs are rescaled.",
caption="Table 2: Logit Model Results for Ceiling Breaches",
caption.above=TRUE)


texreg::htmlreg(list(ln_CBre_Cons_15B,ln_CBre_Comp_15B,ln_CBre_Cons_Comp_15B),file="..//Output//Breach_Contract_Model_15B.html",
                single.row = TRUE,
                custom.model.name=c("Concentration",
                                    "Competition",
                                    "Both"),
                        stars=c(0.1,0.05,0.01,0.001),
                groups = list("Study Variables" = 2:7,
                              "NAICS Characteristics" = 8:11,
                              "Contract Characteristics"=12:24,
                              "Interactions" = 25:31),
                custom.coef.map=list("(Intercept)"="(Intercept)",
                "cl_def3_HHI_lag1"="Log(Subsector HHI)",
"cl_def6_HHI_lag1"="Log(Det. Ind. HHI)",
"CompOffr1 offer"="Comp=1 offer",
"CompOffr2 offers"="Comp=2 offers",
"CompOffr3-4 offers"="Comp=3-4 offers",
"CompOffr5+ offers"="Comp=5+ offers",
"cl_def3_ratio_lag1"="Log(Subsector Ratio)",
"cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
"cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
"cl_US6_avg_sal_lag1"="Log(Det. Ind. U.S. Avg. Salary)",
"cl_Ceil"="Log(Init. Ceiling)",
"cl_Ceil_Then_Year"="Log(Init. Ceiling)",
"cl_Days"="Log(Init. Days)",
"VehS-IDC"="Vehicle=S-IDC",
"VehM-IDC"="Vehicle=M-IDC",
"VehFSS/GWAC"="Vehicle=FSS/GWAC",
"VehBPA/BOA"="Vehicle=BPA/BOA",
"PricingFeeOther FP"="Pricing=Other FP",
"PricingFeeIncentive"="Pricing=Incentive Fee",
"PricingFeeCombination or Other"="Pricing=Combination or Other",
"PricingFeeOther CB"="Pricing=Other CB",
"PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
"b_UCA"="UCA",
"b_Intl"="Performed Abroad",
# "cl_def6_HHI_lag1:cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
"cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
# "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)"),
"cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
"cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
"cl_Ceil_Then_Year:b_UCA"="Log(Init. Ceiling):UCA",
"CompOffr1 offer:b_UCA"="Comp=1 offer:UCA",
"CompOffr2 offers:b_UCA"="Comp=2 offers:UCA",
"CompOffr3-4 offers:b_UCA"="Comp=3-4 offers:UCA",
"CompOffr5+ offers:b_UCA"="Comp=5+ offers:UCA"
),
                bold=0.05,
custom.note="%stars. Logged inputs are rescaled.",
caption="Table 2: Logit Model Results for Ceiling Breaches",
caption.above=TRUE)



#https://www.lcampanelli.org/mixed-effects-modeling-lme4/
# gridExtra::grid.arrange(dotplot(ranef(CBre_Cons_13B.restart, condVar = T), strip = T, scales=list(relation='free'))$Agency,
#              dotplot(ranef(CBre_Comp_13C, condVar = T), strip = T, scales=list(relation='free'))$Agency,
#              dotplot(ranef(CBre_Cons_Comp_15A, condVar = T), strip = T, scales=list(relation='free'))$Agency,
#              nrow=1)


```

### Terminations Model
```{r Output-Term}

# texreg::htmlreg(list(Term_Cons_08A3,
#                   CBre_Cons_08C),#CBre_Cons_08B2
#                 file="..//Output//ConsModel.html",single.row = TRUE,
#                 custom.model.name=c("Termination",
#                                     "Ceiling Breach"),
#                         stars=c(0.05))



# texreg::htmlreg(list(Term_Cons_13E,Term_Comp_13F,Term_Cons_Comp_14C),file="..//Output//Term_Model.html",
#                 single.row = TRUE,
#                 custom.model.name=c("Concentration",
#                                     "Competition",
#                                     "Both"
#                 ),
#                 stars=c(0.1,0.05,0.01,0.001),
#                 groups = list("Study Variables" = 2:7,
#                               "NAICS Characteristics" = 8:11,
#                               "Contract Characteristics"=12:24,
#                               # "Contract Initial Scope" = 12:13,
#                               # "Contract Vehicle (Baseline=Def. Award" = 14:18,
#                               # "Contract Pricing (Baseline=FFP)" = 19:24,
#                               # "Place of Performance" = 25,
#                               "Interactions" = 25:27),
#                 custom.coef.map=list(
#                   "(Intercept)"="(Intercept)",
#                   
#                   "cl_def3_HHI_lag1"="Log(Subsector HHI)",
#                   "cl_def6_HHI_lag1"="Log(Det. Ind. HHI)",
#                   
#                   "CompOffr1 offer"="Comp=1 offer",
#                   "CompOffr2 offers"="Comp=2 offers",
#                   "CompOffr3-4 offers"="Comp=3-4 offers",
#                   "CompOffr5+ offers"="Comp=5+ offers",
#                   "cl_def3_ratio_lag1"="Log(Subsector Ratio)",
#                   "cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
#                   "cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
#                   "cl_US6_avg_sal_lag1"="Log(Det. Ind. U.S. Avg. Salary)",
#                   "cl_Ceil"="Log(Init. Ceiling)",
#                   "cl_Ceil_Then_Year"="Log(Init. Ceiling)",
#                   "cl_Days"="Log(Init. Days)",
#                   "VehS-IDC"="Vehicle=S-IDC",
#                   "VehM-IDC"="Vehicle=M-IDC",
#                   "VehFSS/GWAC"="Vehicle=FSS/GWAC",
#                   "VehBPA/BOA"="Vehicle=BPA/BOA",
#                   "PricingFeeOther FP"="Pricing=Other FP",
#                   "PricingFeeIncentive"="Pricing=Incentive Fee",
#                   "PricingFeeCombination or Other"="Pricing=Combination or Other",
#                   "PricingFeeOther CB"="Pricing=Other CB",
#                   "PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
#                   "b_UCA"="UCA",
#                   "b_Intl"="Performed Abroad",
#                   "cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
#                   "cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
#                   "cl_Ceil_Then_Year:b_UCA"="Log(Init. Ceiling):UCA",
#                   "cl_def6_HHI_lag1:cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
#                   "cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
#                   "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)",
#                   "cl_def6_HHI_lag1:cl_def6_ratio_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. Ratio)",
#                   "cl_US6_avg_sal_lag1:PricingFeeOther FP"="Pricing=Other FP:Log(Det. Ind. U.S. Avg. Salary)",
#                   "cl_US6_avg_sal_lag1:PricingFeeIncentive"="Pricing=Incentive Fee:Log(Det. Ind. U.S. Avg. Salary)",
#                   "cl_US6_avg_sal_lag1:PricingFeeCombination or Other"=
#                     "Pricing=Comb./or Other:Log(Det. Ind. U.S. Avg. Salary)",
#                   "cl_US6_avg_sal_lag1:PricingFeeOther CB"="Pricing=Other CB:Log(Det. Ind. U.S. Avg. Salary)",
#                   "cl_US6_avg_sal_lag1:PricingFeeT&M/LH/FPLOE"=
#                     "Pricing=T&M/LH/FP:LoE:Log(Det. Ind. U.S. Avg. Salary)"
#                   
#                 ),
#                 bold=0.05,
#                 custom.note="%stars. Logged inputs are rescaled.",
#                 caption="Table 3: Logit Model Results for Terminations",
#                 caption.above=TRUE)

                       #  b_UCA:cl_Ceil_Then_Year+
                       #  b_UCA:cl_def6_HHI_lag1 +
                       # PricingFee:cl_US6_avg_sal_lag1+


# texreg::htmlreg(list(Term_Cons_13E,Term_Comp_13E2,Term_Cons_Comp_14C,Term_Cons_Comp_14C_1m),file="..//Output//Term_Model_1m.html",
#                 single.row = TRUE,
#                 custom.model.name=c("Concentration",
#                                     "Competition",
#                                     "Both",
#                                     "Both 1m"
texreg::htmlreg(list(Term_Cons_13E_1m,Term_Comp_13F_1m,Term_Cons_Comp_14B_1m),file="..//Output//Term_Model_1m.html",
                single.row = TRUE,
                custom.model.name=c("Concentration",
                                    "Competition",
                                    "Both"
                ),
                stars=c(0.1,0.05,0.01,0.001),
                groups = list("Study Variables" = 2:7,
                              "NAICS Characteristics" = 8:11,
                              "Contract Characteristics"=12:24,
                              # "Contract Initial Scope" = 12:13,
                              # "Contract Vehicle (Baseline=Def. Award" = 14:18,
                              # "Contract Pricing (Baseline=FFP)" = 19:24,
                              # "Place of Performance" = 25,
                              "Interactions" = 25:27),
                custom.coef.map=list(
                  "(Intercept)"="(Intercept)",
                  
                  "cl_def3_HHI_lag1"="Log(Subsector HHI)",
                  "cl_def6_HHI_lag1"="Log(Det. Ind. HHI)",
                  
                  "CompOffr1 offer"="Comp=1 offer",
                  "CompOffr2 offers"="Comp=2 offers",
                  "CompOffr3-4 offers"="Comp=3-4 offers",
                  "CompOffr5+ offers"="Comp=5+ offers",
                  "cl_def3_ratio_lag1"="Log(Subsector Ratio)",
                  "cl_def6_obl_lag1"="Log(Det. Ind. DoD Obl.)",
                  "cl_def6_ratio_lag1"="Log(Det. Ind. Ratio)",
                  "cl_US6_avg_sal_lag1"="Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_Ceil"="Log(Init. Ceiling)",
                  "cl_Ceil_Then_Year"="Log(Init. Ceiling)",
                  "cl_Days"="Log(Init. Days)",
                  "VehS-IDC"="Vehicle=S-IDC",
                  "VehM-IDC"="Vehicle=M-IDC",
                  "VehFSS/GWAC"="Vehicle=FSS/GWAC",
                  "VehBPA/BOA"="Vehicle=BPA/BOA",
                  "PricingFeeOther FP"="Pricing=Other FP",
                  "PricingFeeIncentive"="Pricing=Incentive Fee",
                  "PricingFeeCombination or Other"="Pricing=Combination or Other",
                  "PricingFeeOther CB"="Pricing=Other CB",
                  "PricingFeeT&M/LH/FPLOE"="Pricing=T&M/LH/FP:LoE",
                  "b_UCA"="UCA",
                  "b_Intl"="Performed Abroad",
                  "cl_def6_HHI_lag1:b_UCA"="Log(Det. Ind. HHI):UCA",
                  "cl_Ceil:b_UCA"="Log(Init. Ceiling):UCA",
                  "cl_Ceil_Then_Year:b_UCA"="Log(Init. Ceiling):UCA",
                  "cl_def6_HHI_lag1:cl_Days"="Log(Det. Ind. HHI):Log(Init. Days)",
                  "cl_def6_HHI_lag1:cl_def6_obl_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. DoD Obl.)",
                  "cl_def3_HHI_lag1:cl_def3_ratio_lag1"="Log(Subsector HHI):Log(Subsector Ratio)",
                  "cl_def6_HHI_lag1:cl_def6_ratio_lag1"="Log(Det. Ind. HHI):Log(Det. Ind. Ratio)",
                  "cl_US6_avg_sal_lag1:PricingFeeOther FP"="Pricing=Other FP:Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_US6_avg_sal_lag1:PricingFeeIncentive"="Pricing=Incentive Fee:Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_US6_avg_sal_lag1:PricingFeeCombination or Other"=
                    "Pricing=Comb./or Other:Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_US6_avg_sal_lag1:PricingFeeOther CB"="Pricing=Other CB:Log(Det. Ind. U.S. Avg. Salary)",
                  "cl_US6_avg_sal_lag1:PricingFeeT&M/LH/FPLOE"=
                    "Pricing=T&M/LH/FP:LoE:Log(Det. Ind. U.S. Avg. Salary)"
                  
                ),
                bold=0.05,
                custom.note="%stars. Logged inputs are rescaled.",
                caption="Table 3: Logit Model Results for Terminations",
                caption.above=TRUE)

                       #  b_UCA:cl_Ceil_Then_Year+
                       #  b_UCA:cl_def6_HHI_lag1 +
                       # PricingFee:cl_US6_avg_sal_lag1+


# gridExtra::grid.arrange(dotplot(ranef(Term_Cons_13E, condVar = T), strip = T, scales=list(relation='free'))$Agency,
#              dotplot(ranef(Term_Comp_13E2, condVar = T), strip = T, scales=list(relation='free'))$Agency,
#              dotplot(ranef(Term_Cons_Comp_14A, condVar = T), strip = T, scales=list(relation='free'))$Agency,
#              nrow=1)
# dotplot(ranef(Term_Cons_13E, condVar = T), strip = T, scales=list(relation='free'))$NAICS3


# or1<-odds_ratio(Term_Cons_13E,"Term_Cons_13E","Concentration","Ceiling Breaches",walds = TRUE)
# or2<-odds_ratio(Term_Comp_13E2,"Term_Comp_13E2","Competition","Ceiling Breaches",walds = TRUE)
# or3<-odds_ratio(Term_Cons_Comp_14C,"Term_Cons_Comp_14C","Both","Ceiling Breaches",walds = TRUE)
# term.or<-rbind(or1,or2,or3)

# write.csv(get_study_variables_odds_ratio(term.or),file="..//Output//termination_study_odds_ratio.csv",row.names=FALSE)

or1<-odds_ratio(Term_Cons_13E_1m,"Term_Cons_13E_1m","Concentration","Ceiling Breaches",walds = TRUE)
or2<-odds_ratio(Term_Comp_13F_1m,"Term_Comp_13F_1m","Competition","Ceiling Breaches",walds = TRUE)
or3<-odds_ratio(Term_Cons_Comp_14C_1m,"Term_Cons_Comp_14C_1m","Both","Ceiling Breaches",walds = TRUE)
term.or<-rbind(or1,or2,or3)

write.csv(get_study_variables_odds_ratio(term.or),file="..//Output//termination_study_odds_ratio_1m.csv",row.names=FALSE)


```
## Odds Ratios by Hypothesis
### Consolidation Odds Ratios

```{r Consolidation}
# or_ceil<-odds_ratio(CBre_Cons_Comp_15A,"CBre_Cons_Comp_15A","Both","Ceiling Breaches",walds = TRUE)
# or_term<-odds_ratio(Term_Cons_Comp_14B,"Term_Cons_Comp_14B","Both","Terminations",walds = TRUE)
# 
# cons.or<-rbind(or_ceil,or_term)
# 
# write.csv(get_study_variables_odds_ratio(subset(cons.or,variable %in% c("cl_def3_HHI_lag1","cl_def6_HHI_lag1"))),
#           file="..//Output//consolidation_odds_ratio.csv",row.names=FALSE)


or_ceil<-odds_ratio(CBre_Cons_Comp_15A_1m,"CBre_Cons_Comp_15A_1m","Both","Ceiling Breaches",walds = TRUE)
or_term<-odds_ratio(Term_Cons_Comp_14C_1m,"Term_Cons_Comp_14C_1m","Both","Terminations",walds = TRUE)

cons.or<-rbind(or_ceil,or_term)

write.csv(get_study_variables_odds_ratio(subset(cons.or,variable %in% c("cl_def3_HHI_lag1","cl_def6_HHI_lag1"))),
          file="..//Output//consolidation_odds_ratio_1m.csv",row.names=FALSE)


# centered_description(smp1m$def6_HHI_lag1,"subsector HHI score")
# centered_log_description(smp1m$l_def6_HHI_lag1,"detailed industrial HHI score")
# 
# 
# centered_description(smp1m$def3_HHI_lag1,"subsector HHI score")
# centered_log_description(smp1m$l_def3_HHI_lag1,"detailed industrial HHI score")





```


### Competition Odds Ratios
```{r Consolidation}
# or_ceil<-odds_ratio(CBre_Cons_Comp_15A,"CBre_Cons_Comp_15A","Both","Ceiling Breaches",walds = TRUE)
# or_term<-odds_ratio(Term_Cons_Comp_14B,"Term_Cons_Comp_14B","Both","Terminations",walds = TRUE)
# 
# cons.or<-rbind(or_ceil,or_term)
# 
# write.csv(get_study_variables_odds_ratio(subset(cons.or,variable %in% c("cl_def3_HHI_lag1","cl_def6_HHI_lag1"))),
#           file="..//Output//consolidation_odds_ratio.csv",row.names=FALSE)


or_ceil<-odds_ratio(CBre_Cons_Comp_15A_1m,"CBre_Cons_Comp_15A_1m","Competition","Ceiling Breaches",walds = TRUE)
or_term<-odds_ratio(Term_Cons_Comp_14C_1m,"Term_Cons_Comp_14C_1m","Competition","Terminations",walds = TRUE)

cons.or<-rbind(or_ceil,or_term)

write.csv(get_study_variables_odds_ratio(subset(cons.or,variable %in% c("CompOffr1 offer",
                                                                        "CompOffr2 offers",
                                                                        "CompOffr3-4 offers",
                                                                        "CompOffr5+ offers"))),
          file="..//Output//competition_odds_ratio_1m.csv",row.names=FALSE)


# centered_description(smp1m$def6_HHI_lag1,"subsector HHI score")
# centered_log_description(smp1m$l_def6_HHI_lag1,"detailed industrial HHI score")
# 
# 
# centered_description(smp1m$def3_HHI_lag1,"subsector HHI score")
# centered_log_description(smp1m$l_def3_HHI_lag1,"detailed industrial HHI score")





```

### Both Odds Ratios
```{r Both}

# or_ceil<-odds_ratio(CBre_Cons_Comp_15A,"CBre_Cons_Comp_15A","Both","Ceiling Breaches",walds = TRUE)
# or_term<-odds_ratio(Term_Cons_Comp_14B,"CBre_Cons_Comp_15A","Both","Terminations",walds = TRUE)
# 
# comp.or<-rbind(or_ceil,or_term)
# 
# write.csv(get_study_variables_odds_ratio(subset(comp.or,!variable %in% c("cl_def3_HHI_lag1","cl_def6_HHI_lag1")),walds = TRUE),
#           file="..//Output//competition_odds_ratio.csv",row.names=FALSE)



or_ceil<-odds_ratio(CBre_Cons_Comp_15A_1m,"CBre_Cons_Comp_15A_1m","Both","Ceiling Breaches",walds = TRUE)
or_term<-odds_ratio(Term_Cons_Comp_14C_1m,"CBre_Cons_Comp_15A_1m","Both","Terminations",walds = TRUE)

comp.or<-rbind(or_ceil,or_term)

write.csv(get_study_variables_odds_ratio(subset(comp.or,!variable %in% c("cl_def3_HHI_lag1","cl_def6_HHI_lag1",
                                                                         "CompOffr1 offer",
                                                                        "CompOffr2 offers",
                                                                        "CompOffr3-4 offers",
                                                                        "CompOffr5+ offers"))),
          file="..//Output//competition_odds_ratio_1m.csv",row.names=FALSE)



# dotplot(ranef(Term_Cons_13E, condVar = T), strip = T, scales=list(relation='free'))$NAICS3
```

## Residuals Plot

```{r Residuals_1m, fig.width=7.5 , fig.height=8.5}

residual_cbre<-gridExtra::grid.arrange(
  binned_fitted_versus_residuals(CBre_Cons_13B_1m,bins=50)+
    labs(title="Concentration Binned Actuals",caption=NULL,
         x="Estimated Pr(Ceiling Breach)",y="Actual Pr(Ceiling Breach)"),
  residuals_binned(CBre_Cons_13B_1m, bins=50)+labs(title="Concentration Binned Residual Plot",
                                                   x="Estimated Pr(Ceiling Breach)"),
  binned_fitted_versus_residuals(CBre_Comp_13C_1m,bins=50)+
    labs(title="Competition Binned Actuals Plot",caption=NULL,
         x="Estimated Pr(Ceiling Breach)",y="Actual Pr(Ceiling Breach)"),
residuals_binned(CBre_Comp_13C_1m, bins=50)+labs(title="Competition Binned Residuals Plot",
                                                 x="Estimated Pr(Ceiling Breach)"),
binned_fitted_versus_residuals(CBre_Cons_Comp_15A_1m,bins=50)+
  labs(title="Both Binned Actuals",
       caption=NULL,
         x="Estimated Pr(Ceiling Breach)",y="Actual Pr(Ceiling Breach)"),
residuals_binned(CBre_Cons_Comp_15A_1m, bins=50)+labs(title="Both Binned Residuals Plot",
                                                      x="Estimated Pr(Ceiling Breach)"),ncol=2)

residual_cbre
ggsave(residual_cbre,file="..//Output//residual_cbre_1m.png",width=7.5, height=8.5)
ggsave(residual_cbre,file="..//Output//residual_cbre_1m.eps",width=7.5, height=8.5)

residual_term<-gridExtra::grid.arrange(
  binned_fitted_versus_residuals(Term_Cons_13E_1m,bins=50)+
    labs(title="Concentration Binned Actuals",caption=NULL,
         x="Estimated Pr(Termination)",y="Actual Pr(Termination)"),
  residuals_binned(Term_Cons_13E_1m, bins=50)+labs(title="Binned Residual Plot"),
  binned_fitted_versus_residuals(Term_Comp_13F_1m,bins=50)+
    labs(title="Competition Binned Actuals Plot",caption=NULL,
         x="Estimated Pr(Termination)",y="Actual Pr(Termination)"),
residuals_binned(Term_Comp_13F_1m, bins=50)+labs(title="Binned Residuals Plot"),
binned_fitted_versus_residuals(Term_Cons_Comp_14C_1m,bins=50)+
  labs(title="Both Binned Actuals",
       caption=NULL,
         x="Estimated Pr(Termination)",y="Actual Pr(Termination)"),
residuals_binned(Term_Cons_Comp_14C_1m, bins=50)+labs(title="Binned Residuals Plot"),ncol=2)


residual_term
ggsave(residual_term,file="..//Output//residual_term_1m.png",width=7.5, height=8.5)
ggsave(residual_term,file="..//Output//residual_term_1m.eps",width=7.5, height=8.5)


# debug(residuals_binned)
# gridExtra::grid.arrange(residuals_binned(Term_Cons_13E, bins=50)+labs(title="Concentration Binned Residuals Plot"),
# residuals_binned(Term_Comp_13E2, bins=50)+labs(title="Competition Binned Residuals Plot"),
# residuals_binned(Term_Cons_Comp_14B, bins=50)+labs(title="Both Binned Residuals Plot"),ncol=1)
```