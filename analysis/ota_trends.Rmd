---
title: "Defense Acquisition Trends"
output:
  html_document:
    keep_md: yes
    toc: yes
date: "Wednesday, October 6, 2021"
---

# Setup
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from   FPDS.

```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(scales)
library(openxlsx)
# library(XLConnect)
axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40
load(file="../data/clean/Defense_OTA.Rda")

ota_def$YTD<-ifelse(ota_def$Fiscal_Year==max(ota_def$Fiscal_Year),"YTD","Full Year")
ota_def$dFYear<-as.Date(paste0(as.character(ota_def$Fiscal_Year),"/01/01"))

online_path<-file.path(get_local_sharepoint_path("DIIG Teamsite - Shared Documents"),"2024 - Acquisition Trends","Data and Figures")
```

# Estimates

## Estimate Prep
```{r EstimatePrep}
OTAquarterly<-read.csv(file.path("..","Data_Raw","OTA_All_FIelds.csv"),skip = 2)
OTAquarterly<-standardize_variable_names(OTAquarterly)
OTAquarterly$Date.Signed<-as.Date(OTAquarterly$Date.Signed,"%m/%d/%Y")

OTAquarterly<-OTAquarterly %>% mutate(fiscal_quarter=lubridate::quarter(Date.Signed,fiscal_start=10),
                        ContractingCustomer=ifelse(Contracting.Department.ID=="9700","Defense","Non-Defense")) %>%
  group_by(Fiscal_Year,fiscal_quarter,ContractingCustomer) %>%
  dplyr::summarize(Action_Obligation=sum(csis360::text_to_number(Dollars.Obligated),na.rm=TRUE)#,
            # minSD=min(Date.Signed),
            # maxSD=max(Date.Signed)
            )%>% filter((fiscal_quarter<=3 | Fiscal_Year<2021)&
                                                Fiscal_Year>=2015 & ContractingCustomer=="Defense") %>%
  arrange(Fiscal_Year,fiscal_quarter)




if(any(is.na(OTAquarterly$Fiscal_Year))) stop("NA Quarters")


OTAquarterly<-deflate(OTAquarterly,money_var = "Action_Obligation",deflator_var="OMB20_GDP20")


```
## Estimate Last Quarter
Create a univariate model that estimates the fourth quarter based on the first three quarters.

This isn't a perfect representation, as the spending in the first three quarters will continue to fluctuate even well after the 90 day delay for DoD has expired. In theory, there could be slightly greater precision by tracking the first three quarters at a consistent point in each year. However, that's not a level of history that can be straightforwardly reconstructed.  

This is also a tiny n, only 6 or so years, and thus an incredibly crude estimate.
```{r Model}


a<-OTAquarterly %>% group_by(Fiscal_Year) %>% filter(Fiscal_Year<2021 & !is.na(fiscal_quarter))%>% mutate(
  q1toq3=if_else(fiscal_quarter<=3,Action_Obligation_OMB24_GDP22,NA),
  q4=if_else(fiscal_quarter==4,Action_Obligation_OMB24_GDP22,NA)) %>%
  summarise(
  q1toq3=sum(q1toq3,na.rm=TRUE),
  q4=sum(q4,na.rm = TRUE),
  total=sum(Action_Obligation_OMB24_GDP22,na.rm=TRUE)
)


m<-lm(data=a,q4~q1toq3)
summary(m)

plot(m)

q1to13_2021<-sum(ifelse(OTAquarterly$fiscal_quarter<=3 & !is.na(OTAquarterly$fiscal_quarter) & OTAquarterly$Fiscal_Year==2021,OTAquarterly$Action_Obligation_OMB24_GDP22,0))

cvalues<-data.frame(q1toq3=q1to13_2021)

p<-predict(m,cvalues,interval="prediction")
e2021<-data.frame(Fiscal_Year=2021,
           fiscal_quarter=4,
           Action_Obligation_Then_Year=NA,
           Action_Obligation_OMB24_GDP22=NA,
           yest=p[1]+q1to13_2021,
           lwr=p[2]+q1to13_2021,
           upr=p[3]+q1to13_2021,
           ContractingCustomer="Defense",
           Actual="Estimate"
           )
rm(q1to13_2021,cvalues)
```


## Topline Estimate
```{r Topline}

OTAquarterly$Actual<-"Actual"
OTAquarterly$lwr<-NA
OTAquarterly$upr<-NA
OTAquarterly$yest<-NA

# build_plot(data=rbind(OTAquarterly,q2021,e2021),
#            x_var="dFYear",
#            y_var="Action_Obligation_OMB24_GDP22",
#            color_var = "fiscal_quarter",
#            facet_var="Actual",
#            chart_geom="Bar Chart")+facet_wrap(~)
OTAquarterlyEst<-rbind(OTAquarterly,e2021)
OTAquarterlyEst$Actual<-factor(OTAquarterlyEst$Actual,levels=c("Estimate","Actual"))
OTAquarterlyEst$fiscal_quarter<-factor(OTAquarterlyEst$fiscal_quarter,c("4","3","2","1"))
OTAquarterlyEst$dFYear<-as.Date(paste("1/1/",as.character(OTAquarterlyEst$Fiscal_Year),sep=""),"%m/%d/%Y")

(ota_topline_qest<-ggplot(data=OTAquarterlyEst %>% filter(Fiscal_Year>=2000) #rbind(OTAquarterly,q2021,e2021),
      )+geom_col( aes(x=dFYear,
           y=Action_Obligation_OMB24_GDP22/1000000000,
           # alpha=Actual,
           fill = fiscal_quarter
       ))+
  # scale_alpha_discrete(range=c(0.4,1))+
  geom_errorbar(aes(x=dFYear,ymin=lwr/1000000000,ymax=upr/1000000000,color = fiscal_quarter))+
    geom_point(aes(x=dFYear,y=yest/1000000000,color = fiscal_quarter))+
    scale_color_discrete("Estimate")+
    labs(x="Fiscal Year",y="Constant FY 2020 $ Billions",fill="Quarter")
)

ggsave600dpi(ota_topline_qest,file=file.path("..","Output","ota_quarterly_est.png"),  
             width=12, height= 6, units="in",size=16, lineheight=1.2
             )

(ota_topline_q<-ggplot(data=OTAquarterlyEst %>% filter(Fiscal_Year>=2000) #rbind(OTAquarterly,q2021,e2021),
      )+geom_col( aes(x=dFYear,
           y=Action_Obligation_OMB24_GDP22/1000000000,
           # alpha=Actual,
           fill = fiscal_quarter
       ))+
  # scale_alpha_discrete(range=c(0.4,1))+
  # geom_errorbar(aes(x=dFYear,ymin=lwr,ymax=upr,color = fiscal_quarter))+
    # geom_point(aes(x=dFYear,y=yest,color = fiscal_quarter))+
    # scale_color_discrete("Estimate")+
    labs(x="Fiscal Year",y="Constant FY 2020 $ Billions",fill="Quarter")
)



write.csv(file="..//Output//OTA//ota_topline_qest.csv",row.names = FALSE,na="",
          OTAquarterlyEst %>%  filter(Fiscal_Year>=2015)%>%
          format_data_for_plot(
                               fy_var="Fiscal_Year",
                               y_var="Action_Obligation_OMB24_GDP22",
                               color_var="fiscal_quarter",
                               # facet="SubCustomer",
                               # labels_and_colors = ota_lc,
                               group=TRUE) %>%
            arrange(Fiscal_Year) %>%
            mutate(Dollars_GDP20=Action_Obligation_OMB24_GDP22/1000000000)%>%
          pivot_wider(id_cols=c(fiscal_quarter),
                      names_from=Fiscal_Year,values_from=Dollars_GDP20) %>% 
            
            # mutate(PlatformPortfolio=factor(PlatformPortfolio,levels=ota_lc$variable[ota_lc$column=="PlatformPortfolio"]))%>%
            # mutate(PlatformPortfolio=factor(PlatformPortfolio,levels=levels(fiscal_quarter),
            #                                 labels=gsub("\\n"," ",levels(PlatformPortfolio))))%>%
                   arrange(fiscal_quarter))


ggsave600dpi(ota_topline_q,file=file.path("..","Output","ota_quarterly.png"),  
             width=12, height= 6, units="in",size=16, lineheight=1.2
             )
```


# Topline


## Topline spend 
```{r}
ota_def$`BaseandAllOptionsValue(TotalContractValue)`
output_TY<-ota_def  %>% 
  filter(Fiscal_YQ<=2024.1) %>%
  group_by(dFYear,YTD)%>%  
  summarise(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE),
            `BaseandAllOptionsValue(TotalContractValue)`=
              sum(text_to_number(`BaseandAllOptionsValue(TotalContractValue)`),
                  na.rm=TRUE))%>%
  pivot_longer(cols=c(Action_Obligation_Then_Year,`BaseandAllOptionsValue(TotalContractValue)`),
                      names_to="Metric")
  
(
Topline<-build_plot(
  data=output_TY,
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=prepare_labels_and_colors(output_TY),
  # NA, #VAR.ncol
  alpha_var="YTD",
  x_var="dFYear",
  y_var="value", #VAR.y.variable
  color_var="Metric", #color_var
  # facet_var="Competition.sum", #facet_var
  # column_key=get_column_key(output_TY),
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2023 $s)")
)

log_plot(plot=Topline, df=output_TY,
                     filename="topline",xlsx="DoD_Acq_Trends_OTA.xlsx",
                     sheet="Topline",path="..//Output//OTA//",second_path=online_path,
         height=3.25,
                     startRow=1,startCol=12,format=TRUE,#var_list=c("Source","fiscal_quarter"),
         excel_then_year =  FALSE,csv_then_year = FALSE
         )                                  
```




## Topline Vendor Size
```{r ToplineVendor}

(
ToplineVendor<-build_plot(
  data=ota_def %>% filter(Fiscal_YQ<=2024.1),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2,partial_year=2024,partial_label="\nQ1")+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi("..//Output//OTA//topline_vendor.png", ToplineVendor, 
             width=6.5, height= 4, units="in",size=11
             )

```


## Topline NonTraditional
```{r ToplineVendor}

(
ToplineNontrad<-build_plot(
  data=ota_def %>% filter(Fiscal_YQ<=2024.1),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="NontraditionalGovernmentContractorParticipationDescription", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2,partial_year=2024,partial_label="\nQ1")+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

log_plot(plot=ToplineNontrad, df=ota_def %>% filter(Fiscal_YQ<=2024.1),
                     filename="acq_ota_3_ota_nontrad",xlsx="DoD_Acq_Trends_OTA.xlsx",
                     sheet="NonTrad",path="..//Output//OTA//",second_path=online_path,
         width=4.5,height=5.5,
                     startRow=1,startCol=12,format=TRUE,#var_list=c("Source","fiscal_quarter"),
         )      

```

# Type of Agreement
## Topline Type of Agreement
```{r TypeOfAgreement}

(
ToplineType<-build_plot(
  data=ota_def %>% filter(Fiscal_Year>=2015 & Fiscal_YQ<=2024.1 &
                            !is.na(TypeOfAgreement)),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="TypeOfAgreement", #color_var
  facet_var="TypeOfAgreement", #facet_var
  # column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2,partial_year=2024,partial_label="\nQ1")+
    facet_grid(TypeOfAgreement~., scales="free_y",space="free_y")+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right",strip.text.y=element_text(angle=0))+
  labs(y="Obligations (Constant 2023 $s)",x="Fiscal Year",
       title="Figure 12: Defense OTA Obligations by Customer and Type, FY 2015–FY 2024 Q1",
       caption="Note: Unlabeled values not show.\nSource: FPDS and CSIS analysis.")
)

log_plot(plot=ToplineType, df=ota_def %>% filter(Fiscal_YQ<=2024.1),
                     filename="acq_ota_1_ota_type",xlsx="DoD_Acq_Trends_OTA.xlsx",
                     sheet="Type",path="..//Output//OTA//",second_path=online_path,
         width=4.5,height=5.5,
                     startRow=1,startCol=12,format=TRUE,#var_list=c("Source","fiscal_quarter"),
         )       

```


## Type Subcustomer
```{r SubCustomerType}

(
TypeSubCustomer<-build_plot(
  data=ota_def %>% filter(Fiscal_Year>=2015 & Fiscal_YQ<=2024.1 &
                            !is.na(TypeOfAgreement)),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="SubCustomer.OTA.sum", #color_var
  facet_var="TypeOfAgreement", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2023,3,partial_year=2024,partial_label="\nQ1")+
    facet_grid(TypeOfAgreement~., scales="free_y",space="free_y")+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right",strip.text.y=element_text(angle=0))+
  labs(y="Obligations (Constant 2023 $s)",x="Fiscal Year",
       title="Defense OTA Obligations by Customer and Type, FY 2015–FY 2024 Q1",
       caption="Note: Unlabeled values not show.\nSource: FPDS and CSIS analysis.")
)

log_plot(plot=TypeSubCustomer, df=ota_def %>% filter(Fiscal_YQ<=2024.1),
                     filename="acq_ota_2_ota_type_cust",xlsx="DoD_Acq_Trends_OTA.xlsx",
                     sheet="TypeCust",path="..//Output//OTA//",second_path=online_path,
         width=4,height=5.5,
                     startRow=1,startCol=12,format=TRUE,#var_list=c("Source","fiscal_quarter"),
         )       



ggsave600dpi("keynote_Type_Platform.png",path="..//Output//OTA//",second_path=online_path,
             TypeSubCustomer+facet_wrap(~TypeOfAgreement), 
             width=9, height= 5.5, units="in",size=20,lineheight = 1.2
             )

log_plot(plot=TypeSubCustomer, df=ota_def %>% filter(Fiscal_YQ<=2024.1),
                     filename="nps_fig12_ota_typecust",xlsx="DoD_2024_NPS.xlsx",
                     sheet="12 OTAtype",path="../output/AcqTrends/NPS2024/",second_path=online_path,
         height=3,include_YTD=FALSE,
                     startRow=1,format=TRUE,excel_y_var=TRUE,excel_formulas = TRUE,
         output_doc_svg=TRUE,output_slide_png = TRUE, suppress_doc_svg_text = "title"
         )

  ggsave600dpi(TypeSubCustomer+facet_wrap(~TypeOfAgreement),filename="nps_fig12_ota_typecust_slide.png",
               path="../output/AcqTrends/NPS2024/",second_path=online_path,
               width=13, height= 5.5, units="in",size=20,lineheight = 1.2
               )
```


## Type NonTraditional
```{r SubCustomerType}

(
TypeNonTrad<-build_plot(
  data=ota_def %>% filter(Fiscal_Year>=2015 & Fiscal_YQ<=2024.1 &
                            !is.na(TypeOfAgreement)),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="NontraditionalGovernmentContractorParticipationDescription", #color_var
  facet_var="TypeOfAgreement", #facet_var
  # column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2,partial_year=2024,partial_label="\nQ1")+
    facet_grid(TypeOfAgreement~., scales="free_y",space="free_y")+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right",strip.text.y=element_text(angle=0))+
  labs(y="Obligations (Constant 2023 $s)",x="Fiscal Year",
       caption="Note: Unlabeled values not show.\nSource: FPDS and CSIS analysis.")
)

log_plot(plot=TypeNonTrad, df=ota_def %>% filter(Fiscal_YQ<=2024.1),
                     filename="acq_ota_2_ota_type_nontrad",xlsx="DoD_Acq_Trends_OTA.xlsx",
                     sheet="NonTrad",path="..//Output//OTA//",second_path=online_path,
         width=4.5,height=5.5,
                     startRow=1,startCol=12,format=TRUE,#var_list=c("Source","fiscal_quarter"),
         )       
 

```

## Type Platform
```{r PlatformType}

(
TypePlatform<-build_plot(
  data=ota_def %>% filter(Fiscal_YQ<=2024.1),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="PlatformPortfolio", #color_var
  facet_var="TypeOfAgreement", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi("..//Output//OTA//Type_Platform.png", TypePlatform, 
             width=12, height= 6, units="in",size=11,lineheight = 1.2
             )
```

#Product/Service/R&D

## Topline Product/Service/R&D
```{r ToplinePSR}

(
ToplinePSR<-build_plot(
  data=ota_def %>% filter(Fiscal_Year>=2015& Fiscal_YQ<=2024.1),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="SimpleArea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")+
  date_x_year_breaks(2000,2022,2,partial_year=2024,partial_label="\nQ1")+
   scale_alpha_ordinal(range=c(1,0.5))
)

ggsave600dpi("..//Output//OTA//ota_topline_psr.png", ToplinePSR, 
             width=5, height= 6, units="in",size=16, lineheight=1.2
             )

ggsave600dpi("..//Output//OTA//ota_topline_psr_keynote.svg", ToplinePSR+
               labs(title="DOD OTAs Obligations\nby Area, 2015-2022"),
             width=6, height= 5.5, units="in", size=20, lineheight = 0.75
             )

ggsave600dpi("..//Output//OTA//ota_topline_psr_keynote.png", ToplinePSR+
               labs(title="DOD OTAs Obligations\nby Area, 2015-2022"),
             width=6, height= 5.5, units="in", size=20, lineheight = 0.75
             )

log_plot(plot=ToplinePSR, df=ota_def   %>% filter(Fiscal_YQ<=2024.1),
                     filename="acq_fig5_3_OTAarea",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="5-3A OTAarea",path="../output/AcqTrends/",second_path=online_path,height=3,
                     startRow=1,startCol=12,format=TRUE,
         excel_y_var = TRUE,excel_formulas=TRUE,hist_year=2015,cur_year=2022
         #var_list=c("Source","fiscal_quarter")
         )

```



## PSR Covid
```{r ToplinePSR}

summary(ota_def$SimpleArea)


(
ToplinePSRcovid<-build_plot(
  data=ota_def %>% filter(Fiscal_YQ<=2024.1),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="ProductServiceOrRnDarea.covid", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi("..//Output//OTA//ota_psr_covid.png", ToplinePSRcovid, 
             width=12, height= 6, units="in",size=11, lineheight=1.2
             )

write.csv(file="..//Output//OTA//ota_psr_covid.csv",row.names = FALSE,
          ota_def %>% group_by(ProductServiceOrRnDarea.covid,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(ProductServiceOrRnDarea.covid),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))


```

## R&D phase
```{r Services}

(
RnDphase<-build_plot(
  data=ota_def %>% filter(SimpleArea=="R&D"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="ProductServiceOrRnDarea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi("..//Output//OTA//psr_RnDPhase.png", RnDphase, 
             width=12, height= 6, units="in",size=11, lineheight=1.2
             )
                           

write.csv(file="..//Output//OTA//psr_RnDPhase.csv",row.names = FALSE,
          pivot_wider(RnDphase$data%>%mutate(Fiscal_Year=year(dFYear)),id_cols=c(ProductServiceOrRnDarea),
                      names_from=dFYear,values_from=Action_Obligation_OMB24_GDP22)%>%
            arrange(ProductServiceOrRnDarea))
            

write.csv(file="..//Output//OTA//psr_RnDPhase_current.csv",row.names = FALSE,
          ota_def %>% filter(SimpleArea=="R&D") %>%
            format_data_for_plot(fy_var="dFYear",y_var="Action_Obligation_Then_Year",color_var = "ProductServiceOrRnDarea",
                                 labels_and_colors=ota_lc) %>%
          pivot_wider(id_cols=c(ProductServiceOrRnDarea),
                      names_from=dFYear,values_from=Action_Obligation_Then_Year)%>%
            arrange(ProductServiceOrRnDarea))

```

## R&D phase and OTA
```{r Services}

contract_merge<-ota_def%>%filter(Fiscal_Year >=2015) %>%
  group_by(Fiscal_Year,
                         ProductServiceOrRnDarea,
                         SimpleArea)%>%
  summarise(Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22))

# 
#   format_data_for_plot(contract_data,
#                      fy_var="Fiscal_Year", #x_var
#                      y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
#                      color_var="ProductServiceOrRnDarea", #color_var
#                      facet_var = "SimpleArea",
#                      labels_and_colors = labels_and_colors
# )
# ota_merge<-format_data_for_plot(ota_def,
#                      fy_var="Fiscal_Year", #x_var
#                      y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
#                      color_var="ProductServiceOrRnDarea", #color_var
#                      facet_var = "SimpleArea",
#                      labels_and_colors = labels_and_colors
# )

ota_merge<-ota_def%>%filter(Fiscal_Year >=2015) %>%
  group_by(Fiscal_Year,
                         ProductServiceOrRnDarea,
                         SimpleArea)%>%
  summarise(Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22))


#   format_data_for_plot(ota_def,
#                      fy_var="Fiscal_Year", #x_var
#                      y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
#                      color_var="ProductServiceOrRnDarea", #color_var
#                      facet_var = "SimpleArea",
#                      labels_and_colors = labels_and_colors
# )

ota_merge$type<-"OTA"
colnames(ota_merge)[colnames(ota_merge)=="Fiscal_Year"]<-"Fiscal_Year"
contract_merge$type<-"contract"
merge<-rbind(ota_merge,contract_merge)

(
RnDphase<-build_plot(
  data=merge %>% filter(SimpleArea=="R&D"),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="type", #color_var
  facet_var="ProductServiceOrRnDarea", #facet_var
  column_key=ota_ck,
  format=FALSE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

# ggsave600dpi("..//Output//OTA//contractota_RnDPhase.png", RnDphase, 
#              width=12, height= 6, units="in",size=11, lineheight=1.2
#              )
#                            
# 
write.csv(file="..//Output//OTA//contractota_RnDPhase.csv",row.names = FALSE,
          pivot_wider(RnDphase$data%>%mutate(Fiscal_Year=year(dFYear)),id_cols=c(ProductServiceOrRnDarea,type),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22)%>%
            arrange(ProductServiceOrRnDarea,type))
#             
# 
# write.csv(file="..//Output//OTA//psr_RnDPhase_current.csv",row.names = FALSE,
#           ota_def %>% filter(SimpleArea=="R&D") %>%
#             format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "ProductServiceOrRnDarea",
#                                  labels_and_colors=ota_lc) %>%
#           pivot_wider(id_cols=c(ProductServiceOrRnDarea),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
#             arrange(ProductServiceOrRnDarea))

```


## PSR Subcustomer
```{r SubCustomerPSR}

(
PSRsubcustomer<-build_plot(
  data=ota_def %>% filter(Fiscal_YQ<=2024.1),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="SubCustomer.OTA.sum", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2023 $s)")
)

# ggsave600dpi("..//Output//OTA//subcustomer_PSR.png", PSRsubcustomer, 
#              width=6.5, height= 4, units="in",size=11
#              )
ggsave600dpi("..//Output//OTA//PSR_subcustomer.png", PSRsubcustomer, 
             width=12, height= 6, units="in",size=11,lineheight = 1.2
             )
```

## Services
```{r names_from=lubridate::year(dFYear)}

(
Services<-build_plot(
  data=ota_def %>% filter(SimpleArea=="Services (Non-R&D)"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="ProductServiceOrRnDarea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi("..//Output//OTA//psr_Services.png", Services, 
             width=12, height= 6, units="in",size=11, lineheight=1.2
             )
                           

write.csv(file="..//Output//OTA//psr_Services.csv",row.names = FALSE,
          pivot_wider(Services$data%>%mutate(Fiscal_Year=year(dFYear)),id_cols=c(ProductServiceOrRnDarea),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22)%>%
            arrange(ProductServiceOrRnDarea))
            

write.csv(file="..//Output//OTA//psr_Services_current.csv",row.names = FALSE,
          ota_def %>% filter(SimpleArea=="R&D") %>%
            format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "ProductServiceOrRnDarea",
                                 labels_and_colors=ota_lc) %>%
          pivot_wider(id_cols=c(ProductServiceOrRnDarea),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(ProductServiceOrRnDarea))

```

# SubCustomer
## Topline SubCustomer 
```{r SubCustomer}
# summary(ota_def$Contracting_Agency_Name)
# ota_def$
(
SubCustomer<-build_plot(
  data=ota_def %>% filter(Fiscal_Year>=2015),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="SubCustomer.OTA.sum", #color_var
  # facet_var="SubCustomer.sum", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi("..//Output//OTA//ota_subcustomer.png", SubCustomer, 
             width=4.5, height= 6, units="in",size=16,lineheight = 1.2
             )

write.csv(file="..//Output//OTA//ota_subcustomer.csv",row.names = FALSE,
          pivot_wider(SubCustomer$data %>% mutate(Fiscal_Year=year(dFYear)),
                      id_cols=c(SubCustomer.OTA),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22))

write.csv(file="..//Output//OTA//ota_subcustomer_current.csv",row.names = FALSE,
          ota_def %>% group_by(SubCustomer.OTA,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(SubCustomer.OTA),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)
          ,na="")

summary(ota_def$SubCustomer)
```

## Topline SubCustomer Variant
```{r SubCustomer}
# platpsc$SubCustomer.platform[platpsc$Contracting.Agency.ID==]


(
SubCustomer<-build_plot(
  data=ota_def %>% filter(Fiscal_YQ<=2024.1),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="SubCustomer.OTA", #color_var
  facet_var="SubCustomer.sum", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi("..//Output//OTA//ota_subcustomer_detail.png", SubCustomer, 
             width=6.5, height= 5.5, units="in",size=11,lineheight = 1.2
             )

write.csv(file="..//Output//OTA//topline_subcustomer.csv",row.names = FALSE,
          pivot_wider(SubCustomer$data%>%mutate(Fiscal_Year=year(dFYear)),id_cols=c(SubCustomer.sum,SubCustomer.OTA),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22))

write.csv(file="..//Output//OTA//topline_subcustomer_current.csv",row.names = FALSE,
          ota_def %>% group_by(SubCustomer.sum,SubCustomer,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(SubCustomer.sum,SubCustomer),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(ota_def$SubCustomer)
```


## SubCustomer Product/Service/R&D
```{r SubCustomerPSR}

(
SubCustomerPSR<-build_plot(
  data=ota_def %>% filter(Fiscal_YQ<=2024.1),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="SimpleArea", #color_var
  facet_var="SubCustomer.OTA", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+facet_wrap(~SubCustomer.OTA,scale="free_y")+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2023 $s),\nVariable Scale")
)

# ggsave600dpi("..//Output//OTA//subcustomer_PSR.png", SubCustomerPSR, 
#              width=6.5, height= 4, units="in",size=11
#              )
ggsave600dpi("..//Output//OTA//subcustomer_PSR.png", SubCustomerPSR, 
             width=12, height= 6, units="in",size=11,lineheight = 1.2
             )
```

## SubCustomer Type
```{r SubCustomerPSR}

(
SubCustomerType<-build_plot(
  data=ota_def %>% filter(Fiscal_YQ<=2024.1),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="TypeOfAgreement", #color_var
  facet_var="SubCustomer.OTA", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+facet_wrap(~SubCustomer.OTA,scale="free_y")+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2023 $s),\nVariable Scale")
)

# ggsave600dpi("..//Output//OTA//subcustomer_PSR.png", SubCustomerPSR, 
#              width=6.5, height= 4, units="in",size=11
#              )
ggsave600dpi("..//Output//OTA//subcustomer_Type.png", SubCustomerType, 
             width=12, height= 6, units="in",size=11,lineheight = 1.2
             )
```

## SubCustomer NonTrad
```{r SubCustomerPSR}

(
SubCustomerNonTrad<-build_plot(
  data=ota_def %>% filter(Fiscal_YQ<=2024.1),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="NontraditionalGovernmentContractorParticipationDescription", #color_var
  facet_var="SubCustomer.OTA", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+facet_wrap(~SubCustomer.OTA,scale="free_y")+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2023 $s),\nVariable Scale")
)

# ggsave600dpi("..//Output//OTA//subcustomer_PSR.png", SubCustomerPSR, 
#              width=6.5, height= 4, units="in",size=11
#              )
ggsave600dpi("..//Output//OTA//subcustomer_Type.png", SubCustomerNonTrad, 
             width=12, height= 6, units="in",size=11,lineheight = 1.2
             )
```

# Platform
## Topline  Platform
```{r Platform}

(
Platform<-build_plot(
  data=ota_def %>% filter(Fiscal_Year>=2015 & Fiscal_YQ<=2024.1),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="PlatformPortfolio", #color_var
  # facet_var="PlatformPortfolio", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")+
  date_x_year_breaks(2000,2022,2,partial_year=2024,partial_label="\nQ1")+
   scale_alpha_ordinal(range=c(1,0.5))
)

ggsave600dpi("..//Output//OTA//ota_platform.png", Platform, 
             width=6, height= 6, units="in",size=14,lineheight = 1.2
             )



ggsave600dpi("..//Output//OTA//ota_platform_keynote.png", Platform+
               labs(title="DOD OTAs Obligations by\nPlatform, 2015-2022"),
             width=6.5, height= 5.5, units="in", size=20, lineheight = 0.75
             )

ggsave600dpi("..//Output//OTA//ota_platform_keynote.svg", Platform+
               labs(title="DOD OTAs Obligations by\nPlatform, 2015-2022"),
             width=6.5, height= 5.5, units="in", size=20, lineheight = 0.75
             )

log_plot(plot=Platform, df=ota_def   %>% filter(Fiscal_YQ<=2024.1),
                     filename="acq_fig5_3_OTAplatform",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="5-3B OTAplat",path="../output/AcqTrends/",second_path=online_path,height=3,
                     startRow=1,startCol=12,format=TRUE,
         excel_y_var = TRUE,excel_formulas=TRUE,hist_year=2015,cur_year=2022
         #var_list=c("Source","fiscal_quarter")
         )

ggsave("..//..//Vendor//Output//AcqTrends//acq_fig5_3_OTAplatarea.svg",
             gridExtra::grid.arrange(ToplinePSR+labs(caption=NULL),Platform+labs(y=NULL,caption=NULL)+
                                       theme(plot.margin = margin(t=0,b=0, l=-0.1, r=0.25)),nrow=1),
             width=6.5, height= 4.25, units="in"#, size=20, lineheight = 0.75
             )


```


## Platform SubCustomer
```{r PlatformSubCustomer}

(
PlatformSubCustomer<-build_plot(
  data=ota_def %>% filter(Fiscal_YQ<=2024.1),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="SubCustomer.OTA.sum", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+# theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi("..//Output//OTA//platform_subcustomer.png", PlatformSubCustomer, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )


```

## Platform PSR
```{r PlatformPSR}

(
PlatformPSR<-build_plot(
  data=ota_def %>% filter(Fiscal_YQ<=2024.1),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="SimpleArea", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2,partial_year=2024,partial_label="\nQ1")+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi("..//Output//OTA//platform_PSR.png", PlatformPSR, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

```





## Platform Vendor
```{r PlatformVendor}

(
PlatformVendor<-build_plot(
  data=ota_def %>% filter(PlatformPortfolio!="Unlabeled" ) ,
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2,partial_year=2024,partial_label="\nQ1")+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi("..//Output//OTA//platform_vendor.png", PlatformVendor, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

```



## Platform Comp
```{r PlatformComp}

(
PlatformComp<-build_plot(
  data=ota_def %>% filter(PlatformPortfolio!="Unlabeled" ),
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2,partial_year=2024,partial_label="\nQ1")+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi("..//Output//OTA//platform_comp.png", PlatformComp, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

```

# Army
## Army Platform
```{r ArmyPlatform}

(
ArmyPlatform<-build_plot(
  data=ota_def %>% filter(SubCustomer=="Army"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="PlatformPortfolio", #color_var
  # facet_var="PlatformPortfolio", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2,partial_year=2024,partial_label="\nQ1")+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi("..//Output//OTA//ota_army_platform.png", ArmyPlatform, 
             width=12, height= 6, units="in",size=11,lineheight = 1.2
             )

  
write.csv(file="..//Output//OTA//ota_army_platform_current.csv",row.names = FALSE,na="",
          format_data_for_plot(ota_def %>% filter(SubCustomer=="Army"),
                               fy_var="Fiscal_Year",
                               y_var="Action_Obligation_Then_Year",
                               color_var="PlatformPortfolio",
                               facet="SubCustomer",
                               labels_and_colors = ota_lc,
                               group=TRUE) %>%
            arrange(Fiscal_Year) %>%
          pivot_wider(id_cols=c(SubCustomer,PlatformPortfolio),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year) %>% 
            # mutate(PlatformPortfolio=factor(PlatformPortfolio,levels=ota_lc$variable[ota_lc$column=="PlatformPortfolio"]))%>%
            mutate(PlatformPortfolio=factor(PlatformPortfolio,levels=levels(PlatformPortfolio),
                                            labels=gsub("\\n"," ",levels(PlatformPortfolio))))%>%
                   arrange(desc(PlatformPortfolio)))

```


# Navy
## Navy Platform
```{r NavyPlatform}

(
NavyPlatform<-build_plot(
  data=ota_def %>% filter(SubCustomer=="Navy"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="PlatformPortfolio", #color_var
  # facet_var="PlatformPortfolio", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2,partial_year=2024,partial_label="\nQ1")+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi("..//Output//OTA//ota_Navy_platform.png", NavyPlatform, 
             width=12, height= 6, units="in",size=11,lineheight = 1.2
             )

  
write.csv(file="..//Output//OTA//ota_Navy_platform_current.csv",row.names = FALSE,na="",
          format_data_for_plot(ota_def %>% filter(SubCustomer=="Navy"),
                               fy_var="Fiscal_Year",
                               y_var="Action_Obligation_Then_Year",
                               color_var="PlatformPortfolio",
                               facet="SubCustomer",
                               labels_and_colors = ota_lc,
                               group=TRUE) %>%
            arrange(Fiscal_Year) %>%
          pivot_wider(id_cols=c(SubCustomer,PlatformPortfolio),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year) %>% 
            # mutate(PlatformPortfolio=factor(PlatformPortfolio,levels=ota_lc$variable[ota_lc$column=="PlatformPortfolio"]))%>%
            mutate(PlatformPortfolio=factor(PlatformPortfolio,levels=levels(PlatformPortfolio),
                                            labels=gsub("\\n"," ",levels(PlatformPortfolio))))%>%
                   arrange(desc(PlatformPortfolio)))

```


# Air Force
## Air Force Platform
```{r AirForcePlatform}

(
AirForcePlatform<-build_plot(
  data=ota_def %>% filter(SubCustomer=="Air Force"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", alpha_var="YTD",  #x_var 
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="PlatformPortfolio", #color_var
  # facet_var="PlatformPortfolio", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2,partial_year=2024,partial_label="\nQ1")+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi("..//Output//OTA//ota_air_force_platform.png", AirForcePlatform, 
             width=12, height= 6, units="in",size=11,lineheight = 1.2
             )

  
write.csv(file="..//Output//OTA//ota_air_force_platform_current.csv",row.names = FALSE,na="",
          format_data_for_plot(ota_def %>% filter(SubCustomer=="Air Force"),
                               fy_var="Fiscal_Year",
                               y_var="Action_Obligation_Then_Year",
                               color_var="PlatformPortfolio",
                               facet="SubCustomer",
                               labels_and_colors = ota_lc,
                               group=TRUE) %>%
            arrange(Fiscal_Year) %>%
          pivot_wider(id_cols=c(SubCustomer,PlatformPortfolio),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year) %>% 
            # mutate(PlatformPortfolio=factor(PlatformPortfolio,levels=ota_lc$variable[ota_lc$column=="PlatformPortfolio"]))%>%
            mutate(PlatformPortfolio=factor(PlatformPortfolio,levels=levels(PlatformPortfolio),
                                            labels=gsub("\\n"," ",levels(PlatformPortfolio))))%>%
                   arrange(desc(PlatformPortfolio)))

```