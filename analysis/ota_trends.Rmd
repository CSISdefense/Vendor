---
title: "Defense Acquisition Trends"
output:
  html_document:
    keep_md: yes
    toc: yes
date: "Wednesday, October 6, 2021"
---

# Setup
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from   FPDS.

```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(scales)

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40
load(file="../data/semi_clean/Defense_OTA.Rda")
```

# Topline



## Topline Competition
```{r ToplineComp}

(
ToplineComp<-build_plot(
  data=ota_def,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Dollars_Obligated_OMB20_GDP20", #VAR.y.variable
  color_var="Competition.sum", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//topline_comp.png", ToplineComp,  
             width=12, height= 6, units="in",size=11, lineheight=1.2
             )

View(ToplineComp$data)

write.csv(file="..//Output//topline_competition.csv",row.names = FALSE,
          # ToplineComp$data%>% mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(ToplineComp$data,id_cols=c(Competition.sum),
                        names_from=Fiscal_Year,values_from=Dollars_Obligated_OMB20_GDP20))



```


## Topline Vendor Size
```{r ToplineVendor}

(
ToplineVendor<-build_plot(
  data=ota_def,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Dollars_Obligated_OMB20_GDP20", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//topline_vendor.png", ToplineVendor, 
             width=6.5, height= 4, units="in",size=11
             )

```
## Topline Vehicle
```{r ToplineVehicle}

(
ToplineVehicle<-build_plot(
  data=ota_def,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Dollars_Obligated_OMB20_GDP20", #VAR.y.variable
  color_var="ProductServiceOrRnDarea.sum", #color_var
  facet_var="Vehicle.sum", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)


(
ToplineVehicle<-build_plot(
  data=ota_def %>% filter(!is.na(Vehicle.AwardTask)),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Dollars_Obligated_OMB20_GDP20", #VAR.y.variable
  color_var="Vehicle.sum", #color_var
  facet_var="Vehicle.AwardTask", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)",
       caption="Note: Unlabeled not shown. Source: FPDS; CSIS analysis")
)

summary(ota_def$Vehicle)

ggsave600dpi("..//Output//topline_vehicle.png", ToplineVehicle, 
             width=13, height= 4.5, units="in",size=11
             )

```


## Topline Pricing
```{r ToplinePricing}
ota_def$PricingUCA.sumlong<-ota_def$PricingUCA.sum
levels(ota_def$PricingUCA.sumlong)<-list("Firm-Fixed-Price"="FFP",
                                           "Less Common"="Less Common",
                                           "Incentive"="Incentive",
                                           "Other Cost-Based"="Other CB",
                                           "Undefinitized\nContract Award"="UCA",
                                           "Unclear"="Unclear"   )
(
ToplinePricing<-build_plot(
  data=ota_def,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Dollars_Obligated_OMB20_GDP20", #VAR.y.variable
  color_var="PricingUCA", #color_var
  facet_var="PricingUCA.sumlong", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

# ggsave600dpi("..//Output//topline_pricing.png", ToplinePricing, 
#              width=6.5, height= 4, units="in",size=11
#              )


ggsave600dpi("..//Output//topline_pricing.png", ToplinePricing,  
             width=12, height= 6, units="in",size=11, lineheight=1.2
             )
lubridate::year(ota_def$dFYear)
write.csv(file="..//Output//topline_pricing.csv",row.names = FALSE,
          ToplinePricing$data%>% mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PricingUCA,PricingUCA.sumlong),
                        names_from=dFYear,values_from=Dollars_Obligated_OMB20_GDP20))


```

#Product/Service/R&D

## Topline Product/Service/R&D
```{r ToplinePSR}

(
ToplinePSR<-build_plot(
  data=ota_def,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Dollars_Obligated_OMB20_GDP20", #VAR.y.variable
  color_var="ProductServiceOrRnDarea.sum", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//topline_psr.png", ToplinePSR, 
             width=12, height= 6, units="in",size=11, lineheight=1.2
             )

write.csv(file="..//Output//topline_psr.csv",row.names = FALSE,
          ota_def %>% group_by(ProductServiceOrRnDarea.sum,Fiscal_Year)%>%
            dplyr::summarize(Dollars_Obligated_Then_Year=sum(Dollars_Obligated_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(ProductServiceOrRnDarea.sum),
                      names_from=Fiscal_Year,values_from=Dollars_Obligated_Then_Year))

```


## R&D phase
```{r Services}

(
RnDphase<-build_plot(
  data=ota_def %>% filter(ProductServiceOrRnDarea.sum=="R&D"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Dollars_Obligated_OMB20_GDP20", #VAR.y.variable
  color_var="ProductServiceOrRnDarea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//psr_RnDPhase.png", RnDphase, 
             width=12, height= 6, units="in",size=11, lineheight=1.2
             )
                           

write.csv(file="..//Output//psr_RnDPhase.csv",row.names = FALSE,
          pivot_wider(RnDphase$data,id_cols=c(ProductServiceOrRnDarea),
                      names_from=Fiscal_Year,values_from=Dollars_Obligated_OMB20_GDP20)%>%
            arrange(ProductServiceOrRnDarea))
            

write.csv(file="..//Output//psr_RnDPhase_current.csv",row.names = FALSE,
          ota_def %>% filter(ProductServiceOrRnDarea.sum=="R&D") %>%
            format_data_for_plot(fy_var="Fiscal_Year",y_var="Dollars_Obligated_Then_Year",color_var = "ProductServiceOrRnDarea",
                                 labels_and_colors=ota_lc) %>%
          pivot_wider(id_cols=c(ProductServiceOrRnDarea),
                      names_from=Fiscal_Year,values_from=Dollars_Obligated_Then_Year)%>%
            arrange(ProductServiceOrRnDarea))

```

## R&D phase and OTA
```{r Services}

contract_merge<-ota_def%>%filter(Fiscal_Year >=2015) %>%
  group_by(Fiscal_Year,
                         ProductServiceOrRnDarea,
                         ProductServiceOrRnDarea.sum)%>%
  summarise(Dollars_Obligated_OMB20_GDP20=sum(Dollars_Obligated_OMB20_GDP20))

# 
#   format_data_for_plot(contract_data,
#                      fy_var="Fiscal_Year", #x_var
#                      y_var="Dollars_Obligated_OMB20_GDP20", #VAR.y.variable
#                      color_var="ProductServiceOrRnDarea", #color_var
#                      facet_var = "ProductServiceOrRnDarea.sum",
#                      labels_and_colors = labels_and_colors
# )
# ota_merge<-format_data_for_plot(ota_def,
#                      fy_var="Fiscal_Year", #x_var
#                      y_var="Dollars_Obligated_OMB20_GDP20", #VAR.y.variable
#                      color_var="ProductServiceOrRnDarea", #color_var
#                      facet_var = "ProductServiceOrRnDarea.sum",
#                      labels_and_colors = labels_and_colors
# )

ota_merge<-ota_def%>%filter(Fiscal_Year >=2015) %>%
  group_by(Fiscal_Year,
                         ProductServiceOrRnDarea,
                         ProductServiceOrRnDarea.sum)%>%
  summarise(Dollars_Obligated_OMB20_GDP20=sum(Dollars_Obligated_OMB20_GDP20))


#   format_data_for_plot(ota_def,
#                      fy_var="Fiscal_Year", #x_var
#                      y_var="Dollars_Obligated_OMB20_GDP20", #VAR.y.variable
#                      color_var="ProductServiceOrRnDarea", #color_var
#                      facet_var = "ProductServiceOrRnDarea.sum",
#                      labels_and_colors = labels_and_colors
# )

ota_merge$type<-"OTA"
colnames(ota_merge)[colnames(ota_merge)=="Fiscal_Year"]<-"Fiscal_Year"
contract_merge$type<-"contract"
merge<-rbind(ota_merge,contract_merge)

(
RnDphase<-build_plot(
  data=merge %>% filter(ProductServiceOrRnDarea.sum=="R&D"),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Dollars_Obligated_OMB20_GDP20", #VAR.y.variable
  color_var="type", #color_var
  facet_var="ProductServiceOrRnDarea", #facet_var
  column_key=ota_ck,
  format=FALSE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

# ggsave600dpi("..//Output//contractota_RnDPhase.png", RnDphase, 
#              width=12, height= 6, units="in",size=11, lineheight=1.2
#              )
#                            
# 
write.csv(file="..//Output//contractota_RnDPhase.csv",row.names = FALSE,
          pivot_wider(RnDphase$data,id_cols=c(ProductServiceOrRnDarea,type),
                      names_from=Fiscal_Year,values_from=Dollars_Obligated_OMB20_GDP20)%>%
            arrange(ProductServiceOrRnDarea,type))
#             
# 
# write.csv(file="..//Output//psr_RnDPhase_current.csv",row.names = FALSE,
#           ota_def %>% filter(ProductServiceOrRnDarea.sum=="R&D") %>%
#             format_data_for_plot(fy_var="Fiscal_Year",y_var="Dollars_Obligated_Then_Year",color_var = "ProductServiceOrRnDarea",
#                                  labels_and_colors=ota_lc) %>%
#           pivot_wider(id_cols=c(ProductServiceOrRnDarea),
#                       names_from=Fiscal_Year,values_from=Dollars_Obligated_Then_Year)%>%
#             arrange(ProductServiceOrRnDarea))

```

## Services
```{r names_from=lubridate::year(dFYear)}

(
Services<-build_plot(
  data=ota_def %>% filter(ProductServiceOrRnDarea.sum=="Services (Non-R&D)"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Dollars_Obligated_OMB20_GDP20", #VAR.y.variable
  color_var="ProductServiceOrRnDarea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//psr_Services.png", Services, 
             width=12, height= 6, units="in",size=11, lineheight=1.2
             )
                           

write.csv(file="..//Output//psr_Services.csv",row.names = FALSE,
          pivot_wider(Services$data,id_cols=c(ProductServiceOrRnDarea),
                      names_from=Fiscal_Year,values_from=Dollars_Obligated_OMB20_GDP20)%>%
            arrange(ProductServiceOrRnDarea))
            

write.csv(file="..//Output//psr_Services_current.csv",row.names = FALSE,
          ota_def %>% filter(ProductServiceOrRnDarea.sum=="R&D") %>%
            format_data_for_plot(fy_var="Fiscal_Year",y_var="Dollars_Obligated_Then_Year",color_var = "ProductServiceOrRnDarea",
                                 labels_and_colors=ota_lc) %>%
          pivot_wider(id_cols=c(ProductServiceOrRnDarea),
                      names_from=Fiscal_Year,values_from=Dollars_Obligated_Then_Year)%>%
            arrange(ProductServiceOrRnDarea))

```

# SubCustomer
## Topline SubCustomer 
```{r SubCustomer}

(
SubCustomer<-build_plot(
  data=ota_def,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Dollars_Obligated_OMB20_GDP20", #VAR.y.variable
  color_var="SubCustomer.platform", #color_var
  facet_var="SubCustomer.sum", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//subcustomer.png", SubCustomer, 
             width=12, height= 6, units="in",size=11,lineheight = 1.2
             )

write.csv(file="..//Output//topline_subcustomer.csv",row.names = FALSE,
          pivot_wider(SubCustomer$data,id_cols=c(SubCustomer.sum,SubCustomer.platform),
                      names_from=Fiscal_Year,values_from=Dollars_Obligated_OMB20_GDP20))

write.csv(file="..//Output//topline_subcustomer_current.csv",row.names = FALSE,
          ota_def %>% group_by(SubCustomer.sum,ContractingSubCustomer,Fiscal_Year)%>%
            dplyr::summarize(Dollars_Obligated_Then_Year=sum(Dollars_Obligated_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(SubCustomer.sum,ContractingSubCustomer),
                      names_from=Fiscal_Year,values_from=Dollars_Obligated_Then_Year))

summary(ota_def$ContractingSubCustomer)
```

## Topline SubCustomer Cariant
```{r SubCustomer}
platpsc$SubCustomer.platform[platpsc$Contracting.Agency.ID==]
platpsc$Dollars_Obligated_OMB20_GDP20
summary(factor(platpsc$Contracting.Agency.ID))
platpsc %>% group_by(Fiscal_Year,Contracting.Agency.ID) %>% filter(Contracting.Agency.ID=="571S")%>%
  summarise(Dollars_Obligated_OMB20_GDP20=sum(Dollars_Obligated_OMB20_GDP20))

(
SubCustomer<-build_plot(
  data=platpsc,
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=detail_lc,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Dollars_Obligated_OMB20_GDP20", #VAR.y.variable
  color_var="SubCustomer.platform", #color_var
  facet_var="SubCustomer.sum", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//subcustomer.png", SubCustomer, 
             width=12, height= 6, units="in",size=11,lineheight = 1.2
             )

write.csv(file="..//Output//topline_subcustomer.csv",row.names = FALSE,
          pivot_wider(SubCustomer$data,id_cols=c(SubCustomer.sum,SubCustomer.platform),
                      names_from=Fiscal_Year,values_from=Dollars_Obligated_OMB20_GDP20))

write.csv(file="..//Output//topline_subcustomer_current.csv",row.names = FALSE,
          ota_def %>% group_by(SubCustomer.sum,ContractingSubCustomer,Fiscal_Year)%>%
            dplyr::summarize(Dollars_Obligated_Then_Year=sum(Dollars_Obligated_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(SubCustomer.sum,ContractingSubCustomer),
                      names_from=Fiscal_Year,values_from=Dollars_Obligated_Then_Year))

summary(ota_def$ContractingSubCustomer)
```


## SubCustomer Product/Service/R&D
```{r SubCustomerPSR}

(
SubCustomerPSR<-build_plot(
  data=ota_def,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Dollars_Obligated_OMB20_GDP20", #VAR.y.variable
  color_var="ProductServiceOrRnDarea.sum", #color_var
  facet_var="SubCustomer.sum", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2020 $s)")
)

# ggsave600dpi("..//Output//subcustomer_PSR.png", SubCustomerPSR, 
#              width=6.5, height= 4, units="in",size=11
#              )
ggsave600dpi("..//Output//subcustomer_PSR.png", SubCustomerPSR, 
             width=12, height= 6, units="in",size=11,lineheight = 1.2
             )
```



# Platform
## Topline  Platform
```{r Platform}

(
Platform<-build_plot(
  data=ota_def,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Dollars_Obligated_OMB20_GDP20", #VAR.y.variable
  color_var="PlatformPortfolio", #color_var
  # facet_var="PlatformPortfolio", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//ota_platform.png", Platform, 
             width=12, height= 6, units="in",size=11,lineheight = 1.2
             )

  
write.csv(file="..//Output//ota_platform_current.csv",row.names = FALSE,na="",
          format_data_for_plot(ota_def,
                               fy_var="Fiscal_Year",
                               y_var="Dollars_Obligated_Then_Year",
                               color_var="PlatformPortfolio",
                               labels_and_colors = ota_lc,
                               group=TRUE) %>%
            arrange(Fiscal_Year) %>%
          pivot_wider(id_cols=c(PlatformPortfolio),
                      names_from=Fiscal_Year,values_from=Dollars_Obligated_Then_Year) %>% 
            # mutate(PlatformPortfolio=factor(PlatformPortfolio,levels=ota_lc$variable[ota_lc$column=="PlatformPortfolio"]))%>%
            mutate(PlatformPortfolio=factor(PlatformPortfolio,levels=levels(PlatformPortfolio),
                                            labels=gsub("\\n"," ",levels(PlatformPortfolio))))%>%
                   arrange(desc(PlatformPortfolio)))

```


## Platform SubCustomer
```{r PlatformSubCustomer}

(
PlatformSubCustomer<-build_plot(
  data=ota_def,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Dollars_Obligated_OMB20_GDP20", #VAR.y.variable
  color_var="SubCustomer.platform", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//platform_subcustomer.png", PlatformSubCustomer, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

```

## Platform PSR
```{r PlatformPSR}

(
PlatformPSR<-build_plot(
  data=ota_def,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Dollars_Obligated_OMB20_GDP20", #VAR.y.variable
  color_var="ProductServiceOrRnDarea.sum", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//platform_PSR.png", PlatformPSR, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

```





## Platform Vendor
```{r PlatformVendor}

(
PlatformVendor<-build_plot(
  data=ota_def %>% filter(PlatformPortfolio!="Unlabeled" ) ,
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Dollars_Obligated_OMB20_GDP20", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//platform_vendor.png", PlatformVendor, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

```



## Platform Comp
```{r PlatformComp}

(
PlatformComp<-build_plot(
  data=ota_def %>% filter(PlatformPortfolio!="Unlabeled" ),
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Dollars_Obligated_OMB20_GDP20", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//platform_comp.png", PlatformComp, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )

```

# Army
## Army Platform
```{r ArmyPlatform}

(
ArmyPlatform<-build_plot(
  data=ota_def %>% filter(SubCustomer=="Army"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Dollars_Obligated_OMB20_GDP20", #VAR.y.variable
  color_var="PlatformPortfolio", #color_var
  # facet_var="PlatformPortfolio", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//ota_army_platform.png", ArmyPlatform, 
             width=12, height= 6, units="in",size=11,lineheight = 1.2
             )

  
write.csv(file="..//Output//ota_army_platform_current.csv",row.names = FALSE,na="",
          format_data_for_plot(ota_def %>% filter(SubCustomer=="Army"),
                               fy_var="Fiscal_Year",
                               y_var="Dollars_Obligated_Then_Year",
                               color_var="PlatformPortfolio",
                               facet="SubCustomer",
                               labels_and_colors = ota_lc,
                               group=TRUE) %>%
            arrange(Fiscal_Year) %>%
          pivot_wider(id_cols=c(SubCustomer,PlatformPortfolio),
                      names_from=Fiscal_Year,values_from=Dollars_Obligated_Then_Year) %>% 
            # mutate(PlatformPortfolio=factor(PlatformPortfolio,levels=ota_lc$variable[ota_lc$column=="PlatformPortfolio"]))%>%
            mutate(PlatformPortfolio=factor(PlatformPortfolio,levels=levels(PlatformPortfolio),
                                            labels=gsub("\\n"," ",levels(PlatformPortfolio))))%>%
                   arrange(desc(PlatformPortfolio)))

```


# Navy
## Navy Platform
```{r NavyPlatform}

(
NavyPlatform<-build_plot(
  data=ota_def %>% filter(SubCustomer=="Navy"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Dollars_Obligated_OMB20_GDP20", #VAR.y.variable
  color_var="PlatformPortfolio", #color_var
  # facet_var="PlatformPortfolio", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//ota_Navy_platform.png", NavyPlatform, 
             width=12, height= 6, units="in",size=11,lineheight = 1.2
             )

  
write.csv(file="..//Output//ota_Navy_platform_current.csv",row.names = FALSE,na="",
          format_data_for_plot(ota_def %>% filter(SubCustomer=="Navy"),
                               fy_var="Fiscal_Year",
                               y_var="Dollars_Obligated_Then_Year",
                               color_var="PlatformPortfolio",
                               facet="SubCustomer",
                               labels_and_colors = ota_lc,
                               group=TRUE) %>%
            arrange(Fiscal_Year) %>%
          pivot_wider(id_cols=c(SubCustomer,PlatformPortfolio),
                      names_from=Fiscal_Year,values_from=Dollars_Obligated_Then_Year) %>% 
            # mutate(PlatformPortfolio=factor(PlatformPortfolio,levels=ota_lc$variable[ota_lc$column=="PlatformPortfolio"]))%>%
            mutate(PlatformPortfolio=factor(PlatformPortfolio,levels=levels(PlatformPortfolio),
                                            labels=gsub("\\n"," ",levels(PlatformPortfolio))))%>%
                   arrange(desc(PlatformPortfolio)))

```


# Air Force
## Air Force Platform
```{r AirForcePlatform}

(
AirForcePlatform<-build_plot(
  data=ota_def %>% filter(SubCustomer=="Air Force"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Dollars_Obligated_OMB20_GDP20", #VAR.y.variable
  color_var="PlatformPortfolio", #color_var
  # facet_var="PlatformPortfolio", #facet_var
  column_key=ota_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//ota_air_force_platform.png", AirForcePlatform, 
             width=12, height= 6, units="in",size=11,lineheight = 1.2
             )

  
write.csv(file="..//Output//ota_air_force_platform_current.csv",row.names = FALSE,na="",
          format_data_for_plot(ota_def %>% filter(SubCustomer=="Air Force"),
                               fy_var="Fiscal_Year",
                               y_var="Dollars_Obligated_Then_Year",
                               color_var="PlatformPortfolio",
                               facet="SubCustomer",
                               labels_and_colors = ota_lc,
                               group=TRUE) %>%
            arrange(Fiscal_Year) %>%
          pivot_wider(id_cols=c(SubCustomer,PlatformPortfolio),
                      names_from=Fiscal_Year,values_from=Dollars_Obligated_Then_Year) %>% 
            # mutate(PlatformPortfolio=factor(PlatformPortfolio,levels=ota_lc$variable[ota_lc$column=="PlatformPortfolio"]))%>%
            mutate(PlatformPortfolio=factor(PlatformPortfolio,levels=levels(PlatformPortfolio),
                                            labels=gsub("\\n"," ",levels(PlatformPortfolio))))%>%
                   arrange(desc(PlatformPortfolio)))

```