---
title: "Defense Acquisition Trends"
output:
html_document:
keep_md: yes
toc: yes
date: "Wednesday, October 6, 2021"
---
  
# Setup
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from FPDS.

```{r Libraries, echo = FALSE}
 library(csis360)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(scales)

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

local_path<-get_local_lookup_path()


main.text.size<-1
note.text.size<-1.40
# if(!exists("full_data"))
#   load(file="FPDS_chart_maker//unaggregated_FPDS.Rda")
load(file=file.path("..","data","clean","fed_summary_FPDS.rda"))
load(file="../data/clean/Federal_platpscintl_FPDS.Rda")
load(file="../data/clean/OTA_contract.Rda")
# load(file="../data/clean/Defense_OTA.Rda")
load(file="../data/clean/Federal_OTA.Rda")
#Emtity Information
load(file=file.path("..","data","clean","defense_platfom_vendor.Rdata"))
rm(annual_naics2_summary,annual_naics3_summary,annual_naics4_summary,annual_naics5_summary,annual_naics6_summary,
   annual_platform_summary,annual_summary,defense_naics_vendor,defense_platform_vendor,defense_vendor)
#Dunsnumber Iformtion
load(file=file.path("..","data","clean","uav_vendor_count.Rda"))
# platformUAS_only$
defense_platformUAV_vendor<-defense_platformUAV_vendor%>%deflate(money_var="Action_Obligation_Then_Year",deflator_var="OMB23_OUT21")

load(file="../data/clean/TopVendorUAVHistoryPlatformCustomer.rda")



# load(file="../data/semi_clean/platpscintl_FPDS.Rda")
# load(file="../data/semi_clean/sw_FPDS.Rda")
# load(file="../data/clean/jadc2.Rda")

platpscintl$SubCustomer.DoD<-as.character(platpscintl$SubCustomer.sum)
platpscintl$SubCustomer.DoD[platpscintl$Customer!="Defense"]<-"Civilian"

fed_data$SubCustomer.DoD<-as.character(fed_data$SubCustomer.sum)
fed_data$SubCustomer.DoD[fed_data$ContractingCustomer!="Defense"]<-"Civilian"
def_data<-fed_data %>% filter(ContractingCustomer=="Defense")

OTA_data$SubCustomer.DoD<-as.character(OTA_data$SubCustomer.sum)
OTA_data$SubCustomer.DoD[OTA_data$Customer!="Defense"]<-"Civilian"

ota_contract$SubCustomer.DoD<-as.character(ota_contract$SubCustomer.sum)
ota_contract$SubCustomer.DoD<-as.character(ota_contract$SubCustomer.sum)

ota_lc<-prepare_labels_and_colors(OTA_data %>% select(-ContractingOfficeName,-MajorCommandName  ))#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
ota_ck<-get_column_key(OTA_data)#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")

ota_contract_lc<-prepare_labels_and_colors(ota_contract)#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
ota_contract_ck<-get_column_key(ota_contract)#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")


fed_lc<-prepare_labels_and_colors(platpscintl)#,path="C:\\Users\\gsand\\Repositories\\Lookup-Tables\\style\\")
                                  #)#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
fed_ck<-get_column_key(platpscintl)#,path="C:\\Users\\gsand\\Repositories\\Lookup-Tables\\style\\")
uav_lc<-prepare_labels_and_colors(defense_platformUAV_vendor)#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
uav_ck<-get_column_key(defense_platformUAV_vendor)#,path#="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
def_data<-fed_data %>% filter(ContractingCustomer=="Defense")

# detail_lc<-prepare_labels_and_colors(platpscintl,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
# detail_ck<-get_column_key(platpscintl,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")


# drone %>% group_by(Customer) %>% summarise(Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22,na.rm=TRUE))
japan_log_path<-file.path(get_local_sharepoint_path("JAPAN-DIIG Project - General"),"Data")
japan_repo_path<-"../../Trade/output/Japan/"
```


## Preprocess
```{r PreprocessProjectDrone}

droneEO<-platpscintl %>% filter(PlatformPortfolioUAV=="Remotely Crewed" |
                                  ProductOrServiceCode %in% c("1220","1240","1280","3635","5850",
                                                              "5855","6008","6031","6033","6650")) 
droneEO$CaseStudy<-NA
droneEO$CaseStudy[droneEO$PlatformPortfolioUAV=="Remotely Crewed"]<-"Remotely Crewed"
droneEO$CaseStudy[droneEO$ProductOrServiceCode %in% c("1220","1240","1280","3635","5850",
                                                              "5855","6008","6031","6033","6650")]<-"Electro-Optical Sensors"
drone<-platpscintl %>% filter(PlatformPortfolioUAV=="Remotely Crewed")

platpscintl$PlatformPortfolioUAVEO<-as.character(platpscintl$PlatformPortfolioUAV)
platpscintl$PlatformPortfolioUAVEO[platpscintl$ProductOrServiceCode %in% c("1220","1240","1280","3635","5850",
                                                              "5855","6008","6031","6033","6650")]<-"EO Sensors"

# drone <-drone %>% select(-ProductOrServiceCodeText.y,-TopPScode,-TopPStext)
colnames(drone)[colnames(drone)=="ProductOrServiceCodeText.x"]<-"ProductOrServiceCodeText"
colnames(drone)[colnames(drone)=="Project.Name"]<-"ProjectName"

summary(factor(drone$ProjectName))

droneplat<-drone %>%
  mutate(ProjectName=ifelse(ProjectName=="Other UAS",NA,ProjectName)) %>%
  group_by(ProjectName) %>%
  dplyr::summarise(Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB24_GDP22,0)),
                                              Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22)
                   )%>%
  group_by () %>%#PlatformPortfolioUAV
  mutate(rank_total=rank(desc(Action_Obligation_OMB24_GDP22)),
         rank_2020=rank(desc(Action_Obligation_2020)))
droneplat %>% arrange(desc(Action_Obligation_OMB24_GDP22))


droneplat$TopProject<-
  ifelse(droneplat$rank_2020<=7 | droneplat$rank_total<=7,droneplat$ProjectName,NA)

drone<-left_join(drone,droneplat %>% dplyr::select(-Action_Obligation_OMB24_GDP22,-Action_Obligation_2020),
                 by=c("ProjectName"))

drone$TopProject[is.na(drone$TopProject) & !is.na(drone$ProjectName)]<-
  "Other Labeled Project"


summary(factor(drone$TopProject))

dronePSC<-drone %>% group_by (ProductOrServiceCode,ProductOrServiceCodeText) %>%
  summarise(
            Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB24_GDP22,0)),
                                       Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22))%>%
  group_by () %>%
  mutate(rank_total=rank(desc(Action_Obligation_OMB24_GDP22)),
         rank_2020=rank(desc(Action_Obligation_2020)))
dronePSC %>% arrange(desc(Action_Obligation_OMB24_GDP22))

dronePSC$dronePSCode<-
  ifelse(dronePSC$rank_2020<=7 | dronePSC$rank_total<=7,dronePSC$ProductOrServiceCode,NA)
dronePSC$TopPStext<-
  ifelse(dronePSC$rank_2020<=7 | dronePSC$rank_total<=7,dronePSC$ProductOrServiceCodeText,NA)


drone<-left_join(drone,dronePSC %>% select(-Action_Obligation_OMB24_GDP22,
                                           -Action_Obligation_2020,-ProductOrServiceCodeText),
                 by=c("ProductOrServiceCode"))

drone$dronePSCode[is.na(drone$dronePSCode) & !is.na(drone$ProductOrServiceCode)]<-
  "Other Labeled PSC"
drone$TopPStext[is.na(drone$TopPStext) & !is.na(drone$ProductOrServiceCode)]<-
  "Other Labeled PSC"

drone$TopPStext<-factor_wrap(drone$TopPStext)

summary(factor(drone$TopPStext))

drone %>% dplyr::group_by(ProjectName, IsRemotelyOperated)  %>% dplyr::summarise(Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22))%>%
  arrange(-Action_Obligation_OMB24_GDP22)
                                                         
                                                                                 

```


# Budget Pull in
Read in the Reaching Farther, Risking Less Budget report.
## Budget
```{r budget}
procurement_uas<-readr::read_delim(file = file.path("..","data","semi_clean","Procurement_Uncrewed_Labeled.txt"),delim="\t",guess_max=3000)
# procurement_remote<-readr::read_delim(file = file.path("..","data","semi_clean","Procurement_Just_Remote.txt"),delim="\t",guess_max=3000)

summary(factor(procurement_uas$Uncrewed.Domain))
colnames(procurement_uas)<-gsub(" ",".",colnames(procurement_uas))
procurement_uas<-procurement_uas%>%dplyr::filter(Crew.Status==2 &
                                                         Uncrewed.Domain %in% c("Aerial","Multi-domain"))



rdte_uas<-readr::read_delim(file = file.path("..","data","semi_clean","RDTE_Remote_Labeled.txt"),delim="\t",guess_max=3000)
colnames(rdte_uas)<-gsub(" ",".",colnames(rdte_remote))
summary(factor(rdte_uas$Domain))

rdte_uas<-rdte_uas%>%dplyr::filter(Crew.Status==2&Domain %in% c("Aerial","Multi-Domain"))



p_long<-procurement_remote %>% pivot_longer(cols=as.character(c(1999:2025)),names_to="Fiscal_Year",values_to="Funding_Const")
r_long<-rdte_remote %>% pivot_longer(cols=as.character(c(1999:2025)),names_to="Fiscal_Year",values_to="Funding_Const")

r_long$Funding_Const<-text_to_number(r_long$Funding_Const)
p_long$Funding_Const<-text_to_number(p_long$Funding_Const)
r_long$Funding_Const<-r_long$Funding_Const*1000
p_long$Funding_Const<-p_long$Funding_Const*1000
colnames(p_long)[colnames(p_long)=="Service"]<-"Subcustomer"
colnames(r_long)[colnames(r_long)=="Service"]<-"Subcustomer"
colnames(p_long)[colnames(p_long)=="Uncrewed.Domain"]<-"Domain"
p_long$ColorOfMoney<-"Procurement"
r_long$ColorOfMoney<-"RDT&E"
inv_long<-rbind(p_long %>%select(Subcustomer,Fiscal_Year,Funding_Const,ColorOfMoney,Domain),
      r_long %>%select(Subcustomer,Fiscal_Year,Funding_Const,ColorOfMoney,Domain))
inv_long$dFYear<-as.Date(paste(inv_long$Fiscal_Year,"1","1",sep="-"))
inv_long$Domain<-factor(inv_long$Domain)
levels(inv_long$Domain)<-list("Aerial"="Aerial"  ,
                              "Ground"="Ground",
                              "Maritime"=c("Maritime (Surface and Undersea)", "Maritime S","Maritime U","Maritime (S&U)"),
                              "Multi-Domain"=c("Multi-domain","Multi-Domain"))

inv_long$Fiscal_Year

write.csv(file="..//Output//Remotely_Crewed//Remotely_Crewed_budget.csv",row.names = FALSE,na = "",
          inv_long %>%
            group_by(Fiscal_Year,ColorOfMoney,Subcustomer)%>%
            summarise(#Fiscal_Year=lubridate::year(dFYear),
              mFunding_Const=sum(Funding_Const,na.rm=TRUE)/1000000)%>%
            arrange(Fiscal_Year)%>%
            pivot_wider(id_cols=c(Subcustomer,ColorOfMoney),
                        names_from=Fiscal_Year,values_from=mFunding_Const)%>%
            arrange(ColorOfMoney,Subcustomer))


```


# Obligations
 
## OTA

### Platform Compare
```{r}

load(file="../data/clean/Federal_OTA.Rda")

write.csv(file="DIU.csv",(OTA_data[grep("DIU", OTA_data$Description_of_Requirement),]%>% filter(PlatformPortfolioUAV=="Remotely Crewed")))

write.csv(file="ArmyUAS.csv",(OTA_data[grep("DIU", OTA_data$Description_of_Requirement),]%>% filter(PlatformPortfolioUAV=="Remotely Crewed")))

(
  co_pp_simplearea<-build_plot(
    data=OTA_data,# %>% filter(IsOTA=="OTA") ,
    chart_geom = "Bar Chart",
    share = FALSE,
    # labels_and_colors=drone_lc,
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
    color_var="SimpleArea", #color_var
    facet_var="PlatformPortfolioUAV", #facet_var
    # second_var="IsOTA", #facet_var
    # column_key=drone_ck,
    format=TRUE,
    ytextposition=FALSE
  )+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "right")+
    labs(y="Obligations (Constant 2022 $s)",caption="Note: Unlabeled not shown. Source: FPDS and CSIS analysis.")+
   facet_wrap(~PlatformPortfolioUAV,scale="free_y")
)


(
  co_pp_type<-build_plot(
    data=OTA_data,# %>% filter(IsOTA=="OTA") ,
    chart_geom = "Bar Chart",
    share = FALSE,
    # labels_and_colors=drone_lc,
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
    color_var="TypeOfAgreement", #color_var
    facet_var="PlatformPortfolioUAV", #facet_var
    # second_var="IsOTA", #facet_var
    # column_key=drone_ck,
    format=TRUE,
    ytextposition=FALSE
  )+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "right")+
    labs(y="Obligations (Constant 2022 $s)",caption="Note: Unlabeled not shown. Source: FPDS and CSIS analysis.")+
   facet_wrap(~PlatformPortfolioUAV,scale="free_y")
)
(
  co_pp_nontrad<-build_plot(
    data=OTA_data,# %>% filter(IsOTA=="OTA") ,
    chart_geom = "Bar Chart",
    share = FALSE,
    # labels_and_colors=drone_lc,
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
    color_var="NontraditionalGovernmentContractorParticipationDescription", #color_var
    facet_var="PlatformPortfolioUAV", #facet_var
    # second_var="IsOTA", #facet_var
    # column_key=drone_ck,
    format=TRUE,
    ytextposition=FALSE
  )+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "bottom")+
    labs(y="Obligations (Constant 2022 $s)",caption="Note: Unlabeled not shown. Source: FPDS and CSIS analysis.")+
   facet_wrap(~PlatformPortfolioUAV,scale="free_y")
)


(
  co_pp_sub<-build_plot(
    data=OTA_data,# %>% filter(IsOTA=="OTA") ,
    chart_geom = "Bar Chart",
    share = FALSE,
    # labels_and_colors=drone_lc,
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
    color_var="SubCustomer.OTA", #color_var
    facet_var="PlatformPortfolioUAV", #facet_var
    # second_var="IsOTA", #facet_var
    # column_key=drone_ck,
    format=TRUE,
    ytextposition=FALSE
  )+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "bottom")+
    labs(y="Obligations (Constant 2022 $s)",caption="Note: Unlabeled not shown. Source: FPDS and CSIS analysis.")+
   facet_wrap(~PlatformPortfolioUAV,scale="free_y")
)

```

### OTA customer
```{r}

  
  (
    uas_ota_sub<-build_plot(
      data=OTA_data %>% filter(PlatformPortfolioUAV=="Remotely Crewed" & Fiscal_Year<=2021) ,
      chart_geom = "Bar Chart",
      share = FALSE,
      labels_and_colors=ota_lc,
      # NA, #VAR.ncol
      x_var="dFYear", #x_var
      y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
      color_var="SubCustomer.DoD", #color_var
      # facet_var="SubCustomer.DoD", #facet_var
      # second_var="IsOTA", #facet_var
      column_key=ota_lc,
      format=TRUE,
      ytextposition=FALSE
    )+
      # theme(strip.text.y = element_text(angle=0))+
      # theme(axis.text.x = element_text(angle=90))+
      #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
      #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
      #             )+labs(title=NULL,
      # x="Fiscal Year",
      # y="Percent of Obligations",
      # color="Competition")+
      theme(legend.position = "right")+
      labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.")#+
     # facet_wrap(~PlatformPortfolioUAV,scale="free_y")
  )
  
  
  
  ggsave600dpi(uas_ota_sub,file="..//output//Remotely_Crewed//uas_ota_sub.png",  
               width=3.5, height= 3, units="in",size=12, lineheight=1.2
  )
  ggsave600dpi(uas_ota_sub,file="..//output//Remotely_Crewed//uas_ota_sub.svg",  
               width=3.5, height= 3, units="in",size=12, lineheight=1.2
  )

(
  uas_ota_subcust<-build_plot(
    data=OTA_data %>% filter(PlatformPortfolioUAV=="Remotely Crewed") ,
    chart_geom = "Bar Chart",
    share = FALSE,
    labels_and_colors=ota_lc,
    # NA, #VAR.ncol
    x_var="Fiscal_Year", #x_var
    y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
    color_var="SubCustomer.DoD", #color_var
    # facet_var="SubCustomer.DoD", #facet_var
    # second_var="IsOTA", #facet_var
    column_key=ota_lc,
    format=TRUE,
    ytextposition=FALSE
  )+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "bottom")+
    labs(y="Obligations (Constant 2022 $s)",caption="Note: Unlabeled not shown. Source: FPDS and CSIS analysis.")#+
   # facet_wrap(~PlatformPortfolioUAV,scale="free_y")
)



ggsave600dpi(uas_ota_subcust,file="..//output//Remotely_Crewed//uas_ota_subcust.png",  
             width=3.25, height= 3, units="in",size=12, lineheight=1.2
)
ggsave600dpi(uas_ota_subcust,file="..//output//Remotely_Crewed//uas_ota_subcustsvg",  
             width=3.25, height= 3, units="in",size=12, lineheight=1.2
)

write.csv(file="..//Output//Remotely_Crewed//uas_ota_subcust.csv",row.names = FALSE,na = "",
          uas_ota_subcust$data %>% mutate(#Fiscal_Year=lubridate::year(dFYear),
            bAction_Obligation_OMB24_GDP22=Action_Obligation_OMB24_GDP22/1000000000)%>%
            arrange(Fiscal_Year)%>%
            pivot_wider(id_cols=c(SubCustomer.DoD),
                        names_from=Fiscal_Year,values_from=bAction_Obligation_OMB24_GDP22)%>%
            arrange(SubCustomer.DoD),na="")


```


## Simple  Area
```{r drone_simplearea}

(
  rc_psr<-build_plot(
    data=drone  ,
    chart_geom = "Bar Chart",
    share = FALSE,
    # labels_and_colors=drone_lc,
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
    color_var="SimpleArea", #color_var
    facet_var="SimpleArea", #facet_var
    # column_key=drone_ck,
    format=TRUE,
    ytextposition=FALSE
  )+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "right")+
    labs(y="Obligations (Constant 2022 $s)",caption="Note: Unlabeled not shown. Source: FPDS and CSIS analysis.")#+
  # facet_wrap(~ContractingAgencyTextSwr,ncol=4)
)

ggsave600dpi(rc_psr,file="..//output//Remotely_Crewed//Remotely_Crewed_psr.png",  
             width=13, height= 6, units="in",size=8, lineheight=1.2
)
ggsave600dpi(rc_psr,file="..//output//Remotely_Crewed//Remotely_Crewed_psr.eps",  
             width=13, height= 6, units="in",size=16, lineheight=1.2
)

# write.csv(file="..//Output//Remotely_Crewed//Remotely_Crewed_psr.csv",row.names = FALSE,na = "",
#           rc_psr$data %>% mutate(#Fiscal_Year=lubridate::year(dFYear),
#             bAction_Obligation_OMB24_GDP22=Action_Obligation_OMB24_GDP22/1000000000)%>%
#             arrange(Fiscal_Year)%>%
#             pivot_wider(id_cols=c(SimpleArea),
#                         names_from=Fiscal_Year,values_from=bAction_Obligation_OMB24_GDP22)%>%
#             arrange(SimpleArea),na="")

output_TY<-drone %>%   group_by(SimpleArea,Fiscal_Year)%>%
  dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
  arrange(Fiscal_Year) %>%
  pivot_wider(id_cols=c(SimpleArea),
              names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year) %>%
  arrange(SimpleArea)
write.csv(file="..//Output//Remotely_Crewed//Remotely_Crewed_psr_cur.csv",row.names = FALSE, na = "",
          output_TY)


output_TY<-drone %>%   group_by(SubCustomer.DoD,SimpleArea,Fiscal_Year)%>%
  dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
  arrange(Fiscal_Year) %>%
  pivot_wider(id_cols=c(SubCustomer.DoD,SimpleArea),
              names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year) %>%
  arrange(SubCustomer.DoD,SimpleArea)
write.csv(file="..//Output//Remotely_Crewed//Remotely_Crewed_Customer_psr_cur.csv",row.names = FALSE, na = "",
          output_TY)



(
  rceo_psr<-build_plot(
    data=droneEO ,
    chart_geom = "Bar Chart",
    share = FALSE,
    # labels_and_colors=drone_lc,
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
    color_var="SimpleArea", #color_var
    facet_var="CaseStudy", #facet_var
    second_var = "SimpleArea",
    # column_key=drone_ck,
    format=TRUE,
    ytextposition=FALSE
  )+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "right")+
    labs(y="Obligations (Constant 2022 $s)",caption="Note: Unlabeled not shown. Source: FPDS and CSIS analysis.")#+
  # facet_wrap(~ContractingAgencyTextSwr,ncol=4)
)

log_plot(plot=rceo_psr, df=droneEO %>% dplyr::filter(  lubridate::year(dFYear)>=1990 & 
                                                                            lubridate::year(dFYear)<=2023),
           filename="UAS_EO_PSR",xlsx="Japan_Def_Coop.xlsx",suppress_text = FALSE,
           sheet="PSR",path=japan_repo_path,second_path=japan_log_path, height=3.5,
           format=TRUE,#var_list=c("FlowText","StateRegionJapan"),
           output_doc_png=TRUE,excel_y_var=TRUE
  )
```

### Simple Area Def Platform

```{r drone_simplearea}

(
  rc_psr_plat<-build_plot(
    data=platpscintl %>% filter(Fiscal_Year>=2010,PlatformPortfolioUAV!="Unlabeled"& Customer=="Defense"&
                               !PlatformPortfolioUAV %in% c("Facilities and Construction",
                                                            "Other Products",
                                                            "Other R&D and Knowledge Based",
                                                            "Other Services")),
    chart_geom = "Bar Chart",
    share = FALSE,
    labels_and_colors=fedpsc_lc,
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
    color_var="SimpleArea", #color_var
    facet_var="PlatformPortfolioUAV", #facet_var
    column_key=fedpsc_ck,
    format=TRUE,
    ytextposition=FALSE
  )+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "bottom")+
    labs(y="Obligations (Constant 2022 $s)",caption="Note: Unlabeled not shown. Source: FPDS and CSIS analysis.")+
    facet_wrap(~PlatformPortfolioUAV,ncol=4,scale="free_y")
)

(
  rc_psr_plat_share<-build_plot(
    data=platpscintl %>% filter(Fiscal_Year>=2010,PlatformPortfolioUAV!="Unlabeled"& Customer=="Defense"&
                               !PlatformPortfolioUAV %in% c("Facilities and Construction",
                                                            "Other Products",
                                                            "Other R&D and Knowledge Based",
                                                            "Other Services")),
    chart_geom = "Line Chart",
    share = TRUE,
    labels_and_colors=fedpsc_lc,
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
    color_var="SimpleArea", #color_var
    facet_var="PlatformPortfolioUAV", #facet_var
    column_key=fedpsc_ck,
    format=TRUE,
    ytextposition=FALSE
  )+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "bottom")+
    labs(y="Share of Obligations",caption="Note: Unlabeled not shown. Source: FPDS and CSIS analysis.")+
    facet_wrap(~PlatformPortfolioUAV,ncol=4)
)


ggsave600dpi(rc_psr_plat,file="..//output//Remotely_Crewed//def_platUAS_psr.png",  
             width=6.5, height= 3.5, units="in",size=12, lineheight=1.2
)
ggsave600dpi(rc_psr_plat,file="..//output//Remotely_Crewed//def_platUAS_psr.svg",  
             width=6.5, height= 3.5, units="in",size=12, lineheight=1.2
)

(gridExtra::grid.arrange(rc_psr_plat+labs(caption=NULL),
                                    rc_psr_plat_share))

ggsave(gridExtra::grid.arrange(rc_psr_plat+labs(caption=NULL),
                                    rc_psr_plat_share),file="..//output//Remotely_Crewed//def_platUAS_psr_share.png",  
             width=6.5, height= 7, units="in")#,size=12, lineheight=1.2

ggsave(gridExtra::grid.arrange(rc_psr_plat+labs(caption=NULL),
                                    rc_psr_plat_share),file="..//output//Remotely_Crewed//def_platUAS_psr_share.svg",  
             width=6.5, height= 7, units="in")#,size=12, lineheight=1.2


write.csv(file="..//Output//Remotely_Crewed//def_platUAS_psr.csv",row.names = FALSE,na = "",
          rc_psr_plat$data %>% mutate(Fiscal_Year=lubridate::year(dFYear),
            bAction_Obligation_OMB24_GDP22=Action_Obligation_OMB24_GDP22/1000000000)%>%
            arrange(Fiscal_Year)%>%
            pivot_wider(id_cols=c(PlatformPortfolioUAV,SimpleArea),
                        names_from=Fiscal_Year,values_from=bAction_Obligation_OMB24_GDP22)%>%
            arrange(PlatformPortfolioUAV,SimpleArea))

output_TY<-fed_data %>% filter(ContractingCustomer=="Defense") %>%   group_by(SimpleArea,PlatformPortfolioUAV,Fiscal_Year)%>%
  dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
  arrange(Fiscal_Year) %>%
  pivot_wider(id_cols=c(PlatformPortfolioUAV,SimpleArea),
              names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year) %>%
  arrange(PlatformPortfolioUAV,SimpleArea)
write.csv(file="..//Output//Remotely_Crewed//def_platUAS_cur.csv",row.names = FALSE, na = "",
          output_TY)



```

## Customer 

### Simple Customer
```{r drone_customer}

# drone %>% group_by(claimantprogramcode,ClaimantProgramCodeText) %>% 
#   summarise(Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22))
# drone$SubCustomer
(
  rc_customer<-build_plot(
    data=drone %>% filter(Fiscal_Year>=2010) ,
    chart_geom = "Bar Chart",
    share = FALSE,
    labels_and_colors=uav_lc,
    column_key=uav_ck,
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
    color_var="SubCustomer.DoD", #color_var
    facet_var="SubCustomer.DoD", #facet_var
    format=TRUE,
    ytextposition=FALSE
  )+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "right")+
    labs(
      y="Obligations (Constant 2022 $s)",caption="Note: Unlabeled not shown. Source: FPDS and CSIS analysis.")#+
  # facet_wrap(~ContractingAgencyTextSwr,ncol=4)
)

(
  eorc_customer<-build_plot(
    data=droneEO %>% filter(Fiscal_Year>=2010) ,
    chart_geom = "Bar Chart",
    share = FALSE,
    labels_and_colors=uav_lc,
    column_key=uav_ck,
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
    color_var="SubCustomer.DoD", #color_var
    alpha_var="YTD",
    facet_var="CaseStudy", #facet_var
    second_var="SubCustomer.DoD",
    format=TRUE,
    ytextposition=FALSE
  )+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "right")+
    labs(title="U.S. Federal UAS and EO Sensor Contracts by Customer",
         y="Obligations (Constant 2022 $s)",caption="Note: Unlabeled not shown. Source: FPDS and CSIS analysis.")#+
  # facet_wrap(~ContractingAgencyTextSwr,ncol=4)
)

ggsave600dpi(rc_customer,file="..//output//Remotely_Crewed//Remotely_Crewed_Customer.png",  
             width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
)
ggsave600dpi(rc_customer,file="..//output//Remotely_Crewed//Remotely_Crewed_Customer.svg",  
             width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
)
ggsave600dpi(rc_customer,file="..//output//Remotely_Crewed//Remotely_Crewed_Customer.emf",  
             width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
)

write.csv(file="..//Output//Remotely_Crewed//Remotely_Crewed_Customer.csv",row.names = FALSE,na = "",
          rc_customer$data %>% mutate(Fiscal_Year=lubridate::year(dFYear),
            bAction_Obligation_OMB24_GDP22=Action_Obligation_OMB24_GDP22/1000000000)%>%
            arrange(Fiscal_Year)%>%
            pivot_wider(id_cols=c(SubCustomer.DoD),
                        names_from=Fiscal_Year,values_from=bAction_Obligation_OMB24_GDP22)%>%
            arrange(SubCustomer.DoD))



output_TY<-drone %>%   group_by(SubCustomer.DoD,Fiscal_Year)%>%
  dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
  arrange(Fiscal_Year) %>%
  pivot_wider(id_cols=c(SubCustomer.DoD),
              names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year) %>%
  arrange(SubCustomer.DoD)
write.csv(file="..//Output//Remotely_Crewed//Remotely_Crewed_Customer_cur.csv",row.names = FALSE, na = "",
          output_TY)

log_plot(plot=eorc_customer, df=droneEO %>% dplyr::filter( 
                                                                            lubridate::year(dFYear)>=1990 & 
                                                                            lubridate::year(dFYear)<=2023),
           filename="UAS_EO_Customer",xlsx="Japan_Def_Coop.xlsx",suppress_text = FALSE,
           sheet="Customer",path=japan_repo_path,second_path=japan_log_path, height=3.5,
           format=TRUE,#var_list=c("FlowText","StateRegionJapan"),
           output_doc_png=TRUE,excel_y_var=TRUE
  )

```


### UAS Customer Top Project
```{r drone_customer}

# drone %>% group_by(claimantprogramcode,ClaimantProgramCodeText) %>% 
#   summarise(Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22))
# drone$SubCustomer
summary(factor(drone$TopProject))
# drone$TopProject<-u

drone$TopProjectLabel<-factor(drone$TopProject  )
drone<-replace_nas_with_unlabeled(drone,"TopProjectLabel","Other UAS")

levels(drone$TopProjectLabel)<-list(
  "Tactical UAV" ="TACTICAL UAV",
   "MQ-1C Gray Eagle"="MQ-1C Gray Eagle",
      "RQ-4 Global Hawk" =c("GLOBAL HAWK", "RQ-4 Global Hawk"),
      "MQ-4C Triton"=c("BAMS","MQ-4C Triton"),
  "MQ-8 Fire Scout"=c("VTUAV","MQ-8 Fire Scout"),
   "MQ-9 Reaper" = "MQ-9 Reaper",
  "MQ-25 Stingray"="MQ-25 Stingray",
  "Other, multiple,\nor unspecified UAS"=c("Other Labeled Project","Other UAS"))

(
  rc_custproj<-build_plot(
    data=drone %>% filter(Fiscal_Year>=2010) ,
    chart_geom = "Bar Chart",
    share = FALSE,
    labels_and_colors=fed_lc,
    column_key=fed_ck,
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
    color_var="TopProjectLabel", #color_var
    facet_var="SubCustomer.DoD", #facet_var
    format=TRUE,
    ytextposition=FALSE
  )+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "right")+
    labs(title="US Federal Contracting for UAS\nby Customer and Project",
         y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.")#+
  # facet_wrap(~ContractingAgencyTextSwr,ncol=4)
)

ggsave600dpi(rc_custproj,file="..//output//Remotely_Crewed//Remotely_Crewed_Customer_Project.png",  
             width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
)
ggsave600dpi(rc_custproj,file="..//output//Remotely_Crewed//Remotely_Crewed_Customer_Project.svg",  
             width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
)
ggsave600dpi(rc_custproj,file="..//output//Remotely_Crewed//Remotely_Crewed_Customer_Project.emf",  
             width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
)

write.csv(file="..//Output//Remotely_Crewed//Remotely_Crewed_Customer_Project.csv",row.names = FALSE,na = "",
          rc_custproj$data %>% mutate(Fiscal_Year=lubridate::year(dFYear),
            bAction_Obligation_OMB24_GDP22=Action_Obligation_OMB24_GDP22/1000000000)%>%
            arrange(Fiscal_Year)%>%
            pivot_wider(id_cols=c(SubCustomer.DoD,TopProjectLabel),
                        names_from=Fiscal_Year,values_from=bAction_Obligation_OMB24_GDP22)%>%
            arrange(SubCustomer.DoD,TopProjectLabel))



output_TY<-drone %>%   group_by(SubCustomer.DoD,TopProjectLabel,Fiscal_Year)%>%
  dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
  arrange(Fiscal_Year) %>%
  pivot_wider(id_cols=c(SubCustomer.DoD,TopProjectLabel),
              names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year) %>%
  arrange(SubCustomer.DoD,TopProjectLabel)
write.csv(file="..//Output//Remotely_Crewed//Remotely_Crewed_Customer_Proj_cur.csv",row.names = FALSE, na = "",
          output_TY)

log_plot(plot=rc_custproj, df=drone,
           filename="UAS_Customer_Proj",xlsx="Japan_Def_Coop.xlsx",suppress_text = FALSE,
           sheet="UAScustProj",path=japan_repo_path,second_path=japan_log_path, height=3.5,
           format=TRUE,#var_list=c("FlowText","StateRegionJapan"),
           output_doc_png=TRUE,excel_y_var=TRUE
  )

```

### EO Customer Top PSC
```{r drone_customer}

droneEO %>% filter(CaseStudy=="Electro-Optical Sensors") %>% group_by(ProductOrServiceCodeText) %>%
  summarise(Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22,na.rm=TRUE))

droneEO$PSCsum<-factor(droneEO$ProductOrServiceCodeText)

# drone$TopProjectLabel<-factor(drone$TopProject  )
# drone<-replace_nas_with_unlabeled(drone,"TopProjectLabel","Other UAS")
# 
levels(droneEO$PSCsum)<-list(
  "Fire Control"=c("AIRCRAFT BOMBING FIRE CONT COMPS","FIRE CONT COMPUTING SIGHTS & DEVICE"),
  "NIGHT VISION EQ"="NIGHT VISION EQ",
  "OPTICAL SIGHTING & RANGING EQUIPMENT"="OPTICAL SIGHTING & RANGING EQUIPMEN",
  "LIGHT COMMUNICATION EQUIPMENT"="VISIBLE AND INVISIBLE LIGHT COMMUNICATION EQUIPMENT",
  "Other EO Sensors and Related"=c("INTEGRATED OPTICAL CIRCUITS","CRYSTAL & GLASS INDUSTRIES MACHINE",
                       "FIBER OPTIC PHOTO DETECTORS","OPTICAL INSTRUMENTS",
                       "OPTICAL MULTIPLEXERS/DEMULTIPLEXERS")
)

# levels(drone$TopProjectLabel)<-list(
#   "Tactical UAV" ="TACTICAL UAV",
#    "MQ-1C Gray Eagle"="MQ-1C Gray Eagle",
#       "RQ-4 Global Hawk" =c("GLOBAL HAWK", "RQ-4 Global Hawk"),
#       "MQ-4C Triton"=c("BAMS","MQ-4C Triton"),
#   "MQ-8 Fire Scout"=c("VTUAV","MQ-8 Fire Scout"),
#    "MQ-9 Reaper" = "MQ-9 Reaper",
#   "MQ-25 Stingray"="MQ-25 Stingray",
#   "Other, multiple,\nor unspecified UAS"=c("Other Labeled Project","Other UAS"))

(
  eo_custproj<-build_plot(
    data=droneEO %>% filter(Fiscal_Year>=2010 & CaseStudy=="Electro-Optical Sensors") ,
    chart_geom = "Bar Chart",
    share = FALSE,
    labels_and_colors=fed_lc,
    column_key=fed_ck,
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
    color_var="PSCsum", #color_var
    facet_var="SubCustomer.DoD", #facet_var
    format=TRUE,
    ytextposition=FALSE
  )+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "right")+
    labs(title="US Federal Contracting for EO Senors\nby Customer and Product Code",
         y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.")#+
  # facet_wrap(~ContractingAgencyTextSwr,ncol=4)
)


log_plot(plot=eo_custproj, df=droneEO %>% filter(CaseStudy=="Electro-Optical Sensors"),
           filename="EO_Customer_PSC",xlsx="Japan_Def_Coop.xlsx",suppress_text = FALSE,
           sheet="EOcustPSC",path=japan_repo_path,second_path=japan_log_path, height=3.5,
           format=TRUE,#var_list=c("FlowText","StateRegionJapan"),
           output_doc_png=TRUE,excel_y_var=TRUE
  )

```

## Commercial 
### Commercial Subcustomer
```{r drone_customer}

fed_data<-fed_data %>% group_by(SubCustomer.DoD,Fiscal_Year) %>%
  dplyr::mutate(pAction_Obligation_SubCustomer=
                     Action_Obligation_Then_Year/sum(Action_Obligation_Then_Year,rm=TRUE))

(
  rc_customer<-build_plot(
    data=fed_data %>% filter(Fiscal_Year>=2010&AnyCommercial %in% c('Y',"NonDev","Other OTA")&ContractingCustomer=="Defense"&
                            PlatformPortfolioUAV=="Remotely Crewed") ,
    chart_geom = "Line Chart",
    share = FALSE,
    labels_and_colors=fed_lc,
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="pAction_Obligation_SubCustomer", #VAR.y.variable
    color_var="SubCustomer.DoD", #color_var
    # facet_var="SubCustomer.DoD", #facet_var
    column_key=fed_ck,
    format=TRUE,
    ytextposition=FALSE
  )+coord_cartesian(ylim=c(0,1))+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "right")+
    labs(y="Obligations (Constant 2022 $s)",caption="Note: Unlabeled not shown. Source: FPDS and CSIS analysis.")#+
  # facet_wrap(~ContractingAgencyTextSwr,ncol=4)
)


(
  rc_commercial<-build_plot(
    data=fed_data %>% filter(Fiscal_Year>=2010&AnyCommercial %in% c('Y',"NonDev","Other OTA")&
                            PlatformPortfolioUAV=="Remotely Crewed"),
    chart_geom = "Line Chart",
    share = FALSE,
    labels_and_colors=fed_lc,
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
    color_var="SubCustomer.DoD", #color_var
    # facet_var="SubCustomer.DoD", #facet_var
    column_key=fed_ck,
    format=TRUE,
    ytextposition=FALSE
  )+#+coord_cartesian(ylim=c(0,1))+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "right")+
    labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis."
         ,title="UAS obligations using any\ncommercial contracting approaches")
  # facet_wrap(~SubCustomer.DoD,nrow=1)
)


# 
ggsave600dpi(rc_commercial,file="..//output//Remotely_Crewed//Remotely_Crewed_Commercial.png",
             width=3.5, height= 3.5, units="in",size=11, lineheight=1.2
)
# ggsave600dpi(rc_customer,file="..//output//Remotely_Crewed//Remotely_Crewed_Customer.svg",  
#              width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
# )
# ggsave600dpi(rc_customer,file="..//output//Remotely_Crewed//Remotely_Crewed_Customer.emf",  
#              width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
# )
# 
# write.csv(file="..//Output//Remotely_Crewed//Remotely_Crewed_Customer.csv",row.names = FALSE,na = "",
#           rc_customer$data %>% mutate(#Fiscal_Year=lubridate::year(dFYear),
#             bAction_Obligation_OMB24_GDP22=Action_Obligation_OMB24_GDP22/1000000000)%>%
#             arrange(Fiscal_Year)%>%
#             pivot_wider(id_cols=c(SubCustomer.DoD),
#                         names_from=Fiscal_Year,values_from=bAction_Obligation_OMB24_GDP22)%>%
#             arrange(SubCustomer.DoD))
# 
# 
# 
# output_TY<-drone %>%   group_by(SubCustomer.DoD,Fiscal_Year)%>%
#   dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
#   arrange(Fiscal_Year) %>%
#   pivot_wider(id_cols=c(SubCustomer.DoD),
#               names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year) %>%
#   arrange(SubCustomer.DoD)
# write.csv(file="..//Output//Remotely_Crewed//Remotely_Crewed_Customer_cur.csv",row.names = FALSE, na = "",
#           output_TY)


  (
    uas_ota_sub<-build_plot(
      data=OTA_data %>% filter(PlatformPortfolioUAV=="Remotely Crewed" & Fiscal_Year<=2021) ,
      chart_geom = "Bar Chart",
      share = FALSE,
      labels_and_colors=ota_lc,
      # NA, #VAR.ncol
      x_var="dFYear", #x_var
      y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
      color_var="SubCustomer.DoD", #color_var
      # facet_var="SubCustomer.DoD", #facet_var
      # second_var="IsOTA", #facet_var
      column_key=ota_lc,
      format=TRUE,
      ytextposition=FALSE
    )+
      # theme(strip.text.y = element_text(angle=0))+
      # theme(axis.text.x = element_text(angle=90))+
      #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
      #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
      #             )+labs(title=NULL,
      # x="Fiscal Year",
      # y="Percent of Obligations",
      # color="Competition")+
      theme(legend.position = "right")+
      labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.")#+
     # facet_wrap(~PlatformPortfolioUAV,scale="free_y")
  )


  (
    uas_ota_contract_comm_sub<-build_plot(
      data=ota_contract %>% filter(PlatformPortfolioUAV=="Remotely Crewed" & Fiscal_Year<=2021& 
                                     AnyCommercial %in% c('Y',"NonDev","Other OTA")&
                                     Fiscal_Year>=2011) ,
      chart_geom = "Bar Chart",
      share = FALSE,
      labels_and_colors=ota_contract_lc,
      # NA, #VAR.ncol
      x_var="dFYear", #x_var
      y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
      color_var="IsOTA", #color_var
      facet_var="SubCustomer.DoD", #facet_var
      # second_var="IsOTA", #facet_var
      column_key=ota_contract_lc,
      format=TRUE,
      ytextposition=FALSE
    )+
      # theme(strip.text.y = element_text(angle=0))+
      # theme(axis.text.x = element_text(angle=90))+
      #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
      #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
      #             )+labs(title=NULL,
      # x="Fiscal Year",
      # y="Percent of Obligations",
      # color="Competition")+
      theme(legend.position = "bottom")+
      labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.")+
     facet_grid(.~SubCustomer.DoD)
  )


(
    uas_contract_comm_sub<-build_plot(
      data=fed_data %>% filter(PlatformPortfolioUAV=="Remotely Crewed" & Fiscal_Year<=2021& 
                                     AnyCommercial %in% c('Y',"NonDev","Other OTA")&
                                     Fiscal_Year>=2011) ,
      chart_geom = "Bar Chart",
      share = FALSE,
      labels_and_colors=ota_contract_lc,
      # NA, #VAR.ncol
      x_var="dFYear", #x_var
      y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
      color_var="SubCustomer.DoD", #color_var
      facet_var="SubCustomer.DoD", #facet_var
      # second_var="IsOTA", #facet_var
      column_key=ota_contract_lc,
      format=TRUE,
      ytextposition=FALSE
    )+
      # theme(strip.text.y = element_text(angle=0))+
      # theme(axis.text.x = element_text(angle=90))+
      #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
      #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
      #             )+labs(title=NULL,
      # x="Fiscal Year",
      # y="Percent of Obligations",
      # color="Competition")+
      theme(legend.position = "bottom")+
      labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.")+
     facet_grid(.~SubCustomer.DoD)
  )
OTA_data$LegalBusinessName
OTA_data %>% filter(SubCustomer.DoD=="Army"& PlatformPortfolioUAV=="Remotely Crewed"& Fiscal_Year<=2014)%>%
  group_by(Description_of_Requirement,LegalBusinessName,NontraditionalGovernmentContractorParticipationDescription)%>%
       summarise(Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22,na.rm=TRUE))%>%
  arrange(-Action_Obligation_OMB24_GDP22)

ggsave600dpi(uas_ota_contract_comm_sub,file="..//output//Remotely_Crewed//uas_ota_contract_comm_sub.png",
             width=6.5, height= 3, units="in",size=11, lineheight=1.2)

ggsave600dpi(uas_ota_contract_comm_sub,file="..//output//Remotely_Crewed//uas_ota_contract_comm_sub.svg",
             width=6.5, height= 3, units="in",size=11, lineheight=1.2)


ggsave600dpi(uas_contract_comm_sub+theme(legend.position = "None"),file="..//output//Remotely_Crewed//uas_contract_comm_sub.png",
             width=6.5, height= 2.75, units="in",size=11, lineheight=1.2)

ggsave600dpi(uas_contract_comm_sub+theme(legend.position = "None"),file="..//output//Remotely_Crewed//uas_contract_comm_sub.svg",
             width=6.5, height= 2.75, units="in",size=11, lineheight=1.2)

write.csv(file="..//Output//Remotely_Crewed//uas_ota_contract_comm_sub.csv",row.names = FALSE,na = "",
          uas_ota_contract_comm_sub$data %>% mutate(Fiscal_Year=lubridate::year(dFYear),
            bAction_Obligation_OMB24_GDP22=Action_Obligation_OMB24_GDP22/1000000000)%>%
            arrange(Fiscal_Year)%>%
            pivot_wider(id_cols=c(SubCustomer.DoD,IsOTA),
                        names_from=Fiscal_Year,values_from=bAction_Obligation_OMB24_GDP22)%>%
            arrange(SubCustomer.DoD,IsOTA))
```

### Commercial Across Categories
```{r ToplineComm}
summary(fed_data$Competition.effective.only)
fed_data <- fed_data %>% group_by(Fiscal_Year,PlatformPortfolioUAV)  %>%
  dplyr::mutate(pctFYPlat=Action_Obligation_Then_Year/sum(Action_Obligation_Then_Year,na.rm=TRUE))
fed_data$platfor
(
CommPlatUAV<-build_plot(
  data=fed_data %>% filter(Fiscal_Year>=2010,AnyCommercial %in% c('Y',"NonDev","Other OTA") & PlatformPortfolioUAV!="Unlabeled"),
  chart_geom = "Line Chart",
  share = FALSE,
  labels_and_colors=fed_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="pctFYPlat", #VAR.y.variable
  # color_var="SimpleArea", #color_var
  facet_var="PlatformPortfolioUAV", #facet_var
  column_key=fed_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # 
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Percent of Obligations")
)


(
CommPlatUAVbar<-build_plot(
  data=fed_data %>% filter(Fiscal_Year>=2010),
  chart_geom = "Line Chart",
  share = FALSE,
  labels_and_colors=fed_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="AnyCommercial", #color_var
  facet_var="PlatformPortfolioUAV", #facet_var
  # second_var="SimpleArea",
  column_key=fed_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # 
  # y="Percent of Obligations",
  # color="Competition")+
    facet_grid(PlatformPortfolioUAV~.,scale="free_y")+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Percent of Obligations")
)

ggsave600dpi(CommPlatUAV,file="../output/Remotely_Crewed//CommPlatUAV.png",
             size = 12, lineheight=1, height =4, width=6.5)


ggsave600dpi(CommPlatUAVbar,file="../output/Remotely_Crewed//CommPlatUAVbar.png",
             size = 12, lineheight=1, height =8.64, width=6.5)


write.csv(file="..//Output//Remotely_Crewed//CommPlatUAV.csv",row.names = FALSE, na = "",
          CommPlatUAV$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlatformPortfolioUAV),
                        names_from=Fiscal_Year,values_from=pctFYPlat)%>%
            arrange(PlatformPortfolioUAV))


# write.csv(file="..//Output//Remotely_Crewed//CommPlatUAV_cur.csv",row.names = FALSE, na = "",
#           full_data %>% group_by(No.Competition.sum,Fiscal_Year)%>%
#             dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
#           pivot_wider(id_cols=c(No.Competition.sum),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>% arrange(No.Competition.sum))


```


##  Competition

### No Competition Breakdown
```{r ToplineComp}

(
ToplineCompMulti<-build_plot(
  data=fed_data %>% filter(Fiscal_Year>=2010,PlatformPortfolioUAV=="Remotely Crewed"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=fed_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=fed_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # 
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Obligations (Constant 2022 $s)")
)




(
ToplineNoComp<-build_plot(
  data=fed_data %>% filter(Fiscal_Year>=2010,PlatformPortfolioUAV=="Remotely Crewed"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=fed_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="No.Competition.sum", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=fed_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Obligations (Constant 2022 $s)")
)

# 

ggsave600dpi(ToplineNoComp,file="../output/Remotely_Crewed//uas_nocompetition.png",
             size = 12, lineheight=1, height =3, width=6.5)



ggsave600dpi(ToplineNoComp,file="../output/Remotely_Crewed//uas_nocompetition.svg",
             size = 12, lineheight=1, height =3, width=6.5)


write.csv(file="..//Output//Remotely_Crewed//uas_nocompetition.csv",row.names = FALSE, na = "",
          ToplineNoComp$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(SimpleArea,No.Competition.sum),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22))


write.csv(file="..//Output//Remotely_Crewed//uas_nocompetition_cur.csv",row.names = FALSE, na = "",
          fed_data %>% group_by(SimpleArea,No.Competition.sum,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(SimpleArea,No.Competition.sum),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>% arrange(SimpleArea,No.Competition.sum))


```


### Competition across categories

```{r ToplineComp}
summary(fed_data$Competition.effective.only)

fed_data <- fed_data %>% group_by(Fiscal_Year,PlatformPortfolioUAV)  %>%
  dplyr::mutate(pctFYplat=Action_Obligation_Then_Year/sum(Action_Obligation_Then_Year,na.rm=true))


fed_data <- fed_data %>% group_by(Fiscal_Year,SimpleArea,PlatformPortfolioUAV)  %>%
  dplyr::mutate(pctFYsimpleareaPlat=Action_Obligation_Then_Year/sum(Action_Obligation_Then_Year,na.rm=true))



(
effCompPlatUAVbar<-build_plot(
  data=fed_data %>% filter(Fiscal_Year>=2010),
  chart_geom = "Line Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="pctFYplat", #VAR.y.variable
  color_var="Competition.effective.only", #color_var
  facet_var="PlatformPortfolioUAV", #facet_var
  # second_var="SimpleArea",
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # 
  # y="Percent of Obligations",
  # color="Competition")+
    # facet_grid(PlatformPortfolioUAV~SimpleArea,scale="free_y")+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Percent of Obligations")
)


(
PSReffCompPlatUAVbar<-build_plot(
  data=fed_data %>% filter(Fiscal_Year>=2010),
  chart_geom = "Line Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="Competition.effective.only", #color_var
  facet_var="PlatformPortfolioUAV", #facet_var
  second_var="SimpleArea",
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # 
  # y="Percent of Obligations",
  # color="Competition")+
    facet_grid(PlatformPortfolioUAV~SimpleArea,scale="free_y")+
  theme(legend.position = "bottom")+
  labs(x="Fiscal Year",
       y="Percent of Obligations")
)

ggsave600dpi(PSReffCompPlatUAV,file="../output/Remotely_Crewed//PSReffCompPlatUAV.png",
             size = 12, lineheight=1, height =4, width=6.5)


ggsave600dpi(PSReffCompPlatUAVbar,file="../output/Remotely_Crewed//PSReffCompPlatUAVbar.png",
             size = 12, lineheight=1, height =8.64, width=6.5)




write.csv(file="..//Output//Remotely_Crewed//PSReffCompPlatUAV.csv",row.names = FALSE, na = "",
          ToplineNoComp$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(SimpleArea,PlatformPortfolioUAV),
                        names_from=Fiscal_Year,values_from=pctFYsimpleareaPlat))


# write.csv(file="..//Output//Remotely_Crewed//PSReffCompPlatUAV_cur.csv",row.names = FALSE, na = "",
#           full_data %>% group_by(No.Competition.sum,Fiscal_Year)%>%
#             dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
#           pivot_wider(id_cols=c(No.Competition.sum),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>% arrange(No.Competition.sum))


```

## Vendor International
```{r ToplineVendor}


(
  RCVendorIntl<-build_plot(
    data=drone %>% filter(Fiscal_Year<=2020),
    chart_geom = "Bar Chart",
    share = FALSE,
    labels_and_colors=labels_and_colors,
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
    color_var="VendorSize_Intl", #color_var
    # facet_var="Competition.sum", #facet_var
    column_key=column_key,
    format=TRUE,
    ytextposition=FALSE
  )+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "right")+
    labs(y="Obligations (Constant 2022 $s)",
         caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies took place in April of 2020 and thus did not make the cutoff for inclusion in FY2020.")
)

ggsave600dpi("..//Output//Remotely_Crewed//remotely_crewed_vendor_intl_square.png", RCVendorIntl+
               labs(y="Obligations (Constant 2022 $s)",caption="Source: FPDS and CSIS analysis.\nNote: The merger of Raytheon and United Technologies is took place in \nApril of 2020 and thus did not make the cutoff for inclusion in FY2020."), 
             width=6, height= 5, units="in",size=12,lineheight=1
)



```


  ### FMS
```{r ToplineFMS}

def_data <- def_data %>% group_by(Fiscal_Year,PlatformPortfolioUAV)  %>%
  dplyr::mutate(pctFYPlat=Action_Obligation_Then_Year/sum(Action_Obligation_Then_Year,na.rm=TRUE))


(
FMSplatUAV<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2012,IsFMS==1 & PlatformPortfolioUAV!="Unlabeled"& 
                                                                    !PlatformPortfolioUAV %in% c("Facilities and Construction",
                                                                                                 "Other Products",
                                                                                                 "Other R&D and Knowledge Based",
                                                                                                 "Other Services")),
  chart_geom = "Line Chart",
  share = FALSE,
  labels_and_colors=fed_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="pctFYPlat", #VAR.y.variable
  color_var="PlatformPortfolioUAV", #color_var
  facet_var="PlatformPortfolioUAV", #facet_var
  column_key=fed_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # 
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(x="Fiscal Year",
       y="Percent of Portfolio Obligations")+
    scale_y_continuous(labels=scales::percent)+facet_wrap(~PlatformPortfolioUAV,nrow=2)
)


(
FMSplatUAVbar<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2012 & PlatformPortfolioUAV!="Unlabeled"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=fed_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
  color_var="IsFMS", #color_var
  facet_var="PlatformPortfolioUAV", #facet_var
  # second_var="SimpleArea",
  column_key=fed_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # 
  # y="Percent of Obligations",
  # color="Competition")+
    facet_wrap(PlatformPortfolioUAV~.,scale="free_y")+
  theme(legend.position = "none")+
  labs(x="Fiscal Year",
       y="Percent of Obligations")
)

ggsave600dpi(FMSplatUAV,file="../output/Remotely_Crewed//FMSplatUAV.png",
             size = 12, lineheight=1, height =4, width=6.5)
ggsave600dpi(FMSplatUAV,file="../output/Remotely_Crewed//FMSplatUAV.svg",
             size = 12, lineheight=1, height =4, width=6.5)

ggsave600dpi(FMSplatUAVbar,file="../output/Remotely_Crewed//FMSplatUAVbar.png",
             size = 12, lineheight=1, height =8.64, width=6.5)



write.csv(file="..//Output//Remotely_Crewed//FMSplatUAV.csv",row.names = FALSE, na = "",
          FMSplatUAV$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlatformPortfolioUAV),
                        names_from=Fiscal_Year,values_from=pctFYPlat))


write.csv(file="..//Output//Remotely_Crewed//FMSplatUAV_cur.csv",row.names = FALSE, na = "",
          def_data %>% group_by(IsFMS,PlatformPortfolioUAV,Fiscal_Year)%>% filter(Fiscal_Year>=2000) %>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
             arrange(Fiscal_Year) %>%
          pivot_wider(id_cols=c(PlatformPortfolioUAV,IsFMS),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>% arrange(PlatformPortfolioUAV,IsFMS))


```

###FMS identification
```{r contract_identification}



# undebug(build_plot)

(rc_contract_identification <-  build_plot(data=droneEO %>% filter(Customer=="Defense" &Fiscal_Year>=2012),
                                           chart_geom="Bar Chart",
                                           share=FALSE,
                                           x_var="dFYear",
                                           y_var="Action_Obligation_OMB24_GDP22",
                                           color_var="foreign_funding_description",
                                           facet_var="CaseStudy",
                                           second_var="IsFMS",
                                           labels_and_colors=fed_lc,
                                           column_key=fed_ck,
                                           legend=TRUE,
                                           caption=FALSE,
                                           format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
    labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
      y="Constant 2020 $ Obligated",
      caption="Source: FPDS and CSIS analysis.")+
    guides(fill=guide_legend(ncol=3)))

ggsave600dpi(rc_contract_identification,file="../output//Remotely_Crewed//figure_03_contract_identification.png",
             size=12,lineheight=1, height =5, width=9)


log_plot(plot=eorc_customer, df=droneEO %>% dplyr::filter( 
                                                                            lubridate::year(dFYear)>=2012 & 
                                                                            lubridate::year(dFYear)<=2023),
           filename="UAS_EO_FMS",xlsx="Japan_Def_Coop.xlsx",suppress_text = FALSE,
           sheet="FMS",path=japan_repo_path,second_path=japan_log_path, height=3.5,
           format=TRUE,#var_list=c("FlowText","StateRegionJapan"),
           output_doc_png=TRUE,excel_y_var=TRUE
  )
```


### FMS Vendor Size/Intl and Place No JSF
```{r FPDS_vendor_Intl}

summary(factor(platpscintl$Shiny.VendorSize[platpscintl$VendorIsForeign==1]))
summary(platpscintl$VendorSize_Intl)

# undebug(format_data_for_plot)
(fpds_vendor_intl_place_noJSF <-  build_plot(data=drone ,
                                             #IsFMS==TRUE 
                                             chart_geom="Bar Chart",
                                             x_var="dFYear",
                                             y_var="Action_Obligation_OMB24_GDP22",
                                             color_var="VendorSize_Intl",
                                             # facet_var="PlaceIsForeign",
                                             second_var="IsFMS",
                                             labels_and_colors=fed_lc,
                                             column_key=fed_ck,
                                             legend=TRUE,
                                             caption=FALSE,
                                             format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS )+labs(title="FMS or Performed Internationally, No JSF")#, scales="free_y"
)


# platpscintl$Shiny.VendorSize
(rc_vendor_place_fms <-  build_plot(data=drone %>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign)&
                                                            !is.na(IsFMS)&Fiscal_Year>2011&Fiscal_Year<=2020),#IsFMS==TRUE  
                                    chart_geom="Bar Chart",
                                    x_var="dFYear",
                                    y_var="Action_Obligation_OMB24_GDP22",
                                    color_var="VendorSize_Intl",
                                    facet_var="PlaceIsForeign",
                                    second_var="IsFMS",
                                    labels_and_colors=fed_lc,
                                    column_key=fed_ck,
                                    legend=TRUE,
                                    caption=FALSE,
                                    format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )+labs(title="FMS or Performed Internationally, No JSF")#, scales="free_y"#, scales="free_y"
)


write.csv(file="..//output//Remotely_Crewed//rc_vendor_place_FMS.csv",row.names = FALSE,na = "",
          rc_vendor_place_fms$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(VendorSize_Intl,IsFMS, PlaceIsForeign),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22)%>% arrange(PlaceIsForeign,IsFMS,VendorSize_Intl))

ggsave600dpi(rc_vendor_place_fms,file="../output/Remotely_Crewed//rc_vendor_place_FMS.png",
             size = 12, lineheight=1, height =4.5, width=9)



```
### Vendor Size
```{r case_study_vendor_size}

(
  rceo_psr<-build_plot(
    data=droneEO ,
    chart_geom = "Bar Chart",
    share = FALSE,
    labels_and_colors=fedpsc_lc,
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="Action_Obligation_OMB24_GDP22", #VAR.y.variable
    color_var="Shiny.VendorSize", #color_var
    facet_var="CaseStudy", #facet_var
    # second_var = "VendorSize",
    column_key=fedpsc_ck,
    format=TRUE,
    ytextposition=FALSE
  )+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "right")+
    labs(y="Obligations (Constant 2022 $s)",caption="Note: Unlabeled not shown. Source: FPDS and CSIS analysis.")#+
  # facet_wrap(~ContractingAgencyTextSwr,ncol=4)
)

log_plot(plot=rceo_psr, df=droneEO %>% dplyr::filter(  lubridate::year(dFYear)>=1990 & 
                                                                            lubridate::year(dFYear)<=2023),
           filename="UAS_EO_Vendor_Size",xlsx="Japan_Def_Coop.xlsx",suppress_text = FALSE,
           sheet="Vendor",path=japan_repo_path,second_path=japan_log_path, height=3.5,
           format=TRUE,#var_list=c("FlowText","StateRegionJapan"),
           output_doc_png=TRUE,excel_y_var=TRUE
  )
```

# Entities

## Consolidation
```{r drone_count}

# platformUAS_only$
annual_platformUAV_summary$dFYear<-as.Date(paste(annual_platformUAV_summary$Fiscal_Year,"01","01",sep="-"))
summary(factor(annual_platformUAV_summary$PlatformPortfolioUAV))
summary(annual_platformUAV_summary)
# 
# ggplot(data=annual_platformUAV_summary %>% filter(dFYear>=1991& !is.na(PlatformPortfolioUAV)),
#        aes(x=dFYear,y=hh_index))+geom_line()+facet_wrap(~PlatformPortfolioUAV)
# 
# ggplot(data=annual_platformUAV_summary %>% filter(dFYear>=1991& !is.na(PlatformPortfolioUAV)),
#        aes(x=dFYear,y=top4))+geom_line()+facet_wrap(~PlatformPortfolioUAV)

# undebug(add_preassigned_scales)
(hhi<-build_plot(data=annual_platformUAV_summary %>% filter(Fiscal_Year>=2010& Fiscal_Year<=2020 & !is.na(PlatformPortfolioUAV)),
           chart_geom="Line Chart",
           x_var="dFYear",
           y_var="hh_index",
           color_var="PlatformPortfolioUAV",
           facet_var="PlatformPortfolioUAV",
           # second_var="IsEntityAbove2018constant10ThousandThreshold",
           # labels_and_colors=uav_lc,
           # column_key=uav_ck,
           legend=TRUE,
           caption=FALSE,
           format=TRUE)+
   facet_wrap(.~PlatformPortfolioUAV))


(top4<-build_plot(data=annual_platformUAV_summary %>% filter(Fiscal_Year>=2010& Fiscal_Year<=2020 &!is.na(PlatformPortfolioUAV)),
           chart_geom="Line Chart",
           x_var="dFYear",
           y_var="top4",
           color_var="PlatformPortfolioUAV",
           facet_var="PlatformPortfolioUAV",
           # second_var="IsEntityAbove2018constant10ThousandThreshold",
           # labels_and_colors=uav_lc,
           # column_key=uav_ck,
           legend=TRUE,
           caption=FALSE,
           format=TRUE)+
   facet_wrap(.~PlatformPortfolioUAV))


(big5<-build_plot(data=annual_platformUAV_summary %>% filter(Fiscal_Year>=2010&  Fiscal_Year<=2020 &!is.na(PlatformPortfolioUAV)),
           chart_geom="Line Chart",
           x_var="dFYear",
           y_var="big5",
           color_var="PlatformPortfolioUAV",
           facet_var="PlatformPortfolioUAV",
           # second_var="IsEntityAbove2018constant10ThousandThreshold",
           # labels_and_colors=uav_lc,
           # column_key=uav_ck,
           legend=TRUE,
           caption=FALSE,
           format=TRUE)+
   facet_wrap(.~PlatformPortfolioUAV))


annual_platformUAV_top4big5<-annual_platformUAV_summary %>% pivot_longer(cols=c(top4,big5),names_to="Metric")
summary(factor(annual_platformUAV_top4big5$PlatformPortfolioUAV))
(top4big5<-build_plot(data=annual_platformUAV_top4big5 %>% filter(Fiscal_Year>=2010& Fiscal_Year<=2020 & !is.na(PlatformPortfolioUAV)&
                                                                    !PlatformPortfolioUAV %in% c("Facilities and Construction",
                                                                                                 "Other Products",
                                                                                                 "Other R&D and Knowledge Based",
                                                                                                 "Other Services")),
           chart_geom="Line Chart",
           x_var="dFYear",
           y_var="value",
           color_var="Metric",
           facet_var="PlatformPortfolioUAV",
           # second_var="IsEntityAbove2018constant10ThousandThreshold",
            labels_and_colors=prepare_labels_and_colors(annual_platformUAV_top4big5),                                                   #,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\"),
           column_key=get_column_key(annual_platformUAV_top4big5),
           legend=TRUE,
           caption=FALSE,
           format=TRUE)+
   facet_wrap(.~PlatformPortfolioUAV,nrow = 2)+
    scale_y_continuous(labels=scales::percent)+labs(y="Share of Portfolio Obligations"))




(vsize<-build_plot(data=defense_platformUAV_vendor %>% filter(Fiscal_Year>=2010 & Fiscal_Year<=2020 &!is.na(PlatformPortfolioUAV)),
           chart_geom="Bar Chart",
           x_var="dFYear",
           y_var="Action_Obligation_OMB24_GDP22",
           color_var="EntitySizeText",
           facet_var="PlatformPortfolioUAV",
           # second_var="IsEntityAbove2018constant10ThousandThreshold",
           labels_and_colors=uav_lc,
           column_key=uav_ck,
           legend=TRUE,
           caption=FALSE,
           format=TRUE)+
   facet_wrap(.~PlatformPortfolioUAV,scales="free_y"))


ggsave600dpi(top4big5,file="../output/Remotely_Crewed//sysuav_top4big5.png",
             size = 12, lineheight=1, height =4, width=6.5)

ggsave600dpi(top4big5,file="../output/Remotely_Crewed//sysuav_top4big5.svg",
             size = 12, lineheight=1, height =4, width=6.5)


ggsave600dpi(top4big5+
               labs(title="Market Share of Leading Contractors by Platform Portfolio), 2010-2020"),
             file="../output/Remotely_Crewed//sysuav_top4big5_slide.png",
             size = 16, lineheight=1, height =5.5, width=12)


```
## Top List
```{r drone_count}
  
  # defense_platformUAV_vendor<-defense_platformUAV_vendor %>% filter (PlatformPortfolioUAV=="Remotely Operated" ) %>%group_by(PlatformPortfolioUAV) %>%
  #   dplyr::select(-PlatformPortfolioUAV) %>% 
  #   group_by(Fiscal_Year,IsRemotelyOperated,EntityID,PlatformPortfolioUAV) %>%
  #   dplyr::summarize(Action_Obligation=sum(Action_Obligation,na.rm=TRUE),
  #             NumberOfActions=sum(NumberOfActions,na.rm=TRUE)) %>% 
  #   deflate(money_var="Action_Obligation")  %>% 
  #   group_by(EntityID) %>% 
  #   dplyr::mutate(TotalSpend=sum(Action_Obligation_OMB24_GDP22,na.rm=TRUE))%>% group_by()%>%
  #                   dplyr::mutate(TotalPos=rank(-TotalSpend,ties="min")) %>% arrange(EntityID)
  #               
  #               # TotalPos=rank(-TotalSpend)) %>% arrange(EntityID),
  #               # TotalPos=rank(-TotalSpend))

defense_UAV_vendor<-defense_platformUAV_vendor %>% filter (PlatformPortfolioUAV=="Remotely Operated" )


topUAV<-defense_UAV_vendor%>% filter(pos<=10)%>% arrange(Fiscal_Year,pos)

topUAVannual<-defense_UAV_vendor %>%
  dplyr::mutate(TopEntityText=ifelse(pos<=10,EntityText,"All Other"),
         Toppos=ifelse(pos<=10,pos,0)) %>%
  dplyr::group_by(Fiscal_Year,PlatformPortfolioUAV,TopEntityText,Toppos) %>%
  dplyr::summarize(Action_Obligation_OMB24_GDP22=sum(Action_Obligation_OMB24_GDP22,na.rm=TRUE)) %>% arrange(Fiscal_Year,Toppos)

# topUAV<-deflate(topUAV,money_var="Action_Obligation")

topUAVunlabeled<-topUAV %>% filter(Fiscal_Year>=2000 & (is.na(EntityCategory) | EntityCategory!="PID"))
```


### Wide
```{r WideDisplay}
defense_UAV_vendor<-defense_UAV_vendor %>%
  group_by(EntityID) %>% 
  dplyr::mutate(TotalSpend=sum(Action_Obligation_OMB24_GDP22,na.rm=TRUE),
                TotalPos=rank(-TotalSpend))

vendorUAVwide<-defense_UAV_vendor %>%
  filter(Fiscal_Year >=2010 & Fiscal_Year<=2021) %>%
  dplyr::mutate(TopEntityText=ifelse(pos<=10,EntityText,"All Other"),
         Toppos=ifelse(pos<=10,pos,0)) %>%
  dplyr::group_by(PlatformPortfolioUAV,EntityText,EntityID,EntityCategory) %>%
  dplyr::mutate(TotalSpend=sum(Action_Obligation_OMB24_GDP22,na.rm=TRUE)) %>%
  arrange(Fiscal_Year)%>%
  pivot_wider(id_cols=c(PlatformPortfolioUAV,EntityText,EntityID,EntityCategory,TotalSpend),
              names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22)%>% 
    group_by() %>% dplyr::mutate(TotalPos=rank(-TotalSpend)) %>% arrange(TotalPos)


write.csv(vendorUAVwide %>% dplyr::select(-EntityCategory),file="../output/Remotely_Crewed//vendorUAVwide.csv",
          row.names = FALSE,na = "")
# View(defense_UAV_vendor %>% filter(TotalPos<=20)%>% arrange(TotalPos,Fiscal_Year))


View(vendorUAVwide %>% filter((TotalSpend>=50000000 & EntityCategory!="PID") | is.na(EntityCategory)))

# (
# vend_spark<-ggplot(defense_UAV_vendor %>% filter(TotalPos<=20),aes(x=Fiscal_Year,y=Action_Obligation_OMB24_GDP22))+
#   facet_grid(EntityID~.,scale="free_y")+geom_col()+
#     theme_light()+
#   theme(axis.title=element_blank(),
#         axis.text.y = element_blank(), 
#         axis.text.x = element_blank(), 
#         axis.ticks = element_blank(),
#         strip.text = element_blank(),
#         panel.grid.minor.x = element_blank(),
#         panel.grid.minor.y = element_blank(),
#         panel.grid.major.y = element_blank(),
#         panel.border = element_blank()
#         )
# )
# 
# ggsave(vend_spark+theme(strip.text.y = element_text(angle=0)),
#        file=file.path("..","output","Remotely_Crewed","vend_sparkline.png"), width=3.5, height=20)
# ggsave(vend_spark+theme(strip.text=element_blank()),
#        file=file.path("..","output","Remotely_Crewed","vend_sparkline_notext.png"), width=1, height=20)
# ggsave(vend_spark+theme(strip.text.y = element_text(angle=0)),
#        file=file.path("..","output","Remotely_Crewed","vend_sparkline.eps"), width=3.5, height=20)
# ggsave(vend_spark+theme(strip.text=element_blank()),
#        file=file.path("..","output","Remotely_Crewed","vend_sparkline_notext.eps"), width=1, height=20)


```

## Top Dunsnumber
```{r drone_count}


colnames(dataplat)[colnames(dataplat)=="PlatformPortfolioRemote"]<-"PlatformPortfolioUAV"
defense_platformUAV_contractor<-dataplat %>% filter (PlatformPortfolioUAV=="Remotely Operated" ) 


defense_platformUAV_contractor<-defense_platformUAV_contractor %>%
  group_by(PlatformPortfolioUAV,Fiscal_Year,IsDefense) %>%
  dplyr::mutate(
    pos = rank(-Action_Obligation,
               ties.method ="min"),
    pct = ifelse(Action_Obligation>0,
                 Action_Obligation / sum(Action_Obligation[Action_Obligation>0]),
                 NA
    )
  )

topUAVduns<-defense_platformUAV_contractor%>% filter(pos<=10)%>% arrange(Fiscal_Year,pos)

# FPDS_eid_fyear <- read.delim(file.path("../Data/semi_clean/Vendor.EntityIDhistory.txt"), header=TRUE,  na.strings = c("", "NULL"))
# FPDS_eid_fyear$EntityID<-text_to_number(FPDS_eid_fyear$EntityID)
# FPDS_eid_fyear<-standardize_variable_names(FPDS_eid_fyear)
# colnames(FPDS_eid_fyear)
# defense_platformUAV_contractor<-left_join(defense_platformUAV_contractor,FPDS_eid_fyear %>% dplyr::select(-Action_Obligation,-NumberOfActions),
#                                       by=c("EntityID","Fiscal_Year"))
# colnames(defense_platformUAV_contractor)

topUAVannualduns<-defense_platformUAV_contractor %>%
  dplyr::mutate(TopVendText=ifelse(pos<=10,ContractorDisplayName,"All Other"),
         Toppos=ifelse(pos<=10,pos,0)) %>%
  dplyr::group_by(Fiscal_Year,PlatformPortfolioUAV,IsDefense,TopVendText,Toppos) %>%
  dplyr::summarize(Action_Obligation=sum(Action_Obligation,na.rm=TRUE)) %>% arrange(Fiscal_Year,IsDefense,Toppos)

topUAVannualduns<-deflate(topUAVannualduns,money_var="Action_Obligation")




```

### Wide
```{r WideDisplayTop}
defense_platformUAV_contractor<-deflate(defense_platformUAV_contractor,money_var="Action_Obligation")  %>%
  group_by(UnknownCompany,AllContractor,
           jointventure,WarningFlag) %>% 
  dplyr::mutate(TotalSpend=sum(Action_Obligation_OMB24_GDP22,na.rm=TRUE),
                TotalPos=rank(-TotalSpend))



contractorUAVwide<-defense_platformUAV_contractor %>%
  filter(Fiscal_Year >=2010 & Fiscal_Year<=2021) %>%
  # dplyr::mutate(TopContractorText=ifelse(pos<=10,AllContractor,"All Other"),
  #        Toppos=ifelse(pos<=10,pos,0)) %>%
  group_by(PlatformPortfolioUAV,UnknownCompany,AllContractor,
           jointventure,Fiscal_Year,IsDefense) %>%
  dplyr::summarize(Action_Obligation_OMB24_GDP22 = sum(Action_Obligation_OMB24_GDP22),
            NumberOfActions = sum(NumberOfActions)) %>%
  dplyr::group_by(PlatformPortfolioUAV,AllContractor,IsDefense) %>%
  dplyr::mutate(TotalSpend=sum(Action_Obligation_OMB24_GDP22,na.rm=TRUE)) %>%
  arrange(Fiscal_Year) %>%
  pivot_wider(id_cols=c(PlatformPortfolioUAV,IsDefense,UnknownCompany,AllContractor,
           jointventure,TotalSpend),
              names_from=Fiscal_Year,values_from=Action_Obligation_OMB24_GDP22)%>% 
  group_by(IsDefense) %>%
     dplyr::mutate(TotalPos=rank(-TotalSpend)) %>% arrange(-IsDefense,TotalPos)%>%dplyr::select(-PlatformPortfolioUAV)


write.csv(contractorUAVwide,file="../output/Remotely_Crewed//contractorUAVwide.csv",
          row.names = FALSE,na = "")

# 
# (
# vend_spark<-ggplot(defense_platformUAV_contractor %>% filter(TotalPos<=20),aes(x=Fiscal_Year,y=Action_Obligation_OMB24_GDP22))+
#   facet_grid(EntityID~.,scale="free_y")+geom_col()+
#     theme_light()+
#   theme(axis.title=element_blank(),
#         axis.text.y = element_blank(), 
#         axis.text.x = element_blank(), 
#         axis.ticks = element_blank(),
#         strip.text = element_blank(),
#         panel.grid.minor.x = element_blank(),
#         panel.grid.minor.y = element_blank(),
#         panel.grid.major.y = element_blank(),
#         panel.border = element_blank()
#         )
# )
# 
# ggsave(vend_spark+theme(strip.text.y = element_text(angle=0)),
#        file=file.path("..","output","Remotely_Crewed","vend_sparkline.png"), width=3.5, height=20)
# ggsave(vend_spark+theme(strip.text=element_blank()),
#        file=file.path("..","output","Remotely_Crewed","vend_sparkline_notext.png"), width=1, height=20)
# ggsave(vend_spark+theme(strip.text.y = element_text(angle=0)),
#        file=file.path("..","output","Remotely_Crewed","vend_sparkline.eps"), width=3.5, height=20)
# ggsave(vend_spark+theme(strip.text=element_blank()),
#        file=file.path("..","output","Remotely_Crewed","vend_sparkline_notext.eps"), width=1, height=20)


```

## Vendor Size and Count via Entity
```{r drone_count}

# undebug(add_preassigned_scales)

defense_UAV_vendor$EntitySizeText.GA<-as.character(defense_UAV_vendor$EntitySizeText)
defense_UAV_vendor$EntitySizeText.GA[defense_UAV_vendor$EntityText=="GENERAL ATOMICS"&
                                       !is.na(defense_UAV_vendor$EntityText)]<-"General Atomics"


uav_lc<-prepare_labels_and_colors(defense_UAV_vendor)#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
uav_ck<-get_column_key(defense_UAV_vendor)#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")

defense_UAV_both<-defense_UAV_vendor %>% pivot_longer(cols=c(EntityCount,Action_Obligation_OMB24_GDP22),names_to = "Metric")







(a<-build_plot(data=defense_UAV_vendor %>% filter(Fiscal_Year>=2010 &
                                                    IsEntityAbove2018constant10ThousandThreshold==1),# & PlatformPortfolioUAV %in% 
                                                  c(#"Aircraft","Electronics, Comms, & Sensors",
                                                    #"Remotely Operated","Ordnance and Missiles")&
                                                      ),
           chart_geom="Bar Chart",
           x_var="dFYear",
           y_var="EntityCount",
           color_var="EntitySizeText.sum",
           facet_var="None",
           # second_var="IsEntityAbove2018constant10ThousandThreshold",
           labels_and_colors=uav_lc,
           column_key=uav_ck,
           legend=TRUE,
           caption=TRUE,
           format=TRUE,
           share=FALSE)+
    labs(y="Number of Entities"))#+
   #facet_wrap(.~PlatformPortfolioUAV,scales="free_y"))



summary(factor(defense_UAV_vendor$EntitySizeText.GA))

(b<-build_plot(data=defense_UAV_vendor %>% filter(Fiscal_Year>=2010 ),
           chart_geom="Bar Chart",
           x_var="dFYear",
           y_var="Action_Obligation_OMB24_GDP22",
           color_var="EntitySizeText.GA",
           # facet_var="PlatformPortfolioRemote",
           # second_var="IsEntityAbove2018constant10ThousandThreshold",
           labels_and_colors=uav_lc,
           column_key=uav_ck,
           legend=TRUE,
           caption=TRUE,
           format=TRUE)#+
   # facet_wrap(.~PlatformPortfolioRemote,scales="free_y"))
)


ggsave600dpi(a,file="../output/Remotely_Crewed//uav_entity_count.png",
             size = 12, lineheight=1, height =4.5, width=9)


ggsave600dpi(b,file="../output/Remotely_Crewed//uav_entity_dollar.png",
             size = 12, lineheight=1, height =4.5, width=9)


(ab<-build_plot(data=defense_UAV_both %>% filter(Fiscal_Year>=2010 &
                                                    IsEntityAbove2018constant10ThousandThreshold==1),# & PlatformPortfolioUAV %in% 
                                                  c(#"Aircraft","Electronics, Comms, & Sensors",
                                                    #"Remotely Operated","Ordnance and Missiles")&
                                                      ),
           chart_geom="Bar Chart",
           x_var="dFYear",
           y_var="value",
           color_var="EntitySizeText.GA",
           facet_var="Metric",
           # second_var="IsEntityAbove2018constant10ThousandThreshold",
           labels_and_colors=prepare_labels_and_colors(defense_UAV_both,path=local_path),
           column_key=get_column_key(defense_UAV_both),
           legend=TRUE,
           caption=TRUE,
           format=TRUE,
           share=FALSE)+
    labs(y=NULL)+
   facet_wrap(.~Metric,scales="free_y")+
    theme(legend.position = "right"))


ggsave600dpi(ab,
                          file="../output/Remotely_Crewed//uav_entity_count_size.png",
              size = 12, lineheight=1,height =3.5, width=6.5)


ggsave600dpi(ab,
                          file="../output/Remotely_Crewed//uav_entity_count_size.svg",
              size = 12, lineheight=1,height =3.5, width=6.5)

write.csv(file="..//output//Remotely_Crewed//uav_entity_count_size.csv",row.names = FALSE,na = "",
          ab$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(EntitySizeText.GA,Metric),
                        names_from=Fiscal_Year,values_from=value)%>%
            arrange(Metric,EntitySizeText.GA))


```




