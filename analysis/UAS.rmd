---
title: "Defense Acquisition Trends"
output:
html_document:
keep_md: yes
toc: yes
date: "Wednesday, October 6, 2021"
---
  
# Setup
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from FPDS.

```{r Libraries, echo = FALSE}
 library(csis360)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(scales)

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40
# if(!exists("full_data"))
#   load(file="FPDS_chart_maker//unaggregated_FPDS.Rda")
load(file=file.path("..","data","clean","defense_naics_vendor.rdata"))
load(file="../data/clean/Federal_platpscintl_FPDS.Rda")
load(file="../data/semi_clean/Defense_OTA_contract.Rda")
load(file="../data/semi_clean/Defense_OTA.Rda")

# load(file="../data/semi_clean/platpscintl_FPDS.Rda")
# load(file="../data/semi_clean/sw_FPDS.Rda")
# load(file="../data/clean/jadc2.Rda")

platpscintl$SubCustomer.sum[platpscintl$Customer!="Defense"]<-"Civilian"
fed_lc<-prepare_labels_and_colors(platpscintl)#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
fed_ck<-get_column_key(platpscintl)#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
# column_key<-get_column_key(platpscintl,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
# detail_lc<-prepare_labels_and_colors(platpscintl,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
# detail_ck<-get_column_key(platpscintl,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")


# drone %>% group_by(Customer) %>% summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21,na.rm=TRUE))

ota_def %>% filter(Product_or_Service_Code=="1550") %>% group_by(Fiscal_Year)%>%
  summarise(Dollars_Obligated_OMB23_GDP21=sum(Dollars_Obligated_OMB23_GDP21,na.rm=TRUE))
```


## Preprocess
```{r PreprocessProjectDrone}




platpscintl<-csis360::read_and_join_experiment(platpscintl,
                                                  "ProjectID.txt",
                                                  by=c("ProjectID"),
                                                  add_var="IsRemotelyOperated",
                                                  path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                                                  dir="project/",
                                                  skip_check_var = "IsRemotelyOperated"
)

drone<-platpscintl %>% filter(ProductOrServiceCode==1550 | IsRemotelyOperated==1)


summary(factor(drone$ProjectName))

droneplat<-drone %>% group_by(ProjectName) %>%
  dplyr::summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
                   Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB23_GDP21,0)))%>%
  group_by () %>%#PlatformPortfolio
  mutate(rank_total=rank(desc(Action_Obligation_OMB23_GDP21)),
         rank_2020=rank(desc(Action_Obligation_2020)))
droneplat %>% arrange(desc(Action_Obligation_OMB23_GDP21))


droneplat$TopProject<-
  ifelse(droneplat$rank_2020<=7 | droneplat$rank_total<=7,droneplat$ProjectName,NA)

drone<-left_join(drone,droneplat %>% select(-Action_Obligation_OMB23_GDP21,Action_Obligation_2020),
                 by=c("ProjectName"))

drone$TopProject[is.na(drone$TopProject) & !is.na(drone$ProjectName)]<-
  "Other Labeled Project"


summary(factor(drone$TopProject))



dronePSC<-drone %>% group_by (ProductOrServiceCode,ProductOrServiceCodeText) %>%
  summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
            Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB23_GDP21,0)))%>%
  group_by () %>%
  mutate(rank_total=rank(desc(Action_Obligation_OMB23_GDP21)),
         rank_2020=rank(desc(Action_Obligation_2020)))
dronePSC %>% arrange(desc(Action_Obligation_OMB23_GDP21))

dronePSC$dronePSCode<-
  ifelse(dronePSC$rank_2020<=5 | dronePSC$rank_total<=5,dronePSC$ProductOrServiceCode,NA)
dronePSC$TopPStext<-
  ifelse(dronePSC$rank_2020<=5 | dronePSC$rank_total<=5,dronePSC$ProductOrServiceCodeText,NA)


drone<-left_join(drone,dronePSC %>% select(-Action_Obligation_OMB23_GDP21,Action_Obligation_2020),
                 by=c("ProductOrServiceCode"))

drone$dronePSCode[is.na(drone$dronePSCode) & !is.na(drone$ProductOrServiceCode)]<-
  "Other Labeled PSC"
drone$TopPStext[is.na(drone$TopPStext) & !is.na(drone$ProductOrServiceCode)]<-
  "Other Labeled PSC"

drone$TopPStext<-factor_wrap(drone$TopPStext)

summary(factor(drone$TopPStext))

drone %>% dplyr::group_by(ProjectName, IsRemotelyOperated)  %>% dplyr::summarise(Action_Obligation_2020.x=sum(Action_Obligation_2020.x))

```

## Top projects
### Project
```{r PreprocessProject}

summary(factor(drone$SubCustomer.sum))

topcust<-drone %>% group_by (ProjectName,SubCustomer.sum) %>%
  summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
            Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB23_GDP21,0)))%>%
              group_by (SubCustomer.sum) %>%
    mutate(rank_total=rank(desc(Action_Obligation_OMB23_GDP21)),
                        rank_2020=rank(desc(Action_Obligation_2020)))
topcust %>% arrange(desc(Action_Obligation_OMB23_GDP21))


topcust$TopProject<-
  ifelse(topcust$rank_2020<=3 | topcust$rank_total<=3,topcust$ProjectName,NA)
summary(topcust$TopProject)
drone<-left_join(drone,topcust %>% select(-Action_Obligation_OMB23_GDP21,Action_Obligation_2020),
          by=c("ProjectName","SubCustomer.sum"))
summary(factor(drone$TopProject))

drone$TopProject[is.na(drone$TopProject) & !is.na(drone$ProjectName)]<-
  "Other Labeled Project"


summary(factor(drone$TopProject))


```
### PSC
```{r PreprocessPSC}

summary(factor(platpscintldef$ProjectPlatform))

topPSC<-platpscintldef %>% group_by (ProductOrServiceCode,ProductOrServiceCodeText,PlatformPortfolio) %>%
  summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
            Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB23_GDP21,0)))%>%
              group_by (PlatformPortfolio) %>%
    mutate(rank_total=rank(desc(Action_Obligation_OMB23_GDP21)),
                        rank_2020=rank(desc(Action_Obligation_2020)))
topPSC %>% arrange(desc(Action_Obligation_OMB23_GDP21))

topPSC$TopPScode<-
  ifelse(topPSC$rank_2020<=7 | topPSC$rank_total<=7,topPSC$ProductOrServiceCode,NA)
topPSC$TopPStext<-
  ifelse(topPSC$rank_2020<=7 | topPSC$rank_total<=7,topPSC$ProductOrServiceCodeText,NA)


platpscintldef<-left_join(platpscintldef,topPSC %>% select(-Action_Obligation_OMB23_GDP21,Action_Obligation_2020),
          by=c("ProductOrServiceCode","PlatformPortfolio"))

platpscintldef$TopPScode[is.na(platpscintldef$TopPScode) & !is.na(platpscintldef$ProductOrServiceCode)]<-
  "Other Labeled PSC"
platpscintldef$TopPStext[is.na(platpscintldef$TopPStext) & !is.na(platpscintldef$ProductOrServiceCode)]<-
  "Other Labeled PSC"

platpscintldef$TopPStext<-factor_wrap(platpscintldef$TopPStext)

summary(factor(platpscintldef$TopPStext))


```

# Budget Pull in
Read in the Reaching Farther, Risking Less Budget report.
##
```{r budget}
procurement_uas<-readr::read_delim(file = file.path("..","data","semi_clean","Procurement_Uncrewed_Labeled.txt"),delim="\t",guess_max=3000)
# procurement_remote<-readr::read_delim(file = file.path("..","data","semi_clean","Procurement_Just_Remote.txt"),delim="\t",guess_max=3000)

summary(factor(procurement_uas$Uncrewed.Domain))
colnames(procurement_uas)<-gsub(" ",".",colnames(procurement_uas))
procurement_uas<-procurement_uas%>%dplyr::filter(Crew.Status==2 &
                                                         Uncrewed.Domain %in% c("Aerial","Multi-domain"))



rdte_uas<-readr::read_delim(file = file.path("..","data","semi_clean","RDTE_Remote_Labeled.txt"),delim="\t",guess_max=3000)
colnames(rdte_uas)<-gsub(" ",".",colnames(rdte_remote))
summary(factor(rdte_uas$Domain))

rdte_uas<-rdte_uas%>%dplyr::filter(Crew.Status==2&Domain %in% c("Aerial","Multi-Domain"))



p_long<-procurement_remote %>% pivot_longer(cols=as.character(c(1999:2025)),names_to="Fiscal_Year",values_to="Funding_Const")
r_long<-rdte_remote %>% pivot_longer(cols=as.character(c(1999:2025)),names_to="Fiscal_Year",values_to="Funding_Const")

r_long$Funding_Const<-text_to_number(r_long$Funding_Const)
p_long$Funding_Const<-text_to_number(p_long$Funding_Const)
r_long$Funding_Const<-r_long$Funding_Const*1000
p_long$Funding_Const<-p_long$Funding_Const*1000
colnames(p_long)[colnames(p_long)=="Service"]<-"Subcustomer"
colnames(r_long)[colnames(r_long)=="Service"]<-"Subcustomer"
colnames(p_long)[colnames(p_long)=="Uncrewed.Domain"]<-"Domain"
p_long$ColorOfMoney<-"Procurement"
r_long$ColorOfMoney<-"RDT&E"
inv_long<-rbind(p_long %>%select(Subcustomer,Fiscal_Year,Funding_Const,ColorOfMoney,Domain),
      r_long %>%select(Subcustomer,Fiscal_Year,Funding_Const,ColorOfMoney,Domain))
inv_long$dFYear<-as.Date(paste(inv_long$Fiscal_Year,"1","1",sep="-"))
inv_long$Domain<-factor(inv_long$Domain)
levels(inv_long$Domain)<-list("Aerial"="Aerial"  ,
                              "Ground"="Ground",
                              "Maritime"=c("Maritime (Surface and Undersea)", "Maritime S","Maritime U","Maritime (S&U)"),
                              "Multi-Domain"=c("Multi-domain","Multi-Domain"))

inv_long$Fiscal_Year

write.csv(file="..//Output//Remotely_Crewed//Remotely_Crewed_budget.csv",row.names = FALSE,na = "",
          inv_long %>%
            group_by(Fiscal_Year,ColorOfMoney,Subcustomer)%>%
            summarise(#Fiscal_Year=lubridate::year(dFYear),
              mFunding_Const=sum(Funding_Const,na.rm=TRUE)/1000000)%>%
            arrange(Fiscal_Year)%>%
            pivot_wider(id_cols=c(Subcustomer,ColorOfMoney),
                        names_from=Fiscal_Year,values_from=mFunding_Const)%>%
            arrange(ColorOfMoney,Subcustomer))


```


# Obligations


## Simple 
```{r drone_customer}

(
  rc_psr<-build_plot(
    data=drone  ,
    chart_geom = "Bar Chart",
    share = FALSE,
    # labels_and_colors=drone_lc,
    # NA, #VAR.ncol
    x_var="Fiscal_Year", #x_var
    y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
    color_var="SimpleArea", #color_var
    facet_var="SimpleArea", #facet_var
    # column_key=drone_ck,
    format=TRUE,
    ytextposition=FALSE
  )+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "right")+
    labs(y="Obligations (Constant 2021 $s)",caption="Note: Unlabeled not shown. Source: FPDS; CSIS analysis.")#+
  # facet_wrap(~ContractingAgencyTextSwr,ncol=4)
)

ggsave600dpi(rc_psr,file="..//output//Remotely_Crewed//Remotely_Crewed_psr.png",  
             width=13, height= 6, units="in",size=8, lineheight=1.2
)
ggsave600dpi(rc_psr,file="..//output//Remotely_Crewed//Remotely_Crewed_psr.eps",  
             width=13, height= 6, units="in",size=16, lineheight=1.2
)

write.csv(file="..//Output//Remotely_Crewed//Remotely_Crewed_crewed_psr.csv",row.names = FALSE,na = "",
          dronepscdetail$data %>% mutate(#Fiscal_Year=lubridate::year(dFYear),
            bAction_Obligation_OMB23_GDP21=Action_Obligation_OMB23_GDP21/1000000000)%>%
            arrange(Fiscal_Year)%>%
            pivot_wider(id_cols=c(SimpleArea),
                        names_from=Fiscal_Year,values_from=bAction_Obligation_OMB23_GDP21)%>%
            arrange(SimpleArea),na="")

output_TY<-drone %>%   group_by(SimpleArea,Fiscal_Year)%>%
  dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
  arrange(Fiscal_Year) %>%
  pivot_wider(id_cols=c(SimpleArea),
              names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year) %>%
  arrange(SimpleArea)
write.csv(file="..//Output//Remotely_Crewed//Remotely_Crewed_crewed_psr_cur.csv",row.names = FALSE, na = "",
          output_TY)


output_TY<-drone %>%   group_by(SubCustomer.sum,SimpleArea,Fiscal_Year)%>%
  dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
  arrange(Fiscal_Year) %>%
  pivot_wider(id_cols=c(SubCustomer.sum,SimpleArea),
              names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year) %>%
  arrange(SubCustomer.sum,SimpleArea)
write.csv(file="..//Output//Remotely_Crewed//Remotely_Crewed_crewed_Customer_psr_cur.csv",row.names = FALSE, na = "",
          output_TY)

```

## Customer 
```{r drone_customer}

# drone %>% group_by(claimantprogramcode,ClaimantProgramCodeText) %>% 
#   summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21))
# drone$SubCustomer
(
  rc_customer<-build_plot(
    data=drone %>% filter(Fiscal_Year>=2005) ,
    chart_geom = "Bar Chart",
    share = FALSE,
    labels_and_colors=fed_lc,
    # NA, #VAR.ncol
    x_var="Fiscal_Year", #x_var
    y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
    color_var="SubCustomer.sum", #color_var
    facet_var="SubCustomer.sum", #facet_var
    column_key=fed_ck,
    format=TRUE,
    ytextposition=FALSE
  )+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "right")+
    labs(y="Obligations (Constant 2021 $s)",caption="Note: Unlabeled not shown. Source: FPDS; CSIS analysis.")#+
  # facet_wrap(~ContractingAgencyTextSwr,ncol=4)
)

ggsave600dpi(rc_customer,file="..//output//Remotely_Crewed//Remotely_Crewed_Customer.png",  
             width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
)
ggsave600dpi(rc_customer,file="..//output//Remotely_Crewed//Remotely_Crewed_Customer.svg",  
             width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
)
ggsave600dpi(rc_customer,file="..//output//Remotely_Crewed//Remotely_Crewed_Customer.emf",  
             width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
)

write.csv(file="..//Output//Remotely_Crewed//Remotely_Crewed_crewed_Customer.csv",row.names = FALSE,na = "",
          rc_customer$data %>% mutate(#Fiscal_Year=lubridate::year(dFYear),
            bAction_Obligation_OMB23_GDP21=Action_Obligation_OMB23_GDP21/1000000000)%>%
            arrange(Fiscal_Year)%>%
            pivot_wider(id_cols=c(SubCustomer.sum),
                        names_from=Fiscal_Year,values_from=bAction_Obligation_OMB23_GDP21)%>%
            arrange(SubCustomer.sum))



output_TY<-drone %>%   group_by(SubCustomer.sum,Fiscal_Year)%>%
  dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
  arrange(Fiscal_Year) %>%
  pivot_wider(id_cols=c(SubCustomer.sum),
              names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year) %>%
  arrange(SubCustomer.sum)
write.csv(file="..//Output//Remotely_Crewed//Remotely_Crewed_crewed_Customer_cur.csv",row.names = FALSE, na = "",
          output_TY)

```


## Customer Top Project
```{r drone_customer}

# drone %>% group_by(claimantprogramcode,ClaimantProgramCodeText) %>% 
#   summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21))
# drone$SubCustomer

drone$TopProject<-u
drone$TopProject<-factor(drone$TopProject,
                         levels=c("Other Labeled Project","TACTICAL UAV" ,"MQ-1C Gray Eagle",
                                  "BAMS","VTUAV",
                                  "GLOBAL HAWK" ,"MQ-9 Reaper"  
                                  ))
levels(factor(drone$TopProject))

(
  rc_custproj<-build_plot(
    data=drone %>% filter(Fiscal_Year>=2000) ,
    chart_geom = "Bar Chart",
    share = FALSE,
    labels_and_colors=fed_lc,
    # NA, #VAR.ncol
    x_var="Fiscal_Year", #x_var
    y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
    color_var="TopProject", #color_var
    facet_var="SubCustomer.sum", #facet_var
    column_key=fed_ck,
    format=TRUE,
    ytextposition=FALSE
  )+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "right")+
    labs(y="Obligations (Constant 2021 $s)",caption="Note: Unlabeled not shown. Source: FPDS; CSIS analysis.")#+
  # facet_wrap(~ContractingAgencyTextSwr,ncol=4)
)

ggsave600dpi(rc_custproj,file="..//output//Remotely_Crewed//Remotely_Crewed_Customer_Project.png",  
             width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
)
ggsave600dpi(rc_custproj,file="..//output//Remotely_Crewed//Remotely_Crewed_Customer_Project.svg",  
             width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
)
ggsave600dpi(rc_custproj,file="..//output//Remotely_Crewed//Remotely_Crewed_Customer_Project.emf",  
             width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
)

write.csv(file="..//Output//Remotely_Crewed//Remotely_Crewed_Customer_Project.csv",row.names = FALSE,na = "",
          rc_customer$data %>% mutate(#Fiscal_Year=lubridate::year(dFYear),
            bAction_Obligation_OMB23_GDP21=Action_Obligation_OMB23_GDP21/1000000000)%>%
            arrange(Fiscal_Year)%>%
            pivot_wider(id_cols=c(SubCustomer.sum,TopProject),
                        names_from=Fiscal_Year,values_from=bAction_Obligation_OMB23_GDP21)%>%
            arrange(SubCustomer.sum,TopProject))



output_TY<-drone %>%   group_by(SubCustomer.sum,TopProject,Fiscal_Year)%>%
  dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
  arrange(Fiscal_Year) %>%
  pivot_wider(id_cols=c(SubCustomer.sum,TopProject),
              names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year) %>%
  arrange(SubCustomer.sum,TopProject)
write.csv(file="..//Output//Remotely_Crewed//Remotely_Crewed_crewed_Customer_Proj_cur.csv",row.names = FALSE, na = "",
          output_TY)

```



## Commercial 
```{r drone_customer}

# drone %>% group_by(claimantprogramcode,ClaimantProgramCodeText) %>% 
#   summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21))
# drone$SubCustomer

drone<-drone %>% group_by(SubCustomer.sum,Fiscal_Year) %>%
  dplyr::mutate(pAction_Obligation_SubCustomer=
                     Action_Obligation_Then_Year/sum(Action_Obligation_Then_Year,rm=TRUE))

(
  rc_customer<-build_plot(
    data=drone %>% filter(Fiscal_Year>=2005&AnyCommercial=='Y'&Customer=="Defense") ,
    chart_geom = "Line Chart",
    share = FALSE,
    labels_and_colors=fed_lc,
    # NA, #VAR.ncol
    x_var="Fiscal_Year", #x_var
    y_var="pAction_Obligation_SubCustomer", #VAR.y.variable
    color_var="SubCustomer.sum", #color_var
    # facet_var="SubCustomer.sum", #facet_var
    column_key=fed_ck,
    format=TRUE,
    ytextposition=FALSE
  )+coord_cartesian(ylim=c(0,1))+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "right")+
    labs(y="Obligations (Constant 2021 $s)",caption="Note: Unlabeled not shown. Source: FPDS; CSIS analysis.")#+
  # facet_wrap(~ContractingAgencyTextSwr,ncol=4)
)


(
  rc_commercial<-build_plot(
    data=drone %>% filter(Fiscal_Year>=2005&AnyCommercial %in% c('Y',"NonDev")),
    chart_geom = "Line Chart",
    share = FALSE,
    labels_and_colors=fed_lc,
    # NA, #VAR.ncol
    x_var="Fiscal_Year", #x_var
    y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
    color_var="SubCustomer.sum", #color_var
    # facet_var="SubCustomer.sum", #facet_var
    column_key=fed_ck,
    format=TRUE,
    ytextposition=FALSE
  )+#+coord_cartesian(ylim=c(0,1))+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "right")+
    labs(y="Obligations (Constant 2021 $s)",caption="Source: FPDS; CSIS analysis."
         ,title="UAS obligations using any\ncommercial contracting approaches")
  # facet_wrap(~SubCustomer.sum,nrow=1)
)


# 
ggsave600dpi(rc_commercial,file="..//output//Remotely_Crewed//Remotely_Crewed_Commercial.png",
             width=3.5, height= 3.5, units="in",size=11, lineheight=1.2
)
# ggsave600dpi(rc_customer,file="..//output//Remotely_Crewed//Remotely_Crewed_Customer.svg",  
#              width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
# )
# ggsave600dpi(rc_customer,file="..//output//Remotely_Crewed//Remotely_Crewed_Customer.emf",  
#              width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
# )
# 
# write.csv(file="..//Output//Remotely_Crewed//Remotely_Crewed_crewed_Customer.csv",row.names = FALSE,na = "",
#           rc_customer$data %>% mutate(#Fiscal_Year=lubridate::year(dFYear),
#             bAction_Obligation_OMB23_GDP21=Action_Obligation_OMB23_GDP21/1000000000)%>%
#             arrange(Fiscal_Year)%>%
#             pivot_wider(id_cols=c(SubCustomer.sum),
#                         names_from=Fiscal_Year,values_from=bAction_Obligation_OMB23_GDP21)%>%
#             arrange(SubCustomer.sum))
# 
# 
# 
# output_TY<-drone %>%   group_by(SubCustomer.sum,Fiscal_Year)%>%
#   dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
#   arrange(Fiscal_Year) %>%
#   pivot_wider(id_cols=c(SubCustomer.sum),
#               names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year) %>%
#   arrange(SubCustomer.sum)
# write.csv(file="..//Output//Remotely_Crewed//Remotely_Crewed_crewed_Customer_cur.csv",row.names = FALSE, na = "",
#           output_TY)

```

## Vendor International
```{r ToplineVendor}


(
  RCVendorIntl<-build_plot(
    data=drone %>% filter(Fiscal_Year<=2020),
    chart_geom = "Bar Chart",
    share = FALSE,
    labels_and_colors=labels_and_colors,
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="Action_Obligation_OMB23_GDP21", #VAR.y.variable
    color_var="VendorSize_Intl", #color_var
    # facet_var="Competition.sum", #facet_var
    column_key=column_key,
    format=TRUE,
    ytextposition=FALSE
  )+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
    # theme(strip.text.y = element_text(angle=0))+
    # theme(axis.text.x = element_text(angle=90))+
    #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
    #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
    #             )+labs(title=NULL,
    # x="Fiscal Year",
    # y="Percent of Obligations",
    # color="Competition")+
    theme(legend.position = "right")+
    labs(y="Obligations (Constant 2021 $s)",
         caption="Source: FPDS; CSIS Analysis.\nNote: The merger of Raytheon and United Technologies took place in April of 2020 and thus did not make the cutoff for inclusion in FY2020.")
)

ggsave600dpi("..//Output//Remotely_Crewed//remotely_crewed_vendor_intl_square.png", RCVendorIntl+
               labs(y="Obligations (Constant 2021 $s)",caption="Source: FPDS; CSIS Analysis.\nNote: The merger of Raytheon and United Technologies is took place in \nApril of 2020 and thus did not make the cutoff for inclusion in FY2020."), 
             width=6, height= 5, units="in",size=12,lineheight=1
)



```

###FMS identification
```{r contract_identification}



# undebug(build_plot)

(rc_contract_identification <-  build_plot(data=drone %>% filter(ContractingCustomer=="Defense"),
                                           chart_geom="Bar Chart",
                                           share=FALSE,
                                           x_var="Fiscal_Year",
                                           y_var="Action_Obligation_OMB23_GDP21",
                                           color_var="foreign_funding_description",
                                           facet_var="IsFMS",
                                           # second_var="StateRegion",
                                           labels_and_colors=fed_lc,
                                           column_key=fed_ck,
                                           legend=TRUE,
                                           caption=FALSE,
                                           format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
    labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
      y="Constant 2020 $ Obligated",
      caption="Source: FPDS; CSIS analysis.")+
    guides(fill=guide_legend(ncol=3)))

ggsave600dpi(rc_contract_identification,file="../output//Remotely_Crewed//figure_03_contract_identification.png",
             size=12,lineheight=1, height =5, width=9)



```


### FMS Vendor Size/Intl and Place No JSF
```{r FPDS_vendor_Intl}

summary(factor(platpscintl$Shiny.VendorSize[platpscintl$VendorIsForeign==1]))
summary(platpscintl$VendorSize_Intl)

# undebug(format_data_for_plot)
(fpds_vendor_intl_place_noJSF <-  build_plot(data=drone ,
                                             #IsFMS==TRUE 
                                             chart_geom="Bar Chart",
                                             x_var="Fiscal_Year",
                                             y_var="Action_Obligation_OMB23_GDP21",
                                             color_var="VendorSize_Intl",
                                             # facet_var="PlaceIsForeign",
                                             second_var="IsFMS",
                                             labels_and_colors=fed_lc,
                                             column_key=fed_ck,
                                             legend=TRUE,
                                             caption=FALSE,
                                             format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS )+labs(title="FMS or Performed Internationally, No JSF")#, scales="free_y"
)


# platpscintl$Shiny.VendorSize
(rc_vendor_place_fms <-  build_plot(data=drone %>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign)&
                                                            !is.na(IsFMS)&Fiscal_Year>2011&Fiscal_Year<=2020),#IsFMS==TRUE  
                                    chart_geom="Bar Chart",
                                    x_var="Fiscal_Year",
                                    y_var="Action_Obligation_OMB23_GDP21",
                                    color_var="VendorSize_Intl",
                                    facet_var="PlaceIsForeign",
                                    second_var="IsFMS",
                                    labels_and_colors=fed_lc,
                                    column_key=fed_ck,
                                    legend=TRUE,
                                    caption=FALSE,
                                    format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )+labs(title="FMS or Performed Internationally, No JSF")#, scales="free_y"#, scales="free_y"
)


write.csv(file="..//output//Remotely_Crewed//rc_vendor_place_FMS.csv",row.names = FALSE,na = "",
          rc_vendor_place_fms$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(VendorSize_Intl,IsFMS, PlaceIsForeign),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21)%>% arrange(PlaceIsForeign,IsFMS,VendorSize_Intl))

ggsave600dpi(rc_vendor_place_fms,file="../output/Remotely_Crewed//rc_vendor_place_FMS.png",
             size = 12, lineheight=1, height =4.5, width=9)



```

# Entities


## Count
```{r drone_count}
load(file=file.path("..","data","clean","uav_vendor_count.Rda"))
# platformUAS_only$


# undebug(add_preassigned_scales)
(a<-build_plot(data=platformUAS_only %>% filter(Fiscal_Year>=2010 & PlatformPortfolioRemote %in% 
                                                  c(#"Aircraft","Electronics, Comms, & Sensors",
                                                    #"Ordnance and Missiles",
                                                    "Remotely Operated")&
                                                      IsEntityAbove2018constant10ThousandThreshold==1),
           chart_geom="Bar Chart",
           x_var="Fiscal_Year",
           y_var="EntityCount",
           color_var="EntitySizeText.sum",
           facet_var="PlatformPortfolioRemote",
           # second_var="IsEntityAbove2018constant10ThousandThreshold",
           labels_and_colors=uav_lc,
           column_key=uav_ck,
           legend=TRUE,
           caption=FALSE,
           format=TRUE)+
   facet_wrap(.~PlatformPortfolioRemote,scales="free_y"))



(b<-build_plot(data=platformUAS_only %>% filter(Fiscal_Year>=2005 & PlatformPortfolioRemote %in% 
                                                  c(#"Aircraft","Electronics, Comms, & Sensors",
                                                    #,"Ordnance and Missiles"
                                                    "Remotely Operated")&
                                                      IsEntityAbove2018constant10ThousandThreshold==1),
           chart_geom="Bar Chart",
           x_var="Fiscal_Year",
           y_var="Action_Obligation_OMB23_GDP21",
           color_var="EntitySizeText.sum",
           facet_var="PlatformPortfolioRemote",
           # second_var="IsEntityAbove2018constant10ThousandThreshold",
           labels_and_colors=uav_lc,
           column_key=uav_ck,
           legend=TRUE,
           caption=FALSE,
           format=TRUE)+
   facet_wrap(.~PlatformPortfolioRemote,scales="free_y"))


ggsave600dpi(a,file="../output/Remotely_Crewed//uav_entity_count.png",
             size = 12, lineheight=1, height =4.5, width=9)


ggsave600dpi(b,file="../output/Remotely_Crewed//uav_entity_dollar.png",
             size = 12, lineheight=1, height =4.5, width=9)

```



## Consolidation
```{r drone_count}

# platformUAS_only$

summary(factor(annual_platformUAV_summary$PlatformPortfolioUAV))
summary(annual_platformUAV_summary)
# 
# ggplot(data=annual_platformUAV_summary %>% filter(Fiscal_Year>=1991& !is.na(PlatformPortfolioUAV)),
#        aes(x=Fiscal_Year,y=hh_index))+geom_line()+facet_wrap(~PlatformPortfolioUAV)
# 
# ggplot(data=annual_platformUAV_summary %>% filter(Fiscal_Year>=1991& !is.na(PlatformPortfolioUAV)),
#        aes(x=Fiscal_Year,y=top4))+geom_line()+facet_wrap(~PlatformPortfolioUAV)

annual_platformUAV_summary$Fiscal_Year
undebug(add_preassigned_scales)
# undebug(add_preassigned_scales)
(hhi<-build_plot(data=annual_platformUAV_summary %>% filter(Fiscal_Year>=1991& !is.na(PlatformPortfolioUAV)),
           chart_geom="Line Chart",
           x_var="Fiscal_Year",
           y_var="hh_index",
           color_var="PlatformPortfolioUAV",
           facet_var="PlatformPortfolioUAV",
           # second_var="IsEntityAbove2018constant10ThousandThreshold",
           # labels_and_colors=uav_lc,
           # column_key=uav_ck,
           legend=TRUE,
           caption=FALSE,
           format=TRUE)+
   facet_wrap(.~PlatformPortfolioUAV))


(top4<-build_plot(data=annual_platformUAV_summary %>% filter(Fiscal_Year>=1991& !is.na(PlatformPortfolioUAV)),
           chart_geom="Line Chart",
           x_var="Fiscal_Year",
           y_var="top4",
           color_var="PlatformPortfolioUAV",
           facet_var="PlatformPortfolioUAV",
           # second_var="IsEntityAbove2018constant10ThousandThreshold",
           # labels_and_colors=uav_lc,
           # column_key=uav_ck,
           legend=TRUE,
           caption=FALSE,
           format=TRUE)+
   facet_wrap(.~PlatformPortfolioUAV))




(b<-build_plot(data=platformUAS_only %>% filter(Fiscal_Year>=2005 & PlatformPortfolioRemote %in% 
                                                  c(#"Aircraft","Electronics, Comms, & Sensors",
                                                    #"Ordnance and Missiles"
                                                    "Remotely Operated")&
                                                      IsEntityAbove2018constant10ThousandThreshold==1),
           chart_geom="Bar Chart",
           x_var="Fiscal_Year",
           y_var="Action_Obligation_OMB23_GDP21",
           color_var="EntitySizeText.sum",
           facet_var="PlatformPortfolioRemote",
           # second_var="IsEntityAbove2018constant10ThousandThreshold",
           labels_and_colors=uav_lc,
           column_key=uav_ck,
           legend=TRUE,
           caption=FALSE,
           format=TRUE)+
   facet_wrap(.~PlatformPortfolioRemote,scales="free_y"))


ggsave600dpi(a,file="../output/Remotely_Crewed//uav_entity_count.png",
             size = 12, lineheight=1, height =4.5, width=9)


ggsave600dpi(b,file="../output/Remotely_Crewed//uav_entity_dollar.png",
             size = 12, lineheight=1, height =4.5, width=9)

```
## Top List
```{r drone_count}
  
  defense_platformUAV_vendor<-defense_platform_vendor %>% filter (PlatformPortfolioUAV=="Remotely Operated" ) %>%group_by(PlatformPortfolioUAV) %>%
    dplyr::select(-PlatformPortfolio) %>% 
    group_by(Fiscal_Year,IsRemotelyOperated,EntityID,PlatformPortfolioUAV) %>%
    dplyr::summarize(Action_Obligation=sum(Action_Obligation,na.rm=TRUE),
              NumberOfActions=sum(NumberOfActions,na.rm=TRUE)) %>% 
    deflate(money_var="Action_Obligation")  %>% 
    group_by(EntityID) %>% 
    dplyr::mutate(TotalSpend=sum(Action_Obligation_OMB23_GDP21,na.rm=TRUE))%>% group_by()%>%
                    dplyr::mutate(TotalPos=rank(-TotalSpend,ties="min")) %>% arrange(EntityID)
                
                # TotalPos=rank(-TotalSpend)) %>% arrange(EntityID),
                # TotalPos=rank(-TotalSpend))


defense_platformUAV_vendor<-defense_platformUAV_vendor %>% group_by(PlatformPortfolioUAV,Fiscal_Year) %>%
  dplyr::mutate(
    pos = rank(-Action_Obligation,
               ties.method ="min"),
    pct = ifelse(Action_Obligation>0,
                 Action_Obligation / sum(Action_Obligation[Action_Obligation>0]),
                 NA
    )
  )

topUAV<-defense_platformUAV_vendor%>% filter(pos<=10)%>% arrange(Fiscal_Year,pos)

FPDS_eid_fyear <- read.delim(file.path("../Data/semi_clean/Defense_Vendor.SP_EntityIDhistory.txt"), header=TRUE,  na.strings = c("", "NULL"))
FPDS_eid_fyear$EntityID<-text_to_number(FPDS_eid_fyear$EntityID)
FPDS_eid_fyear<-standardize_variable_names(FPDS_eid_fyear)
colnames(FPDS_eid_fyear)
defense_platformUAV_vendor<-left_join(defense_platformUAV_vendor,FPDS_eid_fyear %>% dplyr::select(-Action_Obligation,-NumberOfActions),
                                      by=c("EntityID","Fiscal_Year"))
colnames(defense_platformUAV_vendor)

topUAVannual<-defense_platformUAV_vendor %>%
  dplyr::mutate(TopEntityText=ifelse(pos<=10,EntityText,"All Other"),
         Toppos=ifelse(pos<=10,pos,0)) %>%
  dplyr::group_by(Fiscal_Year,PlatformPortfolioUAV,TopEntityText,Toppos) %>%
  dplyr::summarize(Action_Obligation=sum(Action_Obligation,na.rm=TRUE)) %>% arrange(Fiscal_Year,Toppos)

topUAV<-deflate(topUAV,money_var="Action_Obligation")
```


### Wide
```{r WideDisplay}

vendorUAVwide<-deflate(defense_platformUAV_vendor,money_var="Action_Obligation") %>%
  filter(Fiscal_Year >=2000 & Fiscal_Year<=2020) %>%
  dplyr::mutate(TopEntityText=ifelse(pos<=10,EntityText,"All Other"),
         Toppos=ifelse(pos<=10,pos,0)) %>%
  dplyr::group_by(PlatformPortfolioUAV,EntityText,EntityID) %>%
  dplyr::mutate(TotalSpend=sum(Action_Obligation_OMB23_GDP21,na.rm=TRUE)) %>%
  pivot_wider(id_cols=c(PlatformPortfolioUAV,EntityText,EntityID,TotalSpend),
              names_from=Fiscal_Year,values_from=Action_Obligation_OMB23_GDP21)%>% 
    group_by() %>% dplyr::mutate(TotalPos=rank(-TotalSpend)) %>% arrange(TotalPos)


write.csv(vendorUAVwide,file="../output/Remotely_Crewed//vendorUAVwide.csv",row.names = FALSE,na = "")
View(defense_platformUAV_vendor %>% filter(TotalPos<=20)%>% arrange(TotalPos,Fiscal_Year))
(
vend_spark<-ggplot(defense_platformUAV_vendor %>% filter(TotalPos<=20),aes(x=Fiscal_Year,y=Action_Obligation_OMB23_GDP21))+
  facet_grid(EntityID~.,scale="free_y")+geom_col()+
    theme_light()+
  theme(axis.title=element_blank(),
        axis.text.y = element_blank(), 
        axis.text.x = element_blank(), 
        axis.ticks = element_blank(),
        strip.text = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.border = element_blank()
        )
)

ggsave(vend_spark+theme(strip.text.y = element_text(angle=0)),
       file=file.path("..","output","Remotely_Crewed","vend_sparkline.png"), width=3.5, height=20)
ggsave(vend_spark+theme(strip.text=element_blank()),
       file=file.path("..","output","Remotely_Crewed","vend_sparkline_notext.png"), width=1, height=20)
ggsave(vend_spark+theme(strip.text.y = element_text(angle=0)),
       file=file.path("..","output","Remotely_Crewed","vend_sparkline.eps"), width=3.5, height=20)
ggsave(vend_spark+theme(strip.text=element_blank()),
       file=file.path("..","output","Remotely_Crewed","vend_sparkline_notext.eps"), width=1, height=20)


```

## Reproduce Vendor Size
```{r EntitySize}

defense_platformUAV_vendor$Fiscal_Year
(b<-build_plot(data=defense_platformUAV_vendor %>% filter(Fiscal_Year>=2005 ),
           chart_geom="Bar Chart",
           x_var="Fiscal_Year",
           y_var="Action_Obligation_OMB23_GDP21",
           color_var="EntitySizeText.sum",
           facet_var="PlatformPortfolioRemote",
           # second_var="IsEntityAbove2018constant10ThousandThreshold",
           labels_and_colors=uav_lc,
           column_key=uav_ck,
           legend=TRUE,
           caption=FALSE,
           format=TRUE)+
   facet_wrap(.~PlatformPortfolioRemote,scales="free_y"))


```
