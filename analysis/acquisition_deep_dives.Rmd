---
title: "Defense Acquisition Trends"
output:
  html_document:
    keep_md: yes
    toc: yes
date: "Wednesday, October 6, 2021"
---

# Setup
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from FPDS.

```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(openxlsx)
library(tidyverse)
library(scales)
library(openxlsx)
axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40
if(!exists("full_data"))
  load(file="FPDS_chart_maker//unaggregated_FPDS.Rda")

load(file="../data/clean/platpscintl_FPDS.Rda")

load(file=file.path("..","data","clean","defense_naics_vendor.rdata"))
# detail_lc<-prepare_labels_and_colors(platpscintldef)#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
# detail_ck<-get_column_key(platpscintldef)#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
# column_key<-get_column_key(platpscintldef,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
# detail_lc<-prepare_labels_and_colors(platpscintldef,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
# detail_ck<-get_column_key(platpscintldef,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
```
# Preprocessing 
## Group By PlatformPortfolio
### Project
```{r PreprocessProject}

# summary(factor(platpscintldef$ProjectPlatform))
# 
# colnames(platpscintldef)[colnames(platpscintldef)=="Action_Obligation_Then_Year_Then_Year"]<-
#   "Action_Obligation_Then_Year"
# 
# topplat<-platpscintldef %>% group_by (Project.Name,PlatformPortfolio) %>%
#   #Exclude NA from ranking and then create a recent only dollar amount
#   mutate(Action_Obligation_2023=if_else(is.na(Project.Name),Action_Obligation_OMB25_GDP23,NA),
#     Action_Obligation_2023=if_else(Fiscal_Year>=2023,Action_Obligation_OMB25_GDP23,NA))%>%
#   summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23,na.rm = TRUE),
#             Action_Obligation_2023=sum(Action_Obligation_2023,na.rm = TRUE))%>%
#               group_by (PlatformPortfolio) %>%
#     mutate(rank_total=rank(desc(Action_Obligation_OMB25_GDP23)),
#                         rank_2023=rank(desc(Action_Obligation_2023)))
# topplat %>% arrange(desc(Action_Obligation_OMB25_GDP23))
# 
# 
# topplat$TopProject<-
#   ifelse(topplat$rank_2023<=7 | topplat$rank_total<=7,topplat$Project.Name,NA)
# 
# platpscintldef<-left_join(platpscintldef,topplat %>% dplyr::select(-Action_Obligation_OMB25_GDP23,Action_Obligation_2023),
#                           by=c("Project.Name","PlatformPortfolio"))
# 
# platpscintldef$TopProject[is.na(platpscintldef$TopProject) & !is.na(platpscintldef$Project.Name)]<-
#   "Other Labeled Project"
# 
# 
# summary(factor(platpscintldef$TopProject))
# 
# 
# colnames(platpscintldef)
# platpscintldef
# 
# write.csv(topplat,file=file.path("..","Output","AcqTrends","Topplat.csv"),row.names=FALSE)
# debug(label_top)
platpscintldef<-label_top(platpscintldef,
                    col="Project.Name",
                    n=7,
                    top_name="TopProject",
                    group_list="PlatformPortfolio",
                    recent=2023
                    #retain_rank=TRUE,
                    #write_file=file.path("..","Output","AcqTrends","TopProjectTest.csv")
                    )




```
### PSC
```{r PreprocessPSC}


# platpscintldef<-label_top(platpscintldef,
#                     col="ProductOrServiceCode",
#                     n=7,
#                     top_name="TopPScode",
#                     group_list="PlatformPortfolio",
#                     recent=2023
#                     #retain_rank=TRUE,
#                     #write_file=file.path("..","Output","AcqTrends","TopProjectTest.csv")
#                     )



summary(factor(platpscintldef$ProjectPlatform))

topPSC<-platpscintldef %>% group_by (ProductOrServiceCode,ProductOrServiceCodeText,PlatformPortfolio) %>%
  mutate(Action_Obligation_2023=ifelse(Fiscal_Year>=2023,Action_Obligation_OMB25_GDP23,NA))
  summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE),
            Action_Obligation_2023=sum(Action_Obligation_2023,na.rm=TRUE))%>%
              group_by (PlatformPortfolio) %>%
    mutate(rank_total=rank(desc(Action_Obligation_OMB25_GDP23)),
                        rank_2023=rank(desc(Action_Obligation_2023)))
topPSC %>% arrange(desc(Action_Obligation_OMB25_GDP23))

topPSC$TopPScode<-
  ifelse(topPSC$rank_2023<=7 | topPSC$rank_total<=7,topPSC$ProductOrServiceCode,NA)
topPSC$TopPStext<-
  ifelse(topPSC$rank_2023<=7 | topPSC$rank_total<=7,topPSC$ProductOrServiceCodeText,NA)


platpscintldef<-left_join(platpscintldef,topPSC %>% select(-Action_Obligation_OMB25_GDP23,Action_Obligation_2023),
          by=c("ProductOrServiceCode","PlatformPortfolio"))

platpscintldef$TopPScode[is.na(platpscintldef$TopPScode) & !is.na(platpscintldef$ProductOrServiceCode)]<-
  "Other Labeled PSC"
platpscintldef$TopPStext[is.na(platpscintldef$TopPStext) & !is.na(platpscintldef$ProductOrServiceCode)]<-
  "Other Labeled PSC"

platpscintldef$TopPStext<-factor_wrap(platpscintldef$TopPStext)

summary(factor(platpscintldef$TopPStext))


```

## Group By ProductOrServiceArea
### Place State
```{r PreprocessState}

# platpscintldef$pop_isna<-is.na(platpscintldef$pop_state_code)
# platpscintldef$sc_isna<-is.na(platpscintldef$PlaceStateCode)
# platpscintldef %>% group_by(Fiscal_Year,pop_isna,sc_isna) %>%
#   summarise(n=length(Fiscal_Year))

# summary(factor(platpscintldef$ProductOrServiceArea))


platpscintldef<-label_top(platpscintldef,
                    col="pop_state_code",
                    n=25,
                    top_name="TopStateAbbr",
                    group_list="ProductOrServiceArea",
                    recent=2023
                    #retain_rank=TRUE,
                    #write_file=file.path("..","Output","AcqTrends","TopProjectTest.csv")
                    )


# topState<-platpscintldef %>% group_by (pop_state_code,ProductOrServiceArea) %>%
#   summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
#             Action_Obligation_2023=sum(ifelse(Fiscal_Year==2023,Action_Obligation_OMB25_GDP23,0)))%>%
#               group_by (ProductOrServiceArea) %>%
#     mutate(rank_total=rank(desc(Action_Obligation_OMB25_GDP23)),
#                         rank_2023=rank(desc(Action_Obligation_2023)))
# topState %>% arrange(desc(Action_Obligation_OMB25_GDP23))
# 
# topState$TopStateAbbr<-
#   ifelse(topState$rank_2023<=25 | topState$rank_total<=25,topState$pop_state_code,NA)
# # topState$TopStateName<-
# #   ifelse(topState$rank_2023<=7 | topState$rank_total<=7,topState$PlaceStateCodeText,NA)
# platpscintldef<-platpscintldef[,!colnames(platpscintldef) %in% c("Action_Obligation_OMB25_GDP23.x","Action_Obligation_OMB25_GDP23.y",
#                                    "Action_Obligation_2023.x","Action_Obligation_2023.y",
#   "rank_total.y","rank_total.x","rank_2023.y","rank_2023.x","TopStateAbbr.x","TopStateAbbr.y")]
# 
# platpscintldef<-left_join(platpscintldef,topState %>% select(-Action_Obligation_OMB25_GDP23,Action_Obligation_2023),
#           by=c("pop_state_code","ProductOrServiceArea"))
# 
# platpscintldef$TopStateAbbr[is.na(platpscintldef$TopStateAbbr) & !is.na(platpscintldef$pop_state_code)]<-
#   "Other Labeled State"
# platpscintldef$TopStateName[is.na(platpscintldef$TopStateName) & !is.na(platpscintldef$pop_state_code)]<-
#   "Other Labeled State"


# summary(factor(platpscintldef$TopStateName))


```

### Place Country
```{r PreprocessCountry}



platpscintldef<-label_top(platpscintldef,
                    col="PlaceISOalpha3",
                    n=7,
                    top_name="TopCountryISO",
                    group_list="ProductOrServiceArea",
                    recent=2023
                    #retain_rank=TRUE,
                    #write_file=file.path("..","Output","AcqTrends","TopProjectTest.csv")
                    )

# 
# # summary(factor(platpscintldef$ProductOrServiceArea))
# colnames(platpscintldef)[colnames(platpscintldef)=="Fiscal_Year"]<-"Fiscal_Year"
# topCountry<-platpscintldef %>% group_by (PlaceISOalpha3,ProductOrServiceArea) %>%
#   summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
#             Action_Obligation_2023=sum(ifelse(Fiscal_Year==2023,Action_Obligation_OMB25_GDP23,0)))%>%
#               group_by (ProductOrServiceArea) %>%
#     mutate(rank_total=rank(desc(Action_Obligation_OMB25_GDP23)),
#                         rank_2023=rank(desc(Action_Obligation_2023)))
# topCountry %>% arrange(desc(Action_Obligation_OMB25_GDP23))
# 
# topCountry$TopCountryISO<-
#   ifelse(topCountry$rank_2023<=7 | topCountry$rank_total<=7,topCountry$PlaceISOalpha3,NA)
# # topCountry$TopCountryName<-
# #   ifelse(topCountry$rank_2023<=7 | topCountry$rank_total<=7,topCountry$PlaceCountryCodeText,NA)
# 
# 
# platpscintldef<-left_join(platpscintldef,topCountry %>% select(-Action_Obligation_OMB25_GDP23,Action_Obligation_2023),
#           by=c("PlaceISOalpha3","ProductOrServiceArea"))
# 
# platpscintldef$TopCountryISO[is.na(platpscintldef$TopCountryISO) & !is.na(platpscintldef$PlaceISOalpha3)]<-
#   "Other Labeled Country"
# # platpscintldef$TopCountryName[is.na(platpscintldef$TopCountryName) & !is.na(platpscintldef$PlaceISOalpha3)]<-
# #   "Other Labeled Country"
# 
# 
# # summary(factor(platpscintldef$TopCountryName))


```



# Component Variant
## SubCustomer with JPO
```{r SubCustomer}

# levels(platpscintl$SubCustomer.JPO)<-list(
#   "Army"="Army",
#   "F-35 Joint Program Office"="F-35 JPO",
#   "Navy"="Navy",
#   "Air Force"="Air Force", 
#   "Defense Logistics Agency" =c("DLA","Defense Logistics Agency"),
#   "Missile Defense Agency"=c("MDA","Missile Defense Agency"),
#   "Other DoD"="Other DoD"
# )
# detail_lc<-prepare_labels_and_colors(platpscintldef)#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
# detail_ck<-get_column_key(platpscintldef)#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
# platpscintldef$SubCustomer[platpscintldef$SubCustomer.JPO=="F-35 Joint Program Office"&SubCustomer.sum!="Navy"]
summary(factor(platpscintldef$SubCustomer.platform))
summary(factor(platpscintldef$SubCustomer))
platpscintldef %>% filter(Fiscal_Year==2023) %>% group_by(SubCustomer) %>% summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))
summary(factor(platpscintldef$SubCustomer.JPO))
platpscintldef$SubCustomer.JPO<-as.character(platpscintldef$SubCustomer.JPO)
platpscintldef$SubCustomer.JPO[platpscintldef$SubCustomer.JPO %in% c("Other DoD","3","6","8")& platpscintldef$SubCustomer!="Uncategorized"]<-
  as.character(platpscintldef$SubCustomer[platpscintldef$SubCustomer.JPO %in% c("Other DoD","3","6","8")& platpscintldef$SubCustomer!="Uncategorized"])

intl_lc<-prepare_labels_and_colors(platpscintldef)

(
SubCustomer<-build_plot(
  data=platpscintldef,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=intl_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SubCustomer.JPO", #color_var
  facet_var="SubCustomer.sum", #facet_var
  column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")+
  facet_wrap(~SubCustomer.sum,nrow=1)+scale_x_date(breaks=
  as.Date(c("1990-1-1","1995-1-1","2000-1-1","2005-1-1","2010-1-1","2015-1-1","2022-1-1")),date_labels="'%y")
)

ggsave600dpi("..//Output//topline_subcustomer_JPO.png", SubCustomer+labs(caption="Source: FPDS and CSIS analysis."), 
             width=6.5, height= 3.5, units="in",size=11,lineheight = 1
             )

ggsave600dpi("..//Output//topline_subcustomer_JPO.eps", SubCustomer+labs(caption="Source: FPDS and CSIS analysis."), 
             width=6.5, height= 3.5, units="in",size=11,lineheight = 1
             )

ggsave600dpi("..//Output//topline_subcustomer_JPO.svg", SubCustomer+labs(caption="Source: FPDS and CSIS analysis."), 
             width=6.5, height= 3.5, units="in",size=11,lineheight = 1
             )
ggsave600dpi("..//Output//topline_subcustomer_JPO.emf", SubCustomer+labs(caption="Source: FPDS and CSIS analysis."), 
             width=6.5, height= 3.5, units="in",size=11,lineheight = 1
             )


ggsave600dpi("..//Output//topline_subcustomer_JPO_wide.png", SubCustomer+labs(caption="Source: FPDS and CSIS analysis."), 
             width=12, height= 5.5, units="in",size=14,lineheight = 1
             )


write.csv(file="..//Output//topline_subcustomer_JPO.csv",row.names = FALSE,na = "",
          SubCustomer$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
          pivot_wider(id_cols=c(SubCustomer.sum,SubCustomer.JPO),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23))

write.csv(file="..//Output//topline_subcustomer_JPO_current.csv",row.names = FALSE,na = "",
          platpscintldef %>% group_by(SubCustomer.sum,SubCustomer.JPO,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(SubCustomer.sum,SubCustomer.JPO),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))


```

# Service variant
## Services
```{r services}

(
Services<-build_plot(
  data=platpscintldef %>% filter(SimpleArea=="Services"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=intl_lc,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="ProductServiceOrRnDarea", #color_var
  # facet_var="Competintl_ckition.sum", #facet_var
  column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi("..//Output//Archives//2022_Trends//cpsr_Services.png", Services, 
             width=12, height= 6, units="in",size=11, lineheight=1.2
             )
                           

ggsave600dpi("..//Output//Archives//2022_Trends//cpsr_Services.svg", Services, 
             width=6.5, height= 3.25, units="in",size=11, lineheight=1.2
             )

write.csv(file="..//Output//cpsr_Services.csv",row.names = FALSE,na = "",
          pivot_wider(Services$data,id_cols=c(ProductServiceOrRnDarea),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)%>%
            arrange(ProductServiceOrRnDarea))
            
log_plot(plot=Services, df=platpscintldef   %>% filter(SimpleArea=="Services"),#%>% filter(Fiscal_YQ<=2023.2)
                     filename="acq_fig3_3_services",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="3-3 Serv",path="../output/AcqTrends/", height=3.5,
                     startRow=1,startCol=12,format=TRUE,#,var_list=c("SimpleArea","Competition.multisum")
         )
```


# Estimates
## Quarterly YTD

```{r}
write.csv(
  full_data %>% group_by(SubCustomer.sum,PlatformPortfolio,SimpleArea,Competition.sum,
                       VendorSize,Fiscal_Year) %>% filter(Fiscal_Year<=2022) %>%
  summarise(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE),
            Action_Obligation_OMB25_GDP23=sum(Action_Obligation_Then_Year,na.rm=TRUE)),"contracting.csv",row.names = FALSE)
  

```

Read in quarterly data from the CSIS database and the current year data from SAM.gov.

```{r EstimatePrep}
y2021<-read.csv(file.path("..","Data_Raw","SAM","Defense_Agency_SignedDate_2021.csv"),skip = 2)
y2021<-standardize_variable_names(y2021)
y2021$Date.Signed<-as.Date(y2021$Date.Signed,"%m/%d/%Y")

q2021<-y2021 %>% mutate(fiscal_quarter=lubridate::quarter(Date.Signed,fiscal_start=10),
                        ContractingCustomer=ifelse(Contracting.Department.ID=="9700","Defense","Non-Defense")) %>%
  group_by(Fiscal_Year,fiscal_quarter,ContractingCustomer) %>%
  dplyr::summarize(Action_Obligation=sum(csis360::text_to_number(Dollars.Obligated),na.rm=TRUE),
            minSD=min(Date.Signed),
            maxSD=max(Date.Signed))%>% filter(fiscal_quarter<=3)

q2021<-q2021 %>% dplyr::select(Fiscal_Year,fiscal_quarter,Action_Obligation,ContractingCustomer)
# colnames(q2021)[colnames(q2021)=="Fiscal_Year"]<-"Fiscal_Year"
# colnames(q2021)[colnames(q2021)=="Fiscal_Year"]<-"Fiscal_Year"


quarterly<-read.csv(file.path("..","Data","Semi_Clean","Defense_Contract.FiscalQuarter.csv"),na.strings = "NULL")
quarterly<-standardize_variable_names(quarterly)
quarterly<-remove_bom(quarterly)
quarterly$fiscal_quarter<-as.numeric(quarterly$fiscal_quarter)-1
quarterly <- quarterly %>% filter(Fiscal_Year>=2000)  %>% arrange(Fiscal_Year,fiscal_quarter)
if(any(is.na(quarterly$Fiscal_Year))) stop("NA Quarters")

quarterlyYTD<-rbind(as.data.frame(quarterly),as.data.frame(q2021 ))
quarterlyYTD<-deflate(quarterlyYTD,money_var = "Action_Obligation",deflator_var="OMB20_GDP20")
colnames(quarterlyYTD)
toa$fiscal_quarter<-NA
toa$Action_Obligation_Then_Year<-NA
toa$Action_Obligation_OMB25_GDP23<-NA
toa$ContractingCustomer<-"Defense"
quarterlyYTD$Total_Obligation_Authority_OMB20_GDP20<-NA
quarterlyYTD$Total_Obligation_Authority_Then_Year<-NA
quarterlyYTD<-rbind(quarterlyYTD,toa %>% dplyr::select(-Series, -dFYear))

```

## Estimate last quarter
Create a univariate model that estimates the fourth quarter based on the first three quarters.

This isn't a perfect representation, as the spending in the first three quarters will continue to fluctuate even well after the 90 day delay for DoD has expired. In theory, there could be slightly greater precision by tracking the first three quarters at a consistent point in each year. However, that's not a level of history that can be straightforwardly reconstructed.  
```{r Model}


a<-quarterlyYTD %>% group_by(Fiscal_Year) %>% filter(Fiscal_Year<2021 & !is.na(fiscal_quarter))%>% dplyr::summarise(
  q1toq3=sum(ifelse(fiscal_quarter<=3,Action_Obligation_OMB25_GDP23,0)),
  q4=sum(ifelse(fiscal_quarter==4,Action_Obligation_OMB25_GDP23,0)),
             total=sum(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))
)
a$NewAdmin<-0
a$NewAdmin[a$Fiscal_Year %in% c(2001,2009,2017,2021)]<-1

m<-lm(data=a,q4~q1toq3)
m2<-lm(data=a,q4~q1toq3+NewAdmin)
summary(m)
summary(m2)
# plot(m)

q1to13_2021<-sum(ifelse(quarterlyYTD$fiscal_quarter<=3 & !is.na(quarterlyYTD$fiscal_quarter) & quarterlyYTD$Fiscal_Year==2021,quarterlyYTD$Action_Obligation_OMB25_GDP23,0))

cvalues<-data.frame(q1toq3=q1to13_2021)

p<-predict(m,cvalues,interval="prediction")
e2021<-data.frame(Fiscal_Year=2021,
           fiscal_quarter=4,
           Action_Obligation_Then_Year=NA,
           Action_Obligation_OMB25_GDP23=NA,
           yest=p[1]+q1to13_2021,
           lwr=p[2]+q1to13_2021,
           upr=p[3]+q1to13_2021,
           ContractingCustomer="Defense",
           Actual="Estimate",
           Total_Obligation_Authority_OMB20_GDP20=NA,
           Total_Obligation_Authority_Then_Year=NA
           )
rm(q1to13_2021,cvalues)
```
The first three years made a pretty good estimator. However, adding a variable based on whether it was the first year of a new adminsitration added nothing to the model.


## TOA Topline Quarterly
```{r TOA}

quarterlyYTD$Actual<-"Actual"
quarterlyYTD$lwr<-NA
quarterlyYTD$upr<-NA
quarterlyYTD$yest<-NA

# build_plot(data=rbind(quarterly,q2021,e2021),
#            x_var="Fiscal_Year",
#            y_var="Action_Obligation_OMB25_GDP23",
#            color_var = "fiscal_quarter",
#            facet_var="Actual",
#            chart_geom="Bar Chart")+facet_wrap(~)
quarterlyEst<-rbind(quarterlyYTD,e2021)
quarterlyEst$Actual<-factor(quarterlyEst$Actual,levels=c("Estimate","Actual"))
quarterlyEst$fiscal_quarter<-factor(quarterlyEst$fiscal_quarter,c("4","3","2","1"))
quarterlyEst$dFYear<-as.Date(paste("1/1/",as.character(quarterlyEst$Fiscal_Year),sep=""),"%m/%d/%Y")

(topline_q<-ggplot(data=quarterlyEst %>% filter(Fiscal_Year>=2000) #rbind(quarterly,q2021,e2021),
      )+geom_col( aes(x=dFYear,
           y=Action_Obligation_OMB25_GDP23/1000000000,
           # alpha=Actual,
           fill = fiscal_quarter
       ))+
    geom_path(aes(x=dFYear,y=Total_Obligation_Authority_OMB20_GDP20/1000000000),group="Quarter")+
  # scale_alpha_discrete(range=c(0.4,1))+
  geom_errorbar(aes(x=dFYear,ymin=lwr/1000000000,ymax=upr/1000000000,y=yest/1000000000,color = fiscal_quarter))+
    geom_point(aes(x=dFYear,ymin=lwr/1000000000,ymax=upr/1000000000,y=yest/1000000000,color = fiscal_quarter))+
    scale_color_discrete("Estimate")+
    labs(x="Fiscal Year",y="Constant FY 2022 $ Billions",fill="Quarter")
)

write.csv(file="..//Output//toa_topline.csv",row.names = FALSE,na="",
          quarterlyEst %>% mutate(fiscal_quarter=ifelse(!is.na(Total_Obligation_Authority_OMB20_GDP20),"TOA",fiscal_quarter),
                                            Dollars_GDP20=ifelse(fiscal_quarter=="TOA",
                                                                 Total_Obligation_Authority_OMB20_GDP20,Action_Obligation_OMB25_GDP23))%>%
            filter(Fiscal_Year>=2000)%>%
          format_data_for_plot(
                               fy_var="Fiscal_Year",
                               y_var="Dollars_GDP20",
                               color_var="fiscal_quarter",
                               # facet="SubCustomer",
                               # labels_and_colors = ota_lc,
                               group=TRUE) %>%
            arrange(Fiscal_Year) %>%
            mutate(Dollars_GDP20=Dollars_GDP20/1000000000)%>%
          pivot_wider(id_cols=c(fiscal_quarter),
                      names_from=Fiscal_Year,values_from=Dollars_GDP20) %>% 
            
            # mutate(PlatformPortfolio=factor(PlatformPortfolio,levels=ota_lc$variable[ota_lc$column=="PlatformPortfolio"]))%>%
            # mutate(PlatformPortfolio=factor(PlatformPortfolio,levels=levels(fiscal_quarter),
            #                                 labels=gsub("\\n"," ",levels(PlatformPortfolio))))%>%
                   arrange(fiscal_quarter))


ggsave600dpi(topline_q,file=file.path("..","Output","toa_quarterly.png"),  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )
```

# Top Projects Annual
## Write Projects
```{r TopProject}
summary(platpscintldef$PlatformPortfolio[platpscintldef$ProductOrServiceCode=='AC11'])

topoverall<-platpscintldef %>% group_by (Project.Name,Fiscal_Year) %>%
  summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))%>%
              group_by (Fiscal_Year) %>%
    mutate(rank_annual=rank(desc(Action_Obligation_OMB25_GDP23))) %>%
  arrange(desc(Fiscal_Year) ,desc(Action_Obligation_OMB25_GDP23))


topoverall$TopProject<-
  ifelse(topoverall$rank_annual<=11,topoverall$Project.Name,NA)
#11 because NA counts as one.


topoverall$TopProject[is.na(topoverall$TopProject) & !is.na(topoverall$Project.Name)]<-
  "Other Labeled Project"


write.csv(topoverall %>% group_by(TopProject,Fiscal_Year) %>%
            summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))%>%
            arrange(desc(Fiscal_Year) ,desc(Action_Obligation_OMB25_GDP23))
          
          ,file="TopAnnualDoDproject.csv",row.names = FALSE)


# platpscintldef<-left_join(platpscintldef,topplat %>% select(-Action_Obligation_OMB25_GDP23,Action_Obligation_2023),
#           by=c("Project.Name","PlatformPortfolio"))


```

## Platform Multi-Year
```{r PlatformMultiyear}

platpscintldef<-label_top(platpscintldef,
                    col="Project.Name",
                    n=5,
                    top_name="TopProjectMY",
                    group_list=c("multiyearcontract"),
                    recent=2023
                    #retain_rank=TRUE,
                    #write_file=file.path("..","Output","AcqTrends","TopProjectTest.csv")
                    )

summary(factor(platpscintldef$TopProjectMY))
    platpscintldef<-platpscintldef%>% mutate(multiyearcontracttext=factor(multiyearcontract,levels=c("0","1"),
                              labels=c("Not Multiyear","Multiyear Contract")))

platpscintldef<-platpscintldef %>% group_by(Fiscal_Year,PlatformPortfolio)%>%
  mutate(pPlatFYear=Action_Obligation_OMB25_GDP23/sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))

(
PlatformMultiYearProject<-build_plot(
  data=platpscintldef %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<2024 &  (multiyearcontract==1)
                           & !is.na(PlatformPortfolio)&
                              PlatformPortfolio!="Unlabeled"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=intl_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopProjectMY", #color_var
  facet_var="PlatformPortfolio",
  column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,6)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",
       caption="Note: When the multi-year column is blank, transactions are treated as not multiyear.\nSource: FPDS and CSIS analysis.")
)

platpscintldef<-platpscintldef %>% group_by(Fiscal_Year,PlatformPortfolio)%>%
  mutate(pPlatFYear=Action_Obligation_OMB25_GDP23/sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))
(
PlatformMultiYearShare<-build_plot(
  data=platpscintldef %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<2024 &
                             (multiyearcontract==1)&
                              !is.na(PlatformPortfolio)&
                              PlatformPortfolio!="Unlabeled"), #is.na(multiyearcontract)|
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=intl_lc,
  # NA, #VAR.ncol
  x_var="dFYear",
  # alpha_var="YTD", #x_var
  y_var="pPlatFYear", #VAR.y.variable
  color_var="TopProjectMY", #color_var
  facet_var="PlatformPortfolio",
  column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,6)+#,partial_year=2024,partial_label="\nQ1")   
    
  theme(legend.position = "bottom")+
  labs(y="Share of Portfolio Obligations\nGoing to Multiyear Contracts",
       title="Share of Contract Obligations Employing Multiyear Procurement by Platform and the Top Seven Projects, FY 2000-FY 2023",
       caption="Note: When the multi-year column is blank, transactions are treated as not multiyear.\nSource: FPDS and CSIS analysis.")+
    scale_y_continuous(labels = percent)
)



ggsave600dpi(path="..//Output//AcqTrends//",filename="Platform_MultiYearShare_keynote.png", 
               PlatformMultiYearShare+labs(
                 title="DOD Share of Contract Obligations to Multiyear Contracts, 2000–2023")+
                 facet_wrap(PlatformPortfolio~.,nrow=2)+
                labs(y="Share of Obligations",
       caption="Note: When the multi-year column is empty, transactions are treated as not multiyear.\nSource: FPDS and CSIS analysis.")#+geom_line(aes(x=dFYear,y=pPlatFYear,group=YTD,linetype=YTD),linewidth=2),  
             # width=13, height= 5.5, units="in",size=20, lineheight=1.2
             )

log_plot(plot=PlatformMultiYearShare, df=platpscintldef %>% filter(Fiscal_YQ<2024),
                     filename="nps_fig07_multiyearproj",xlsx="DoD_2024_NPS.xlsx",
                     sheet="7 MultProj",path="../output/AcqTrends/NPS2024/",
         second_path = online_path,
         height=3.5,include_YTD=FALSE,csv_then_year = FALSE,excel_then_year = FALSE,
                     startRow=1,format=TRUE,excel_y_var=TRUE,excel_formulas = TRUE,
         output_doc_svg=TRUE
         )



```
## Platform GFE
```{r GFEplatform}


platpscintldef<-label_top(platpscintldef,
                    col="Project.Name",
                    n=5,
                    top_name="TopProjectGFE",
                    group_list=c("gfe_gfp_code"),
                    recent=2023
                    #retain_rank=TRUE,
                    #write_file=file.path("..","Output","AcqTrends","TopProjectTest.csv")
                    )

platpscintldef<-platpscintldef %>% group_by(Fiscal_Year,PlatformPortfolio)%>%
  mutate(pPlatFYear=Action_Obligation_OMB25_GDP23/sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))

(
PlatformGFEshare<-build_plot(
  data=platpscintldef %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024 & gfe_gfp_code=="Y"&
                             !is.na(PlatformPortfolio) & PlatformPortfolio!="Unlabeled") ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  color_var="TopProjectGFE", #color_var
  y_var="pPlatFYear", #VAR.y.variable
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  date_x_year_breaks(2007,2023,4)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "bottom")+
  labs(y="Share of Portfolio Obligations\nwith Government Furnished Equipment or Property"
       # caption="Note: When the multi-year column is blank, transactions are treated as not multiyear.\nSource: FPDS and CSIS analysis."
       )+
    scale_y_continuous(labels = percent)
)

log_plot(PlatformGFEshare, platpscintldef%>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024 & gfe_gfp_code=="Y"&
                             !is.na(PlatformPortfolio) & PlatformPortfolio!="Unlabeled") ,
                     filename="acq_fig4_3_gfe",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="4-3 GFEtop",path="../output/AcqTrends/", height=3,excel_y_var = TRUE,excel_formulas = FALSE,
                     startRow=1,startCol=13,format=TRUE,y_var="Action_Obligation_OMB25_GDP23"
         # var_list=c("PlatformPortfolio","gfe_gfp_value"),
         )

log_plot(PlatformGFEshare+
           labs(y="Share of Obligations\nwith Government Furnished\nEquipment or Property",
                caption=NULL) , platpscintldef%>% 
           filter(Fiscal_Year>=2007 & Fiscal_YQ<2024 & gfe_gfp_code=="Y"&
                    !is.na(PlatformPortfolio) & PlatformPortfolio!="Unlabeled"),
                     filename="nps_figXX_gfe_plat",xlsx="DoD_2024_NPS.xlsx",
         sheet="9 GFEtop",
          path="../output/AcqTrends/NPS2024/",second_path=online_path,
         height=3,include_YTD=FALSE,excel_then_year = FALSE, csv_then_year = FALSE,
                     startRow=1,format=TRUE,excel_y_var=TRUE,excel_formulas = TRUE,
         output_doc_svg=TRUE
         )
         

```

# Top PSCs 
## Platform Multi-Year
```{r PlatformMultiyear}

platpscintldef<-label_top(platpscintldef,
                    col="ProductOrServiceCodeText",
                    n=5,
                    top_name="TopPSCtextMY",
                    group_list=c("multiyearcontract"),
                    recent=2023
                    #retain_rank=TRUE,
                    #write_file=file.path("..","Output","AcqTrends","TopProjectTest.csv")
                    )

intl_lc<-prepare_labels_and_colors(platpscintldef, path="offline")
intl_ck<-get_column_key(platpscintldef, path="offline")

summary(factor(platpscintldef$TopProjectMY))
    platpscintldef<-platpscintldef%>% mutate(multiyearcontracttext=factor(multiyearcontract,levels=c("0","1"),
                              labels=c("Not Multiyear","Multiyear Contract")))

platpscintldef<-platpscintldef %>% group_by(Fiscal_Year,PlatformPortfolio)%>%
  mutate(pPlatFYear=Action_Obligation_OMB25_GDP23/sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))

(
PlatformMultiyearPSC<-build_plot(
  data=platpscintldef %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<2024 &  (multiyearcontract==1)
                           & !is.na(PlatformPortfolio)&
                              PlatformPortfolio!="Unlabeled"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=intl_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopPSCtextMY", #color_var
  facet_var="PlatformPortfolio",
  column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,6)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",
       title="DOD Contract Obligations to Multi-Year Procuement\nby Platform and Product or Service, 2000–2023",
       caption="Note: When the multi-year column is blank, transactions are treated as not multiyear.\nSource: FPDS and CSIS analysis.")
)

platpscintldef<-platpscintldef %>% group_by(Fiscal_Year,PlatformPortfolio)%>%
  mutate(pPlatFYear=Action_Obligation_OMB25_GDP23/sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))



(
PlatformMultiYearShare<-build_plot(
  data=platpscintldef %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<2024 &
                             (multiyearcontract==1)&
                              !is.na(PlatformPortfolio)&
                              PlatformPortfolio!="Unlabeled"), #is.na(multiyearcontract)|
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=intl_lc,
  # NA, #VAR.ncol
  x_var="dFYear",
  # alpha_var="YTD", #x_var
  y_var="pPlatFYear", #VAR.y.variable
  color_var="TopPSCtextMY", #color_var
  facet_var="PlatformPortfolio",
  column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,6)+#,partial_year=2024,partial_label="\nQ1")   
    
  theme(legend.position = "right")+guides(fill=guide_legend(ncol=1))+
  labs(y="Share of Portfolio Obligations\nGoing to Multiyear Contracts",
       title="Market Share of Multiyear DOD Contracts\nby Platform and Product or Service, FY 2000–FY 2023",
       caption="Note: When the multi-year column is blank, transactions are treated as not multiyear.\nSource: FPDS and CSIS analysis.")+
    scale_y_continuous(labels = percent)
)



ggsave600dpi(path="..//Output//AcqTrends//",filename="Platform_MultiYearShare_keynote.png", 
               PlatformMultiYearShare+
                 facet_wrap(PlatformPortfolio~.,nrow=2),
             #+geom_line(aes(x=dFYear,y=pPlatFYear,group=YTD,linetype=YTD),linewidth=2),  
              width=13, height= 5.5, units="in",size=20, lineheight=1.2
             )

log_plot(plot=PlatformMultiYearShare+facet_wrap(~PlatformPortfolio,ncol=4)+theme(legend.position = "bottom")+guides(fill=guide_legend(ncol=4)), df=platpscintldef %>% 
           filter(Fiscal_YQ<2024 & multiyearcontract==1),
                     filename="nps_fig07_multiyearPSC",xlsx="DoD_2024_NPS.xlsx",
                     sheet="11 MultPSC",path="../output/AcqTrends/NPS2024/",
         second_path = online_path,y_var="Action_Obligation_OMB25_GDP23",
         output_doc_png=TRUE,
         height=4.75,include_YTD=FALSE,csv_then_year = FALSE,excel_then_year = FALSE,
                     startRow=1,format=TRUE,excel_y_var=TRUE,excel_formulas = TRUE,
         var_list = c("PlatformPortfolio","TopPSCtextMY")
         )

#Legend on the right for the slide version.
ggsave600dpi(PlatformMultiYearShare,path="..//Output//AcqTrends//NPS2024//",filename="nps_fig07_multiyearPSC_slide.png",
              width=13, height= 5.5, units="in",size=20, lineheight=1.2,second_path = online_path
             )

ggsave600dpi(path="..//Output//AcqTrends//NPS2024//",filename="nps_fig07_multiyearPSC_slide.png", 
               PlatformMultiYearShare+theme(legend.position = "right"),
              width=13, height= 5.5, units="in",size=20, lineheight=1,
             second_path = online_path
             )


```

# Redundant Summaries
## Topline  Platform
```{r Platform}

(
Platform<-build_plot(
  data=platpscintldef,
  chart_geom = "Line Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PlatformPortfolio", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi("..//Output//topline_platform.png", Platform, 
             width=12, height= 6, units="in",size=14,lineheight = 1.2
             )

ggsave600dpi("..//Output//topline_platform.svg", Platform, 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi("..//Output//topline_platform.emf", Platform+geom_line(
  size=1,aes(x=dFYear,y=Action_Obligation_OMB25_GDP23,color=PlatformPortfolio)),
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )


(
Platform_Bar<-build_plot(
  data=platpscintldef,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PlatformPortfolio", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi("..//Output//topline_platform_bar.png", Platform_Bar, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi("..//Output//topline_platform_bar.emf", Platform_Bar,
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )





```

## R&D phase
```{r RnD}

platpscintldef  %>% filter(SimpleArea=="R&D") %>% group_by(ProductOrServiceCode,
                                                           ProductOrServiceCodeText.x,
                                                           ProductServiceOrRnDarea) %>%
  summarise(n=nrow(ProductOrServiceCode),
            minFY=min(Fiscal_Year),
            maxFY=max(Fiscal_Year))

(
RnDphase<-build_plot(
  data=platpscintldef %>% filter(SimpleArea=="R&D"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=intl_lc,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="ProductServiceOrRnDarea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi("..//Output//psr_RnDPhase.png", RnDphase, 
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )
                           

write.csv(file="..//Output//psr_RnDPhase.csv",row.names = FALSE, na = "",
          pivot_wider(RnDphase$data,id_cols=c(ProductServiceOrRnDarea),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)%>%
            arrange(ProductServiceOrRnDarea))
            

output_TY<-platpscintldef %>% filter(Fiscal_YQ<2023) %>% filter(SimpleArea=="R&D") %>%
            format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "ProductServiceOrRnDarea",
                                 labels_and_colors=labels_and_colors) %>%
          pivot_wider(id_cols=c(ProductServiceOrRnDarea),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(ProductServiceOrRnDarea)

write.csv(file="..//Output//psr_RnDPhase_current.csv",row.names = FALSE, na = "",
          output_TY)

# wb <- loadWorkbook("..//Output//DoD_Acq_Trends_Contracts.xlsx", create = TRUE)
# createSheet(wb, name = "R&D")
# writeWorksheet(wb, output_TY, sheet = "R&D", startRow = 15, startCol = 13)
# saveWorkbook(wb)

```



# Customers and all projects / PSC 
## Topline SubCustomer 
```{r SubCustomer}
platpscintldef$SubCustomer

platpscintldef %>% group_by(SubCustomer,Fiscal_Year) %>% filter(SubCustomer=="SDA") %>%
  summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23)) %>% arrange(
    Fiscal_Year
  )

(
SubCustomer<-build_plot(
  data=platpscintldef %>% filter(Fiscal_Year<2024),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SubCustomer", #color_var
  facet_var="SubCustomer.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)") +date_x_year_breaks(1990,2020,5)#,partial_year=2024,partial_label="\nQ1")
)

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_subcustomer.png", SubCustomer, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_subcustomer.svg", SubCustomer+facet_wrap(~SubCustomer.sum,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",second_path=online_path,filename="topline_subcustomer_keynote.svg", SubCustomer+
               facet_wrap(~SubCustomer.sum,nrow=1)+
               labs(title="DOD Contract Obligations by Component, 1990–2023")+
               date_x_year_breaks(1990,2020,8),#,partial_year=2024,partial_label="\nQ1"), 
             width=13, height= 5.5, units="in", size=20, lineheight = 0.75
             )

log_plot(plot=SubCustomer+facet_wrap(~SubCustomer.sum,nrow=1)+
           date_x_year_breaks(1990,2020,8),#,partial_year=2024,partial_label="\nQ1"),
         df=platpscintldef %>% filter(Fiscal_YQ<2024),
                     filename="acq_fig2_3_subcustomer",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="2-3 Cust",path="../output/AcqTrends/",second_path=online_path, height=3.5,
                     startRow=1,startCol=13,format=TRUE,var_list=c("SubCustomer.sum","SubCustomer.JPO")
         )

```

### Project Customer Breakout
```{r ProjPlatBreakout} 
subcustomer_levels<-levels(factor(platpscintldef$SubCustomer.sum))
for(c in subcustomer_levels){
  file_c<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",c)))
  
  

  if(!dir.exists(file.path("../output/AcqTrends/Customer",file_c)))
    dir.create(file.path("../output/AcqTrends/Customer",file_c))

  log_plot(plot=NULL, df=platpscintldef %>% filter(Fiscal_Year>=2000&Fiscal_YQ<=2023.2&SubCustomer.sum==c),
           filename=paste(file_c,"all_project",sep="_"),xlsx=paste(file_c,"Contracts.xlsx",sep="_"),
           x_var="Fiscal_Year",y_var="Action_Obligation_OMB25_GDP23",
           sheet="AllProj",path=file.path("../output/AcqTrends/Customer/",file_c),
           csv_then_year=TRUE,excel_then_year = FALSE, excel_y_var=TRUE,excel_formula=TRUE,
           startRow=1,startCol=14,format=TRUE,var_list=c("PlatformPortfolio","Project.Name","ProjectID"),
           output_doc_png=FALSE, output_doc_svg = FALSE
           )

}
```


### PSC Customer Breakout
```{r PSCcustBreakout} 
subcustomer_levels<-levels(factor(platpscintldef$SubCustomer.sum))
for(c in subcustomer_levels){
  file_c<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",c)))
  
  

  if(!dir.exists(file.path("../output/AcqTrends/Customer",file_c)))
    dir.create(file.path("../output/AcqTrends/Customer",file_c))

  log_plot(plot=NULL, df=platpscintldef %>% filter(Fiscal_Year>=2000&Fiscal_Year<=2023&SubCustomer.sum==c),
           filename=paste(file_c,"all_psc",sep="_"),xlsx=paste(file_c,"Contracts.xlsx",sep="_"),
           x_var="Fiscal_Year",y_var="Action_Obligation_OMB25_GDP23",
           sheet="AllPSC",path=file.path("../output/AcqTrends/Customer/",file_c),
           csv_then_year=TRUE,excel_then_year = FALSE, excel_y_var=TRUE,excel_formulas = TRUE,
           startRow=1,startCol=13,format=TRUE,var_list=c("ProductOrServiceArea","ProductOrServiceCode","ProductOrServiceCodeText.x"),
           output_doc_png=FALSE, output_doc_svg = FALSE
           )

}
```


# Platforms and Top Projects / PSC


### Project Plat Breakout
```{r ProjPlatBreakout} 
platform_levels<-levels(factor(platpscintldef$PlatformPortfolio))


for(p in platform_levels){
  file_p<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",p)))
  
  (Breakout<-build_plot(
    data=platpscintldef %>% filter(Fiscal_Year>=2000&Fiscal_Year<=2023&PlatformPortfolio==p),
 chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)",title=p)
)

  if(!dir.exists(file.path("../output/AcqTrends/Platform",file_p)))
    dir.create(file.path("../output/AcqTrends/Platform",file_p))
  undebug(log_plot)
  log_plot(plot=Breakout, df=platpscintldef %>% filter(Fiscal_Year>=2000&Fiscal_Year<=2023&PlatformPortfolio==p),
           filename=paste(file_p,"top_project",sep="_"),xlsx=paste("DoD",file_p,"Contracts.xlsx",sep="_"),
           sheet="Proj",path=file.path("../output/AcqTrends/Platform/",file_p), height=3.5,
           startRow=1,startCol=13,format=TRUE,#var_list=c("Vehicle.AwardTask","Vehicle.sum7"),
           output_doc_png=TRUE,excel_y_var=TRUE,excel_formula=TRUE
           )
  #All PSCs
  
  log_plot(plot=Breakout, df=platpscintldef %>% filter(Fiscal_Year>=2000&Fiscal_Year<=2023&PlatformPortfolio==p),
           filename=paste(file_p,"all_psc",sep="_"),xlsx=paste("DoD",file_p,"Contracts.xlsx",sep="_"),
           sheet="AllProj",path=file.path("../output/AcqTrends/Platform/",file_p),
           csv_then_year=TRUE,excel_then_year = FALSE, excel_y_var=TRUE,excel_formula=TRUE,
           startRow=1,startCol=15,format=TRUE,var_list=c("Project.Name","ProjectID"),
           output_doc_png=FALSE, output_doc_svg = FALSE
           )

}
```


### PSC Platform Breakout
```{r PSCplatBreakout} 
platform_levels<-levels(factor(platpscintldef$PlatformPortfolio))


for(p in platform_levels){
  file_p<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",p)))
  
  (Breakout<-build_plot(
    data=platpscintldef %>% filter(Fiscal_Year>=2000&Fiscal_Year<=2023&PlatformPortfolio==p),
    chart_geom = "Line Chart",
    share = FALSE,
    # labels_and_colors=labels_and_colors,
    x_var="dFYear", #x_var
    y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
    color_var="TopPStext", #color_var
    facet_var="TopPStext", #facet_var
    # column_key=intl_ck,
    format=TRUE,
    ytextposition=FALSE
  )+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
      theme(legend.position = "none")+
      labs(y="Obligations (Constant 2023 $s)")
  )
  
  
  
  if(!dir.exists(file.path("../output/AcqTrends/Platform",file_p)))
    dir.create(file.path("../output/AcqTrends/Platform",file_p))
  
  log_plot(plot=Breakout, platpscintldef %>% filter(Fiscal_Year>=2000&Fiscal_Year<=2023&PlatformPortfolio==p),
           filename=paste(file_p,"top_PSC",sep="_"),xlsx=paste("DoD",file_p,"Contracts.xlsx",sep="_"),
           sheet="PSC",path=file.path("../output/AcqTrends/Platform/",file_p), height=3.5,
           startRow=1,startCol=13,format=TRUE,#,var_list=c("Vehicle.AwardTask","Vehicle.sum7"),
           output_doc_png=TRUE,excel_y_var=TRUE,excel_formula=TRUE
  )
  
  #All Project IDs
  log_plot(plot=Breakout, df=platpscintldef %>% filter(Fiscal_Year>=2000&Fiscal_Year<=2023&PlatformPortfolio==p),
           filename=paste(file_p,"top_PSC",sep="_"),xlsx=paste("DoD",file_p,"Contracts.xlsx",sep="_"),
           sheet="AllPSC",path=file.path("../output/AcqTrends/Platform/",file_p),
           csv_then_year=FALSE,excel_then_year = FALSE, excel_y_var=TRUE,excel_formula=TRUE,
           startRow=1,startCol=15,format=TRUE,var_list=c("Project.Name","ProjectID"),
           output_doc_png=FALSE, output_doc_svg = FALSE
           )

  
}
```

## Aircraft System
```{r Aircraft}
# summary(factor(platpscintldef$ProjectPlatform))
# platpscintldef$Fiscal_Year
# 
# topplat<-platpscintldef %>% filter(PlatformPortfolio=="Aircraft") %>% group_by (Project.Name) %>%
#   summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
#             )
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB25_GDP23)),
#                         rank_2023=rank(desc(Action_Obligation_2023)))
# topplat %>% arrange(desc(Action_Obligation_OMB25_GDP23))
# 
# platpscintldef$TopAircraftProject<-
#   ifelse(platpscintldef$Project.Name %in% topplat$Project.Name[topplat$rank_2023<=7 | topplat$rank_total<=7],
#          platpscintldef$Project.Name,NA)
# platpscintldef$TopAircraftProject[is.na(platpscintldef$TopAircraftProject) & !is.na(platpscintldef$Project.Name)]<-
#   "Other Labeled Project"
# summary(factor(platpscintldef$TopAircraftProject))


(
Platform<-build_plot(
  data=platpscintldef %>% filter(PlatformPortfolio=="Aircraft"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)
  
  
  write.csv(file="..//Output//Aircraft_project_cur.csv",row.names = FALSE,na = "",
            platpscintldef %>% filter(PlatformPortfolio=="Aircraft")  %>%
              format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "TopProject"#,
                                   # labels_and_colors=labels_and_colors
                                   )%>% arrange(Fiscal_Year) %>%
            pivot_wider(id_cols=c(TopProject),
                        names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
              arrange(TopProject))
```

## Ships and Submarines
```{r ShipsAndSubs}
# summary(factor(platpscintldef$ProjectPlatform))
# platpscintldef$Fiscal_Year
# 
# topplat<-platpscintldef %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (Project.Name) %>%
#   summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
#             )
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB25_GDP23)),
#                         rank_2023=rank(desc(Action_Obligation_2023)))
# topplat %>% arrange(desc(Action_Obligation_OMB25_GDP23))
# 
# platpscintldef$TopShipProject<-
#   ifelse(platpscintldef$Project.Name %in% topplat$Project.Name[topplat$rank_2023<=7 | topplat$rank_total<=7],
#          platpscintldef$Project.Name,NA)
# platpscintldef$TopShipProject[is.na(platpscintldef$TopShipProject) & !is.na(platpscintldef$Project.Name)]<-
#   "Other Labeled Project"
# summary(factor(platpscintldef$TopShipProject))


(
Platform<-build_plot(
  data=platpscintldef %>% filter(PlatformPortfolio=="Ships & Submarines"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)

 write.csv(file="..//Output//ShipSub_project_current.csv",row.names = FALSE,na="",
            platpscintldef %>% filter(PlatformPortfolio=="Ships & Submarines")  %>%
              format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "TopProject"#,
                                   # labels_and_colors=labels_and_colors
                                   )%>% arrange(Fiscal_Year) %>%
            pivot_wider(id_cols=c(TopProject),
                        names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
              arrange(TopProject))
```
 

## Ordnance and Missiles
```{r OrdMissiles}
summary(factor(platpscintldef$ProjectPlatform))


# platpscintldef$Fiscal_Year
# 
# topplat<-platpscintldef %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (Project.Name) %>%
#   summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
#             )
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB25_GDP23)),
#                         rank_2023=rank(desc(Action_Obligation_2023)))
# topplat %>% arrange(desc(Action_Obligation_OMB25_GDP23))
# 
# platpscintldef$TopShipProject<-
#   ifelse(platpscintldef$Project.Name %in% topplat$Project.Name[topplat$rank_2023<=7 | topplat$rank_total<=7],
#          platpscintldef$Project.Name,NA)
# platpscintldef$TopShipProject[is.na(platpscintldef$TopShipProject) & !is.na(platpscintldef$Project.Name)]<-
#   "Other Labeled Project"
summary(factor(platpscintldef$TopProject[platpscintldef$PlatformPortfolio=="Ordnance and Missiles"]))


(
Platform<-build_plot(
  data=platpscintldef %>% filter(PlatformPortfolio=="Ordnance and Missiles"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)



(
PSC<-build_plot(
  data=platpscintldef %>% filter(PlatformPortfolio=="Ordnance and Missiles"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)

summary(platpscintldef$PlatformPortfolio[platpscintldef$ProjectID %in% c(1916,137,2240)])
platpscintldef$PlatformPortfolio[platpscintldef$ProjectID %in% c(1916,137,2240)]<-"Missile Defense"

#Project ID 1916 (PATRIOT MISSILE SYS), 137 ('BALLISTIC MISSILE DEFENSE', 2240, LTAMDS should all be air and missile defense. Fixed in databse), 
write.csv(file="..//Output//OrdMiss_psc_current.csv",row.names = FALSE,na="",
            platpscintldef %>% filter(PlatformPortfolio=="Ordnance and Missiles")  %>%
              format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "TopPStext"#,
                                   # labels_and_colors=labels_and_colors
                                   )%>% arrange(Fiscal_Year) %>%
            pivot_wider(id_cols=c(TopPStext),
                        names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
              arrange(TopPStext))


ggsave600dpi("..//Output//topline_platform.png", Platform, 
             width=12, height= 6, units="in",size=14,lineheight = 1.2
             )

ggsave600dpi("..//Output//topline_platform.svg", Platform, 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi("..//Output//topline_platform.emf", Platform+geom_line(
  size=1,aes(x=dFYear,y=Action_Obligation_OMB25_GDP23,color=PlatformPortfolio)),
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )


(
Platform_Bar<-build_plot(
  data=platpscintldef,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PlatformPortfolio", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi("..//Output//topline_platform_bar.png", Platform_Bar, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi("..//Output//topline_platform_bar.emf", Platform_Bar,
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

output_TY<-full_data %>% group_by(PlatformPortfolio,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(PlatformPortfolio),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%arrange(PlatformPortfolio)

write.csv(file="..//Output//topline_platform_current.csv",row.names = FALSE, na = "",
          output_TY)

wb <- loadWorkbook("..//Output//DoD_Acq_Trends_Contracts.xlsx")
# addWorksheet(wb, sheetName = "Platform Portfolio")
 writeData(wb, output_TY, sheet = "Platform Portfolio", startRow = 1, startCol = 1)
saveWorkbook(wb,file="..//Output//DoD_Acq_Trends_Contracts.xlsx",overwrite = TRUE)
rm(wb)

```

## Air and Missile Defense
```{r Defense}
summary(factor(platpscintldef$ProjectPlatform))
# platpscintldef$Fiscal_Year
# 
# topplat<-platpscintldef %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (Project.Name) %>%
#   summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
#             )
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB25_GDP23)),
#                         rank_2023=rank(desc(Action_Obligation_2023)))
# topplat %>% arrange(desc(Action_Obligation_OMB25_GDP23))
# 
# platpscintldef$TopShipProject<-
#   ifelse(platpscintldef$Project.Name %in% topplat$Project.Name[topplat$rank_2023<=7 | topplat$rank_total<=7],
#          platpscintldef$Project.Name,NA)
# platpscintldef$TopShipProject[is.na(platpscintldef$TopShipProject) & !is.na(platpscintldef$Project.Name)]<-
#   "Other Labeled Project"
# summary(factor(platpscintldef$TopShipProject))


(
Platform<-build_plot(
  data=platpscintldef %>% filter(PlatformPortfolio=="Missile Defense"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)



(
PSC<-build_plot(
  data=platpscintldef %>% filter(PlatformPortfolio=="Missile Defense"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)


```

## Electronics Comms and Sensors
```{r ElecCommsSensors}
summary(factor(platpscintldef$ProjectPlatform))
# platpscintldef$Fiscal_Year
# 
# topplat<-platpscintldef %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (Project.Name) %>%
#   summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
#             )
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB25_GDP23)),
#                         rank_2023=rank(desc(Action_Obligation_2023)))
# topplat %>% arrange(desc(Action_Obligation_OMB25_GDP23))
# 
# platpscintldef$TopShipProject<-
#   ifelse(platpscintldef$Project.Name %in% topplat$Project.Name[topplat$rank_2023<=7 | topplat$rank_total<=7],
#          platpscintldef$Project.Name,NA)
# platpscintldef$TopShipProject[is.na(platpscintldef$TopShipProject) & !is.na(platpscintldef$Project.Name)]<-
#   "Other Labeled Project"
# summary(factor(platpscintldef$TopShipProject))


(
Platform<-build_plot(
  data=platpscintldef %>% filter(PlatformPortfolio=="Electronics, Comms, & Sensors"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)



(
PSC<-build_plot(
  data=platpscintldef %>% filter(PlatformPortfolio=="Electronics, Comms, & Sensors"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)

```


## Space Systems
```{r Space}
summary(factor(platpscintldef$ProjectPlatform))
# platpscintldef$Fiscal_Year
# 
# topplat<-platpscintldef %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (Project.Name) %>%
#   summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
#             )
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB25_GDP23)),
#                         rank_2023=rank(desc(Action_Obligation_2023)))
# topplat %>% arrange(desc(Action_Obligation_OMB25_GDP23))
# 
# platpscintldef$TopShipProject<-
#   ifelse(platpscintldef$Project.Name %in% topplat$Project.Name[topplat$rank_2023<=7 | topplat$rank_total<=7],
#          platpscintldef$Project.Name,NA)
# platpscintldef$TopShipProject[is.na(platpscintldef$TopShipProject) & !is.na(platpscintldef$Project.Name)]<-
#   "Other Labeled Project"
# summary(factor(platpscintldef$TopShipProject))


(
Platform<-build_plot(
  data=platpscintldef %>% filter(PlatformPortfolio=="Space Systems"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)


(
PSC<-build_plot(
  data=platpscintldef %>% filter(PlatformPortfolio=="Space Systems"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)

```

## Land Vehicles
```{r Land}
summary(factor(platpscintldef$ProjectPlatform))
# platpscintldef$Fiscal_Year
# 
# topplat<-platpscintldef %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (Project.Name) %>%
#   summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
#             )
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB25_GDP23)),
#                         rank_2023=rank(desc(Action_Obligation_2023)))
# topplat %>% arrange(desc(Action_Obligation_OMB25_GDP23))
# 
# platpscintldef$TopShipProject<-
#   ifelse(platpscintldef$Project.Name %in% topplat$Project.Name[topplat$rank_2023<=7 | topplat$rank_total<=7],
#          platpscintldef$Project.Name,NA)
# platpscintldef$TopShipProject[is.na(platpscintldef$TopShipProject) & !is.na(platpscintldef$Project.Name)]<-
#   "Other Labeled Project"
# summary(factor(platpscintldef$TopShipProject))


(
Platform<-build_plot(
  data=platpscintldef %>% filter(PlatformPortfolio=="Land Vehicles"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)


(
PSC<-build_plot(
  data=platpscintldef %>% filter(PlatformPortfolio=="Land Vehicles"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)

```


### Vendor Size and Count via Entity
```{r drone_count}

# undebug(add_preassigned_scales)

# defense_land_vendor$EntitySizeText.GA<-as.character(defense_land_vendor$EntitySizeText)
# defense_land_vendor$EntitySizeText.GA[defense_land_vendor$EntityText=="GENERAL ATOMICS"&
#                                        !is.na(defense_land_vendor$EntityText)]<-"General Atomics"

entity_lc<-prepare_labels_and_colors(defense_platformUAV_vendor)#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
entity_ck<-get_column_key(defense_platformUAV_vendor)#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
defense_platformUAV_vendor$EntityCount<-1


defense_entity_both<-defense_platformUAV_vendor %>% filter(PlatformPortfolioUAV=="Land Vehicles")%>% pivot_longer(cols=c(EntityCount,Action_Obligation_OMB25_GDP23),names_to = "Metric")







(a<-build_plot(data=defense_platformUAV_vendor %>% filter(Fiscal_Year>=2005& Fiscal_Year<=2022 & 
                                                       PlatformPortfolioUAV=="Land Vehicles" &
                                                    IsEntityAbove2018constant10ThousandThreshold==1),# & PlatformPortfolioUAV %in% 
                                                  c(#"Aircraft","Electronics, Comms, & Sensors",
                                                    #"Remotely Operated","Ordnance and Missiles")&
                                                      ),
           chart_geom="Bar Chart",
           x_var="dFYear",
           y_var="EntityCount",
           color_var="EntitySizeText.sum",
           facet_var="None",
           # second_var="IsEntityAbove2018constant10ThousandThreshold",
           labels_and_colors=entity_lc,
           column_key=entity_ck,
           legend=TRUE,
           caption=FALSE,
           format=TRUE,
           share=FALSE)+
    labs(y="Number of Entities"))#+
   #facet_wrap(.~PlatformPortfolioUAV,scales="free_y"))



# summary(factor(defense_platformUAV_vendor$EntitySizeText))

(b<-build_plot(data=defense_platformUAV_vendor %>% filter(Fiscal_Year>=2005& Fiscal_Year<=2022 &
                                                       PlatformPortfolioUAV=="Land Vehicles"),
           chart_geom="Bar Chart",
           x_var="dFYear",
           y_var="Action_Obligation_OMB25_GDP23",
           color_var="EntitySizeText",
           # facet_var="PlatformPortfolioUAVRemote",
           # second_var="IsEntityAbove2018constant10ThousandThreshold",
           labels_and_colors=entity_lc,
           column_key=entity_ck,
           legend=TRUE,
           caption=FALSE,
           format=TRUE)#+
   # facet_wrap(.~PlatformPortfolioUAVRemote,scales="free_y"))
)


ggsave600dpi(a,file="../output/land//land_entity_count.png",
             size = 12, lineheight=1, height =4.5, width=9)


ggsave600dpi(b,file="../output/land//land_entity_dollar.png",
             size = 12, lineheight=1, height =4.5, width=9)


(ab<-build_plot(data=defense_entity_both %>% filter(Fiscal_Year>=2005&
                                                    IsEntityAbove2018constant10ThousandThreshold==1& Fiscal_Year<=2022 &
                                                       PlatformPortfolioUAV=="Land Vehicles"),# & PlatformPortfolioUAV %in% 
                                                  c(#"Aircraft","Electronics, Comms, & Sensors",
                                                    #"Remotely Operated","Ordnance and Missiles")&
                                                      ),
           chart_geom="Bar Chart",
           x_var="dFYear",
           y_var="value",
           color_var="EntitySizeText",
           facet_var="Metric",
           # second_var="IsEntityAbove2018constant10ThousandThreshold",
           labels_and_colors=prepare_labels_and_colors(defense_entity_both),
           column_key=get_column_key(defense_entity_both),
           legend=TRUE,
           caption=FALSE,
           format=TRUE,
           share=FALSE)+
    labs(y=NULL)+
   facet_wrap(.~Metric,scales="free_y")+
    theme(legend.position = "right"))


ggsave600dpi(ab,
                          file="../output/land//land_entity_count_size.png",
              size = 12, lineheight=1,height =3.5, width=6.5)


ggsave600dpi(ab,
                          file="../output/land//land_entity_count_size.svg",
              size = 12, lineheight=1,height =3.5, width=6.5)

```




## Facility Related And Construction
```{r FRSnC}
summary(factor(platpscintldef$ProjectPlatform))
# platpscintldef$Fiscal_Year
# 
# topplat<-platpscintldef %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (Project.Name) %>%
#   summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
#             )
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB25_GDP23)),
#                         rank_2023=rank(desc(Action_Obligation_2023)))
# topplat %>% arrange(desc(Action_Obligation_OMB25_GDP23))
# 
# platpscintldef$TopShipProject<-
#   ifelse(platpscintldef$Project.Name %in% topplat$Project.Name[topplat$rank_2023<=7 | topplat$rank_total<=7],
#          platpscintldef$Project.Name,NA)
# platpscintldef$TopShipProject[is.na(platpscintldef$TopShipProject) & !is.na(platpscintldef$Project.Name)]<-
#   "Other Labeled Project"
# summary(factor(platpscintldef$TopShipProject))


(
Platform<-build_plot(
  data=platpscintldef %>% filter(PlatformPortfolio=="Facilities and Construction"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)


(
PSC<-build_plot(
  data=platpscintldef %>% filter(PlatformPortfolio=="Facilities and Construction"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)

```

## Construction
```{r FRSnC}
summary(factor(platpscintldef$ProductOrServiceArea))
# platpscintldef$Fiscal_Year
# 
# topplat<-platpscintldef %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (Project.Name) %>%
#   summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
#             )
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB25_GDP23)),
#                         rank_2023=rank(desc(Action_Obligation_2023)))
# topplat %>% arrange(desc(Action_Obligation_OMB25_GDP23))
# 
# platpscintldef$TopShipProject<-
#   ifelse(platpscintldef$Project.Name %in% topplat$Project.Name[topplat$rank_2023<=7 | topplat$rank_total<=7],
#          platpscintldef$Project.Name,NA)
# platpscintldef$TopShipProject[is.na(platpscintldef$TopShipProject) & !is.na(platpscintldef$Project.Name)]<-
#   "Other Labeled Project"
# summary(factor(platpscintldef$TopShipProject))

(
State<-build_plot(
  data=platpscintldef %>% filter(ProductOrServiceArea=="Construction"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopStateAbbr", #color_var
  facet_var="TopStateAbbr", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)
ggsave(State,file="construction_state.png")
(
State<-build_plot(
  data=platpscintldef %>% filter(ProductOrServiceArea=="Construction"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopStateAbbr", #color_var
  facet_var="TopStateAbbr", #facet_var
  second_var="SubCustomer",
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)


(
Country<-build_plot(
  data=platpscintldef %>% filter(ProductOrServiceArea=="Construction"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopCountryISO", #color_var
  facet_var="TopCountryISO", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)


(
PSC<-build_plot(
  data=platpscintldef %>% filter(PlatformPortfolio=="Construction"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)

```


## Other Products
```{r OtherProducts}
summary(factor(platpscintldef$PlatformPortfolio))
# platpscintldef$Fiscal_Year
# 
# topplat<-platpscintldef %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (Project.Name) %>%
#   summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
#             )
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB25_GDP23)),
#                         rank_2023=rank(desc(Action_Obligation_2023)))
# topplat %>% arrange(desc(Action_Obligation_OMB25_GDP23))
# 
# platpscintldef$TopShipProject<-
#   ifelse(platpscintldef$Project.Name %in% topplat$Project.Name[topplat$rank_2023<=7 | topplat$rank_total<=7],
#          platpscintldef$Project.Name,NA)
# platpscintldef$TopShipProject[is.na(platpscintldef$TopShipProject) & !is.na(platpscintldef$Project.Name)]<-
#   "Other Labeled Project"
# summary(factor(platpscintldef$TopShipProject))


(
Platform<-build_plot(
  data=platpscintldef %>% filter(PlatformPortfolio=="Other Products"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)


(
PSC<-build_plot(
  data=platpscintldef %>% filter(PlatformPortfolio=="Other Products"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)

```
### Army Investigation
```{r ArmyOtherProducts}
armyDB<-platpscintldef %>% filter(SubCustomer=="Army" & PlatformPortfolio=="Other Products" & 
                                    Fiscal_Year==2023 & ProductOrServiceCodeText.x=="DRUGS AND BIOLOGICALS")


# armyDB$off
# summary(armyOP$TopPStext)

```



# NAICS sector
## High Tech Setup
```{r HighTechSetup}
if(!exists("hightech"))
  load(file.path("..","Data","Clean","hightech_FPDS.rda"))

hightech$YTD<-factor(ifelse(hightech$Fiscal_Year==max(hightech$Fiscal_Year),"YTD","Full Year"),levels=c("Full Year","YTD"))
hightech$CriticalTech[hightech$CriticalTech==""]<-"Rest of Defense"
hightech$costorpricingdata[hightech$costorpricingdata==""]<-NA

hightech$costaccountingstandardsclause[hightech$costaccountingstandardsclause==""]<-NA
hightech$casorffp<-hightech$costaccountingstandardsclause
hightech$casorffp[is.na(hightech$costaccountingstandardsclause)&
                    hightech$PricingUCA.sum=="FFP"]<-"CAS Status Unknown, but FFP"
hightech$casorffp[is.na(hightech$costaccountingstandardsclause)&
                    hightech$PricingUCA.sum!="FFP"]<-"Other Unlabeled"
hightech$casorffp<-factor(hightech$casorffp)

levels(hightech$casorffp)=list(
  "No CAS or CAS Waived"=c("N","X"),
  "CAS Status Unknown, but FFP"="CAS Status Unknown, but FFP",
  "CAS Clause"="Y",
  "Other Unlabeled"="Other Unlabeled"
)

hightech_ck<-get_column_key(hightech,path="offline")
hightech_lc<-prepare_labels_and_colors(hightech,path="offline")


```

## Pricing and Cost Accounting Standards
```{r PricingCostAccount}


  (
  costaccountingstandardsclause<-build_plot(
    data=hightech %>% filter(Fiscal_Year>=2000),
    chart_geom = "Bar Chart",
    share = FALSE,
    labels_and_colors=hightech_lc,
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
    color_var="costaccountingstandardsclause", #color_var
    alpha_var="YTD",
    facet_var="PricingUCA", #facet_var
    # second_var = "PricingUCA.sum",
    column_key=hightech_ck,
    format=TRUE,
    ytextposition=FALSE,
  reverse_color=TRUE
  )+ theme(legend.position = "right")+facet_wrap(~PricingUCA, scales="free_y")+
    labs(y="Obligations (Constant 2023 $s,\nVariable Scale)",x="Fiscal Year",
         title="Defense Contracts by Pricing Mechanism and\nCost Accounting Standards (CAS) Clause")+
    date_x_year_breaks(start=2000, stop =2025,by=5)
  )


       
log_plot(plot=costaccountingstandardsclause, df=hightech%>% filter(Fiscal_Year>=2000),
                     filename="PricingCAS",xlsx="NonTraditional.xlsx",
                     sheet="PrCAS", height=3.5,path="../Output/AcqTrends/",
                     format=TRUE,excel_formulas=TRUE,
         var_list=c("PricingUCA","costaccountingstandardsclause")
         )


  (
  costorpricingdata<-build_plot(
    data=hightech %>% filter(Fiscal_Year>=2000),
    chart_geom = "Bar Chart",
    share = FALSE,
    labels_and_colors=hightech_lc,
    # NA, #VAR.ncol
    x_var="dFYear", #x_var
    y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
    color_var="costorpricingdata", #color_var
    alpha_var="YTD",
    facet_var="PricingUCA", #facet_var
    column_key=hightech_ck,
    format=TRUE,
    ytextposition=FALSE,
    reverse_color = TRUE
  )+
    theme(legend.position = "right")+facet_wrap(~PricingUCA, scales="free_y")+
    labs(y="Obligations (Constant 2023 $s, Variable Scale)",x="Fiscal Year",
         title="Defense Contracts by Pricing Mechanism and\nCost or Pricing Data Obtained")+
    date_x_year_breaks(start=2000, stop =2025,by=5)
  )


       
log_plot(plot=costorpricingdata, df=hightech%>% filter(Fiscal_Year>=2000),
                     filename="PricingCoP",xlsx="NonTraditional.xlsx",
                     sheet="PrCoP", height=3.5,path="../Output/AcqTrends/",
                     format=TRUE,excel_formulas=TRUE,
         var_list=c("PricingUCA","costorpricingdata")
         )

```

## High Tech

```{r HighTech}
(
Unlabeled<-build_plot(
  data=hightech %>% filter(is.na(CriticalTech) ),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=hightech_lc,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="casorffp", #color_var
  facet_var="CriticalTech", #facet_var
  column_key=hightech_ck,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Current $s)",x="Economic Sector Relevant to Critical Tech")
)



(
HighTech<-build_plot(
  data=hightech %>% filter(!CriticalTech %in% c("Unlabeled","")&!is.na(CriticalTech)&
                               Fiscal_Year>=2011),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=hightech_lc,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="casorffp", #color_var
  alpha_var="YTD",
  facet_var="CriticalTech", #facet_var
  column_key=hightech_ck,
  format=TRUE,
  ytextposition=FALSE,
  reverse_color=TRUE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s, \nVariable Scale)",x="Economic Sector Relevant to Critical Tech")+
    facet_wrap(~CriticalTech,scales="free_y")
  
  # coord_flip()+
)


(
HighTechShare<-build_plot(
  data=hightech %>% filter(!CriticalTech %in% c("Unlabeled","")&!is.na(CriticalTech)&
                               Fiscal_Year>=2011),
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=hightech_lc,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="casorffp", #color_var
  alpha_var="YTD",
  facet_var="CriticalTech", #facet_var
  column_key=hightech_ck,
  format=TRUE,
  ytextposition=FALSE,
  reverse_color=TRUE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Share of Inflation\nAdjusted Obligations",x="Economic Sector Relevant to Critical Tech")#+
  # coord_flip()#+facet_wrap(~CriticalTech,scales="free",ncol=1)
)

ht2<-gridExtra::grid.arrange(HighTech+theme(legend.position="none")+labs(caption="Note: Critical technologies are only a subset of each sector. \nUnlabeled NAICS are excluded.",title="High Tech Sectors"),HighTechShare+labs(x=NULL,y="Share of Obligations",title="2000-2023 YTD",caption="Source: FPDS, academic high\ntech sector labeling, and CSIS analysis."),nrow=1)


ggsave(HighTech+labs(title="Addressable Market for Nontraditional Vendors\nBased on Use of Cost Accounting Standards (CAS), FY 2011-2023 YTD"),file="HighTechCostAccountingAnnual.png",width=9,height=4.5)

          
log_plot(plot=HighTech, df=hightech%>% filter(Fiscal_Year>=2018),
                     filename="HighTechCAS",xlsx="HighTechnology.xlsx",
                     sheet="HighTechCase", height=3.5,path="../Output/AcqTrends/",
                     startCol = 1, format=TRUE,excel_formulas=TRUE,
         var_list=c("CriticalTech","casorffp")
         )

ggsave(ht2,file="HighTechCostAccountingAnnual.png",width=9,height=4.5)
```

#Inflation
## Fuel
```{r Fuel}

# PlaceIsForeign
# full_data$PlaceStateRegion
# replace_nas_with_unlabeled(factor(full_data$PlaceIsForeign,levels=c(1,0),labels=c("Performed Abroad","Performed in the U.S."))

full_data$SimpleArea.fuels<- as.character( full_data$SimpleArea)
full_data$SimpleArea.fuels[full_data$ProductServiceOrRnDarea=="Fuels"]<-"Fuels"
summary(factor(full_data$SimpleArea.fuels))
full_data$SimpleArea.fuels<-factor(full_data$SimpleArea.fuels,
                                           levels=c("Services (Non-R&D)" ,
                                                   "R&D",
                                                   "Products (All)",
                                                   "Fuels",
                                                   "Unlabeled" ),
                                           labels=c("Services (Non-R&D)" ,
                                                   "R&D",
                                                   "Products (Non-Fuels)",
                                                   "Fuels",
                                                   "Unlabeled" ))
summary(factor(full_data$SimpleArea.fuels))
labels_and_colors<-prepare_labels_and_colors(full_data,path="C:\\Users\\gsand\\Repositories\\Lookup-Tables\\style\\")
column_key<-get_column_key(full_data,path="C:\\Users\\gsand\\Repositories\\Lookup-Tables\\style\\")


(
psrfuel<-build_plot(
  data=full_data,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SimpleArea.fuels", #color_var
  # facet_var="TopPStext", #facet_var
  column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  # theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)",
              caption = "Source: FPDS, CSIS Analysis, OMB GDP deflators.")
)

  ggsave600dpi(filename = "..//Output//PSRfuels.png", psrfuel,  
               width=12, height= 5.6, units="in",size=18, lineheight=1.2,
               bg="transparent"
               )

write.csv(file="..//Output//PSRfuels.csv",row.names = FALSE, na = "",
  pivot_wider(psrfuel$data %>% 
                        arrange(dFYear) %>% mutate(Fiscal_Year=lubridate::year(dFYear)),
                      id_cols=c(SimpleArea.fuels),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23)%>%
    arrange(SimpleArea.fuels))


(
fuel<-build_plot(
  data=full_data %>% filter(ProductOrServiceArea=="Fuels")%>% 
    mutate(PlaceIsForeign=factor(PlaceIsForeign,levels=c(1,0),labels=c("Performed Abroad","Performed in the U.S."))),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PlaceStateRegion", #color_var
  # facet_var="TopPStext", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  # theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)",
       caption = "Source: FPDS, CSIS Analysis, OMB GDP deflators.")
)


(
fuel<-build_plot(
  data=full_data %>% filter(ProductOrServiceArea=="Fuels")%>% 
    mutate(PlaceIsForeign=factor(PlaceIsForeign,levels=c(1,0),labels=c("Performed Abroad","Performed in the U.S."))),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PlaceIsForeign", #color_var
  # facet_var="TopPStext", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  # theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi("..//Output//Deep_Dives/Inflation/defense_fuel_place.png", fuel+labs(title="DoD Contract Obligations for Fuels", caption="Source: FPDS and CSIS analysis."), 
             width=6.5, height= 3.5, units="in",size=12,lineheight = 1
             )


write.csv(file="..//Output//Deep_Dives/Inflation/defense_fuel_place.csv",row.names = FALSE,na = "",
          fuel$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
          pivot_wider(id_cols=c(PlaceIsForeign),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23))



(
fuel_psc<-build_plot(
  data=platpscintldef %>% filter(ProductOrServiceArea=="Fuels")%>% 
    mutate(PlaceIsForeign=factor(PlaceIsForeign,levels=c(1,0),labels=c("Performed Abroad","Performed in the U.S."))),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="ProductOrServiceCodeText", #color_var
  # facet_var="TopPStext", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  # theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)

```



## Pricing History
```{r ToplinePricing}
load(file="../data/clean/pricing_historical.Rda")
# full_data$PricingUCA.sumlong<-full_data$PricingUCA.sum
# levels(full_data$PricingInflation)<-list("FFP"="FFP",
#                                            "Less Common"="Less Common",
#                                            "Cost-Based"="Cost-Based",
#                                            "FP-Econ. Price Adj. "="Other CB",
#                                            "Undefinitized\nContract Award"="UCA",
#                                            "Unclear"="Unclear"   )
(
HistoricPricing<-build_plot(
  data=pricing %>% filter(Fiscal_Year>=1979 & Fiscal_Year<=2021 ),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=pricing_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  # y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  y_var="Action_Obligation", #VAR.y.variable
  color_var="PricingInflation", #color_var
  # facet_var="PricingUCA.sumlong", #facet_var
  column_key=pricing_ck,
  format=TRUE,
  ytextposition=FALSE,
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right",rect = element_rect(fill = "transparent",))
  # labs(y="Obligations (Constant 2023 $s)")
)

# ggsave600dpi("..//Output//topline_pricing.png", ToplinePricing, 
#              width=6.5, height= 4, units="in",size=11
#              )


  ggsave600dpi("..//Output//HistoricPricing.png", HistoricPricing,  
               width=12, height= 5.6, units="in",size=18, lineheight=1.2,
               bg="transparent"
               )

write.csv(file="..//Output//HistoricPricing.csv",row.names = FALSE, na = "",
  pivot_wider(HistoricPricing$data %>% 
                        arrange(dFYear) %>% mutate(Fiscal_Year=lubridate::year(dFYear)),
                      id_cols=c(PricingInflation),
                      names_from=Fiscal_Year,values_from=Action_Obligation)%>%
    arrange(PricingInflation))


```




# DLA 
```{r}
summary(platpscintldef$PlatformPortfolio)
(
DLAplatform<-build_plot(
  data=platpscintldef %>% filter(SubCustomer=="DLA"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PlatformPortfolio", #color_var
  facet_var="PlatformPortfolio", #facet_var
  # column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)")
)
  
```
# DTRA

## OTA
```{r DTRAota}
ota_def$SubCustomer.DTRA<-as.character(ota_def$SubCustomer.OTA)
ota_def$SubCustomer.DTRA[ota_def$Contracting_Agency_ID=="9761"]<-"DTRA"

summary(ota_def$Product_or_Service_Code[is.na(ota_def$SimpleArea)])


(
DTRAjustota<-build_plot(
  data=ota_def %>% filter(Fiscal_Year>=2015 & Fiscal_Year<=2022 &(Contracting_Agency_ID=="9761"|Funding_Agency_ID=="9761")),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=intl_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SubCustomer.DTRA", #color_var
  # facet_var="SimpleArea", #facet_var
  column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")+
    scale_x_date(breaks=as.Date(c(paste(seq(2000,2022,5),"-01-01",sep=""))),
                                                   date_labels="'%y")
)


(
DTRAota<-build_plot(
  data=ota_contract %>% filter(Fiscal_Year>=2015 & Contracting_Agency_ID=="9761"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=intl_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="IsOTA", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")+
    scale_x_date(breaks=as.Date(c(paste(seq(2000,2022,5),"-01-01",sep=""))),
                                                   date_labels="'%y")
)

ggsave600dpi("..//Output//Deep_Dives//DTRA//DTRAjustota.png", DTRAjustota, 
             width=6, height= 5.5, units="in",size=12,lineheight = 1.2
             )



write.csv(file="..//Output//..//Output//Deep_Dives//DTRA//DTRAjustota.csv",row.names = FALSE, na = "",
          DTRAjustota$data%>% mutate(Fiscal_Year=lubridate::year(dFYear)) %>% arrange(Fiscal_Year)
            pivot_wider(id_cols=c(SubCustomer.DTRA),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23))



ggsave600dpi("..//Output//Deep_Dives//DTRA//DTRAota.png", DTRAota, 
             width=6, height= 5.5, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi("..//Output//Deep_Dives//DTRA//DTRAota.svg", DTRAota,#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi("..//Output//Deep_Dives//DTRA//DTRAota.emf", DTRAota,#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )



write.csv(file="..//Output//..//Output//Deep_Dives//DTRA//DTRAota.csv",row.names = FALSE, na = "",
          DTRAota$data%>% mutate(Fiscal_Year=lubridate::year(dFYear)) %>% pivot_wider(id_cols=c(SimpleArea,IsOTA),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23))

write.csv(file="..//Output//Deep_Dives//DTRA//DTRAota_current.csv",row.names = FALSE, na = "",
          ota_contract %>% group_by(SimpleArea,IsOTA,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(SimpleArea,IsOTA),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(SimpleArea,IsOTA))


```

## Commercial
```{r DTRAcommercial}
platpscintldef$AnyCommercialText<-factor(platpscintldef$AnyCommercial)
levels(platpscintldef$AnyCommercialText)<-list(
  "Not Classified\nas Commrcial"="N",
  "Non-Development\nor Commercial Similar"= "NonDev",
  "Any Commercial\nClassification"="Y"
)  
platpscintldef$Action_Obligation_OMB25_GDP23
(
DTRAcomm<-build_plot(
  data=platpscintldef %>% filter(Fiscal_Year>=2000 & Contracting_Agency_ID=="9761"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=intl_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="AnyCommercialText", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")+
    scale_x_date(breaks=as.Date(c(paste(seq(2000,2022,5),"-01-01",sep=""))),
                                                   date_labels="'%y")
)
 




ggsave600dpi("..//Output//Deep_Dives//DTRA//DTRAcomm.png", DTRAcomm, 
             width=6, height= 5.5, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi("..//Output//Deep_Dives//DTRA//DTRAcomm.svg", DTRAcomm,#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi("..//Output//Deep_Dives//DTRA//DTRAcomm.emf", DTRAcomm,#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )


write.csv(file="..//Output//..//Output//Deep_Dives//DTRA//DTRAcomm.csv",row.names = FALSE, na = "",
          DTRAcomm$data%>% mutate(Fiscal_Year=lubridate::year(dFYear)) %>% 
            pivot_wider(DTRAcomm$data,id_cols=c(SimpleArea,AnyCommercialText),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23))

write.csv(file="..//Output//Deep_Dives//DTRA//DTRAcomm_current.csv",row.names = FALSE, na = "",
          platpscintldef %>% group_by(SimpleArea,AnyCommercialText,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(SimpleArea,AnyCommercialText),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(SimpleArea,AnyCommercialText))



summary(full_data$ContractingSubCustomer)
```

## HIMARS

```{r}

(
HimarsPSR<-build_plot(
  data=platpscintldef %>% filter(Project.Name=='MLRS'),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=intl_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi("..//Output//Deep_Dives//Himars//Himars_psr.png", HimarsPSR, 
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )

ggsave600dpi("..//Output//Deep_Dives//Himars//Himars_psr.emf", HimarsPSR, 
             width=6.5, height= 3, units="in",size=11, lineheight=1.2
             )

output_TY<-platpscintldef %>% group_by(Shiny.VendorSize,Fiscal_Year,Project.Name)%>% filter(Project.Name=='MLRS') %>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
  arrange(Fiscal_Year) %>%
          pivot_wider(id_cols=c(Project.Name,Shiny.VendorSize),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)
write.csv(file="..//Output//Deep_Dives//Himars//Himars_psr.csv",row.names = FALSE, na = "",
          output_TY)


# wb <- loadWorkbook("..//Output//DoD_Acq_Trends_Contracts.xlsx", create = TRUE)
# addWorksheet(wb, name = "Area")
#  writeData(wb, output_TY, sheet = "Area", startRow = 14, startCol = 14)
# saveWorkbook(wb)


```

