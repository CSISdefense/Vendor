---
title: "Defense Acquisition Trends"
output:
  html_document:
    keep_md: yes
    toc: yes
date: "Wednesday, October 6, 2021"
---

# Setup
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from FPDS.

```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(scales)

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40
if(!exists("full_data"))
  load(file="FPDS_chart_maker//unaggregated_FPDS.Rda")

load(file="../data/semi_clean/platpsc_FPDS.Rda")
load(file="../data/semi_clean/platpscintl_FPDS.Rda")

detail_lc<-prepare_labels_and_colors(platpsc)#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
detail_ck<-get_column_key(platpsc)#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
# column_key<-get_column_key(platpsc,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
# detail_lc<-prepare_labels_and_colors(platpsc,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
# detail_ck<-get_column_key(platpsc,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
```
# Preprocessing 
## Project
```{r PreprocessProject}

summary(factor(platpsc$ProjectPlatform))

topplat<-platpsc %>% group_by (ProjectName,PlatformPortfolio) %>%
  summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
            Action_Obligation_2020=sum(ifelse(fiscal_year==2020,Action_Obligation_OMB20_GDP20,0)))%>%
              group_by (PlatformPortfolio) %>%
    mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
                        rank_2020=rank(desc(Action_Obligation_2020)))
topplat %>% arrange(desc(Action_Obligation_OMB20_GDP20))


topplat$TopProject<-
  ifelse(topplat$rank_2020<=7 | topplat$rank_total<=7,topplat$ProjectName,NA)

platpsc<-left_join(platpsc,topplat %>% select(-Action_Obligation_OMB20_GDP20,Action_Obligation_2020),
          by=c("ProjectName","PlatformPortfolio"))

platpsc$TopProject[is.na(platpsc$TopProject) & !is.na(platpsc$ProjectName)]<-
  "Other Labeled Project"


summary(factor(platpsc$TopProject))


```
## PSC
```{r PreprocessPSC}

summary(factor(platpsc$ProjectPlatform))

topPSC<-platpsc %>% group_by (ProductOrServiceCode,ProductOrServiceCodeText,PlatformPortfolio) %>%
  summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
            Action_Obligation_2020=sum(ifelse(fiscal_year==2020,Action_Obligation_OMB20_GDP20,0)))%>%
              group_by (PlatformPortfolio) %>%
    mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
                        rank_2020=rank(desc(Action_Obligation_2020)))
topPSC %>% arrange(desc(Action_Obligation_OMB20_GDP20))

topPSC$TopPScode<-
  ifelse(topPSC$rank_2020<=7 | topPSC$rank_total<=7,topPSC$ProductOrServiceCode,NA)
topPSC$TopPStext<-
  ifelse(topPSC$rank_2020<=7 | topPSC$rank_total<=7,topPSC$ProductOrServiceCodeText,NA)


platpsc<-left_join(platpsc,topPSC %>% select(-Action_Obligation_OMB20_GDP20,Action_Obligation_2020),
          by=c("ProductOrServiceCode","PlatformPortfolio"))

platpsc$TopPScode[is.na(platpsc$TopPScode) & !is.na(platpsc$ProductOrServiceCode)]<-
  "Other Labeled PSC"
platpsc$TopPStext[is.na(platpsc$TopPStext) & !is.na(platpsc$ProductOrServiceCode)]<-
  "Other Labeled PSC"


summary(factor(platpsc$TopPStext))


```

## Place State
```{r PreprocessState}

# test$pop_isna<-is.na(test$pop_state_code)
# test$sc_isna<-is.na(test$PlaceStateCode)
# test %>% group_by(Fiscal.Year,pop_isna,sc_isna) %>%
#   summarise(n=length(Fiscal.Year))

# summary(factor(test$CrisisProductOrServiceArea))
colnames(test)[colnames(test)=="Fiscal.Year"]<-"fiscal_year"
topState<-test %>% group_by (pop_state_code,CrisisProductOrServiceArea) %>%
  summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
            Action_Obligation_2020=sum(ifelse(fiscal_year==2020,Action_Obligation_OMB20_GDP20,0)))%>%
              group_by (CrisisProductOrServiceArea) %>%
    mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
                        rank_2020=rank(desc(Action_Obligation_2020)))
topState %>% arrange(desc(Action_Obligation_OMB20_GDP20))

topState$TopStateAbbr<-
  ifelse(topState$rank_2020<=25 | topState$rank_total<=25,topState$pop_state_code,NA)
# topState$TopStateName<-
#   ifelse(topState$rank_2020<=7 | topState$rank_total<=7,topState$PlaceStateCodeText,NA)
test<-test[,!colnames(test) %in% c("Action_Obligation_OMB20_GDP20.x","Action_Obligation_OMB20_GDP20.y",
                                   "Action_Obligation_2020.x","Action_Obligation_2020.y",
  "rank_total.y","rank_total.x","rank_2020.y","rank_2020.x","TopStateAbbr.x","TopStateAbbr.y")]

test<-left_join(test,topState %>% select(-Action_Obligation_OMB20_GDP20,Action_Obligation_2020),
          by=c("pop_state_code","CrisisProductOrServiceArea"))

test$TopStateAbbr[is.na(test$TopStateAbbr) & !is.na(test$pop_state_code)]<-
  "Other Labeled State"
# test$TopStateName[is.na(test$TopStateName) & !is.na(test$pop_state_code)]<-
#   "Other Labeled State"


# summary(factor(test$TopStateName))


```

## Place Country
```{r PreprocessCountry}

# summary(factor(test$CrisisProductOrServiceArea))
colnames(test)[colnames(test)=="Fiscal.Year"]<-"fiscal_year"
topCountry<-test %>% group_by (PlaceISOalpha3,CrisisProductOrServiceArea) %>%
  summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
            Action_Obligation_2020=sum(ifelse(fiscal_year==2020,Action_Obligation_OMB20_GDP20,0)))%>%
              group_by (CrisisProductOrServiceArea) %>%
    mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
                        rank_2020=rank(desc(Action_Obligation_2020)))
topCountry %>% arrange(desc(Action_Obligation_OMB20_GDP20))

topCountry$TopCountryISO<-
  ifelse(topCountry$rank_2020<=7 | topCountry$rank_total<=7,topCountry$PlaceISOalpha3,NA)
# topCountry$TopCountryName<-
#   ifelse(topCountry$rank_2020<=7 | topCountry$rank_total<=7,topCountry$PlaceCountryCodeText,NA)


test<-left_join(test,topCountry %>% select(-Action_Obligation_OMB20_GDP20,Action_Obligation_2020),
          by=c("PlaceISOalpha3","CrisisProductOrServiceArea"))

test$TopCountryISO[is.na(test$TopCountryISO) & !is.na(test$PlaceISOalpha3)]<-
  "Other Labeled Country"
# test$TopCountryName[is.na(test$TopCountryName) & !is.na(test$PlaceISOalpha3)]<-
#   "Other Labeled Country"


# summary(factor(test$TopCountryName))


```

# Component Variant
## SubCustomer with JPO
```{r SubCustomer}
levels(platpsc$SubCustomer.JPO)<-list(
  "Army"="Army",
  "F-35 Joint Program Office"="F-35 JPO",
  "Navy"="Navy",
  "Air Force"="Air Force", 
  "Defense Logistics Agency" =c("DLA","Defense Logistics Agency"),
  "Missile Defense Agency"=c("MDA","Missile Defense Agency"),
  "Other DoD"="Other DoD"
)
detail_lc<-prepare_labels_and_colors(platpsc)#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
detail_ck<-get_column_key(platpsc)#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
# platpsc$SubCustomer[platpsc$SubCustomer.JPO=="F-35 Joint Program Office"&SubCustomer.sum!="Navy"]

(
SubCustomer<-build_plot(
  data=platpsc,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=detail_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="SubCustomer.JPO", #color_var
  facet_var="SubCustomer.sum", #facet_var
  column_key=detail_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")+
  facet_wrap(~SubCustomer.sum,nrow=1)+scale_x_date(breaks=
  as.Date(c("2000-1-1","2005-1-1","2010-1-1","2015-1-1","2020-1-1")),date_labels="'%y")
)

ggsave600dpi("..//Output//topline_subcustomer_JPO.png", SubCustomer+labs(caption="Source: FPDS and CSIS analysis."), 
             width=6.5, height= 3.5, units="in",size=11,lineheight = 1
             )

ggsave600dpi("..//Output//topline_subcustomer_JPO.eps", SubCustomer+labs(caption="Source: FPDS and CSIS analysis."), 
             width=6.5, height= 3.5, units="in",size=11,lineheight = 1
             )

ggsave600dpi("..//Output//topline_subcustomer_JPO_wide.png", SubCustomer+labs(caption="Source: FPDS and CSIS analysis."), 
             width=12, height= 6, units="in",size=12,lineheight = 1
             )


write.csv(file="..//Output//topline_subcustomer_JPO.csv",row.names = FALSE,
          SubCustomer$data%>% mutate(fiscal_year=lubridate::year(dFYear))%>%
          pivot_wider(id_cols=c(SubCustomer.sum,SubCustomer.JPO),
                      names_from=fiscal_year,values_from=Action_Obligation_OMB20_GDP20))

write.csv(file="..//Output//topline_subcustomer_JPO_current.csv",row.names = FALSE,
          platpsc %>% group_by(SubCustomer.sum,SubCustomer.JPO,fiscal_year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(SubCustomer.sum,SubCustomer.JPO),
                      names_from=fiscal_year,values_from=Action_Obligation_Then_Year))

summary(full_data$ContractingSubCustomer)
```

# Service variant
## Crisis Services
```{r services}
platpsc$CrisisProductOrServiceArea
(
Services<-build_plot(
  data=platpsc %>% filter(Simple=="Services"&ProductOrServiceCode!="M183"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=detail_lc,
  # NA, #VAR.ncol
  x_var="fiscal_year", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="CrisisProductOrServiceArea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=detail_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//cpsr_Services.png", Services, 
             width=12, height= 6, units="in",size=11, lineheight=1.2
             )
                           

write.csv(file="..//Output//cpsr_Services.csv",row.names = FALSE,
          pivot_wider(Services$data,id_cols=c(CrisisProductOrServiceArea),
                      names_from=fiscal_year,values_from=Action_Obligation_OMB20_GDP20)%>%
            arrange(CrisisProductOrServiceArea))
            

write.csv(file="..//Output//psr_Services_current.csv",row.names = FALSE,
          full_data %>% filter(ProductServiceOrRnDarea.sum=="R&D") %>%
            format_data_for_plot(fy_var="fiscal_year",y_var="Action_Obligation_Then_Year",color_var = "ProductServiceOrRnDarea",
                                 labels_and_colors=labels_and_colors) %>%
          pivot_wider(id_cols=c(ProductServiceOrRnDarea),
                      names_from=fiscal_year,values_from=Action_Obligation_Then_Year)%>%
            arrange(ProductServiceOrRnDarea))

```



# Platforms and Top Projects


## Aircraft System
```{r Aircraft}
# summary(factor(platpsc$ProjectPlatform))
# platpsc$fiscal_year
# 
# topplat<-platpsc %>% filter(PlatformPortfolio=="Aircraft") %>% group_by (ProjectName) %>%
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
#             Action_Obligation_2020=sum(ifelse(fiscal_year==2020,Action_Obligation_OMB20_GDP20,0))
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
#                         rank_2020=rank(desc(Action_Obligation_2020)))
# topplat %>% arrange(desc(Action_Obligation_OMB20_GDP20))
# 
# platpsc$TopAircraftProject<-
#   ifelse(platpsc$ProjectName %in% topplat$ProjectName[topplat$rank_2020<=7 | topplat$rank_total<=7],
#          platpsc$ProjectName,NA)
# platpsc$TopAircraftProject[is.na(platpsc$TopAircraftProject) & !is.na(platpsc$ProjectName)]<-
#   "Other Labeled Project"
# summary(factor(platpsc$TopAircraftProject))


(
Platform<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Aircraft"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)
  
  
  write.csv(file="..//Output//Aircraft_project_cur.csv",row.names = FALSE,
            platpsc %>% filter(PlatformPortfolio=="Aircraft")  %>%
              format_data_for_plot(fy_var="fiscal_year",y_var="Action_Obligation_Then_Year",color_var = "TopProject"#,
                                   # labels_and_colors=labels_and_colors
                                   )%>% arrange(fiscal_year) %>%
            pivot_wider(id_cols=c(TopProject),
                        names_from=fiscal_year,values_from=Action_Obligation_Then_Year)%>%
              arrange(TopProject))
```

## Ships and Submarines
```{r ShipsAndSubs}
# summary(factor(platpsc$ProjectPlatform))
# platpsc$fiscal_year
# 
# topplat<-platpsc %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (ProjectName) %>%
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
#             Action_Obligation_2020=sum(ifelse(fiscal_year==2020,Action_Obligation_OMB20_GDP20,0))
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
#                         rank_2020=rank(desc(Action_Obligation_2020)))
# topplat %>% arrange(desc(Action_Obligation_OMB20_GDP20))
# 
# platpsc$TopShipProject<-
#   ifelse(platpsc$ProjectName %in% topplat$ProjectName[topplat$rank_2020<=7 | topplat$rank_total<=7],
#          platpsc$ProjectName,NA)
# platpsc$TopShipProject[is.na(platpsc$TopShipProject) & !is.na(platpsc$ProjectName)]<-
#   "Other Labeled Project"
# summary(factor(platpsc$TopShipProject))


(
Platform<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Ships & Submarines"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)

 write.csv(file="..//Output//ShipSub_project_current.csv",row.names = FALSE,na="",
            platpsc %>% filter(PlatformPortfolio=="Ships & Submarines")  %>%
              format_data_for_plot(fy_var="fiscal_year",y_var="Action_Obligation_Then_Year",color_var = "TopProject"#,
                                   # labels_and_colors=labels_and_colors
                                   )%>% arrange(fiscal_year) %>%
            pivot_wider(id_cols=c(TopProject),
                        names_from=fiscal_year,values_from=Action_Obligation_Then_Year)%>%
              arrange(TopProject))
```


## Ordnance and Missiles
```{r OrdMissiles}
summary(factor(platpsc$ProjectPlatform))
# platpsc$fiscal_year
# 
# topplat<-platpsc %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (ProjectName) %>%
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
#             Action_Obligation_2020=sum(ifelse(fiscal_year==2020,Action_Obligation_OMB20_GDP20,0))
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
#                         rank_2020=rank(desc(Action_Obligation_2020)))
# topplat %>% arrange(desc(Action_Obligation_OMB20_GDP20))
# 
# platpsc$TopShipProject<-
#   ifelse(platpsc$ProjectName %in% topplat$ProjectName[topplat$rank_2020<=7 | topplat$rank_total<=7],
#          platpsc$ProjectName,NA)
# platpsc$TopShipProject[is.na(platpsc$TopShipProject) & !is.na(platpsc$ProjectName)]<-
#   "Other Labeled Project"
# summary(factor(platpsc$TopShipProject))


(
Platform<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Ordnance and Missiles"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)



(
PSC<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Ordnance and Missiles"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)

write.csv(file="..//Output//OrdMiss_psc_current.csv",row.names = FALSE,na="",
            platpsc %>% filter(PlatformPortfolio=="Ordnance and Missiles")  %>%
              format_data_for_plot(fy_var="fiscal_year",y_var="Action_Obligation_Then_Year",color_var = "TopPStext"#,
                                   # labels_and_colors=labels_and_colors
                                   )%>% arrange(fiscal_year) %>%
            pivot_wider(id_cols=c(TopPStext),
                        names_from=fiscal_year,values_from=Action_Obligation_Then_Year)%>%
              arrange(TopPStext))

```

## Air and Missile Defesnse
```{r Defense}
summary(factor(platpsc$ProjectPlatform))
# platpsc$fiscal_year
# 
# topplat<-platpsc %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (ProjectName) %>%
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
#             Action_Obligation_2020=sum(ifelse(fiscal_year==2020,Action_Obligation_OMB20_GDP20,0))
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
#                         rank_2020=rank(desc(Action_Obligation_2020)))
# topplat %>% arrange(desc(Action_Obligation_OMB20_GDP20))
# 
# platpsc$TopShipProject<-
#   ifelse(platpsc$ProjectName %in% topplat$ProjectName[topplat$rank_2020<=7 | topplat$rank_total<=7],
#          platpsc$ProjectName,NA)
# platpsc$TopShipProject[is.na(platpsc$TopShipProject) & !is.na(platpsc$ProjectName)]<-
#   "Other Labeled Project"
# summary(factor(platpsc$TopShipProject))


(
Platform<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Missile Defense"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)



(
PSC<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Missile Defense"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)


```

## Electronics Comms and Sensors
```{r ElecCommsSensors}
summary(factor(platpsc$ProjectPlatform))
# platpsc$fiscal_year
# 
# topplat<-platpsc %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (ProjectName) %>%
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
#             Action_Obligation_2020=sum(ifelse(fiscal_year==2020,Action_Obligation_OMB20_GDP20,0))
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
#                         rank_2020=rank(desc(Action_Obligation_2020)))
# topplat %>% arrange(desc(Action_Obligation_OMB20_GDP20))
# 
# platpsc$TopShipProject<-
#   ifelse(platpsc$ProjectName %in% topplat$ProjectName[topplat$rank_2020<=7 | topplat$rank_total<=7],
#          platpsc$ProjectName,NA)
# platpsc$TopShipProject[is.na(platpsc$TopShipProject) & !is.na(platpsc$ProjectName)]<-
#   "Other Labeled Project"
# summary(factor(platpsc$TopShipProject))


(
Platform<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Electronics, Comms, & Sensors"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)



(
PSC<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Electronics, Comms, & Sensors"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)

```


## Space Systems
```{r Space}
summary(factor(platpsc$ProjectPlatform))
# platpsc$fiscal_year
# 
# topplat<-platpsc %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (ProjectName) %>%
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
#             Action_Obligation_2020=sum(ifelse(fiscal_year==2020,Action_Obligation_OMB20_GDP20,0))
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
#                         rank_2020=rank(desc(Action_Obligation_2020)))
# topplat %>% arrange(desc(Action_Obligation_OMB20_GDP20))
# 
# platpsc$TopShipProject<-
#   ifelse(platpsc$ProjectName %in% topplat$ProjectName[topplat$rank_2020<=7 | topplat$rank_total<=7],
#          platpsc$ProjectName,NA)
# platpsc$TopShipProject[is.na(platpsc$TopShipProject) & !is.na(platpsc$ProjectName)]<-
#   "Other Labeled Project"
# summary(factor(platpsc$TopShipProject))


(
Platform<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Space Systems"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)


(
PSC<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Space Systems"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)

```

## Land Vehicles
```{r Land}
summary(factor(platpsc$ProjectPlatform))
# platpsc$fiscal_year
# 
# topplat<-platpsc %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (ProjectName) %>%
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
#             Action_Obligation_2020=sum(ifelse(fiscal_year==2020,Action_Obligation_OMB20_GDP20,0))
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
#                         rank_2020=rank(desc(Action_Obligation_2020)))
# topplat %>% arrange(desc(Action_Obligation_OMB20_GDP20))
# 
# platpsc$TopShipProject<-
#   ifelse(platpsc$ProjectName %in% topplat$ProjectName[topplat$rank_2020<=7 | topplat$rank_total<=7],
#          platpsc$ProjectName,NA)
# platpsc$TopShipProject[is.na(platpsc$TopShipProject) & !is.na(platpsc$ProjectName)]<-
#   "Other Labeled Project"
# summary(factor(platpsc$TopShipProject))


(
Platform<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Land Vehicles"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)


(
PSC<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Land Vehicles"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)

```

## Facility Related And Construction
```{r FRSnC}
summary(factor(platpsc$ProjectPlatform))
# platpsc$fiscal_year
# 
# topplat<-platpsc %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (ProjectName) %>%
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
#             Action_Obligation_2020=sum(ifelse(fiscal_year==2020,Action_Obligation_OMB20_GDP20,0))
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
#                         rank_2020=rank(desc(Action_Obligation_2020)))
# topplat %>% arrange(desc(Action_Obligation_OMB20_GDP20))
# 
# platpsc$TopShipProject<-
#   ifelse(platpsc$ProjectName %in% topplat$ProjectName[topplat$rank_2020<=7 | topplat$rank_total<=7],
#          platpsc$ProjectName,NA)
# platpsc$TopShipProject[is.na(platpsc$TopShipProject) & !is.na(platpsc$ProjectName)]<-
#   "Other Labeled Project"
# summary(factor(platpsc$TopShipProject))


(
Platform<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Facilities and Construction"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)


(
PSC<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Facilities and Construction"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)

```

## Construction
```{r FRSnC}
summary(factor(test$CrisisProductOrServiceArea))
# test$fiscal_year
# 
# topplat<-test %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (ProjectName) %>%
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
#             Action_Obligation_2020=sum(ifelse(fiscal_year==2020,Action_Obligation_OMB20_GDP20,0))
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
#                         rank_2020=rank(desc(Action_Obligation_2020)))
# topplat %>% arrange(desc(Action_Obligation_OMB20_GDP20))
# 
# test$TopShipProject<-
#   ifelse(test$ProjectName %in% topplat$ProjectName[topplat$rank_2020<=7 | topplat$rank_total<=7],
#          test$ProjectName,NA)
# test$TopShipProject[is.na(test$TopShipProject) & !is.na(test$ProjectName)]<-
#   "Other Labeled Project"
# summary(factor(test$TopShipProject))

(
State<-build_plot(
  data=test %>% filter(CrisisProductOrServiceArea=="Construction"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="fiscal_year", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopStateAbbr", #color_var
  facet_var="TopStateAbbr", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)
ggsave(State,file="construction_state.png")
(
State<-build_plot(
  data=test %>% filter(CrisisProductOrServiceArea=="Construction"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="fiscal_year", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopStateAbbr", #color_var
  facet_var="TopStateAbbr", #facet_var
  second_var="SubCustomer",
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)


(
Country<-build_plot(
  data=test %>% filter(CrisisProductOrServiceArea=="Construction"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="fiscal_year", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopCountryISO", #color_var
  facet_var="TopCountryISO", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)


(
PSC<-build_plot(
  data=test %>% filter(PlatformPortfolio=="Construction"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)

```

# International
##FMS 


###FMS identification
```{r contract_identification}

summary(fpds_data$foreign_funding_description)

# undebug(build_plot)

(contract_identification <-  build_plot(data=platpscintldef %>% filter(ContractingCustomer=="Defense"),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal.Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="foreign_funding_description",
                            facet_var="IsFMS",
                            # second_var="StateRegion",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Constant 2020 $ Obligated",
       caption="Source: FPDS; CSIS analysis.")+
    guides(fill=guide_legend(ncol=3)))

ggsave600dpi(contract_identification,file="../output/figure_03_contract_identification.png",size=12,lineheight=1, height =5, width=9)


```

### JSF International
```{r FPDS_JSF}

summary(factor(platpscintldef$Shiny.VendorSize[platpscintldef$VendorIsForeign==1]))
summary(platpscintldef$VendorSize_Intl)

# undebug(format_data_for_plot)
(fpds_vendor_intl_place <-  build_plot(data=platpscintldef %>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign)&
                                                                      !is.na(IsFMS)& Fiscal.Year>2011),
                                       #IsFMS==TRUE 
                                       chart_geom="Bar Chart",
                            x_var="Fiscal.Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="VendorSize_Intl",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )#, scales="free_y"
  )


write.csv(file="..//Output//FMS_vendorplaceintl.csv",row.names = FALSE,
          fpds_vendor_intl_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(VendorSize_Intl,IsFMS, PlaceIsForeign),
                        names_from=Fiscal.Year,values_from=Action_Obligation_OMB20_GDP20)%>% arrange(PlaceIsForeign,IsFMS,VendorSize_Intl))

ggsave600dpi(fpds_vendor_intl_place,file="../output/FMS_vendorplaceintl.png",
             size = 12, lineheight=1, height =4.5, width=9)


# platpscintldef$Shiny.VendorSize
(fpds_vendor_place <-  build_plot(data=platpscintldef %>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign)&
                                                                      !is.na(IsFMS)&Fiscal.Year>2011 ),#IsFMS==TRUE  
                            chart_geom="Bar Chart",
                            x_var="Fiscal.Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="Shiny.VendorSize",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )#, scales="free_y"
  )

ggsave600dpi(fpds_vendor_place,file="../output/FMS_vendorplace.png",
             size = 12, lineheight=1, height =4.5, width=9)


write.csv(file="..//Output//FMS_vendorplace.csv",row.names = FALSE,
          fpds_vendor_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(Shiny.VendorSize,PlaceIsForeign,IsFMS),
                        names_from=Fiscal.Year,values_from=Action_Obligation_OMB20_GDP20)%>% arrange(PlaceIsForeign,Shiny.VendorSize,IsFMS))


```


### FMS Vendor Size/Intl and Place
```{r FPDS_vendor_Intl}

summary(factor(platpscintldef$Shiny.VendorSize[platpscintldef$VendorIsForeign==1]))
summary(platpscintldef$VendorSize_Intl)

# undebug(format_data_for_plot)
(fpds_vendor_intl_place <-  build_plot(data=platpscintldef %>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign)&
                                                                      !is.na(IsFMS)& Fiscal.Year>2011),
                                       #IsFMS==TRUE 
                                       chart_geom="Bar Chart",
                            x_var="Fiscal.Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="VendorSize_Intl",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )#, scales="free_y"
  )


write.csv(file="..//Output//FMS_vendorplaceintl.csv",row.names = FALSE,
          fpds_vendor_intl_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(VendorSize_Intl,IsFMS, PlaceIsForeign),
                        names_from=Fiscal.Year,values_from=Action_Obligation_OMB20_GDP20)%>% arrange(PlaceIsForeign,IsFMS,VendorSize_Intl))

ggsave600dpi(fpds_vendor_intl_place,file="../output/FMS_vendorplaceintl.png",
             size = 12, lineheight=1, height =4.5, width=9)


# platpscintldef$Shiny.VendorSize
(fpds_vendor_place <-  build_plot(data=platpscintldef %>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign)&
                                                                      !is.na(IsFMS)&Fiscal.Year>2011 ),#IsFMS==TRUE  
                            chart_geom="Bar Chart",
                            x_var="Fiscal.Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="Shiny.VendorSize",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )#, scales="free_y"
  )

ggsave600dpi(fpds_vendor_place,file="../output/FMS_vendorplace.png",
             size = 12, lineheight=1, height =4.5, width=9)


write.csv(file="..//Output//FMS_vendorplace.csv",row.names = FALSE,
          fpds_vendor_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(Shiny.VendorSize,PlaceIsForeign,IsFMS),
                        names_from=Fiscal.Year,values_from=Action_Obligation_OMB20_GDP20)%>% arrange(PlaceIsForeign,Shiny.VendorSize,IsFMS))


```

### JSF FMS Vendor Size/Intl and Place
```{r FPDS_vendor_Intl}

summary(factor(platpscintldef$Shiny.VendorSize[platpscintldef$VendorIsForeign==1]))
summary(platpscintldef$VendorSize_Intl)

# undebug(format_data_for_plot)
(fpds_vendor_intl_place <-  build_plot(data=platpscintldef %>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign)&
                                                                      !is.na(IsFMS)& Fiscal.Year>2011),
                                       #IsFMS==TRUE 
                                       chart_geom="Bar Chart",
                            x_var="Fiscal.Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="VendorSize_Intl",
                            facet_var="IsJSF",
                            second_var="IsFMSplaceIntl",
                            # labels_and_colors=intl_lc,
                            # column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid(IsFMSplaceIntl~IsJSF, scales="free_y", space="free_y")
  )


write.csv(file="..//Output//FMS_vendorplaceintl.csv",row.names = FALSE,
          fpds_vendor_intl_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(VendorSize_Intl,IsFMS, PlaceIsForeign),
                        names_from=Fiscal.Year,values_from=Action_Obligation_OMB20_GDP20)%>% arrange(PlaceIsForeign,IsFMS,VendorSize_Intl))

ggsave600dpi(fpds_vendor_intl_place,file="../output/FMS_vendorplaceintl.png",
             size = 12, lineheight=1, height =4.5, width=9)


# platpscintldef$Shiny.VendorSize
(fpds_vendor_place <-  build_plot(data=platpscintldef %>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign)&
                                                                      !is.na(IsFMS)&Fiscal.Year>2011 ),#IsFMS==TRUE  
                            chart_geom="Bar Chart",
                            x_var="Fiscal.Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="Shiny.VendorSize",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )#, scales="free_y"
  )

ggsave600dpi(fpds_vendor_place,file="../output/FMS_vendorplace.png",
             size = 12, lineheight=1, height =4.5, width=9)


write.csv(file="..//Output//FMS_vendorplace.csv",row.names = FALSE,
          fpds_vendor_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(Shiny.VendorSize,PlaceIsForeign,IsFMS),
                        names_from=Fiscal.Year,values_from=Action_Obligation_OMB20_GDP20)%>% arrange(PlaceIsForeign,Shiny.VendorSize,IsFMS))


```



#### Place
```{r FPDS_vendor_Intl}


# undebug(format_data_for_plot)
(fpds_manufacture_intl_place <-  build_plot(data=platpscintldef%>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign) &
                                                                            Fiscal.Year>2011 & !is.na(IsFMS)),#IsFMS==TRUE                             
                                            chart_geom="Bar Chart",
                            x_var="Fiscal.Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )#, scales="free_y"
  )


write.csv(file="..//Output//FMS_BAAplaceintl.csv",row.names = FALSE,
          fpds_manufacture_intl_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlaceIsForeign,IsFMS, PlaceOfManufacture_Sum),
                        names_from=Fiscal.Year,values_from=Action_Obligation_OMB20_GDP20)%>% arrange(PlaceIsForeign,IsFMS,PlaceOfManufacture_Sum))
```

#### JSF Place
```{r FPDS_vendor_Intl}


# undebug(format_data_for_plot)
(fpds_manufacture_intl_place <-  build_plot(data=platpscintldef%>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign) &
                                                                            Fiscal.Year>2011 & !is.na(IsFMS)),#IsFMS==TRUE                             
                                            chart_geom="Bar Chart",
                            x_var="Fiscal.Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="IsFMSplaceIntl",
                            second_var="IsJSF",
                            # labels_and_colors=intl_lc,
                            # column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")#+
    # facet_grid( IsJSF+PlaceIsForeign )#, scales="free_y"
  )


write.csv(file="..//Output//FMS_BAAplaceintl.csv",row.names = FALSE,
          fpds_manufacture_intl_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlaceIsForeign,IsFMS, PlaceOfManufacture_Sum),
                        names_from=Fiscal.Year,values_from=Action_Obligation_OMB20_GDP20)%>% arrange(PlaceIsForeign,IsFMS,PlaceOfManufacture_Sum))
```



