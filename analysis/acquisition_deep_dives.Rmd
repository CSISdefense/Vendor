---
title: "Defense Acquisition Trends"
output:
  html_document:
    keep_md: yes
    toc: yes
date: "Wednesday, October 6, 2021"
---

# Setup
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from FPDS.

```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(scales)

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40
if(!exists("full_data"))
  load(file="FPDS_chart_maker//unaggregated_FPDS.Rda")

load(file="../data/semi_clean/platpsc_FPDS.Rda")
load(file="../data/semi_clean/platpscintl_FPDS.Rda")
load(file="data/semi_clean/sw_FPDS.Rda")
# detail_lc<-prepare_labels_and_colors(platpsc)#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
# detail_ck<-get_column_key(platpsc)#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
# column_key<-get_column_key(platpsc,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
# detail_lc<-prepare_labels_and_colors(platpsc,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
# detail_ck<-get_column_key(platpsc,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
```
# Preprocessing 
## Project
```{r PreprocessProject}

summary(factor(platpsc$ProjectPlatform))

topplat<-platpsc %>% group_by (ProjectName,PlatformPortfolio) %>%
  summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
            Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB20_GDP20,0)))%>%
              group_by (PlatformPortfolio) %>%
    mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
                        rank_2020=rank(desc(Action_Obligation_2020)))
topplat %>% arrange(desc(Action_Obligation_OMB20_GDP20))


topplat$TopProject<-
  ifelse(topplat$rank_2020<=7 | topplat$rank_total<=7,topplat$ProjectName,NA)

platpsc<-left_join(platpsc,topplat %>% select(-Action_Obligation_OMB20_GDP20,Action_Obligation_2020),
          by=c("ProjectName","PlatformPortfolio"))

platpsc$TopProject[is.na(platpsc$TopProject) & !is.na(platpsc$ProjectName)]<-
  "Other Labeled Project"


summary(factor(platpsc$TopProject))


```
## PSC
```{r PreprocessPSC}

summary(factor(platpsc$ProjectPlatform))

topPSC<-platpsc %>% group_by (ProductOrServiceCode,ProductOrServiceCodeText,PlatformPortfolio) %>%
  summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
            Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB20_GDP20,0)))%>%
              group_by (PlatformPortfolio) %>%
    mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
                        rank_2020=rank(desc(Action_Obligation_2020)))
topPSC %>% arrange(desc(Action_Obligation_OMB20_GDP20))

topPSC$TopPScode<-
  ifelse(topPSC$rank_2020<=7 | topPSC$rank_total<=7,topPSC$ProductOrServiceCode,NA)
topPSC$TopPStext<-
  ifelse(topPSC$rank_2020<=7 | topPSC$rank_total<=7,topPSC$ProductOrServiceCodeText,NA)


platpsc<-left_join(platpsc,topPSC %>% select(-Action_Obligation_OMB20_GDP20,Action_Obligation_2020),
          by=c("ProductOrServiceCode","PlatformPortfolio"))

platpsc$TopPScode[is.na(platpsc$TopPScode) & !is.na(platpsc$ProductOrServiceCode)]<-
  "Other Labeled PSC"
platpsc$TopPStext[is.na(platpsc$TopPStext) & !is.na(platpsc$ProductOrServiceCode)]<-
  "Other Labeled PSC"

platpsc$TopPStext<-factor_wrap(platpsc$TopPStext)

summary(factor(platpsc$TopPStext))


```

## Place State
```{r PreprocessState}

# platpscintldef$pop_isna<-is.na(platpscintldef$pop_state_code)
# platpscintldef$sc_isna<-is.na(platpscintldef$PlaceStateCode)
# platpscintldef %>% group_by(Fiscal_Year,pop_isna,sc_isna) %>%
#   summarise(n=length(Fiscal_Year))

# summary(factor(platpscintldef$CrisisProductOrServiceArea))

topState<-platpscintldef %>% group_by (pop_state_code,CrisisProductOrServiceArea) %>%
  summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
            Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB20_GDP20,0)))%>%
              group_by (CrisisProductOrServiceArea) %>%
    mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
                        rank_2020=rank(desc(Action_Obligation_2020)))
topState %>% arrange(desc(Action_Obligation_OMB20_GDP20))

topState$TopStateAbbr<-
  ifelse(topState$rank_2020<=25 | topState$rank_total<=25,topState$pop_state_code,NA)
# topState$TopStateName<-
#   ifelse(topState$rank_2020<=7 | topState$rank_total<=7,topState$PlaceStateCodeText,NA)
platpscintldef<-platpscintldef[,!colnames(platpscintldef) %in% c("Action_Obligation_OMB20_GDP20.x","Action_Obligation_OMB20_GDP20.y",
                                   "Action_Obligation_2020.x","Action_Obligation_2020.y",
  "rank_total.y","rank_total.x","rank_2020.y","rank_2020.x","TopStateAbbr.x","TopStateAbbr.y")]

platpscintldef<-left_join(platpscintldef,topState %>% select(-Action_Obligation_OMB20_GDP20,Action_Obligation_2020),
          by=c("pop_state_code","CrisisProductOrServiceArea"))

platpscintldef$TopStateAbbr[is.na(platpscintldef$TopStateAbbr) & !is.na(platpscintldef$pop_state_code)]<-
  "Other Labeled State"
# platpscintldef$TopStateName[is.na(platpscintldef$TopStateName) & !is.na(platpscintldef$pop_state_code)]<-
#   "Other Labeled State"


# summary(factor(platpscintldef$TopStateName))


```

## Place Country
```{r PreprocessCountry}

# summary(factor(platpscintldef$CrisisProductOrServiceArea))
colnames(platpscintldef)[colnames(platpscintldef)=="Fiscal_Year"]<-"Fiscal_Year"
topCountry<-platpscintldef %>% group_by (PlaceISOalpha3,CrisisProductOrServiceArea) %>%
  summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
            Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB20_GDP20,0)))%>%
              group_by (CrisisProductOrServiceArea) %>%
    mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
                        rank_2020=rank(desc(Action_Obligation_2020)))
topCountry %>% arrange(desc(Action_Obligation_OMB20_GDP20))

topCountry$TopCountryISO<-
  ifelse(topCountry$rank_2020<=7 | topCountry$rank_total<=7,topCountry$PlaceISOalpha3,NA)
# topCountry$TopCountryName<-
#   ifelse(topCountry$rank_2020<=7 | topCountry$rank_total<=7,topCountry$PlaceCountryCodeText,NA)


platpscintldef<-left_join(platpscintldef,topCountry %>% select(-Action_Obligation_OMB20_GDP20,Action_Obligation_2020),
          by=c("PlaceISOalpha3","CrisisProductOrServiceArea"))

platpscintldef$TopCountryISO[is.na(platpscintldef$TopCountryISO) & !is.na(platpscintldef$PlaceISOalpha3)]<-
  "Other Labeled Country"
# platpscintldef$TopCountryName[is.na(platpscintldef$TopCountryName) & !is.na(platpscintldef$PlaceISOalpha3)]<-
#   "Other Labeled Country"


# summary(factor(platpscintldef$TopCountryName))


```


## SW agency
```{r PreprocessPSC}


topAgency<-sw %>% group_by (Contracting_Agency_ID,ContractingAgencyName,Customer) %>% #,PlatformPortfolio
  summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
            Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB20_GDP20,0)))%>%
              group_by (Customer) %>%
    mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
                        rank_2020=rank(desc(Action_Obligation_2020)))
topAgency %>% arrange(desc(Action_Obligation_OMB20_GDP20))

topAgency$TopAgencyID<-
  ifelse(topAgency$rank_2020<=7 | topAgency$rank_total<=7,topAgency$Contracting_Agency_ID,NA)
topAgency$TopAgencyText<-
  ifelse(topAgency$rank_2020<=7 | topAgency$rank_total<=7,topAgency$ContractingAgencyName,NA)


sw<-left_join(sw,topAgency %>% select(-Action_Obligation_OMB20_GDP20,Action_Obligation_2020),
          by=c("Contracting_Agency_ID","Customer"))

sw$TopAgencyID[is.na(sw$TopAgencyID) & !is.na(sw$Contracting_Agency_ID)]<-
  "Other Labeled Agency"
sw$TopAgencyText[is.na(sw$TopAgencyText) & !is.na(sw$Contracting_Agency_ID)]<-
  "Other Labeled Agency"

sw$TopAgencyText<-factor_wrap(factor(sw$TopAgencyText))

summary(sw$TopAgencyText)


```

# Component Variant
## SubCustomer with JPO
```{r SubCustomer}

levels(platpsc$SubCustomer.JPO)<-list(
  "Army"="Army",
  "F-35 Joint Program Office"="F-35 JPO",
  "Navy"="Navy",
  "Air Force"="Air Force", 
  "Defense Logistics Agency" =c("DLA","Defense Logistics Agency"),
  "Missile Defense Agency"=c("MDA","Missile Defense Agency"),
  "Other DoD"="Other DoD"
)
detail_lc<-prepare_labels_and_colors(platpsc)#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
detail_ck<-get_column_key(platpsc)#,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
# platpsc$SubCustomer[platpsc$SubCustomer.JPO=="F-35 Joint Program Office"&SubCustomer.sum!="Navy"]

(
SubCustomer<-build_plot(
  data=platpsc,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=detail_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="SubCustomer.JPO", #color_var
  facet_var="SubCustomer.sum", #facet_var
  column_key=detail_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")+
  facet_wrap(~SubCustomer.sum,nrow=1)+scale_x_date(breaks=
  as.Date(c("2000-1-1","2005-1-1","2010-1-1","2015-1-1","2020-1-1")),date_labels="'%y")
)

ggsave600dpi("..//Output//topline_subcustomer_JPO.png", SubCustomer+labs(caption="Source: FPDS and CSIS analysis."), 
             width=6.5, height= 3.5, units="in",size=11,lineheight = 1
             )

ggsave600dpi("..//Output//topline_subcustomer_JPO.eps", SubCustomer+labs(caption="Source: FPDS and CSIS analysis."), 
             width=6.5, height= 3.5, units="in",size=11,lineheight = 1
             )

ggsave600dpi("..//Output//topline_subcustomer_JPO_wide.png", SubCustomer+labs(caption="Source: FPDS and CSIS analysis."), 
             width=12, height= 6, units="in",size=12,lineheight = 1
             )


write.csv(file="..//Output//topline_subcustomer_JPO.csv",row.names = FALSE,
          SubCustomer$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
          pivot_wider(id_cols=c(SubCustomer.sum,SubCustomer.JPO),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20))

write.csv(file="..//Output//topline_subcustomer_JPO_current.csv",row.names = FALSE,
          platpsc %>% group_by(SubCustomer.sum,SubCustomer.JPO,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(SubCustomer.sum,SubCustomer.JPO),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))


```

# Service variant
## Crisis Services
```{r services}
platpsc$CrisisProductOrServiceArea
(
Services<-build_plot(
  data=platpsc %>% filter(SimpleArea=="Services"&ProductOrServiceCode!="M183"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=detail_lc,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="CrisisProductOrServiceArea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=detail_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//Archives//2020_Trends//cpsr_Services.png", Services, 
             width=12, height= 6, units="in",size=11, lineheight=1.2
             )
                           

ggsave600dpi("..//Output//Archives//2020_Trends//cpsr_Services.svg", Services, 
             width=6.5, height= 3.25, units="in",size=11, lineheight=1.2
             )

write.csv(file="..//Output//cpsr_Services.csv",row.names = FALSE,
          pivot_wider(Services$data,id_cols=c(CrisisProductOrServiceArea),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20)%>%
            arrange(CrisisProductOrServiceArea))
            

write.csv(file="..//Output//psr_Services_current.csv",row.names = FALSE,
          full_data %>% filter(ProductServiceOrRnDarea.sum=="R&D") %>%
            format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "ProductServiceOrRnDarea",
                                 labels_and_colors=labels_and_colors) %>%
          pivot_wider(id_cols=c(ProductServiceOrRnDarea),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
            arrange(ProductServiceOrRnDarea))

```



# Platforms and Top Projects


## Aircraft System
```{r Aircraft}
# summary(factor(platpsc$ProjectPlatform))
# platpsc$Fiscal_Year
# 
# topplat<-platpsc %>% filter(PlatformPortfolio=="Aircraft") %>% group_by (ProjectName) %>%
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
#             Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB20_GDP20,0))
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
#                         rank_2020=rank(desc(Action_Obligation_2020)))
# topplat %>% arrange(desc(Action_Obligation_OMB20_GDP20))
# 
# platpsc$TopAircraftProject<-
#   ifelse(platpsc$ProjectName %in% topplat$ProjectName[topplat$rank_2020<=7 | topplat$rank_total<=7],
#          platpsc$ProjectName,NA)
# platpsc$TopAircraftProject[is.na(platpsc$TopAircraftProject) & !is.na(platpsc$ProjectName)]<-
#   "Other Labeled Project"
# summary(factor(platpsc$TopAircraftProject))


(
Platform<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Aircraft"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)
  
  
  write.csv(file="..//Output//Aircraft_project_cur.csv",row.names = FALSE,
            platpsc %>% filter(PlatformPortfolio=="Aircraft")  %>%
              format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "TopProject"#,
                                   # labels_and_colors=labels_and_colors
                                   )%>% arrange(Fiscal_Year) %>%
            pivot_wider(id_cols=c(TopProject),
                        names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
              arrange(TopProject))
```

## Ships and Submarines
```{r ShipsAndSubs}
# summary(factor(platpsc$ProjectPlatform))
# platpsc$Fiscal_Year
# 
# topplat<-platpsc %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (ProjectName) %>%
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
#             Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB20_GDP20,0))
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
#                         rank_2020=rank(desc(Action_Obligation_2020)))
# topplat %>% arrange(desc(Action_Obligation_OMB20_GDP20))
# 
# platpsc$TopShipProject<-
#   ifelse(platpsc$ProjectName %in% topplat$ProjectName[topplat$rank_2020<=7 | topplat$rank_total<=7],
#          platpsc$ProjectName,NA)
# platpsc$TopShipProject[is.na(platpsc$TopShipProject) & !is.na(platpsc$ProjectName)]<-
#   "Other Labeled Project"
# summary(factor(platpsc$TopShipProject))


(
Platform<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Ships & Submarines"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)

 write.csv(file="..//Output//ShipSub_project_current.csv",row.names = FALSE,na="",
            platpsc %>% filter(PlatformPortfolio=="Ships & Submarines")  %>%
              format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "TopProject"#,
                                   # labels_and_colors=labels_and_colors
                                   )%>% arrange(Fiscal_Year) %>%
            pivot_wider(id_cols=c(TopProject),
                        names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
              arrange(TopProject))
```


## Ordnance and Missiles
```{r OrdMissiles}
summary(factor(platpsc$ProjectPlatform))
# platpsc$Fiscal_Year
# 
# topplat<-platpsc %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (ProjectName) %>%
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
#             Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB20_GDP20,0))
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
#                         rank_2020=rank(desc(Action_Obligation_2020)))
# topplat %>% arrange(desc(Action_Obligation_OMB20_GDP20))
# 
# platpsc$TopShipProject<-
#   ifelse(platpsc$ProjectName %in% topplat$ProjectName[topplat$rank_2020<=7 | topplat$rank_total<=7],
#          platpsc$ProjectName,NA)
# platpsc$TopShipProject[is.na(platpsc$TopShipProject) & !is.na(platpsc$ProjectName)]<-
#   "Other Labeled Project"
# summary(factor(platpsc$TopShipProject))


(
Platform<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Ordnance and Missiles"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)



(
PSC<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Ordnance and Missiles"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopAgencyText", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)

write.csv(file="..//Output//OrdMiss_psc_current.csv",row.names = FALSE,na="",
            platpsc %>% filter(PlatformPortfolio=="Ordnance and Missiles")  %>%
              format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "TopPStext"#,
                                   # labels_and_colors=labels_and_colors
                                   )%>% arrange(Fiscal_Year) %>%
            pivot_wider(id_cols=c(TopPStext),
                        names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
              arrange(TopPStext))

```

## Air and Missile Defesnse
```{r Defense}
summary(factor(platpsc$ProjectPlatform))
# platpsc$Fiscal_Year
# 
# topplat<-platpsc %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (ProjectName) %>%
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
#             Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB20_GDP20,0))
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
#                         rank_2020=rank(desc(Action_Obligation_2020)))
# topplat %>% arrange(desc(Action_Obligation_OMB20_GDP20))
# 
# platpsc$TopShipProject<-
#   ifelse(platpsc$ProjectName %in% topplat$ProjectName[topplat$rank_2020<=7 | topplat$rank_total<=7],
#          platpsc$ProjectName,NA)
# platpsc$TopShipProject[is.na(platpsc$TopShipProject) & !is.na(platpsc$ProjectName)]<-
#   "Other Labeled Project"
# summary(factor(platpsc$TopShipProject))


(
Platform<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Missile Defense"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)



(
PSC<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Missile Defense"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)


```

## Electronics Comms and Sensors
```{r ElecCommsSensors}
summary(factor(platpsc$ProjectPlatform))
# platpsc$Fiscal_Year
# 
# topplat<-platpsc %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (ProjectName) %>%
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
#             Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB20_GDP20,0))
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
#                         rank_2020=rank(desc(Action_Obligation_2020)))
# topplat %>% arrange(desc(Action_Obligation_OMB20_GDP20))
# 
# platpsc$TopShipProject<-
#   ifelse(platpsc$ProjectName %in% topplat$ProjectName[topplat$rank_2020<=7 | topplat$rank_total<=7],
#          platpsc$ProjectName,NA)
# platpsc$TopShipProject[is.na(platpsc$TopShipProject) & !is.na(platpsc$ProjectName)]<-
#   "Other Labeled Project"
# summary(factor(platpsc$TopShipProject))


(
Platform<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Electronics, Comms, & Sensors"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)



(
PSC<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Electronics, Comms, & Sensors"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)

```


## Space Systems
```{r Space}
summary(factor(platpsc$ProjectPlatform))
# platpsc$Fiscal_Year
# 
# topplat<-platpsc %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (ProjectName) %>%
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
#             Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB20_GDP20,0))
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
#                         rank_2020=rank(desc(Action_Obligation_2020)))
# topplat %>% arrange(desc(Action_Obligation_OMB20_GDP20))
# 
# platpsc$TopShipProject<-
#   ifelse(platpsc$ProjectName %in% topplat$ProjectName[topplat$rank_2020<=7 | topplat$rank_total<=7],
#          platpsc$ProjectName,NA)
# platpsc$TopShipProject[is.na(platpsc$TopShipProject) & !is.na(platpsc$ProjectName)]<-
#   "Other Labeled Project"
# summary(factor(platpsc$TopShipProject))


(
Platform<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Space Systems"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)


(
PSC<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Space Systems"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)

```

## Land Vehicles
```{r Land}
summary(factor(platpsc$ProjectPlatform))
# platpsc$Fiscal_Year
# 
# topplat<-platpsc %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (ProjectName) %>%
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
#             Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB20_GDP20,0))
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
#                         rank_2020=rank(desc(Action_Obligation_2020)))
# topplat %>% arrange(desc(Action_Obligation_OMB20_GDP20))
# 
# platpsc$TopShipProject<-
#   ifelse(platpsc$ProjectName %in% topplat$ProjectName[topplat$rank_2020<=7 | topplat$rank_total<=7],
#          platpsc$ProjectName,NA)
# platpsc$TopShipProject[is.na(platpsc$TopShipProject) & !is.na(platpsc$ProjectName)]<-
#   "Other Labeled Project"
# summary(factor(platpsc$TopShipProject))


(
Platform<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Land Vehicles"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)


(
PSC<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Land Vehicles"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)

```

## Facility Related And Construction
```{r FRSnC}
summary(factor(platpsc$ProjectPlatform))
# platpsc$Fiscal_Year
# 
# topplat<-platpsc %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (ProjectName) %>%
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
#             Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB20_GDP20,0))
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
#                         rank_2020=rank(desc(Action_Obligation_2020)))
# topplat %>% arrange(desc(Action_Obligation_OMB20_GDP20))
# 
# platpsc$TopShipProject<-
#   ifelse(platpsc$ProjectName %in% topplat$ProjectName[topplat$rank_2020<=7 | topplat$rank_total<=7],
#          platpsc$ProjectName,NA)
# platpsc$TopShipProject[is.na(platpsc$TopShipProject) & !is.na(platpsc$ProjectName)]<-
#   "Other Labeled Project"
# summary(factor(platpsc$TopShipProject))


(
Platform<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Facilities and Construction"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)


(
PSC<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Facilities and Construction"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)

```

## Construction
```{r FRSnC}
summary(factor(platpscintldef$CrisisProductOrServiceArea))
# platpscintldef$Fiscal_Year
# 
# topplat<-platpscintldef %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (ProjectName) %>%
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
#             Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB20_GDP20,0))
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
#                         rank_2020=rank(desc(Action_Obligation_2020)))
# topplat %>% arrange(desc(Action_Obligation_OMB20_GDP20))
# 
# platpscintldef$TopShipProject<-
#   ifelse(platpscintldef$ProjectName %in% topplat$ProjectName[topplat$rank_2020<=7 | topplat$rank_total<=7],
#          platpscintldef$ProjectName,NA)
# platpscintldef$TopShipProject[is.na(platpscintldef$TopShipProject) & !is.na(platpscintldef$ProjectName)]<-
#   "Other Labeled Project"
# summary(factor(platpscintldef$TopShipProject))

(
State<-build_plot(
  data=platpscintldef %>% filter(CrisisProductOrServiceArea=="Construction"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopStateAbbr", #color_var
  facet_var="TopStateAbbr", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)
ggsave(State,file="construction_state.png")
(
State<-build_plot(
  data=platpscintldef %>% filter(CrisisProductOrServiceArea=="Construction"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopStateAbbr", #color_var
  facet_var="TopStateAbbr", #facet_var
  second_var="SubCustomer",
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)


(
Country<-build_plot(
  data=platpscintldef %>% filter(CrisisProductOrServiceArea=="Construction"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopCountryISO", #color_var
  facet_var="TopCountryISO", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)


(
PSC<-build_plot(
  data=platpscintldef %>% filter(PlatformPortfolio=="Construction"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)

```


## Other Products
```{r OtherProducts}
summary(factor(platpsc$PlatformPortfolio))
# platpsc$Fiscal_Year
# 
# topplat<-platpsc %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (ProjectName) %>%
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
#             Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB20_GDP20,0))
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
#                         rank_2020=rank(desc(Action_Obligation_2020)))
# topplat %>% arrange(desc(Action_Obligation_OMB20_GDP20))
# 
# platpsc$TopShipProject<-
#   ifelse(platpsc$ProjectName %in% topplat$ProjectName[topplat$rank_2020<=7 | topplat$rank_total<=7],
#          platpsc$ProjectName,NA)
# platpsc$TopShipProject[is.na(platpsc$TopShipProject) & !is.na(platpsc$ProjectName)]<-
#   "Other Labeled Project"
# summary(factor(platpsc$TopShipProject))


(
Platform<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Other Products"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)


(
PSC<-build_plot(
  data=platpsc %>% filter(PlatformPortfolio=="Other Products"),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)

```


# International
##FMS 


###FMS identification
```{r contract_identification}



# undebug(build_plot)

(contract_identification <-  build_plot(data=platpscintldef %>% filter(ContractingCustomer=="Defense"),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="foreign_funding_description",
                            facet_var="IsFMS",
                            # second_var="StateRegion",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Constant 2020 $ Obligated",
       caption="Source: FPDS; CSIS analysis.")+
    guides(fill=guide_legend(ncol=3)))

ggsave600dpi(contract_identification,file="../output/figure_03_contract_identification.png",size=12,lineheight=1, height =5, width=9)



```

### JSF International
```{r FPDS_JSF}

summary(factor(platpscintldef$Shiny.VendorSize[platpscintldef$VendorIsForeign==1]))
summary(platpscintldef$VendorSize_Intl)

# undebug(format_data_for_plot)
(jsf_vendor_intl_place <-  build_plot(data=platpscintldef %>% filter(IsJSF=="JSF (F-35)"& Fiscal_Year>2011),
                                       #IsFMS==TRUE 
                                       chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="VendorSize_Intl",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )#, scales="free_y"
  )


write.csv(file="..//Output//jsf_vendor_intl_place.csv",row.names = FALSE,
          jsf_vendor_intl_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(VendorSize_Intl,IsFMS, PlaceIsForeign),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20)%>% arrange(PlaceIsForeign,IsFMS,VendorSize_Intl))

ggsave600dpi(jsf_vendor_intl_place,file="../output/jsf_vendor_intl_place.png",
             size = 12, lineheight=1, height =4.5, width=9)


# platpscintldef$Shiny.VendorSize
# undebug(format_data_for_plot)
(jsf_manufacture_intl_place <-  build_plot(data=platpscintldef%>% filter(IsJSF=="JSF (F-35)"& Fiscal_Year>2011),              
                                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )#, scales="free_y"
  )


write.csv(file="..//Output//jsf_manufacture_intl_place.csv",row.names = FALSE,
          jsf_manufacture_intl_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlaceIsForeign,IsFMS, PlaceOfManufacture_Sum),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20)%>% arrange(PlaceIsForeign,IsFMS,PlaceOfManufacture_Sum))

ggsave600dpi(jsf_manufacture_intl_place,file="../output/jsf_manufacture_intl_place.png",
             size = 12, lineheight=1, height =4.5, width=9)

platpscintldef$OriginISOalpha3
(jsf_manufacture_intl_place <-  build_plot(data=platpscintldef%>% filter(IsJSF=="JSF (F-35)"& Fiscal_Year>2011),              
                                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="OriginISOalpha3",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            # labels_and_colors=intl_lc,
                            # column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )#, scales="free_y"
  )



```


  ### FMS Vendor Size/Intl and Place
```{r FPDS_vendor_Intl}

summary(factor(platpscintldef$Shiny.VendorSize[platpscintldef$VendorIsForeign==1]))
summary(platpscintldef$VendorSize_Intl)

# undebug(format_data_for_plot)
(fpds_vendor_intl_place <-  build_plot(data=platpscintldef %>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign)&
                                                                      !is.na(IsFMS)& Fiscal_Year>2011),
                                       #IsFMS==TRUE 
                                       chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="VendorSize_Intl",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )+labs(title="FMS or Performed Internationally, Including JSF")#, scales="free_y"
  )


write.csv(file="..//Output//FMS_vendorplaceintl_all.csv",row.names = FALSE,
          fpds_vendor_intl_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(VendorSize_Intl,IsFMS, PlaceIsForeign),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20)%>% arrange(PlaceIsForeign,IsFMS,VendorSize_Intl))

ggsave600dpi(fpds_vendor_intl_place,file="../output/FMS_vendorplaceintl_all.png",
             size = 12, lineheight=1, height =4.5, width=9)


# platpscintldef$Shiny.VendorSize
(fpds_vendor_place <-  build_plot(data=platpscintldef %>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign)&
                                                                      !is.na(IsFMS)&Fiscal_Year>2011 ),#IsFMS==TRUE  
                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="Shiny.VendorSize",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )+labs(title="FMS or Performed Internationally, Including JSF")#, scales="free_y"#, scales="free_y"
  )

ggsave600dpi(fpds_vendor_place,file="../output/FMS_vendorplace_all.png",
             size = 12, lineheight=1, height =4.5, width=9)


write.csv(file="..//Output//FMS_vendorplace_all.csv",row.names = FALSE,
          fpds_vendor_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(Shiny.VendorSize,PlaceIsForeign,IsFMS),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20)%>% arrange(PlaceIsForeign,Shiny.VendorSize,IsFMS))


```

### FMS Vendor Size/Intl and Place No JSF
```{r FPDS_vendor_Intl}

summary(factor(platpscintldef$Shiny.VendorSize[platpscintldef$VendorIsForeign==1]))
summary(platpscintldef$VendorSize_Intl)

# undebug(format_data_for_plot)
(fpds_vendor_intl_place_noJSF <-  build_plot(data=platpscintldef %>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign)&
                                                                      !is.na(IsFMS)& Fiscal_Year>2011&
                                                                            IsJSF %in% c("Other Project","Unknown Project")),
                                       #IsFMS==TRUE 
                                       chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="VendorSize_Intl",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )+labs(title="FMS or Performed Internationally, No JSF")#, scales="free_y"
  )


write.csv(file="..//Output//FMS_vendorplaceintl_noJSF.csv",row.names = FALSE,
          fpds_vendor_intl_place_noJSF$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(VendorSize_Intl,IsFMS, PlaceIsForeign),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20)%>% arrange(PlaceIsForeign,IsFMS,VendorSize_Intl))

ggsave600dpi(fpds_vendor_intl_place_noJSF,file="../output/FMS_vendorplaceintl_noJSF.png",
             size = 12, lineheight=1, height =4.5, width=9)


# platpscintldef$Shiny.VendorSize
(fpds_vendor_place_noJSF <-  build_plot(data=platpscintldef %>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign)&
                                                                      !is.na(IsFMS)&Fiscal_Year>2011&
                                                                            IsJSF %in% c("Other Project","Unknown Project") ),#IsFMS==TRUE  
                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="Shiny.VendorSize",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )+labs(title="FMS or Performed Internationally, No JSF")#, scales="free_y"#, scales="free_y"
  )

ggsave600dpi(fpds_vendor_place_noJSF,file="../output/FMS_vendorplace_noJSF.png",
             size = 12, lineheight=1, height =4.5, width=9)


write.csv(file="..//Output//FMS_vendorplace_noJSF.csv",row.names = FALSE,
          fpds_vendor_place_noJSF$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(Shiny.VendorSize,PlaceIsForeign,IsFMS),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20)%>% arrange(PlaceIsForeign,Shiny.VendorSize,IsFMS))


```

### JSF FMS Vendor Size/Intl and Place
```{r FPDS_vendor_Intl}

summary(factor(platpscintldef$Shiny.VendorSize[platpscintldef$VendorIsForeign==1]))
summary(platpscintldef$VendorSize_Intl)

# undebug(format_data_for_plot)
(fpds_vendor_intl_place <-  build_plot(data=platpscintldef %>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign)&
                                                                      !is.na(IsFMS)& Fiscal_Year>2011),
                                       #IsFMS==TRUE 
                                       chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="VendorSize_Intl",
                            facet_var="IsJSF",
                            second_var="IsFMSplaceIntl",
                            # labels_and_colors=intl_lc,
                            # column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid(IsFMSplaceIntl~IsJSF, scales="free_y", space="free_y")
  )


write.csv(file="..//Output//FMS_vendorplaceintl.csv",row.names = FALSE,
          fpds_vendor_intl_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(VendorSize_Intl,IsFMS, PlaceIsForeign),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20)%>% arrange(PlaceIsForeign,IsFMS,VendorSize_Intl))

ggsave600dpi(fpds_vendor_intl_place,file="../output/FMS_vendorplaceintl.png",
             size = 12, lineheight=1, height =4.5, width=9)


# platpscintldef$Shiny.VendorSize
(fpds_vendor_place <-  build_plot(data=platpscintldef %>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign)&
                                                                      !is.na(IsFMS)&Fiscal_Year>2011 ),#IsFMS==TRUE  
                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="Shiny.VendorSize",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )#, scales="free_y"
  )

ggsave600dpi(fpds_vendor_place,file="../output/FMS_vendorplace.png",
             size = 12, lineheight=1, height =4.5, width=9)


write.csv(file="..//Output//FMS_vendorplace.csv",row.names = FALSE,
          fpds_vendor_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(Shiny.VendorSize,PlaceIsForeign,IsFMS),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20)%>% arrange(PlaceIsForeign,Shiny.VendorSize,IsFMS))


```



#### Place
```{r FPDS_vendor_Intl}


# undebug(format_data_for_plot)
(fpds_manufacture_intl_place <-  build_plot(data=platpscintldef%>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign) &
                                                                            Fiscal_Year>2011 & !is.na(IsFMS)),#IsFMS==TRUE                             
                                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )+labs(title="FMS or Performed Internationally, Including JSF")#, scales="free_y"#, scales="free_y"
  )


write.csv(file="..//Output//FMS_BAAplaceintl_all.csv",row.names = FALSE,
          fpds_manufacture_intl_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlaceIsForeign,IsFMS, PlaceOfManufacture_Sum),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20)%>% arrange(PlaceIsForeign,IsFMS,PlaceOfManufacture_Sum))

ggsave600dpi(fpds_manufacture_intl_place,file="../output/FMS_BAAplaceintl_all.png",
             size = 12, lineheight=1, height =4.5, width=9)

```

#### Place No JSF
```{r FPDS_vendor_Intl}

summary(factor(platpscintldef$IsJSF))
# undebug(format_data_for_plot)
(fpds_manufacture_intl_place_noJSF <-  build_plot(data=platpscintldef%>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign) &
                                                                            Fiscal_Year>2011 & !is.na(IsFMS)&
                                                                            IsJSF %in% c("Other Project","Unknown Project")),#IsFMS==TRUE                             
                                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )+labs(title="FMS or Performed Internationally, No JSF")#, scales="free_y"#, scales="free_y"
  )


write.csv(file="..//Output//FMS_BAAplaceintl_noJSF.csv",row.names = FALSE,
          fpds_manufacture_intl_place_noJSF$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlaceIsForeign,IsFMS, PlaceOfManufacture_Sum),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20)%>% arrange(PlaceIsForeign,IsFMS,PlaceOfManufacture_Sum))

ggsave600dpi(fpds_manufacture_intl_place_noJSF,file="../output/FMS_BAAplaceintl_noJSF.png",
             size = 12, lineheight=1, height =4.5, width=9)

```

#### JSF Place
```{r FPDS_vendor_Intl}


# undebug(format_data_for_plot)
(fpds_manufacture_intl_place <-  build_plot(data=platpscintldef%>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign) &
                                                                            Fiscal_Year>2011 & !is.na(IsFMS)),#IsFMS==TRUE                             
                                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="PlaceOfManufacture_Sum",
                            facet_var="IsFMSplaceIntl",
                            second_var="IsJSF",
                            # labels_and_colors=intl_lc,
                            # column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")#+
    # facet_grid( IsJSF+PlaceIsForeign )#, scales="free_y"
  )


write.csv(file="..//Output//FMS_BAAplaceintl.csv",row.names = FALSE,
          fpds_manufacture_intl_place$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlaceIsForeign,IsFMS, PlaceOfManufacture_Sum),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20)%>% arrange(PlaceIsForeign,IsFMS,PlaceOfManufacture_Sum))
```




#### Service Category
```{r FPDS_vendor_Intl}

summary(factor(platpscintldef$SimpleArea))
# undebug(format_data_for_plot)
(fmsintl_service <-  build_plot(data=platpscintldef%>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign) &
                                                                            Fiscal_Year>2011 & !is.na(IsFMS)&
                                                                  SimpleArea=="Services"),#IsFMS==TRUE                             
                                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="CrisisProductOrServiceArea",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )+labs(title="Services FMS or Performed Internationally")#, scales="free_y"#, scales="free_y"
  )
summary(platpscintldef$dFYear)

write.csv(file="..//Output//fmsintl_service.csv",row.names = FALSE,
          fmsintl_service$data%>%# mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlaceIsForeign,IsFMS,CrisisProductOrServiceArea),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20)%>% arrange(PlaceIsForeign,IsFMS,CrisisProductOrServiceArea))

ggsave600dpi(fmsintl_service,file="../output/fmsintl_service.png",
             size = 12, lineheight=1, height =6, width=9)


(fmsintl_service_vendor <-  build_plot(data=platpscintldef%>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign) &
                                                                            Fiscal_Year>2011 & !is.na(IsFMS)&
                                                                  SimpleArea=="Services"),#IsFMS==TRUE                             
                                            chart_geom="Bar Chart",
                            x_var="dFYear",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="CrisisProductOrServiceArea",
                            facet_var="IsFMSplaceIntl",
                            second_var="VendorSize_Intl",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( IsFMSplaceIntl~VendorSize_Intl , scales="free_y", space="free_y")+labs(title="Services FMS or Performed Internationally")+
    theme(  strip.text.y=element_text(angle=0))
  )


write.csv(file="..//Output//fmsintl_service_vendor.csv",row.names = FALSE,
          fmsintl_service_vendor$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(IsFMSplaceIntl,VendorSize_Intl,CrisisProductOrServiceArea),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20)%>% arrange(IsFMSplaceIntl,VendorSize_Intl,CrisisProductOrServiceArea))

ggsave600dpi(fmsintl_service_vendor,file="../output/fmsintl_service_vendor.png",
             size = 12, lineheight=1, height =6, width=9)

```

#Software

## Product vs. Service
```{r ProdServ}


sw$SWpsc<-as.character(sw$SimpleArea)
sw$SWpsc[sw$ProductOrServiceCode =="D319" ]<-"Annual Software Maint."
# sw$SWpsc[sw$ProductOrServiceCode =="D317" ]<-"Annual Software Maint."
sw$SWpsc[sw$ProductOrServiceCode =="7030" ]<-"Software as a product"
sw$SWpsc[sw$ProductOrServiceCode =="D305" ]<-"Teleprocessing / Cloud Computing"
sw$SWpsc[sw$ProductOrServiceCode %in% c("D302","D307","D308","D313","D317","D318","D399","H170","H970","J070","R413")]<-"Software Development Related"
sw$SWpsc[sw$SWpsc =="Services" ]<-"Other ADP Services"
sw$SWpsc<-factor(sw$SWpsc)
#D317
#D399, R413

sw %>% 
  group_by(SWpsc,ProductOrServiceCode,ProductOrServiceCodeText)%>% summarise(o=sum(Action_Obligation_OMB20_GDP20))

write.csv(sw %>% filter(Fiscal_Year>=2000) %>%
  group_by(SWpsc,ProductOrServiceCode,ProductOrServiceCodeText,Fiscal_Year)%>% summarise(o=sum(Action_Obligation_OMB20_GDP20))%>%#/1000000000
    arrange(Fiscal_Year)%>%pivot_wider(id_cols=c(SWpsc,ProductOrServiceCode,ProductOrServiceCodeText),
                names_from=Fiscal_Year,values_from=o)%>%arrange(SWpsc,ProductOrServiceCode,ProductOrServiceCodeText)
  ,file="..\\output\\Software_Prodserv.csv",row.names = FALSE)


sw %>% filter (ProductOrServiceCode %in% c("D317","D319")) %>%  #D317 not included
  group_by(SWpsc,ProductOrServiceCode,ProductOrServiceCodeText)%>% summarise(o=sum(Action_Obligation_OMB20_GDP20))


sw %>% filter (ProductOrServiceCode %in% c("7030","D302","D307","D308","D313","D317","D318","D319","H170","J070","R413")) %>% 
  group_by(SWpsc,ProductOrServiceCode,ProductOrServiceCodeText)%>% summarise(o=sum(Action_Obligation_OMB20_GDP20))

sw<-sw %>% filter(ProductOrServiceCode %in% c("D305", "D317","D319", "7030","D302","D307","D308","D313","D317","D318","D319","D399","H170","H970","J070","R413"))

# platpsc$SimpleArea
# platpsc$SWpsc<-as.character(platpsc$SimpleArea)
# platpsc$SWpsc[substr(platpsc$ProductOrServiceCode,1,1)=="D" ]<-"Other IT and Telecomm"
# platpsc$SWpsc[substr(platpsc$ProductOrServiceCode,1,2)=="70" ]<-"Other ADP EQPT/SOFTWARE/SUPPLIES AND EQPT"
# # platpsc$SWpsc[platpsc$ProductOrServiceCode =="D304" ]<-"Telecomm & Transmission"
# # platpsc$SWpsc[platpsc$ProductOrServiceCode =="D316" ]<-"Telecomm Network Mgmt."
# platpsc$SWpsc[platpsc$ProductOrServiceCode =="D319" ]<-"Annual Software Maint."
# platpsc$SWpsc[platpsc$ProductOrServiceCode =="D305" ]<-"Teleprocessing, Timeshare, Cloud Computing, and High Performance Computing"
# platpsc$SWpsc[platpsc$ProductOrServiceCode =="7030" ]<-"Software as a product"
# platpsc$SWpsc[platpsc$SWpsc =="Products" ]<-"Other Products"
# platpsc$SWpsc[platpsc$SWpsc =="Services" ]<-"Other Services"
# 
# platpsc %>%group_by(SWpsc)%>%
#   dplyr::summarise(o=sum(Action_Obligation_OMB20_GDP20))
# levels(factor(platpsc$SWpsc))
# any(platpsc$ProductOrServiceCode=="D305")
# 
# levels(factor(platpsc$SWpsc))
# platpsc$SWpsc<-factor(platpsc$SWpsc,
#                               levels=c("Annual Software Maint.",
#                                        "Teleprocessing, Timeshare, Cloud Computing, and High Performance Computing",
#                                        "Other IT and Telecomm"  ,
#                                        "Other Services" ,
#                                        "Software as a product" ,
#                                        "Other ADP EQPT/SOFTWARE/SUPPLIES AND EQPT",
#                                        "Other Products"  ,
#                                        "R&D"))
#                              

summary(platpsc$ProductServiceOrRnDarea)
(
SWpscdetail<-build_plot(
  data=sw %>% filter(Fiscal_Year>=2002 & ProductServiceOrRnDarea!="Unlabeled" &
                            !SWpsc %in% c("Other Services" ,"Other Products","R&D" ))  ,
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=sw_lc,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="ProductOrServiceCode", #color_var
  facet_var="SWpsc", #facet_var
  # column_key=sw_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)",caption="Note: Unlabeled not shown. Source: FPDS; CSIS analysis.")
)

# platpsc$ContractingAgencyText
# platpsc$ContractingAgencyTextSwr<-factor_wrap(platpsc$ContractingAgencyText)



# write.csv(file="..//Output//Software_prodserv_comm.csv",row.names = FALSE,
#           arrange(pivot_wider(SWpscdetail$data %>% 
#                         arrange(dFYear) %>% mutate(Fiscal_Year=lubridate::year(dFYear)),
#                       id_cols=c(SWpsc,Commercial),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20),SWpsc,Commercial))

ggsave600dpi(SWpscdetail,file="..//output//Software_prodserv.png",  
             width=13, height= 6, units="in",size=16, lineheight=1.2
             )
# ggsave600dpi(SWpscdetail,file="..//output//Software_prodserv.eps",  
#              width=13, height= 6, units="in",size=16, lineheight=1.2
#              )
```



## Customer 
```{r DoDsoftware}
summary(factor(sw$Customer))

sw %>% filter(Customer=="Other Agencies") %>% group_by(ProductOrServiceCodeText,TopAgencyText) %>% 
  summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20))

(
SWpscdetail<-build_plot(
  data=sw %>% filter(Fiscal_Year>=2000 )  ,
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=sw_lc,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="SWpsc", #color_var
  facet_var="Customer", #facet_var
  # column_key=sw_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)",caption="Note: Unlabeled not shown. Source: FPDS; CSIS analysis.")#+
    # facet_wrap(~ContractingAgencyTextSwr,ncol=4)
)

ggsave600dpi(SWpscdetail,file="..//output//Software_Customer.png",  
             width=13, height= 6, units="in",size=8, lineheight=1.2
             )
ggsave600dpi(SWpscdetail,file="..//output//Software_Customer_Agency.eps",  
             width=13, height= 6, units="in",size=16, lineheight=1.2
             )

write.csv(file="..//Output//Software_Customer.csv",row.names = FALSE,
          SWpscdetail$data %>% mutate(#Fiscal_Year=lubridate::year(dFYear),
                                bAction_Obligation_OMB20_GDP20=Action_Obligation_OMB20_GDP20/1000000000)%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(Customer,SWpsc),
                      names_from=Fiscal_Year,values_from=bAction_Obligation_OMB20_GDP20)%>%
            arrange(Customer,SWpsc),na="")

```
## DoD Component 
```{r DoDsoftware}


(
SWpscDoDcomp<-build_plot(
  data=sw %>% filter(Fiscal_Year>=2000 & Customer=="Defense")  ,
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=sw_lc,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="SWpsc", #color_var
  facet_var="TopAgencyText", #facet_var
  # column_key=sw_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)",caption="Note: Unlabeled not shown. Source: FPDS; CSIS analysis.")#+
    # facet_wrap(~ContractingAgencyTextSwr,ncol=4)
)

ggsave600dpi(SWpscDoDcomp,file="..//output//Software_Defense_Agency.png",  
             width=13, height= 6, units="in",size=8, lineheight=1.2
             )
ggsave600dpi(SWpscDoDcomp,file="..//output//Software_Defense_Agency.eps",  
             width=13, height= 6, units="in",size=16, lineheight=1.2
             )

write.csv(file="..//Output//SWpscDoDcomp.csv",row.names = FALSE,
          SWpscDoDcomp$data %>% mutate(#Fiscal_Year=lubridate::year(dFYear),
                                bAction_Obligation_OMB20_GDP20=Action_Obligation_OMB20_GDP20/1000000000)%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(TopAgencyText,SWpsc),
                      names_from=Fiscal_Year,values_from=bAction_Obligation_OMB20_GDP20)%>%
            arrange(TopAgencyText,SWpsc),na="")

```


##  Competition
```{r SoftwareComp}

(
SoftwareComp<-build_plot(
  data=sw %>% filter(Fiscal_Year>=2000),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=sw_lc,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Competition.sum", #color_var
  facet_var="SWpsc", #facet_var
  column_key=sw_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//Software_comp.png", SoftwareComp,  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )



write.csv(file="..//Output//Software_competition.csv",row.names = FALSE,
          SoftwareComp$data %>% mutate(#Fiscal_Year=lubridate::year(dFYear),
                                bAction_Obligation_OMB20_GDP20=Action_Obligation_OMB20_GDP20/1000000000)%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(SWpsc,Competition.sum),
                      names_from=Fiscal_Year,values_from=bAction_Obligation_OMB20_GDP20)%>%
            arrange(SWpsc,Competition.sum),na="")

```


##  Vendor Size
```{r SoftwareVendor}
library(scales)
(
SoftwareVendor<-build_plot(
  data=sw %>% filter(Fiscal_Year>=2000),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=sw_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  facet_var="SWpsc", #facet_var
  column_key=sw_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)",
       caption="Source: FPDS; CSIS Analysis.\nNote: The Merger of Raytheon and United Technologies took place in April of 2020 and thus did not make the cutofff for inclusion in FY2020.")
)

(
SoftwareVendor_line<-build_plot(
  data=sw,
  chart_geom = "Line Chart",
  labels_and_colors=sw_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  facet_var="SWpsc", #facet_var
  column_key=sw_ck,
  format=TRUE,
  ytextposition=FALSE,
  share=TRUE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)",caption="Source: FPDS; CSIS Analysis.\nNote: The Merger of Raytheon and United Technologies took place in April of 2020\n and thus did not make the cutofff for inclusion in FY2020.")
)

ggsave600dpi("..//Output//Software_vendor_wide.png", SoftwareVendor+
  labs(y="Obligations (Constant 2020 $s)",caption="Source: FPDS; CSIS Analysis.\nNote: The Merger of Raytheon and United Technologies took place in April of 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=12, height= 6, units="in",size=12,lineheight=1
             )


ggsave600dpi("..//Output//Software_vendor_cq.png", SoftwareVendor+
  labs(y="Obligations (Constant 2020 $s)",caption="Source: FPDS; CSIS Analysis.\nNote: The Merger of Raytheon and United Technologies took place in April\nof 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

ggsave600dpi("..//Output//Software_vendor_cq.eps", SoftwareVendor+
  labs(y="Obligations (Constant 2020 $s)",caption="Source: FPDS; CSIS Analysis.\nNote: The Merger of Raytheon and United Technologies took place in April\nof 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

ggsave600dpi("..//Output//Software_vendor.png", SoftwareVendor, 
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

ggsave600dpi("..//Output//Software_vendor.eps", SoftwareVendor+
  labs(y="Obligations (Constant 2020 $s)",caption="Source: FPDS; CSIS Analysis.\nNote: The Merger of Raytheon and United Technologies took place in April\nof 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=6.5, height= 4, units="in",size=11,lineheight=1
             )

# 
# write.csv(file="..//Output//Software_vendor_cur.csv",row.names = FALSE,
#           sw %>% group_by(Shiny.VendorSize,Fiscal_Year)%>%
#             dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE)/1000000000)%>%
#           pivot_wider(id_cols=c(Shiny.VendorSize),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>% arrange(Shiny.VendorSize))
# 



write.csv(file="..//Output//Software_vendor.csv",row.names = FALSE,
          SoftwareVendor$data %>% mutate(Fiscal_Year=lubridate::year(dFYear),
                                bAction_Obligation_OMB20_GDP20=Action_Obligation_OMB20_GDP20/1000000000)%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(SWpsc,Shiny.VendorSize),
                      names_from=Fiscal_Year,values_from=bAction_Obligation_OMB20_GDP20)%>%
            arrange(SWpsc,Shiny.VendorSize),na="")


```
##  Vehicle
```{r SoftwareVehicle}


(
SoftwareVehicle<-build_plot(
  data=sw %>% filter(!is.na(Vehicle.AwardTask)),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=sw_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Vehicle.sum", #color_var
  second_var="Vehicle.AwardTask", #facet_var
  facet_var="SWpsc",
  column_key=sw_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)",
       caption="Note: Unlabeled not shown. Source: FPDS; CSIS Analysis.")
)

summary(sw$Vehicle)

ggsave600dpi("..//Output//Software_vehicle.png", SoftwareVehicle, 
             width=13, height= 4.5, units="in",size=11
             )

write.csv(file="..//Output//Software_vehicle.csv",row.names = FALSE,
          SoftwareVehicle$data%>% mutate(Fiscal_Year=lubridate::year(dFYear),
                                       bAction_Obligation_OMB20_GDP20=Action_Obligation_OMB20_GDP20/1000000000)%>%
            pivot_wider(id_cols=c(SWpsc,Vehicle.sum,Vehicle.AwardTask),
                        names_from=Fiscal_Year,values_from=bAction_Obligation_OMB20_GDP20)%>%arrange(SWpsc,Vehicle.sum,Vehicle.AwardTask))

```


##  Pricing
```{r SoftwarePricing}

sw$PricingUCA.sumlong<-sw$PricingUCA.sum
levels(sw$PricingUCA.sumlong)<-list("Firm-Fixed-Price"="FFP",
                                           "Less Common"="Less Common",
                                           "Incentive"="Incentive",
                                           "Other Cost-Based"="Other CB",
                                           "Undefinitized\nContract Award"="UCA",
                                           "Unclear"="Unclear"   )
  (
SoftwarePricing<-build_plot(
  data=sw %>% filter(Fiscal_Year>=2000),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=sw_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="PricingUCA", #color_var
  # second_var="PricingUCA.sumlong", #facet_var
  facet_var="SWpsc",
  column_key=sw_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

# ggsave600dpi("..//Output//Software_pricing.png", SoftwarePricing, 
#              width=6.5, height= 4, units="in",size=11
#              )


ggsave600dpi("..//Output//Software_pricing.png", SoftwarePricing,  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )


write.csv(file="..//Output//Software_pricing.csv",row.names = FALSE,
          SoftwarePricing$data %>% mutate(Fiscal_Year=lubridate::year(dFYear),
                                bAction_Obligation_OMB20_GDP20=Action_Obligation_OMB20_GDP20/1000000000)%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(SWpsc,PricingUCA),
                      names_from=Fiscal_Year,values_from=bAction_Obligation_OMB20_GDP20)%>%
            arrange(SWpsc,PricingUCA),na="")
```


## Info Tech Commercial
```{r Softwarecomm}

(
SoftwareComm<-build_plot(
  data=sw %>% filter(Fiscal_Year>=2002 & Customer %in% c("Defense","GSA")),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=sw_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Commercial", #color_var
  facet_var="SWpsc", #facet_var
  column_key=sw_ck,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Defense & GSA Obligations (Constant 2020 $s)")
)


(
SoftwareCommLine<-build_plot(
  data=sw %>% filter(Fiscal_Year>=2002 & Customer %in% c("Defense","GSA")),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=sw_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Commercial", #color_var
  facet_var="SWpsc", #facet_var
  column_key=sw_ck,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Defense & GSA Obligations (Constant 2020 $s)")
)


(
SoftwareCommDetail<-build_plot(
  data=sw %>% filter(Fiscal_Year>=2002 & Customer %in% c("Defense","GSA")),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="informationtechnologycommercialitemcategoryText", #color_var
  facet_var="Commercial", #facet_var
  column_key=sw_ck,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Defense & GSA Obligations (Constant 2020 $s)")
)

(
SoftwareCommIT<-build_plot(
  data=sw %>% filter(Fiscal_Year>=2002  & Customer %in% c("Defense","GSA")),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="informationtechnologycommercialitemcategoryText", #color_var
  facet_var="ITcategory", #facet_var
  second_var = "SWpsc",
  column_key=sw_ck,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)


(
SoftwarecommPSCdetail<-build_plot(
  data=sw %>% filter(Fiscal_Year>=2002  & Customer %in% c("Defense","GSA")),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="informationtechnologycommercialitemcategoryText", #color_var
  second_var="SWpsc", #facet_var
  facet_var="Commercial",
  column_key=sw_ck,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Defense & GSA Obligations (Constant 2020 $s)")
)


# ggsave600dpi("..//Output//Software_pricing.png", SoftwareComm, 
#              width=6.5, height= 4, units="in",size=11
#              )


ggsave600dpi("..//Output//Software_comm.png", SoftwareComm,  
             width=13, height= 6, units="in",size=16, lineheight=1.2
             )


write.csv(file="..//Output//Software_comm.csv",row.names = FALSE,
          SoftwareComm$data %>% mutate(Fiscal_Year=lubridate::year(dFYear),
                                bAction_Obligation_OMB20_GDP20=Action_Obligation_OMB20_GDP20/1000000000)%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(SWpsc,Commercial),
                      names_from=Fiscal_Year,values_from=bAction_Obligation_OMB20_GDP20)%>%
            arrange(SWpsc,Commercial),na="")

ggsave600dpi("..//Output//Software_comm_paper.png", SoftwareComm,  
             width=13, height= 3.75, units="in",size=16, lineheight=1.2
             )
# ggsave600dpi("..//Output//Software_comm_paper.eps", SoftwareComm,  
#              width=13, height= 3.75, units="in",size=16, lineheight=1.2
#              )


ggsave600dpi("..//Output//Software_DefenseGSA_comm.png", SoftwareComm,  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )


write.csv(file="..//Output//Software_DefenseGSA_comm.csv",row.names = FALSE,
          SoftwareComm$data%>% mutate(Fiscal_Year=lubridate::year(dFYear),
                                bAction_Obligation_OMB20_GDP20=Action_Obligation_OMB20_GDP20/1000000000)%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(Commercial,SWpsc),
                      names_from=Fiscal_Year,values_from=bAction_Obligation_OMB20_GDP20)%>%
            arrange(Commercial,SWpsc),na="")

```

#### Commercial Component
```{r Softwarecomm}

(
SoftwareCommAgency<-build_plot(
  data=sw %>% filter(Fiscal_Year>=2002 & Customer %in% c("Defense")),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=sw_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Commercial", #color_var
  second_var="SWpsc", #facet_var
  facet_var="TopAgencyText",
  column_key=sw_ck,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Defense Obligations (Constant 2020 $s)")+
   theme(strip.text.y = element_text(angle=0))
)


(
SoftwareCommAgencyLine<-build_plot(
  data=sw %>% filter(Fiscal_Year>=2002 & Customer %in% c("Defense")),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=sw_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Commercial", #color_var
  second_var="SWpsc", #facet_var
  facet_var="TopAgencyText",
  column_key=sw_ck,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Defense Obligations (Constant 2020 $s)")+
     theme(strip.text.y = element_text(angle=0))
)

         

# 
ggsave600dpi("..//Output//SoftwareCommDefAgency.png", SoftwareCommAgency,
             width=13, height= 6, units="in",size=12, lineheight=1.2
             )

write.csv(file="..//Output//SoftwareCommDefAgency.csv",row.names = FALSE,
          SoftwareCommAgency$data%>% mutate(Fiscal_Year=lubridate::year(dFYear),
                                bAction_Obligation_OMB20_GDP20=Action_Obligation_OMB20_GDP20/1000000000)%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(TopAgencyText,SWpsc,Commercial),
                      names_from=Fiscal_Year,values_from=bAction_Obligation_OMB20_GDP20)%>%
            arrange(TopAgencyText,SWpsc,Commercial),na="")

```

#Drones
## Preprocess
```{r PreprocessProjectDrone}

platpscintldef<-csis360::read_and_join_experiment(platpscintldef,
                                             "ProjectID.txt",
                                             by=c("ProjectID"),
                                             add_var="IsRemotelyOperated",
                                             path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                                             dir="project/",
                                             skip_check_var = "IsRemotelyOperated"
)

drone<-platpscintldef %>% filter(ProductOrServiceCode==1550 | IsRemotelyOperated==1)


summary(factor(drone$ProjectName))

droneplat<-drone %>% group_by (ProjectName) %>%
  summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
            Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB20_GDP20,0)))%>%
              group_by () %>%#PlatformPortfolio
    mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
                        rank_2020=rank(desc(Action_Obligation_2020)))
droneplat %>% arrange(desc(Action_Obligation_OMB20_GDP20))


droneplat$TopProject<-
  ifelse(droneplat$rank_2020<=6 | droneplat$rank_total<=6,droneplat$ProjectName,NA)

drone<-left_join(drone,droneplat %>% select(-Action_Obligation_OMB20_GDP20,Action_Obligation_2020),
          by=c("ProjectName"))

drone$TopProject[is.na(drone$TopProject) & !is.na(drone$ProjectName)]<-
  "Other Labeled Project"


summary(factor(drone$TopProject))


summary(factor(platpsc$ProjectPlatform))

dronePSC<-drone %>% group_by (ProductOrServiceCode,ProductOrServiceCodeText) %>%
  summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
            Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB20_GDP20,0)))%>%
              group_by () %>%
    mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
                        rank_2020=rank(desc(Action_Obligation_2020)))
dronePSC %>% arrange(desc(Action_Obligation_OMB20_GDP20))

dronePSC$dronePSCode<-
  ifelse(dronePSC$rank_2020<=5 | dronePSC$rank_total<=5,dronePSC$ProductOrServiceCode,NA)
dronePSC$TopPStext<-
  ifelse(dronePSC$rank_2020<=5 | dronePSC$rank_total<=5,dronePSC$ProductOrServiceCodeText,NA)


drone<-left_join(drone,dronePSC %>% select(-Action_Obligation_OMB20_GDP20,Action_Obligation_2020),
          by=c("ProductOrServiceCode"))

drone$dronePSCode[is.na(drone$dronePSCode) & !is.na(drone$ProductOrServiceCode)]<-
  "Other Labeled PSC"
drone$TopPStext[is.na(drone$TopPStext) & !is.na(drone$ProductOrServiceCode)]<-
  "Other Labeled PSC"

drone$TopPStext<-factor_wrap(drone$TopPStext)

summary(factor(drone$TopPStext))



```


## Simple 
```{r drone_customer}

(
rc_psr<-build_plot(
  data=drone  ,
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=drone_lc,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="SimpleArea", #color_var
  facet_var="SimpleArea", #facet_var
  # column_key=drone_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)",caption="Note: Unlabeled not shown. Source: FPDS; CSIS analysis.")#+
    # facet_wrap(~ContractingAgencyTextSwr,ncol=4)
)

ggsave600dpi(rc_psr,file="..//output//Deep_Dives//Remotely_Crewed//Remotely_Crewed_psr.png",  
             width=13, height= 6, units="in",size=8, lineheight=1.2
             )
ggsave600dpi(rc_psr,file="..//output//Deep_Dives//Remotely_Crewed//Remotely_Crewed_psr.eps",  
             width=13, height= 6, units="in",size=16, lineheight=1.2
             )

write.csv(file="..//Output//Deep_Dives//Remotely_Crewed//Remotely_Crewed_crewed_psr.csv",row.names = FALSE,
          dronepscdetail$data %>% mutate(#Fiscal_Year=lubridate::year(dFYear),
                                bAction_Obligation_OMB20_GDP20=Action_Obligation_OMB20_GDP20/1000000000)%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(SimpleArea),
                      names_from=Fiscal_Year,values_from=bAction_Obligation_OMB20_GDP20)%>%
            arrange(SimpleArea),na="")

```

## Customer 
```{r drone_customer}

# drone %>% group_by(claimantprogramcode,ClaimantProgramCodeText) %>% 
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20))
# drone$SubCustomer
(
rc_customer<-build_plot(
  data=drone  ,
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=drone_lc,
  # NA, #VAR.ncol
  x_var="Fiscal_Year", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="SubCustomer", #color_var
  facet_var="SubCustomer", #facet_var
  # column_key=drone_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)",caption="Note: Unlabeled not shown. Source: FPDS; CSIS analysis.")#+
    # facet_wrap(~ContractingAgencyTextSwr,ncol=4)
)

ggsave600dpi(rc_customer,file="..//output//Deep_Dives//Remotely_Crewed//Remotely_Crewed_Customer.png",  
             width=13, height= 6, units="in",size=8, lineheight=1.2
             )
ggsave600dpi(rc_customer,file="..//output//Deep_Dives//Remotely_Crewed//Remotely_Crewed_Customer.eps",  
             width=13, height= 6, units="in",size=16, lineheight=1.2
             )

write.csv(file="..//Output//Deep_Dives//Remotely_Crewed//Remotely_Crewed_crewed_Customer.csv",row.names = FALSE,
          dronepscdetail$data %>% mutate(#Fiscal_Year=lubridate::year(dFYear),
                                bAction_Obligation_OMB20_GDP20=Action_Obligation_OMB20_GDP20/1000000000)%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(SubCustomer),
                      names_from=Fiscal_Year,values_from=bAction_Obligation_OMB20_GDP20)%>%
            arrange(SubCustomer),na="")

```

## Vendor International
```{r ToplineVendor}


(
RCVendorIntl<-build_plot(
  data=drone %>% filter(Fiscal_Year<=2020),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="VendorSize_Intl", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)",
       caption="Source: FPDS; CSIS Analysis.\nNote: The merger of Raytheon and United Technologies took place in April of 2020 and thus did not make the cutofff for inclusion in FY2020.")
)

ggsave600dpi("..//Output//Deep_Dives//Remotely_Crewed//remotely_crewed_vendor_intl_square.png", RCVendorIntl+
  labs(y="Obligations (Constant 2020 $s)",caption="Source: FPDS; CSIS Analysis.\nNote: The merger of Raytheon and United Technologies is took place in \nApril of 2020 and thus did not make the cutofff for inclusion in FY2020."), 
             width=6, height= 5, units="in",size=12,lineheight=1
             )



```

###FMS identification
```{r contract_identification}



# undebug(build_plot)

(rc_contract_identification <-  build_plot(data=drone %>% filter(ContractingCustomer=="Defense"),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="foreign_funding_description",
                            facet_var="IsFMS",
                            # second_var="StateRegion",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    # facet_grid(  IsFMS~., scales="free_y")+
  labs(#x="Year of Delivery (Calendar or Fiscal Varies by Source)",
       y="Constant 2020 $ Obligated",
       caption="Source: FPDS; CSIS analysis.")+
    guides(fill=guide_legend(ncol=3)))

ggsave600dpi(rc_contract_identification,file="../output//Deep_Dives//Remotely_Crewed//figure_03_contract_identification.png",
             size=12,lineheight=1, height =5, width=9)



```


### FMS Vendor Size/Intl and Place No JSF
```{r FPDS_vendor_Intl}

summary(factor(platpscintldef$Shiny.VendorSize[platpscintldef$VendorIsForeign==1]))
summary(platpscintldef$VendorSize_Intl)

# undebug(format_data_for_plot)
(fpds_vendor_intl_place_noJSF <-  build_plot(data=drone ,
                                       #IsFMS==TRUE 
                                       chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="VendorSize_Intl",
                            # facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS )+labs(title="FMS or Performed Internationally, No JSF")#, scales="free_y"
  )


# platpscintldef$Shiny.VendorSize
(rc_vendor_place_fms <-  build_plot(data=drone %>% filter((PlaceIsForeign==1|IsFMS==TRUE)&!is.na(PlaceIsForeign)&
                                                            !is.na(IsFMS)&Fiscal_Year>2011&Fiscal_Year<=2020),#IsFMS==TRUE  
                            chart_geom="Bar Chart",
                            x_var="Fiscal_Year",
                            y_var="Action_Obligation_OMB20_GDP20",
                            color_var="VendorSize_Intl",
                            facet_var="PlaceIsForeign",
                            second_var="IsFMS",
                            labels_and_colors=intl_lc,
                            column_key=intl_ck,
                            legend=TRUE,
                            caption=FALSE,
                            format=TRUE)+theme(legend.position = "right")+
    facet_grid( .~IsFMS+PlaceIsForeign )+labs(title="FMS or Performed Internationally, No JSF")#, scales="free_y"#, scales="free_y"
  )


write.csv(file="..//output//Deep_Dives//Remotely_Crewed//rc_vendor_place_FMS.csv",row.names = FALSE,
          rc_vendor_place_fms$data%>%# mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(VendorSize_Intl,IsFMS, PlaceIsForeign),
                        names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20)%>% arrange(PlaceIsForeign,IsFMS,VendorSize_Intl))

ggsave600dpi(rc_vendor_place_fms,file="../output/Deep_Dives//Remotely_Crewed//rc_vendor_place_FMS.png",
             size = 12, lineheight=1, height =4.5, width=9)



```

## Project
```{r Land}
summary(factor(drone$ProjectPlatform))
# drone$Fiscal_Year
# 
# topplat<-drone %>% filter(PlatformPortfolio=="Ships & Submarines") %>% group_by (ProjectName) %>%
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20),
#             Action_Obligation_2020=sum(ifelse(Fiscal_Year==2020,Action_Obligation_OMB20_GDP20,0))
#             )%>% mutate(rank_total=rank(desc(Action_Obligation_OMB20_GDP20)),
#                         rank_2020=rank(desc(Action_Obligation_2020)))
# topplat %>% arrange(desc(Action_Obligation_OMB20_GDP20))
# 
# drone$TopShipProject<-
#   ifelse(drone$ProjectName %in% topplat$ProjectName[topplat$rank_2020<=7 | topplat$rank_total<=7],
#          drone$ProjectName,NA)
# drone$TopShipProject[is.na(drone$TopShipProject) & !is.na(drone$ProjectName)]<-
#   "Other Labeled Project"
# summary(factor(drone$TopShipProject))


(
Platform<-build_plot(
  data=drone ,
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="TopProject", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)
# 
# 
(
PSC<-build_plot(
  data=drone,
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TopPStext", #color_var
  facet_var="TopPStext", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)

```


# Inflation
## Fuel
```{r Fuel}

# PlaceIsForeign
# full_data$PlaceStateRegion
# replace_nas_with_unlabeled(factor(full_data$PlaceIsForeign,levels=c(1,0),labels=c("Performed Abroad","Performed in the U.S."))
(
fuel<-build_plot(
  data=full_data %>% filter(ProductOrServiceArea=="Fuels")%>% 
    mutate(PlaceIsForeign=factor(PlaceIsForeign,levels=c(1,0),labels=c("Performed Abroad","Performed in the U.S."))),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="PlaceStateRegion", #color_var
  # facet_var="TopPStext", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  # theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)


(
fuel<-build_plot(
  data=full_data %>% filter(ProductOrServiceArea=="Fuels")%>% 
    mutate(PlaceIsForeign=factor(PlaceIsForeign,levels=c(1,0),labels=c("Performed Abroad","Performed in the U.S."))),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="PlaceIsForeign", #color_var
  # facet_var="TopPStext", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  # theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//Deep_Dives/Inflation/defense_fuel_place.png", fuel+labs(title="DoD Contract Obligations for Fuels", caption="Source: FPDS and CSIS analysis."), 
             width=6.5, height= 3.5, units="in",size=12,lineheight = 1
             )


write.csv(file="..//Output//Deep_Dives/Inflation/defense_fuel_place.csv",row.names = FALSE,
          fuel$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
          pivot_wider(id_cols=c(PlaceIsForeign),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20))



(
fuel_psc<-build_plot(
  data=platpscintldef %>% filter(ProductOrServiceArea=="Fuels")%>% 
    mutate(PlaceIsForeign=factor(PlaceIsForeign,levels=c(1,0),labels=c("Performed Abroad","Performed in the U.S."))),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="ProductOrServiceCodeText", #color_var
  # facet_var="TopPStext", #facet_var
  # column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  # theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)

```