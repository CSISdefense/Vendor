---
title: "Space and Launch"
output: html_document
date: "2024-05-07"
---

# Setup
First we load the data. Two datasets, one federal for the space platform, one just for top 10 vendors.

```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(openxlsx)
library(tidyverse)
library(scales)
library(openxlsx)
axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40


load(file="../data/clean/space_FPDS.Rda")


space$SpaceParentID<-space$ParentID


space<-read_and_join_experiment(space,path="",dir=file.path("..","output","space"),lookup_file="space_psc.csv",
                                add_var="SpaceArea",by=c("ProductOrServiceCode","ProductOrServiceCodeText",
                                                         "ProductServiceOrRnDarea"),
                                missing_file = "space_psc2.txt")

space_fedpsc<-read_and_join_experiment(space_fedpsc,path="",dir=file.path("..","output","space"),lookup_file="space_psc.csv",
                                add_var="SpaceArea",by=c("ProductOrServiceCode","ProductOrServiceCodeText",
                                                         "ProductServiceOrRnDarea"),
                                missing_file = "../Output/Space//missing_space_PSC.csv")



# space<-space %>% select(-TopPSCtextMY )
space_lc<-prepare_labels_and_colors(space, path="offline")
space_ck<-get_column_key(space, path="offline")



```


# Space Overall
## Customer

### Customer Comp
```{r SpaceCustComp}
# 
# (
# SpaceCustComp<-build_plot(
#   data=spaceplatpscintl %>% filter(Fiscal_YQ<2024 & Fiscal_YQ>=2007),
#   chart_geom = "Bar Chart",
#   share = FALSE,
#   labels_and_colors=space_lc,
#   # NA, #VAR.ncol
#   x_var="dFYear", #x_var
#   y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
#   color_var="Competition.sum", #color_var
#   facet_var="Customer", #facet_var
#   alpha_var="YTD",
#   column_key=space_ck,
#   format=TRUE,
#   ytextposition=FALSE
# )+
#   # theme(strip.text.y = element_text(angle=0))+
#  # theme(axis.text.x = element_text(angle=90))+
#  #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
#  #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
#  #             )+labs(title=NULL,
#   # x="Fiscal Year",
#   # y="Percent of Obligations",
#   # color="Competition")+
#   theme(legend.position = "right")+
#   labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Space Providers,\nby Competition FY 2007-FY 2023",x="Fiscal Year",
#        caption="Note: Northrop Grumman (NGC) and Boeing includes only space platform portfolio; all other vendors are completely included.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")+
#   date_x_year_breaks(2007,2023,3,partial_year=2024,partial_label="\nQ1")
# )



  
```

### Customer Pricing
```{r SpaceCustPricing}
# 
# (
# SpaceCustPricing<-build_plot(
#   data=spaceplatpscintl %>% filter(Fiscal_YQ<2024 & Fiscal_YQ>=2007),
#   chart_geom = "Bar Chart",
#   share = FALSE,
#   labels_and_colors=space_lc,
#   # NA, #VAR.ncol
#   x_var="dFYear", #x_var
#   y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
#   color_var="PricingUCA", #color_var
#   facet_var="Customer", #facet_var
#   alpha_var="YTD",
#   column_key=space_ck,
#   format=TRUE,
#   ytextposition=FALSE
# )+
#   # theme(strip.text.y = element_text(angle=0))+
#  # theme(axis.text.x = element_text(angle=90))+
#  #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
#  #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
#  #             )+labs(title=NULL,
#   # x="Fiscal Year",
#   # y="Percent of Obligations",
#   # color="Competition")+
#   theme(legend.position = "right")+
#   labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Space Providers,\nby Contract Pricing FY 2007-FY 2023",x="Fiscal Year",
#        caption="Note: Northrop Grumman (NGC) and Boeing includes only space platform portfolio; all other vendors are completely included.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")+
#   date_x_year_breaks(2007,2023,3,partial_year=2024,partial_label="\nQ1")
# )



```



### Customer Vehicle
```{r SpaceCust}
# 
# (
# SpaceCustVehicle<-build_plot(
#   data=spaceplatpscintl %>% filter(Fiscal_YQ<2024 & Fiscal_YQ>=2007),
#   chart_geom = "Bar Chart",
#   share = FALSE,
#   labels_and_colors=space_lc,
#   # NA, #VAR.ncol
#   x_var="dFYear", #x_var
#   y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
#   color_var="Vehicle.sum7", #color_var
#   facet_var="Customer", #facet_var
#   alpha_var="YTD",
#   column_key=space_ck,
#   format=TRUE,
#   ytextposition=FALSE
# )+
#   theme(legend.position = "right")+
#   labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Space Providers,\nby Contract Vehicle FY 2007-FY 2023",x="Fiscal Year",
#        caption="Note: Northrop Grumman (NGC) and Boeing includes only space platform portfolio; all other vendors are completely included.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")+
#   date_x_year_breaks(2007,2023,3,partial_year=2024,partial_label="\nQ1")
# )
# 
# (SpaceCustVehicleVar<-SpaceCustVehicle+facet_wrap(~Customer,scales="free_y")+labs(y="Obligations (Constant 2023 $s) Variable Scale"))
# 
# 
  
```
### Customer Commercial
```{r SpaceCust}
# 
# (
# SpaceCustComm<-build_plot(
#   data=spaceplatpscintl %>% filter(Fiscal_YQ<2024 & Fiscal_YQ>=2007),
#   chart_geom = "Bar Chart",
#   share = FALSE,
#   labels_and_colors=space_lc,
#   # NA, #VAR.ncol
#   x_var="dFYear", #x_var
#   y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
#   color_var="AnyCommercial", #color_var
#   facet_var="Customer", #facet_var
#   alpha_var="YTD",
#   column_key=space_ck,
#   format=TRUE,
#   ytextposition=FALSE
# )+
#   theme(legend.position = "right")+
#   labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Space Providers, by Vehicel FY 2007-FY 2023",x="Fiscal Year",
#        caption="Note: Northrop Grumman (NGC) and Boeing includes only space platform portfolio; all other vendors are completely included.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")+
#   date_x_year_breaks(2007,2023,3,partial_year=2024,partial_label="\nQ1")
# )
# 


```

## Space Vendor 
### Vendor Top PSC
```{r SpaceTopPSC}
# write.csv(space %>% group_by(ProductOrServiceCode,ProductOrServiceCodeText,ProductServiceOrRnDarea) %>% summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23)) %>% arrange(ProductOrServiceCode),file="..\\output\\Space\\space_psc.csv",
#           row.names = FALSE)
          

space<-label_top(space,
                    col="ProductOrServiceCodeText",
                    n=5,
                    top_name="TopPSCtext",
                    # group_list=c("multiyearcontract"),
                    recent=2023
                    #retain_rank=TRUE,
                    #write_file=file.path("..","Output","AcqTrends","TopProjectTest.csv")
                    )


# space<-space %>% select(-TopPSCtextMY )
space_lc<-prepare_labels_and_colors(space, path="offline")
space_ck<-get_column_key(space, path="offline")

summary(factor(space$SpacePSC))
   
(
SpacePSC<-build_plot(
  data=space %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024 ),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=space_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopPSCtext", #color_var
  facet_var="SpaceParentID",
  column_key=space_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2007,2023,4)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "bottom")+guides(fill=guide_legend(ncol=1))+facet_wrap(~SpaceParentID,nrow=2,
                                                                                 scale="free_y")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Space Providers,\nby Product or Service FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: Northrop Grumman (NGC) and Boeing includes only space platform portfolio; all other vendors are completely included.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")
)


log_plot(plot=SpacePSC, df=space %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="space_vend_psc",xlsx="Space_Acq_Trends.xlsx",
                     sheet="VendPSC",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,format=TRUE,
         output_slide_png = TRUE, slide_size=16 ,var_list=c("SpaceParentID","TopPSCtext")
         )



```
### Vendor Area
```{r SpaceTopPSC}
# write.csv(
space %>% filter(SpaceParentID %in% c("RUSSIA SPACE AGENCY"))%>% group_by(ProductOrServiceCode,ProductOrServiceCodeText,SpaceArea) %>% summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23)) %>% arrange(-Action_Obligation_OMB25_GDP23)
      #"ABL Space" ,"BLUE ORIGIN","Firefly Aerospace","Rocket Lab", "RUSSIA SPACE AGENCY", "Virgin Orbit"

# write.csv(space %>% group_by(ProductOrServiceCode,ProductOrServiceCodeText,ProductServiceOrRnDarea) %>% summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23)) %>% arrange(ProductOrServiceCode),file="..\\output\\Space\\space_psc.csv",
#           row.names = FALSE)
          

summary(factor(space$SpacePSC))
   
(
SpaceArea<-build_plot(
  data=space %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024 ),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=space_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SpaceArea", #color_var
  facet_var="SpaceParentID",
  column_key=space_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2007,2023,4)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "right")+guides(fill=guide_legend(ncol=1))+facet_wrap(~SpaceParentID,nrow=3,
                                                                                 scale="free_y")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Space Providers,\nby Area FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: Northrop Grumman (NGC) and Boeing includes only space platform portfolio; all other vendors are completely included.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")
)


log_plot(plot=SpaceArea, df=space %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="space_vend_area",xlsx="Space_Acq_Trends.xlsx",
                     sheet="VendArea",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,format=TRUE,
         output_slide_png = TRUE, slide_size=16 ,var_list=c("SpaceParentID","SpaceArea")
         )



```

### Vendor Top Project
```{r SpaceTopProject}
str(space)

space<-label_top(space,
                    col="Project.Name",
                    n=5,
                    top_name="TopProject",
                    # group_list=c("multiyearcontract"),
                    recent=2023
                    #retain_rank=TRUE,
                    #write_file=file.path("..","Output","AcqTrends","TopProjectTest.csv")
                    )

space_lc<-prepare_labels_and_colors(space, path="offline")
space_ck<-get_column_key(space, path="offline")

summary(factor(space$TopProject))
   
(
SpaceProj<-build_plot(
  data=space %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024 ),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=space_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="SpaceParentID",
  column_key=space_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2007,2023,4)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "bottom")+guides(fill=guide_legend(ncol=3))+facet_wrap(~SpaceParentID,nrow=2,
                                                                                 scale="free_y")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Space Providers,\nby Project FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: Northrop Grumman (NGC) and Boeing includes only space platform portfolio; all other vendors are completely included.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")
)


log_plot(plot=SpaceProj, df=space %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="space_vend_proj",xlsx="Space_Acq_Trends.xlsx",
                     sheet="VendProj",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,format=TRUE,
         output_slide_png = TRUE, slide_size=16 ,var_list=c("SpaceParentID","TopProject")
         )


```

### Vendor Top CAU
```{r SpaceTopCAU}

space<-label_top(space,
                    col="contract_award_unique_key",
                    n=3,
                    top_name="TopCAU",
                    # group_list=c("multiyearcontract"),
                    recent=2023
                    #retain_rank=TRUE,
                    #write_file=file.path("..","Output","AcqTrends","TopProjectTest.csv")
                    )


# space<-space %>% select(-TopPSCtextMY )
space_lc<-prepare_labels_and_colors(space, path="offline")
space_ck<-get_column_key(space, path="offline")

   
(
SpaceCAU<-build_plot(
  data=space %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024 ),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=space_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopCAU", #color_var
  facet_var="SpaceParentID",
  column_key=space_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2007,2023,4)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "bottom")+guides(fill=guide_legend(ncol=1))+facet_wrap(~SpaceParentID,nrow=2,
                                                                                 scale="free_y")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Space Providers,\nby Top Contract FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: Northrop Grumman (NGC) and Boeing includes only space platform portfolio; all other vendors are completely included.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")
)


log_plot(plot=SpaceCAU, df=space %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="space_vend_psc",xlsx="Space_Acq_Trends.xlsx",
                     sheet="VendCAU",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,format=TRUE,
         output_slide_png = TRUE, slide_size=16 ,var_list=c("SpaceParentID","TopCAU")
         )



```


### Vendor Customer
```{r Space}

(
SpaceParentOnly<-build_plot(
  data=space %>% filter(Fiscal_YQ<2024 & Fiscal_YQ>=2007),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=space_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  # color_var="SpaceParentID", #color_var
  facet_var="SpaceParentID", #facet_var
  # alpha_var="YTD",
  column_key=space_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 9 Major Space Providers,\nby Customer FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: Northrop Grumman (NGC) includes only space platform portfolio; all other vendors are completely included.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")+
  date_x_year_breaks(2007,2023,3#,partial_year=2024,partial_label="\nQ1")
))


(
SpaceParent<-build_plot(
  data=space %>% filter(Fiscal_YQ<2024 & Fiscal_YQ>=2007),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=space_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Customer", #color_var
  facet_var="SpaceParentID", #facet_var
  alpha_var="YTD",
  column_key=space_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Space Providers,\ FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: Northrop Grumman (NGC) and Boeing includes only space platform portfolio; all other vendors are completely included.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")+
  date_x_year_breaks(2007,2023,3)#,partial_year=2024,partial_label="\nQ1")
)

(SpaceParentVar<-SpaceParent+facet_wrap(~SpaceParentID,scales="free_y")+labs(y="Obligations (Constant 2023 $s) Variable Scale"))


  
log_plot(plot=SpaceParent, df=space %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="space_vend_cust",xlsx="Space_Acq_Trends.xlsx",
                     sheet="VendCust",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,
                     startRow=1,startCol=12,format=TRUE,
         output_slide_png = TRUE, slide_size=16 ,var_list=c("SpaceParentID","Customer")
         )


log_plot(plot=SpaceParentOnly, df=space %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="space_vend",xlsx="Space_Acq_Trends.xlsx",
                     sheet="Vend",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,
                     startRow=1,startCol=12,format=TRUE,#,var_list=c("SimpleArea","Competition.multisum"),
         output_slide_png = TRUE , slide_size=16
         )
ggsave600dpi("..//Output//Space//space_vend_cust_variable_slide.png", SpaceParentVar, 
             width=13, height= 5.5, units="in",size=14,lineheight = 1
             )
```


### Vendor Comp
```{r SpaceComp}

(
SpaceComp<-build_plot(
  data=space %>% filter(Fiscal_YQ<2024 & Fiscal_YQ>=2007),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=space_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.sum", #color_var
  facet_var="SpaceParentID", #facet_var
  alpha_var="YTD",
  column_key=space_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Space Providers,\nby Competition FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: Northrop Grumman (NGC) and Boeing includes only space platform portfolio; all other vendors are completely included.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")+
  date_x_year_breaks(2007,2023,3#,partial_year=2024,partial_label="\nQ1")
))

(SpaceCompVar<-SpaceComp+facet_wrap(~SpaceParentID,scales="free_y")+labs(y="Obligations (Constant 2023 $s) Variable Scale"))


  
log_plot(plot=SpaceCompVar, df=space %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="space_vend_cust",xlsx="Space_Acq_Trends.xlsx",
                     sheet="VendComp",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,
                     startRow=1,startCol=12,format=TRUE,
         output_slide_png = TRUE, slide_size=16 ,var_list=c("SpaceParentID","Competition.sum")
         )

```

### Vendor Pricing
```{r Space}

(
SpacePricing<-build_plot(
  data=space %>% filter(Fiscal_YQ<2024 & Fiscal_YQ>=2007),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=space_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingUCA", #color_var
  facet_var="SpaceParentID", #facet_var
  alpha_var="YTD",
  column_key=space_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Space Providers,\nby Contract Pricing FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: Northrop Grumman (NGC) and Boeing includes only space platform portfolio; all other vendors are completely included.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")+
  date_x_year_breaks(2007,2023,3#,partial_year=2024,partial_label="\nQ1")
))

(SpacePricingVar<-SpacePricing+facet_wrap(~SpaceParentID,scales="free_y")+labs(y="Obligations (Constant 2023 $s) Variable Scale"))


  
log_plot(plot=SpacePricingVar, df=space %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="space_vend_pricing",xlsx="Space_Acq_Trends.xlsx",
                     sheet="VendPric",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,format=TRUE,
         output_slide_png = TRUE, slide_size=16 ,var_list=c("SpaceParentID","PricingUCA")
         )

```



### Vendor Vehicle
```{r Space}

(
SpaceVehicle<-build_plot(
  data=space %>% filter(Fiscal_YQ<2024 & Fiscal_YQ>=2007),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=space_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Vehicle.sum7", #color_var
  facet_var="SpaceParentID", #facet_var
  alpha_var="YTD",
  column_key=space_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Space Providers,\nby Vehicle FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: Northrop Grumman (NGC) and Boeing includes only space platform portfolio; all other vendors are completely included.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")+
  date_x_year_breaks(2007,2023,3#,partial_year=2024,partial_label="\nQ1")
))

(SpaceVehicleVar<-SpaceVehicle+facet_wrap(~SpaceParentID,scales="free_y")+labs(y="Obligations (Constant 2023 $s) Variable Scale"))


  
log_plot(plot=SpaceVehicleVar, df=space %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="space_vend_vehicle",xlsx="Space_Acq_Trends.xlsx",
                     sheet="VendVeh",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,format=TRUE,
         output_slide_png = TRUE, slide_size=16 ,var_list=c("SpaceParentID","Vehicle.sum7")
         )

```
### Vendor Commercial
```{r Space}
space$AnyCommercialText<-factor(space$AnyCommercial)
levels(space$AnyCommercialText)<-list(
  "Not Classified\nas Commercial"="N",
  "Non-development\nor Commercial Similar"= "NonDev",
  "Any Commercial\nClassification"="Y"
 
)

(
SpaceComm<-build_plot(
  data=space %>% filter(Fiscal_YQ<2024 & Fiscal_YQ>=2007),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=space_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="AnyCommercialText", #color_var
  facet_var="SpaceParentID", #facet_var
  alpha_var="YTD",
  column_key=space_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Space Providers,\nby Commercial Contracting FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: Northrop Grumman (NGC) and Boeing includes only space platform portfolio; all other vendors are completely included.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")+
  date_x_year_breaks(2007,2023,3#,partial_year=2024,partial_label="\nQ1")
))

(SpaceCommVar<-SpaceComm+facet_wrap(~SpaceParentID,scales="free_y")+labs(y="Obligations (Constant 2023 $s) Variable Scale"))


  
log_plot(plot=SpaceCommVar, df=space %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="space_vend_commercial",xlsx="Space_Acq_Trends.xlsx",
                     sheet="VendComm",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,format=TRUE,
         output_slide_png = TRUE, slide_size=16 ,var_list=c("SpaceParentID","AnyCommercialText")
         )

```

# Launch
## ** Setup **
```{r LaunchSetup}
space_fedpsc<-read_and_join_experiment(space_fedpsc,path="",dir=file.path("..","output","space"),lookup_file="space_psc.csv",
                                add_var="SpaceArea",by=c("ProductOrServiceCode","ProductOrServiceCodeText",
                                                         "ProductServiceOrRnDarea"),
                                missing_file = "../Output/Space//missing_space_PSC.csv")


launch<-space %>% filter(Project.Name=="EELV" | SpaceArea %in% c("R&D (Space Flight)",
                                                                "Space Transp. and Launch",
                                                                "Space Vehicle Launchers")|
                           SpaceParentID %in% c("RUSSIA SPACE AGENCY"))






# add_labels_and_colors(launch_plus,"SpaceParentID.sum","ParentID")

launch_fedpsc<-space_fedpsc %>% filter(Project.Name=="EELV" | SpaceArea %in% c("R&D (Space Flight)",
                                                                "Space Transp. and Launch",
                                                                "Space Vehicle Launchers"))

summary(factor(space$SpaceParentID))
summary(factor(launch_fedpsc$SpaceArea))

colnames(launch_fedpsc)[!colnames(launch_fedpsc) %in% colnames(launch)]

colnames(launch)[!colnames(launch) %in% colnames(launch_fedpsc)]

common_cols<-colnames(launch)[colnames(launch) %in% colnames(launch_fedpsc)]
common_cols<-c("Fiscal_Year" ,
              "dFYear",
              "ProjectID",
              "ProductOrServiceCode",
              "Contracting_Agency_ID",
              "Project.Name",
              "Action_Obligation_OMB25_GDP23",
              "Action_Obligation_Then_Year",
              "SpaceArea",
              "Fiscal_YQ"
              )

launch_residual<-launch_fedpsc[,colnames(launch_fedpsc) %in% common_cols]
launch_residual<-launch_residual%>%group_by_list(common_cols[!common_cols %in% c("Action_Obligation_Then_Year",
  "Action_Obligation_OMB25_GDP23")])%>%summarise(
    Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE),
        Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE)
  )

if(sum(launch_residual$Action_Obligation_Then_Year)!=sum(launch_fedpsc$Action_Obligation_Then_Year))
  stop("Checksum error")

colnames(launch_residual)[colnames(launch_residual)=="Action_Obligation_Then_Year"]<-"Total_Action_Obligation_Then_Year"
colnames(launch_residual)[colnames(launch_residual)=="Action_Obligation_OMB25_GDP23"]<-"Total_Action_Obligation_OMB25_GDP23"

launch_join<-launch[,colnames(launch) %in% common_cols]
launch_join<-launch_join%>%group_by_list(common_cols[!common_cols %in% c("Action_Obligation_Then_Year",
  "Action_Obligation_OMB25_GDP23")])%>%summarise(
    Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE),
        Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE)
  )


if(sum(launch_residual$Total_Action_Obligation_Then_Year)!=sum(launch_fedpsc$Action_Obligation_Then_Year) |
   sum(launch_residual$Total_Action_Obligation_OMB25_GDP23)!=sum(launch_fedpsc$Action_Obligation_OMB25_GDP23)
   )
  stop("Checksum error")

if(sum(launch_join$Action_Obligation_Then_Year,na.rm=TRUE)!=sum(launch$Action_Obligation_Then_Year,na.rm=TRUE) |
   sum(launch_join$Action_Obligation_OMB25_GDP23,na.rm=TRUE)!=sum(launch$Action_Obligation_OMB25_GDP23,na.rm=TRUE)
   )
  stop("Checksum error")


launch_residual<-left_join(launch_residual,launch_join)

if(sum(launch_residual$Total_Action_Obligation_Then_Year,na.rm = TRUE)!=
   sum(launch_fedpsc$Action_Obligation_Then_Year,na.rm = TRUE) |
   sum(launch_residual$Total_Action_Obligation_OMB25_GDP23,na.rm = TRUE)!=
   sum(launch_fedpsc$Action_Obligation_OMB25_GDP23,na.rm = TRUE)
   )
  stop("Checksum error")

match_rows<-launch$Project.Name=="EELV" | launch$SpaceArea %in% c("R&D (Space Flight)",
                                                                "Space Transp. and Launch",
                                                                "Space Vehicle Launchers")

if(sum(launch_residual$Action_Obligation_Then_Year,na.rm=TRUE)!=sum(launch$Action_Obligation_Then_Year[match_rows],na.rm=TRUE) |
   sum(launch_residual$Action_Obligation_OMB25_GDP23,na.rm=TRUE)!=sum(launch$Action_Obligation_OMB25_GDP23[match_rows],na.rm=TRUE)
   )
  stop("Checksum error")

launch_residual%>%group_by(Fiscal_Year) %>%
  summarise(Total_Action_Obligation_OMB25_GDP23=sum(Total_Action_Obligation_OMB25_GDP23,na.rm=TRUE),
    Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))

launch_residual %>% filter(Project.Name=="EELV") %>%group_by(Fiscal_Year) %>%
  summarise(Total_Action_Obligation_OMB25_GDP23=sum(Total_Action_Obligation_OMB25_GDP23,na.rm=TRUE),
    Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))

launch_residual<-launch_residual %>% mutate(
  Residual_Action_Obligation_OMB25_GDP23=
    case_when(is.na(Action_Obligation_OMB25_GDP23)~Total_Action_Obligation_OMB25_GDP23,
              is.na(Total_Action_Obligation_OMB25_GDP23)~-Action_Obligation_OMB25_GDP23,
              TRUE ~ Total_Action_Obligation_OMB25_GDP23-Action_Obligation_OMB25_GDP23),
  Residual_Action_Obligation_Then_Year=case_when(is.na(Action_Obligation_Then_Year)~Total_Action_Obligation_Then_Year,
              is.na(Total_Action_Obligation_Then_Year)~-Action_Obligation_Then_Year,
              TRUE ~ Total_Action_Obligation_Then_Year-Action_Obligation_Then_Year))


if(sum(launch_residual$Total_Action_Obligation_Then_Year,na.rm = TRUE)!=
   sum(launch_fedpsc$Action_Obligation_Then_Year,na.rm = TRUE) |
   sum(launch_residual$Total_Action_Obligation_OMB25_GDP23,na.rm = TRUE)!=
   sum(launch_fedpsc$Action_Obligation_OMB25_GDP23,na.rm = TRUE) |
   sum(launch_residual$Action_Obligation_Then_Year,na.rm=TRUE)!=sum(launch$Action_Obligation_Then_Year[match_rows],na.rm=TRUE) |
   sum(launch_residual$Action_Obligation_OMB25_GDP23,na.rm=TRUE)!=sum(launch$Action_Obligation_OMB25_GDP23[match_rows],na.rm=TRUE)
   )
  stop("Checksum error")


if((sum(launch_residual$Residual_Action_Obligation_OMB25_GDP23,na.rm = TRUE)+
   sum(launch_residual$Action_Obligation_OMB25_GDP23,na.rm = TRUE))-
   sum(launch_residual$Total_Action_Obligation_OMB25_GDP23,na.rm = TRUE)>0.1 |
   (sum(launch_residual$Residual_Action_Obligation_Then_Year,na.rm = TRUE)+
   sum(launch_residual$Action_Obligation_Then_Year,na.rm = TRUE))-
   sum(launch_residual$Total_Action_Obligation_Then_Year,na.rm = TRUE)>
   0.1)
  stop("Checksum error")  
   

if((sum(launch_residual$Residual_Action_Obligation_OMB25_GDP23,na.rm = TRUE)+
   sum(launch$Action_Obligation_OMB25_GDP23[match_rows],na.rm = TRUE))-
   sum(launch_fedpsc$Action_Obligation_OMB25_GDP23,na.rm = TRUE)>0.1 |
   (sum(launch_residual$Residual_Action_Obligation_Then_Year,na.rm = TRUE)+
   sum(launch$Action_Obligation_Then_Year[match_rows],na.rm = TRUE))-
   sum(launch_fedpsc$Action_Obligation_Then_Year,na.rm = TRUE)>
   0.1)
  stop("Checksum error")  
   


sum(launch_residual$Total_Action_Obligation_OMB25_GDP23[launch_residual$SpaceArea %in% c("R&D (Space Flight)",
                                                                "Space Transp. and Launch",
                                                                "Space Vehicle Launchers")],na.rm = TRUE)
sum(launch_fedpsc$Action_Obligation_OMB25_GDP23[launch$SpaceArea %in% c("R&D (Space Flight)",
                                                                "Space Transp. and Launch",
                                                                "Space Vehicle Launchers")],na.rm = TRUE)


launch_residual%>%group_by(Fiscal_Year) %>%
  summarise(Total_Action_Obligation_OMB25_GDP23=sum(Total_Action_Obligation_OMB25_GDP23,na.rm=TRUE),
    Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE),
    Residual_Action_Obligation_OMB25_GDP23=sum(Residual_Action_Obligation_OMB25_GDP23,na.rm = TRUE))

launch_residual %>% filter(Project.Name=="EELV") %>%group_by(Fiscal_Year) %>%
  summarise(Total_Action_Obligation_OMB25_GDP23=sum(Total_Action_Obligation_OMB25_GDP23,na.rm=TRUE),
    Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23,na.rm = TRUE),
    Residual_Action_Obligation_OMB25_GDP23=sum(Residual_Action_Obligation_OMB25_GDP23,na.rm = TRUE)
    )

launch_residual$SpaceParentID<-"Other Residual"
launch_residual<-launch_residual %>% select(-Action_Obligation_OMB25_GDP23,-Action_Obligation_Then_Year,
                                            -Total_Action_Obligation_OMB25_GDP23,-Total_Action_Obligation_Then_Year)

colnames(launch_residual)[colnames(launch_residual)=="Residual_Action_Obligation_Then_Year"]<-"Action_Obligation_Then_Year"
colnames(launch_residual)[colnames(launch_residual)=="Residual_Action_Obligation_OMB25_GDP23"]<-"Action_Obligation_OMB25_GDP23"
launch_plus<-bind_rows(launch,launch_residual)


if(sum(launch_plus$Action_Obligation_OMB25_GDP23[launch_plus$SpaceArea %in% c("R&D (Space Flight)",
                                                                "Space Transp. and Launch",
                                                                "Space Vehicle Launchers")],na.rm = TRUE)!=
   sum(launch_fedpsc$Action_Obligation_OMB25_GDP23[launch_fedpsc$SpaceArea %in% c("R&D (Space Flight)",
                                                                "Space Transp. and Launch",
                                                                "Space Vehicle Launchers")],na.rm = TRUE) |
  sum(launch_plus$Action_Obligation_Then_Year[launch_plus$SpaceArea %in% c("R&D (Space Flight)",
                                                                "Space Transp. and Launch",
                                                                "Space Vehicle Launchers")],na.rm = TRUE)!=
   sum(launch_fedpsc$Action_Obligation_Then_Year[launch_fedpsc$SpaceArea %in% c("R&D (Space Flight)",
                                                                "Space Transp. and Launch",
                                                                "Space Vehicle Launchers")],na.rm = TRUE))
  stop("Checksum error")


launch_plus$SpaceParentID.sum<-factor(launch_plus$SpaceParentID)
levels(launch_plus$SpaceParentID.sum)<-
  list(
    "UNITED LAUNCH ALLIANCE"    ="UNITED LAUNCH ALLIANCE"    ,
    "BOEING"    ="BOEING"    ,
    "SPACEX"       ="SPACEX"       ,
    "NORTHROP GRUMMAN / ORBITAL"=c("NORTHROP GRUMMAN" ,"Orbital ATK" ,"ORBITAL SCIENCES" ),
    "RUSSIA SPACE AGENCY"="RUSSIA SPACE AGENCY",
    "SIERRA NEVADA"="SIERRA NEVADA",
    "BLUE ORIGIN"="BLUE ORIGIN",
  "Other New Space"=c("ABL Space","Firefly Aerospace","Rocket Lab","Virgin Orbit"),
 "Other Residual"=c("WYLE LABORATORIES","CALIFORNIA INSTITUTE OF TECHNOLOGY","JOHNS HOPKINS UNIVERSITY"   ,
                      "MAXAR TECHNOLOGIES" , "MDA" ,"LORAL SPACE","Other Residual")
  )


launch$SpaceAreaEELV<-launch$SpaceArea
launch$SpaceAreaEELV[launch$Project.Name=="EELV" & 
                       !launch$SpaceArea %in% c("R&D (Space Flight)",
                                                                "Space Transp. and Launch",
                                                                "Space Vehicle Launchers")]<-"Other EELV"

launch_plus$SpaceAreaEELV<-launch_plus$SpaceArea

launch_plus$SpaceAreaEELV[launch_plus$Project.Name=="EELV" & 
                       !launch_plus$SpaceArea %in% c("R&D (Space Flight)",
                                                                "Space Transp. and Launch",
                                                                "Space Vehicle Launchers")]<-"Other EELV"

launch_fedpsc$SpaceAreaEELV<-launch_fedpsc$SpaceArea
launch_fedpsc$SpaceAreaEELV[launch_fedpsc$Project.Name=="EELV" & 
                       !launch_fedpsc$SpaceArea %in% c("R&D (Space Flight)",
                                                                "Space Transp. and Launch",
                                                                "Space Vehicle Launchers")]<-"Other EELV"



launch_lc<-prepare_labels_and_colors(launch_plus, path="offline")
launch_ck<-get_column_key(launch_plus, path="offline")


```

## Launch PSC
### Area alone
```{r LaunchArea} 
(
SpaceArea<-build_plot(
  data=launch_fedpsc %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024 ),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=launch_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SpaceAreaEELV", #color_var
  facet_var="SpaceAreaEELV",
  column_key=launch_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2007,2023,4)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "right")+guides(fill=guide_legend(ncol=1))+#facet_wrap(~SpaceParentID,ncol=4,scale="free_y")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for Launch and Adjacent R&D,\nby Area FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: The EELV and Russia Space Agency are entirely included, all other vendors are limited to launch product or service codes.\nSource: FPDS and CSIS analysis")
)

(
SpaceAreaLaunchPlus<-build_plot(
  data=launch_plus %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024 ),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=launch_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SpaceAreaEELV", #color_var
  facet_var="SpaceAreaEELV",
  column_key=launch_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2007,2023,4)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "right")+guides(fill=guide_legend(ncol=1))+#facet_wrap(~SpaceParentID,ncol=4,scale="free_y")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for Launch and Adjacent R&D,\nby Area FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: The EELV and Russia Space Agency are entirely included, all other vendors are limited to launch product or service codes.\nSource: FPDS and CSIS analysis")
)



log_plot(plot=SpaceAreaLaunchPlus, df=launch_plus %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="launch_area",xlsx="Launch_Acq_Trends.xlsx",
                     sheet="Area",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,
                     startRow=1,startCol=12,format=TRUE,#,var_list=c("SimpleArea","Competition.multisum"),
         output_slide_png = TRUE , slide_size=16
         )



(
SpaceArea<-build_plot(
  data=launch %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024 ),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=launch_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SpaceAreaEELV", #color_var
  facet_var="SpaceAreaEELV",
  column_key=launch_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2007,2023,4)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "right")+guides(fill=guide_legend(ncol=1))+#facet_wrap(~SpaceParentID,ncol=4,scale="free_y")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for Launch and Adjacent R&D,\nby Area FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: The EELV and Russia Space Agency are entirely included, all other vendors are limited to launch product or service codes.\nSource: FPDS and CSIS analysis")
)


```
## Launch Vendor 
### Vendor
```{r Launch}

(
LaunchParentOnly<-build_plot(
  data=launch_plus %>% filter(Fiscal_YQ<2024 & Fiscal_YQ>=2007),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=launch_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  # color_var="SpaceParentID", #color_var
  facet_var="SpaceParentID", #facet_var
  # alpha_var="YTD",
  column_key=launch_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", launch="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for Selected Launch Providers and Researchers,\nFY 2007-FY 2023",x="Fiscal Year",
       caption="Note: The EELV and Russia Space Agency are entirely included, all other vendors are limited to launch product or service codes.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")+
  date_x_year_breaks(2007,2023,3#,partial_year=2024,partial_label="\nQ1")
))


  

log_plot(plot=LaunchParentOnly, df=launch_plus %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="launch_vend",xlsx="Launch_Acq_Trends.xlsx",
                     sheet="Vend",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,
                     startRow=1,startCol=12,format=TRUE,#,var_list=c("SimpleArea","Competition.multisum"),
         output_slide_png = TRUE , slide_size=16
         )




(
LaunchParentOnlySum<-build_plot(
  data=launch_plus %>% filter(Fiscal_YQ<2024 & Fiscal_YQ>=2007),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=launch_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  # color_var="SpaceParentID", #color_var
  facet_var="SpaceParentID.sum", #facet_var
  # alpha_var="YTD",
  column_key=launch_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for Top 7 Launch Providers,\nby Customer FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: The EELV and Russia Space Agency are entirely included, all other vendors are limited to launch product or service codes.\nSource: FPDS and CSIS analysis")+
  date_x_year_breaks(2007,2023,3#,partial_year=2024,partial_label="\nQ1")
))

log_plot(plot=LaunchParentOnlySum, df=launch_plus %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="launch_vend_sum",xlsx="Launch_Acq_Trends.xlsx",
                     sheet="VendSum",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,
                     startRow=1,startCol=12,format=TRUE,#,var_list=c("SimpleArea","Competition.multisum"),
         output_slide_png = TRUE , slide_size=16
         )



```




### Vendor Area
```{r LaunchTopPSC}
# write.csv(

launch %>% filter(SpaceParentID %in% c("RUSSIA SPACE AGENCY"))%>% group_by(ProductOrServiceCode,ProductOrServiceCodeText,SpaceArea) %>% summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23)) %>% arrange(-Action_Obligation_OMB25_GDP23)
      #"ABL Space" ,"BLUE ORIGIN","Firefly Aerospace","Rocket Lab", "RUSSIA SPACE AGENCY", "Virgin Orbit"

# write.csv(launch %>% group_by(ProductOrServiceCode,ProductOrServiceCodeText,ProductServiceOrRnDarea) %>% summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23)) %>% arrange(ProductOrServiceCode),file="..\\output\\Space\\launch_psc.csv",
#           row.names = FALSE)
          
launch<-read_and_join_experiment(launch,path="",dir=file.path("..","output","space"),lookup_file="space_psc.csv",
                                add_var="SpaceArea",by=c("ProductOrServiceCode","ProductOrServiceCodeText",
                                                         "ProductServiceOrRnDarea"))
launch_plus<-read_and_join_experiment(launch_plus,path="",dir=file.path("..","output","space"),lookup_file="space_psc.csv",
                                add_var="SpaceArea",by=c("ProductOrServiceCode","ProductOrServiceCodeText",
                                                         "ProductServiceOrRnDarea"))
# add_labels_and_colors(launch,"SpaceAreaEELV","Area")

summary(factor(launch$LaunchPSC))
   
(
SpaceArea<-build_plot(
  data=launch_plus %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024 ),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=launch_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SpaceAreaEELV", #color_var
  facet_var="SpaceParentID",
  column_key=launch_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2007,2023,4)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "right")+guides(fill=guide_legend(ncol=1))+facet_wrap(~SpaceParentID,ncol=4,
                                                                                 scale="free_y")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for Selected Launch Providers and Researchers,\nFY 2007-FY 2023",x="Fiscal Year",
       caption="Note: The EELV and Russia Space Agency are entirely included, all other vendors are limited to launch product or service codes.\nSource: FPDS and CSIS analysis")
)


log_plot(plot=SpaceArea, df=launch_plus %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="launch_vend_area",xlsx="Launch_Acq_Trends.xlsx",
                     sheet="VendArea",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,format=TRUE,
         output_slide_png = TRUE, slide_size=16 ,var_list=c("SpaceParentID","SpaceArea")
         )


  
(
SpaceAreaSum<-build_plot(
  data=launch_plus %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024 ),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=launch_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SpaceAreaEELV", #color_var
  facet_var="SpaceParentID.sum",
  column_key=launch_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2007,2023,4)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "right")+guides(fill=guide_legend(ncol=1))+#facet_wrap(~SpaceParentID.sum,nrow=3,
                                                                           #      scale="free_y")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for Top 7 Launch Providers,\nby Area FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: The EELV and Russia Space Agency are entirely included, all other vendors are limited to launch product or service codes.\nSource: FPDS and CSIS analysis")
)

log_plot(plot=SpaceAreaSum, df=launch_plus %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="launch_vend_area_sum",xlsx="Launch_Acq_Trends.xlsx",
                     sheet="VendSumArea",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,format=TRUE,
         output_slide_png = TRUE, slide_size=16 ,var_list=c("SpaceParentID","SpaceArea")
         )


```

### Vendor Top PSC
```{r LaunchTopPSC}
# write.csv(launch %>% group_by(ProductOrServiceCode,ProductOrServiceCodeText,ProductServiceOrRnDarea) %>% summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23)) %>% arrange(ProductOrServiceCode),file="..\\output\\Space\\launch_psc.csv",
#           row.names = FALSE)


launch<-label_top(launch,
                    col="ProductOrServiceCodeText",
                    n=3,
                    top_name="TopPSCtext",
                    # group_list=c("multiyearcontract"),
                    recent=2023
                    #retain_rank=TRUE,
                    #write_file=file.path("..","Output","AcqTrends","TopProjectTest.csv")
                    )


# launch<-launch %>% select(-TopPSCtextMY )
launch_lc<-prepare_labels_and_colors(launch, path="offline")
launch_ck<-get_column_key(launch, path="offline")

summary(factor(launch$LaunchPSC))
   
(
LaunchPSC<-build_plot(
  data=launch %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024 ),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=launch_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopPSCtext", #color_var
  facet_var="SpaceParentID",
  column_key=launch_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2007,2023,4)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "bottom")+guides(fill=guide_legend(ncol=1))+facet_wrap(~SpaceParentID,nrow=2,
                                                                                 scale="free_y")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Launch Providers,\nby Product or Service FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: The EELV and Russia Space Agency are entirely included, all other vendors are limited to launch product or service codes.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")
)


log_plot(plot=LaunchPSC, df=launch %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="launch_vend_psc",xlsx="Launch_Acq_Trends.xlsx",
                     sheet="VendPSC",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,format=TRUE,
         output_slide_png = TRUE, slide_size=16 ,var_list=c("SpaceParentID","TopPSCtext")
         )



```
  ### Vendor Area
```{r LaunchTopPSC}
# write.csv(
launch %>% filter(SpaceParentID %in% c("RUSSIA SPACE AGENCY"))%>% group_by(ProductOrServiceCode,ProductOrServiceCodeText,SpaceArea) %>% summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23)) %>% arrange(-Action_Obligation_OMB25_GDP23)
      #"ABL Space" ,"BLUE ORIGIN","Firefly Aerospace","Rocket Lab", "RUSSIA SPACE AGENCY", "Virgin Orbit"

# write.csv(launch %>% group_by(ProductOrServiceCode,ProductOrServiceCodeText,ProductServiceOrRnDarea) %>% summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23)) %>% arrange(ProductOrServiceCode),file="..\\output\\Space\\launch_psc.csv",
#           row.names = FALSE)
          
launch<-read_and_join_experiment(launch,path="",dir=file.path("..","output","space"),lookup_file="space_psc.csv",
                                add_var="SpaceArea",by=c("ProductOrServiceCode","ProductOrServiceCodeText",
                                                         "ProductServiceOrRnDarea"))


# launch<-launch %>% select(-TopPSCtextMY )
launch_lc<-prepare_labels_and_colors(launch, path="offline")
launch_ck<-get_column_key(launch, path="offline")

summary(factor(launch$LaunchPSC))
   
(
SpaceArea<-build_plot(
  data=launch %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024 ),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=launch_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SpaceArea", #color_var
  facet_var="SpaceParentID",
  column_key=launch_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2007,2023,4)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "right")+guides(fill=guide_legend(ncol=1))+facet_wrap(~SpaceParentID,nrow=3,
                                                                                 scale="free_y")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Launch Providers,\nby Area FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: The EELV and Russia Space Agency are entirely included, all other vendors are limited to launch product or service codes.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")
)


log_plot(plot=SpaceArea, df=launch %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="launch_vend_area",xlsx="Launch_Acq_Trends.xlsx",
                     sheet="VendArea",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,format=TRUE,
         output_slide_png = TRUE, slide_size=16 ,var_list=c("SpaceParentID","SpaceArea")
         )



```

### Vendor Top Project
```{r LaunchTopProject}
str(launch)

launch<-label_top(launch,
                    col="Project.Name",
                    n=5,
                    top_name="TopProject",
                    # group_list=c("multiyearcontract"),
                    recent=2023
                    #retain_rank=TRUE,
                    #write_file=file.path("..","Output","AcqTrends","TopProjectTest.csv")
                    )

launch_lc<-prepare_labels_and_colors(launch, path="offline")
launch_ck<-get_column_key(launch, path="offline")

summary(factor(launch$TopProject))
   
(
LaunchProj<-build_plot(
  data=launch %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024 ),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=launch_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopProject", #color_var
  facet_var="SpaceParentID",
  column_key=launch_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2007,2023,4)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "bottom")+guides(fill=guide_legend(ncol=3))+facet_wrap(~SpaceParentID,nrow=2,
                                                                                 scale="free_y")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Launch Providers,\nby Project FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: The EELV and Russia Space Agency are entirely included, all other vendors are limited to launch product or service codes.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")
)


log_plot(plot=SpaceProj, df=launch %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="launch_vend_proj",xlsx="Launch_Acq_Trends.xlsx",
                     sheet="VendProj",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,format=TRUE,
         output_slide_png = TRUE, slide_size=16 ,var_list=c("SpaceParentID","TopProject")
         )


```

### Vendor Top CAU
```{r LaunchTopCAU}

launch %>% filter(SpaceParentID=="SPACEX",SimpleArea=="R&D") %>%group_by(contract_award_unique_key)%>%
  summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE)) %>%arrange(-Action_Obligation_OMB25_GDP23)

launch<-label_top(launch,
                    col="contract_award_unique_key",
                    n=3,
                    top_name="TopCAU",
                    # group_list=c("multiyearcontract"),
                    recent=2023
                    #retain_rank=TRUE,
                    #write_file=file.path("..","Output","AcqTrends","TopProjectTest.csv")
                    )


# launch<-launch %>% select(-TopPSCtextMY )
launch_lc<-prepare_labels_and_colors(launch, path="offline")
launch_ck<-get_column_key(launch, path="offline")

   
(
LaunchCAU<-build_plot(
  data=launch %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024 ),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=launch_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopCAU", #color_var
  facet_var="SpaceParentID",
  column_key=launch_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2007,2023,4)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "bottom")+guides(fill=guide_legend(ncol=1))+facet_wrap(~SpaceParentID,nrow=2,
                                                                                 scale="free_y")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Launch Providers,\nby Top Contract FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: The EELV and Russia Space Agency are entirely included, all other vendors are limited to launch product or service codes.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")
)


log_plot(plot=LaunchCAU, df=launch %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="launch_vend_psc",xlsx="Launch_Acq_Trends.xlsx",
                     sheet="VendCAU",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,format=TRUE,
         output_slide_png = TRUE, slide_size=16 ,var_list=c("SpaceParentID","TopCAU")
         )



```


### Vendor All CAU
```{r LaunchTopCAU}

launch %>% filter(SpaceParentID=="SPACEX",SimpleArea=="R&D") %>%group_by(contract_award_unique_key)%>%
  summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE)) %>%arrange(-Action_Obligation_OMB25_GDP23)

write_csv(file="SpaceX_unique_contract_award_keys.csv",
launch %>% filter(SpaceParentID=="SPACEX") %>%group_by(ParentID,contract_award_unique_key,PricingMechanism,
                                                       ProductOrServiceCodeText,
                                                       CompetitionClassification,
                                                       ClassifyNumberOfOffers,
                                                       anycommercial,Vehicle)%>%
  summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE),
            baseandexercisedoptionsvalue=sum(baseandexercisedoptionsvalue,na.rm=TRUE),
            baseandalloptionsvalue=sum(baseandalloptionsvalue,na.rm=TRUE),
            MinOfsigneddate=min(signeddate),
            ) %>%arrange(-Action_Obligation_OMB25_GDP23))

colnames(launch)

launch<-label_top(launch,
                    col="contract_award_unique_key",
                    n=3,
                    top_name="TopCAU",
                    # group_list=c("multiyearcontract"),
                    recent=2023
                    #retain_rank=TRUE,
                    #write_file=file.path("..","Output","AcqTrends","TopProjectTest.csv")
                    )


# launch<-launch %>% select(-TopPSCtextMY )
launch_lc<-prepare_labels_and_colors(launch, path="offline")
launch_ck<-get_column_key(launch, path="offline")

   
(
LaunchCAU<-build_plot(
  data=launch %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024 ),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=launch_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="TopCAU", #color_var
  facet_var="SpaceParentID",
  column_key=launch_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2007,2023,4)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "bottom")+guides(fill=guide_legend(ncol=1))+facet_wrap(~SpaceParentID,nrow=2,
                                                                                 scale="free_y")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Launch Providers,\nby Top Contract FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: The EELV and Russia Space Agency are entirely included, all other vendors are limited to launch product or service codes.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")
)


log_plot(plot=LaunchCAU, df=launch %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="launch_vend_psc",xlsx="Launch_Acq_Trends.xlsx",
                     sheet="VendCAU",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,format=TRUE,
         output_slide_png = TRUE, slide_size=16 ,var_list=c("SpaceParentID","TopCAU")
         )



```


### Vendor Customer
```{r Launch}

(
LaunchParentOnly<-build_plot(
  data=launch_plus %>% filter(Fiscal_YQ<2024 & Fiscal_YQ>=2007),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=launch_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  # color_var="SpaceParentID", #color_var
  facet_var="SpaceParentID", #facet_var
  # alpha_var="YTD",
  column_key=launch_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", launch="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 9 Major Launch Providers,\nby Customer FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: The EELV and Russia Space Agency are entirely included, all other vendors are limited to launch product or service codes.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")+
  date_x_year_breaks(2007,2023,3#,partial_year=2024,partial_label="\nQ1")
))


(
LaunchParent<-build_plot(
  data=launch_plus %>% filter(Fiscal_YQ<2024 & Fiscal_YQ>=2007),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=launch_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Customer", #color_var
  facet_var="SpaceParentID", #facet_var
  alpha_var="YTD",
  column_key=launch_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", launch="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Launch Providers,\ FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: The EELV and Russia Space Agency are entirely included, all other vendors are limited to launch product or service codes.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")+
  date_x_year_breaks(2007,2023,3)#,partial_year=2024,partial_label="\nQ1")
)

(LaunchParentVar<-LaunchParent+facet_wrap(~SpaceParentID,scales="free_y")+labs(y="Obligations (Constant 2023 $s) Variable Scale"))


  
log_plot(plot=LaunchParent, df=launch_plus %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="launch_vend_cust",xlsx="Launch_Acq_Trends.xlsx",
                     sheet="VendCust",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,
                     startRow=1,startCol=12,format=TRUE,
         output_slide_png = TRUE, slide_size=16 ,var_list=c("SpaceParentID","Customer")
         )

```


### Vendor Comp
```{r LaunchComp}
levels(factor(space$SpaceParentID))

launch %>% group_by(SpaceParentID) %>% summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))%>% arrange(-Action_Obligation_OMB25_GDP23)

(
LaunchComp<-build_plot(
  data=launch %>% filter(Fiscal_YQ<2024 & Fiscal_YQ>=2007),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=launch_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.sum", #color_var
  facet_var="SpaceParentID", #facet_var
  alpha_var="YTD",
  column_key=launch_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", launch="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Launch Providers,\nby Competition FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: The EELV and Russia Space Agency are entirely included, all other vendors are limited to launch product or service codes.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")+
  date_x_year_breaks(2007,2023,3#,partial_year=2024,partial_label="\nQ1")
))

(LaunchCompVar<-LaunchComp+facet_wrap(~SpaceParentID,scales="free_y")+labs(y="Obligations (Constant 2023 $s) Variable Scale"))


  
log_plot(plot=LaunchCompVar, df=launch %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="launch_vend_comp",xlsx="Launch_Acq_Trends.xlsx",
                     sheet="VendComp",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,
                     startRow=1,startCol=12,format=TRUE,
         output_slide_png = TRUE, slide_size=16 ,var_list=c("SpaceParentID","Competition.sum")
         )

```

### Vendor Pricing
```{r Launch}

(
LaunchPricing<-build_plot(
  data=launch %>% filter(Fiscal_YQ<2024 & Fiscal_YQ>=2007),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=launch_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingUCA", #color_var
  facet_var="SpaceParentID", #facet_var
  alpha_var="YTD",
  column_key=launch_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", launch="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Launch Providers,\nby Contract Pricing FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: The EELV and Russia Space Agency are entirely included, all other vendors are limited to launch product or service codes.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")+
  date_x_year_breaks(2007,2023,3#,partial_year=2024,partial_label="\nQ1")
))

(LaunchPricingVar<-LaunchPricing+facet_wrap(~SpaceParentID,scales="free_y")+labs(y="Obligations (Constant 2023 $s) Variable Scale"))


  
log_plot(plot=LaunchPricingVar, df=launch %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="launch_vend_pricing",xlsx="Launch_Acq_Trends.xlsx",
                     sheet="VendPric",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,format=TRUE,
         output_slide_png = TRUE, slide_size=16 ,var_list=c("SpaceParentID","PricingUCA")
         )

```
### Space Area Pricing
```{r Launch}

(
LaunchPricingArea<-build_plot(
  data=launch %>% filter(Fiscal_YQ<2024 & Fiscal_YQ>=2007),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=launch_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingUCA", #color_var
  facet_var="SpaceArea", #facet_var
  alpha_var="YTD",
  column_key=launch_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", launch="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Launch Providers,\nby Contract Pricing FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: The EELV and Russia Space Agency are entirely included, all other vendors are limited to launch product or service codes.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")+
  date_x_year_breaks(2007,2023,3#,partial_year=2024,partial_label="\nQ1")
))


  
# log_plot(plot=LaunchPricingVar, df=launch %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
#                      filename="launch_vend_pricing",xlsx="Launch_Acq_Trends.xlsx",
#                      sheet="VendPric",path="../output/Space/", height=4.25,width=8,
#          excel_y_var=TRUE,excel_formula=TRUE,format=TRUE,
#          output_slide_png = TRUE, slide_size=16 ,var_list=c("SpaceParentID","PricingUCA")
#          )

```


### Vendor Vehicle
```{r Launch}

(
LaunchVehicle<-build_plot(
  data=launch %>% filter(Fiscal_YQ<2024 & Fiscal_YQ>=2007),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=launch_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Vehicle.sum7", #color_var
  facet_var="SpaceParentID", #facet_var
  alpha_var="YTD",
  column_key=launch_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Launch Providers,\nby Vehicle FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: The EELV and Russia Space Agency are entirely included, all other vendors are limited to launch product or service codes.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")+
  date_x_year_breaks(2007,2023,3#,partial_year=2024,partial_label="\nQ1")
))

(LaunchVehicleVar<-LaunchVehicle+facet_wrap(~SpaceParentID,scales="free_y")+labs(y="Obligations (Constant 2023 $s) Variable Scale"))


  
log_plot(plot=LaunchVehicleVar, df=launch %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="launch_vend_vehicle",xlsx="Launch_Acq_Trends.xlsx",
                     sheet="VendVeh",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,format=TRUE,
         output_slide_png = TRUE, slide_size=16 ,var_list=c("SpaceParentID","Vehicle.sum7")
         )

```
### Vendor Commercial
```{r Launch}
launch$AnyCommercialText<-factor(launch$AnyCommercial)
levels(launch$AnyCommercialText)<-list(
  "Not Classified\nas Commercial"="N",
  "Non-development\nor Commercial Similar"= "NonDev",
  "Any Commercial\nClassification"="Y"
 
)

(
LaunchComm<-build_plot(
  data=launch %>% filter(Fiscal_YQ<2024 & Fiscal_YQ>=2007),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=launch_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="AnyCommercialText", #color_var
  facet_var="SpaceParentID", #facet_var
  alpha_var="YTD",
  column_key=launch_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Launch Providers,\nby Commercial Contracting FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: The EELV and Russia Space Agency are entirely included, all other vendors are limited to launch product or service codes.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")+
  date_x_year_breaks(2007,2023,3#,partial_year=2024,partial_label="\nQ1")
))

(LaunchCommVar<-LaunchComm+facet_wrap(~SpaceParentID,scales="free_y")+labs(y="Obligations (Constant 2023 $s) Variable Scale"))


  
log_plot(plot=LaunchCommVar, df=launch %>% filter(Fiscal_YQ<=2024 & Fiscal_YQ>=2007),
                     filename="launch_vend_commercial",xlsx="Launch_Acq_Trends.xlsx",
                     sheet="VendComm",path="../output/Space/", height=4.25,width=8,
         excel_y_var=TRUE,excel_formula=TRUE,format=TRUE,
         output_slide_png = TRUE, slide_size=16 ,var_list=c("SpaceParentID","AnyCommercialText")
         )

```


### Area Commercial
```{r Launch}
launch$AnyCommercialText<-factor(launch$AnyCommercial)
levels(launch$AnyCommercialText)<-list(
  "Not Classified\nas Commercial"="N",
  "Non-development\nor Commercial Similar"= "NonDev",
  "Any Commercial\nClassification"="Y"
 
)

(
LaunchCommArea<-build_plot(
  data=launch %>% filter(Fiscal_YQ<2024 & Fiscal_YQ>=2007),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=launch_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="AnyCommercialText", #color_var
  facet_var="SpaceArea", #facet_var
  alpha_var="YTD",
  column_key=launch_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",title="Contract Obligations for 10 Major Launch Providers,\nby Commercial Contracting FY 2007-FY 2023",x="Fiscal Year",
       caption="Note: The EELV and Russia Space Agency are entirely included, all other vendors are limited to launch product or service codes.\nNGC completed acquisition of Orbital ATK in June 2018, which is reflected in FY 2019.\nSource: FPDS and CSIS analysis")+
  date_x_year_breaks(2007,2023,3#,partial_year=2024,partial_label="\nQ1")
))



```