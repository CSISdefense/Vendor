---
title: "Defense Acquisition Trends"
output:
  html_document:
    keep_md: yes
    toc: yes
date: "Wednesday, October 6, 2021"
---

# Setup
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from   FPDS.

```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(scales)

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40
if(!exists("full_data"))
  load(file="FPDS_chart_maker//unaggregated_FPDS.Rda")

disa_data<- full_data %>% filter(ContractingSubCustomer=="DISA")
load(file=file.path("..","data","semi_clean","disa.Rda"))

```

## DISA Specific Variables
```{r DISAspecific}

disa_data$PricingUCA.sumlong<-disa_data$PricingUCA.sum
levels(disa_data$PricingUCA.sumlong)<-list("Firm-Fixed-Price"="FFP",
                                           "Less Common"="Less Common",
                                           "Incentive"="Incentive",
                                           "Other Cost-Based"="Other CB",
                                           "Undefinitized\nContract Award"="UCA",
                                           "Unclear"="Unclear"   )



# 
#   
# disa_sum <- deflate(disa_sum,money_var="Action_Obligation_Then_Year",fy_var="Fiscal_Year",deflator_var="OMB20_GDP20")
# colnames(disa_sum)[colnames(disa_sum)=="Action_Obligation_Then_Year_Then_Year"]<-"Action_Obligation_Then_Year"
# colnames(disa_sum)[colnames(disa_sum)=="Action_Obligation_Then_Year_OMB20_GDP20"]<-"Action_Obligation_OMB20_GDP20"


disa_sum$ServicesCategory.sum<-factor(disa_sum$ServicesCategory.detail)
levels(disa_sum$ServicesCategory.sum)<-list("ICT" ="ICT" ,
                                      "PAMS"  ="PAMS"  ,
                                      "Other Services and R&D"=c("Other Services","ERS","FRS&C","Fuels","MED","R&D"),
                                      "Products"="Products",
                                       "Unlabeled"= "Unlabeled")

disa_sum$DISAprodserv.sum<-as.character(disa_sum$ServicesCategory.sum)
disa_sum$DISAprodserv.sum[disa_sum$ProductOrServiceCode =="7030" ]<-"Software as a product"
disa_sum$DISAprodserv.sum[disa_sum$DISAprodserv.sum =="Products" ]<-"Other Products"
disa_sum$DISAprodserv.sum<-factor(disa_sum$DISAprodserv.sum)
levels(disa_sum$DISAprodserv.sum)<-list("Information & Communication\nTechnology Services" ="ICT",
                                      "Professional, Administrative,\nand Managerial Services"  ="PAMS"  ,
                                      "Other Services and R&D"="Other Services and R&D",
                                      "Software as a Product"="Software as a product",
                                      "Other Products"="Other Products",
                                       "Unlabeled"= "Unlabeled")
summary(disa_sum$DISAprodserv.sum)
## DISA Competition

disa_data$ServicesCategory.sum<-factor(disa_data$ServicesCategory.detail)
levels(disa_data$ServicesCategory.sum)<-list("ICT" ="ICT" ,
                                      "PAMS"  ="PAMS"  ,
                                      "Other Services and R&D"=c("Other Services","ERS","FRS&C","Fuels","MED","R&D"),
                                      # ""="R&D",
                                      "Products"="Products",
                                       "Unlabeled"= "Unlabeled")

disa_sum<-disa_sum[,!colnames(disa_sum) %in% c("ContractingSubCustomer")]
colnames(disa_sum)[colnames(disa_sum)=="SubCustomer"]<-"ContractingSubCustomer"
disa_sum$FundingAgency[disa_sum$fundingrequestingagencyid=="955P"]<-"DHS"
disa_sum<-read_and_join_experiment(disa_sum,
                            path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                            "Agency_AgencyID.csv",
                            dir="",
                            by=c("fundingrequestingagencyid"="AgencyID"),
                            add_var=c("SubCustomer"),#Contracting.Agency.ID
                            skip_check_var=c("Platform","SubCustomer"),
                            guess_max=2000)

colnames(disa_sum)[colnames(disa_sum)=="SubCustomer"]<-"SubFunder"
disa_sum<-replace_nas_with_unlabeled(disa_sum,"SubFunder","Uncategorized")
disa_sum<-csis360::read_and_join_experiment(disa_sum,
                                             "SubCustomer.csv",
                                             by=c("FundingAgency"="Customer","SubFunder"="SubCustomer"),
                                             add_var=c("SubCustomer.platform","SubCustomer.sum"),
                                             path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                                            # path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\",
                                             dir="office/",
                                            case_sensitive = FALSE
)
disa_sum<-disa_sum[,!colnames(disa_sum) %in% c("FundingSubAgency.platform","FundingSubAgency.sum")]
colnames(disa_sum)[colnames(disa_sum)=="SubCustomer.platform"]<-"FundingSubAgency.platform"
colnames(disa_sum)[colnames(disa_sum)=="SubCustomer.sum"]<-"FundingSubAgency.sum"

summary(factor(disa_sum$FundingSubAgency.sum))
disa_sum$Funder<-disa_sum$FundingAgency

disa_sum$Funder[disa_sum$FundingAgency =="Defense" & !is.na(disa_sum$FundingAgency)& !is.na(disa_sum$FundingSubAgency.sum)]<-
  disa_sum$FundingSubAgency.sum[disa_sum$FundingAgency =="Defense" & !is.na(disa_sum$FundingAgency) & !is.na(disa_sum$FundingSubAgency.sum)]
disa_sum$Funder[disa_sum$FundingAgency!= "Defense"]<-"Other than DoD"
disa_sum$Funder[disa_sum$FundingSubAgency=="DISA"]<-"DISA"
disa_sum$FunderDISA<-ifelse(disa_sum$FundingSubAgency=="DISA","DISA","Other than DISA")
disa_sum %>% group_by(FundingAgency ) %>% summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20,na.rm=TRUE))
disa_sum %>% group_by(Funder ) %>% summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20,na.rm=TRUE))


disa_sum$Office<-factor(disa_sum$ContractingOfficeID)
levels(disa_sum$Office)<-list("Telecomm Div.\n(HC1013)"="HC1013",
                              "IT Contracting PL83\n(HC1028)"="HC1028" ,
                              "IT Contracting PL84\n(HC1084)"="HC1084" ,
                              "DITCO-PAC\n(HC1019)"="HC1019" ,
                              "DITCO-Europe\n(HC1021)"="HC1021",
                              "DITCO-Alaska\n(HC1022)"="HC1022",
                              "DISA-Ft. Meade\n(HC1046)"="HC1046", 
                              "DISA-Ft. Meade\n(HC1047)"="HC1047", 
                              "J7 White House Comm\n(HC1064)"="HC1064",                              
                              "ZD10"=c("ZD10"   ,"ZD10 "),
                              "ZD11"=c("ZD11"   ,"ZD11 "),
                              "ZD13"=c("ZD13"="ZD13 "),
                              "ZD14"=c("ZD14"="ZD14 "),
                              "ZD15"=c("ZD15"="ZD15 "))
disa_sum$OfficeLoc<-factor(disa_sum$ContractingOfficeID)
levels(disa_sum$OfficeLoc)<-list("Scott AFB"=c("HC1013","HC1028","HC1084"),
                                "Fort Meade"=c("HC1046","HC1047"),
                              "Pearl Harbor"="HC1019" ,
                              "Europe"="HC1021",
                              "Alaska"="HC1022",
                              "Washington, DC"="HC1064",
                              "ZD10"=c("ZD10"   ,"ZD10 "),
                              "ZD11"=c("ZD11"   ,"ZD11 "),
                              "ZD13"=c("ZD13"="ZD13 "),
                              "ZD14"=c("ZD14"="ZD14 "),
                              "ZD15"=c("ZD15"="ZD15 "))
disa_sum$OfficeScott<-factor(disa_sum$ContractingOfficeID)
levels(disa_sum$OfficeScott)<-list("Scott AFB"=c("HC1013","HC1028","HC1084"),
                                "All Other"=c("HC1046","HC1047","HC1019" ,"HC1021","HC1022","HC1064"),
                              "ZD10"=c("ZD10"   ,"ZD10 "),
                              "ZD11"=c("ZD11"   ,"ZD11 "),
                              "ZD13"=c("ZD13"="ZD13 "),
                              "ZD14"=c("ZD14"="ZD14 "),
                              "ZD15"=c("ZD15"="ZD15 "))

disa_sum$OfficeSum<-factor(disa_sum$ContractingOfficeID)
levels(disa_sum$OfficeSum)<-list("Telecomm Div."="HC1013",
                              "IT Contracting PL83"="HC1028" ,
                              "IT Contracting PL84"="HC1084" ,
                              "DITCO OCONUS"=c("HC1019" ,"HC1021","HC1022"),
                                "DISA Fort Meade"=c("HC1046","HC1047"),
                              "J7 White House Comm."="HC1064",
                              "ZD10"=c("ZD10"   ,"ZD10 "),
                              "ZD11"=c("ZD11"   ,"ZD11 "),
                              "ZD13"=c("ZD13"="ZD13 "),
                              "ZD14"=c("ZD14"="ZD14 "),
                              "ZD15"=c("ZD15"="ZD15 "))


```
## Labels, Colors, and Column Key
```{r lc}
colnames(disa_data)[colnames(disa_data)=="ProductServiceOrRnDarea.sum"]<-"SimpleArea"
disa_data$SimpleArea<-factor(disa_data$SimpleArea)
# ds_lc<-prepare_labels_and_colors(disa_sum,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
# ds_ck<-csis360::get_column_key(disa_sum,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
# ds_lc<-prepare_labels_and_colors(disa_sum,path="C:\\Users\\gsand\\Repositories\\Lookup-Tables\\style\\")
# ds_ck<-csis360::get_column_key(disa_sum,path="C:\\Users\\gsand\\Repositories\\Lookup-Tables\\style\\")
# ds_lc<-prepare_labels_and_colors(disa_sum,path="F:\\Users\\gsanders\\Documents\\Repositories\\Lookup-Tables\\style\\")
# ds_ck<-csis360::get_column_key(disa_sum,path="F:\\Users\\gsanders\\Documents\\Repositories\\Lookup-Tables\\style\\")
# labels_and_colors<-prepare_labels_and_colors(disa_data,path="C:\\Users\\gsand\\Repositories\\Lookup-Tables\\style\\")
# column_key<-get_column_key(disa_data,path="C:\\Users\\gsand\\Repositories\\Lookup-Tables\\style\\")
labels_and_colors<-prepare_labels_and_colors(disa_data,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
column_key<-get_column_key(disa_data,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")

labels_and_colors<-prepare_labels_and_colors(disa_data)
column_key<-get_column_key(disa_data)

ds_lc<-prepare_labels_and_colors(disa_sum)
ds_ck<-csis360::get_column_key(disa_sum)

```

# DISA Topline
## DISA Competition
```{r DISAComp}

# classify competition
disa_sum<-csis360::read_and_join(disa_sum,
  "Lookup_SQL_CompetitionClassification.csv",
  by=c("CompetitionClassification","ClassifyNumberOfOffers"),
  replace_na_var="ClassifyNumberOfOffers",
  add_var=c("Competition.sum",
    "Competition.multisum",
    "Competition.effective.only",
    "No.Competition.sum"),
  path="https://raw.githubusercontent.com/CSISdefense/R-scripts-and-data/master/",
  dir="Lookups/"
)


(
DISAComp<-build_plot(
  data=disa_data,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Competition.sum", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//DISA_comp.png", DISAComp,  
             width=13, height= 6, units="in",size=16, lineheight=1.2
             )



write.csv(file="..//Output//DISA_competition.csv",row.names = FALSE,
          # DISAComp$data%>% mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(DISAComp$data,id_cols=c(Competition.sum),
                        names_from=dFYear,values_from=Action_Obligation_OMB20_GDP20))



```


## DISA Vendor Size
```{r DISAVendor}

(
DISAVendor<-build_plot(
  data=disa_data,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//DISA_vendor.png", DISAVendor, 
             width=6.5, height= 4, units="in",size=11
             )


write.csv(file="..//Output//DISA_vendorsize.csv",row.names = FALSE,
          # DISAComp$data%>% mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(DISAVendor$data,id_cols=c(Shiny.VendorSize),
                        names_from=dFYear,values_from=Action_Obligation_OMB20_GDP20))


```
## DISA Vehicle
```{r DISAVehicle}

(
DISAVehiclePSR<-build_plot(
  data=disa_sum%>% filter(!is.na(Vehicle.AwardTask)),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="DISAprodserv.sum", #color_var
  facet_var="Vehicle.sum7", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

disa_sum$Vehicle.sum7<-factor(disa_sum$Vehicle.sum7)

(
DISAVehicle<-build_plot(
  data=disa_data %>% filter(!is.na(Vehicle.AwardTask)),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Vehicle.sum7", #color_var
  facet_var="Vehicle.AwardTask", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)",
       caption="Note: Unlabeled not shown. Source: FPDS; CSIS analysis.")
)

summary(disa_data$Vehicle)


write.csv(file="..//Output//DISA_vehicle.csv",row.names = FALSE,
          arrange(pivot_wider(DISAVehicle$data %>% 
                        arrange(dFYear) %>% mutate(Fiscal_Year=lubridate::year(dFYear)),
                      id_cols=c(Vehicle.AwardTask,Vehicle.sum7),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20),Vehicle.sum7))

ggsave600dpi("..//Output//DISA_vehicle.png", DISAVehicle, 
             width=13, height= 6, units="in",size=16
             )
ggsave600dpi("..//Output//DISA_vehicle_paper.png", DISAVehicle, 
             width=13, height= 4.25, units="in",size=16
             )
ggsave600dpi("..//Output//DISA_vehicle_paper.eps", DISAVehicle, 
             width=13, height= 4.25, units="in",size=16
             )

write.csv(file="..//Output//DISA_Vehicle.csv",row.names = FALSE,
          DISAVehicle$data%>% mutate(Fiscal_Year=lubridate::year(dFYear),
                                bAction_Obligation_OMB20_GDP20=Action_Obligation_OMB20_GDP20/1000000000)%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(Vehicle.AwardTask,Vehicle.sum7),
                      names_from=Fiscal_Year,values_from=bAction_Obligation_OMB20_GDP20)%>%
            arrange(Vehicle.AwardTask,Vehicle.sum7),na="")

```


## DISA Pricing
```{r DISAPricing}

(
DISAPricing<-build_plot(
  data=disa_data,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="PricingUCA", #color_var
  facet_var="PricingUCA.sumlong", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

# ggsave600dpi("..//Output//DISA_pricing.png", DISAPricing, 
#              width=6.5, height= 4, units="in",size=11
#              )


ggsave600dpi("..//Output//DISA_pricing.png", DISAPricing,  
             width=13, height= 6, units="in",size=16, lineheight=1.2
             )
write.csv(file="..//Output//DISA_pricing.csv",row.names = FALSE,
          DISAPricing$data%>% mutate(dFYear=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PricingUCA,PricingUCA.sumlong),
                        names_from=dFYear,values_from=Action_Obligation_OMB20_GDP20))

write.csv(file="..//Output//DISA_pricing.csv",row.names = FALSE,
          arrange(pivot_wider(DISAPricing$data %>% 
                        arrange(dFYear) %>% mutate(Fiscal_Year=lubridate::year(dFYear)),
                      id_cols=c(PricingUCA,PricingUCA.sumlong),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20),PricingUCA.sumlong))


```

## DISA Info Tech Commercial
```{r DISAcomm}

(
DISAcomm<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2002),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Commercial", #color_var
  # facet_var="Commercial", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

(
DISAcommLine<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2002),
  chart_geom = "Line Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Commercial", #color_var
  # facet_var="Commercial", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)


(
DISAcommDetail<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2002),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="informationtechnologycommercialitemcategoryText", #color_var
  facet_var="Commercial", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

(
DISAcommIT<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2002),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="informationtechnologycommercialitemcategoryText", #color_var
  facet_var="ITcategory", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)


(
DISAcommPSR<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2002),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="informationtechnologycommercialitemcategoryText", #color_var
  facet_var="SimpleArea", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)


# ggsave600dpi("..//Output//DISA_pricing.png", DISAcomm, 
#              width=6.5, height= 4, units="in",size=11
#              )


ggsave600dpi("..//Output//DISA_comm.png", DISAcomm,  
             width=13, height= 6, units="in",size=16, lineheight=1.2
             )

ggsave600dpi("..//Output//DISA_comm_paper.png", DISAcomm,  
             width=13, height= 3.75, units="in",size=16, lineheight=1.2
             )
ggsave600dpi("..//Output//DISA_comm_paper.eps", DISAcomm,  
             width=13, height= 3.75, units="in",size=16, lineheight=1.2
             )


write.csv(file="..//Output//DISA_comm.csv",row.names = FALSE,
          DISAcomm$data%>% mutate(Fiscal_Year=lubridate::year(dFYear),
                                bAction_Obligation_OMB20_GDP20=Action_Obligation_OMB20_GDP20/1000000000)%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(Commercial),
                      names_from=Fiscal_Year,values_from=bAction_Obligation_OMB20_GDP20)%>%
            arrange(Commercial),na="")

```

## DISA Funder   
```{r Funder}
summary(factor(disa_sum$fundingrequestingagencyid))
disa_sum %>% group_by(Fiscal_Year,Funder,FundingAgency) %>% filter(Funder=="Other than DoD") %>% summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20))


disa_sum %>% group_by(Fiscal_Year,Funder,FundingAgency,SubFunder,fundingrequestingagencyid) %>% filter(Funder=="Other than DoD") %>% summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20))


disa_sum %>% group_by(Fiscal_Year,Funder,FundingAgency,SubFunder,fundingrequestingagencyid) %>% filter(Funder=="Other than DoD") %>% summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20))
(
Funder<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2000),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Funder", #color_var
  facet_var="Funder", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//DISA_Funder.png", Funder, 
             width=13, height= 6, units="in",size=16,lineheight = 1.2
             )
ggsave600dpi("..//Output//DISA_Funder.eps", Funder, 
             width=13, height= 6, units="in",size=16,lineheight = 1.2
             )


write.csv(file="..//Output//DISA_Funder.csv",row.names = FALSE,
          Funder$data%>% mutate(Fiscal_Year=lubridate::year(dFYear),
                                bAction_Obligation_OMB20_GDP20=Action_Obligation_OMB20_GDP20/1000000000)%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(Funder),
                      names_from=Fiscal_Year,values_from=bAction_Obligation_OMB20_GDP20)%>%
            arrange(Funder),na="")


write.csv(file="..//Output//DISA_Funder_current.csv",row.names = FALSE,
          disa_sum %>% group_by(Funder,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(Funder),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))


```
## DISA ICT Funder   
```{r Funder_DISA_ICT}

(
ICT_Funder<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2000 & ServicesCategory.detail=="ICT"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Funder", #color_var
  facet_var="Funder", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)

# ggsave600dpi("..//Output//DISA_Funder.png", Funder, 
#              width=13, height= 6, units="in",size=16,lineheight = 1.2
#              )
# 
# write.csv(file="..//Output//DISA_Funder.csv",row.names = FALSE,
#           pivot_wider(Funder$data,id_cols=c(Funder.sum,Funder.platform),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20))
# 
# write.csv(file="..//Output//DISA_Funder_current.csv",row.names = FALSE,
#           disa_sum %>% group_by(Funder,Fiscal_Year)%>%
#             dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE)/1000000000)%>%
#           pivot_wider(id_cols=c(Funder),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(disa_data$ContractingFunder)
```
## ICT
```{r ICTfunder}
summary(factor(full_data$ServicesCategory.detail))


ICT_data<-format_data_for_plot(full_data  %>% filter(Fiscal_Year>=2000 & ServicesCategory.detail=="ICT"),
                                 fy_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="ContractingSubCustomer", #color_var
  facet_var="ContractingSubCustomer") #facet_var)


levels(ICT_data$ContractingSubCustomer)<-list(
  "Army"="Army",
  "Navy"="Navy",
   "Air Force"="Air Force",
  "DISA"="DISA",
  "Other DoD"=c("DLA","MDA","MilitaryHealth","Other DoD"),
  "Uncategorized"=  "Uncategorized" 
)
ICT_data$Funder<-ICT_data$ContractingSubCustomer
ICT_data%>% filter(ContractingSubCustomer!="DISA")
disa_sum$ContractingSubCustomer<-"DISA"
ICT_data<-rbind(ICT_data,format_data_for_plot(disa_sum  %>% filter(Fiscal_Year>=2000 & ServicesCategory.detail=="ICT"),
                                 fy_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="ContractingSubCustomer", #color_var
  facet_var="Funder")) #facet_var)

# ICT_lc<-prepare_labels_and_colors(ICT_data,path="C:\\Users\\gsand\\Repositories\\Lookup-Tables\\style\\")
ICT_lc<-prepare_labels_and_colors(ICT_data)



            
(
ICT<-build_plot(
  data=ICT_data %>% filter(Funder!="Uncategorized"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ICT_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="ContractingSubCustomer", #color_var
  facet_var="Funder", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)



ggsave600dpi("..//Output//ICT_disa.png", ICT, 
             width=13, height= 6, units="in",size=16,lineheight = 1.2
             )
# 
# write.csv(file="..//Output//DISA_Funder.csv",row.names = FALSE,
#           pivot_wider(Funder$data,id_cols=c(Funder.sum,Funder.platform),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20))
# 
# write.csv(file="..//Output//DISA_Funder_current.csv",row.names = FALSE,
#           disa_data %>% group_by(Funder.sum,ContractingFunder,Fiscal_Year)%>%
#             dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
#           pivot_wider(id_cols=c(Funder.sum,ContractingFunder),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(disa_data$ContractingFunder)
```


## ICT Funder prior
```{r ICTfunderPrior}
full_ICT<- read_delim(
  "..//data//semi_clean//EC_ICT_ProdservAgency.txt",delim = "\t",
  col_names = TRUE, guess_max = 500000,na=c("NA","NULL"))

full_ICT<-standardize_variable_names(full_ICT)
colnames(full_ICT)[colnames(full_ICT)=="Fiscal.Year"]<-"Fiscal_Year"
full_ICT<-deflate(full_ICT,
                   money_var = "Action_Obligation",
                   fy_var="Fiscal_Year",
                   deflator_var="OMB20_GDP20"
)
full_ICT$dFYear<-as.Date(paste("1/1/",as.character(full_ICT$Fiscal_Year),sep=""),"%m/%d/%Y")



# ICT_lc<-prepare_labels_and_colors(full_ICT,path="C:\\Users\\gsand\\Repositories\\Lookup-Tables\\style\\")

View(full_ICT%>% filter(ContractingCustomer=='Defense' & (is.na(Funder)|is.na(fundingagency)|full_ICT$fundingagency=="Unlabeled")))
# full_ICT$fundingagency[is.na(full_ICT$fundingagency)& full_ICT$fundingrequestingagencyid==""]<-
#   full_ICT$ContractingCustomer[is.na(full_ICT$fundingagency)& full_ICT$fundingrequestingagencyid==""]
# full_ICT$fundingsubagency[is.na(full_ICT$fundingsubagency)& full_ICT$fundingrequestingagencyid=="" &
#                             !is.na(full_ICT$fundingrequestingagencyid)]<-
#   full_ICT$SubCustomer[is.na(full_ICT$fundingsubagency)& full_ICT$fundingrequestingagencyid==""&
#                             !is.na(full_ICT$fundingrequestingagencyid)]
# 
# 
# full_ICT<-read_and_join_experiment(full_ICT,
#                             path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
#                             "Agency_AgencyID.csv",
#                             dir="",
#                             by=c("Contracting.Agency.ID"="AgencyID"),
#                             add_var=c("SubCustomer"),#Contracting.Agency.ID
#                             skip_check_var=c("Platform","SubCustomer"),
#                             guess_max=2000)
# 
# full_ICT$fundingagency[full_ICT$fundingrequestingagencyid %in% c('7055','7058')]<-"DHS"
# 
#   
# full_ICT$Funder<-full_ICT$fundingagency
# full_ICT$Funder[full_ICT$Funder!='Defense']<-"DoD Implemented\nOther Funder"
# full_ICT$Funder[full_ICT$Funder=='Defense'&!is.na(full_ICT$Funder)]<-
#   full_ICT$fundingsubagency[full_ICT$Funder=='Defense'&!is.na(full_ICT$Funder)]
# full_ICT$Funder[full_ICT$fundingrequestingagencyid %in% c('9700')]<-"Other DoD"
# 
# full_ICT$Funder<-factor(full_ICT$Funder)
# levels(full_ICT$Funder)<-list(
#   "Army"="Army",
#   "Navy"="Navy",
#    "Air Force"="Air Force",
#   "DISA"="DISA",
#   "Other DoD"=c("DLA","MDA","MilitaryHealth","Other DoD"),
#   "DoD Implemented\nOther Funder"=c("DoD Implemented\nOther Funder","Other than DoD"),
#   "Uncategorized"=  "Uncategorized" 
# )
# 
# full_ICT$Agency<-full_ICT$ContractingCustomer
# full_ICT$Agency[!full_ICT$Agency %in% c('Defense','GSA')]<-"Other Agencies"
# full_ICT$Agency[full_ICT$Agency=="Defense"]<-full_ICT$SubCustomer[full_ICT$Agency=="Defense"]
# full_ICT$Agency<-factor(full_ICT$Agency)
# levels(full_ICT$Agency)<-list(
#   "Self-Administered"="Self-Administered",
#   "Army"="Army",
#   "Navy"="Navy",
#    "Air Force"="Air Force",
#   "DISA"="DISA",
#   "Other DoD"=c("DLA","MDA","MilitaryHealth","Other DoD"),
#   "GSA"="GSA",
#   "Other Agencies"="Other Agencies",
#   "Uncategorized"=  "Uncategorized" 
# )
# 
# full_ICT$Agency[as.character(full_ICT$Agency)==as.character(full_ICT$Funder)]<-"Self-Administered"
# 
# full_ICT %>% filter(Fiscal_Year>=2000 & ProductServiceOrRnDarea=="ICT" & 
#                             (   ContractingCustomer=='Defense' | fundingagency=='Defense') &
#                              !is.na(Funder)) %>% group_by(SubCustomer)%>%
#   filter(ContractingCustomer=="Other Agencies") %>%
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20))
# 
# ICT_lc<-prepare_labels_and_colors(full_ICT,path="F:\\Users\\gsanders\\Documents\\Repositories\\Lookup-Tables\\style\\")
# 
# 
# (
# ICTfunder<-build_plot(
#   data=full_ICT %>% filter(Fiscal_Year>=2000 & ProductServiceOrRnDarea=="ICT" & 
#                             (   ContractingCustomer=='Defense' | fundingagency=='Defense') &
#                              !is.na(Funder)),
#   chart_geom = "Bar Chart",
#   share = FALSE,
#   labels_and_colors=ICT_lc,
#   # NA, #VAR.ncol
#   x_var="dFYear", #x_var
#   y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
#   color_var="Agency", #color_var
#   facet_var="Funder", #facet_var
#   column_key=ds_ck,
#   format=TRUE,
#   ytextposition=FALSE
#   
# )+ theme(legend.title = element_text("Contracting\nAgency"))+
#   # theme(strip.text.y = element_text(angle=0))+
#  # theme(axis.text.x = element_text(angle=90))+
#  #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
#  #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
#  #             )+labs(title=NULL,
#   # x="Fiscal Year",
#   # y="Percent of Obligations",
#   # color="Competition")+
#   theme(legend.position = "right")+
#   labs(y="Funded ICT Service Obligations (Constant 2020 $s)",fill="Contracting\nAgency")
# )
# 
# 
# 
# ggsave600dpi("..//Output//ICT_funder.png", ICTfunder, 
#              width=13, height= 6, units="in",size=16,lineheight = 1.2
#              )
# 
# write.csv(file="..//Output//DISA_Funder.csv",row.names = FALSE,
#           pivot_wider(Funder$data,id_cols=c(Funder.sum,Funder.platform),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20))
# 
# write.csv(file="..//Output//DISA_Funder_current.csv",row.names = FALSE,
#           disa_data %>% group_by(Funder.sum,ContractingFunder,Fiscal_Year)%>%
#             dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
#           pivot_wider(id_cols=c(Funder.sum,ContractingFunder),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))
# 
# summary(disa_data$ContractingFunder)
```

#Product/Service/R&D

## DISA Product/Service/R&D
```{r DISAPSR}


(
DISAPSR<-build_plot(
  data=disa_data,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="SimpleArea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

labels_and_colors<-prepare_labels_and_colors(disa_data)

(
DISAPSR<-build_plot(
  data=disa_data,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="ServicesCategory.sum", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)


ggsave600dpi("..//Output//DISA_psr.png", DISAPSR, 
             width=13, height= 6, units="in",size=16, lineheight=1.2
             )

write.csv(file="..//Output//DISA_psr.csv",row.names = FALSE,
          disa_data %>% group_by(SimpleArea,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(SimpleArea),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

```
## DISA Product/Service/R&D Services
```{r DISAPSRdetail}

(
DISAPSRdetail<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2000),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="DISAprodserv.sum", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)


ggsave600dpi("..//Output//DISA_psr_detail.png", DISAPSRdetail, 
             width=13, height= 6, units="in",size=16, lineheight=1.2
             )
ggsave600dpi("..//Output//DISA_psr_detail.eps", DISAPSRdetail, 
             width=13, height= 6, units="in",size=16, lineheight=1.2
             )


write.csv(file="..//Output//DISA_DISAPSRdetail.csv",row.names = FALSE,
          arrange(pivot_wider(DISAPSRdetail$data %>% 
                        arrange(dFYear) %>% mutate(Fiscal_Year=lubridate::year(dFYear)),
                      id_cols=c(DISAprodserv.sum),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20),DISAprodserv.sum))



# write.csv(file="..//Output//DISA_psr_detail_current.csv",row.names = FALSE,
#           disa_data %>% group_by(SimpleArea,Fiscal_Year)%>%
#             dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
#           pivot_wider(id_cols=c(SimpleArea),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

```

## R&D phase
```{r RnDphase}

(
RnDphase<-build_plot(
  data=disa_data %>% filter(SimpleArea=="R&D"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="ProductServiceOrRnDarea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

# ggsave600dpi("..//Output//DISA_psr_RnDPhase.png", RnDphase, 
#              width=13, height= 6, units="in",size=16, lineheight=1.2
#              )
                           

# write.csv(file="..//Output//DISA_psr_RnDPhase.csv",row.names = FALSE,
#           pivot_wider(RnDphase$data,id_cols=c(ProductServiceOrRnDarea),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20)%>%
#             arrange(ProductServiceOrRnDarea))
            

# write.csv(file="..//Output//DISA_psr_RnDPhase_current.csv",row.names = FALSE,
#           disa_data %>% filter(SimpleArea=="R&D") %>%
#             format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "ProductServiceOrRnDarea",
#                                  labels_and_colors=labels_and_colors) %>%
#           pivot_wider(id_cols=c(ProductServiceOrRnDarea),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
#             arrange(ProductServiceOrRnDarea))

```
## Services
```{r Services}

(
Services<-build_plot(
  data=disa_data %>% filter(SimpleArea=="Services (Non-R&D)"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="ProductServiceOrRnDarea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

# ggsave600dpi("..//Output//DISA_psr_Services.png", Services, 
#              width=13, height= 6, units="in",size=16, lineheight=1.2
#              )
                           

# write.csv(file="..//Output//DISA_psr_Services.csv",row.names = FALSE,
#           pivot_wider(Services$data,id_cols=c(ProductServiceOrRnDarea),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20)%>%
#             arrange(ProductServiceOrRnDarea))
#             

# write.csv(file="..//Output//DISA_psr_Services_current.csv",row.names = FALSE,
#           disa_data %>% filter(SimpleArea=="R&D") %>%
#             format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "ProductServiceOrRnDarea",
#                                  labels_and_colors=labels_and_colors) %>%
#           pivot_wider(id_cols=c(ProductServiceOrRnDarea),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
#             arrange(ProductServiceOrRnDarea))

```

## Products
```{r Products}

(
Products<-build_plot(
  data=disa_data %>% filter(SimpleArea=="Products (All)"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="ProductServiceOrRnDarea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

# ggsave600dpi("..//Output//DISA_psr_Products.png", Products, 
#              width=13, height= 6, units="in",size=16, lineheight=1.2
#              )
                           

# write.csv(file="..//Output//DISA_psr_Products.csv",row.names = FALSE,
#           pivot_wider(Products$data,id_cols=c(ProductServiceOrRnDarea),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20)%>%
#             arrange(ProductServiceOrRnDarea))
#             

# write.csv(file="..//Output//DISA_psr_Products_current.csv",row.names = FALSE,
#           disa_data %>% filter(SimpleArea=="R&D") %>%
#             format_data_for_plot(fy_var="Fiscal_Year",y_var="Action_Obligation_Then_Year",color_var = "ProductServiceOrRnDarea",
#                                  labels_and_colors=labels_and_colors) %>%
#           pivot_wider(id_cols=c(ProductServiceOrRnDarea),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year)%>%
#             arrange(ProductServiceOrRnDarea))

```
## DISA Product/Service/R&D Services Prior
```{r DISAPSRdetailPrior}

# (
# DISAPSRdetail<-build_plot(
#   data=disa_data,
#   chart_geom = "Bar Chart",
#   share = TRUE,
#   # labels_and_colors=labels_and_colors,
#   # NA, #VAR.ncol
#   x_var="Fiscal_Year", #x_var
#   y_var="obligatedAmount_OMB19_19", #VAR.y.variable
#   color_var="Office", #color_var
#   facet_var="Funder", #facet_var
#   column_key=column_key,
#   format=FALSE,
#   ytextposition=FALSE
# )+
#   # theme(strip.text.y = element_text(angle=0))+
#  # theme(axis.text.x = element_text(angle=90))+
#  #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
#  #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
#  #             )+labs(title=NULL,
#   # x="Fiscal Year",
#   # y="Percent of Obligations",
#   # color="Competition")+
#   theme(legend.position = "right")+
#   labs(y="Obligations (Constant 2020 $s)")
# )
# 
# 
# ggsave600dpi("..//Output//OfficePricing.png", OfficePricing, 
#              width=12, height= 6, units="in",size=11,lineheight = 1.2
#              )
# 
# # write.csv(file="..//Output//DISA_OfficePricing.csv",row.names = FALSE,
# #           pivot_wider(OfficePricing$data,id_cols=c(Office.sum,Office.platform),
# #                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20))
# 
# write.csv(file="..//Output//DISA_OfficePricing_current.csv",row.names = FALSE,
#           disa_sum %>% group_by(Office.sum,ContractingOffice,Fiscal_Year)%>%
#             dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
#           pivot_wider(id_cols=c(Office.sum,ContractingOffice),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))
# 
# summary(disa_sum$ContractingOffice)
```


# Product or Service Detail 
## Top 7 ProdServ
```{r ProdServTop7}

prodserv<-disa_sum %>% filter(Fiscal_Year>=2002) %>% group_by(ProductOrServiceCode,ProductOrServiceCodeText,ProductServiceOrRnDarea,SimpleArea)%>%
  summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20,na.rm=TRUE))


write.csv(prodserv,"..\\output\\DISA_prodserv.csv",row.names = FALSE)
# write.csv(prodservcomm,"..\\output\\DISA_prodservComm.csv",row.names = FALSE)

prodservcomm<-disa_sum %>% filter(Fiscal_Year>=2002) %>% group_by(ProductOrServiceCode,ProductOrServiceCodeText,ProductServiceOrRnDarea,SimpleArea,Commercial)%>%
  summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20,na.rm=TRUE)) %>%pivot_wider(names_from = Commercial, values_from=Action_Obligation_OMB20_GDP20)

prodserv$rank<-rank(prodserv$Action_Obligation_OMB20_GDP20*-1)

disa_sum$prodserv_detail<-as.character(disa_sum$ServicesCategory.sum)
disa_sum$prodserv_detail[disa_sum$ProductOrServiceCode %in% prodserv$ProductOrServiceCode[prodserv$rank<=7]]<-
  disa_sum$ProductOrServiceCodeText[disa_sum$ProductOrServiceCode %in% prodserv$ProductOrServiceCode[prodserv$rank<=7]]
  

(
DISAProdServdetail<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2002),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Commercial", #color_var
  facet_var="prodserv_detail", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)



```
## NAICS
```{r NAICS}


disa_psc_naics<-disa_sum %>% filter(Fiscal_Year>=2005) %>% group_by(ProductOrServiceCode,ProductOrServiceCodeText,principalnaicscode,NAICS_ShortHand,ContractingOfficeID,ContractingOfficeName) %>%
  summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20))
disa_psc_naics <-  disa_psc_naics %>% group_by(ContractingOfficeID) %>%
  mutate(crank=order(order(Action_Obligation_OMB20_GDP20,decreasing = TRUE)),
         cshare=Action_Obligation_OMB20_GDP20/sum(Action_Obligation_OMB20_GDP20))

disa_psc_naics<-disa_psc_naics[order(disa_psc_naics$ContractingOfficeID,desc(disa_psc_naics$Action_Obligation_OMB20_GDP20)),]
disa_psc_naics$NAICS_ShortHand[disa_psc_naics$NAICS_ShortHand=="" & disa_psc_naics$principalnaicscode=="541519"]<-"Other Computer Related Services"
disa_psc_naics$NAICS_ShortHand[disa_psc_naics$NAICS_ShortHand=="" & disa_psc_naics$principalnaicscode=="517410"]<-"Satellite Telecommunications"
disa_psc_naics$NAICS_ShortHand[disa_psc_naics$NAICS_ShortHand=="" & disa_psc_naics$principalnaicscode=="517110"]<-"Wired Telecommunications Carriers"
disa_psc_naics$NAICS_ShortHand[disa_psc_naics$NAICS_ShortHand=="" & disa_psc_naics$principalnaicscode=="511210"]<-"Software Publishers"
disa_psc_naics$NAICS_ShortHand[disa_psc_naics$NAICS_ShortHand=="" & disa_psc_naics$principalnaicscode=="541512"]<-"Computer Systems Design Services "


View(disa_psc_naics %>% filter(crank<=5))
disa_psc_naics %>% filter(crank<=5) %>% group_by(ContractingOfficeID) %>%
  dplyr::summarise(cshare=sum(cshare),
                   Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20))


# naics<-disa_sum %>% filter(Fiscal_Year>=2002) %>% group_by(principalnaicscode,principalnaicscodeText,NAICS_ShortHand)%>%
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20,na.rm=TRUE))
# 
# write.csv(naics,"..\\output\\DISA_NAICS.csv",row.names = FALSE)
# 
# naicsD399<-disa_sum %>% filter(Fiscal_Year>=2002&ProductOrServiceCode=='D399') %>% group_by(principalnaicscode,principalnaicscodeText,NAICS_ShortHand)%>%
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20,na.rm=TRUE))
# write.csv(naicsD399,"..\\output\\DISA_NAICSD399.csv",row.names = FALSE)
# 
# prodservcomm<-disa_sum %>% filter(Fiscal_Year>=2002) %>% group_by(ProductOrServiceCode,ProductOrServiceCodeText,ProductServiceOrRnDarea,SimpleArea,Commercial)%>%
#   summarise(Action_Obligation_OMB20_GDP20=sum(Action_Obligation_OMB20_GDP20,na.rm=TRUE)) %>%pivot_wider(names_from = Commercial, values_from=Action_Obligation_OMB20_GDP20)
# 
# naics$rank<-rank(naics$Action_Obligation_OMB20_GDP20*-1)
# 
# disa_sum$prodserv_detail<-
# disa_sum$prodserv_detail[disa_sum$ProductOrServiceCode %in% prodserv$ProductOrServiceCode[prodserv$rank<=7]]<-
#   disa_sum$ProductOrServiceCodeText[disa_sum$ProductOrServiceCode %in% prodserv$ProductOrServiceCode[prodserv$rank<=7]]
#   
# 
# (
# DISAProdServdetail<-build_plot(
#   data=disa_sum %>% filter(Fiscal_Year>=2002),
#   chart_geom = "Bar Chart",
#   share = FALSE,
#   labels_and_colors=ds_lc,
#   # NA, #VAR.ncol
#   x_var="dFYear", #x_var
#   y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
#   color_var="Commercial", #color_var
#   facet_var="prodserv_detail", #facet_var
#   column_key=ds_ck,
#   format=TRUE,
#   ytextposition=FALSE
# )+
#   # theme(strip.text.y = element_text(angle=0))+
#  # theme(axis.text.x = element_text(angle=90))+
#  #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
#  #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
#  #             )+labs(title=NULL,
#   # x="Fiscal Year",
#   # y="Percent of Obligations",
#   # color="Competition")+
#   theme(legend.position = "right")+
#   labs(y="Obligations (Constant 2020 $s)")
# )
# 
# 
# 
# write.csv(prodserv,"..\\output\\DISA_prodserv.csv",row.names = FALSE)
# write.csv(prodservcomm,"..\\output\\DISA_prodservComm.csv",row.names = FALSE)
```

## Hand created
```{r ProdServ}


disa_sum$DISAprodserv<-as.character(disa_sum$ServicesCategory.sum)
disa_sum$DISAprodserv[substr(disa_sum$ProductOrServiceCode,1,1)=="D" ]<-"Other IT and Telecomm"
# disa_sum$DISAprodserv[disa_sum$ProductOrServiceCode =="D304" ]<-"Telecomm & Transmission"
disa_sum$DISAprodserv[disa_sum$ProductOrServiceCode =="D316" ]<-"Telecomm Network Mgmt."
disa_sum$DISAprodserv[disa_sum$ProductOrServiceCode =="D319" ]<-"Annual oftreoftware Maint."
disa_sum$DISAprodserv[disa_sum$ProductOrServiceCode =="7030" ]<-"Software as a product"
disa_sum$DISAprodserv[disa_sum$DISAprodserv =="Products" ]<-"Other Products"
disa_sum$DISAprodserv[disa_sum$DISAprodserv =="ICT" ]<-"Other ICT Services"



levels(factor(disa_sum$DISAprodserv))
disa_sum$DISAprodserv<-factor(disa_sum$DISAprodserv,
                              levels=c("Telecomm & Transmission", "Telecomm Network Mgmt.","Annual Software Maint.",
                                       "Other IT and Telecomm","Other ICT Services" ,
                                        "PAMS" , "Other Services and R&D","Software as a product",
                                        "Other Products" ,"Unlabeled"))
             


(
DISAProdServdetail<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2002 & ProductServiceOrRnDarea!="Unlabeled")  ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Commercial", #color_var
  facet_var="DISAprodserv", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)",caption="Note: Unlabeled not shown. Source: FPDS; CSIS analysis.")
)


write.csv(file="..//Output//DISA_prodserv_Comm.csv",row.names = FALSE,
          arrange(pivot_wider(DISAProdServdetail$data %>% 
                        arrange(dFYear) %>% mutate(Fiscal_Year=lubridate::year(dFYear)),
                      id_cols=c(DISAprodserv,Commercial),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20),DISAprodserv,Commercial))



# write.csv(file="..//Output//DISA_prodserv_comm.csv",row.names = FALSE,
#           arrange(pivot_wider(DISAProdServdetail$data %>% 
#                         arrange(dFYear) %>% mutate(Fiscal_Year=lubridate::year(dFYear)),
#                       id_cols=c(DISAprodserv,Commercial),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20),DISAprodserv,Commercial))

ggsave600dpi(DISAProdServdetail,file="..//output//DISA_prodserv.png",  
             width=13, height= 6, units="in",size=16, lineheight=1.2
             )
ggsave600dpi(DISAProdServdetail,file="..//output//DISA_prodserv.eps",  
             width=13, height= 6, units="in",size=16, lineheight=1.2
             )
```
### Hand Office
```{r HandOffice}

(
DISAProdServdetail<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2004 & ProductServiceOrRnDarea!="Unlabeled")  ,
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="OfficeSum", #color_var
  facet_var="DISAprodserv", #facet_var
  # column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)",caption="Note: Unlabeled not shown. Source: FPDS; CSIS analysis.")
)


(
DISAProdServdetail<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2004 & ProductServiceOrRnDarea!="Unlabeled")  ,
  chart_geom = "Bar Chart",
  share = TRUE,
  # labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="DISAprodserv", #color_var
  facet_var="OfficeSum", #facet_var
  # column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)",caption="Note: Unlabeled not shown. Source: FPDS; CSIS analysis.")
)

# ggsave600dpi(DISA_prodservdetail,file="..//output//DISA_prodserv.png",  
#              width=13, height= 6, units="in",size=16, lineheight=1.2
#              )
```

# Commercial

## DISA Info Tech Commercial PSR
```{r DISAcommPSR}

(
DISAcommPSR<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2002),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="informationtechnologycommercialitemcategoryText", #color_var
  facet_var="ServicesCategory.sum", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)


# ggsave600dpi("..//Output//DISA_pricing.png", DISAcomm, 
#              width=6.5, height= 4, units="in",size=11
#              )

# 
# ggsave600dpi("..//Output//DISA_commPSR.png", DISAcommPSR,  
#              width=13, height= 6, units="in",size=16, lineheight=1.2
#              )
# write.csv(file="..//Output//DISA_commPSR.csv",row.names = FALSE,
#           DISAcommPSR$data%>% mutate(dFYear=lubridate::year(dFYear))%>%
#             pivot_wider(id_cols=c(informationtechnologycommercialitemcategoryText,ServicesCategory.sum),
#                         names_from=dFYear,values_from=Action_Obligation_OMB20_GDP20))


```
## Commercial Vehicle
```{r CommVeh}

(
VehCommDet<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2002),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="informationtechnologycommercialitemcategoryText", #color_var
  facet_var="Vehicle.sum7", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)


(
VehCommSum<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2002),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Commercial", #color_var
  facet_var="Vehicle.sum7", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

(
CommVeh<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2002),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Vehicle.sum7", #color_var
  facet_var="Commercial", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

# ggsave600dpi("..//Output//DISA_pricing.png", DISAcomm, 
#              width=6.5, height= 4, units="in",size=11
#              )


ggsave600dpi("..//Output//DISA_CommVeh.png", CommVeh,  
             width=13, height= 6, units="in",size=16, lineheight=1.2
             )

ggsave600dpi("..//Output//DISA_VehCommSum.png", VehCommSum,  
             width=13, height= 6, units="in",size=16, lineheight=1.2
             )

# 
# write.csv(file="..//Output//DISA_CommVeh.csv",row.names = FALSE,
#           CommVeh$data%>% mutate(dFYear=lubridate::year(dFYear))%>%
#             pivot_wider(id_cols=c(Vehicle.sum7,Commercial),
#                         names_from=dFYear,values_from=Action_Obligation_OMB20_GDP20))

write.csv(file="..//Output//DISA_VehCommSum.csv",row.names = FALSE,
          VehCommSum$data%>% mutate(Fiscal_Year=lubridate::year(dFYear),
                                bAction_Obligation_OMB20_GDP20=Action_Obligation_OMB20_GDP20/1000000000)%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(Vehicle.sum7,Commercial),
                      names_from=Fiscal_Year,values_from=bAction_Obligation_OMB20_GDP20)%>%
            arrange(Vehicle.sum7,Commercial),na="")


levels(factor(disa_sum$Commercial))
```


## Commercial Competition
```{r CommComp}
summary(factor(disa_sum$Competition.sum))
(
CompComm<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2002),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Commercial", #color_var
  facet_var="Competition.sum", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

(
CommComp<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2002),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Competition.sum", #color_var
  facet_var="Commercial", #facet_var
  # column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+#scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)


# ggsave600dpi("..//Output//DISA_CommComp.png", CommComp,  
#              width=13, height= 6, units="in",size=16, lineheight=1.2
#              )
# 
# ggsave600dpi("..//Output//DISA_CompCommSum.png", CompComm,  
#              width=13, height= 6, units="in",size=16, lineheight=1.2
#              )


# write.csv(file="..//Output//DISA_CommVeh.csv",row.names = FALSE,
#           DISAcomm$data%>% mutate(dFYear=lubridate::year(dFYear))%>%
#             pivot_wider(id_cols=c(PricingUCA,PricingUCA.sumlong),
#                         names_from=dFYear,values_from=Action_Obligation_OMB20_GDP20))

levels(factor(disa_sum$Commercial))
```


# Office
## DISA Office 
```{r Office}

(
Office<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2004),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Office", #color_var
  facet_var="Office", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

# ggsave600dpi("..//Output//DISA_Office.png", Office, 
#              width=13, height= 6, units="in",size=16,lineheight = 1.2
#              )

# write.csv(file="..//Output//DISA_Office.csv",row.names = FALSE,
#           arrange(pivot_wider(Office$data %>% 
#                         arrange(dFYear) %>% mutate(Fiscal_Year=lubridate::year(dFYear)),
#                       id_cols=c(Office),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20),Office))


# 
# write.csv(file="..//Output//DISA_Office_current.csv",row.names = FALSE,
#           disa_data %>% group_by(Office,ContractingOffice,Fiscal_Year)%>%
#             dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
#           pivot_wider(id_cols=c(Office,ContractingOffice),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(disa_data$ContractingOffice)
```
## DISA Office  Location
```{r OfficeLoc}

(
OfficeLoc<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2004),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Office", #color_var
  facet_var="OfficeLoc", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//DISA_OfficeLoc.png", OfficeLoc, 
             width=13, height= 6, units="in",size=16,lineheight = 1.2
             )

# write.csv(file="..//Output//DISA_Office.csv",row.names = FALSE,
#           pivot_wider(Office$data,id_cols=c(Office.sum,Office.platform),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20))

# write.csv(file="..//Output//DISA_Office_current.csv",row.names = FALSE,
#           disa_data %>% group_by(Office.sum,ContractingOffice,Fiscal_Year)%>%
#             dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
#           pivot_wider(id_cols=c(Office.sum,ContractingOffice),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(disa_data$ContractingOffice)
```


## DISA Office  Summary
```{r OfficeSum}

(
OfficeSum<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2004),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="OfficeSum", #color_var
  facet_var="OfficeScott", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//DISA_OfficeSum.png", OfficeSum, 
             width=13, height= 6, units="in",size=16,lineheight = 1.2
             )
ggsave600dpi("..//Output//DISA_OfficeSum.eps", OfficeSum, 
             width=13, height= 6, units="in",size=16,lineheight = 1.2
             )
write.csv(file="..//Output//DISA_OfficeSum.csv",row.names = FALSE,
          arrange(pivot_wider(OfficeSum$data %>% 
                        arrange(dFYear) %>% mutate(Fiscal_Year=lubridate::year(dFYear)),
                      id_cols=c(OfficeScott,OfficeSum),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20),OfficeScott,OfficeSum))



# write.csv(file="..//Output//DISA_Office_current.csv",row.names = FALSE,
#           disa_data %>% group_by(Office.sum,ContractingOffice,Fiscal_Year)%>%
#             dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
#           pivot_wider(id_cols=c(Office.sum,ContractingOffice),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(disa_data$ContractingOffice)
```

## Office ProdServ
```{r OfficePSR}



(
OfficePSR<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2004),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="DISAprodserv.sum", #color_var
  facet_var="OfficeSum", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)+facet_wrap(~OfficeSum, ncol=3)

(
OfficePSRdetail<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2004),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="DISAprodserv", #color_var
  facet_var="OfficeSum", #facet_var
  # column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)+facet_wrap(~OfficeSum, ncol=3, scales="free_y")


ggsave600dpi("..//Output//DISA_OfficePSR.png", OfficePSR, 
             width=13, height= 6, units="in",size=16,lineheight = 1.2
             )

ggsave600dpi("..//Output//DISA_OfficePSR_paper.png", OfficePSR, 
             width=13, height= 4.5, units="in",size=16,lineheight = 1.2
             )

ggsave600dpi("..//Output//DISA_OfficePSR_paper.eps", OfficePSR, 
             width=13, height= 4.5, units="in",size=16,lineheight = 1.2
             )

write.csv(file="..//Output//DISA_OfficePSR.csv",row.names = FALSE,
          OfficePSR$data%>% mutate(Fiscal_Year=lubridate::year(dFYear),
                                bAction_Obligation_OMB20_GDP20=Action_Obligation_OMB20_GDP20/1000000000)%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(OfficeSum,DISAprodserv.sum),
                      names_from=Fiscal_Year,values_from=bAction_Obligation_OMB20_GDP20)%>%
            arrange(OfficeSum,DISAprodserv.sum),na="")

# write.csv(file="..//Output//DISA_OfficePSR_current.csv",row.names = FALSE,
#           disa_sum %>% group_by(OfficeSum,ContractingOffice,Fiscal_Year)%>%
#             dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
#           pivot_wider(id_cols=c(OfficeSum,ContractingOffice),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

```
## Office Pricing
```{r OfficePricing}

(
OfficePricing<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2004),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="TypeOfContractPricing5Category", #color_var
  facet_var="OfficeSum", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

# ggsave600dpi("..//Output//OfficePricing.png", OfficePricing, 
#              width=13, height= 6, units="in",size=16,lineheight = 1.2
#              )

# write.csv(file="..//Output//DISA_OfficePricing.csv",row.names = FALSE,
#           pivot_wider(OfficePricing$data,id_cols=c(Office.sum,Office.platform),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20))

# write.csv(file="..//Output//DISA_OfficePricing_current.csv",row.names = FALSE,
#           disa_sum %>% group_by(Office.sum,ContractingOffice,Fiscal_Year)%>%
#             dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
#           pivot_wider(id_cols=c(Office.sum,ContractingOffice),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(disa_sum$ContractingOffice)
```
## Office Funder
```{r OfficeFunder}
(
OfficeFunderDISA<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2004),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="FunderDISA", #color_var
  facet_var="OfficeSum", #facet_var
  # column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

(
OfficeFunder<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2004),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Funder", #color_var
  facet_var="OfficeSum", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)



ggsave600dpi("..//Output//DISA_OfficeFunder.png", OfficeFunder, 
             width=13, height= 6, units="in",size=16,lineheight = 1.2
             )

ggsave600dpi("..//Output//DISA_OfficeFunder_paper.png", OfficeFunder, 
             width=13, height= 4.5, units="in",size=16,lineheight = 1.2
             )
ggsave600dpi("..//Output//DISA_OfficeFunder_paper.eps", OfficeFunder, 
             width=13, height= 4.5, units="in",size=16,lineheight = 1.2
             )

write.csv(file="..//Output//DISA_OfficeFunder.csv",row.names = FALSE,
          OfficeFunder$data%>% mutate(Fiscal_Year=lubridate::year(dFYear),
                                bAction_Obligation_OMB20_GDP20=Action_Obligation_OMB20_GDP20/1000000000)%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(OfficeSum,Funder),
                      names_from=Fiscal_Year,values_from=bAction_Obligation_OMB20_GDP20)%>%
            arrange(OfficeSum,Funder),na="")

# write.csv(file="..//Output//DISA_OfficePricing_current.csv",row.names = FALSE,
#           disa_sum %>% group_by(Office.sum,ContractingOffice,Fiscal_Year)%>%
#             dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
#           pivot_wider(id_cols=c(Office.sum,ContractingOffice),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(disa_sum$ContractingOffice)
```

## Office Commercial
```{r OfficeComm}

(
OfficeComm<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2004),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Commercial", #color_var
  facet_var="OfficeSum", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)


(
OfficeCommLine<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2004),
  chart_geom = "Bar Chart",
  share = TRUE,
  # labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Commercial", #color_var
  facet_var="OfficeSum", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

(
OfficeIT<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2004),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="ITcategory", #color_var
  facet_var="OfficeSum", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)


ggsave600dpi("..//Output//DISA_OfficeComm.png", OfficeComm, 
             width=13, height= 6, units="in",size=16,lineheight = 1.2
             )


ggsave600dpi("..//Output//DISA_OfficeComm_paper.png", OfficeComm, 
             width=13, height= 4.5, units="in",size=16,lineheight = 1.2
             )


ggsave600dpi("..//Output//DISA_OfficeComm_paper.eps", OfficeComm, 
             width=13, height= 4.5, units="in",size=16,lineheight = 1.2
             )


write.csv(file="..//Output//DISA_OfficeComm.csv",row.names = FALSE,
          OfficeComm$data%>% mutate(Fiscal_Year=lubridate::year(dFYear),
                                bAction_Obligation_OMB20_GDP20=Action_Obligation_OMB20_GDP20/1000000000)%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(OfficeSum,Commercial),
                      names_from=Fiscal_Year,values_from=bAction_Obligation_OMB20_GDP20)%>%
            arrange(OfficeSum,Commercial),na="")


# write.csv(file="..//Output//DISA_OfficeComm_current.csv",row.names = FALSE,
#           disa_sum %>% group_by(Office.sum,ContractingOffice,Fiscal_Year)%>%
#             dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
#           pivot_wider(id_cols=c(Office.sum,ContractingOffice),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(disa_sum$ContractingOffice)
```

## Office Competition
```{r OfficeComp}

# (
# OfficeComp<-build_plot(
#   data=disa_sum %>% filter(Fiscal_Year>=2004),
#   chart_geom = "Bar Chart",
#   share = FALSE,
#   labels_and_colors=ds_lc,
#   # NA, #VAR.ncol
#   x_var="dFYear", #x_var
#   y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
#   color_var="Competition.sum", #color_var
#   facet_var="OfficeSum", #facet_var
#   column_key=ds_ck,
#   format=TRUE,
#   ytextposition=FALSE
# )+
#   # theme(strip.text.y = element_text(angle=0))+
#  # theme(axis.text.x = element_text(angle=90))+
#  #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
#  #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
#  #             )+labs(title=NULL,
#   # x="Fiscal Year",
#   # y="Percent of Obligations",
#   # color="Competition")+
#   theme(legend.position = "right")+
#   labs(y="Obligations (Constant 2020 $s)")
# )
# 
# 
# (
# OfficeCommLine<-build_plot(
#   data=disa_sum %>% filter(Fiscal_Year>=2004),
#   chart_geom = "Bar Chart",
#   share = TRUE,
#   # labels_and_colors=ds_lc,
#   # NA, #VAR.ncol
#   x_var="dFYear", #x_var
#   y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
#   color_var="Commercial", #color_var
#   facet_var="OfficeSum", #facet_var
#   column_key=ds_ck,
#   format=TRUE,
#   ytextposition=FALSE
# )+
#   # theme(strip.text.y = element_text(angle=0))+
#  # theme(axis.text.x = element_text(angle=90))+
#  #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
#  #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
#  #             )+labs(title=NULL,
#   # x="Fiscal Year",
#   # y="Percent of Obligations",
#   # color="Competition")+
#   theme(legend.position = "right")+
#   labs(y="Obligations (Constant 2020 $s)")
# )
# 
# (
# OfficeIT<-build_plot(
#   data=disa_sum %>% filter(Fiscal_Year>=2004),
#   chart_geom = "Bar Chart",
#   share = FALSE,
#   # labels_and_colors=ds_lc,
#   # NA, #VAR.ncol
#   x_var="dFYear", #x_var
#   y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
#   color_var="ITcategory", #color_var
#   facet_var="OfficeSum", #facet_var
#   column_key=ds_ck,
#   format=TRUE,
#   ytextposition=FALSE
# )+
#   # theme(strip.text.y = element_text(angle=0))+
#  # theme(axis.text.x = element_text(angle=90))+
#  #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
#  #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
#  #             )+labs(title=NULL,
#   # x="Fiscal Year",
#   # y="Percent of Obligations",
#   # color="Competition")+
#   theme(legend.position = "right")+
#   labs(y="Obligations (Constant 2020 $s)")
# )
# 
# 
# ggsave600dpi("..//Output//DISA_OfficeComm.png", OfficeComm, 
#              width=13, height= 6, units="in",size=16,lineheight = 1.2
#              )
# 
# write.csv(file="..//Output//DISA_OfficeComm.csv",row.names = FALSE,
#           pivot_wider(OfficeComm$data,id_cols=c(Office.sum,Office.platform),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20))
# 
# write.csv(file="..//Output//DISA_OfficeComm_current.csv",row.names = FALSE,
#           disa_sum %>% group_by(Office.sum,ContractingOffice,Fiscal_Year)%>%
#             dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
#           pivot_wider(id_cols=c(Office.sum,ContractingOffice),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))
# 
# summary(disa_sum$ContractingOffice)
```

## Office Vehicle
```{r OfficeVehicle}

(
OfficeVehicle<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2004 & !is.na(Vehicle.sum7)),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Vehicle.sum7", #color_var
  facet_var="OfficeSum", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)", caption="Note: Unlabeled not shown. Source: FPDS; CSIS analysis.")
)


(
OfficeVehicleLine<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2004),
  chart_geom = "Bar Chart",
  share = TRUE,
  # labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Vehicle.sum7", #color_var
  facet_var="OfficeSum", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

(
OfficeIT<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2004),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="ITcategory", #color_var
  facet_var="OfficeSum", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

# 
# ggsave600dpi("..//Output//DISA_OfficeVehicle.png", OfficeVehicle, 
#              width=13, height= 6, units="in",size=16,lineheight = 1.2
#              )

ggsave600dpi("..//Output//DISA_OfficeVehicle_paper.png", OfficeVehicle, 
             width=13, height= 4.5, units="in",size=16,lineheight = 1.2
             )
ggsave600dpi("..//Output//DISA_OfficeVehicle_paper.eps", OfficeVehicle, 
             width=13, height= 4.5, units="in",size=16,lineheight = 1.2
             )

write.csv(file="..//Output//DISA_OfficeVehicle.csv",row.names = FALSE,
          OfficeVehicle$data%>% mutate(Fiscal_Year=lubridate::year(dFYear),
                                bAction_Obligation_OMB20_GDP20=Action_Obligation_OMB20_GDP20/1000000000)%>%
            arrange(Fiscal_Year)%>%
          pivot_wider(id_cols=c(OfficeSum,Vehicle.sum7),
                      names_from=Fiscal_Year,values_from=bAction_Obligation_OMB20_GDP20)%>%
            arrange(OfficeSum,Vehicle.sum7),na="")


# write.csv(file="..//Output//DISA_OfficeVehicle_current.csv",row.names = FALSE,
#           disa_sum %>% group_by(Office.sum,ContractingOffice,Fiscal_Year)%>%
#             dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
#           pivot_wider(id_cols=c(Office.sum,ContractingOffice),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(disa_sum$ContractingOffice)
```


# Funder
## Funder Office
```{r FunderOffice}

(
FunderOffice<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2004),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="OfficeSum", #color_var
  facet_var="Funder", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)


(
FunderOffice<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2004),
  chart_geom = "Line Chart",
  share = TRUE,
  # labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="OfficeSum", #color_var
  facet_var="Funder", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)

# 
# ggsave600dpi("..//Output//OfficeVehicle.png", OfficeVehicle, 
#              width=13, height= 6, units="in",size=16,lineheight = 1.2
#              )

# write.csv(file="..//Output//DISA_OfficeVehicle.csv",row.names = FALSE,
#           pivot_wider(OfficeVehicle$data,id_cols=c(Office.sum,Office.platform),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20))
# 
# write.csv(file="..//Output//DISA_OfficeVehicle_current.csv",row.names = FALSE,
#           disa_sum %>% group_by(Office.sum,ContractingOffice,Fiscal_Year)%>%
#             dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
#           pivot_wider(id_cols=c(Office.sum,ContractingOffice),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(disa_sum$ContractingOffice)
```
For the services, their division by office is relatively even. Army is making more use of PL-84 but Navy and Air Force are picking up as well.

## Funder Commercial

```{r FunderComm}

(
FunderComm<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2004),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Commercial", #color_var
  facet_var="Funder", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)


# ggsave600dpi("..//Output//DISA_FunderComm.png", FunderComm, 
#              width=13, height= 6, units="in",size=16,lineheight = 1.2
#              )

# write.csv(file="..//Output//DISA_OfficePricing.csv",row.names = FALSE,
#           pivot_wider(OfficePricing$data,id_cols=c(Office.sum,Office.platform),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20))
# 
# write.csv(file="..//Output//DISA_OfficePricing_current.csv",row.names = FALSE,
#           disa_sum %>% group_by(Office.sum,ContractingOffice,Fiscal_Year)%>%
#             dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
#           pivot_wider(id_cols=c(Office.sum,ContractingOffice),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(disa_sum$ContractingOffice)
```

With the exception of Other than DoD, each funder appears to make use of a mix of comemrcial and non-commercial sources.


## Funder PSR
```{r FunderPSR}

(
FunderPSR<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2004),
  chart_geom = "Bar Chart",
  share = FALSE,
  # labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="ServicesCategory.sum", #color_var
  facet_var="Funder", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)


(
FunderPSR<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2004),
  chart_geom = "Line Chart",
  share = TRUE,
  # labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="OfficeSum", #color_var
  facet_var="Funder", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)


# ggsave600dpi("..//Output//DISA_OfficePricing.png", OfficePricing, 
#              width=13, height= 6, units="in",size=16,lineheight = 1.2
#              )

# write.csv(file="..//Output//DISA_OfficePricing.csv",row.names = FALSE,
#           pivot_wider(OfficePricing$data,id_cols=c(Office.sum,Office.platform),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20))
# 
# write.csv(file="..//Output//DISA_OfficePricing_current.csv",row.names = FALSE,
#           disa_sum %>% group_by(Office.sum,ContractingOffice,Fiscal_Year)%>%
#             dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
#           pivot_wider(id_cols=c(Office.sum,ContractingOffice),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(disa_sum$ContractingOffice)
```
The Army stands out nin buying products, generally the services are acquiring ICT. But otherwise not that remarkable.


## Funder Vehicle
```{r FunderVehicle}

(
FunderVehicle<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2004),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Vehicle.sum7", #color_var
  facet_var="Funder", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)


(
FunderVehicle<-build_plot(
  data=disa_sum %>% filter(Fiscal_Year>=2004),
  chart_geom = "Bar Chart",
  share = TRUE,
  # labels_and_colors=ds_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Vehicle.sum7", #color_var
  facet_var="Funder", #facet_var
  column_key=ds_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2020 $s)")
)+facet_wrap(~Funder)


# ggsave600dpi("..//Output//DISA_OfficePricing.png", OfficePricing, 
#              width=13, height= 6, units="in",size=16,lineheight = 1.2
#              )

# write.csv(file="..//Output//DISA_OfficePricing.csv",row.names = FALSE,
#           pivot_wider(OfficePricing$data,id_cols=c(Office.sum,Office.platform),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB20_GDP20))
# 
# write.csv(file="..//Output//DISA_OfficePricing_current.csv",row.names = FALSE,
#           disa_sum %>% group_by(Office.sum,ContractingOffice,Fiscal_Year)%>%
#             dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
#           pivot_wider(id_cols=c(Office.sum,ContractingOffice),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(disa_sum$ContractingOffice)
```
With the exception of Other than DoD the patterns seems simialr enought that this breakdown does not add much. Other than DoD is domianted by Other IDV.
# Platform
## DISA  Platform
```{r Platform}

(
Platform<-build_plot(
  data=disa_data,
  chart_geom = "Line Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="PlatformPortfolio", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2020 $s)")
)

ggsave600dpi("..//Output//DISA_platform.png", Platform, 
             width=13, height= 6, units="in",size=16,lineheight = 1.2
             )


write.csv(file="..//Output//DISA_platform_current.csv",row.names = FALSE,
          disa_data %>% group_by(PlatformPortfolio,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(PlatformPortfolio),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

```



## Platform SubCustomer
```{r PlatformSubCustomer}

(
PlatformSubCustomer<-build_plot(
  data=disa_data,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="SubCustomer.platform", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2020 $s)")
)

# ggsave600dpi("..//Output//DISA_platform_subcustomer.png", PlatformSubCustomer, 
#              width=6.5, height= 4, units="in",size=11,lineheight = 0.75
#              )

```

## Platform PSR
```{r PlatformPSR}

(
PlatformPSR<-build_plot(
  data=disa_data,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="SimpleArea", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2020 $s)")
)

# ggsave600dpi("..//Output//DISA_platform_PSR.png", PlatformPSR, 
#              width=6.5, height= 4, units="in",size=11,lineheight = 0.75
#              )

```





## Platform Vendor
```{r PlatformVendor}

(
PlatformVendor<-build_plot(
  data=disa_data %>% filter(PlatformPortfolio!="Unlabeled" ) ,
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Shiny.VendorSize", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2020 $s)")
)

# ggsave600dpi("..//Output//DISA_platform_vendor.png", PlatformVendor, 
#              width=6.5, height= 4, units="in",size=11,lineheight = 0.75
#              )

```



## Platform Comp
```{r PlatformComp}

(
PlatformComp<-build_plot(
  data=disa_data %>% filter(PlatformPortfolio!="Unlabeled" ),
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB20_GDP20", #VAR.y.variable
  color_var="Competition.multisum", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+scale_x_date("Fiscal Year",labels = date_format("'%y"))+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Obligations (Constant 2020 $s)")
)

# ggsave600dpi("..//Output//DISA_platform_comp.png", PlatformComp, 
#              width=6.5, height= 4, units="in",size=11,lineheight = 0.75
#              )

```
