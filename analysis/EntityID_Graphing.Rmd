---
title: "Footing"
author: "Greg Sanders"
date: "July 16, 2018"
output: html_document
---
# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(tidyverse)
library(ggplot2)
library(csis360)
load(file="../data/clean/FPDS_eid_fyear.rda")
load(file="../data//clean//defense_naics_vendor.Rdata")

load(file="../data//clean//TopVendorUAVHistoryPlatformCustomer.rda")

# style_path<-"https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/style/"
# style_path<-"K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\"
style_path<-"C:\\Users\\gsand\\Repositories\\Lookup-Tables\\style\\"

eid_lc<-prepare_labels_and_colors(FPDS_eid_fyear)


summary(factor(FPDS_eid_fyear$IsEntityAbove2018constant10ThousandThreshold))

summary(factor(FPDS_eid_fyear$EntitySizeText))
summary(factor(FPDS_eid_fyear$EntitySizeGlitch))
summary(FPDS_eid_fyear$ObligatedAmountIsSmall)
summary(FPDS_eid_fyear$MajorityNotSmall)
FPDS_eid_fyear$count<-1
FPDS_eid_fyear<-csis360::read_and_join_experiment(FPDS_eid_fyear,
                        "EntitySizeCode.csv",
                        by=c("EntitySizeCode"),
                        add_var=c("EntitySmall"),
                        path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                        dir="vendor/"
)

FPDS_eid_fyear$EntitySmall[FPDS_eid_fyear$EntitySizeGlitch==TRUE |FPDS_eid_fyear$EntitySmall=="Unlabeled Vendor" ]<-"Unlabeled"
summary(factor(FPDS_eid_fyear$EntitySmall))
FPDS_eid_fyear$EntitySmall<-factor(FPDS_eid_fyear$EntitySmall,rev(c("Always Small Vendor","Sometimes Small Vendor","Other Than Small","Unlabeled")))

FPDS_eid_fyear<-csis360::read_and_join_experiment(FPDS_eid_fyear,
  "Vendor.EntityIDanyDefense.txt",
  by=c("fiscal_year","EntityID"),
  add_var="AnyDefenseCustomer",
  skip_check_var = "AnyDefenseCustomer",
  path="",
  
  dir=file.path("..","data","semi_clean")
)



ec<-read.delim(file.path("../Data/semi_clean/Vendor_sp_EntityCountHistoryCustomer.txt"), header=TRUE,  na.strings = c("", "NULL"))
ec<-remove_bom(ec)
ec<-standardize_variable_names(ec)
ec$dFYear<-as.Date(paste("1/1/",as.character(ec$Fiscal_Year),sep=""),"%m/%d/%Y")


ec<-csis360::read_and_join_experiment(ec,
  "EntitySizeCode.csv",
  by="EntitySizeCode",
  add_var="EntitySmall",
  path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
  dir="vendor/"
)



# def_eid_fyear<-read.delim(file.path("../Data/semi_clean/Defense_Vendor.SP_EntityIDhistory.txt"), header=TRUE,  na.strings = c("", "NULL"))
# def_eid_fyear<-remove_bom(def_eid_fyear)
# def_eid_fyear$EntityCount<-1
# def_eid_fyear<-standardize_variable_names(def_eid_fyear)
# def_eid_fyear$dFYear<-as.Date(paste("1/1/",as.character(def_eid_fyear$Fiscal_Year),sep=""),"%m/%d/%Y")

# eid_lc<-prepare_labels_and_colors(ec,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
ec<-replace_nas_with_unlabeled(ec,"EntitySmall","Unlabeled Vendor")
ec<-replace_nas_with_unlabeled(ec,"EntitySizeText","Unlabeled Vendor")

eid_lc<-prepare_labels_and_colors(ec)




ecp<-read.delim(file.path("../Data/semi_clean/Defense_Vendor_sp_EntityCountHistoryPlatformCustomer.txt"), header=TRUE,  na.strings = c("", "NULL"))
ecp<-remove_bom(ecp)
ecp<-standardize_variable_names(ecp)
ecp$dFYear<-as.Date(paste("1/1/",as.character(ecp$Fiscal_Year),sep=""),"%m/%d/%Y")



ecp<-csis360::read_and_join(ecp,
  "EntitySizeCode.csv",
  by="EntitySizeCode",
  add_var="EntitySmall",
  path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
  dir="vendor/"
)
def_eid_fyear_plat<-read.delim(file.path("../Data/semi_clean/Defense_Vendor.SP_EntityIDhistoryPlatform.txt"),
                               header=TRUE,  na.strings = c("", "NULL"))
def_eid_fyear_plat<-remove_bom(def_eid_fyear_plat)
def_eid_fyear_plat<-standardize_variable_names(def_eid_fyear_plat)
def_eid_fyear_plat$EntityCount<-1
def_eid_fyear_plat$dFYear<-as.Date(paste("1/1/",as.character(def_eid_fyear_plat$Fiscal_Year),sep=""),"%m/%d/%Y")

ecp$EntitySizeText<-factor(ecp$EntitySizeText)
ecp$thresh<-factor(ecp$IsEntityAbove2016constantOneMillionThreshold,
                   levels=c(0,1), 
                   labels=c("Vendor only receives smaller contracts","Vendor receives contracts over $1 million in 2016 $"))


ecp<-replace_nas_with_unlabeled(ecp,"EntitySmall","Unlabeled Vendor")
ecp<-replace_nas_with_unlabeled(ecp,"EntitySizeText","Unlabeled Vendor")


# ecp_lc<-prepare_labels_and_colors(ecp,path="K:\\Users\\Greg\\Repositories\\Lookup-Tables\\style\\")
ecp_lc<-prepare_labels_and_colors(ecp)

ecp_ck<-get_column_key(ecp)




ecsub<-read.delim(file.path("../Data/semi_clean/Vendor_sp_EntityCountHistorySubCustomer.txt"), header=TRUE,  na.strings = c("", "NULL"))
ecsub<-remove_bom(ecsub)
ecsub<-standardize_variable_names(ecsub)
ecsub$dFYear<-as.Date(paste("1/1/",as.character(ecsub$Fiscal_Year),sep=""),"%m/%d/%Y")



ecsub<-csis360::read_and_join(ecsub,
  "EntitySizeCode.csv",
  by="EntitySizeCode",
  add_var="EntitySmall",
  path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
  dir="vendor/"
)
eid_lc<-prepare_labels_and_colors(FPDS_eid_fyear)
eid_ck<-get_column_key(FPDS_eid_fyear)
ecp_lc<-prepare_labels_and_colors(defense_platform_vendor)
ecp_ck<-get_column_key(defense_platform_vendor)

```
## Join up new entrants
```{r setupnew}
entrant_lookup<-FPDS_eid_fyear %>% select(EntityID,fiscal_year,
                                          entrant,entrant_2018T,
                                          IsEntityAbove2018constant10ThousandThreshold) %>%
  standardize_variable_names()
# defense_platform_vendor <- defense_platform_vendor%>%select(-entrant,-entrant_2018T)
defense_platform_vendor<-defense_platform_vendor[,!colnames(defense_platform_vendor)%in% 
                                                   c("entrant","entrant_2018T",
                                                     "entrant.x","entrant_2018T/x",
                                                     "entrant.y","entrant_2018T.y",
                                                     "IsEntityAbove2018constant10ThousandThreshold",
                                                     "IsEntityAbove2018constant10ThousandThreshold.x",
                                                     "IsEntityAbove2018constant10ThousandThreshold.y")]
defense_platform_vendor<-left_join(defense_platform_vendor,entrant_lookup,
                                   by=c("Fiscal_Year","EntityID"))
defense_platform_vendor$count<-1
defense_platform_vendor<-apply_standard_lookups(defense_platform_vendor)
defense_platform_vendor<-replace_nas_with_unlabeled(defense_platform_vendor,"entrant_2018T")
defense_platform_vendor$entrant_2018T<-factor(defense_platform_vendor$entrant_2018T,
                                              levels=c("TRUE","FALSE","Unlabeled"),
                                              labels=c("New Entrant",
                                                       "Pre-established Vendor",
                                                       "Unlabeled"
                                                       ))

```
# New Entrant Count
## Overall Vendor
```{r overall}


(
all_10k_small_bar<-build_plot(
  data=FPDS_eid_fyear %>% dplyr::filter(IsEntityAbove2018constant10ThousandThreshold==1
                                        & fiscal_year>=2005), ##where is FPDS summary?
  chart_geom = "Bar Chart",
  share = FALSE,
  x_var="fiscal_year",
  y_var="count", #Name of variable to plot on y-axis
  color_var="EntitySmall",       # name of coloration variable, as string
  # facet_var="EntitySizeText",        # name of facet variable, as string
  legend=TRUE, #Include a legend
  caption=TRUE, #Include a source caption
  # labels_and_colors=eid_lc,
  column_key=NULL,
  format=TRUE
)+labs(y="Count of vendors contracts above $10k in 2018 $s",x="Fiscal Year")
)

(
all_10k_small_bar<-build_plot(
  data=FPDS_eid_fyear %>% dplyr::filter(IsEntityAbove1990constantReportingThreshold==1), ##where is FPDS summary?
  chart_geom = "Bar Chart",
  share = FALSE,
  x_var="fiscal_year",
  y_var="count", #Name of variable to plot on y-axis
  color_var="EntitySmall",       # name of coloration variable, as string
  # facet_var="EntitySizeText",        # name of facet variable, as string
  legend=TRUE, #Include a legend
  caption=TRUE, #Include a source caption
  # labels_and_colors=eid_lc,
  column_key=NULL,
  format=TRUE
)+labs(y="Count of vendors contracts above $25k in 1990 $s",x="Fiscal Year")
)


(
all_small_bar<-build_plot(
  data=FPDS_eid_fyear,# %>% dplyr::filter(IsEntityAbove2018constant10ThousandThreshold==0), ##where is FPDS summary?
  chart_geom = "Bar Chart",
  share = FALSE,
  x_var="fiscal_year",
  y_var="count", #Name of variable to plot on y-axis
  color_var="EntitySmall",       # name of coloration variable, as string
  # facet_var="EntitySizeText",        # name of facet variable, as string
  legend=TRUE, #Include a legend
  caption=TRUE, #Include a source caption
  # labels_and_colors=eid_lc,
  column_key=NULL,
  format=TRUE
)+labs(y="Count of all vendors",x="Fiscal Year")
)

write.csv(all_10k_small_bar$data %>% pivot_wider(id_cols="EntitySmall",names_from="fiscal_year",values_from="count"),file.path("..","output","all_10k_small.csv"))


write.csv(all_small_bar$data %>% pivot_wider(id_cols="EntitySmall",names_from="fiscal_year",values_from="count"),file.path("..","output","all_small.csv"))

ggsave(all_10k_small_bar+labs(title="Federal Contractor Count",x="Fiscal Year",y="Number of Entities with contracts\nvalued over $10k threshold (in 2018 constant dollars)"),file=file.path("..","output","all_10k_small.png"))

```

## Defense Vendor
```{r overall}


(
all_10k_small_bar<-build_plot(
  data=FPDS_eid_fyear %>% dplyr::filter(IsEntityAbove2018constant10ThousandThreshold==1
                                        & fiscal_year>=2005 &
                                          AnyDefenseCustomer==1), ##where is FPDS summary?
  chart_geom = "Bar Chart",
  share = FALSE,
  x_var="fiscal_year",
  y_var="count", #Name of variable to plot on y-axis
  color_var="EntitySmall",       # name of coloration variable, as string
  # facet_var="EntitySizeText",        # name of facet variable, as string
  legend=TRUE, #Include a legend
  caption=TRUE, #Include a source caption
  # labels_and_colors=eid_lc,
  column_key=NULL,
  format=TRUE
)+labs(y="Count of vendors contracts above $10k in 2018 $s",x="Fiscal Year")
)

(
all_10k_small_bar<-build_plot(
  data=FPDS_eid_fyear %>% dplyr::filter(IsEntityAbove1990constantReportingThreshold==1 &
                                          AnyDefenseCustomer==1), ##where is FPDS summary?
  chart_geom = "Bar Chart",
  share = FALSE,
  x_var="fiscal_year",
  y_var="count", #Name of variable to plot on y-axis
  color_var="EntitySmall",       # name of coloration variable, as string
  # facet_var="EntitySizeText",        # name of facet variable, as string
  legend=TRUE, #Include a legend
  caption=TRUE, #Include a source caption
  # labels_and_colors=eid_lc,
  column_key=NULL,
  format=TRUE
)+labs(y="Count of vendors contracts above $25k in 1990 $s",x="Fiscal Year")
)

(
all_small_bar<-build_plot(
  data=FPDS_eid_fyear %>% dplyr::filter( AnyDefenseCustomer==1), ##where is FPDS summary?
  chart_geom = "Bar Chart",
  share = FALSE,
  x_var="fiscal_year",
  y_var="count", #Name of variable to plot on y-axis
  color_var="EntitySmall",       # name of coloration variable, as string
  # facet_var="EntitySizeText",        # name of facet variable, as string
  legend=TRUE, #Include a legend
  caption=TRUE, #Include a source caption
  # labels_and_colors=eid_lc,
  column_key=NULL,
  format=TRUE
)+labs(y="Count of all vendors",x="Fiscal Year")
)

write.csv(all_10k_small_bar$data %>% pivot_wider(id_cols="EntitySmall",names_from="fiscal_year",values_from="count"),file.path("..","output","all_10k_small.csv"))


write.csv(all_small_bar$data %>% pivot_wider(id_cols="EntitySmall",names_from="fiscal_year",values_from="count"),file.path("..","output","all_small.csv"))

ggsave(all_10k_small_bar+labs(title="Federal Contractor Count",x="Fiscal Year",y="Number of Entities with contracts\nvalued over $10k threshold (in 2018 constant dollars)"),file=file.path("..","output","all_10k_small.png"))

```

First lets look at the total number of vendors.

```{r count, echo=FALSE, fig.width=6.5, fig.height=9}
##counting the number of new entrants and incumbent firms##



build_plot(
  data=FPDS_eid_fyear, ##where is FPDS summary?
  chart_geom = "Line Chart",
  share = TRUE,
  x_var="fiscal_year",
  y_var="count", #Name of variable to plot on y-axis
  color_var="entrant",       # name of coloration variable, as string
  # facet_var="entrant",        # name of facet variable, as string
  legend=TRUE, #Include a legend
  caption=TRUE, #Include a source caption
  labels_and_colors=eid_lc,
  column_key=NULL,
  format=TRUE
)


build_plot(
  data=FPDS_eid_fyear %>% filter(first_year_2018T==2007), ##where is FPDS summary?
  chart_geom = "Bar Chart",
  share = FALSE,
  x_var="fiscal_year",
  y_var="count", #Name of variable to plot on y-axis
  color_var="last_year_2018T",       # name of coloration variable, as string
  # facet_var="entrant",        # name of facet variable, as string
  legend=TRUE, #Include a legend
  caption=TRUE, #Include a source caption
  labels_and_colors=NULL,
  column_key=NULL,
  format=TRUE
)

  ##counting the number of new entrants and incumbent firms stacked##
  build_plot(
    data=FPDS_eid_fyear,
    chart_geom = "Histogram",
    # share = FALSE,
    x_var="fiscal_year",
    # y_var="ObligatedAmount_OMB20_GDP20", #Name of variable to plot on y-axis
    color_var="status",       # name of coloration variable, as string
    facet_var="status",        # name of facet variable, as string
    legend=TRUE, #Include a legend
    caption=TRUE, #Include a source caption
    labels_and_colors=NULL,
    column_key=NULL
  )

  ##counting the number of new entrants and incumbent firms stacked##
  build_plot(
    data=FPDS_eid_fyear %>% filter(first_year_2018T==2007),
    chart_geom = "Histogram",
    # share = FALSE,
    x_var="fiscal_year",
    # y_var="ObligatedAmount_OMB20_GDP20", #Name of variable to plot on y-axis
    color_var="status",       # name of coloration variable, as string
    facet_var="status",        # name of facet variable, as string
    legend=TRUE, #Include a legend
    caption=TRUE, #Include a source caption
    labels_and_colors=NULL,
    column_key=NULL
  )
```

## SRC Count
```{r srccount}
#*****#
##SRC##
#*****#
#number of new entrants vs incumbent firms
#drop years before 2001 and after 2016
FPDS_eid_fyear_op <- FPDS_eid_fyear[!(FPDS_eid_fyear$fiscal_year<2001), ]
FPDS_eid_fyear_op <- FPDS_eid_fyear_op[!(FPDS_eid_fyear_op$fiscal_year>2016), ]

ggplot(FPDS_eid_fyear_op, aes(x = fiscal_year, fill = factor(entrant))) +
  geom_histogram(position = "stack", binwidth = 1) +
  scale_x_continuous(breaks = c(2001:2016)) +
  xlab("Fiscal Year") +
  ylab("Number of Vendors") +
  scale_fill_manual(name = "New Entrants Types", values = c("darkslategray1", "cadetblue4"), labels = c("Incumbent", "New Entrant")) 
#******************************#
#******************************#

##counting the number of new entrant and incumbent firms on two separate graphs##
build_plot(
  data=FPDS_eid_fyear,
  chart_geom = "Histogram",
  # share = FALSE,
  x_var="fiscal_year",
  # y_var="ObligatedAmount_OMB20_GDP20", #Name of variable to plot on y-axis
  color_var="entrant",       # name of coloration variable, as string
  facet_var="entrant",        # name of facet variable, as string
  legend=TRUE, #Include a legend
  caption=TRUE, #Include a source caption
  labels_and_colors=eid_lc,
  column_key=NULL
)+facet_wrap(~entrant,scales="free_y",ncol=1)


build_plot(
  data=FPDS_eid_fyear,
  chart_geom = "Histogram",
  # share = FALSE,
  x_var="fiscal_year",
  # y_var="ObligatedAmount_OMB20_GDP20", #Name of variable to plot on y-axis
  color_var="status",       # name of coloration variable, as string
  facet_var="entrant",        # name of facet variable, as string
  legend=TRUE, #Include a legend
  caption=TRUE, #Include a source caption
  labels_and_colors=eid_lc,
  column_key=NULL
)+facet_wrap(~entrant,scales="free_y",ncol=1)


#number of vendors from each sample over time#
#I think i want drop the "not included in sample" --> use FPDS_eid_fyear_op
build_plot(
  data=FPDS_eid_fyear,
  chart_geom = "Histogram",
  # share = FALSE,
  x_var="fiscal_year",
  # y_var="ObligatedAmount_OMB20_GDP20", #Name of variable to plot on y-axis
  color_var="sample_year",       # name of coloration variable, as string
  # facet_var="sample_year",        # name of facet variable, as string
  legend=TRUE, #Include a legend
  caption=TRUE, #Include a source caption
  labels_and_colors=eid_lc,
  column_key=NULL
)+labs(x="Fiscal Year of Transaction",y="Number of Contractors") #what do you mean by fiscal year of transaction







build_plot(
  data=subset(FPDS_eid_fyear,sample_year!="Not in sample"),
  chart_geom = "Histogram",
  # share = FALSE,
  x_var="fiscal_year",
  # y_var="ObligatedAmount_OMB20_GDP20", #Name of variable to plot on y-axis
  color_var="sample_year",       # name of coloration variable, as string
  # facet_var="sample_year",        # name of facet variable, as string
  legend=TRUE, #Include a legend
  caption=TRUE, #Include a source caption
  labels_and_colors=eid_lc,
  column_key=NULL
)+labs(x="Fiscal Year of Transaction",y="Number of Contractors") #what do you mean by fiscal year of transaction


#*******#
#**SRC**#
#*******#
##drop those not in sample 
#1. make not in sample binary
table(FPDS_eid_fyear$sample_year)
FPDS_eid_fyear$sample_year_bin <- plyr::revalue(FPDS_eid_fyear$sample_year, c("Not in sample"="0", "2001"="1", "2002"="2", "2003"="3", "2004"="4", "2005"="5", "2006"="6"))
str(FPDS_eid_fyear$sample_year_bin)
table(FPDS_eid_fyear$sample_year_bin)
FPDS_eid_fyear$sample_year_bin <- as.numeric(as.character(FPDS_eid_fyear$sample_year_bin))
str(FPDS_eid_fyear$sample_year_bin)
table(FPDS_eid_fyear$sample_year_bin)

FPDS_eid_fyear_samples <- FPDS_eid_fyear[!(FPDS_eid_fyear$sample_year_bin<1), ]
FPDS_eid_fyear_samples_op <- FPDS_eid_fyear_samples[!(FPDS_eid_fyear_samples$fiscal_year<2001), ]
FPDS_eid_fyear_samples_op <- FPDS_eid_fyear_samples_op[!(FPDS_eid_fyear_samples_op$fiscal_year>2016), ]


ggplot(FPDS_eid_fyear_samples_op, aes(x = fiscal_year, fill = factor(sample_year))) +
  geom_histogram(position = "stack", binwidth = .5)
#*****************************************************************************************#
#*****************************************************************************************#


build_plot(
  data=FPDS_eid_fyear,
  chart_geom = "Histogram",
  # share = FALSE,
  x_var="fiscal_year",
  # y_var="ObligatedAmount_OMB20_GDP20", #Name of variable to plot on y-axis
  color_var="sample_year",       # name of coloration variable, as string
  facet_var="sample_year",        # name of facet variable, as string
  legend=TRUE, #Include a legend
  caption=TRUE, #Include a source caption
  labels_and_colors=eid_lc,
  column_key=NULL
)+facet_wrap(~sample_year,scales="fixed",ncol=1)+
  labs(x="Fiscal Year of Transaction",y="Number of Contractors")

#GSS2018-07-30 Start year faceted, but only vendors in sample, x is fiscal year
sample<-subset(FPDS_eid_fyear,sample_year!="Not in sample")
build_plot(
  data=sample,
  chart_geom = "Histogram",
  # share = FALSE,
  x_var="fiscal_year",
  # y_var="ObligatedAmount_OMB20_GDP20", #Name of variable to plot on y-axis
  color_var="sample_year",       # name of coloration variable, as string
  facet_var="sample_year",        # name of facet variable, as string
  legend=TRUE, #Include a legend
  caption=TRUE, #Include a source caption
  labels_and_colors=eid_lc,
  column_key=NULL
)+facet_wrap(~sample_year,scales="fixed",ncol=1)+
  labs(x="Fiscal Year of Transaction",y="Number of Contractors")

#GSS2018-07-30 Start year faceted, but only vendors in sample, x is number of years since entry

sample$years_in_sample<-sample$fiscal_year-sample$first_year_2018T
build_plot(
  data=sample,
  chart_geom = "Histogram",
  # share = FALSE,
  x_var="years_in_sample",
  # y_var="ObligatedAmount_OMB20_GDP20", #Name of variable to plot on y-axis
  color_var="sample_year",       # name of coloration variable, as string
  facet_var="sample_year",        # name of facet variable, as string
  legend=TRUE, #Include a legend
  caption=TRUE, #Include a source caption
  labels_and_colors=eid_lc,
  column_key=NULL
)+facet_wrap(~sample_year,scales="fixed",ncol=1)+
  labs(x="Years Since Vendor Became New Entrant",y="Number of Contractors")





build_plot(
  data=FPDS_eid_fyear,
  chart_geom = "Histogram",
  # share = FALSE,
  x_var="fiscal_year",
  # y_var="ObligatedAmount_OMB20_GDP20", #Name of variable to plot on y-axis
  color_var="status",       # name of coloration variable, as string
  facet_var="sample_year",        # name of facet variable, as string
  legend=TRUE, #Include a legend
  caption=TRUE, #Include a source caption
  labels_and_colors=eid_lc,
  column_key=NULL
)+facet_wrap(~sample_year,scales="fixed",ncol=1)+
  labs(x="Fiscal Year of Transaction",y="Number of Contractors")




# build_plot(
#   data=FPDS_cleaned_unique %>% filter(fiscal_year>2000),
#   chart_geom = "Histogram",
#   # share = FALSE,
#   x_var="FYear",
#   # y_var="ObligatedAmount_OMB20_GDP20", #Name of variable to plot on y-axis
#   # color_var="entrant",       # name of coloration variable, as string
#   # facet_var="entrant",        # name of facet variable, as string
#   legend=TRUE, #Include a legend
#   caption=TRUE, #Include a source caption
#   labels_and_colors=eid_lc,
#   column_key=NULL
# )+labs(x="Fiscal Year of Contractor First Appearance",y="Number of Contractors")#+facet_wrap(~entrant,scales="free_y",ncol=1)


```
## Dollars
Then the vendor spend.

```{r dollars, fig.width=7, fig.height=7}

build_plot(
  data=FPDS_eid_fyear %>% filter(fiscal_year>2000),
  chart_geom = "Bar Chart",
  # share = FALSE,
  x_var="fiscal_year",
  y_var="ObligatedAmount_OMB20_GDP20", #Name of variable to plot on y-axis
  color_var="entrant",       # name of coloration variable, as string
  # facet_var="entrant",        # name of facet variable, as string
  legend=TRUE, #Include a legend
  caption=TRUE, #Include a source caption
  labels_and_colors=eid_lc,
  column_key=NULL
)+labs(x="Fiscal Year of Transaction",y="Obligations 2020 $")


##fiscal year of transaction
build_plot(
  data=FPDS_eid_fyear,
  chart_geom = "Bar Chart",
  # share = FALSE,
  x_var="fiscal_year",
  y_var="ObligatedAmount_OMB20_GDP20", #Name of variable to plot on y-axis
  color_var="entrant",       # name of coloration variable, as string
  facet_var="entrant",        # name of facet variable, as string
  legend=TRUE, #Include a legend
  caption=TRUE, #Include a source caption
  labels_and_colors=eid_lc,
  column_key=NULL
)+facet_wrap(~entrant,scales="free_y",ncol=1)+labs(x="Fiscal Year of Transaction",y="Obligations 2020 $")


build_plot(
  data=FPDS_eid_fyear ,
  chart_geom = "Bar Chart",
  # share = FALSE,
  x_var="fiscal_year",
  y_var="ObligatedAmount_OMB20_GDP20", #Name of variable to plot on y-axis
  color_var="sample_year",       # name of coloration variable, as string
  # facet_var="sample_year",        # name of facet variable, as string
  legend=TRUE, #Include a legend
  caption=TRUE, #Include a source caption
  labels_and_colors=eid_lc,
  column_key=NULL
)+labs(x="Fiscal Year of Transaction",y="Obligations 2020 $")


build_plot(
  data=FPDS_eid_fyear,
  chart_geom = "Bar Chart",
  # share = FALSE,
  x_var="fiscal_year",
  y_var="ObligatedAmount_OMB20_GDP20", #Name of variable to plot on y-axis
  color_var="sample_year",       # name of coloration variable, as string
  facet_var="sample_year",        # name of facet variable, as string
  legend=TRUE, #Include a legend
  caption=TRUE, #Include a source caption
  labels_and_colors=eid_lc,
  column_key=NULL
)+facet_wrap(~sample_year,scales="free_y",ncol=1)+
  labs(x="Fiscal Year of Transaction",y="Obligations 2020 $")


# 
# build_plot(
#   data=FPDS_cleaned_unique,
#   chart_geom = "Bar Chart",
#   # share = FALSE,
#   x_var="FYear",
#   y_var="total_obligations", #Name of variable to plot on y-axis
#   # color_var="entrant",       # name of coloration variable, as string
#   # facet_var="entrant",        # name of facet variable, as string
#   legend=TRUE, #Include a legend
#   caption=TRUE, #Include a source caption
#   labels_and_colors=eid_lc,
#   column_key=NULL
# )+labs(x="Fiscal Year of Contractor First Appearance",y="Obligations 2020 $")


```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


## Platform
``` {r NewPlat}



(eplatnew<-build_plot(defense_platform_vendor %>% filter(Fiscal_Year>=2008 &
                                    IsEntityAbove2018constant10ThousandThreshold==1 &
                                      PlatformPortfolio!="Unlabeled"&
                                      PlatformPortfolio!="Unlabeled"),
           chart_geom = "Bar Chart",
           x_var="dFYear",
           y_var="count",
           color_var="entrant_2018T",
           facet_var="PlatformPortfolio",
           # second_var="",
           labels_and_colors = ecp_lc,
           column_key = ecp_lc,
           format=TRUE)+
   labs(x="Fiscal Year",
         y="Count of Vendors above 2018 reporting threshold\n(Variable Scale)",
                             color="New Entrant",
        caption="Source: FPDS, CSIS analysis\nNote: Vendors with unlabeled platforms are not shown.")+
   facet_wrap(~PlatformPortfolio,scales="free_y")
)

write.csv(file=file.path("..","Output","def_entity_new_plat.csv"),row.names = FALSE, na = "",
          eplatnew$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlatformPortfolio,entrant_2018T),
                        names_from=Fiscal_Year,values_from=count)%>%
            arrange(PlatformPortfolio,entrant_2018T))

ggsave600dpi(file=file.path("..","Output","def_entity_new_plat_line.png"), eplatnew, 
             width=6.5, height= 4, units="in",size=9,lineheight = 0.75
             )

ggsave600dpi(file=file.path("..","Output","def_entity_new_plat_line.svg"), eplatnew, 
             width=6.5, height= 4, units="in",size=9,lineheight = 0.75
             )


summary(defense_platform_vendor$PlatformPortfolio)

(ecsplatnew<-build_plot(defense_platform_vendor %>% filter(Fiscal_Year>=2008 &
                                    IsEntityAbove2018constant10ThousandThreshold==1 &
                                      PlatformPortfolio!="Unlabeled"&
                                      PlatformPortfolio!="Unlabeled",
                                    PlatformPortfolio=="Electronics, Comms, & Sensors"),
           chart_geom = "Bar Chart",
           x_var="dFYear",
           y_var="count",
           color_var="entrant_2018T",
           # facet_var="PlatformPortfolio",
           # second_var="",
           labels_and_colors = ecp_lc,
           column_key = ecp_lc,
           format=TRUE)+
   labs(x="Fiscal Year",
         y="Count of Vendors above\n2018 reporting threshold",
                             color="New Entrant",
        title="Number of Defense Vendors in the\nElectronics, Comms, and Sensors Sector",
        caption="Source: FPDS, CSIS analysis")+
    theme(legend.position = "right")
)


ggsave600dpi(file=file.path("..","Output","def_ecs_entity_new_plat_line.png"), ecsplatnew, 
             width=3.75, height= 3, units="in",size=9,lineheight = 0.75
             )

ggsave600dpi(file=file.path("..","Output","def_ecs_entity_new_plat_line.svg"), ecsplatnew, 
             width=4, height= 3, units="in",size=9,lineheight = 0.75
             )

```

# Summary Trends
## Defense Count
```{r EntityCount}
eid_lc<-prepare_labels_and_colors(ec)
  
  (edef<-build_plot(ec %>% filter(Fiscal_Year>=2005 & Customer=="Defense"),
             chart_geom = "Line Chart",
             x_var="dFYear",
             y_var="EntityCount",
             color_var="IsEntityAbove2018constant10ThousandThreshold",
             # labels_and_colors = eid_lc,
             format=TRUE)+labs(x="Fiscal Year",y="Vendor Count")
  )
  summary(factor(ec$EntitySmall))
  summary(ec$EntitySmall)
  (edef<-build_plot(ec %>% filter(Fiscal_Year>=2005 & Customer=="Defense"&
                                    IsEntityAbove2018constant10ThousandThreshold==1),
             chart_geom = "Line Chart",
             x_var="dFYear",
             y_var="EntityCount",
             color_var="EntitySmall",
             labels_and_colors = eid_lc,
             format=TRUE)+labs(x="Fiscal Year",y="Vendor Count")
  )
  
  
  (edefbar<-build_plot(ec %>% filter(Fiscal_Year>=2005 & Customer=="Defense"&
                                    IsEntityAbove2018constant10ThousandThreshold==1),
             chart_geom = "Bar Chart",
             x_var="dFYear",
             y_var="EntityCount",
             color_var="EntitySmall",
             labels_and_colors = eid_lc,
             format=TRUE)+labs(x="Fiscal Year",y="Vendor Count")+
      scale_x_date(#date_breaks="3 years",
                   breaks = c(as.Date("2005/1/1"),
                                   as.Date("2008/1/1"),
                              as.Date("2011/1/1"),
                              as.Date("2014/1/1"),
                              as.Date("2017/1/1"),
                                   as.Date("2020/1/1")),date_labels = "'%y")
      #coord_cartesian(xlim=c(as.Date("2004/10/1"),as.Date("2020/9/30")))
  )
  
  # 
  # (edef<-build_plot(def_eid_fyear %>% filter(Fiscal_Year>=2005),
  #            chart_geom = "Line Chart",
  #            x_var="dFYear",
  #            y_var="EntityCount",
  #            # color_var="Small",
  #            labels_and_colors = eid_lc,
  #            format=TRUE)+labs(x="Fiscal Year",y="Vendor Count")
  # )
  ggsave600dpi(file.path("..","Output","def_entity_count_bar.png"), edefbar+ theme(legend.position = "right"),#guides(fill = guide_legend(nrow = 2)), 
               width=6.5, height= 3, units="in",size=11,lineheight = 0.75
               )
  
  ggsave600dpi(file.path("..","Output","def_entity_count_bar.svg"), edefbar+ theme(legend.position = "right"),#guides(fill = guide_legend(nrow = 2)), 
               width=6.5, height= 3, units="in",size=11,lineheight = 0.75
               )
  # ggsave600dpi(file.path("..","Output","def_entity_count.png"), edef, 
  #              width=6.5, height= 4, units="in",size=11,lineheight = 0.75
  #              )
  
  
    write.csv(file=file.path("..","Output","def_entity_count.csv"),row.names = FALSE, na = "",
              edefbar$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
                pivot_wider(id_cols=c(EntitySmall),
                            names_from=Fiscal_Year,values_from=EntityCount)%>% arrange(EntitySmall))
  
  ec$thresh<-factor(ec$IsEntityAbove2016constantOneMillionThreshold,
                     levels=c(0,1), labels=c("Vendor only receives smaller contracts","Vendor receives contracts over $1 million in 2016 $"))
  (eplat<-build_plot(ec %>% filter(Fiscal_Year>=2005 &
                                      IsEntityAbove2018constant10ThousandThreshold==1&
                                     Customer=="Defense"),
             chart_geom = "Bar Chart",
             x_var="dFYear",
             y_var="EntityCount",
             color_var="thresh",
             # second_var="",
             # labels_and_colors = eid_lc,
             format=TRUE)+labs(x="Fiscal Year",y="Vendor Count")
  )+labs(color="Vendor receives over $1 million threshold in 2016 $s")
  
  (build_plot(ec %>% filter(Fiscal_Year>=2005 &
                                      IsEntityAbove2018constant10ThousandThreshold==1&
                                     Customer=="Defense"),
             chart_geom = "Bar Chart",
             x_var="dFYear",
             y_var="Action_Obligation",
             color_var="EntitySizeText",
             facet_var="IsEntityAbove2016constantOneMillionThreshold",
             labels_and_colors = eid_lc,
             format=TRUE)+labs(x="Fiscal Year",y="Obligations")
  )#+facet_wrap(~PlatformPortfolio,scale="free_y")
  
  (build_plot(ec %>% filter(Fiscal_Year>=2005 &
                                      IsEntityAbove2018constant10ThousandThreshold==1&
                                     Customer=="Defense"),
             chart_geom = "Bar Chart",
             x_var="dFYear",
             y_var="Action_Obligation",
             color_var="EntitySizeText",
             facet_var="IsEntityAbove2016constantOneMillionThreshold",
             labels_and_colors = eid_lc,
             share=TRUE,
             format=TRUE)+labs(x="Fiscal Year",y="Obligations")
  )#+facet_wrap(~PlatformPortfolio,scale="free_y")
  
  
  ec %>% filter() %>% group_by(IsEntityAbove2016constantOneMillionThreshold,Fiscal_Year) %>%
            dplyr::summarise(act=sum(Action_Obligation))%>%group_by(Fiscal_Year)%>%mutate(act=act/sum(act))
  
  
  
```
## Platform
```{r PlatEntityCount}


(eplat<-build_plot(ecp %>% filter(Fiscal_Year>=2005 &
                                    IsEntityAbove2018constant10ThousandThreshold==1&
                                    PlatformPortfolio!="Unlabeled"),
           chart_geom = "Bar Chart",
           x_var="dFYear",
           y_var="EntityCount",
           color_var="thresh",
           facet_var="PlatformPortfolio",
           # second_var="",
           # labels_and_colors = ecp_lc,
           format=TRUE)+labs(x="Fiscal Year",y="Vendor Count")+
   labs(color="Vendor receives over $1 million threshold in 2016 $s")+
   labs(title="Defense Contractor Count, 2005-2020",x="Fiscal Year"
        ,y="Number of Entities with Contracts\nValued over $10k (2018 Constant $s)",
        caption="Notes: Some entities appear in multiple categories. Entities with unlabeled platforms not shown.
        Source: FPDS including Duns & Bradstreet identifiers, CSIS roll-ups and analysis.")
)

(eplatbar<-build_plot(ecp %>% filter(Fiscal_Year>=2005 &
                                    IsEntityAbove2018constant10ThousandThreshold==1&
                                    PlatformPortfolio!="Unlabeled"),
           chart_geom = "Bar Chart",
           x_var="dFYear",
           y_var="EntityCount",
           color_var="EntitySmall",
           facet_var="PlatformPortfolio",
           # second_var="",
           labels_and_colors = ecp_lc,
           format=TRUE)+labs(x="Fiscal Year",y="Vendor Count")+facet_wrap(~PlatformPortfolio,scale="free_y")+
   labs(title="Defense Contractor Count, 2005-2020",x="Fiscal Year"
        ,y="Number of Entities with Contracts\nValued over $10k (2018 Constant $s)",
        caption="Notes: Some entities appear in multiple categories. Unlabeled platform not shown.
        Source: FPDS including Duns & Bradstreet identifiers, CSIS roll-ups and analysis.")
)



(eplatbar<-build_plot(ecp %>% filter(Fiscal_Year>=2005 &
                                    IsEntityAbove2018constant10ThousandThreshold==1&
                                    PlatformPortfolio!="Unlabeled"),
           chart_geom = "Bar Chart",
           x_var="dFYear",
           y_var="EntityCount",
           color_var="EntitySmall",
           facet_var="PlatformPortfolio",
           # second_var="",
           labels_and_colors = ecp_lc,
           format=TRUE)+ labs(title="Defense Contractor Count, 2005-2020",x="Fiscal Year"
        ,y="Number of Entities with Contracts\nValued over $10k (2018 Constant $s)",
        caption="Notes: Some entities appear in multiple categories. Entities with unlabeled platforms not shown.
        Source: FPDS including Duns & Bradstreet identifiers, CSIS roll-ups and analysis.")+
    facet_wrap(~PlatformPortfolio,ncol=6)+scale_x_date("Fiscal Year",labels = scales::label_date("'%y"),date_breaks = "3 years"))



write.csv(file=file.path("..","Output","def_entity_size_count_plat.csv"),row.names = FALSE, na = "",
          eplatline$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlatformPortfolio),
                        names_from=Fiscal_Year,values_from=EntityCount))

ggsave600dpi(file=file.path("..","Output","def_entity_size_count_plat_line.png"), eplatline, 
             width=6.5, height= 4, units="in",size=9,lineheight = 0.75
             )

(eplatline<-build_plot(ecp %>% filter(Fiscal_Year>=2005 &
                                    IsEntityAbove2018constant10ThousandThreshold==1&
                                    PlatformPortfolio!="Unlabeled"),
           chart_geom = "Line Chart",
           x_var="dFYear",
           y_var="EntityCount",
           # color_var="PlatformPortfolio",
           facet_var="PlatformPortfolio",
           # second_var="",
           labels_and_colors = ecp_lc,
           format=TRUE)+facet_wrap(~PlatformPortfolio,ncol=6)+scale_x_date("Fiscal Year",labels = scales::label_date("'%y"),date_breaks = "3 years")+ labs(title="Defense Contractor Count, 2005-2020",x="Fiscal Year"
        ,y="Number of Entities with Contracts\nValued over $10k (2018 Constant $s)",
        caption="Notes: Some entities appear in multiple categories. Entities with unlabeled platforms not shown.
        Source: FPDS including Duns & Bradstreet identifiers, CSIS roll-ups and analysis.")
)

write.csv(file=file.path("..","Output","def_entity_count_plat.csv"),row.names = FALSE, na = "",
          eplatline$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlatformPortfolio),
                        names_from=Fiscal_Year,values_from=EntityCount))

ggsave600dpi(file=file.path("..","Output","def_entity_count_plat_line.png"), eplatline, 
             width=6.5, height= 4, units="in",size=9,lineheight = 0.75
             )

(eplat<-build_plot(ecp %>% filter(Fiscal_Year>=2005 &
                                    IsEntityAbove2018constant10ThousandThreshold==1&
                                    PlatformPortfolio!="Unlabeled"),
           chart_geom = "Bar Chart",
           x_var="dFYear",
           y_var="Action_Obligation",
           color_var="EntitySizeText",
           facet_var="IsEntityAbove2016constantOneMillionThreshold",
           second_var="PlatformPortfolio",
           # labels_and_colors = ecp_lc,
           format=TRUE)+labs(x="Fiscal Year",y="Vendor Count")+ labs(title="Defense Contractor Count, 2005-2020",x="Fiscal Year"
        ,y="Number of Entities with Contracts\nValued over $10k (2018 Constant $s)",
        caption="Notes: Some entities appear in multiple categories. Entities with unlabeled platforms not shown.
        Source: FPDS including Duns & Bradstreet identifiers, CSIS roll-ups and analysis.")
)#+facet_wrap(~PlatformPortfolio,scale="free_y")



ecp %>% group_by(IsEntityAbove2016constantOneMillionThreshold,Fiscal_Year) %>%
          dplyr::summarise(act=sum(Action_Obligation))%>%group_by(Fiscal_Year)%>%mutate(act=act/sum(act))

write.csv(file=file.path("..","Output","def_entity_count_plat_line.csv"),row.names = FALSE, na = "",
          eplatline$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlatformPortfolio),
                        names_from=Fiscal_Year,values_from=EntityCount))
```


### Platform Portfolio HHI
```{r Platform, fig.width=6.5 , fig.height=3.25}

library(readr)
annual_platform_summary<-read_csv(file="..//Output//annual_platform_summary.csv")
colnames(annual_platform_summary)[colnames(annual_platform_summary)=="platformPortfolio"]<-"PlatformPortfolio"

platform_no_na<-subset(annual_platform_summary,PlatformPortfolio!="Unlabeled")
labels_and_colors<-csis360::prepare_labels_and_colors(platform_no_na,"PlatformPortfolio")



platform_no_na$plat_short <-factor_wrap(platform_no_na$PlatformPortfolio,nwrap = 21)
platform_no_na<-subset(platform_no_na,Fiscal_Year>=2000 & Fiscal_Year<=2020)
platform_no_na<-apply_standard_lookups(platform_no_na)
 

# plat<-ggplot(platform_no_na,
#        aes(x=Fiscal_Year,y=hh_index))+#color=NAICS_Code
#   geom_line()+
#   scale_y_continuous(label=scales::comma)+ 
#   # scale_x_continuous(breaks=c(2006,2009,2011,2014))+
#   labs(x="Fiscal Year",y="Herfindahl-Herschman Index")+ 
#   geom_hline(yintercept=c(1500,2500),linetype="dotted")+
#   facet_wrap(~plat_short)
# add_preassigned_scales(plat,labels_and_colors = labels_and_colors)

# str(platform_no_na)
# summary(platform_no_na$Fiscal_Year)
#
# undebug(add_preassigned_scales)
plat_hhi<-build_plot(
  data=platform_no_na,
  chart_geom = "Line Chart",
  share = FALSE,
  x_var="dFYear",
  y_var="hh_index", #Name of variable to plot on y-axis
  color_var="PlatformPortfolio",       # name of coloration variable, as string
  facet_var="PlatformPortfolio",        # name of facet variable, as string
  legend=FALSE, #Include a legend
  caption=FALSE, #Include a source caption
  labels_and_colors=labels_and_colors,
  column_key=NULL
)


# add_preassigned_scales(plat, labels_and_colors,  var="PlatformPortfolio"

plat_hhiz<-plat_hhiz+geom_hline(yintercept=c(1500,2500),linetype="dotted")+
  labs(x="Fiscal Year",y="Herfindahl-Herschman Indetx")
plat_hhiz
ggsave(plat_hhiz+geom_line(aes(x=dFYear,y=hh_index,color=PlatformPortfolio),size=1),filename="..//Output//platform_hhi.png",height=3.25, width=6.5)
ggsave(plat_hhiz+geom_line(aes(x=dFYear,y=hh_index)),filename="..//Output//platform_hhi_bw.png",height=3.25, width=6.5)
ggsave(plat_hhiz+geom_line(aes(x=dFYear,y=hh_index,color=PlatformPortfolio),size=1),filename="..//Output//platform_hhi.eps",height=3.25, width=6.5)
ggsave(plat_hhiz+geom_line(aes(x=dFYear,y=hh_index)),filename="..//Output//platform_hhi_bw.eps",height=3.25, width=6.5)


write.csv(file=file.path("..","Output","platform_hhi.csv"),row.names = FALSE, na = "",
          plat_hhi$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(PlatformPortfolio),
                        names_from=Fiscal_Year,values_from=hh_index))

```

## SubCustomer
```{r SubCustEntityCount}

(esub<-build_plot(ecsub  %>% filter(Fiscal_Year>=2005 & IsEntityAbove2018constant10ThousandThreshold==1),
           chart_geom = "Line Chart",
           x_var="dFYear",
           y_var="EntityCount",
           facet_var="SubCustomer",
           color_var="EntitySmall",
           labels_and_colors = ecp_lc,
           format=TRUE)+labs(x="Fiscal Year",y="Vendor Count")
)+facet_wrap(~SubCustomer,scale="free_y")


ggsave600dpi(file.path("..","Output","def_entity_count_plat.png"), eplat, 
             width=6.5, height= 4, units="in",size=11,lineheight = 0.75
             )


write.csv(file=file.path("..","Output","def_entity_count_subcust.csv"),row.names = FALSE, na = "",
          esub$data%>% mutate(Fiscal_Year=lubridate::year(dFYear))%>%
            pivot_wider(id_cols=c(SubCustomer,EntitySmall),
                        names_from=Fiscal_Year,values_from=EntityCount))
```




# Top Vendors
## Dunsnumber
### Defense Portfolio
```{r TopDefensePortfolio}
# 
# dataplat$ContractorDisplayName[dataplat$ContractorDisplayName=="087689394^"]<-"DEPARTMENT OF ENERGY^"
#Label
# 
# dataplat$ContractorDisplayName[dataplat$ContractorDisplayName=="020016718^"]<-"ROLLS ROYCE SOLUTIONS AMERICA^" # Label


#https://spacenews.com/aerojet-rocketdyne-buying-target-missile-maker-coleman-aerospace/

defense_platformUAV_contractor<-dataplat


defense_platformUAV_contractor<-defense_platformUAV_contractor %>%
  group_by(PlatformPortfolioUAV,Fiscal_Year,IsDefense,ContractorDisplayName) %>%
  dplyr::summarise(Action_Obligation=sum(Action_Obligation))%>%
  group_by(PlatformPortfolioUAV,Fiscal_Year,IsDefense) %>%
  dplyr::mutate(
    pos = rank(-Action_Obligation,
               ties.method ="min"),
    pct = ifelse(Action_Obligation>0,
                 Action_Obligation / sum(Action_Obligation[Action_Obligation>0]),
                 NA
    )
  )

topplatduns<-defense_platformUAV_contractor%>% filter(pos<=10)%>% arrange(Fiscal_Year,pos)

# FPDS_eid_fyear <- read.delim(file.path("../Data/semi_clean/Vendor.EntityIDhistory.txt"), header=TRUE,  na.strings = c("", "NULL"))
# FPDS_eid_fyear$EntityID<-text_to_number(FPDS_eid_fyear$EntityID)
# FPDS_eid_fyear<-standardize_variable_names(FPDS_eid_fyear)
# colnames(FPDS_eid_fyear)
# defense_platformUAV_contractor<-left_join(defense_platformUAV_contractor,FPDS_eid_fyear %>% dplyr::select(-Action_Obligation,-NumberOfActions),
#                                       by=c("EntityID","Fiscal_Year"))
# colnames(defense_platformUAV_contractor)

topplatannualduns<-defense_platformUAV_contractor %>%
  dplyr::mutate(TopVendText=ifelse(pos<=10,ContractorDisplayName,"All Other"),
         Toppos=ifelse(pos<=10,pos,0)) %>%
  dplyr::group_by(Fiscal_Year,PlatformPortfolioUAV,IsDefense,TopVendText,Toppos) %>%
  dplyr::summarize(Action_Obligation=sum(Action_Obligation,na.rm=TRUE)) %>%
  arrange(Fiscal_Year,IsDefense,PlatformPortfolioUAV,Toppos)

topplatannualduns<-deflate(topplatannualduns,money_var="Action_Obligation")


top5platannualduns<-defense_platformUAV_contractor %>%
  dplyr::mutate(TopVendText=ifelse(pos<=5,ContractorDisplayName,"All Other"),
                Toppos=ifelse(pos<=5,pos,NA)) %>%
  dplyr::group_by(Fiscal_Year,PlatformPortfolioUAV,IsDefense,TopVendText,Toppos) %>%
  dplyr::summarize(Action_Obligation=sum(Action_Obligation,na.rm=TRUE)) %>% 
  arrange(Fiscal_Year,IsDefense,PlatformPortfolioUAV,Toppos)

write.csv(file=file.path("..","Output","Defense_TopVendorPlatform.csv"),
          top5platannualduns %>% filter(IsDefense==1 & !is.na(PlatformPortfolioUAV) & Fiscal_Year==2021 ),
          row.names = FALSE)


write.csv(file=file.path("..","Output","Defense_TopVendorPlatform.csv"),
          topplatannualduns %>% filter(IsDefense==1 & !is.na(PlatformPortfolioUAV) & Fiscal_Year==2021 ),
          row.names = FALSE)

```

### Army Portfolio
```{r ArmyDefensePortfolio}

# 
# dataplat$ContractorDisplayName[dataplat$ContractorDisplayName=="087689394^"]<-"DEPARTMENT OF ENERGY^"
#Label
# 
# dataplat$ContractorDisplayName[dataplat$ContractorDisplayName=="020016718^"]<-"ROLLS ROYCE SOLUTIONS AMERICA^" # Label

army_platformUAV_contractor$

army_platformUAV_contractor<-dataplat %>% filter(SubCustomer=="Army")


army_platformUAV_contractor<-army_platformUAV_contractor %>%
  group_by(PlatformPortfolioUAV,Fiscal_Year,SubCustomer,ContractorDisplayName) %>%
  dplyr::summarise(Action_Obligation=sum(Action_Obligation,
                                         max()))%>%
  group_by(PlatformPortfolioUAV,Fiscal_Year,SubCustomer) %>%
  dplyr::mutate(
    pos = rank(-Action_Obligation,
               ties.method ="min"),
    pct = ifelse(Action_Obligation>0,
                 Action_Obligation / sum(Action_Obligation[Action_Obligation>0]),
                 NA
    )
  )

topplatduns<-army_platformUAV_contractor%>% filter(pos<=10)%>% arrange(Fiscal_Year,pos)

# FPDS_eid_fyear <- read.delim(file.path("../Data/semi_clean/Vendor.EntityIDhistory.txt"), header=TRUE,  na.strings = c("", "NULL"))
# FPDS_eid_fyear$EntityID<-text_to_number(FPDS_eid_fyear$EntityID)
# FPDS_eid_fyear<-standardize_variable_names(FPDS_eid_fyear)
# colnames(FPDS_eid_fyear)
# army_platformUAV_contractor<-left_join(army_platformUAV_contractor,FPDS_eid_fyear %>% dplyr::select(-Action_Obligation,-NumberOfActions),
#                                       by=c("EntityID","Fiscal_Year"))
# colnames(army_platformUAV_contractor)

topplatannualduns<-army_platformUAV_contractor %>%
  dplyr::mutate(TopVendText=ifelse(pos<=10,ContractorDisplayName,"All Other"),
         Toppos=ifelse(pos<=10,pos,0)) %>%
  dplyr::group_by(Fiscal_Year,PlatformPortfolioUAV,SubCustomer,TopVendText,Toppos) %>%
  dplyr::summarize(Action_Obligation=sum(Action_Obligation,na.rm=TRUE)) %>%
  arrange(Fiscal_Year,SubCustomer,PlatformPortfolioUAV,Toppos)

topplatannualduns<-deflate(topplatannualduns,money_var="Action_Obligation")


top5platannualduns<-army_platformUAV_contractor %>%
  dplyr::mutate(TopVendText=ifelse(pos<=5,ContractorDisplayName,"All Other"),
                Toppos=ifelse(pos<=5,pos,NA)) %>%
  dplyr::group_by(Fiscal_Year,PlatformPortfolioUAV,SubCustomer,TopVendText,Toppos) %>%
  dplyr::summarize(Action_Obligation=sum(Action_Obligation,na.rm=TRUE)) %>% 
  arrange(Fiscal_Year,SubCustomer,PlatformPortfolioUAV,Toppos)

write.csv(file=file.path("..","Output","Army_TopVendorPlatform.csv"),
          top5platannualduns %>% filter(SubCustomer=="Army" & !is.na(PlatformPortfolioUAV) & Fiscal_Year==2021 ),
          row.names = FALSE)

  
  write.csv(file=file.path("..","Output","Army_TopVendorPlatform.csv"),
            topplatannualduns %>% filter(SubCustomer=="Army" & !is.na(PlatformPortfolioUAV) & Fiscal_Year==2021 ),
            row.names = FALSE)

```


### Army Small Business Portfolio
```{r ArmyDefensePortfolio}

# 
# dataplat$ContractorDisplayName[dataplat$ContractorDisplayName=="087689394^"]<-"DEPARTMENT OF ENERGY^"
#Label
# 
# dataplat$ContractorDisplayName[dataplat$ContractorDisplayName=="020016718^"]<-"ROLLS ROYCE SOLUTIONS AMERICA^" # Label

army_platformUAV_contractor<-dataplat %>% filter(SubCustomer=="Army")


army_platformUAV_contractor<-army_platformUAV_contractor %>%
  group_by(PlatformPortfolioUAV,Fiscal_Year,SubCustomer,ContractorDisplayName) %>%
  dplyr::summarise(Action_Obligation=sum(Action_Obligation))%>%
  group_by(PlatformPortfolioUAV,Fiscal_Year,SubCustomer) %>%
  dplyr::mutate(
    pos = rank(-Action_Obligation,
               ties.method ="min"),
    pct = ifelse(Action_Obligation>0,
                 Action_Obligation / sum(Action_Obligation[Action_Obligation>0]),
                 NA
    )
  )

topplatduns<-army_platformUAV_contractor%>% filter(pos<=10)%>% arrange(Fiscal_Year,pos)

# FPDS_eid_fyear <- read.delim(file.path("../Data/semi_clean/Vendor.EntityIDhistory.txt"), header=TRUE,  na.strings = c("", "NULL"))
# FPDS_eid_fyear$EntityID<-text_to_number(FPDS_eid_fyear$EntityID)
# FPDS_eid_fyear<-standardize_variable_names(FPDS_eid_fyear)
# colnames(FPDS_eid_fyear)
# army_platformUAV_contractor<-left_join(army_platformUAV_contractor,FPDS_eid_fyear %>% dplyr::select(-Action_Obligation,-NumberOfActions),
#                                       by=c("EntityID","Fiscal_Year"))
# colnames(army_platformUAV_contractor)

topplatannualduns<-army_platformUAV_contractor %>%
  dplyr::mutate(TopVendText=ifelse(pos<=10,ContractorDisplayName,"All Other"),
         Toppos=ifelse(pos<=10,pos,0)) %>%
  dplyr::group_by(Fiscal_Year,PlatformPortfolioUAV,SubCustomer,TopVendText,Toppos) %>%
  dplyr::summarize(Action_Obligation=sum(Action_Obligation,na.rm=TRUE)) %>%
  arrange(Fiscal_Year,SubCustomer,PlatformPortfolioUAV,Toppos)

topplatannualduns<-deflate(topplatannualduns,money_var="Action_Obligation")


top5platannualduns<-army_platformUAV_contractor %>%
  dplyr::mutate(TopVendText=ifelse(pos<=5,ContractorDisplayName,"All Other"),
                Toppos=ifelse(pos<=5,pos,NA)) %>%
  dplyr::group_by(Fiscal_Year,PlatformPortfolioUAV,SubCustomer,TopVendText,Toppos) %>%
  dplyr::summarize(Action_Obligation=sum(Action_Obligation,na.rm=TRUE)) %>% 
  arrange(Fiscal_Year,SubCustomer,PlatformPortfolioUAV,Toppos)

write.csv(file=file.path("..","Output","Army_TopVendorPlatform.csv"),
          top5platannualduns %>% filter(SubCustomer=="Army" & !is.na(PlatformPortfolioUAV) & Fiscal_Year==2021 ),
          row.names = FALSE)

  
  write.csv(file=file.path("..","Output","Army_TopVendorPlatform.csv"),
            topplatannualduns %>% filter(SubCustomer=="Army" & !is.na(PlatformPortfolioUAV) & Fiscal_Year==2021 ),
            row.names = FALSE)

```
