---
title: "Consolidation Codebook"
output:
  html_document:
    keep_md: yes
    toc: yes
date: "Thursday, July 11, 2017"
---

# Setup
First we load the data. The dataset used is a U.S. Defense Contracting dataset derived from   FPDS.

```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(arm)
library(R2WinBUGS)
library(knitr)
library(foreign)
library(stargazer)
library(texreg)
library(reshape2)
library(tidyverse)
source("https://raw.githubusercontent.com/CSISdefense/Vendor/master/Scripts/DIIGstat.r")


axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40
load(file="../Data/Clean/JSCAN//transformed_def.Rdata")


# debug(statsummary_discrete)
statsummary_discrete("Agency",def,accuracy=0.01,
                                 value_col=NULL,
                                 top_rank=5)

grouped_barplot("Agency",def,top_rank = 5)

debug(grouped_barplot)
grouped_barplot("Agency",def)
# Percent_Actions <- def %>% group_by(unquo(x)) %>%
#     summarise(
#       Records=sum(unquo(value_col)),
#       Actions=length(unquo(x))
#     )




```


Contracts are classified using a mix of numerical and categorical variables. While the changes in numerical variables are easy to grasp and summarize, a contract may have one line item that is competed and another that is not. As is detailed in the exploration on R&D, we are only considering information available prior to contract start. The percentage of contract obligations that were competed is a valuable benchmark, but is highly influenced by factors that occured after contract start.


# Dependent Variables

### Number of  Offers
summary(def$offer)
centered_description(def$UnmodifiedNumberOfOffersReceived,"number of offers")
centered_log_description(def$UnmodifiedNumberOfOffersReceived,"number of offers")
NA_stats(def,"cl_Offr")


```{r NumOffers}

statsummary_continuous(c("UnmodifiedNumberOfOffersReceived"), def)
grouped_barplot("Offr", def)

```



### Ceiling  Breaches
The base variables for b_CBre and  cln_CBre are is CBre and n_CBre_Then_Year
* b_CBre ("Any Ceiling Breach") is a binary variable that reports whether a contract had its cost ceiling increased via a change order.
sum(def$Action_Obligation[def$b_CBre==1],na.rm=TRUE)/sum(def$Action_Obligation,na.rm=TRUE)
NA_stats(def,"b_CBre")`)
* ln_CBre ("Any Ceiling Breach") is a continuous variable that reports the increased contract ceiling due to change orders, logged, in 2018 constant dollars based on contract start fiscal year. The dataset for these models is limited to contracts with any ceiling breaches, in order to avoid clustering at zero-based problems.  `r centered_log_description(def$n_CBre_OMB20_GDP18,"dollars")`

```{r vargraphs: b_Term, b_CBre}
#The original variables for b_Term and b_CBre are Term and CBre
# grouped_barplot("CBre", def)
# statsummary_discrete(c("CBre"), def)


statsummary_continuous(c("n_CBre_Then_Year"), def)


(
  cbre_plot<-ggplot(def %>% filter(b_CBre==1 & !is.na(qHighCeiling)), aes(x=n_CBre_Then_Year)) +
    geom_histogram(bins=100)+
    theme(axis.text.x = element_text(angle = 90, hjust = 1))+
    scale_x_log10(label=scales::comma, breaks =c(0,1e3,1e6,1e8))+
    scale_y_continuous(label=scales::comma)+
    scale_x_log10(label=scales::comma, breaks =c(0,1,50,1e3,5e4,1e6,5e7,1e9))+
    coord_cartesian(xlim = c(1, round(max(def$n_CBre_Then_Year,na.rm=TRUE),-9)))+
    facet_wrap(~qHighCeiling,scales="free_y")+
    labs(y="Count of Contracts that Experienced\na Ceiling Breach (Variable Scale)",x="Ceiling Breach Size on a Logarithmic Scale")#+, space="free_y"
  
  #+geom_vline(xintercept = 0.1)+
  #facet_grid(NoPreTermObl~.,scales="free_y", space="free_y")+
  # labs(title="Distribution of Contracts with Obligations After Last termination",
  #      y="Contract Count",
  #      x="Percent of Obligations After Day of Termination",
  #      fill="Termination Completion"
)

ggsave(cbre_plot+theme(text=element_text(size=13))+labs(y="Count of Contracts that Experienced\na Ceiling Breach (Variable Scale)",x="Ceiling Breach Size on a Logarithmic Scale"),file="..//Output\\JSCAN\\Figure1.png",width=9.5,height=4,dpi=600)
ggsave(cbre_plot+theme(text=element_text(size=13))+labs(y="Count of Contracts that Experienced\na Ceiling Breach (Variable Scale)",x="Ceiling Breach Size on a Logarithmic Scale"),file="..//Output\\JSCAN\\Figure1.eps",width=9.5,height=4,dpi=600)

ggsave(cbre_plot+theme(text=element_text(size=13))+labs(y="Count of Contracts that Experienced\na Ceiling Breach (Variable Scale)",x="Ceiling Breach Size on a Logarithmic Scale"),file="..//Output\\JSCAN\\Figure1.svg",width=9.5,height=4,dpi=600)

```


### Contract Terminations

Contract terminations and the number of change orders can be calculated for the entire sample.  Contract termination is determined using the *Reason for Modification* field in FPDS.  A contract is considered to be terminated if it has at least one modification with the following values:

* "Terminate for Default (complete or partial)"
* "Terminate for Convenience (complete or partial)"
* "Terminate for Cause"
* "Legal Contract Cancellation"

These four categories and the "Close Out" category are used to mark a contract as closed.  Many contracts in FPDS and in the sample are never marked closed.  



NA_stats(def,"b_Term")
* b_Term is a binary variable that has a value of 1 for any contracts that have experienced a partial or complete termination, 0 otherwise. (`r summary(def$b_Term);
sum(def$Action_Obligation.OMB20_GDP18[def$b_Term==1],na.rm=TRUE)/sum(def$Action_Obligation.OMB20_GDP18,na.rm=TRUE)`

```{r vargraphs: b_Term, b_CBre}
#The original variables for b_Term and b_CBre are Term and CBre
grouped_barplot("Term", def)
statsummary_discrete(c("b_Term"), def)

#Overlaping ceiling breach and termination
nrow(def %>% filter(b_Term==1 & b_CBre==1))
sum((def %>% filter(b_Term==1 & b_CBre==1))$Action_Obligation_Then_Year)

```






# Independent Variables

## Study Variables



### Competition
* b_Comp is a binary variable based on competition. It has a value of 0 for uncompeted contracts and a value of 1 for competition, regardless of number of offers. `r  summary(def$Comp);
NA_stats(def,"Comp") `
* n_Comp is a binary variable based on competition. It has a value of 0 for uncompeted contracts and a value of 1 for competition, regardless of number of offers. `r  summary(def$EffComp);
NA_stats(def,"EffComp")
sum(def$Action_Obligation[def$EffComp=="No Comp."],na.rm=TRUE)/sum(def$Action_Obligation,na.rm=TRUE)
sum(def$Action_Obligation[def$EffComp=="1 Offer"],na.rm=TRUE)/sum(def$Action_Obligation,na.rm=TRUE)
sum(def$Action_Obligation[def$EffComp=="2+ Offers"],na.rm=TRUE)/sum(def$Action_Obligation,na.rm=TRUE)`
)


* CompOffr is a dummy variable based on competition and the number of offers. It's baseline value is No Competition, sole-source contracts, which are intentionally not assigned a dummy to avoid multicollinearity. `r  summary(def$CompOffr);
debug(NA_stats)
NA_stats(def,"CompOffr")
sum(def$Action_Obligation[def$CompOffr=="No Competition"],na.rm=TRUE)/sum(def$Action_Obligation,na.rm=TRUE)
sum(def$Action_Obligation[def$CompOffr=="1 offer"],na.rm=TRUE)/sum(def$Action_Obligation,na.rm=TRUE)
sum(def$Action_Obligation[def$CompOffr=="2 offers"],na.rm=TRUE)/sum(def$Action_Obligation,na.rm=TRUE)
sum(def$Action_Obligation[def$CompOffr=="3-4 offers"],na.rm=TRUE)/sum(def$Action_Obligation,na.rm=TRUE)
sum(def$Action_Obligation[def$CompOffr=="5+ offers"],na.rm=TRUE)/sum(def$Action_Obligation,na.rm=TRUE)

length(def$CompOffr[def$CompOffr=="No Competition" & !is.na(def$CompOffr)])/nrow(def)
length(def$CompOffr[def$CompOffr=="1 offer"& !is.na(def$CompOffr)])/nrow(def)
length(def$CompOffr[def$CompOffr=="2 offers"& !is.na(def$CompOffr)])/nrow(def)
length(def$CompOffr[def$CompOffr=="3-4 offers"& !is.na(def$CompOffr)])/nrow(def)
length(def$CompOffr[def$CompOffr=="5+ offers"& !is.na(def$CompOffr)])/nrow(def)

`
)



```{r Competition}  
# grouped_barplot("Comp",def)
# grouped_barplot("EffComp",def)
grouped_barplot("CompOffr", def)
statsummary_discrete(c("CompOffr"), def)


summary(def$offer)
centered_description(def$UnmodifiedNumberOfOffersReceived,"number of offers")
centered_log_description(def$UnmodifiedNumberOfOffersReceived,"number of offers")
statsummary_continuous(def,"cl_Offr")
# <!-- cl_def3_HHI_lag1+cl_def3_ratio_lag1+#cl_def3_obl_lag1+ -->
#                             <!-- #cl_US3_avg_sal_lag1+ -->
#                             <!-- cl_def6_HHI_lag1+cl_def6_obl_lag1+cl_def6_ratio_lag1+ -->
#                             <!-- cl_US6_avg_sal_lag1Const+ -->



# Effplot<-freq_discrete_plot(subset(def,"EffComp"))
# Effplot<-Effplot+labs(x="Effective Competition",y="Contract or Task Order Count")
# ggsave(Effplot,file="..\\Output//EffFreq.png",width=5.5,height=5.5,dpi=600)
```


##### Subsector HHI
NA_stats(def,"def3_HHI_lag1")
centered_description(def$def3_HHI_lag1,"HHI score")
centered_log_description(def$def3_HHI_lag1,"HHI score")

NA_stats(def,"def3_HHI_lag1")
NA_stats(def,"cl_def3_HHI_lag1")


##### Detailed Industry HHI                            

* cl_def6_HHI_lag1 is a numeric variable based on the HHI Index of a NAICS code for defense contracting. Index values of 1500 and below are considered unconsolidated. 1500-2000 is considered moderately consolidated. And 2,000 and above are considered highly consolidated. The scale runs from 0 to 10,000. `r summary(def$cl_def6_HHI_lag1);
summary(def$l_def6_HHI_lag1);
centered_description(def$def6_HHI_lag1,"HHI score")
centered_log_description(def$l_def6_HHI_lag1,"HHI score")

                            
NA_stats(def,"def6_HHI_lag1")


`
```{r statistic summary table for continuous variables: cl_def_HHI_lag1, cl_def_ratio_lag1, cl_US_avg_sal_lag1, cl_def_obl_lag1, all use original variables instead}

# !is.na(def$cl_US6_avg_sal_lag1Const)&
#   !is.na(def$pPBSC)&
# !is.na(def$pOffPSC)&

HHI_category<-c("def3_HHI_lag1","def6_HHI_lag1")
complex_category <- c("US6_avg_sal_lag1","CFTE_Rate_1year")
capacity_category <- c("pPBSC", "pOffPSC")
pair_category <- c("office_entity_ca_inc")

# def$CFTE_Rate_1year
statsummary_discrete("CompOffr",def)

def$office_entity_ca_inc<-def$office_entity_numberofactions_1year+1
hhi<-statsummary_continuous(HHI_category, def)
hhi
write.csv(hhi,file="..\\Output/hhi_summary.csv")
statsummary_continuous(complex_category, def)
statsummary_continuous(capacity_category, def,log=FALSE)
statsummary_continuous(pair_category, def)

centered_log_description(def$def3_obl_lag1,"obligations")
centered_log_description(def$def6_obl_lag1,"obligations")
NA_stats(def,"cl_def3_obl_lag1")

NA_stats(def,"cl_def6_obl_lag1")

centered_log_description(def$def3_ratio_lag1,"obligations")

centered_log_description(def$def6_ratio_lag1,"obligations")
NA_stats(def,"cl_def3_ratio_lag1")
NA_stats(def,"cl_def6_ratio_lag1")



```

```{r statistic summary table for continuous variables: cl_def_HHI_lag1, cl_def_ratio_lag1, cl_US_avg_sal_lag1, cl_def_obl_lag1, all use original variables instead}
ratio_category <- c("capped_def6_ratio_lag1", "capped_def5_ratio_lag1", "capped_def4_ratio_lag1", "capped_def3_ratio_lag1", "capped_def2_ratio_lag1")
avg_category <- c("US6_avg_sal_lag1", "US5_avg_sal_lag1", "US4_avg_sal_lag1", "US3_avg_sal_lag1", "US2_avg_sal_lag1")
obl_category <- c("def6_obl_lag1", "def5_obl_lag1", "def4_obl_lag1", "def3_obl_lag1", "def2_obl_lag1" )

statsummary_discrete("CompOffr",def)



statsummary_continuous(ratio_category, def)
statsummary_continuous(avg_category, def)
statsummary_continuous(obl_category, def)

statsummary_discrete("CompOffr", def)

HHI_category <- c("def6_HHI_lag1", "def5_HHI_lag1", "def4_HHI_lag1","def3_HHI_lag1", "def2_HHI_lag1")

hhi<-statsummary_continuous(HHI_category, def)
hhi
write.csv(hhi,file="..//Output/hhi_summary.csv")
```


## Controls


### Initial Contract Scope

#### Ceiling
* cl_Ceil is the natural log of the initial contract cost ceiling, in then-year dollars. `r centered_log_description(def$UnmodifiedContractBaseAndAllOptionsValue,"dollars");
NA_stats(def,"cl_Ceil")`

* cl_Days is the natural log of the initial maximum duration of the contract, in days. The variable is centered, by subtracting its mean (`r centered_log_description(def$UnmodifiedDays,"days");
NA_stats(def,"cl_Days")` 


```{r cl_Ceil}
#original variable for cl_Ceil: UnmodifiedContractBaseAndAllOptionsValue

freq_continuous_plot(def,"UnmodifiedContractBaseAndAllOptionsValue",bins=50,
                     log=TRUE)


```


#### Duration
* cl_Days is the natural log of the initial maximum duration of the contract, in days. The variable is centered, by subtracting its mean (`r centered_log_description(def$UnmodifiedDays,"days");
NA_stats(def,"cl_Days")` 


```{r cl_Days}
#original variable for cl_Ceil: UnmodifiedContractBaseAndAllOptionsValue.OMB20_GDP18

freq_continuous_plot(def,"UnmodifiedContractBaseAndAllOptionsValue.OMB20_GDP18",bins=50,
                     log=TRUE)

statsummary_continuous(c("UnmodifiedDays","UnmodifiedContractBaseAndAllOptionsValue.OMB20_GDP18"), def)



```


### Contract Vehicle
* SIDV, MIDV, and FSS/GWAC, BPA/BOA are dummy variables based on the contract vehicle. They correspond to Single-Award IDVs, Multi-Award IDVs, and Other IDVs, respectively, having a value of 1 when the task order has that vehicle type, and having a 0 other. The remaining types, definitive contracts and purchase orders, are intentionally left out. 

```{r VehGraph}
grouped_barplot("Veh", def)
statsummary_discrete("Veh", def)
```


### Pricing Fee
* n_Fixed is a numeric variable based on contract pricing. It has a value of 0 for cost-based, 0.5 or "combination or other", 1 for any fixed price (excluding fixed-price level of effort which is classified as cost-based). (`r summary(def$n_Fixed);
NA_stats(def,"n_Fixed")
sum(def$Action_Obligation.OMB20_GDP18[def$n_Fixed==0],na.rm=TRUE)/sum(def$Action_Obligation.OMB20_GDP18,na.rm=TRUE)
sum(def$Action_Obligation.OMB20_GDP18[def$n_Fixed==0.5],na.rm=TRUE)/sum(def$Action_Obligation.OMB20_GDP18,na.rm=TRUE)
sum(def$Action_Obligation.OMB20_GDP18[def$n_Fixed==1],na.rm=TRUE)/sum(def$Action_Obligation.OMB20_GDP18,na.rm=TRUE)
nrow(def[def$n_Fixed==0,])/nrow(def)
nrow(def[def$n_Fixed==0.5,])/nrow(def)
nrow(def[def$n_Fixed==1,])/nrow(def)


summary(def$PricingFee);
length(def$PricingFee[def$PricingFee =="FFP"])/nrow(def)

length(def$PricingFee[def$PricingFee =="Other FP" & !is.na(def$PricingFee)])/nrow(def)
length(def$PricingFee[def$PricingFee =="Incentive" & !is.na(def$PricingFee)])/nrow(def)
length(def$PricingFee[def$PricingFee =="Combination or Other" & !is.na(def$PricingFee)])/nrow(def)
length(def$PricingFee[def$PricingFee =="Other CB" & !is.na(def$PricingFee)])/nrow(def)
length(def$PricingFee[def$PricingFee =="T&M/LH/FPLOE" & !is.na(def$PricingFee)])/nrow(def)
NA_stats(def,"PricingFee")

`)

NA_stats(def,"n_Incent")`)
* b_UCA is a binary variable with a value of 1 for contracts/task orders that begin as letter contracts or undefinitized contract awards (UCA) and a value of 0 otherwise. `r summary(def$b_UCA);
sum(def$Action_Obligation.OMB20_GDP18[def$b_UCA==1],na.rm=TRUE)/sum(def$Action_Obligation.OMB20_GDP18,na.rm=TRUE)

### Pricing Fee
* FxCb is a categorical numeric variable based on contract pricing. It has a value for of 0 for cost-based, 0.5 or "combination or other", 1 for any fixed price (excluding fixed-price level of effort which is classified as cost-based). (`r summary(def$n_Fixed);


* Pricing is a categorical  variable based on contract pricing. It has six possible values, Firmed-Fixed Price, Other Fixed-Price, Incentive (Including Cost Sharing, Fixed-Price and Cost Plus), Combination or Other, Other Cost Based, Time & Materials, Labor Hours, Fixed-Price: Level of effort.





```{r PricingFeeGraphs}
#n_Fixed(0,1), PricingFee, n_Incent, b_UCA(0,1), b_Intl
#original variable for b_UCA: UCA
#original variable for n_Fixed: FxCb
#original variable for n_Incent: Fee

grouped_barplot("FxCb", def)
grouped_barplot("Fee", def)
grouped_barplot("PricingFee", def)
statsummary_discrete("PricingFee", def)
```

### UCA

* b_UCA is a binary variable with a value of 1 for contracts/task orders that begin as letter contracts or undefinitized contract awards (UCA) and a value of 0 otherwise. `r summary(def$b_UCA);
sum(def$Action_Obligation[def$b_UCA==1],na.rm=TRUE)/sum(def$Action_Obligation,na.rm=TRUE)
length(def$b_UCA[def$b_UCA==1 & !is.na(def$b_UCA)])/nrow(def)
NA_stats(def,"b_UCA")`


length(def$b_UCA[def$b_UCA==1 & !is.na(def$b_UCA)])/nrow(def)
NA_stats(def,"b_UCA")`
* NAICS is a factor reporting the top North American Industrial Classification Code of each contract. 
`r summary(def$NAICS);
NA_stats(def,"NAICS")`
* Agency is a factor reporting the top Contracting Agency of each contract. 
`r summary(def$Agency);
NA_stats(def,"Agency")`
* Office is a factor reporting the top Contracting office of each contract. 
`r summary(def$Office);
NA_stats(def,"Office")`


```{r UCA}

grouped_barplot("UCA", def)
statsummary_discrete("UCA", def)

```
### International



* b_Intl is a binary variable with a value of 1 for contracts/task orders with any transactions performed internationally and a value of 0 otherwise. `r summary(def$b_Intl);
sum(def$Action_Obligation[def$b_Intl==1],na.rm=TRUE)/sum(def$Action_Obligation,na.rm=TRUE)
NA_stats(def,"b_Intl")`


```{r International}
#n_Fixed(0,1), PricingFee, n_Incent, b_UCA(0,1), b_Intl
#original variable for b_UCA: UCA
#original variable for n_Fixed: FxCb
#original variable for n_Incent: Fee

grouped_barplot("Intl", def)
statsummary_discrete("Intl", def)
```

### Contracting Customer
#### Agency
* Agency is a factor reporting the top Contracting Agency of each contract. 
`r summary(def$Agency);
NA_stats(def,"Agency")`



```{r frequancy bar plot for agency}
#Prepare the dataframe for plot
Agency_Freq <- as.data.frame(table(def$Agency))
Agency_Freq$Percent_Freq <- round(Agency_Freq$Freq/sum(Agency_Freq$Freq),4)*100
colnames(Agency_Freq) <- c("Agency","Count_Freq","Percent_Freq")
Agency_Freq <- Agency_Freq[order(-Agency_Freq$Count_Freq),]
Agency_Freq <- Agency_Freq[1:10,]

#Add detail description to Agency code
Agency_Lookup <- read.csv("https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/Agency_AgencyID.csv")
Agency_Lookup <- Agency_Lookup[,1:2]
colnames(Agency_Lookup) <- c("Agency","Agency_Description")
Agency_Freq <- left_join(Agency_Freq, Agency_Lookup, by = "Agency")
Agency_Freq$Agency <- factor(Agency_Freq$Agency, levels = rev(Agency_Freq$Agency))
Agency_Freq <- Agency_Freq[order(-Agency_Freq$Percent_Freq),]
Agency_Freq$Agency_Description <- factor(Agency_Freq$Agency_Description, 
                                         levels=rev(Agency_Freq$Agency_Description))

#build the frequency bar plot
Frequency_Plot3 <- ggplot(data = Agency_Freq, aes(x=Agency_Description,        y=Percent_Freq)) +
                   geom_bar(stat = "identity", position = "dodge", width = 0.8) +
                   coord_flip() +
                   xlab("Agency") +
                   ylab("Percent of Frequency") +
                   theme_grey() +
                   scale_fill_grey() +
                   ggtitle("Top 10 of the most frequently appeared Agency") +
                   theme(text = element_text(size = 10))
Frequency_Plot3
```


```{r frequancy and obligation percent grouped bar plot for agency}

#Percent grouped bar plot for variable Agency
#Generate new data frame containing frequency information
Agency_Freq <- as.data.frame(table(def$Agency))
Agency_Freq$Percent_Freq <- round(Agency_Freq$Freq/sum(Agency_Freq$Freq),4)*100
colnames(Agency_Freq) <- c("Agency","Count_Freq","Percent_Freq")

#Add detail Agency description according to agency code
Agency_Lookup <- read.csv("https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/Agency_AgencyID.csv")
Agency_Lookup <- Agency_Lookup[,1:2]
colnames(Agency_Lookup) <- c("Agency","Agency_Description")
Agency_Freq <- left_join(Agency_Freq, Agency_Lookup, by = "Agency")
#Add obligation percent information to data frame
Percent_Obli <- c()
for (i in Agency_Freq$Agency) {
  Percent_Obligation <- round(sum(def$Action_Obligation[def$Agency == i], na.rm = TRUE)/sum(def$Action_Obligation, na.rm = TRUE),5)
  Percent_Obli <- c(Percent_Obli, Percent_Obligation)
}
Agency_Freq$Agency_Description <- as.character(Agency_Freq$Agency_Description)
Agency_Freq$Percent_Obli <- Percent_Obli*100

#Get top 5 Agencies that take largest percent obligation
Agency_Freq <- Agency_Freq[order(-Percent_Obli),]
Agency_Freq <- Agency_Freq[1:5,]
percent_freq_rest <- 100 - sum(Agency_Freq$Percent_Freq, na.rm = TRUE)
percent_obli_rest <- 100 - sum(Agency_Freq$Percent_Obli, na.rm = TRUE)

Agency_Freq[6,] <- c("All Other", "NA", percent_freq_rest, "All Other", percent_obli_rest)
Agency_Freq$Agency_Description <- factor(Agency_Freq$Agency_Description, levels = rev(Agency_Freq$Agency_Description))
Agency_Freq[,c(3,5)] <- lapply(Agency_Freq[,c(3,5)], function(x) as.numeric(x))
Agency_Freq <- melt(Agency_Freq, id = c("Agency","Count_Freq", "Agency_Description"))

#Build grouped bar plot
Agency_barplot <- ggplot(data = Agency_Freq, 
                         aes(x = Agency_Description, 
                             y=value, 
                             fill=factor(variable))) + 
                  geom_bar(stat = "identity", 
                           position= "dodge", 
                           width = 0.8) + 
                  xlab("") + 
                  ylab("") + 
                  coord_flip() + 
                  theme_grey() +
                  scale_fill_grey(labels = c("% of records", "% of obligation"),
                                  guide = guide_legend(reverse = TRUE)) +
                  theme(legend.title = element_blank(),
                        legend.position = "bottom",
                        legend.margin = margin(t=-0.8, r=0, b=0.5, l=0, unit = "cm"),
                        legend.text = element_text(margin = margin(r=0.5, unit = "cm")),
                        plot.margin = margin(t=0.3, r=0.5, b=0, l=0.5, unit = "cm")) +
                 ggtitle("Top 5 of the most frequently appeared Agency") 
Agency_barplot                  

```


#### Office 

* Office is a factor reporting the top Contracting office of each contract. 
`r summary(def$Office);
NA_stats(def,"Office")`
```{r grouped percent frequency/obligation barplot for all Office}
#grouped bar plot for variable Office
#Perpare data for plot
#get the detailed desceription for Office by AgencyID and OfficeID
# Office_Lookup <- read.delim("https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/office/Office.ContractingOfficeCode.txt")
# def_dup <- def

memory.limit(56000)
Office_Freq <- def %>% group_by(Office,ContractingOfficeName) %>% summarise(
  Count_Freq=length(CSIScontractID),
  Action_Obligation.OMB20_GDP18=sum(Action_Obligation.OMB20_GDP18)
)
  
  # Office_Freq <- Office_Freq[order(-Office_Freq$Freq),]
# Office_Freq_TOP20 <- Office_Freq[1:20,]   #Get top 20 NAICS has largest frequency count
Office_Freq$Percent_Freq <- round(Office_Freq$Count_Freq/
                                   sum(Office_Freq$Count_Freq),4)*100
Office_Freq$Percent_Obli <- round(Office_Freq$Action_Obligation.OMB20_GDP18/
                                         sum(Office_Freq$Action_Obligation.OMB20_GDP18),4)*100

colnames(Office_Freq)[colnames(Office_Freq)=="Office"] <- "OfficeID"
colnames(Office_Freq)[colnames(Office_Freq)=="ContractingOfficeName"] <- "OfficeName"

Office_Freq$Percent_Freq <- round(Office_Freq$Count_Freq/sum(Office_Freq$Count_Freq),4)*100
Office_Freq <- subset(Office_Freq, (Office_Freq$Count_Freq != 0)&(Office_Freq$Percent_Freq!=0))
Office_Freq[,1:2] <- lapply(Office_Freq[,1:2], function(x) as.character(x))

Office_Freq$Office_Full <- ifelse(is.na(Office_Freq$OfficeName), Office_Freq$OfficeID, Office_Freq$OfficeName)



Office_Freq_top10Freq <- Office_Freq[order(-Office_Freq$Percent_Freq),]
Office_Freq_top10Freq <- Office_Freq_top10Freq[1:10, ]  #including NULL category
Office_Freq_top10Obli <- Office_Freq[order(-Office_Freq$Percent_Obli),]
Office_Freq_top10Obli <- Office_Freq_top10Obli[1:10, ]  #including NULL category

Office_Freq_TOP <- rbind(Office_Freq_top10Obli, Office_Freq_top10Freq)
Office_Freq_TOP <- unique(Office_Freq_TOP)  #17 records in total

#Generate a new name column by Combining officeID and officeName
Office_Freq_TOP$Office_Full <- ifelse(Office_Freq_TOP$Office_Full == Office_Freq_TOP$OfficeID, 
                                      Office_Freq_TOP$OfficeID, 
                                      paste(Office_Freq_TOP$OfficeID, 
                                            " - ", 
                                            Office_Freq_TOP$OfficeName))

Office_Freq_TOP$Office_Full <- factor(Office_Freq_TOP$Office_Full, 
                                      levels = rev(Office_Freq_TOP$Office_Full))
Office_Freq_TOP <- melt(Office_Freq_TOP, 
                        id = c("OfficeID", "OfficeName", "Count_Freq", "Office_Full"))

Office_barplot <- ggplot(data = Office_Freq_TOP,
                         aes(x = Office_Full, 
                             y = value,
                             fill = factor(variable))) +
                  geom_bar(stat = "identity", 
                  position = "dodge", 
                  width = 0.8) + 
                  coord_flip() +
                  xlab("") + 
                  ylab("") + 
                  theme_grey() + 
                  scale_fill_grey(labels = c("% of records", "% of obligation"),
                                  guide = guide_legend(reverse = TRUE)) + 
                  ggtitle("Percent of Frequency and obligation for Office") +
                  theme(text = element_text(size = 10), 
                        legend.title = element_blank(),
                        legend.position = "bottom",
                        legend.margin = margin(t=-0.8, r=0, b=0.5, l=0, unit = "cm"),
                        legend.text = element_text(margin = margin(r=0.5, unit = "cm")), 
                        plot.margin = margin(t=0.3, r=0.5, b=0, l=0.5, unit = "cm"))
Office_barplot
```

```{r frequancy and obligation percent grouped bar plot for agency}

#Percent grouped bar plot for variable Agency
#Generate new data frame containing frequency information
Agency_Freq <- as.data.frame(table(def$Agency))
Agency_Freq$Percent_Freq <- round(Agency_Freq$Freq/sum(Agency_Freq$Freq),4)*100
colnames(Agency_Freq) <- c("Agency","Count_Freq","Percent_Freq")

#Add detail Agency description according to agency code
Agency_Lookup <- read.csv("https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/Agency_AgencyID.csv")
Agency_Lookup <- Agency_Lookup[,1:2]
colnames(Agency_Lookup) <- c("Agency","Agency_Description")
Agency_Freq <- left_join(Agency_Freq, Agency_Lookup, by = "Agency")
#Add obligation percent information to data frame
Percent_Obli <- c()
for (i in Agency_Freq$Agency) {
  Percent_Obligation <- round(sum(def$Action_Obligation.OMB20_GDP18[def$Agency == i], na.rm = TRUE)/sum(def$Action_Obligation.OMB20_GDP18, na.rm = TRUE),5)
  Percent_Obli <- c(Percent_Obli, Percent_Obligation)
}
Agency_Freq$Agency_Description <- as.character(Agency_Freq$Agency_Description)
Agency_Freq$Percent_Obli <- Percent_Obli*100

#Get top 5 Agencies that take largest percent obligation
Agency_Freq <- Agency_Freq[order(-Percent_Obli),]
Agency_Freq <- Agency_Freq[1:5,]
percent_freq_rest <- 100 - sum(Agency_Freq$Percent_Freq, na.rm = TRUE)
percent_obli_rest <- 100 - sum(Agency_Freq$Percent_Obli, na.rm = TRUE)

Agency_Freq[6,] <- c("All Other", "NA", percent_freq_rest, "All Other", percent_obli_rest)
Agency_Freq$Agency_Description <- factor(Agency_Freq$Agency_Description, levels = rev(Agency_Freq$Agency_Description))
Agency_Freq[,c(3,5)] <- lapply(Agency_Freq[,c(3,5)], function(x) as.numeric(x))
Agency_Freq <- melt(Agency_Freq, id = c("Agency","Count_Freq", "Agency_Description"))

#Build grouped bar plot
Agency_barplot <- ggplot(data = Agency_Freq, 
                         aes(x = Agency_Description, 
                             y=value, 
                             fill=factor(variable))) + 
                  geom_bar(stat = "identity", 
                           position= "dodge", 
                           width = 0.8) + 
                  xlab("") + 
                  ylab("") + 
                  coord_flip() + 
                  theme_grey() +
                  scale_fill_grey(labels = c("% of records", "% of obligation"),
                                  guide = guide_legend(reverse = TRUE)) +
                  theme(legend.title = element_blank(),
                        legend.position = "bottom",
                        legend.margin = margin(t=-0.8, r=0, b=0.5, l=0, unit = "cm"),
                        legend.text = element_text(margin = margin(r=0.5, unit = "cm")),
                        plot.margin = margin(t=0.3, r=0.5, b=0, l=0.5, unit = "cm")) +
                 ggtitle("Top 5 of the most frequently appeared Agency") 
Agency_barplot                  

```

### Economic Sector
* NAICS is a factor reporting the top North American Industrial Classification Code of each contract. 
`r summary(def$NAICS);
NA_stats(def,"NAICS")`

#### NAICS 2
```{r NAICS2_Summary, fig.width=7.5 , fig.height=3}

# Add NAICS title
#def$NAICS_Code<-create_naics2(def$NAICS)
def$NAICS_Code<-def$NAICS2


def<-csis360::read_and_join_experiment(def,
                            lookup_file = "Lookup_PrincipalNAICScode.csv",
                            path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                            dir="economic/",
                            by=c("NAICS_Code"="principalnaicscode"),
                            add_var="principalnaicscodeText"
)

def$NAICS2_label<-paste(def$NAICS_Code,
                             def$principalnaicscodeText)

def$NAICS2_label[
  def$NAICS2_label==
    "56 Administrative and Support and Waste Management and Remediation Services"
  ]<-"56 Admin./Support/Waste Management and Remediation"
def$NAICS2_label[def$NAICS2_label==
                                    "NA NA"]<-"Unlabeled"

def$NAICS2_label<-factor(def$NAICS2_label)
order<-  rev(levels(def$NAICS2_label))


NAICS2digit<-ggplot(def,
       aes(x=NAICS2_label))+
  geom_bar()+coord_flip()+
  scale_y_continuous(label=scales::comma)+scale_x_discrete(limits=order)+
  labs(x="2-Digit NAICS Code",y="Number of Contracts and Task Orders in Unfiltered Dataset")

NAICS2digit
ggsave(NAICS2digit,file="..//Output\\NAICS2digitCount.png",width=10,height=6,dpi=600)
ggsave(NAICS2digit,file="..//Output\\NAICS2digitCount.eps",width=10,height=6,dpi=600)
```


```{r grouped percent frequency/obligation barplot for all NAICS2, 21 in total}
#Prepare data for plot
NAICS2_Freq <- as.data.frame(table(def$NAICS2))
NAICS2_Freq$Percent_Freq <- round(NAICS2_Freq$Freq/sum(NAICS2_Freq$Freq),4)*100
colnames(NAICS2_Freq) <- c("NAICS_Code", "Count_Freq", "Percent_Freq")

#Get detail description for NAICS2 code
NAICS2_Freq<-csis360::read_and_join_experiment(NAICS2_Freq,
                            lookup_file = "Lookup_PrincipalNAICScode.csv",
                            path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                            dir="economic/",
                            by=c("NAICS_Code"="principalnaicscode"),
                            add_var="principalnaicscodeText"
)


Percent_Obli <- c()
Total_Obli <- sum(def$Action_Obligation.OMB20_GDP18, na.rm = TRUE)
for (i in NAICS2_Freq$NAICS_Code) {
  Percent_Obligation <- round(sum(def$Action_Obligation.OMB20_GDP18[def$NAICS2 == i], na.rm = TRUE)/Total_Obli,5)
  Percent_Obli <- c(Percent_Obli, Percent_Obligation)
}

NAICS2_Freq$Percent_Obli <- Percent_Obli * 100
NAICS2_Freq <- NAICS2_Freq[order(-NAICS2_Freq$Percent_Obli),]
NAICS2_Freq[,c(1,3)] <- lapply(NAICS2_Freq[,c(1,3)], function(x) as.character(x))
NAICS2_Freq$principalnaicscodeText <- paste(NAICS2_Freq$NAICS_Code, " - ", NAICS2_Freq$principalnaicscodeText)
NAICS2_Freq$principalnaicscodeText <- factor(NAICS2_Freq$principalnaicscodeText, levels = rev(NAICS2_Freq$principalnaicscodeText))
NAICS2_Freq <- melt(NAICS2_Freq, id = c("NAICS_Code", "Count_Freq","principalnaicscodeText"))
NAICS2_Freq$value <- as.numeric(NAICS2_Freq$value)

NAICS2_barplot <- ggplot(data = NAICS2_Freq,
                          aes(x = principalnaicscodeText, 
                              y = value,
                              fill = factor(variable))) +
                   geom_bar(stat = "identity", 
                            position = "dodge", 
                            width = 0.8) + 
                   coord_flip() +
                   xlab("") + 
                   ylab("") + 
                   theme_grey() + 
                   scale_fill_grey(labels = c("% records", "% obligation"),
                                  guide = guide_legend(reverse = TRUE)) + 
                   ggtitle("Percent of Frequency and obligation for NAICS2") +
                   theme(text = element_text(size = 10), 
                         legend.title = element_blank(),
                         legend.position = "bottom",
                         legend.margin = margin(t=-0.8, r=0, b=0.5, l=0, unit = "cm"),
                         legend.text = element_text(margin = margin(r=0.5, unit = "cm")),
                         plot.margin = margin(t=0.3, r=0.5, b=0, l=0.5, unit = "cm"))
NAICS2_barplot
```


#### NAICS 3

centered_log_description(def$l_def3_obl_lag1,"obligations")
centered_log_description(def$l_def6_obl_lag1,"obligations")
NA_stats(def,"l_def3_obl_lag1")

centered_log_description(def$l_def3_ratio_lag1,"obligations")

NA_stats(def,"cl_def3_ratio_lag1")

```{r grouped barplot for variable NAICS3}
Frequency <- as.data.frame(table(def$NAICS3))
Frequency[["Percent_Freq"]] <- round(Frequency[["Freq"]]/sum(Frequency[["Freq"]]),4)*100
colnames(Frequency) <- c("NAICS3", "Count_Freq", "Percent_Freq")
Percent_Obli <- c()
for (i in Frequency[["NAICS3"]]) {
  Percent_Obligation <- round(sum(def[["Action_Obligation_Then_Year"]][def$NAICS3 == i], na.rm = TRUE)/sum(def[["Action_Obligation_Then_Year"]], na.rm = TRUE),5)
    Percent_Obli <- c(Percent_Obli, Percent_Obligation)
  }
Frequency[["Percent_Obli"]] <- Percent_Obli*100
NAICS3_Freq <- Frequency

#Add detail description to unique NAICS3 code
NAICS3_Freq<-read_and_join_experiment(NAICS3_Freq,
                                           lookup_file = "Lookup_PrincipalNAICScode.csv",
                                      path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                                      dir="economic\\",
                                      by=c("NAICS3"="principalnaicscode"),
                                      add_var="principalnaicscodeText"
                                      )

NAICS3_Freq$principalnaicscodeText <- as.character(NAICS3_Freq$principalnaicscodeText)
NAICS3_Freq$principalnaicscodeText <- paste(NAICS3_Freq$NAICS, " - ", NAICS3_Freq$principalnaicscodeText)

#Get the top 15 most frequently appeared NAICS3
NAICS3_Freq_top10Freq <- NAICS3_Freq[order(-NAICS3_Freq$Percent_Freq),]
NAICS3_Freq_top10Freq <- NAICS3_Freq_top10Freq[1:10, ]   
NAICS3_Freq_top10Obli <- NAICS3_Freq[order(-NAICS3_Freq$Percent_Obli),]
NAICS3_Freq_top10Obli <- NAICS3_Freq_top10Obli[1:10, ]
NAICS3_Freq_TOP <- rbind(NAICS3_Freq_top10Obli, NAICS3_Freq_top10Freq)
NAICS3_Freq_TOP <- unique(NAICS3_Freq_TOP)  #15 records in total
NAICS3_Freq_TOP <- NAICS3_Freq_TOP[order(-NAICS3_Freq_TOP$Percent_Obli),]
NAICS3_Freq_TOP$principalnaicscodeText <- factor(NAICS3_Freq_TOP$principalnaicscodeText, rev(NAICS3_Freq_TOP$principalnaicscodeText))

#Reshape the dataframe to long format for plot
NAICS3_Freq_TOP <- melt(NAICS3_Freq_TOP, id = c("NAICS3", "Count_Freq", "principalnaicscodeText"))

#Generate the plot and add title manually
part_grouped_barplot("NAICS3", NAICS3_Freq_TOP,
                     description_var="principalnaicscodeText") + ggtitle("Top 15 of the most frequently appeared NAICS3")
```



#### NAICS 6

centered_log_description(def$US6_avg_sal_lag1Const,"dollars")
NA_stats(def,"cl_US6_avg_sal_lag1Const")

NA_stats(def,"l_def6_obl_lag1")
def$l_def6_ratio_lag1[is.nan(def$l_def6_ratio_lag1) | is.infinite(def$l_def6_ratio_lag1)]<-NA
def$cl_def6_ratio_lag1[is.nan(def$cl_def6_ratio_lag1) | is.infinite(def$cl_def6_ratio_lag1)]<-NA
centered_log_description(def$l_def6_ratio_lag1,"obligations")
<!-- centered_log_description(def$l_def6_ratio_lag1) -->
NA_stats(def,"cl_def6_ratio_lag1")

centered_log_description(def$l_US6_avg_sal_lag1,"dollars")
NA_stats(def,"cl_US6_avg_sal_lag1")


```{r NAICS6_Summary, fig.width=7.5 , fig.height=3}
NAICS_summary<-def %>% group_by(NAICS,StartCY,def6_HHI_lag1,def6_obl_lag1,def6_ratio_lag1,US6_avg_sal_lag1) %>%
  dplyr::summarise(annual_action_obligation=sum(Action_Obligation.OMB20_GDP18),
                   annual_count=length(StartCY)) 

top_NAICS <- NAICS_summary %>% group_by(NAICS) %>% 
  dplyr::summarise(naics_action_obligation=sum(annual_action_obligation),
                   naics_count=sum(annual_count)) 
top_NAICS$naics_dollar_rank<-rank(-top_NAICS$naics_action_obligation)
top_NAICS$naics_count_rank<-rank(-top_NAICS$naics_count)


NAICS_summary<-left_join(NAICS_summary,top_NAICS, by="NAICS")

colnames(NAICS_summary)[colnames(NAICS_summary)=="NAICS"]<-"principalnaicscode"

NAICS_summary$principalnaicscode<-as.character(NAICS_summary$principalnaicscode)
NAICS_summary<-as.data.frame(NAICS_summary)


NAICS_summary<-read_and_join_experiment(NAICS_summary,
                                                 lookup_file = "Lookup_PrincipalNAICScode.csv",
                                                 path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                                                 dir="economic/",
                                                 by="principalnaicscode",
                                                 skip_check_var=c("principalnaicscodeText",
                                                                  "NAICS_shorthand",
                                                                  "principalNAICS4DigitCode")

)

summary(NAICS_summary$NAICS_shorthand)

# View(NAICS_summary)
NAICS_summary$NAICS_shorthand<-swr(NAICS_summary$NAICS_shorthand,nwrap = 25)
NAICS_summary$CY<-NAICS_summary$StartCY-1
NAICS6top<-ggplot(subset(NAICS_summary,naics_dollar_rank<=4 |
                          naics_count_rank<=4),
       aes(x=CY,y=def6_HHI_lag1))+#color=NAICS_Code
  geom_line()+
  scale_y_continuous(label=scales::comma)+ 
  # scale_x_continuous(breaks=c(2006,2009,2011,2014))+
  labs(x="Calendar Year",y="Herfindahl-Herschman Index")+ 
  geom_hline(yintercept=c(1500,2500),linetype="dotted")

NAICS6top_paper<-NAICS6top+ facet_wrap(~NAICS_shorthand,ncol=2)
ggsave(NAICS6top_paper,file="..\\Output\\NAICS6top.png",width=4,height=8,dpi=600)
ggsave(NAICS6top_paper,file="..\\Output\\NAICS6top.eps",width=4,height=8,dpi=600)

NAICS6top_pp<-NAICS6top+ facet_wrap(~NAICS_shorthand,ncol=4)
NAICS6top_pp
ggsave(NAICS6top_pp,file="..\\Output\\NAICS6top_pp.png",width=10.5,height=5.5,dpi=600)
ggsave(NAICS6top_pp,file="..\\Output\\NAICS6top_pp.eps",width=10.5,height=5.5,dpi=600)

summary(NAICS_summary$naics_count_rank)


NAICS_summary$NAICS_shorthand<-swr(NAICS_summary$NAICS_shorthand,nwrap = 16)
# NAICS_summary$CY<-factor(paste("'",substring(as.character(NAICS_summary$CY),3,4),sep=""))

NAICS6top8<-ggplot(subset(NAICS_summary,naics_dollar_rank<=8),
       aes(x=CY,y=def6_HHI_lag1))+#color=NAICS_Code
  geom_line()+
  scale_y_continuous(label=scales::comma)+ 
  scale_x_continuous(breaks=c(2007,2012))+
  labs(x="Calendar Year",y="Herfindahl-Herschman Index")+ 
  geom_hline(yintercept=c(1500,2500),linetype="dotted")

NAICS6top8_wide<-NAICS6top8+ facet_grid(.~NAICS_shorthand)
ggsave(NAICS6top8_wide,file="..\\Output\\NAICS6top8.png",width=9.5,height=4,dpi=600)
ggsave(NAICS6top8_wide,file="..\\Output\\NAICS6top8.eps",width=9.5,height=4,dpi=600)


colnames(NAICS_summary)
NAICS_long<-NAICS_summary[,colnames(NAICS_summary) %in% c( "principalnaicscode",
                                                    "def6_HHI_lag1",
                                                    "def6_obl_lag1",
                                                    "def6_ratio_lag1",
                                                    # "US6_avg_sal_lag1",
                                                    "naics_dollar_rank" ,
                                                    "naics_count_rank",
                                                    "principalnaicscodeText",
                                                     "NAICS_shorthand",
                                                    "CY")]
NAICS_long<-melt(NAICS_long, id=c("principalnaicscode","naics_dollar_rank","naics_count_rank","principalnaicscodeText","CY", "NAICS_shorthand"))



#Drop the ratios and average salaries w/ unique values
# NAICS_long<-NAICS_long[NAICS_long$variable %in% c(),]


levels(NAICS_long$variable)<- list("Herfindahl-\nHerschman Index"=c("def6_HHI_lag1"),
                                   "Defense Obligations"=c("def6_obl_lag1"),
                                   "Defense Obligations\nto U.S. Revenue Ratio"=c("def6_ratio_lag1"))

NAICS_long$high<-2500
NAICS_long$high[NAICS_long$variable!="Herfindahl-\nHerschman Index"]<-NA
NAICS_long$low<-1500
NAICS_long$low[NAICS_long$variable!="Herfindahl-\nHerschman Index"]<-NA


NAICS6long<-ggplot(subset(NAICS_long,naics_dollar_rank<=8),
       aes(x=CY,y=value))+#color=NAICS_Code
  geom_line()+
  scale_y_continuous(label=scales::comma)+ 
  scale_x_continuous(breaks=c(2007,2012))+
  labs(x="Calendar Year",y="Detailed Industry Metric")+
  geom_hline(aes(
           yintercept=high),linetype="dotted")+
  geom_hline(aes(
           yintercept=low),linetype="dotted")    



NAICS6long_wide<-NAICS6long+ facet_grid(variable~NAICS_shorthand,scales="free_y")
ggsave(NAICS6long_wide,file="..\\Output\\NAICS6long.png",width=9.5,height=5.5,dpi=600)
ggsave(NAICS6long_wide,file="..\\Output\\NAICS6long.eps",width=9.5,height=5.5,dpi=600)

write.csv(NAICS_summary,file="..\\Output/NAICS6_summary.csv",row.names = FALSE)
```

```{r barplot for top 20 most frequently appeared NAICS}
#Prepare dateframe for plot
NAICS_Freq <- as.data.frame(table(def$NAICS))
NAICS_Freq <- NAICS_Freq[order(-NAICS_Freq$Freq),]
NAICS_Freq_TOP20 <- NAICS_Freq[1:20,]   #Get top 20 NAICS has largest frequency count
NAICS_Freq_TOP20$Percent_Freq <- round(NAICS_Freq_TOP20$Freq/sum(NAICS_Freq$Freq),4)*100
colnames(NAICS_Freq_TOP20) <- c("NAICS_Code", "Count_Freq", "Percent_Freq")

#Get detail description for each NAICS code
NAICS_Freq_TOP20 <- left_join(NAICS_Freq_TOP20, NAICS_Lookup, by = "NAICS_Code")
NAICS_Freq_TOP20 <- NAICS_Freq_TOP20[order(-NAICS_Freq_TOP20$Percent_Freq),]
NAICS_Freq_TOP20$principalnaicscodeText <- factor(NAICS_Freq_TOP20$principalnaicscodeText, levels = rev(NAICS_Freq_TOP20$principalnaicscodeText))


Frequency_Plot <- ggplot(data = NAICS_Freq_TOP20, 
                         aes(x = NAICS_Freq_TOP20$principalnaicscodeText, 
                             y = NAICS_Freq_TOP20$Percent_Freq)) +
                  geom_bar(stat = "identity", position = "dodge", width = 0.8) + 
                  coord_flip() +
                  xlab("") + 
                  ylab("Percent of Frequency") + 
                  theme_grey() + 
                  scale_fill_grey() + 
                  ggtitle("Top 20 of the most frequently appeared NAICS") +
                  theme(text = element_text(size = 10))
Frequency_Plot
```

```{r grouped barplot for NAICS most frequency appeared/has the largest percent obligation }
# #Percent frequency/obligation grouped bar plot for variable NAICS
# #Prepare dateframe for plot
# NAICS_Freq <- as.data.frame(table(def$NAICS))
# # NAICS_Freq <- NAICS_Freq[order(-NAICS_Freq$Freq),]
# # NAICS_Freq_TOP20 <- NAICS_Freq[1:20,]   #Get top 20 NAICS has largest frequency count
# NAICS_Freq$Percent_Freq <- round(NAICS_Freq$Freq/sum(NAICS_Freq$Freq),4)*100
# colnames(NAICS_Freq) <- c("NAICS_Code", "Count_Freq", "Percent_Freq")
# 
# #Get detail description for each NAICS code
# NAICS_Freq<-read_and_join_experiment(NAICS_Freq,
                                      #      lookup_file = "Lookup_PrincipalNAICScode.csv",
                                      # path="https://raw.githubusercontent.com/CSISdefense/Lookup-Tables/master/",
                                      # dir="economic\\",
                                      # by=c("NAICS_Code"="principalnaicscode")
#                                       )


# NAICS_Freq <- NAICS_Freq[order(-NAICS_Freq$Percent_Freq),]
# NAICS_Freq$principalnaicscodeText <- factor(NAICS_Freq$principalnaicscodeText, levels = rev(NAICS_Freq$principalnaicscodeText))
# 
# Percent_Obli <- c()
# Total_Obli <- sum(def$Action_Obligation_Then_Year, na.rm = TRUE)

# for (i in NAICS_Freq$NAICS_Code) {
#   Percent_Obligation <- round(sum(def$Action_Obligation_Then_Year[def$NAICS == i], na.rm = TRUE)/Total_Obli,5)
#   Percent_Obli <- c(Percent_Obli, Percent_Obligation)
#   print(i)
# }
# NAICS_Freq$Percent_Obli <- Percent_Obli*100

#The above code need more than 30 mins to run, so just load RData in practice
load(file = "../Data/semi_clean/NAICS_Freq_all.RData")

NAICS_Freq_top10Freq <- NAICS_Freq[order(-NAICS_Freq$Percent_Freq),]
NAICS_Freq_top10Freq <- NAICS_Freq_top10Freq[1:10, ]
NAICS_Freq_top10Obli <- NAICS_Freq[order(-NAICS_Freq$Percent_Obli),]
NAICS_Freq_top10Obli <- NAICS_Freq_top10Obli[1:10, ]

NAICS_Freq_TOP <- rbind( NAICS_Freq_top10Obli, NAICS_Freq_top10Freq)
NAICS_Freq_TOP <- unique(NAICS_Freq_TOP)  #18 records in total
NAICS_Freq_TOP[,c(1,4)] <- lapply(NAICS_Freq_TOP[,c(1,4)], function(x) as.character(x))
NAICS_Freq_TOP$principalnaicscodeText <- paste(NAICS_Freq_TOP$NAICS_Code, " - ", NAICS_Freq_TOP$principalnaicscodeText)

NAICS_Freq_TOP$principalnaicscodeText <- factor(NAICS_Freq_TOP$principalnaicscodeText, levels = rev(NAICS_Freq_TOP$principalnaicscodeText))
NAICS_Freq_TOP <- melt(NAICS_Freq_TOP, id = c("NAICS_Code","Count_Freq","principalnaicscodeText"))
#NAICS_Freq_TOP <- merge(NAICS_Freq_top20Freq, NAICS_Freq_top20Obli, by= "NAICS_Code", all=TRUE)

NAICS_barPlot <- ggplot(data = NAICS_Freq_TOP, 
                         aes(x = principalnaicscodeText, 
                             y = value,
                             fill = factor(variable))) +
                  geom_bar(stat = "identity", position = "dodge", width = 0.8) + 
                  coord_flip() +
                  xlab("") + 
                  ylab("") + 
                  theme_grey() + 
                  scale_fill_grey(labels = c("% records", "% obligation"),
                                  guide = guide_legend(reverse = TRUE)) + 
                  ggtitle("Top 18 of the most frequently appeared NAICS") +
                  theme(text = element_text(size = 10),
                        legend.title = element_blank(),
                        legend.position = "bottom",
                        legend.margin = margin(t=-0.8, r=0, b=0.5, l=0, unit = "cm"),
                        legend.text = element_text(margin = margin(r=0.5, unit = "cm")),
                        plot.margin = margin(t=0.3, r=0.5, b=0, l=0.5, unit = "cm"))

NAICS_barPlot
```


# Missing Data Measures
```{r Sample}

 # load(file="data//def_sample.Rdata")

summary(def$b_Term)
summary(def$b_CBre)
summary(def$lp_OptGrowth) #Missing
summary(def$ExercisedOptions)
summary(def$AnyUnmodifiedUnexercisedOptions)
#Study Variables
summary(def$cl_US6_avg_sal_lag1Const)
summary(def$cl_CFTE)
summary(def$c_pPBSC)
summary(def$c_pOffPSC)
summary(def$c_pairHist)
summary(def$cl_pairCA)
#Controls
summary(def$CompOffr)
summary(def$cl_Offr)
summary(def$cl_Ceil)
summary(def$cl_Days)
summary(def$Veh) 
summary(def$PricingUCA)
summary(def$PlaceCountryISO3)
summary(def$NAICS)
summary(def$NAICS3)
summary(def$Office)
summary(def$Agency)
summary(def$StartCY)
summary(def$cl_def3_HHI_lag1)
summary(def$cl_def3_ratio_lag1)
summary(def$cl_def6_HHI_lag1)
summary(def$cl_def6_obl_lag1)
summary(def$cl_def6_ratio_lag1)
#New Controls
summary(def$cl_OffCA)
summary(def$cl_OffCA)
summary(def$c_pMarket)
summary(def$Crisis)


complete<-
  #Dependent Variables
  !is.na(def$b_Term)& #summary(def$b_Term)
  !is.na(def$b_CBre)&
  !is.na(def$lp_OptGrowth)&
  !is.na(def$ExercisedOptions)&
  !is.na(def$AnyUnmodifiedUnexercisedOptions)&
  #Study Variables
  !is.na(def$cl_US6_avg_sal_lag1Const)&
  !is.na(def$cl_CFTE)&
  !is.na(def$c_pPBSC)&
  !is.na(def$c_pOffPSC)&
  !is.na(def$c_pairHist)&
  !is.na(def$cl_pairCA)&
  #Controls
  !is.na(def$CompOffr)&
  !is.na(def$cl_Offr)&
  !is.na(def$cl_Ceil)&
  !is.na(def$cl_Days)&
  !is.na(def$Veh) &
  !is.na(def$PricingUCA)&
  !is.na(def$PlaceCountryISO3)& #New Variable
  # !is.na(def$b_UCA)& No longer  used
  !is.na(def$NAICS)&
  !is.na(def$NAICS3)&
  !is.na(def$Office)&
  !is.na(def$Agency)&
  !is.na(def$StartCY)&
  !is.na(def$cl_def3_HHI_lag1)&
  !is.na(def$cl_def3_ratio_lag1)&
  !is.na(def$cl_def6_HHI_lag1)&
  !is.na(def$cl_def6_obl_lag1Const)&
  !is.na(def$cl_def6_ratio_lag1)&
  #New Controls
  !is.na(def$cl_OffCA)& #summary(def$cl_OffCA)
  !is.na(def$cl_OffVol)& #summary(def$cl_OffVol)
  !is.na(def$c_pMarket)&  #summary(def$c_pMarket)
  !is.na(def$Crisis)  #summary(def$c_pMarket)




summary(complete)
summary(def$Action_Obligation.OMB20_GDP18)
money<-def$Action_Obligation.OMB20_GDP18
any(def$Action_Obligation.OMB20_GDP18<0)
money[def$Action_Obligation.OMB20_GDP18<0]<-0
sum(def$Action_Obligation.OMB20_GDP18[def$Action_Obligation.OMB20_GDP18<0])

#Overall
length(money[!complete])/length(money)
sum(money[!complete],na.rm=TRUE)/sum(money,na.rm=TRUE)

#What portion of contracts have potential options, 
sum(money[def$AnyUnmodifiedUnexercisedOptions==1],na.rm=TRUE)/
  sum(money,na.rm=TRUE)


#Missing data, how many records
nrow(def[!complete,])/nrow(def)
sum(def[!complete,]$Action_Obligation.OMB20_GDP18.OMB20,na.rm=TRUE)/sum(def$Action.Obligation.OMB20_GDP18,na.rm=TRUE)

#Missing data how much money?
length(money[!complete&def$AnyUnmodifiedUnexercisedOptions==1])/
  length(money[def$AnyUnmodifiedUnexercisedOptions==1])
sum(money[!complete&def$AnyUnmodifiedUnexercisedOptions==1],na.rm=TRUE)/
  sum(money[def$AnyUnmodifiedUnexercisedOptions==1],na.rm=TRUE)




```
