---
title: "Defense Acquisition Trends"
output:
  html_document:
    keep_md: yes
    toc: yes
date: "Wednesday, October 6, 2021"
---

# Setup
First we load the data. The dataset used is a U.S. DOD Contracting dataset derived from FPDS.

```{r Libraries, echo = FALSE}
library(csis360)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(scales)
library(svglite)
library(readxl)

library(openxlsx)

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

local_path<-get_local_lookup_path()

main.text.size<-1
note.text.size<-1.40
if(!exists("full_data"))
  load(file="FPDS_chart_maker//unaggregated_FPDS.Rda")
if(!exists("def_data"))
  load(file="FPDS_chart_maker/unaggregated_def.Rda")


# if(!"Action_Obligation_OMB25_GDP23" %in% colnames(full_data))
#   full_data<-deflate(full_data, "Action_Obligation_Then_Year",deflator_var="OMB25_GDP23",path="offline")
# colnames(full_data)[colnames(full_data)=="Action_Obligation_Then_Year_Then_Year"]<-"Action_Obligation_Then_Year"




if(!exists("ota_def")|!exists("def_kota_update"))
  load(file="../data/clean/Defense_OTA.Rda")


# if(!"Action_Obligation_OMB25_GDP23" %in% colnames(ota_def))
#   ota_def<-deflate(ota_def, "Action_Obligation_Then_Year",deflator_var="OMB25_GDP23")
# colnames(ota_def)[colnames(ota_def)=="Action_Obligation_Then_Year_Then_Year"]<-"Action_Obligation_Then_Year"




#Manual import Greenbook data
toa<-readxl::read_excel(path=file.path("..","data_raw","FY24 6-1_DoD TOA by Title.xlsx"),skip=4)
request<-readxl::read_excel(path=file.path("..","data_raw","FY24 1-1.xlsx"),skip=3)
toa<-toa[sapply(toa[,2],function(x) substr(x,start=1,stop=21))==
            "Total Current Dollars" & !is.na(toa[,2]),c(-1,-3)]
colnames(toa)<-gsub("FY ","",colnames(toa))
colnames(toa)<-gsub("\r\nEnacted","",colnames(toa))
colnames(toa)[colnames(toa)=="...2"]<-"Series"
toa<-pivot_longer(toa,  cols=-Series, names_to="Fiscal_Year", values_to="Total_Obligation_Authority")
toa$Total_Obligation_Authority<-toa$Total_Obligation_Authority*1000000
# debug(deflate)
toa<-deflate(toa,money_var = "Total_Obligation_Authority",deflator_var="OMB25_GDP23",path="offline")
toa$dFYear<-as.Date(paste(toa$Fiscal_Year,1,1,sep="-"))

#Manual import Public Budget Data
outlay<-readxl::read_excel(path=file.path("..","data_raw","hist03z2_fy2025.xlsx"),skip=2,
                           na = c("...........","..........","N/A"))
# outlay<-outlay[sapply(outlay[,2],function(x) substr(x,start=1,stop=21))==
#             "Total Current Dollars" & !is.na(outlay[,2]),c(-1,-3)]

colnames(outlay)<-gsub(" estimate","",colnames(outlay))
# View(outlay %>% filter(!is.na(outlay$`1962`)&is.na(text_to_number(outlay$`1962`))))
colnames(outlay)[colnames(outlay)=="Function and Subfunction"]<-"Series"
outlay<- outlay %>% filter(Series %in% c("051 Subtotal, Department of Defense-Military"))
#Could later add RDT&E, Procurement, and O&M to PSR
outlay<-pivot_longer(outlay,  cols=-Series, names_to="Fiscal_Year", values_to="Outlays")
if(nrow(outlay %>% filter(!is.na(outlay$Outlays)&is.na(text_to_number(outlay$Outlays))))>0)
   stop("Probably an NA value to remove")
outlay$Outlays<-text_to_number(outlay$Outlays)
outlay$Outlays<-outlay$Outlays*1000000
# debug(deflate)
outlay<-deflate(outlay,money_var = "Outlays",deflator_var="OMB25_GDP23",path="offline")
outlay$dFYear<-as.Date(paste(outlay$Fiscal_Year,1,1,sep="-"))



online_path<-file.path(get_local_sharepoint_path("DIIG Teamsite - Shared Documents"),"2024 - Acquisition Trends","Data and Figures")

max(full_data$Fiscal_YQ)
max(def_data$Fiscal_YQ)

full_data %>% group_by(Fiscal_Year) %>%
  summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23))%>%
  arrange(Fiscal_Year)


load(file="../data/clean/Defense_OTA.Rda")
```

# Topline

## Topline Quarterly
```{r toplineq}




(toplineq<-build_plot(data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<=2024.1),#rbind(quarterly,q2021,e2021),
                     chart_geom="Bar Chart",
                     x_var="dFYear",alpha_var="YTD",
                     y_var="Action_Obligation_OMB25_GDP23",
           color_var="fiscal_quarter",
           format = TRUE,
           labels_and_colors = def_lc,
           column_key=def_ck
       )+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nOct–Nov")
       theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi(toplineq,file=file.path("..","Output","AcqTrends","toplineq.svg"),  
             width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
             )

ggsave600dpi(toplineq,file=file.path("..","Output","AcqTrends","toplineq.png"),  
             width=6.5, height= 3.5, units="in",size=11, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",
             filename="toplineqr_keynote.svg", toplineq+
               labs(title="DOD Contract Obligations, 2000–2024 Oct-Nov"),
             width=13, height= 5.5, units="in", size=20, lineheight = 0.75
             )

log_plot(plot=toplineq, df=def_data   %>% filter(Fiscal_YQ<2024),
                     filename="acq_fig2_2_fq",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="2-2 FYQ",path="../output/AcqTrends/", height=3.25,
                     startRow=1,startCol=12,format=TRUE,#var_list=c("Source","fiscal_quarter")
         )

```

### Quarterly Plat Breakout
```{r QuartPlatBreakout} 
platform_levels<-levels(factor(def_data$PlatformPortfolio))
for(p in platform_levels){
  file_p<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",p)))
  (Breakout<-build_plot(
    data=def_data %>% filter(Fiscal_Year>=2000&Fiscal_YQ<2024&PlatformPortfolio==p),
                     chart_geom="Bar Chart",
                     x_var="dFYear",alpha_var="YTD",
                     y_var="Action_Obligation_OMB25_GDP23",
           color_var="fiscal_quarter",
           format = TRUE,
           labels_and_colors = def_lc,
           column_key=def_ck
       )+
      date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nOct–Nov")   theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",title=p)
)
  
  if(!dir.exists(file.path("../output/AcqTrends/Platform",file_p)))
    dir.create(file.path("../output/AcqTrends/Platform",file_p))
  undebug(log_plot)
  log_plot(plot=Breakout, df=def_data  %>% filter(Fiscal_YQ<2024&PlatformPortfolio==p),
           filename=paste(file_p,"FYQ",sep="_"),xlsx=paste("DoD",file_p,"Contracts.xlsx",sep="_"),
           sheet="FYQ",path=file.path("../output/AcqTrends/Platform/",file_p), height=3.5,
           startRow=1,startCol=13,format=TRUE,var_list=c("Vehicle.AwardTask","Vehicle.sum7"),
           output_doc_png=TRUE,excel_y_var=TRUE
           )
  
}
```

f### Quarterly Cust Breakout
```{r QuartCustBreakout} 
subcustomer_levels<-levels(factor(def_data$SubCustomer.sum))
for(c in subcustomer_levels){
  file_c<-gsub("__*","_",gsub("&","and",gsub("[ |,]","_",c)))
  (Breakout<-build_plot(
    data=def_data %>% filter(Fiscal_Year>=2000&SubCustomer.sum==c& Fiscal_YQ<2024),
                    chart_geom="Bar Chart",
                     x_var="dFYear",alpha_var="YTD",
                     y_var="Action_Obligation_OMB25_GDP23",
           color_var="fiscal_quarter",
           format = TRUE,
           labels_and_colors = def_lc,
           column_key=def_ck
       )+
      date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nOct–Nov")   theme(legend.position = "right")+
     labs(y="Obligations (Constant 2023 $s)",title=c))
  
  if(!dir.exists(file.path("../output/AcqTrends/Customer",file_c)))
    dir.create(file.path("../output/AcqTrends/Customer",file_c))
  
  log_plot(plot=Breakout, df=def_data  %>% filter(Fiscal_YQ<2024&SubCustomer.sum==c),
           filename=paste(file_c,"FYQ",sep="_"),xlsx=paste(file_c,"Contracts.xlsx",sep="_"),
           sheet="FYQ",path=file.path("../output/AcqTrends/Customer/",file_c), height=3.5,
           startRow=1,startCol=13,format=TRUE,var_list=c("Vehicle.AwardTask","Vehicle.sum7"),
           output_doc_png=TRUE,excel_y_var=TRUE
           )
  
}
```


## Topline and TOA (Greenbook)
```{r TOAfms}

if(!exists("platpscintldef"))
  load(file="../data/clean/platpscintl_FPDS.Rda")

fpds_annual<-platpscintldef %>% filter(Fiscal_Year<2024) %>% group_by(Fiscal_Year,dFYear,IsFMS,
                                    ContractingCustomer,YTD) %>% summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE),
                                                                       Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))
fpds_annual$Series<-"Contract Obligations"
toa$ContractingCustomer<-"Defense"
toa$Action_Obligation_OMB25_GDP23<-NA
toa$Action_Obligation_Then_Year<-NA
toa$Fiscal_Year<-text_to_number(toa$Fiscal_Year)
toa$YTD<-NA
toa$IsFMS<-0
fpds_annual$Total_Obligation_Authority_Then_Year<-NA
fpds_annual$Total_Obligation_Authority_OMB25_GDP23<-NA
colnames(toa)[!colnames(toa) %in% colnames(fpds_annual)]
colnames(fpds_annual)[!colnames(fpds_annual) %in% colnames(toa)]
fpds_annual<-rbind(as.data.frame(fpds_annual),as.data.frame(toa))# %>% dplyr::select(-fiscal_quarter)

fpds_annual$FMS<-as.character(fpds_annual$IsFMS)
fpds_annual$FMS[fpds_annual$Fiscal_Year<2012 | is.na(fpds_annual$IsFMS)]<-"Obligations (reliable\nFMS labels not available)"
fpds_annual$FMS[!is.na(fpds_annual$Total_Obligation_Authority_OMB25_GDP23)]<-"Obligations (no FMS)"
fpds_annual$FMS<-factor(fpds_annual$FMS)
levels(fpds_annual$FMS)<-list("Obligations (includes FMS)"=c("1","Obligations (includes FMS)"),
                              "Obligations (no FMS)"=c("0","Obligations (no FMS)"),
                              "Obligations (reliable\nFMS labels not available)"="Obligations (reliable\nFMS labels not available)")
fpds_annual$Topline<-"Total Obligation Authority"

fa_lc<-prepare_labels_and_colors(fpds_annual,path="offline")
fa_ck<-get_column_key(fpds_annual,path="offline")


(toplineTOA<-build_plot(data=fpds_annual %>% filter(Fiscal_Year>=1990),#rbind(quarterly,q2021,e2021),
                     chart_geom="Bar Chart",
                     x_var="dFYear",#alpha_var="YTD",
                     y_var="Action_Obligation_OMB25_GDP23",
           color_var="FMS",
               labels_and_colors=fa_lc,
  column_key=fa_ck
       )+
    geom_path(aes(x=dFYear,y=Total_Obligation_Authority_OMB25_GDP23,color=Topline))+
    scale_color_manual(name="Budget",values="black")+
  # scale_alpha_discrete(range=c(0.4,1))+
    labs(x="Fiscal Year",y="Constant FY 2023 $",fill="Contract",color="Budget",
         title="DOD Contract Obligations and Total Obligation Authority, FY 1990-FY 2023",
         caption="Source: FPDS, FY 2024 DoD Greenbook, CSIS Analysis")+
    theme(legend.position = "right")+
    date_x_year_breaks(1990,2028,3)#,partial_year=2024,partial_label="\nQ1")
)


ggsave600dpi(toplineTOA,file=file.path("..","Output","AcqTrends","topline_toa_annual.png"),  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )


output_TY<-toplineTOA$data %>%
  mutate(source=ifelse(!is.na(Total_Obligation_Authority_Then_Year),
                       "TOA","Contract"),
         Dollars=ifelse(source=="Budget",
                        Total_Obligation_Authority_Then_Year,Action_Obligation_Then_Year))%>%
  filter(Fiscal_Year>=1990)%>%
          format_data_for_plot(
                               fy_var="Fiscal_Year",
                               y_var="Dollars",
                               color_var="source",
                               facet="FMS",
                               # labels_and_colors = ota_lc,
                               group=TRUE) %>%
            arrange(Fiscal_Year) 


output_TY<-deflate(output_TY,money_var = "Dollars",deflator_var="OMB25_GDP23",path="offline")

# 
# output_TY<-toplineTOA$data %>%
#   mutate(source=ifelse(!is.na(Total_Obligation_Authority_Then_Year),
#                        "TOA","Contract"),
#          Dollars=ifelse(source=="TOA",
#                         Total_Obligation_Authority_Then_Year,Action_Obligation_Then_Year))%>%
#   filter(Fiscal_Year>=1990)%>%
#           format_data_for_plot(
#                                fy_var="Fiscal_Year",
#                                y_var="Then_Year_Dollars",
#                                color_var="source",
#                                facet="FMS",
#                                # labels_and_colors = ota_lc,
#                                group=TRUE) %>%
#             arrange(Fiscal_Year) 

#+theme(plot.margin =margin(t=0,b=0,l=0.1,r=0.25,"inches"))
log_plot(plot=toplineTOA, 
         df=output_TY   ,y_var="Dollars_OMB25_GDP23",#%>% filter(Fiscal_YQ<2024),
                     filename="acq_fig2_1_toa_annual",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="2-1 TOA",path="../output/AcqTrends/", height=3,excel_formulas = TRUE,
                     startRow=1,startCol=13,format=TRUE,var_list=c("source","FMS"),
         output_doc_svg=TRUE
         )

log_plot(plot=toplineTOA, df=output_TY,y_var="Dollars_OMB25_GDP23",
                     filename="nps_figXX_toa_fms",xlsx="DoD_2024_NPS.xlsx",
                     sheet="1 TOA",path="../output/AcqTrends/NPS2024/",
         second_path=online_path,
         height=3,include_YTD=FALSE,
                     format=TRUE,excel_y_var=TRUE,excel_formulas = TRUE,
         output_slide_png=TRUE,var_list=c("source","FMS")
         )


```

## Topline and Outlays (Public Budget Data)
```{r OutlayFMS}

if(!exists("platpscintldef"))
  load(file="../data/clean/platpscintl_FPDS.Rda")

fpds_annual<-platpscintldef %>% filter(Fiscal_Year<2024) %>% 
  group_by(Fiscal_Year,dFYear,IsFMS,ContractingCustomer,YTD) %>% 
  summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE),
            Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))

fpds_annual$Series<-"Contract Obligations"
outlay$ContractingCustomer<-"Defense"
outlay$Action_Obligation_OMB25_GDP23<-NA
outlay$Action_Obligation_Then_Year<-NA
outlay$Fiscal_Year<-text_to_number(outlay$Fiscal_Year)
outlay$YTD<-NA
outlay$IsFMS<-0
fpds_annual$Outlays_Then_Year<-NA
fpds_annual$Outlays_OMB25_GDP23<-NA
colnames(outlay)[!colnames(outlay) %in% colnames(fpds_annual)]
colnames(fpds_annual)[!colnames(fpds_annual) %in% colnames(outlay)]
fpds_annual<-rbind(as.data.frame(fpds_annual),as.data.frame(outlay))# %>% dplyr::select(-fiscal_quarter)

fpds_annual$FMS<-as.character(fpds_annual$IsFMS)
fpds_annual$FMS[fpds_annual$Fiscal_Year<2012 | is.na(fpds_annual$IsFMS)]<-"Obligations (reliable\nFMS labels not available)"
fpds_annual$FMS[!is.na(fpds_annual$Outlays_OMB25_GDP23)]<-"Obligations (no FMS)"
fpds_annual$FMS<-factor(fpds_annual$FMS)
levels(fpds_annual$FMS)<-list("Obligations (includes FMS)"=c("1","Obligations (includes FMS)"),
                              "Obligations (no FMS)"=c("0","Obligations (no FMS)"),
                              "Obligations (reliable\nFMS labels not available)"="Obligations (reliable\nFMS labels not available)")
fpds_annual$Topline<-"Outlays"


fa_lc<-prepare_labels_and_colors(fpds_annual,path="offline")
fa_ck<-get_column_key(fpds_annual,path="offline")

(toplineOutlay<-build_plot(data=fpds_annual %>% filter(Fiscal_Year>=1990),#rbind(quarterly,q2021,e2021),
                     chart_geom="Bar Chart",
                     x_var="dFYear",#alpha_var="YTD",
                     y_var="Action_Obligation_OMB25_GDP23",
           color_var="FMS",
           labels_and_colors = fa_lc,
           column_key = fa_ck
       )+
    geom_path(aes(x=dFYear,y=Outlays_OMB25_GDP23,color=Topline))+
    scale_color_manual(name="Budget",values="black")+
  # scale_alpha_discrete(range=c(0.4,1))+
    labs(x="Fiscal Year",y="Constant FY 2023 $",fill="Contract",color="Budget",
         caption="Source: FPDS, FY 2025 Office of Management\nand Budget Public Historical Tables, CSIS Analysis",
         title="DOD Contract Obligations and Outlays, FY 1990-FY 2023")+
    theme(legend.position = "right")+
    date_x_year_breaks(1990,2029,3)#,partial_year=2024,partial_label="\nQ1")
)


ggsave600dpi(toplineOutlay,file=file.path("..","Output","AcqTrends","toplineOutlay_outlay_annual.png"),  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )


output_TY<-toplineOutlay$data %>%
  mutate(source=ifelse(!is.na(Outlays_Then_Year),
                       "Outlays","Contract"),
         Dollars=ifelse(source=="Outlays",
                        Outlays_Then_Year,Action_Obligation_Then_Year))%>%
  filter(Fiscal_Year>=1990)%>%
          format_data_for_plot(
                               fy_var="Fiscal_Year",
                               y_var="Dollars",
                               color_var="source",
                               facet="FMS",
                               # labels_and_colors = ota_lc,
                               group=TRUE) %>%
            arrange(Fiscal_Year) 


output_TY<-deflate(output_TY,money_var = "Dollars",deflator_var="OMB25_GDP23",path="offline")

#+theme(plot.margin =margin(t=0,b=0,l=0.1,r=0.25,"inches"))
log_plot(plot=toplineOutlay, 
         df=output_TY   , y_var="Dollars_OMB25_GDP23",#%>% filter(Fiscal_YQ<2024),
                     filename="acq_fig2_1_outlay_annual",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="1 Outlay",path="../output/AcqTrends/", height=3,
         excel_formulas = TRUE,
                     startRow=1,startCol=13,format=TRUE,var_list=c("source","FMS"),
         output_doc_svg=TRUE
         )


log_plot(plot=toplineOutlay, df=output_TY,y_var="Dollars_OMB25_GDP23",
                     filename="nps_fig01_outlay_fms",xlsx="DoD_2024_NPS.xlsx",
                     sheet="1 Outlay",path="../output/AcqTrends/NPS2024/",second_path=online_path,
         height=3,include_YTD=FALSE,
                     format=TRUE,excel_y_var=TRUE,excel_formulas = TRUE,
         output_slide_png=TRUE,var_list=c("source","FMS"),suppress_doc_svg_text = "title"
         )
summary(factor(platpscintldef$IsJSF))
View(platpscintldef %>% group_by(Fiscal_Year,IsFMS,IsJSF) %>% filter(IsJSF=="JSF (F-35)") %>%
  summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE)))
```

## Topline Pricing
```{r ToplinePricing}

# def_data$PricingUCA.sumlong<-def_data$PricingUCA.sum
# levels(def_data$PricingUCA.sumlong)<-list("Firm Fixed-Price"="FFP",
#                                            "Less Common"="Less Common",
#                                            "Incentive"="Incentive",
#                                            "Other Cost-Based"="Other CB",
#                                            "Undefinitized\nContract Award"="UCA",
#                                            "Unclear"="Unclear"   )
(
ToplinePricing<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingUCA", #color_var
  facet_var="PricingUCA.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE,
  alpha_var="YTD",
)+date_x_year_breaks(2000,2023,7)+#,partial_year=2024,partial_label="\nQ1")
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+facet_wrap(~PricingUCA.sum,nrow=1)+
  labs(y="Obligations\n(Constant 2023 $s)",
       title="DOD Contract Obligations by Pricing Mechanism, FY 2000–FY 2023",
       caption="Note: CB=Cost-Based, FFP=Firm Fixed Price, FP=Fixed-Price, FPLOE=Fixed-Price Level-of-Effort,\nLH=Labor Hours,T&M=Time & Materials, UCA=Undefinitized Contract Award\nSource: FPDS and CSIS analysis.")
)





ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_pricing.png", ToplinePricing,  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )


log_plot(plot=ToplinePricing+theme(plot.margin = margin(t=0,r=0.25,b=0.1,l=0.1,"inches")), df=def_data  %>% filter(Fiscal_YQ<2024),
                     filename="aila_fig54_pricing",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="4-1 Price",path="../output/AcqTrends/", height=3.5,second_path=online_path,
         output_slide_png = TRUE,
                     format=TRUE,var_list=c("PricingUCA.sum","PricingUCA"),
         excel_formula=TRUE, excel_y_var = TRUE
         )

```


### Pricing UCA History
```{r ToplinePricing}
if(!exists("pricing"))
  load(file="../data/clean/pricing_latest.Rda")


if(!"Action_Obligation_OMB25_GDP23" %in% colnames(pricing))
  pricing<-deflate(pricing, "Action_Obligation_Then_Year",deflator_var="OMB25_GDP23",path="offline")

hist_lc<-prepare_labels_and_colors(pricing %>% select(-ContractingOfficeName,-PricingMechanism,-MajorCommandName))#,path=local_path
hist_ck<-get_column_key(pricing)#,path=local_path
# pricing$Fiscal_YQ<-pricing$Fiscal_Year
# pricing$YTD<-"Full Year"
PricingUpdate<-rbind(pricing[pricing$Fiscal_Year>2023,colnames(pricing) %in% colnames(def_data)],
                     def_data[def_data$Fiscal_Year<=2023,
                              colnames(def_data) %in% colnames(pricing)]
                     )


(
ToplinePricing<-build_plot(
  data=PricingUpdate %>% filter(Fiscal_Year>=2000 & Fiscal_Year<2025),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingUCA", #color_var
  facet_var="PricingUCA.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE,
  # alpha_var="YTD",
)+date_x_year_breaks(2000,2024,6)+#,partial_year=2024,partial_label="\nQ1")
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+facet_wrap(~PricingUCA.sum,nrow=1)+
  labs(y="Obligations\n(Constant 2023 $s)",
       title="DOD Contract Obligations by Pricing Mechanism, FY 2000–FY 2024",
       caption="Note: CB=Cost-Based, FFP=Firm Fixed Price, FP=Fixed-Price, FPLOE=Fixed-Price Level-of-Effort,\nLH=Labor Hours,T&M=Time & Materials, UCA=Undefinitized Contract Award\nSource: FPDS and CSIS analysis.")
)


  ggsave600dpi(path="..//Output//AcqTrends//",filename="Topline_PricingUCA.png", ToplinePricing,  
               width=6.5, height= 3, units="in",size=12, lineheight=1.2
               )
  
  
  ggsave600dpi(path="..//Output//AcqTrends//",filename="Topline_PricingUCA.svg", ToplinePricing,  
               width=12, height= 5.5, units="in",size=, lineheight=1.2
               )


log_plot(plot=ToplinePricing, df=PricingUpdate  %>% filter(Fiscal_Year<2025&Fiscal_Year>=2000),
                     filename="acq_fig8_2_pricing_uca",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="8-2 PriceUCA",path="../output/AcqTrends/", height=3.5,
                     format=TRUE,output_slide_png=TRUE,include_YTD=FALSE,#,var_list=c("PricingInflation",
         excel_y_var =TRUE,
         excel_share =TRUE,excel_formulas = TRUE
         )

(
PricingHistory<-build_plot(
  data=PricingUpdate %>% filter(Fiscal_Year < 2025 & Fiscal_Year>=2000),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=hist_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingUCA.sum", #color_var
  # facet_var="PricingUCA.sumlong", #facet_var
  column_key=hist_ck,
  format=TRUE,
  ytextposition=FALSE
)+#+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right",
        plot.caption = element_text(hjust = 0,face="plain"))+
    date_x_year_breaks(2000,2024,6)+#,partial_year=2024,partial_label="\nQ1")
    # xlim(c(as.Date("1979-01-01"), as.Date("2023-12-30")))+
    # coord_cartesian(xlim = c(as.Date("1980-01-01"), as.Date("2022-01-01"))
  labs(y="Share of Obligations",caption="Source: Federal Procurement Data System (FPDS) and CSIS analysis.")
)


  ggsave600dpi(path="..//Output//AcqTrends//",filename="Topline_PricingUCA_Share.png", PricingHistory,  
               width=6.5, height= 3, units="in",size=12, lineheight=1.2
               )
  
  
  ggsave600dpi(path="..//Output//AcqTrends//",filename="Topline_PricingUCA_Share.svg", PricingHistory,  
               width=12, height= 5.5, units="in",size=, lineheight=1.2
               )

# log_plot(plot=PricingHistory, df=PricingUpdate  %>% filter(Fiscal_Year<2025&Fiscal_Year>=2000),
#                      filename="acq_fig8_2_pricing_uca",xlsx="DoD_Acq_Trends_Contracts.xlsx",
#                      sheet="8-2 PriceUCA",path="../output/AcqTrends/", height=3.5,
#                      format=TRUE,output_slide_png=TRUE
#          ,#,var_list=c("PricingInflation",
#          excel_y_var =TRUE,
#          excel_share =TRUE
#          )


```
### Pricing R&D UCA History
```{r ToplinePricing}
if(!exists("pricing"))
  load(file="../data/clean/pricing_latest.Rda")


if(!"Action_Obligation_OMB25_GDP23" %in% colnames(pricing))
  pricing<-deflate(pricing, "Action_Obligation_Then_Year",deflator_var="OMB25_GDP23",path="offline")

hist_lc<-prepare_labels_and_colors(pricing %>% select(-ContractingOfficeName,-PricingMechanism,-MajorCommandName))#,path=local_path
hist_ck<-get_column_key(pricing)#,path=local_path
# pricing$Fiscal_YQ<-pricing$Fiscal_Year
# pricing$YTD<-"Full Year"
PricingUpdate<-rbind(pricing[pricing$Fiscal_Year>2023,colnames(pricing) %in% colnames(def_data)],
                     def_data[def_data$Fiscal_Year<=2023,
                              colnames(def_data) %in% colnames(pricing)]
                     )


(
ToplinePricing<-build_plot(
  data=PricingUpdate %>% filter(Fiscal_Year>=2000 & Fiscal_Year<2025 & SimpleArea=="R&D") ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingUCA", #color_var
  facet_var="PricingUCA.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE,
  # alpha_var="YTD",
)+date_x_year_breaks(2000,2024,6)+#,partial_year=2024,partial_label="\nQ1")
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+facet_wrap(~PricingUCA.sum,nrow=1)+
  labs(y="Obligations\n(Constant 2023 $s)",
       title="DOD R&D Contract Obligations by Pricing Mechanism, FY 2000–FY 2024",
       caption="Note: CB=Cost-Based, FFP=Firm Fixed Price, FP=Fixed-Price, FPLOE=Fixed-Price Level-of-Effort,\nLH=Labor Hours,T&M=Time & Materials, UCA=Undefinitized Contract Award\nSource: FPDS and CSIS analysis.")
)


  ggsave600dpi(path="..//Output//AcqTrends//",filename="RnD_PricingUCA.png", ToplinePricing,  
               width=6.5, height= 3, units="in",size=12, lineheight=1.2
               )
  
  
  ggsave600dpi(path="..//Output//AcqTrends//",filename="RnD_PricingUCA.svg", ToplinePricing,  
               width=12, height= 5.5, units="in",size=, lineheight=1.2
               )



(
PricingHistory<-build_plot(
  data=PricingUpdate %>% filter(Fiscal_Year < 2025 & Fiscal_Year>=2000 & SimpleArea=="R&D"),
  chart_geom = "Line Chart",
  share = TRUE,
  labels_and_colors=hist_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PricingUCA.sum", #color_var
  # facet_var="PricingUCA.sumlong", #facet_var
  column_key=hist_ck,
  format=TRUE,
  ytextposition=FALSE
)+#+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right",
        plot.caption = element_text(hjust = 0,face="plain"))+
    date_x_year_breaks(2000,2024,6)+#,partial_year=2024,partial_label="\nQ1")
    # xlim(c(as.Date("1979-01-01"), as.Date("2023-12-30")))+
    # coord_cartesian(xlim = c(as.Date("1980-01-01"), as.Date("2022-01-01"))
  labs(y="Share of Obligations",caption="Source: Federal Procurement Data System (FPDS) and CSIS analysis.")
)


  ggsave600dpi(path="..//Output//AcqTrends//",filename="RnD_PricingUCA_Share.png", PricingHistory,  
               width=6.5, height= 3, units="in",size=12, lineheight=1.2
               )
  
  
  ggsave600dpi(path="..//Output//AcqTrends//",filename="RnD_PricingUCA_Share.svg", PricingHistory,  
               width=12, height= 5.5, units="in",size=, lineheight=1.2
               )

log_plot(plot=PricingHistory, df=PricingUpdate  %>% filter(Fiscal_Year<2025&Fiscal_Year>=2000 & SimpleArea=="R&D"),
                     filename="acq_fig8_2_pricing_uca",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="8-2 RnD PriceUCA",path="../output/AcqTrends/", height=3.5,
                     format=TRUE,#,var_list=c("PricingInflation",
         excel_y_var =TRUE,
         excel_share =TRUE
         )


```

## Topline Commercial
```{r Commercial}
def_data$AnyCommercialText<-factor(def_data$AnyCommercial)
levels(def_data$AnyCommercialText)<-list(
  "Not Classified\nas Commercial"="N",
  "Non-development\nor Commercial Similar"= "NonDev",
  "Any Commercial\nClassification"="Y"
  
)

(
Commercial<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="AnyCommercialText", #color_var
  # facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")+
  date_x_year_breaks(2000,2022,2)#)#,partial_year=2024,partial_label="\nOct–Nov")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_commercial.png", Commercial, 
             width=11, height= 5.5, units="in",size=14,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_commercial.svg", Commercial+
  labs(y="Obligations\n(Constant 2023 $s)"),#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 2.25, units="in",size=11,lineheight = 1.2
             )


log_plot(plot=Commercial+labs(y="Obligations\n(Constant 2023 $s)"), df=def_data %>% filter(Fiscal_YQ<2024),
                     filename="acq_fig5_4_commercial",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="5-4 Comm",path="../output/AcqTrends/", height=2.5,
                     startRow=1,startCol=12,format=TRUE,#var_list=c("SimpleArea","Competition.multisum")
         )


def_data %>% filter(SubCustomer.sum=="Army", PlatformPortfolio=="Other Products", Fiscal_Year==2021) %>%
  group_by(AnyCommercialText,Competition.multisum) %>% summarise(
    COVID19obligated=sum(COVID19obligated,na.rm=TRUE),
    Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
    Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year),
    
  )

```



## Topline Multi-Year
```{r Multi-Year}
def_data<-def_data%>% mutate(multiyearcontracttext=factor(multiyearcontract,levels=c("0","1"),
                              labels=c("Not Multi-Year","Multi-Year Contract")))


(
MultiYear<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="multiyearcontract", #color_var
  # facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")+
  date_x_year_breaks(2000,2022,2)#)#,partial_year=2024,partial_label="\nOct–Nov")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_Multiyear.png", Multiyear, 
             width=11, height= 5.5, units="in",size=14,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_Multiyear.svg", Multiyear+
  labs(y="Obligations\n(Constant 2023 $s)"),#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 2.25, units="in",size=11,lineheight = 1.2
             )


# full_data %>% filter(SubCustomer.sum=="Army", PlatformPortfolio=="Other Products", Fiscal_Year==2021) %>%
#   group_by(AnyMultiyearText,Competition.multisum) %>% summarise(
#     COVID19obligated=sum(COVID19obligated,na.rm=TRUE),
#     Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23),
#     Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year),
#     
#   )

```


```{r ToplinePricing}
    full_data<-full_data%>% mutate(multiyearcontracttext=factor(multiyearcontract,levels=c("0","1"),
                              labels=c("Not Multi-Year","Multi-Year Contract")))

full_data$multiyearcontracttext[is.na(full_data$multiyearcontract)&
                             full_data$Vehicle %in% c("BOA","BPA","FSS","GWAC","PO","DO") ]<-"Not Multi-Year"
  # "MULTIPLE AWARD IDC"  "SINGLE AWARD IDC"   "Unlabeled IDC"        "DCA"    "DO"   


# full_data %>% group_by(Vehicle) %>%
#   dplyr::summarise(multiyearcontracttext=sum(
#     ifelse(multiyearcontracttext=="Multi-Year Contract",Action_Obligation_OMB25_GDP23,0),na.rm=TRUE))



full_data<-full_data %>% group_by(Fiscal_Year,Vehicle.sum7)%>%
  mutate(pPlatFYear=Action_Obligation_OMB25_GDP23/sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))
```
### Multi-Year Vehicle
```{r VehicleMultiyear}
def_data %>% group_by(Vehicle,multiyearcontracttext) %>%
  dplyr::summarise(Action_Obligation_OMB25_GDP23=sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))

    def_data<-def_data%>% mutate(multiyearcontracttext=factor(multiyearcontract,levels=c("0","1"),
                              labels=c("Not Multi-Year","Multi-Year Contract")))

def_data<-def_data %>% group_by(Fiscal_Year,PlatformPortfolio)%>%
  mutate(pPlatFYear=Action_Obligation_OMB25_GDP23/sum(Action_Obligation_OMB25_GDP23,na.rm=TRUE))

levels(factor(def_data$Vehicle))

(
VehicleMultiYear<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = TRUE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="multiyearcontracttext", #color_var
  facet_var="Vehicle",
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

(
VehicleMultiYearShare<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Vehicle.sum7!="Unlabeled"&
                             (is.na(multiyearcontract)|multiyearcontract==1)),
  chart_geom = "Line Chart",
  share = FALSE,
  labels_and_colors=labels_and_colors,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="pVehFYear", #VAR.y.variable
  color_var="multiyearcontracttext", #color_var
  facet_var="Vehicle.sum7",
  column_key=column_key,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(2000,2022,2)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "bottom")+
  labs(y="Share of Obligations")+
    scale_y_continuous(labels = percent)
)


ggsave600dpi(path="..//Output//AcqTrends//",filename="Vehicle_MultiYear.png", VehicleMultiYear,  
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="Vehicle_MultiYearShare.png", VehicleMultiYearShare,  
             width=6.5, height= 4, units="in",size=12, lineheight=1.2
             )

write.csv(file="..//Output//AcqTrends//VehicleMultiYearShare.csv",row.names = FALSE, na = "",
  pivot_wider(VehicleMultiYearShare$data %>% 
                        arrange(dFYear) %>% mutate(Fiscal_Year=lubridate::year(dFYear)),
                      id_cols=c(Vehicle.sum7,multiyearcontracttext),
                      names_from=Fiscal_Year,values_from=pPlatFYear)%>%
  arrange(Vehicle.sum7,multiyearcontracttext))
  


```

## Topline GFE
```{r GFE}

def_data$gfe_gfp_value<-factor(def_data$gfe_gfp_code)
levels(def_data$gfe_gfp_value)<-list(
   "No Government Furnished"="N",
  "Transaction uses\nGovernment Furnished\nEquipment or Property"="Y"
 
)

```



### GFE Competition
```{r GFEcomp}
summary(def_data$gfe_gfp_code)
(
GFEcomp<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="No.Competition.sum", #color_var
  facet_var="gfe_gfp_value", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")+
    scale_x_date(breaks=as.Date(c(paste(seq(2000,2021,3),"-01-01",sep=""))),
                                                   date_labels="'%y")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="platform_GFE.png", GFEplat, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="platform_GFE.svg", GFEplat, 
             width=6.5, height= 4.5, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="platform_GFE.emf", GFEplat, 
             width=6.5, height= 4.5, units="in",size=11,lineheight = 1.2
             )


# write.csv(file="..//Output//AcqTrends//platform_GFE.csv",row.names = FALSE, na = "",
#           pivot_wider(GFEplat$data,id_cols=c(PlatformPortfolio,gfe_gfp_value),
#                       names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23))

write.csv(file="..//Output//AcqTrends//platform_GFE_current.csv",row.names = FALSE, na = "",
          def_data %>% group_by(PlatformPortfolio,gfe_gfp_value,Fiscal_Year)%>%
            filter(Fiscal_Year>=2004 & Fiscal_YQ<2024)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(PlatformPortfolio,gfe_gfp_value),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(def_data$ContractingSubCustomer)
```


## Topline Cost Accounting
```{r SubCustomer}


(
CAS<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2001 & Fiscal_YQ<2024) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="costaccountingstandardsclause", #color_var
  facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)


(
CAS<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="costaccountingstandardsclause", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)


(
CAS<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="Competition.detail", #color_var
  facet_var="costaccountingstandardsclause", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)


(
CAS<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="AnyCommercial", #color_var
  facet_var="costaccountingstandardsclause", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_subcustomer.png", SubCustomer, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_subcustomer.svg", SubCustomer+facet_wrap(~SubCustomer.sum,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_subcustomer.emf", SubCustomer+facet_wrap(~SubCustomer.sum,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )


write.csv(file="..//Output//AcqTrends//topline_subcustomer.csv",row.names = FALSE, na = "",
          pivot_wider(SubCustomer$data,id_cols=c(SubCustomer.sum,SubCustomer.platform),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23))

write.csv(file="..//Output//AcqTrends//topline_subcustomer_current.csv",row.names = FALSE, na = "",
          def_data %>% group_by(SubCustomer.sum,ContractingSubCustomer,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(SubCustomer.sum,ContractingSubCustomer),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(def_data$ContractingSubCustomer)
```

## Topline Energy Efficient
```{r SubCustomer}



(
EE<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="EnergyEfficient", #color_var
  facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)


(
EE<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2007 & Fiscal_YQ<2024) ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="EnergyEfficient", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")
)



ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_subcustomer.png", SubCustomer, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_subcustomer.svg", SubCustomer+facet_wrap(~SubCustomer.sum,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_subcustomer.emf", SubCustomer+facet_wrap(~SubCustomer.sum,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )


write.csv(file="..//Output//AcqTrends//topline_subcustomer.csv",row.names = FALSE, na = "",
          pivot_wider(SubCustomer$data,id_cols=c(SubCustomer.sum,SubCustomer.platform),
                      names_from=Fiscal_Year,values_from=Action_Obligation_OMB25_GDP23))

write.csv(file="..//Output//AcqTrends//topline_subcustomer_current.csv",row.names = FALSE, na = "",
          def_data %>% group_by(SubCustomer.sum,ContractingSubCustomer,Fiscal_Year)%>%
            dplyr::summarize(Action_Obligation_Then_Year=sum(Action_Obligation_Then_Year,na.rm=TRUE))%>%
          pivot_wider(id_cols=c(SubCustomer.sum,ContractingSubCustomer),
                      names_from=Fiscal_Year,values_from=Action_Obligation_Then_Year))

summary(def_data$ContractingSubCustomer)
```

#Product/Service/R&D

## Topline Product/Service/R&D
```{r ToplinePSR}
if(!exists("pricing"))
  load(file="../data/clean/pricing_latest.Rda")
PSR<-pricing

if(!"Action_Obligation_OMB25_GDP23" %in% colnames(PSR))
  PSR<-deflate(pricing, "Action_Obligation_Then_Year",deflator_var="OMB25_GDP23",path="offline")

# PSR$Fiscal_YQ<-PSR$Fiscal_Year
# PSR$YTD<-"Full Year"
PSRUpdate<-rbind(PSR[PSR$Fiscal_Year>2023,colnames(PSR) %in% colnames(def_data)],
                     def_data[def_data$Fiscal_Year<=2023,
                              colnames(def_data) %in% colnames(PSR)]
                     )
levels(factor(PSRUpdate$SimpleArea))
PSRUpdate$SimpleArea<-factor(PSRUpdate$SimpleArea)
levels(PSRUpdate$SimpleArea)<-list(PSRUpdate$SimpleArea,
  "Products"=c("Products","Products (All)"),
  "Services"=c("Services","Services (Non-R&D)"),
  "R&D"  ="R&D"  ,
  "Unlabeled" ="Unlabeled" 
                                   )

hist_lc<-prepare_labels_and_colors(PSRUpdate )#,path=local_path
hist_ck<-get_column_key(PSRUpdate)#,path=local_path


(
ToplinePSR<-build_plot(
  data=PSRUpdate %>% filter(Fiscal_Year<2025 & !is.na(SimpleArea) & SimpleArea!="Unlabeled"),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=hist_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  # alpha_var="YTD",
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SimpleArea", #color_var
  # facet_var="Competition.sum", #facet_var
  column_key=hist_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",
       caption="Note: Unlabeled product, service, and R&D areas not shown.\nSource: FPDS and CSIS analysis.")+
  date_x_year_breaks(1990,2020,5)#,partial_year=2024,partial_label="\nQ1",)
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_psr.png", ToplinePSR, 
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_psr.svg", ToplinePSR, 
             width=6.5, height= 3, units="in",size=11, lineheight=1.2
             )

log_plot(plot=ToplinePSR+facet_wrap(~SimpleArea), df=def_data %>% filter(Fiscal_YQ<2024),
                     filename="acq_fig3_1_area",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="3-1 Area",path="../output/AcqTrends/", height=3.5,
                     startRow=1,startCol=12,format=TRUE,#var_list=c("SimpleArea","Competition.multisum"),
         excel_y_var = TRUE,excel_formulas = TRUE
         )

```

## PSR OTA
```{r ToplinePSR}
# if(!exists("def_kota"))
#   load(file="../data/clean/def_kota.Rda")


PSRUpdate$IsOTA<-"Contract"
PSRUpdate$AreaType<-paste("Contract for",PSRUpdate$SimpleArea)


def_kota_update<-ota_def
def_kota_update$IsOTA<-"OTA"
def_kota_update$AreaType<-paste("OTA for",def_kota_update$TypeOfAgreement)

def_kota_update<-rbind(def_kota_update[,colnames(def_kota_update)[colnames(def_kota_update) %in% colnames(PSRUpdate)]],
               PSRUpdate[,colnames(PSRUpdate)[colnames(PSRUpdate) %in% colnames(def_kota_update)]])%>%
  filter(Fiscal_Year>=2015)



def_kota_update$AreaType<-factor(def_kota_update$AreaType)
levels(def_kota_update$AreaType)<-list(
  "OTA for Production"="OTA for Production",
  "Contract for Products"="Contract for Products (All)",
  "OTA for Prototype"="OTA for Prototype" ,
  "Contract for R&D"="Contract for R&D",
  "Contract for Services"="Contract for Services (Non-R&D)",
  "Unlabeled"=c("Contract for Unlabeled","OTA for NA")
)
def_kota_update$SimpleAreaType<-def_kota_update$AreaType
levels(def_kota_update$SimpleAreaType)<-list(
  "Products and Production"=c("Contract for Products",
                              "OTA for Production"),
  "R&D and Prototypes"=c("Contract for R&D",
                         "OTA for Prototype"),
  "Services"="Contract for Services",
  "Unlabeled"="Unlabeled")

def_kota_update<-def_kota_update %>% mutate(
  SimpleAreaType=factor(SimpleAreaType),
  AreaType=factor(AreaType)
)


(
OTAPSR<-build_plot(
  data=def_kota_update %>% filter(Fiscal_Year>=2015 & Fiscal_Year<2025 &
                                 !is.na(AreaType) & AreaType!="Unlabeled") ,
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=kota_lc,
  # NA, #VAR.ncol
  x_var="dFYear", #x_var
  # alpha_var="YTD",
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="AreaType", #color_var
  facet_var="SimpleAreaType", #facet_var
  column_key=kota_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",
       caption="Note: Unlabeled contract product, service, and R&D areas\nas well as unlabeled OTA agreement types not shown.\nSource: FPDS and CSIS analysis.",
       title="Defense Contract Obligations by Product, Service, and R&D and\nOTA Obligations by Agreement Type, FY 2015–FY 2023")+facet_wrap(~SimpleAreaType, nrow=1)+
  date_x_year_breaks(2015,2023,2)#,partial_year=2024,partial_label="\nQ1",)
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="OTA_psr.png", OTAPSR, 
             width=12, height= 6, units="in",size=12, lineheight=1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="OTA_psr.svg", OTAPSR, 
             width=6.5, height= 3, units="in",size=11, lineheight=1.2
             )

log_plot(plot=OTAPSR, df=def_kota_update %>% filter(Fiscal_Year<2025),
                     filename="acq_fig3_1a_kota_areatype",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="3-1a KOta",path="../output/AcqTrends/", height=3.5,include_YTD = FALSE,
                     startRow=1,startCol=12,format=TRUE,#var_list=c("SimpleArea","Competition.multisum"),
         excel_y_var = TRUE,excel_formulas = TRUE
         )



log_plot(plot=OTAPSR, df=def_kota_update %>% filter(Fiscal_Year<2025),
                     filename="nps_fig02_kota_areatype",xlsx="DoD_2024_NPS.xlsx",
                     sheet="2 KOta",path="../output/AcqTrends/NPS2024/",second_path=online_path,
         height=3,include_YTD=FALSE,output_slide_png=TRUE,suppress_doc_svg_text = "title",
                     startRow=1,format=TRUE,excel_y_var=TRUE,excel_formulas = TRUE,
         output_doc_svg=TRUE
         )

```

# SubCustomer
## Topline SubCustomer 
```{r SubCustomer}

(
SubCustomer<-build_plot(
  data=def_data %>% filter(Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="SubCustomer.JPO", #color_var
  facet_var="SubCustomer.sum", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)",
       title="DOD Contract Obligations by DOD Component, FY 1990-FY 2023") +date_x_year_breaks(1990,2020,5)#,partial_year=2024,partial_label="\nQ1")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_subcustomer.png", SubCustomer, 
             width=12, height= 6, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_subcustomer.svg", SubCustomer+facet_wrap(~SubCustomer.sum,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_subcustomer_keynote.svg", SubCustomer+
               facet_wrap(~SubCustomer.sum,nrow=1)+
               labs(title="DOD Contract Obligations by Component, 1990–2023")+
               date_x_year_breaks(1990,2020,8),#,partial_year=2024,partial_label="\nQ1"), 
             width=13, height= 5.5, units="in", size=20, lineheight = 0.75
             )

log_plot(plot=SubCustomer+facet_wrap(~SubCustomer.sum,nrow=1)+
           date_x_year_breaks(1990,2020,8),#,partial_year=2024,partial_label="\nQ1"),
         df=def_data %>% filter(Fiscal_YQ<2024),
                     filename="acq_fig2_3_subcustomer",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="2-3 Cust",path="../output/AcqTrends/", height=3.5,
                     startRow=1,startCol=13,format=TRUE,var_list=c("SubCustomer.sum","SubCustomer.JPO")
         )




log_plot(plot=SubCustomer+facet_wrap(~SubCustomer.sum,nrow=1)+
           date_x_year_breaks(1990,2022,8), df=def_data %>% filter(Fiscal_YQ<2024),
                     filename="nps_fig04_component",xlsx="DOD_2024_NPS.xlsx",
                     sheet="4 Cust",path="../output/AcqTrends/NPS2024/",second_path=online_path,
         height=3,include_YTD=FALSE,suppress_doc_svg_text="title",
                     startRow=1,format=TRUE,excel_y_var=TRUE,excel_formulas = TRUE,
         output_slide_png=TRUE
         )

```



## SubCustomer Commercial
```{r Commercial}
def_data$AnyCommercialText<-factor(def_data$AnyCommercial)
levels(def_data$AnyCommercialText)<-list(
  "Not Classified\nas Commercial"="N",
  "Non-development\nor Commercial Similar"= "NonDev",
  "Any Commercial\nClassification"="Y"
  
)

(
CommercialCust<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=2000 & Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="AnyCommercialText", #color_var
  facet_var="SubCustomer.platform", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "right")+
  labs(y="Obligations (Constant 2023 $s)")+
      date_x_year_breaks(2000,2023,6)#,partial_year=2024,partial_label="\nQ1")
    

)
 

ggsave600dpi(path="..//Output//AcqTrends//",filename="subcustomer_commercial.png", CommercialCust, 
             width=6, height= 5.5, units="in",size=12,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="subcustomer_commercial.svg", CommercialCust,#+facet_wrap(~SubCustomer.platform,nrow=1), 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",
             filename="subcustomer_commercial_keynote.png", CommercialCust+
               labs(title="DOD Contract Obligations by  Commercial Categorization, FY 2000–FY 2023"),
             width=13, height= 5.5, units="in", size=20, lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="subcustomer_commercial_keynote.svg", CommercialCust+
               labs(title="DOD Contract Obligations by  Commercial Categorization, FY 2000–FY 2023"),
             width=13, height= 5.5, units="in", size=20, lineheight = 1.2
             )


log_plot(plot=CommercialCust, df=def_data %>% filter(Fiscal_YQ<2024),
                     filename="acq_fig5_5_subcustomer_commercial",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="5-5 CustComm",path="../output/AcqTrends/", height=4,
                     startRow=1,startCol=13,format=TRUE,
         var_list=c("SubCustomer.platform","AnyCommercialText"),
         output_doc_svg=TRUE
         )
log_plot(plot=CommercialCust, df=def_data %>% filter(Fiscal_YQ<2024),
                     filename="nps_figXX_commercial_subcustomer",xlsx="DOD_2024_NPS.xlsx",
                     sheet="5 Comm",path="../output/AcqTrends/NPS2024/",second_path=online_path,
         height=4,include_YTD=FALSE,suppress_doc_svg_text="title",output_slide_png=TRUE,
                     startRow=1,format=TRUE,excel_y_var=TRUE,excel_formulas = TRUE,
         output_doc_svg=TRUE
         )


```



# Platform
## Topline  Platform
```{r Platform}
(
Platform<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=1990 & Fiscal_YQ<2024),
  chart_geom = "Line Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PlatformPortfolio", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(1990,2020,8)+#,partial_year=2024,partial_label="\nQ1")   
  # theme(strip.text.y = element_text(angle=0))+
 # theme(axis.text.x = element_text(angle=90))+
 #    scale_y_continuous("Percent of Obligations", labels = percent_format(accuracy=1))+
 #      facet_grid(.~Competition.sum ,scales="free_x", space="free_x"
 #             )+labs(title=NULL,
  # x="Fiscal Year",
  # y="Percent of Obligations",
  # color="Competition")+
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)",
       title="DOD Contract Obligations by Platform Portfolio, FY 1990-FY 2023")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_platform.png", Platform, 
             width=12, height= 6, units="in",size=14,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_platform.svg", Platform, 
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_platform.emf", Platform+geom_line(
  size=1,aes(x=dFYear,y=Action_Obligation_OMB25_GDP23,color=PlatformPortfolio)),
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )


(
Platform_Bar<-build_plot(
  data=def_data %>% filter(Fiscal_Year>=1990 & Fiscal_YQ<2024),
  chart_geom = "Bar Chart",
  share = FALSE,
  labels_and_colors=def_lc,
  # NA, #VAR.ncol
  x_var="dFYear",#alpha_var="YTD", #x_var
  y_var="Action_Obligation_OMB25_GDP23", #VAR.y.variable
  color_var="PlatformPortfolio", #color_var
  facet_var="PlatformPortfolio", #facet_var
  column_key=def_ck,
  format=TRUE,
  ytextposition=FALSE
)+date_x_year_breaks(1990,2020,8)+#,partial_year=2024,partial_label="\nQ1")   
  theme(legend.position = "none")+
  labs(y="Obligations (Constant 2023 $s)",
       title="DOD Contract Obligations by Platform Portfolio, FY 1990-FY 2023")
)

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_platform_bar.png", Platform_Bar, 
             width=11, height= 5.5, units="in",size=14,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_platform_bar.emf", Platform_Bar,
             width=6.5, height= 4, units="in",size=11,lineheight = 1.2
             )

ggsave600dpi(path="..//Output//AcqTrends//",filename="topline_platform_bar_keynote.svg", Platform_Bar+
               labs(title="DOD Contract Obligations by Platform Portfolio, FY 2000–FY 2023"),
             width=13, height= 5.5, units="in", size=20, lineheight = 0.75
             )


log_plot(plot=Platform_Bar+theme(plot.margin = margin(t=0,r=0.25,b=0.1,l=0.1,"inches")), df=def_data   %>% filter(Fiscal_YQ<2024),
                     filename="acq_fig3_2_platform",xlsx="DoD_Acq_Trends_Contracts.xlsx",
                     sheet="3-2 Plat",path="../output/AcqTrends/", height=3.5,
                     startRow=1,startCol=12,format=TRUE#var_list=c("Source","fiscal_quarter"),
         )


log_plot(plot=Platform_Bar+theme(plot.margin = margin(t=0,r=0.25,b=0.1,l=0.1,"inches")), df=def_data   %>% filter(Fiscal_YQ<2024),
                     filename="nps_fig03_platform",xlsx="DoD_2024_NPS.xlsx",
                     sheet="3 Plat",path="../output/AcqTrends/NPS2024/",second_path=online_path,
         height=3.5,include_YTD=FALSE,suppress_doc_svg_text="title",output_slide_png=TRUE,
                     startRow=1,format=TRUE,excel_y_var=TRUE,excel_formulas = TRUE,
         output_doc_svg=TRUE
         )


```

