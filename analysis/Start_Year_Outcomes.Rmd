---
title: "Start Year Performance"
author: "Greg Sanders"
date: "Wednesday, February 8, 2017"
output:
  html_document:
    keep_md: yes
--- 

Annual Outcome 
============================================================================


#Setup

## Read in packages and functions
```{r InputFiles, echo = TRUE}
source("https://raw.githubusercontent.com/CSISdefense/R-scripts-and-data/master/helper.r")
source("https://raw.githubusercontent.com/CSISdefense/R-scripts-and-data/master/lookups.r")
source("../scripts/DIIGstat.r")
source("https://raw.githubusercontent.com/CSISdefense/Crisis-Funding/master/Scripts/ContractCleanup.r")

library(csis360)
library(ggplot2)
library(scales)
library(Hmisc)
library(dplyr)
library(readr)
library(tidyverse)
# Coloration<-read.csv(
#     paste(Path,"Lookups\\","lookup_coloration.csv",sep=""),
#     header=TRUE, sep=",", na.strings="", dec=".", strip.white=TRUE, 
#     stringsAsFactors=FALSE
#     )
# 
# Coloration<-ddply(Coloration
#                   , c(.(R), .(G), .(B))
#                   , mutate
#                   , ColorRGB=as.character(
#                       if(min(is.na(c(R,G,B)))) {NA} 
#                       else {rgb(max(R),max(G),max(B),max=255)}
#                       )
#                   )

axis.text.size<-10
strip.text.size<-10
legend.text.size<-8
# table.text.size<-5.75
title.text.size<-12
geom.text.size<-12

main.text.size<-1
note.text.size<-1.40

all_labeled<-function(data){
  data<-data %>% dplyr::filter(
                                        !is.na(UnmodifiedDays) & 
               !is.na(UnmodifiedCeiling_OMB20_GDP18) &
               !is.na(p_CBre) & 
           !is.na(Term))
}

missing_caption<-function(data){
  data<-data %>% dplyr::filter(
                                        is.na(UnmodifiedDays) |
               is.na(UnmodifiedCeiling_OMB20_GDP18) |
               is.na(p_CBre) |
           is.na(Term))
  
  paste("Missing: Count:Data is missing for",prettyNum(nrow(data),big.mark=","),"contracts accounting for",
        round(sum(data$Action_Obligation_OMB23_GDP21)/1000000000,1),"B","in obligations.")
}

# FacetCount=paste("Count:",prettyNum(sum(Count),big.mark=",")),
#     FacetValue=paste(FacetCount,"\nObligated: $",round(sum(Action_Obligation_OMB23_GDP21)/1000000000,1),"B",sep="")

only_complete<-function(data){
  data<-all_labeled(data) %>%
    dplyr::filter((LastCurrentCompletionDate<=as.Date("2018-09-30") |
              IsClosed==1) &
           UnmodifiedCurrentCompletionDate<as.Date("2018-09-30"))
}



load(file="../data/clean/defense_contract_all_detail.RData")
# debug(transform_contract)
# undebug(transform_contract)

def_all<-def_all %>%
  dplyr::filter(StartFiscal_Year>=2007 & 
                  StartFiscal_Year<=2017 
  ) %>% dplyr::select(CSIScontractID,
                      IsTerminated,
                      IsClosed,
                      IsComplete,
                      pChangeOrderUnmodifiedBaseAndAll,
                      n_CBre,
                      Action_Obligation,
                      UnmodifiedDays,
                      qHighCeiling,
                      qLowCeiling,
                      UnmodifiedCeiling,
                      StartFiscal_Year,
                      LastCurrentCompletionDate,
                      UnmodifiedCurrentCompletionDate,
                      CBre,
                      SumOfisChangeOrder
                      )



#Unknown or uninitialised column: 'qCRais'.Unknown or uninitialised column: 'qNChg'.> 


if(any(duplicated(colnames(def_all)))) stop("Duplicate Contract Name")

def_all<-rename_dataset(def_all)
def_all<-transform_contract(def_all)


def_all<-FormatContractModel(def_all)

head(def_all)

# write.csv(subset(def_all,Term=="Terminated"),"Terminated.csv")

colnames(def_all)[colnames(def_all)=="pChangeOrderUnmodifiedBaseAndAll"]<-"p_CBre"


memory.limit(30000)
    

   
```


Contracts are classified using a mix of numerical and categorical variables. While the changes in numerical variables are easy to grasp and summarize, a contract may have one line item that is competed and another that is not. As is detailed in the exploration on R&D, we are only considering information available prior to contract start. The percentage of contract obligations that were competed is a valuable benchmark, but is highly influenced by factors that occured after contract start..


**A Histogram of the IsTerminated data** showing the distribution of whether or not a contract was terminated each year from 2007.  

```{r ContractTerminationGraphs, echo = TRUE, fig.width=3,fig.height=9, dpi=600}
# TerminatedDurSummary<-ddply(subset(def_all,StartFY>=2007 & 
#                   !is.na(Ceil)&
#                   UnmodifiedCompletionDate<=as.Date("2015-09-30")&
#                       !is.na(Term)),
#                             .(Ceil,
#                               qDuration,
#                               StartFY,
#                               Term
#                             ),
#                             dplyr::summarise,
#                             Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
#                             Count=length(CSIScontractID)
#                   )
# 
# 
# TerminatedDurSummary<-ddply(TerminatedDurSummary,.(Ceil,
#                                                   qDuration,
#                                              StartFY
#                                              ),transform,
#                       pContractCeilDurStart=Count/sum(Count),
#                       pObligationCeilDurStart=Action_Obligation_OMB23_GDP21/sum(Action_Obligation_OMB23_GDP21)
#       )
# 
# 
# ggplot(TerminatedDurSummary,
#        aes(x=StartFY,
#            y=Count,
#            color=Term))+geom_line()+    geom_point(aes(shape=metric))+facet_grid(Ceil ~ qDuration ) +scale_y_log10(labels=scales::comma)
# 
# 
# 
# 
# 
# 
# ggplot(
#   data = TerminatedEndSummary,
#   aes_string(x = "Term"),
#   ) + geom_bar() + 
#     facet_grid( Ceil ~ .,
#                 scales = "free_y",
#                 space = "free_y") + scale_y_continuous(expand = c(0,50)) 
# 
# 
# 
# 
# 
# ggplot(
#   data = subset(TerminatedEndSummary,Term=="Terminated"),
#   aes_string(x = "Ceil")
#   )+ geom_bar()+
#     scale_x_discrete("Original Ceiling (Current $ Value)")+scale_y_continuous("Number of Partially or Completely \nTerminated Contracts",labels = comma)+theme(axis.text.x=element_text(angle=90,size=12))
# 
# 
# 
# 
# 
# 
# TerminatedEndSummary$Graph[TerminatedEndSummary$Term=="Terminated"]<-TRUE
# 
# TerminatedEndSummary$Graph[TerminatedEndSummary$Term=="Unterminated"]<-FALSE
# 
# 
# head(TerminatedEndSummary)
# 
# ggplot(
#   data = subset(TerminatedEndSummary,Term=="Terminated"),
#   aes(x = Ceil,weight=Action_Obligation_OMB23_GDP21/1000000000)
#   )+ geom_bar()+
#     scale_x_discrete("Original Ceiling (Current $ Value)")+scale_y_continuous("Obligations to Partially or Completely\nTerminated Contracts (Current $ Billions)",labels = comma)+theme(axis.text.x=element_text(angle=90,size=12))
# 
# 
# ggplot(
#   data = subset(TerminatedEndSummary,Term=="Terminated"),
#   aes_string(x = "Ceil",weight="pContract")
# #   main="Percentage of Contracts going to Partially or Completely Terminated Contracts\nBy Initial Contract Ceiling"
#   )+ geom_bar()+ scale_y_continuous("Percent of Contracts Partially or Completely Terminated\nby Original Ceiling Category", labels=percent)+
#     scale_x_discrete("Original Ceiling (Current $ Value)")+theme(axis.text.x=element_text(angle=90,size=12))
# 
# 
# ggplot(
#   data = subset(TerminatedEndSummary,Term=="Terminated"),
#   aes_string(x = "Ceil",weight="pObligation"),
#   main="Percentage of Contract Obligations going to Partially or Completely Terminated Contracts\nBy Initial Contract Ceiling"
#   )+ geom_bar()+ scale_y_continuous("Percent of Obligations to Terminated Contracts \nin Original Ceiling Category", labels=percent)+
#     scale_x_discrete("Original Ceiling (Current $ Value)")+theme(axis.text.x=element_text(angle=90,size=12))
# 
# 
# # 
# # LatticePercentLineWrapper("VAR.name"
# #                                     ,"VAR.proper.name"
# #                                     ,"VAR.X.label"
# #                                     ,"VAR.Y.label"
# #                                     ,Coloration
# #                                     ,subset(TerminatedEndSummary,!is.na(Term))
# #                                     ,NULL
# #                                     ,"Ceil"
# #                                     ,"Count"
# #                                     ,"Term"
# #                                     ,NA
# #                                     ,NA
# #                                     )
# 
# # 
# # + 
# #     facet_grid( Ceil ~ .,
# #                 scales = "free_y",
# #                 space = "free_y") 
# # 

```


```{r ImportanceOfEndOfPeriod}





# 
# ggplot(TerminatedEndSummary,
#        aes(x=StartFY,
#            y=Count,
#            color=Term))+geom_line()+    geom_point(aes(shape=metric))+facet_grid(Ceil ~ EndAfterPeriod ) +scale_y_log10()

```


```{r AnnualTerminationRateAggregateYear, fig.width=3,fig.height=9, dpi=600}
# 
# TerminatedUnmodifiedYearsCatStat<-rbind(ddply(subset(def_all,
#                                 !is.na(qDuration) & StartFY>=2007 & 
#                                     !is.na(UnmodifiedYearsCat) &
#                                     UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")&
#                                     !is.na(Term)),
#                          .(UnmodifiedYearsCat,
#                            StartFY
#                          ),
#                          
#                          dplyr::summarise,
#                          Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
#                          Count=length(CSIScontractID),
#                          mean = mean(TermNum),
#                          sd   = NA ,# sd(TermNum),
#                          se   = NA, #sd / sqrt(Count),
#                          metric="Unweighted"
#                           # ceil.mean = wtd.mean(TermNum,UnmodifiedContractBaseAndAllOptionsValue),
#                          # ceil.cat.mean = wtd.mean(TermNum,ceil.median.wt)
# ))
# 
# 
# 
# TerminatedUnmodifiedYearsCatStat<-rbind(TerminatedUnmodifiedYearsCatStat,
#                          ddply(subset(def_all,
#                                 !is.na(qDuration) & StartFY>=2007 & 
#                                     !is.na(Ceil) &
#                                     UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")&
#                                     !is.na(Term)),
#                          .(UnmodifiedYearsCat,
#                            StartFY
#                          ),
#                          
#                          dplyr::summarise,
#                          Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
#                          Count=length(CSIScontractID),
#                          mean = wtd.mean(TermNum,ObligationWT),
#                          sd   = NA ,# sd(TermNum),
#                          se   = NA, #sd / sqrt(Count),
#                          metric="Obligation Weighted"
#                           # ceil.mean = wtd.mean(TermNum,UnmodifiedContractBaseAndAllOptionsValue),
#                          # ceil.cat.mean = wtd.mean(TermNum,ceil.median.wt)
# 
# ))
# 
# TerminatedUnmodifiedYearsCatStat<-rbind(TerminatedUnmodifiedYearsCatStat,
#                          ddply(subset(def_all,
#                                 !is.na(qDuration) & StartFY>=2007 & 
#                                     !is.na(Ceil) &
#                                     UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")&
#                                     !is.na(Term)),
#                          .(UnmodifiedYearsCat,
#                            StartFY
#                          ),
#                          
#                          dplyr::summarise,
#                          Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
#                          Count=length(CSIScontractID),
#                          mean = wtd.mean(TermNum,UnmodifiedContractBaseAndAllOptionsValue),
#                          sd   = NA ,# sd(TermNum),
#                          se   = NA, #sd / sqrt(Count),
#                          metric="Ceiling Weighted"
#                          # obl.mean = ,
#                          # ceil.mean = wtd.mean(TermNum,UnmodifiedContractBaseAndAllOptionsValue),
#                          # ceil.cat.mean = wtd.mean(TermNum,ceil.median.wt)
# 
# ))
# 
# 
# TerminatedUnmodifiedYearsCatStat<-rbind(TerminatedUnmodifiedYearsCatStat,
#                          ddply(subset(def_all,
#                                 !is.na(qDuration) & StartFY>=2007 & 
#                                     !is.na(Ceil) &
#                                     UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")&
#                                     !is.na(Term)),
#                          .(UnmodifiedYearsCat,
#                            StartFY
#                          ),
#                          
#                          dplyr::summarise,
#                          Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
#                          Count=length(CSIScontractID),
#                          mean = wtd.mean(TermNum,ceil.median.wt),
#                          sd   = NA ,# sd(TermNum),
#                          se   = NA, #sd / sqrt(Count),
#                          metric="Ceiling Category Weighted"
# 
# ))
# 
# 
# # 
# # pd <- position_dodge(0.1) # move them .05 to the left and right
# # 
# # ggplot(tgc, aes(x=dose, y=len, colour=supp)) + 
# #     geom_errorbar(aes(ymin=len-se, ymax=len+se), width=.1, position=pd) 
# 
# ggplot(TerminatedUnmodifiedYearsCatStat,aes(x=StartFY,y=mean,color=metric))+
#     geom_line()+
#         geom_point(aes(shape=metric))+
#     facet_grid(.~ UnmodifiedYearsCat ) +
#     scale_x_continuous("Contract Starting Fiscal Year")+
#     scale_y_continuous(label=percent)+
#     geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1)+
#     theme(legend.position="bottom") #, position=pd

```

```{r AnnualTerminationRateAggregateDur, fig.width=3,fig.height=9, dpi=600}
# 
# TerminatedDurStat<-rbind(                         ddply(subset(def_all,
#                                 !is.na(qDuration) & StartFY>=2007 & 
#                                     StartFY<=2014 & 
#                                     !is.na(Ceil) &
#                                     UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")&
#                                     !is.na(Term)),
#                          .(qDuration,
#                            StartFY
#                          ),
#                          
#                          dplyr::summarise,
#                          Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
#                          Count=length(CSIScontractID),
#                          mean = mean(TermNum),
#                          sd   = sd(TermNum),
#                          se   = sd / sqrt(Count),
#                          metric="Unweighted"
#                           # ceil.mean = wtd.mean(TermNum,UnmodifiedContractBaseAndAllOptionsValue),
#                          # ceil.cat.mean = wtd.mean(TermNum,ceil.median.wt)
# ))
# 
# 
# TerminatedDurStat<-rbind(TerminatedDurStat,
#                          ddply(subset(def_all,
#                                 !is.na(qDuration) & StartFY>=2007 & 
#                                     StartFY<=2014 & 
#                                     !is.na(Ceil) &
#                                     UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")&
#                                     !is.na(Term)),
#                          .(qDuration,
#                            StartFY
#                          ),
#                          
#                          dplyr::summarise,
#                          Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
#                          Count=length(CSIScontractID),
#                          mean = wtd.mean(TermNum,ObligationWT),
#                          sd   = sqrt(wtd.var(TermNum,ObligationWT)) ,
#                          se   = sd / sqrt(Count),
#                          metric="Obligation Weighted"
#                           # ceil.mean = wtd.mean(TermNum,UnmodifiedContractBaseAndAllOptionsValue),
#                          # ceil.cat.mean = wtd.mean(TermNum,ceil.median.wt)
# ))
# 
# TerminatedDurStat<-rbind(TerminatedDurStat,
#                          ddply(subset(def_all,
#                                 !is.na(qDuration) & StartFY>=2007 & 
#                                     StartFY<=2014 & 
#                                     !is.na(Ceil) &
#                                     UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")&
#                                     !is.na(Term)),
#                          .(qDuration,
#                            StartFY
#                          ),
#                          
#                          dplyr::summarise,
#                          Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
#                          Count=length(CSIScontractID),
#                          mean = wtd.mean(TermNum,UnmodifiedContractBaseAndAllOptionsValue),
#                          sd   = sqrt(wtd.var(TermNum,UnmodifiedContractBaseAndAllOptionsValue)) ,
#                          se   = sd / sqrt(Count),
#                          metric="Ceiling Weighted"
#                          # obl.mean = ,
#                          # ceil.mean = wtd.mean(TermNum,UnmodifiedContractBaseAndAllOptionsValue),
#                          # ceil.cat.mean = wtd.mean(TermNum,ceil.median.wt)
# 
# ))
# 
# 
# TerminatedDurStat<-rbind(TerminatedDurStat,
#                          ddply(subset(def_all,
#                                 !is.na(qDuration) & StartFY>=2007 & 
#                                     StartFY<=2014 & 
#                                     !is.na(Ceil) &
#                                     UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")&
#                                     !is.na(Term)),
#                          .(qDuration,
#                            StartFY
#                          ),
#                          
#                          dplyr::summarise,
#                          Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
#                          Count=length(CSIScontractID),
#                          mean = wtd.mean(TermNum,ceil.median.wt),
#                          sd   = sqrt(wtd.var(TermNum,ceil.median.wt)) ,
#                          se   = sd / sqrt(Count),
#                          metric="Ceiling Category Weighted"
# 
# ))
# 
# 
# # 
# # pd <- position_dodge(0.1) # move them .05 to the left and right
# # 
# # ggplot(tgc, aes(x=dose, y=len, colour=supp)) + 
# #     geom_errorbar(aes(ymin=len-se, ymax=len+se), width=.1, position=pd) 
# 
# ggplot(subset(TerminatedDurStat,!metric %in% c("Ceiling Weighted")),
#        aes(x=StartFY,y=mean,color=metric))+
#     geom_line()+
#         geom_point(aes(shape=metric))+
#     facet_grid( qDuration  ~.) +
#     scale_x_continuous("Contract Starting Fiscal Year")+
#     scale_y_continuous(label=percent)+
#     geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1)+
#     theme(legend.position="bottom") #, position=pd
# 
# ggplot(subset(TerminatedDurStat,!metric %in% c("Ceiling Weighted","Ceiling Category Weighted")),
#        aes(x=StartFY,y=mean,color=metric))+
#     geom_line()+
#         geom_point(aes(shape=metric))+
#     facet_grid( qDuration  ~., space = "free_y", scales="free_y") +
#     scale_x_continuous("Contract Starting Fiscal Year")+
#     scale_y_continuous(label=percent)+
#     geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1)+
#     theme(legend.position="bottom") #, position=pd
# 
# 

```


```{r SDurCount, fig.width=3,fig.height=9, dpi=600}
# TerminatedDur.SimpleStatCount<-ddply(subset(def_all,
#                                 !is.na(qDuration) & StartFY>=2007 & 
#                                     StartFY<=2014 & 
#                                     !is.na(Ceil) &
#                                     UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")&
#                                     !is.na(Term)),
#                          .(Dur.Simple,
#                            StartFY,
#                            Term
#                          ),
#                          
#                          dplyr::summarise,
#                          Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
#                          Count=length(CSIScontractID)
# )
# 
# ggplot(TerminatedDur.SimpleStatCount,
#        aes(x=StartFY,y=Count,color=Term))+
#     geom_line()+
#     geom_point(aes(shape=Term))+
#     facet_grid( Dur.Simple  ~.) +
#     scale_x_continuous("Contract Starting Fiscal Year")+
#     scale_y_log10("Number of Contracts",label=comma)
#     geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1)+
#     # theme(legend.position="bottom") #, position=pd
# 
# ggplot(TerminatedDur.SimpleStatCount,
#        aes(x=StartFY,y=Count,color=Term))+
#     geom_line()+
#         geom_point(aes(shape=Term))+
#     facet_grid( Dur.Simple  ~., ) +#
#     scale_x_continuous("Contract Starting Fiscal Year")+
#         
#     scale_y_log10("Number of Contracts (Variable Scale)",label=comma)
#     # geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1)+
#     theme(legend.position="bottom") #, position=pd
#     

```

```{r SDurPercent, fig.width=3,fig.height=9, dpi=600}
# ddply(TerminatedDurStat,
#       .(qDuration),
#       dplyr::summarise,
#       Count=sum(Count),
#       Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21))
# 
# 
# 
# TerminatedDur.SimpleStat<-rbind(                         ddply(subset(def_all,
#                                 !is.na(qDuration) & StartFY>=2007 & 
#                                     StartFY<=2014 & 
#                                     !is.na(Ceil) &
#                                     UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")&
#                                     !is.na(Term)),
#                          .(Dur.Simple,
#                            StartFY
#                          ),
#                          
#                          dplyr::summarise,
#                          Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
#                          Count=length(CSIScontractID),
#                          mean = mean(TermNum),
#                          sd   = sd(TermNum),
#                          se   = sd / sqrt(Count),
#                          metric="Unweighted"
#                           # ceil.mean = wtd.mean(TermNum,UnmodifiedContractBaseAndAllOptionsValue),
#                          # ceil.cat.mean = wtd.mean(TermNum,ceil.median.wt)
# ))
# 
# 
# TerminatedDur.SimpleStat<-rbind(TerminatedDur.SimpleStat,
#                          ddply(subset(def_all,
#                                 !is.na(qDuration) & StartFY>=2007 & 
#                                     StartFY<=2014 & 
#                                     !is.na(Ceil) &
#                                     UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")&
#                                     !is.na(Term)),
#                          .(Dur.Simple,
#                            StartFY
#                          ),
#                          
#                          dplyr::summarise,
#                          Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
#                          Count=length(CSIScontractID),
#                          mean = wtd.mean(TermNum,ObligationWT),
#                          sd   = sqrt(wtd.var(TermNum,ObligationWT)) ,
#                          se   = sd / sqrt(Count),
#                          metric="Obligation Weighted"
#                           # ceil.mean = wtd.mean(TermNum,UnmodifiedContractBaseAndAllOptionsValue),
#                          # ceil.cat.mean = wtd.mean(TermNum,ceil.median.wt)
# ))
# 
# TerminatedDur.SimpleStat<-rbind(TerminatedDur.SimpleStat,
#                          ddply(subset(def_all,
#                                 !is.na(qDuration) & StartFY>=2007 & 
#                                     StartFY<=2014 & 
#                                     !is.na(Ceil) &
#                                     UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")&
#                                     !is.na(Term)),
#                          .(Dur.Simple,
#                            StartFY
#                          ),
#                          
#                          dplyr::summarise,
#                          Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
#                          Count=length(CSIScontractID),
#                          mean = wtd.mean(TermNum,UnmodifiedContractBaseAndAllOptionsValue),
#                          sd   = sqrt(wtd.var(TermNum,UnmodifiedContractBaseAndAllOptionsValue)) ,
#                          se   = sd / sqrt(Count),
#                          metric="Ceiling Weighted"
#                          # obl.mean = ,
#                          # ceil.mean = wtd.mean(TermNum,UnmodifiedContractBaseAndAllOptionsValue),
#                          # ceil.cat.mean = wtd.mean(TermNum,ceil.median.wt)
# 
# ))
# 
# 
# TerminatedDur.SimpleStat<-rbind(TerminatedDur.SimpleStat,
#                          ddply(subset(def_all,
#                                 !is.na(qDuration) & StartFY>=2007 & 
#                                     StartFY<=2014 & 
#                                     !is.na(Ceil) &
#                                     UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")&
#                                     !is.na(Term)),
#                          .(Dur.Simple,
#                            StartFY
#                          ),
#                          
#                          dplyr::summarise,
#                          Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
#                          Count=length(CSIScontractID),
#                          mean = wtd.mean(TermNum,ceil.median.wt),
#                          sd   = sqrt(wtd.var(TermNum,ceil.median.wt)) ,
#                          se   = sd / sqrt(Count),
#                          metric="Ceiling Category Weighted"
# 
# ))
# 
# 
# # 
# # pd <- position_dodge(0.1) # move them .05 to the left and right
# # 
# # ggplot(tgc, aes(x=dose, y=len, colour=supp)) + 
# #     geom_errorbar(aes(ymin=len-se, ymax=len+se), width=.1, position=pd) 
# 
# ggplot(subset(TerminatedDur.SimpleStat,!metric %in% c("Ceiling Weighted","Ceiling Category Weighted")),
#        aes(x=StartFY,y=mean,color=metric))+
#     geom_line()+
#     geom_point(aes(shape=metric))+
#     facet_grid( Dur.Simple  ~.) +
#     scale_x_continuous("Contract Starting Fiscal Year")+
#     scale_y_continuous(label=percent)+
#     geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1)+
#     theme(legend.position="bottom") #, position=pd
# 
# ggplot(subset(TerminatedDur.SimpleStat,!metric %in% c("Ceiling Weighted","Ceiling Category Weighted")),
#        aes(x=StartFY,y=mean,color=metric))+
#     geom_line()+
#         geom_point(aes(shape=metric))+
#     facet_grid( Dur.Simple  ~., space = "free_y", scales="free_y") +
#     scale_x_continuous("Contract Starting Fiscal Year")+
#     scale_y_continuous("Percent Terminated",label=percent)+
#     geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1)+
#     theme(legend.position="bottom")+ #, position=pd
    

```



```{r SDurCeilingCount, fig.width=3,fig.height=9, dpi=600}
# TerminatedSDurSCeilStatCount<-ddply(subset(def_all,
#                                 !is.na(qDuration) & StartFY>=2007 & 
#                                     StartFY<=2014 & 
#                                     !is.na(Ceil) &
#                                     UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")&
#                                     !is.na(Term)),
#                          .(Dur.Simple,
#                            Ceil,
#                            StartFY,
#                            Term
#                          ),
#                          
#                          dplyr::summarise,
#                          Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
#                          Count=length(CSIScontractID)
# )
# 
# 
# 
# ggplot(TerminatedSDurSCeilStatCount,
#        aes(x=StartFY,y=Count,color=Term))+
#     geom_line()+
#     geom_point(aes(shape=Term))+
#     facet_grid( Dur.Simple  ~ Ceil) +
#     scale_x_continuous("Contract Starting Fiscal Year")+
#     scale_y_log10("Number of Contracts",label=comma)
#     # theme(legend.position="bottom") #, position=pd
# 
# ggplot(TerminatedSDurSCeilStatCount,
#        aes(x=StartFY,y=Count,color=Term))+
#     geom_line()+
#         geom_point(aes(shape=Term))+
#     facet_grid( Dur.Simple  ~ Ceil ) +#
#     scale_x_continuous("Contract Starting Fiscal Year")+
#         
#     scale_y_log10("Number of Contracts (Variable Scale)",label=comma)
#     # geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1)+
#     theme(legend.position="bottom") #, position=pd
#     

```

# Terminations


Contract terminations and the number of change orders can be calculated for the entire sample.  Contract termination is determined using the *Reason for Modification* field in FPDS.  A contract is considered to be terminated if it has at least one modification with the following values:

* "Terminate for Default (complete or partial)"
* "Terminate for Convenience (complete or partial)"
* "Terminate for Cause"
* "Legal Contract Cancellation"

These four catetegories and the "Close Out" category are used to mark a contract as closed.  Many contracts in FPDS and in the sample are never marked closed.  




## Termination Timeline


```{r TermSDurSCeilCount, fig.width=9,fig.height=9, dpi=600}
# def_all<-as.data.frame(def_all)
# 
summary(def_all$qDuration)
summary(def_all$Dur.Simple)



summary((def_all %>% dplyr::filter(is.na(Dur.Simple)))$UnmodifiedDays)
# def_all$Dur.Simple<-def_all$qDuration
# 
# 
#     def_all$Dur.Simple<-as.character(def_all$qDuration)
#     def_all$Dur.Simple[def_all$Dur.Simple %in% c(
#       "[0 months,~2 months)",
#       "[~2 months,~7 months)",
#       "[~7 months-~1 year]")]<-"<~1 year"
#     def_all$qDuration.Simple<-factor(def_all$Dur.Simple,
#                                       levels=c("<~1 year",
#                                                "(~1 year,~2 years]",
#                                                "(~2 years+]"),
#                                       ordered=TRUE
#     )
# 
# def_all$Dur.Simple<-factor(factor(def_all$Dur.Simple))
# summary(TerminatedSDurSCeilStatCount$Ceil.Simple)
# summary(def_all$Ceil.Simple)
# summary(def_all$Ceil)
# 
# View(TerminatedSDurSCeilStatCount)
# write.csv(TerminatedSDurSCeilStatCount,"TerminatedSDurSCeilStatCount.csv")

# summary(def_all$qHighCeiling)
# if (all(levels(def_all$qHighCeiling)==c("[0.00e+00,1.50e+04)",
#                                              "[1.50e+04,1.00e+05)",
#                                              "[1.00e+05,1.00e+06)",
#                                              "[1.00e+06,1.00e+07)",
#                                              "[1.00e+07,7.50e+07)",
#                                              "[7.50e+07,3.36e+12]"))){
#       def_all$qHighCeiling<-factor(def_all$qHighCeiling,
# 
#                                     levels=c("[0.00e+00,1.50e+04)",
#                                              "[1.50e+04,1.00e+05)",
#                                              "[1.00e+05,1.00e+06)",
#                                              "[1.00e+06,1.00e+07)",
#                                              "[1.00e+07,7.50e+07)",
#                                              "[7.50e+07,3.36e+12]"),
#                                     labels=c("[0,15k)",
#                                              "[15k,100k)",
#                                              "[100k,1m)",
#                                              "[1m,10m)",
#                                              "[10m,75m)",
#                                              "[75m+]"),
#                                     ordered=TRUE
#       )
#     }
# 
# 
# 
#  if (identical(levels(def_all$qHighCeiling),c("[0,15k)",
#                                                   "[15k,100k)",
#                                                   "[100k,1m)",
#                                                   "[1m,10m)",
#                                                   "[10m,75m)",
#                                                   "[75m+]"
#     ))){
#       def_all$Ceil.Simple<-def_all$qHighCeiling
#       levels(def_all$Ceil.Simple)<- list("0k - <100k"=c("[15k,100k)",
#                                                          "[0,15k)"),
#                                           "100k - <10m"=c("[1m,10m)",
#                                                           "[100k,1m)"),
#                                           "10m+"=c("[75m+]",
#                                                    "[10m,75m)"))
# 
#       def_all$Ceil.Big<-def_all$Ceil
#       levels(def_all$Ceil.Big)<- list("0k - <100k"=c("[15k,100k)",
#                                                       "[0,15k)"),
#                                        "100k - <10m"=c("[1m,10m)",
#                                                        "[100k,1m)"),
#                                        "10m - <75m"=c("[10m,75m)"),
#                                        "75m+"=c("[75m+]"))
# }
# summary(def_all$Ceil.Simple)

TerminatedSDurSCeilStatCount<-
  only_complete(def_all) %>%
  group_by(Dur.Simple,
      Ceil.Simple,
      StartFY,
      Term
    ) %>%
    dplyr::summarise(
    Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
    Count=length(CSIScontractID),
    metric="Contracts within Period"
)



TerminatedSDurSCeilStatCount<-rbind(TerminatedSDurSCeilStatCount,
                                    all_labeled(def_all) %>%                
                                    group_by(Dur.Simple,
                                      Ceil.Simple,
                                      StartFY,
                                      Term
                                    ) %>%
                                    dplyr::summarise(
                                    Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
                                    Count=length(CSIScontractID),
                                    metric="Early Results for All Contracts"
))

TerminatedSDurSCeilStatCount$metric<-factor(TerminatedSDurSCeilStatCount$metric,
                                            levels=c("Contracts within Period",
                                                   "Early Results for All Contracts"),
                                            ordered=TRUE)

TerminatedSDurSCeilStatCount$Term<-factor(TerminatedSDurSCeilStatCount$Term,
                                          levels=c("Unterminated",
                                                   "Terminated"),
                                          labels=c("Unterminated",
                                                   "Complete or Partial Termination"),
                                            ordered=TRUE)


TerminatedSDurSCeilLabels<-
    subset(TerminatedSDurSCeilStatCount,metric=="Contracts within Period") %>%
    group_by(Dur.Simple,Ceil.Simple) %>%
    dplyr::summarise(
    FacetCount=paste("Count:",prettyNum(sum(Count),big.mark=",")),
    FacetValue=paste(FacetCount,"\nObligated: $",round(sum(Action_Obligation_OMB23_GDP21)/1000000000,1),"B",sep="")
    )

Ypos<-max(TerminatedSDurSCeilStatCount$Count)

(
Term_Plot<-ggplot(TerminatedSDurSCeilStatCount,
       aes(x=StartFY,y=Count,color=Term))+
    geom_line(aes(linetype=metric))+
    geom_point(aes(shape=Term))+
    geom_text(data=TerminatedSDurSCeilLabels,
              aes(x=2007,y=Ypos,label=FacetValue),
              # parse=TRUE,
              hjust=0,
              vjust=1,
              color="black")+
    facet_grid( Dur.Simple  ~ Ceil.Simple ) +#
    scale_x_continuous("Contract Starting Fiscal Year")+
    scale_color_manual("Status", values=c("blue","red"))+
    scale_linetype_discrete("Early Results")+
    scale_shape_discrete("Status")+
    scale_y_log10("Number of Contracts (Logorithmic Scale)",label=scales::comma)+
    # geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1)+
    theme(legend.position="bottom")+ #, position=pd
    labs(caption=paste("Source: FPDS and CSIS Analysis",missing_caption(def_all)))
)
ggsave(Term_Plot,file="Term_Plot.png",width=9,height=9, dpi=600)
  # View(def_all %>% filter(is.na(Ceil.Simple)))

write.csv(Term_Plot$data,# %>%
            # spread(key=Fiscal.Year, value=amount_OMB19_19),
          file="../output/Term_Plot.csv",row.names = FALSE)

summary(def_all$StartFY        )

ggplot(def_all,aes(x=na_non_positive_log(UnmodifiedDays)))+geom_histogram()
ggplot(subset(def_all,UnmodifiedDays<1),aes(x=UnmodifiedDays))+geom_histogram()




```



```{r FewerDurIntlPercent, fig.width=3,fig.height=9, dpi=600}
# summary(def_all$qDuration)
# 
# TerminatedDur.SimpleIntlStat<-rbind(                         ddply(subset(def_all,
#                                 !is.na(qDuration) & StartFY>=2007 & 
#                                     StartFY<=2014 & (LastCurrentCompletionDate<=strptime("2015-09-30","%Y-%m-%d") | IsClosed==1) &
#                                     !is.na(Ceil) &
#                                     !is.na(Intl) &
#                                     UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")&
#                                     !is.na(Term)),
#                          .(Dur.Simple,
#                            StartFY,
#                            Intl
#                          ),
#                          
#                          dplyr::summarise,
#                          Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
#                          Count=length(CSIScontractID),
#                          mean = mean(TermNum),
#                          sd   = sd(TermNum),
#                          se   = sd / sqrt(Count),
#                          metric="Unweighted"
#                           # ceil.mean = wtd.mean(TermNum,UnmodifiedContractBaseAndAllOptionsValue),
#                          # ceil.cat.mean = wtd.mean(TermNum,ceil.median.wt)
# ))
# 
# 
# 
# TerminatedDur.SimpleIntlStat<-rbind(TerminatedDur.SimpleIntlStat,
#                          ddply(subset(def_all,
#                                 !is.na(qDuration) & StartFY>=2007 & 
#                                     StartFY<=2014 & (LastCurrentCompletionDate<=strptime("2015-09-30","%Y-%m-%d") | IsClosed==1) &
#                                     !is.na(Ceil) &
#                                     !is.na(Intl) &
#                                     UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")&
#                                     !is.na(Term)),
#                          .(Dur.Simple,
#                            StartFY,
#                            Intl
#                          ),
#                          
#                          dplyr::summarise,
#                          Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
#                          Count=length(CSIScontractID),
#                          mean = wtd.mean(TermNum,ObligationWT),
#                          sd   = sqrt(wtd.var(TermNum,ObligationWT)) ,
#                          se   = sd / sqrt(Count),
#                          metric="Obligation Weighted"
#                           # ceil.mean = wtd.mean(TermNum,UnmodifiedContractBaseAndAllOptionsValue),
#                          # ceil.cat.mean = wtd.mean(TermNum,ceil.median.wt)
# ))
# 
# TerminatedDur.SimpleIntlStat<-rbind(TerminatedDur.SimpleIntlStat,
#                          ddply(subset(def_all,
#                                 !is.na(qDuration) & StartFY>=2007 & 
#                                     StartFY<=2014 & (LastCurrentCompletionDate<=strptime("2015-09-30","%Y-%m-%d") | IsClosed==1) &
#                                     !is.na(Ceil) &
#                                     !is.na(Intl) &
#                                     UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")&
#                                     !is.na(Term)),
#                          .(Dur.Simple,
#                            StartFY,
#                            Intl
#                          ),
#                          
#                          dplyr::summarise,
#                          Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
#                          Count=length(CSIScontractID),
#                          mean = wtd.mean(TermNum,UnmodifiedContractBaseAndAllOptionsValue),
#                          sd   = sqrt(wtd.var(TermNum,UnmodifiedContractBaseAndAllOptionsValue)) ,
#                          se   = sd / sqrt(Count),
#                          metric="Ceiling Weighted"
#                          # obl.mean = ,
#                          # ceil.mean = wtd.mean(TermNum,UnmodifiedContractBaseAndAllOptionsValue),
#                          # ceil.cat.mean = wtd.mean(TermNum,ceil.median.wt)
# 
# ))
# 
# 
# TerminatedDur.SimpleIntlStat<-rbind(TerminatedDur.SimpleIntlStat,
#                          ddply(subset(def_all,
#                                 !is.na(qDuration) & StartFY>=2007 & 
#                                     StartFY<=2014 & (LastCurrentCompletionDate<=strptime("2015-09-30","%Y-%m-%d") | IsClosed==1) &
#                                     !is.na(Ceil) &
#                                     !is.na(Intl) &
#                                     UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")&
#                                     !is.na(Term)),
#                          .(Dur.Simple,
#                            StartFY,
#                            Intl
#                          ),
#                          
#                          dplyr::summarise,
#                          Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
#                          Count=length(CSIScontractID),
#                          mean = wtd.mean(TermNum,ceil.median.wt),
#                          sd   = sqrt(wtd.var(TermNum,ceil.median.wt)) ,
#                          se   = sd / sqrt(Count),
#                          metric="Ceiling Category Weighted"
# 
# ))
# 
# 
# # 
# # pd <- position_dodge(0.1) # move them .05 to the left and right
# # 
# # ggplot(tgc, aes(x=dose, y=len, colour=supp)) + 
# #     geom_errorbar(aes(ymin=len-se, ymax=len+se), width=.1, position=pd) 
# 
# ddply(TerminatedDur.SimpleIntlStat,
#       .(Dur.Simple,
#         Intl,
#         metric),
#       dplyr::summarise,
#       Count=sum(Count),
#       Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21))
# 
# TermLabels<-ddply(
#     subset(TerminatedDur.SimpleIntlStat,
#            !metric %in% c("Ceiling Weighted",
#                           "Ceiling Category Weighted")),
#     .(Dur.Simple,Intl,metric),
#     dplyr::summarise,
#     FacetCount=paste("Count:",prettyNum(sum(Count),big.mark=",")),
#     FacetValue=paste(FacetCount,"\nObligated: $",round(sum(Action_Obligation_OMB23_GDP21)/1000000000,1),"B",sep=""),
#     FacetY=max(mean+se))
# 
# TermLabels<-ddply(TermLabels,
#       .(Dur.Simple),
#       dplyr::mutate,
#       FacetY=max(FacetY))
# 
# ggplot(subset(TerminatedDur.SimpleIntlStat,!metric %in% c("Ceiling Weighted","Ceiling Category Weighted")),
#        aes(x=StartFY,y=mean,color=metric))+
#     geom_line()+
#         geom_point(aes(shape=metric))+
#     geom_text(data=TermLabels,
#               aes(x=2007,y=FacetY,label=FacetValue),
#               # parse=TRUE,
#               hjust=0,
#               vjust=1,
#               color="black")+
#     
#     facet_grid( Dur.Simple  ~ Intl, space = "free_y", scales="free_y") +
#     scale_x_continuous("Contract Starting Fiscal Year")+
#     scale_y_continuous("Percent Terminated",label=percent)+
#     geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1)+
#     theme(legend.position="bottom") #, position=pd
# 
# 
# 
# ggplot(subset(TerminatedDur.SimpleIntlStat,!metric %in% c("Ceiling Weighted","Ceiling Category Weighted")),
#        aes(x=StartFY,y=mean,color=metric))+
#     geom_line()+
#         geom_point(aes(shape=metric))+
#     geom_text(data=TermLabels,
#               aes(x=2007,y=FacetY,label=FacetValue),
#               # parse=TRUE,
#               hjust=0,
#               vjust=1,
#               color="black")+
#     facet_grid( Dur.Simple  ~ Intl, space = "free_y", scales="free_y") +
#     scale_x_continuous("Contract Starting Fiscal Year")+
#     scale_y_continuous("Percent Terminated",label=percent)+
#     geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1)+
#     theme(legend.position="bottom") #, position=pd
# 

```


```{r AnnualTerminationRateByCeiling, fig.width=3,fig.height=9, dpi=600}


# 
# TerminatedDurCeilStat<-ddply(subset(def_all,
#                                 !is.na(qDuration) & StartFY>=2007 & 
#                                     !is.na(Ceil) &
#                                     UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")&
#                                     !is.na(Term)),
#                          .(Ceil,
#                            qDuration,
#                            StartFY
#                          ),
#                          
#                          dplyr::summarise,
#                          Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
#                          Count=length(CSIScontractID),
#                          N    = length(TermNum),
#                          mean = mean(TermNum),
#                          sd   = sd(TermNum),
#                          se   = sd / sqrt(N),
#                          obl.mean = wtd.mean(TermNum,ObligationWT,na.rm=TRUE),
#                          ceil.mean = wtd.mean(TermNum,UnmodifiedContractBaseAndAllOptionsValue)
# )
# # 
# # pd <- position_dodge(0.1) # move them .05 to the left and right
# # 
# # ggplot(tgc, aes(x=dose, y=len, colour=supp)) + 
# #     geom_errorbar(aes(ymin=len-se, ymax=len+se), width=.1, position=pd) 
# 
# ggplot(TerminatedDurCeilStat,aes(x=StartFY))+
#     geom_line(aes(y=mean))+
#     # geom_line(aes(y=ceil.mean))+
#     geom_line(aes(y=obl.mean))+
#     geom_point(aes(y=mean))+
#     facet_grid(Ceil ~ qDuration ) +
#     scale_x_continuous("Contract Starting Fiscal Year")+
#     scale_y_continuous("Percent Terminated",label=percent)+
#     geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) #, position=pd
# 
# 
# ggplot(TerminatedDurCeilStat,
#        aes(x=StartFY,
#            y=obl.mean))+geom_line()+    geom_point()+facet_grid(Ceil ~ qDuration ) +
#     scale_x_continuous("Contract Starting Fiscal Year")+
#     scale_y_continuous("Percent Terminated",label=percent)
#          # geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) #, position=pd
# 
# 
# ggplot(TerminatedDurCeilStat,
#        aes(x=StartFY,
#            y=ceil.mean))+geom_line()+    geom_point()+facet_grid(Ceil ~ qDuration ) +
#     scale_x_continuous("Contract Starting Fiscal Year")+
#     scale_y_continuous("Percent Terminated",label=percent)
#          # geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) #, position=pd
# 
# 
# ```
# 
# 
# 
# 
# 
# ```{r FxCBcategories, fig.width=3,fig.height=9, dpi=600}
# 
# 
# 
# 
# TerminatedFxCb<-rbind(                         ddply(subset(def_all,
#                                 !is.na(FxCb) & StartFY>=2007 & 
#                                     StartFY<=2014 & (LastCurrentCompletionDate<=strptime("2015-09-30","%Y-%m-%d") | IsClosed==1) &
#                                     !is.na(Ceil) &
#                                     UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")&
#                                     !is.na(Term)),
#                          .(FxCb,
#                            StartFY
#                          ),
#                          
#                          dplyr::summarise,
#                          Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
#                          Count=length(CSIScontractID),
#                          mean = mean(TermNum),
#                          sd   = sd(TermNum),
#                          se   = sd / sqrt(Count),
#                          metric="Unweighted"
#                           # ceil.mean = wtd.mean(TermNum,UnmodifiedContractBaseAndAllOptionsValue),
#                          # ceil.cat.mean = wtd.mean(TermNum,ceil.median.wt)
# ))
# 
# 
# TerminatedFxCb<-rbind(TerminatedFxCb,
#                          ddply(subset(def_all,
#                                 !is.na(FxCb) & StartFY>=2007 & 
#                                     StartFY<=2014 & (LastCurrentCompletionDate<=strptime("2015-09-30","%Y-%m-%d") | IsClosed==1) &
#                                     !is.na(Ceil) &
#                                     UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")&
#                                     !is.na(Term)),
#                          .(FxCb,
#                            StartFY
#                          ),
#                          
#                          dplyr::summarise,
#                          Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
#                          Count=length(CSIScontractID),
#                          mean = wtd.mean(TermNum,ObligationWT),
#                          sd   = sqrt(wtd.var(TermNum,ObligationWT)) ,
#                          se   = sd / sqrt(Count),
#                          metric="Obligation Weighted"
#                           # ceil.mean = wtd.mean(TermNum,UnmodifiedContractBaseAndAllOptionsValue),
#                          # ceil.cat.mean = wtd.mean(TermNum,ceil.median.wt)
# ))
# 
# TerminatedFxCb<-rbind(TerminatedFxCb,
#                          ddply(subset(def_all,
#                                 !is.na(FxCb) & StartFY>=2007 & 
#                                     StartFY<=2014 & (LastCurrentCompletionDate<=strptime("2015-09-30","%Y-%m-%d") | IsClosed==1) &
#                                     !is.na(Ceil) &
#                                     UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")&
#                                     !is.na(Term)),
#                          .(FxCb,
#                            StartFY
#                          ),
#                          
#                          dplyr::summarise,
#                          Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
#                          Count=length(CSIScontractID),
#                          mean = wtd.mean(TermNum,UnmodifiedContractBaseAndAllOptionsValue),
#                          sd   = sqrt(wtd.var(TermNum,UnmodifiedContractBaseAndAllOptionsValue)) ,
#                          se   = sd / sqrt(Count),
#                          metric="Ceiling Weighted"
#                          # obl.mean = ,
#                          # ceil.mean = wtd.mean(TermNum,UnmodifiedContractBaseAndAllOptionsValue),
#                          # ceil.cat.mean = wtd.mean(TermNum,ceil.median.wt)
# 
# ))
# 
# 
# TerminatedFxCb<-rbind(TerminatedFxCb,
#                          ddply(subset(def_all,
#                                 !is.na(FxCb) & StartFY>=2007 & 
#                                     StartFY<=2014 & (LastCurrentCompletionDate<=strptime("2015-09-30","%Y-%m-%d") | IsClosed==1) &
#                                     !is.na(Ceil) &
#                                     UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")&
#                                     !is.na(Term)),
#                          .(FxCb,
#                            StartFY
#                          ),
#                          
#                          dplyr::summarise,
#                          Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
#                          Count=length(CSIScontractID),
#                          mean = wtd.mean(TermNum,ceil.median.wt),
#                          sd   = sqrt(wtd.var(TermNum,ceil.median.wt)) ,
#                          se   = sd / sqrt(Count),
#                          metric="Ceiling Category Weighted"
# 
# ))
# 
# 
# # 
# # pd <- position_dodge(0.1) # move them .05 to the left and right
# # 
# # ggplot(tgc, aes(x=dose, y=len, colour=supp)) + 
# #     geom_errorbar(aes(ymin=len-se, ymax=len+se), width=.1, position=pd) 
# 
# ggplot(subset(TerminatedFxCb,!metric %in% c("Ceiling Weighted","Ceiling Category Weighted")),
#        aes(x=StartFY,y=mean,color=metric))+
#     geom_line()+
#     geom_point(aes(shape=metric))+
#     facet_grid( FxCb  ~.) +
#     scale_x_continuous("Contract Starting Fiscal Year")+
#     scale_y_continuous(label=percent)+
#     geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1)+
#     theme(legend.position="bottom") #, position=pd
# 
# ggplot(TerminatedFxCb,#subset(TerminatedFxCb,!metric %in% c("Ceiling Weighted","Ceiling Category Weighted")),
#        aes(x=StartFY,y=mean,color=metric))+
#     geom_line()+
#         geom_point(aes(shape=metric))+
#     facet_grid( FxCb  ~., space = "free_y", scales="free_y") +
#     scale_x_continuous("Contract Starting Fiscal Year")+
#     scale_y_continuous("Percent Terminated",label=percent)+
#     geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1)+
#     theme(legend.position="bottom") #, position=pd
    

```
Contracts are classified using a mix of numerical and categorical variables. While the changes in numerical variables are easy to grasp and summarize, a contract may have one line item that is competed and another that is not. As is detailed in the exploration on R&D, we are only considering information available prior to contract start. The percentage of contract obligations that were competed is a valuable benchmark, but is highly influenced by factors that occured after contract start..

# Ceiling Breaches

In the same manner as contract terminations, change orders are reported in the *reason for modification* field.  There are two values that this study counts as change orders: "Change Order" and "Definitize Change Order."  For the remainder of this report, contracts with at least one change order are called **Changed Contracts**.  

There are also multiple modifications captured in FPDS that this current study will not investigate as change orders.  These include:

* Additional World (new agreement, FAR part 6 applies)
* Supplemental Agreement for work within scope
* Exercise an Option
* Definitize Letter Contract

In addition, there are a number of other modifications that may be undertaken based on changes on the government or vendor side that are not included in this analysis. 



**A histogram of the data** showing the distribution of the number of change orders each year from 2007.

```{r DataFrameChangeOrders, echo = TRUE, fig.width=4.5,fig.height=6}
  
  NChgCeil<-ddply(def_all,
               .(SumOfisChangeOrder,
                 StartFY,
                 Ceil),
               plyr::summarise,
               ContractCount=length(CSIScontractID),
               Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21))

NChgCeil<-ddply(NChgCeil, 
                .(Ceil), 
                transform, 
                pContractByCeil=ContractCount/sum(ContractCount),
                pObligationByCeil=Action_Obligation_OMB23_GDP21/sum(Action_Obligation_OMB23_GDP21))

NChgCeil$pTotalObligation<-NChgCeil$Action_Obligation_OMB23_GDP21/sum(NChgCeil$Action_Obligation_OMB23_GDP21,na.rm=TRUE)
NChgCeil$pTotalContract<-NChgCeil$ContractCount/sum(NChgCeil$ContractCount,na.rm=TRUE)

```

```{r ChangeOrderGraphs}
# 
# ggplot(
#   data = subset(NChgCeil,SumOfisChangeOrder>0),
#   aes_string(x = "SumOfisChangeOrder")
#   ) + geom_bar(binwidth=1) + 
#     facet_grid( Ceil ~ .,
#                 scales = "free_y",
#                 space = "free_y") + scale_y_continuous(expand = c(0,50)) +scale_x_continuous(limits=c(0,10))
# 
# 
# 
# ggplot(
#   data = subset(NChgCeil,SumOfisChangeOrder>0),
#   aes_string(x = "Ceil",weight="ContractCount"),
#   main="Number of Contracts with Change Orders\nBy Initial Contract Ceiling")+ 
#   geom_bar()+
#     scale_x_discrete("Initial Cost Ceiling (Current $ Value)")+scale_y_continuous("Number of Contracts with Change Orders")+theme(axis.text.x=element_text(angle=90))
# 
# 
# ggplot(
#   data = subset(NChgCeil,SumOfisChangeOrder>0),
#   aes_string(x = "Ceil",weight="pContractByCeil"),
#   main="Percentage of Contracts going to Contracts with Change Orders\nBy Initial Contract Ceiling")+ geom_bar()+ scale_y_continuous("Percent of Contracts with Change Orders", labels=percent)+
#     scale_x_discrete("Initial Cost Ceiling (Current $ Value)")+theme(axis.text.x=element_text(angle=90))
# 
# 
# ggplot(
#   data =subset(NChgCeil,SumOfisChangeOrder>0),
#   aes_string(x = "Ceil",weight="pObligationByCeil"),
#   main="Percentage of Contract Obligations going to Contracts with Change Orders\nBy Initial Contract Ceiling"
#   )+ geom_bar()+ scale_y_continuous("Percent of Obligations in Cost Ceiling Category", labels=percent)+
#     scale_x_discrete("Initial Cost Ceiling (Current $ Value)")+theme(axis.text.x=element_text(angle=90))
# 
# 
# ggplot(
#   data = subset(NChgCeil,SumOfisChangeOrder>0),
#   aes_string(x = "Ceil",weight="Action_Obligation_OMB23_GDP21")
#   )+ geom_bar()+
#     scale_x_discrete("Initial Cost Ceiling (Current $ Value)")+scale_y_continuous("Total Obligated Value of Contracts with Change Orders")+theme(axis.text.x=element_text(angle=90))
# 
# 
# 
# sum(subset(NChgCeil,SumOfisChangeOrder>0)$pTotalObligation)
# sum(subset(NChgCeil,SumOfisChangeOrder>0)$pTotalContract)

```


This study uses changes in the *Base and All Options Value Amount* as a way of tracking the potential cost of change orders.

* The *Base and All Options Value Amount* refers to the ceiling of contract costs if all available options were exercised. 
* The *Base and Exercised Value Amount* is not used because contracts are often specified such that the bulk of the eventually executed contract in dollar terms are treated as options.  In these cases, the all-inclusive value provides a better baseline for tracking growth.  
* The *Action Obligation* refers to the actual amount transferred to vendors.  This study team does not use this value because spending for change orders are not necessarily front-loaded.  For example, a change to a contract in May of 2010 could easily result in payments from May 2010 through August 2013.

The % Growth in Base and All Options Value Amount form Change Orders is calculated as follows: 

*Base and All Options Value Amount* increases for all Change Order Modifications/
*Base and All Options Value Amount* from the original unmodified contract transaction


**A histogram of the data** showing the distribution of the initial amount of the specific change order 


```{r DataFrameCeilingBreachSumamry}
# 
# pChgCeil<-ddply(def_all,
#              .(pChange3Sig,
#                StartFY,
#                Ceil),
#              plyr::summarise,
#              ContractCount=length(CSIScontractID),
#              Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21))
# 
# pChgCeil<-ddply(pChgCeil, 
#                 .(Ceil), 
#                 transform, 
#                 pContractByCeil=ContractCount/sum(ContractCount),
#                 pObligationByCeil=Action_Obligation_OMB23_GDP21/sum(Action_Obligation_OMB23_GDP21))
# 
# pChgCeil<-ddply(pChgCeil, 
#                 .(StartFY), 
#                 transform, 
#                 pContractByFYear=ContractCount/sum(ContractCount),
#                 pObligationByFYear=Action_Obligation_OMB23_GDP21/sum(Action_Obligation_OMB23_GDP21))
# 
# pChgCeil$pChange3Sig[pChgCeil$pChange3Sig==-Inf]<-NA
# pChgCeil$pChange3Sig[pChgCeil$pChange3Sig==Inf]<-NA
# 
# pChgCeilAverage<-ddply(pChgCeil,
#                 .(Ceil),
#                 plyr::summarise,
#                 mean = wtd.mean(pChange3Sig,ContractCount),
#                 sd   = sqrt(wtd.var(pChange3Sig,ContractCount))
#                 # se   = sd / sqrt(ContractCount)
#                 )
# 
# 
# 
# 
# pChgCeil$pTotalObligation<-pChgCeil$Action_Obligation_OMB23_GDP21/sum(NChgCeil$Action_Obligation_OMB23_GDP21,na.rm=TRUE)
# pChgCeil$pTotalContract<-pChgCeil$ContractCount/sum(NChgCeil$ContractCount,na.rm=TRUE)
# 
# pChgCeil$p_CBre <- cut2(
#     pChgCeil$pChange3Sig,c(
#                                               -0.001,
#                                               0.001,
#                                               0.15)
#     )
# 
# 

```

```{r CeilingBreachGraphs}
# 
# ggplot(
#   data = pChgCeil,
#   aes_string(x = "pChange3Sig",
#              weights = "ContractCount")
#   ) + geom_histogram(binwidth=0.01) +
#     facet_grid( Ceil ~ .,
#                 scales = "free_y",
#                 space = "free_y") +
#     scale_y_log10("Number of Contracts")+
#     scale_x_continuous("Percentage of Cost-Ceiling-Raising Change Orders b
#                        y\nInitial Cost Ceiling (Current $ Value)",
#                        limits=c(-1.25,1.25), labels=percent)+
#     theme(axis.text.x=element_text(angle=90,size=1))+
#   geom_vline(data=pChgCeilAverage,aes(xintercept=mean),color="red")
# 
# 
# 
# 
# # ggplot(
# #   data = subset(pChgCeil,is.numeric(pChange3Sig)&is.finite(pChange3Sig)),
# #   aes_string(y = "pChange3Sig")
# #   ) + geom_boxplot() 
# 
# ggplot(
#   data = subset(pChgCeil,is.finite(pChange3Sig)&
#                   !is.na(pChange3Sig)&StartFY>2007&StartFY<=2014&pChange3Sig!=0),
#   aes(y = pChange3Sig,x=factor(StartFY),
#              weight = ContractCount)
#   ) + geom_violin() + 
#     facet_grid( Ceil ~ .) +
#     # scale_y_log10("Number of Contracts",limits=c(-1.25,1.25))+
#      scale_y_continuous(
#        "Cost-Ceiling-Raising Change Orders Percent (Current $ Value)",
#                        limits=c(-0.05,0.05), labels=percent)
#     # theme(axis.text.x=element_text(angle=90,size=1))
# 
# 
# 
# ggplot(
#   data = subset(pChgCeil,is.finite(pChange3Sig)&
#                   !is.na(pChange3Sig)&StartFY>2007&StartFY<=2014),
#   aes(y = pChange3Sig,x=factor(StartFY),
#              weight = ContractCount)
#   ) + geom_boxplot(outlier.shape = NA,notch=TRUE) + 
#     facet_grid( Ceil ~ .) +
#     # scale_y_log10("Number of Contracts",limits=c(-1.25,1.25))+
#      scale_y_continuous(
#        "Cost-Ceiling-Raising Change Orders Percent (Current $ Value)",
#                        limits=c(-0.05,0.05), labels=percent)
#     # theme(axis.text.x=element_text(angle=90,size=1))
# 
# 
# # Percent of Contracts breakdown by StartYear
# ggplot(
#   data = subset(pChgCeil,
#                 StartFY>=2007 & 
#                   StartFY<=2015 &
#                   pChange3Sig!=0),
#   aes_string(x = "pChange3Sig",
#              weight="pContractByFYear")
#   ) + geom_histogram(binwidth=0.01) +
#   scale_x_continuous("Percentage of Cost-Ceiling-Raising Change Orders b
#                        y\nInitial Cost Ceiling (Current $ Value)",
#                        limits=c(-1.25,1.25), labels=percent)+
#   scale_y_continuous()+
#   facet_wrap("StartFY")
# 
# 
# # Percent of Contracts breakdown by Ceiling
# ggplot(
#   data = subset(pChgCeil,pChange3Sig!=0),
#   aes_string(x = "pChange3Sig",weight="pContractByCeil",fill="p_CBre")#
#   )+ geom_histogram(binwidth=0.05)+
# #     scale_x_continuous("Percentage of Cost-Ceiling-Raising Change Orders by\nInitial Cost Ceiling (Current $ Value)")
#     scale_y_continuous("Percent of Contracts", labels=percent)+
#         facet_grid( . ~ Ceil )+scale_x_continuous("Extent of Ceiling Breach in 5% Increments",limits=c(-0.5,1), labels=percent)+theme(axis.text.x=element_text(angle=90),legend.position="bottom")+scale_fill_discrete(name="Extent of Ceiling Breach")
# 
# 
# 
# tapply(pChgCeil$pChange3Sig, pChgCeil$Ceil, summary)
# 
# 
# 
# 
# #Percent of obligations breakdown
# ggplot(
#   data = subset(pChgCeil,pChange3Sig!=0),
#   aes_string(x = "pChange3Sig",weight="pTotalObligation",fill="p_CBre")#
#   )+ geom_bar(binwidth=0.01)+
# #     scale_x_continuous("Percentage of Obligations  by\nInitial Cost Ceiling (Current $ Value)")
#     scale_y_continuous("Percent of Completed Contracts\n(Weighted by Current $ Obligations)", labels=percent)+
#        # facet_grid( . ~ Term )+
#     scale_x_continuous("Extent of Ceiling Breach \n(Percent Change in Current $ Value in 1% Increments)",labels=percent,limits=c(-0.5,1))+
#     coord_cartesian(xlim=c(-0.5,1))+ theme(axis.text.x=element_text(angle=90),legend.position="bottom")+
#     scale_fill_discrete(name="Extent of Ceiling Breach")
# 
# 
# tapply(pChgCeil$p_CBre, pChgCeil$Ceil, summary)
# 
# 
# sum(subset(pChgCeil,pChange3Sig>0)$pTotalObligation)
# 


```



```{r SpecialResearch}

# BreachSummary<-ddply(def_all,
#                      .(Ceil,
#                        pChange3Sig,
#                        SumOfisChangeOrder,
#                        p_CBre,
#                        Term),
#                      summarise,
#                      pContractByCeil=sum(pContractByCeil),
#                      pObligationByCeil=sum(pObligationByCeil),
#                      pTotalObligation=sum(pTotalObligation))
# 
# 
# 
# ddply(pChgCeil,.(Term,p_CBre),
#                      summarise,
#                      pTotalObligation=sum(pTotalObligation))


```

## Any Ceiling Breach

```{r CBreSDurSCeilCount, fig.width=9,fig.height=9, dpi=600}


BreachedSDurSCeilStatCount<-
  only_complete(def_all) %>%
  group_by(Dur.Simple,
      Ceil.Big,
      StartFY,
      CBre
    ) %>%
    dplyr::summarise(
    Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
    Count=length(CSIScontractID),
    metric="Contracts within Period"
)

BreachedSDurSCeilStatCount<-rbind(BreachedSDurSCeilStatCount,
                                    all_labeled(def_all) %>%                
                                    group_by(Dur.Simple,
                                      Ceil.Big,
                                      StartFY,
                                      CBre
                                    ) %>%
                                    dplyr::summarise(
                                    Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
                                    Count=length(CSIScontractID),
                                    metric="Early Results for All Contracts"
))

BreachedSDurSCeilStatCount$metric<-factor(BreachedSDurSCeilStatCount$metric,
                                            levels=c("Contracts within Period",
                                                   "Early Results for All Contracts"),
                                            ordered=TRUE)

BreachedSDurSCeilLabels<-
    subset(BreachedSDurSCeilStatCount,metric=="Contracts within Period") %>%
    group_by(Dur.Simple,Ceil.Big) %>%
    dplyr::summarise(
    FacetCount=paste("Count:",prettyNum(sum(Count),big.mark=",")),
    FacetValue=paste(FacetCount,"\nObligated: $",round(sum(Action_Obligation_OMB23_GDP21)/1000000000,1),"B",sep="")
    )

Ypos<-max(BreachedSDurSCeilStatCount$Count)


ggplot(BreachedSDurSCeilStatCount,
       aes(x=StartFY,y=Count,color=CBre))+
    geom_line(aes(linetype=metric))+
    geom_point(aes(shape=CBre))+
    geom_text(data=BreachedSDurSCeilLabels,
              aes(x=2007,y=Ypos,label=FacetValue),
              # parse=TRUE,
              hjust=0,
              vjust=1,
              color="black")+
    facet_grid( Dur.Simple  ~ Ceil.Big ) +#
    scale_x_continuous("Contract Starting Fiscal Year")+
    scale_color_manual("Status", values=c("blue","red"))+
    scale_linetype_discrete("Early Results")+
    scale_shape_discrete("Status")+
    scale_y_log10("Number of Contracts (Logorithmic Scale)",label=scales::comma)+
    # geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1)+
    theme(legend.position="bottom") #, position=pd
summary(def_all$StartFY
        )

ggplot(def_all,aes(x=log(UnmodifiedDays)))+geom_histogram()
ggplot(subset(def_all,UnmodifiedDays<1),aes(x=UnmodifiedDays))+geom_histogram()
View(subset(def_all,Ceil.Big=="0k - <100k" & Dur.Simple=="(~2 years+]"))
```

## Ceiling Breach Quantile
```{r Quantile , fig.width=9,fig.height=9, dpi=600}
df.QCrai<-only_complete(def_all)%>%
      group_by(StartFY,
               Ceil,
               qDuration)%>%
      dplyr::summarise(
      X50 = quantile(p_CBre, probs = 0.5,na.rm=TRUE),
      X75 = quantile(p_CBre, probs = 0.75,na.rm=TRUE), 
      X80 = quantile(p_CBre, probs = 0.80,na.rm=TRUE), 
      X90 = quantile(p_CBre, probs = 0.90,na.rm=TRUE), 
      X95 = quantile(p_CBre, probs = 0.95,na.rm=TRUE),
      X99 = quantile(p_CBre, probs = 0.99,na.rm=TRUE),
      ContractCount=length(CSIScontractID),
             Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
      metric="Contracts within Period")


df.QCrai<-melt(df.QCrai,variable.name="Quantile",value.name="pCRai",measure.vars=c(
  "X50",
  "X75",
  "X90",
  "X95",
  "X99")
)

ggplot(df.QCrai,
       aes(x=StartFY,y=pCRai,color=Quantile))+
  geom_line()+
  scale_y_continuous(labels=percent)+
  facet_grid(Ceil~qDuration)+labs(title="All Six Quantiles")

ggplot(subset(df.QCrai,
                !Quantile %in% c("X99")),
       aes(x=StartFY,y=pCRai,color=Quantile))+
  geom_line()+
  facet_grid(Ceil~qDuration#,
             # scales="free_y",
             # space="free_y"
             )+
  scale_y_continuous(labels=percent)+
  labs(title="Five Quantiles (no 99%)")


#Test to see which percentiles register at all.
df.ecdf<-def_all %>%
      group_by(Ceil,
               qDuration)%>%
      dplyr::summarise(
      r001 = ecdf(p_CBre)(0.001),
      r01 = ecdf(p_CBre)(0.01),
      r05 = ecdf(p_CBre)(0.01)
)

# df.ecdf<-subset(df.ecdf,StartFY>=2007&StartFY<=2014)

# test<-tapply(def_all, p_CBre, ecdf)
```
## Simple.Dur / Ceiling.Big

```{r QuantileSimpleDur, fig.width=9,fig.height=9, dpi=600}
df.QCrai.SDur<-only_complete(def_all) %>%
      group_by(StartFY,
               Ceil.Big,
               Dur.Simple) %>%
      dplyr::summarise(
      X50 = quantile(p_CBre, probs = 0.5,na.rm=TRUE),
      X75 = quantile(p_CBre, probs = 0.75,na.rm=TRUE), 
      X80 = quantile(p_CBre, probs = 0.80,na.rm=TRUE), 
      X90 = quantile(p_CBre, probs = 0.90,na.rm=TRUE), 
      X95 = quantile(p_CBre, probs = 0.95,na.rm=TRUE),
      X99 = quantile(p_CBre, probs = 0.99,na.rm=TRUE),
      ContractCount=length(CSIScontractID),
             Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
      metric="Contracts within Period")



df.QCrai.SDur<-rbind(df.QCrai.SDur,
                all_labeled(def_all)%>%
      group_by(StartFY,
               Ceil.Big,
               Dur.Simple)%>%
      dplyr::summarise( 
      X50 = quantile(p_CBre, probs = 0.5,na.rm=TRUE),
      X75 = quantile(p_CBre, probs = 0.75,na.rm=TRUE), 
      X80 = quantile(p_CBre, probs = 0.80,na.rm=TRUE), 
      X90 = quantile(p_CBre, probs = 0.90,na.rm=TRUE), 
      X95 = quantile(p_CBre, probs = 0.95,na.rm=TRUE),
      X99 = quantile(p_CBre, probs = 0.99,na.rm=TRUE),
      ContractCount=length(CSIScontractID),
             Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
      metric="Early Results for All Contracts")
)


df.QCrai.SDur<-melt(df.QCrai.SDur,
                      variable.name="Quantile",value.name="pCRai",measure.vars=c(
  "X50",
  "X75",
  "X80",
  "X90",
  "X95",
  "X99")
)

df.QCrai.SDur$Quantile<-factor(df.QCrai.SDur$Quantile,
  levels=c("X50",
  "X75",
  "X80",
  "X90",
  "X95",
  "X99"),
  labels=c("50th Percentile",
  "75th Percentile",
  "80th Percentile",
  "90th Percentile",
  "95th Percentile",
  "99th Percentile")
)

CRaiSDurCeilLabels<-ddply(
  subset(df.QCrai.SDur,Quantile=="50th Percentile" &
           metric=="Contracts within Period"),
    .(Dur.Simple,Ceil.Big),
    plyr::summarise,
    FacetCount=paste("Count:",prettyNum(sum(ContractCount),big.mark=",")),
    FacetValue=paste(FacetCount,"\nObligated: $",round(sum(Action_Obligation_OMB23_GDP21)/1000000000,1),"B",sep="")
    )

Ypos<-max(subset(df.QCrai.SDur,
                   !Quantile %in% c("99th Percentile")
                 )$pCRai,na.rm=TRUE)


CRaiOutput<-ggplot(subset(df.QCrai.SDur,
                !Quantile %in% c("99th Percentile",
                                 "75th Percentile")),
       aes(x=StartFY,y=pCRai,color=Quantile))+
  geom_line(aes(linetype=metric))+
  geom_point(aes(shape=Quantile))+
  geom_text(data=CRaiSDurCeilLabels,
              aes(x=2007,y=Ypos,label=FacetValue),
              # parse=TRUE,
              hjust=0,
              vjust=1,
              color="black")+
  facet_grid(Dur.Simple~Ceil.Big)+
               scale_y_continuous("Cost-Ceiling-Raising Change Orders Percent (Current $ Value)",
                                  labels=percent)+
  scale_x_continuous("Contract Starting Fiscal Year")+
  scale_linetype_discrete("Early Results")+
  theme(legend.position="bottom") #, position=pd

CRaiOutput
ggsave("../output/CRaiOutput.png",
       CRaiOutput,
       width=8,
       height=7,
       dpi=600)

write.csv(CRaiOutput$data,# %>%
            # spread(key=Fiscal.Year, value=amount_OMB19_19),
          file="../output/CRaiOutput.csv",row.names = FALSE)



ggplot(subset(df.QCrai.SDur,
                # !Quantile %in% c("99th Percentile")
                !Ceil.Big %in% c("15k - <100k","0 - <15k")
              ),
       aes(x=StartFY,
           y=pCRai,
           color=Quantile))+
  geom_line(aes(linetype=metric))+
  facet_grid(Ceil.Big~Dur.Simple,
             scales="free_y",
             space="free_y")+
  scale_y_continuous(labels=percent)

#Test to see which percentiles register at all.
df.ecdf<-ddply(def_all,
      .(Ceil.Big,
               Dur.Simple),
      summarise, 
      r001 = ecdf(p_CBre)(0.001),
      r01 = ecdf(p_CBre)(0.01),
      r05 = ecdf(p_CBre)(0.01)
)

# df.ecdf<-subset(df.ecdf,StartFY>=2007&StartFY<=2014)


CRaiSDurCeilFYearSummary<-ddply(
  subset(df.QCrai.SDur,Quantile=="50th Percentile" &
           metric=="Contracts within Period"),
    .(Dur.Simple,Ceil.Big,StartFY),
    plyr::summarise,
    FacetCount=paste("Count:",prettyNum(sum(ContractCount),big.mark=",")),
    FacetValue=paste(FacetCount,"\nObligated: $",round(sum(Action_Obligation_OMB23_GDP21)/1000000000,1),"B",sep="")
    )

DurBoundary<-subset(def_all,Ceil=="75m+"&
         qDuration=="(~2 years+]"&
         StartFY==2013&
         UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")
         )

```
## Dur.Simple / Ceiling.Simple
```{r QuantileSimpleDurSimpleCeil, fig.width=9,fig.height=9, dpi=600}
df.QCrai.SDur<-only_complete(def_all) %>%
      group_by(StartFY,
               Ceil.Simple,
               Dur.Simple) %>%
      dplyr::summarise(
      X50 = quantile(p_CBre, probs = 0.5,na.rm=TRUE),
      X75 = quantile(p_CBre, probs = 0.75,na.rm=TRUE), 
      X80 = quantile(p_CBre, probs = 0.80,na.rm=TRUE), 
      X90 = quantile(p_CBre, probs = 0.90,na.rm=TRUE), 
      X95 = quantile(p_CBre, probs = 0.95,na.rm=TRUE),
      X99 = quantile(p_CBre, probs = 0.99,na.rm=TRUE),
      ContractCount=length(CSIScontractID),
             Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
      metric="Contracts within Period")



df.QCrai.SDur<-rbind(df.QCrai.SDur,
                all_labeled(def_all)%>%
      group_by(StartFY,
               Ceil.Simple,
               Dur.Simple)%>%
      dplyr::summarise( 
      X50 = quantile(p_CBre, probs = 0.5,na.rm=TRUE),
      X75 = quantile(p_CBre, probs = 0.75,na.rm=TRUE), 
      X80 = quantile(p_CBre, probs = 0.80,na.rm=TRUE), 
      X90 = quantile(p_CBre, probs = 0.90,na.rm=TRUE), 
      X95 = quantile(p_CBre, probs = 0.95,na.rm=TRUE),
      X99 = quantile(p_CBre, probs = 0.99,na.rm=TRUE),
      ContractCount=length(CSIScontractID),
             Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
      metric="Early Results for All Contracts")
)
write.csv(df.QCrai.SDur,"df.QCrai.SDur.csv")

df.QCrai.SDur<-melt(df.QCrai.SDur,
                      variable.name="Quantile",value.name="pCRai",measure.vars=c(
  "X50",
  "X75",
  "X80",
  "X90",
  "X95",
  "X99")
)


df.QCrai.SDur$Quantile<-factor(df.QCrai.SDur$Quantile,
  levels=c("X50",
  "X75",
  "X80",
  "X90",
  "X95",
  "X99"),
  labels=c("50th Percentile",
  "75th Percentile",
  "80th Percentile",
  "90th Percentile",
  "95th Percentile",
  "99th Percentile")
)

CRaiSDurCeilLabels<-ddply(
  subset(df.QCrai.SDur,Quantile=="50th Percentile" &
           metric=="Contracts within Period"),
    .(Dur.Simple,Ceil.Simple),
    plyr::summarise,
    FacetCount=paste("Count:",prettyNum(sum(ContractCount),big.mark=",")),
    FacetValue=paste(FacetCount,"\nObligated: $",round(sum(Action_Obligation_OMB23_GDP21)/1000000000,1),"B",sep="")
    )

Ypos<-max(subset(df.QCrai.SDur,
                   !Quantile %in% c("99th Percentile")
                 )$pCRai,na.rm=TRUE)


CRaiOutput<-ggplot(subset(df.QCrai.SDur,
                !Quantile %in% c("99th Percentile",
                                 "75th Percentile")),
       aes(x=StartFY,y=pCRai,color=Quantile))+
  geom_line(aes(linetype=metric))+
  geom_point(aes(shape=Quantile))+
  geom_text(data=CRaiSDurCeilLabels,
              aes(x=2007,y=Ypos,label=FacetValue),
              # parse=TRUE,
              hjust=0,
              vjust=1,
              color="black")+
  facet_grid(Dur.Simple~Ceil.Simple)+
               scale_y_continuous("Cost-Ceiling-Raising Change Orders Percent (Current $ Value)",
                                  labels=percent)+
  scale_x_continuous("Contract Starting Fiscal Year")+
  scale_linetype_discrete("Early Results")+
  theme(legend.position="bottom") #, position=pd

CRaiOutput
ggsave("CRaiOutput.png",
       CRaiOutput,
       width=8,
       height=7,
       dpi=600)

ggplot(subset(df.QCrai.SDur,
                # !Quantile %in% c("99th Percentile")
                !Ceil.Simple %in% c("15k - <100k","0 - <15k")
              ),
       aes(x=StartFY,
           y=pCRai,
           color=Quantile))+
  geom_line(aes(linetype=metric))+
  facet_grid(Ceil.Simple~Dur.Simple,
             scales="free_y",
             space="free_y")+
  scale_y_continuous(labels=percent)

#Test to see which percentiles register at all.
df.ecdf<-ddply(def_all,
      .(Ceil.Simple,
               Dur.Simple),
      summarise, 
      r001 = ecdf(p_CBre)(0.001),
      r01 = ecdf(p_CBre)(0.01),
      r05 = ecdf(p_CBre)(0.01)
)

# df.ecdf<-subset(df.ecdf,StartFY>=2007&StartFY<=2014)


CRaiSDurCeilFYearSummary<-ddply(
  subset(df.QCrai.SDur,Quantile=="50th Percentile" &
           metric=="Contracts within Period"),
    .(Dur.Simple,Ceil.Simple,StartFY),
    plyr::summarise,
    FacetCount=paste("Count:",prettyNum(sum(ContractCount),big.mark=",")),
    FacetValue=paste(FacetCount,"\nObligated: $",round(sum(Action_Obligation_OMB23_GDP21)/1000000000,1),"B",sep="")
    )

DurBoundary<-subset(def_all,Ceil=="75m+"&
         qDuration=="(~2 years+]"&
         StartFY==2013&
         UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")
         )
levels(def_all$Ceil.Simple)
def_all$StartFY
summary(def_all$qCRais[def_all$Dur.Simple=="(~2 years+]" & def_all$StartFY==2015 & def_all$Ceil.Simple=="0k - <100k"])
# def_all[def_all$Dur.Simple=="(~2 years+]" & def_all$StartFY==2015 & def_all$Ceil.Simple=="0k - <100k"]
write.csv(def_all[def_all$Dur.Simple=="(~2 years+]" & def_all$StartFY==2015 & def_all$Ceil.Simple=="0k - <100k",],"cbre_weird.csv")

```
## Dur.Simple / Ceiling.1m
```{r QuantileSimpleDurCeil.1m, fig.width=9,fig.height=9, dpi=600}
df.QCrai.SDur<-only_complete(def_all) %>%
      group_by(StartFY,
               Ceil.1m,
               Dur.Simple) %>%
      dplyr::summarise(
      X50 = quantile(p_CBre, probs = 0.5,na.rm=TRUE),
      X75 = quantile(p_CBre, probs = 0.75,na.rm=TRUE), 
      X80 = quantile(p_CBre, probs = 0.80,na.rm=TRUE), 
      X90 = quantile(p_CBre, probs = 0.90,na.rm=TRUE), 
      X95 = quantile(p_CBre, probs = 0.95,na.rm=TRUE),
      X99 = quantile(p_CBre, probs = 0.99,na.rm=TRUE),
      ContractCount=length(CSIScontractID),
             Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
      metric="Contracts within Period")



df.QCrai.SDur<-rbind(df.QCrai.SDur,
                all_labeled(def_all)%>%
      group_by(StartFY,
               Ceil.1m,
               Dur.Simple)%>%
      dplyr::summarise( 
      X50 = quantile(p_CBre, probs = 0.5,na.rm=TRUE),
      X75 = quantile(p_CBre, probs = 0.75,na.rm=TRUE), 
      X80 = quantile(p_CBre, probs = 0.80,na.rm=TRUE), 
      X90 = quantile(p_CBre, probs = 0.90,na.rm=TRUE), 
      X95 = quantile(p_CBre, probs = 0.95,na.rm=TRUE),
      X99 = quantile(p_CBre, probs = 0.99,na.rm=TRUE),
      ContractCount=length(CSIScontractID),
             Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21),
      metric="Early Results for All Contracts")
)


df.QCrai.SDur<-melt(df.QCrai.SDur,
                      variable.name="Quantile",value.name="pCRai",measure.vars=c(
  "X50",
  "X75",
  "X80",
  "X90",
  "X95",
  "X99")
)

df.QCrai.SDur$Quantile<-factor(df.QCrai.SDur$Quantile,
  levels=c("X50",
  "X75",
  "X80",
  "X90",
  "X95",
  "X99"),
  labels=c("50th Percentile",
  "75th Percentile",
  "80th Percentile",
  "90th Percentile",
  "95th Percentile",
  "99th Percentile")
)

CRaiSDurCeilLabels<-ddply(
  subset(df.QCrai.SDur,Quantile=="50th Percentile" &
           metric=="Contracts within Period"),
    .(Dur.Simple,Ceil.1m),
    plyr::summarise,
    FacetCount=paste("Count:",prettyNum(sum(ContractCount),big.mark=",")),
    FacetValue=paste(FacetCount,"\nObligated: $",round(sum(Action_Obligation_OMB23_GDP21)/1000000000,1),"B",sep="")
    )

Ypos<-max(subset(df.QCrai.SDur,
                   !Quantile %in% c("99th Percentile")
                 )$pCRai,na.rm=TRUE)


CRaiOutput<-ggplot(subset(df.QCrai.SDur,
                !Quantile %in% c("99th Percentile",
                                 "75th Percentile")),
       aes(x=StartFY,y=pCRai,color=Quantile))+
  geom_line(aes(linetype=metric))+
  geom_point(aes(shape=Quantile))+
  geom_text(data=CRaiSDurCeilLabels,
              aes(x=2007,y=Ypos,label=FacetValue),
              # parse=TRUE,
              hjust=0,
              vjust=1,
              color="black")+
  facet_grid(Dur.Simple~Ceil.1m)+
               scale_y_continuous("Cost-Ceiling-Raising Change Orders Percent (Current $ Value)",
                                  labels=percent)+
  scale_x_continuous("Contract Starting Fiscal Year")+
  scale_linetype_discrete("Early Results")+
  theme(legend.position="bottom") #, position=pd

CRaiOutput
ggsave("CRaiOutput.png",
       CRaiOutput,
       width=8,
       height=7,
       dpi=600)

ggplot(subset(df.QCrai.SDur,
                # !Quantile %in% c("99th Percentile")
                !Ceil.1m %in% c("15k - <100k","0 - <15k")
              ),
       aes(x=StartFY,
           y=pCRai,
           color=Quantile))+
  geom_line(aes(linetype=metric))+
  facet_grid(Ceil.1m~Dur.Simple,
             scales="free_y",
             space="free_y")+
  scale_y_continuous(labels=percent)

#Test to see which percentiles register at all.
df.ecdf<-ddply(def_all,
      .(Ceil.1m,
               Dur.Simple),
      summarise, 
      r001 = ecdf(p_CBre)(0.001),
      r01 = ecdf(p_CBre)(0.01),
      r05 = ecdf(p_CBre)(0.01)
)

# df.ecdf<-subset(df.ecdf,StartFY>=2007&StartFY<=2014)


CRaiSDurCeilFYearSummary<-ddply(
  subset(df.QCrai.SDur,Quantile=="50th Percentile" &
           metric=="Contracts within Period"),
    .(Dur.Simple,Ceil.1m,StartFY),
    plyr::summarise,
    FacetCount=paste("Count:",prettyNum(sum(ContractCount),big.mark=",")),
    FacetValue=paste(FacetCount,"\nObligated: $",round(sum(Action_Obligation_OMB23_GDP21)/1000000000,1),"B",sep="")
    )

DurBoundary<-subset(def_all,Ceil=="75m+"&
         qDuration=="(~2 years+]"&
         StartFY==2013&
         UnmodifiedCurrentCompletionDate<as.Date("2015-09-30")
         )

# View(subset(def_all,Ceil.Big=="75m+" & Dur.Simple=="(~2 years+]" & StartFY==2014))

# write.csv(subset(def_all,Ceil.Big=="75m+" & Dur.Simple=="(~2 years+]" & StartFY==2014),"Long2014.csv")
```


# Time

## Start Year Dur Prep
```{r}
library(tidyr)
library(dplyr)
library(ggplot2)
library(csis360)
if(!exists("def_all")) load(file="../data/clean/defense_contract_all_detail.RData")
# debug(transform_contract)
# undebug(transform_contract)

if(!"Action_Obligation_OMB23_GDP21" %in% colnames(def_all))
  def_all<-deflate(def_all,
                   money_var = "Action_Obligation",
                   # deflator_var="OMB.2019",
                   fy_var="StartFiscal_Year"
  )

# Contract.SP_ContractTerminationExamination.txt
# 
# def_all<-csis360::read_and_join_experiment(data=def_all,
#                                              lookup_file="Defense_Contract.SP_ContractSampleCriteriaDetailsCustomer.txt",
#                                             path="",
#                                             dir="..\\data\\semi_clean\\",
#                                             by="CSIScontractID",
#                                             new_var_checked=FALSE,
#                                              add_var="MaxBoostDate"
# )

```

```{r }

def_dur<-def_all %>%
  # dplyr::filter(#StartFiscal_Year>=2007 &
                # LastCurrentCompletionDate<as.Date("2017-10-01")) %>%
  dplyr::group_by(IsTerminated,
                      IsClosed,
                      IsComplete,
                      # pChangeOrderUnmodifiedBaseAndAll,
                      # n_CBre,
                      UnmodifiedDays,
                      # qHighCeiling,
                      # qLowCeiling,
                      # UnmodifiedCeiling,
                      StartFiscal_Year,
                      LastCurrentCompletionDate,
                MinOfSignedDate,
                qDuration,
                      # UnmodifiedCurrentCompletionDate,
                      # CBre,
                      # SumOfisChangeOrder
                      ) %>%
  dplyr::summarise(Action_Obligation_OMB23_GDP21=sum(Action_Obligation_OMB23_GDP21,na.rm=TRUE),
            kcount=length(CSIScontractID))


#Last CurrentCompletion Yer
def_dur$LastCurrentCompletionYear<-get_fiscal_year(def_dur$LastCurrentCompletionDate)

#Oh we're missing MaxBoostDate
def_dur$LastCurrentCompletionYear[(def_dur$IsComplete==1 & !is.na(def_dur$IsComplete) &
                                    def_dur$LastCurrentCompletionYear>2018) |
                                  def_dur$LastCurrentCompletionYear<def_dur$StartFiscal_Year]<-"Unlabeled"

def_dur$LastCurrentCompletionYear[def_dur$IsComplete==0 | is.na(def_dur$IsComplete)]<-"Active in 2018"

def_dur$LastCurrentCompletionYear<-factor(def_dur$LastCurrentCompletionYear,
                                          levels=c("Unlabeled","Active in 2018",2017:2007))


def_dur<-replace_nas_with_unlabeled(def_dur,"LastCurrentCompletionYear")

def_dur<-replace_nas_with_unlabeled(def_dur,"qDuration")

#Estimated End Date



#Actual Duration
if (!"ActualDays" %in% colnames(def_dur)){
  def_dur$ActualDays<-as.numeric(
    difftime(strptime(def_dur$LastCurrentCompletionDate,"%Y-%m-%d")
             , strptime(def_dur$MinOfSignedDate,"%Y-%m-%d")
             , unit="days"
    ))+1
}
def_dur$ActualDays[def_dur$ActualDays<1]<-NA



if (!"ActualDur" %in% colnames(def_dur)){
  def_dur$ActualDur<-Hmisc::cut2(def_dur$ActualDays,cuts=c(61,214,366,732))
}



levels(def_dur$ActualDur)<-gsub(" ","",levels(def_dur$ActualDur))
if (levels(def_dur$ActualDur)[[2]] %in% c("[61,214)")){
  levels(def_dur$ActualDur)<- list(
    "[0 months,~2 months)"=c("[1,61)","[0,61)"),
    "[~2 months,~7 months)"=c("[61,214)"),
    "[~7 months-~1 year]"=c("[214,366)"),
    "(~1 year,~2 years]"=c("[366,732)","[366,732)"),
    "(~2 years+]"=levels(def_dur$ActualDur)[5],
    "Active in 2018"="Active in 2018")
}
def_dur$ActualDur<-as.character(def_dur$ActualDur)






#Longer dur
def_dur$ActualYears<-ceiling(lubridate::time_length(difftime(strptime(def_dur$LastCurrentCompletionDate,"%Y-%m-%d"),
                                           strptime(def_dur$MinOfSignedDate,"%Y-%m-%d")),"years"))

year_plus<-def_dur$ActualYears>1&!is.na(def_dur$ActualYears)
def_dur$ActualDur[year_plus]<-
  paste("(~",def_dur$ActualYears[year_plus]-1,
        " year,~",def_dur$ActualYears[year_plus]," years]",sep="")
  
#Cleanup



def_dur$ActualDur[def_dur$IsComplete==0 | is.na(def_dur$IsComplete)]<-"Active in 2018"


def_dur$ActualDur[(def_dur$IsComplete==1 & !is.na(def_dur$IsComplete) &
                                    def_dur$LastCurrentCompletionYear>2018) |
                                  def_dur$LastCurrentCompletionYear<def_dur$StartFiscal_Year]<-"Unlabeled"

# def_dur$ActualDur<-factor(def_dur$ActualDur,c(
#   "Active in 2018",
#     "(~2 years+]",
#     "(~1 year,~2 years]",
#     "[~7 months-~1 year]",
#     "[~2 months,~7 months)",
#   "[0 months,~2 months)"
#     ))
  
  
def_dur<-replace_nas_with_unlabeled(def_dur,"ActualDur")

def_dur$ActualDur<-droplevels(def_dur$ActualDur)

def_dur %>% group_by(ActualDur,IsComplete) %>%
  summarise(MinActualDays=min(ActualDays,na.rm=TRUE),
            MaxActualDays=max(ActualDays,na.rm=TRUE),
            MinLastYear=min(LastCurrentCompletionYear),
            MaxLastYear=max(LastCurrentCompletionYear),
            kcount=sum(kcount))


dur_labels_and_colors<-prepare_labels_and_colors(def_dur)
dur_column_key<-get_column_key(def_dur)


```

### Duration trends
```{r Dur}

```

### Colored by End Year
```{r StackedLastYear}
def_dur %>% group_by(IsComplete,StartFiscal_Year,LastCurrentCompletionYear) %>%
  dplyr::summarise(Action_Obligation=sum(Action_Obligation_OMB23_GDP21,na.rm=TRUE)) %>%
  ggplot(aes(fill=factor(LastCurrentCompletionYear),x=StartFiscal_Year,y=Action_Obligation))+
  geom_col()#+facet_wrap(IsComplete~.,ncol=1)



summary(def_dur$IsComplete)
summary(def_dur$StartFiscal_Year)
summary(def_dur$Action_Obligation_OMB23_GDP21)

```

### Actual Duration
```{r StackedDur}
# undebug(build_plot)
(staked_duration_share <-  build_plot(data=def_dur,# %>% filter(Fiscal.Year>=2007&
                                                                    # !is.na(FirstYear)&
                                                                    # !is.na(qDuration)),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="StartFiscal_Year",
                            y_var="Action_Obligation_OMB23_GDP21",
                            color_var="ActualDur",
                            # facet_var="FirstYear",
                            # second_var="dtDelivYear_fac",
                            labels_and_colors=dur_labels_and_colors,
                            column_key=dur_column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    #facet_grid(Source ~ dtDelivYear_fac, scales="free_y")+ scale_x_continuous("Corruption Perceptions Index Score", c(0, 25, 50, 75, 100)) + 
  labs(#x="Corruption Perceptions Index Score",
       #y="Delivery Value (Metric Varies by Source)"),
    caption="Contracts that started before 2000 or with unlabeled durations are not shown. Source: FPDS; CSIS Analysis")
)+theme(legend.position = "right")


```



#### Initial vs. Actual
```{r StackedLastYear}

(staked_duration_share <-  build_plot(data=def_dur,# %>% filter(Fiscal.Year>=2007&
                                                                    # !is.na(FirstYear)&
                                                                    # !is.na(qDuration)),
                            chart_geom="Bar Chart",
                            share=FALSE,
                            x_var="StartFiscal_Year",
                            y_var="Action_Obligation_OMB23_GDP21",
                            color_var="ActualDur",
                            facet_var="qDuration",
                            # second_var="dtDelivYear_fac",
                            labels_and_colors=dur_labels_and_colors,
                            column_key=dur_column_key,
                            legend=TRUE,
                            caption=FALSE,
                        format=TRUE)+
    #facet_grid(Source ~ dtDelivYear_fac, scales="free_y")+ scale_x_continuous("Corruption Perceptions Index Score", c(0, 25, 50, 75, 100)) + 
  labs(#x="Corruption Perceptions Index Score",
       #y="Delivery Value (Metric Varies by Source)"),
    caption="Contracts that started before 2000 or with unlabeled durations are not shown. Source: FPDS; CSIS Analysis")
)

```

### Gradiant
```{r DurGradiant}
(gradiant_duration<-ggplot(def_dur %>%
                              dplyr::filter(Fiscal.Year>=2007 &
                                              !is.na(UnmodifiedDays)&
                                              !is.na(FirstYear)) %>%  
         group_by(Fiscal.Year,FirstYear,capped_UnmodifiedDays) %>% #,StateRegionSwr,Source
         dplyr::summarise(obligatedamount_OMB20_GDP18=sum(obligatedamount_OMB20_GDP18))%>%
           group_by(Fiscal.Year,FirstYear) %>% mutate(pObligatedamount=obligatedamount_OMB20_GDP18/
                                              sum(obligatedamount_OMB20_GDP18,na.rm=TRUE)),
       aes(x=Fiscal.Year,y=obligatedamount_OMB20_GDP18, fill=capped_UnmodifiedDays))+
  geom_col()+#facet_grid(Source~StateRegionSwr)+
   scale_fill_gradient2(trans = "log",low = muted("blue"), 
                        mid = "yellow",
                        high = muted("red"), midpoint = log(365))+scale_y_reverse()+
    facet_grid(FirstYear ~.)
)

(gradiant_duration_share<-ggplot(def_dur %>%
                              dplyr::filter(Fiscal.Year>=2007 &
                                              !is.na(UnmodifiedDays)&
                                              !is.na(FirstYear)) %>%  
         group_by(Fiscal.Year,FirstYear,capped_UnmodifiedDays) %>% #,StateRegionSwr,Source
         dplyr::summarise(obligatedamount_OMB20_GDP18=sum(obligatedamount_OMB20_GDP18))%>%
           group_by(Fiscal.Year,FirstYear) %>% mutate(pObligatedamount=obligatedamount_OMB20_GDP18/
                                              sum(obligatedamount_OMB20_GDP18,na.rm=TRUE)),
       aes(x=Fiscal.Year,y=pObligatedamount, fill=capped_UnmodifiedDays))+
  geom_col()+#facet_grid(Source~StateRegionSwr)+
   scale_fill_gradient2(trans = "log",low = muted("blue"), 
                        mid = "yellow",
                        high = muted("red"), midpoint = log(365))+scale_y_reverse()+
    facet_grid(FirstYear ~.)
)
```



## PALT
```{r Palt}

load(file=file.path("..","data","semi_clean","def_palt_veh.rda"))


summary(def_palt$qLowCeiling)
  
  
  if (gsub(" ","",levels(def_palt$qLowCeiling)[[2]]) =="[1.5e+04,1.0e+05)"&
      gsub(" ","",levels(def_palt$qLowCeiling)[[3]]) =="[1.0e+05,1.0e+06)"&
      gsub(" ","",levels(def_palt$qLowCeiling)[[4]]) =="[1.0e+06,3.0e+07)"){
    def_palt$qLowCeiling<-factor(def_palt$qLowCeiling, 
                                 
                                 levels=levels(def_palt$qLowCeiling),
                                 labels=c("[0,15k)",
                                          "[15k,100k)",
                                          "[100k,1m)",
                                          "[1m,30m)",
                                          "[30m+]"),
                                 ordered=TRUE
    )
  }

def_palt$Veh.SIDC<-ifelse(def_palt$Veh=="SINGLE AWARD IDC"|
                                            (is.na(def_palt$Veh)&def_palt$IsIDV=="IDV"),
                      "Single Award or Unlabeled Task Order",
                      "All Other Awards and Task Orders")
summary(factor(def_palt$Veh.SIDC))


def_palt_stat<-def_palt %>% group_by(qLowCeiling,StartFiscal_Year,Veh.SIDC) %>%
  dplyr::summarise(Median=median(PALT,na.rm=TRUE),
            Mean=mean(PALT,na.rm=TRUE))%>% pivot_longer(cols=c(Mean,Median),names_to="Statistic")
                
def_palt$Count<-1
  
  PaltCeilLabels<-
      def_palt %>%
      group_by(qLowCeiling,StartFiscal_Year,Veh.SIDC) %>%
      dplyr::summarise(
      FacetCount=paste("#:",prettyNum(sum(Count),big.mark=",")),
      FacetValue=paste("Obl.: $",round(sum(Action_Obligation)/1000000000,1),"B",sep=""),
      FacetMedian=paste(FacetValue,"\nMed.: ",round(median(PALT,na.rm=TRUE),1),
                        ifelse(round(median(PALT,na.rm=TRUE),1)==1," Day"," Days"),sep=""),
      FacetMean=paste(FacetMedian,"\nAvg.: ",round(mean(PALT,na.rm=TRUE),1),
                        ifelse(round(mean(PALT,na.rm=TRUE),1)==1," Day"," Days"),sep=""),
      YPos=max(hist(log10(PALT), breaks=25, plot=FALSE)$counts)
      ) %>% group_by(qLowCeiling,Veh.SIDC)%>%
    dplyr::mutate(YPos=max(YPos)
           )


# (counthigh<-ggplot(def_palt, aes(x=PALT))+geom_histogram()+scale_x_log10()+facet_wrap(~qHighCeiling,scales="free_y"))
# (countlow<-ggplot(def_palt, aes(x=PALT))+geom_histogram()+scale_x_log10()+facet_wrap(~qLowCeiling,scales="free_y"))
# 
# (countlow<-ggplot(def_palt, aes(x=PALT))+geom_histogram()+scale_x_log10()+facet_grid(qLowCeiling~Veh,scales="free_y"))
# dollar<-ggplot(def_palt, aes(x=PALT,y=Action_Obligation))+geom_point()+scale_x_log10()+scale_y_log10()
# # dollar<-ggplot(def_palt, aes(x=PALT,y=Action_Obligation))+geom_histogram()+scale_x_log10()

(countlowSIDV<-ggplot(def_palt %>% dplyr::filter(Veh.SIDC=="Single Award or Unlabeled Task Order"& StartFiscal_Year>=2019),
                      aes(x=PALT))+geom_histogram()+
    geom_vline(data=def_palt_stat%>% dplyr::filter(Veh.SIDC=="Single Award or Unlabeled Task Order"& 
                                                StartFiscal_Year>=2019),
               aes(xintercept=value, color=Statistic))+
  
    geom_text(data=PaltCeilLabels %>% dplyr::filter(Veh.SIDC=="Single Award or Unlabeled Task Order"& 
                                               StartFiscal_Year>=2019),
              aes(x=400,y=YPos, label=FacetMean),#,y=Ypos),
              # parse=TRUE,
              hjust=0,
              vjust=1,
              color="black",
              size=3)+
    scale_x_log10()+facet_grid(qLowCeiling~StartFiscal_Year,scales="free_y")+labs(
      y="Number of Awards and Task Orders (Variable Scale)", x="Procurement Award Lead Time in Days\n(Logarithmic Scale)"
    ))
ggsave600dpi(width=13, height=6, size=11, lineheight=1.2,file=file.path("..","output","PALT_slide_SIDV.png"),
             countlowSIDV)
ggsave600dpi(width=6.5, height=6, size=11, lineheight=1.2,file=file.path("..","output","PALT_SIDV.png"),
             countlowSIDV)


ggsave600dpi(width=6.5, height=6, size=11, lineheight=1.2, file=file.path("..","output","PALT_SIDV.emf"),
             countlowSIDV)

(countlowOther<-ggplot(def_palt %>% filter(Veh.SIDC=="All Other Awards and Task Orders"& StartFiscal_Year>=2019),
                       aes(x=PALT))+geom_histogram()+
    geom_vline(data=def_palt_stat%>% filter(Veh.SIDC=="All Other Awards and Task Orders"& StartFiscal_Year>=2019),
               aes(xintercept=value, color=Statistic))+
    geom_text(data=PaltCeilLabels %>% filter(Veh.SIDC=="All Other Awards and Task Orders"& StartFiscal_Year>=2019),
              aes(x=400,y=YPos, label=FacetMean),#,y=Ypos),
              # parse=TRUE,
              hjust=0,
              vjust=1,
              color="black",
              size=3)+
    scale_x_log10()+facet_grid(qLowCeiling~StartFiscal_Year,scales="free_y")+labs(
      y="Number of Awards and Task Orders (Variable Scale)", x="Procurement Award Lead Time in Days\n(Logarithmic Scale)"
    ))

ggsave600dpi(width=13, height=6, size=11, lineheight=1.2,file=file.path("..","output","PALT_other_slide.png"),
             countlowOther)
ggsave600dpi(width=6.5, height=6, size=11, lineheight=1.2,file=file.path("..","output","PALT_other.png"),
             countlowOther)
ggsave600dpi(width=6.5, height=6, size=11, lineheight=1.2, file=file.path("..","output","PALT_other.emf"),
             countlowOther)



write.csv(
  PaltCeilLabels %>% group_by(qLowCeiling,StartFiscal_Year,Veh.SIDC) %>%
    filter(StartFiscal_Year>=2018) %>%
    pivot_wider(id_cols=c(Veh.SIDC,qLowCeiling),
                        names_from=c(StartFiscal_Year),values_from=FacetMean) %>%
    arrange(Veh.SIDC,qLowCeiling),row.names = FALSE, na = "",
  file=file.path("..","output","PALT.csv")
)



    #https://stackoverflow.com/questions/14584093/ggplot2-find-number-of-counts-in-histogram-maximum

#   geom_vline(data=pChgCeilAverage,aes(xintercept=mean),color="red")

# 
# palt_hist<-build_plot(
#   data=def_palt,
#   chart_geom = "Histogram",
#   share = FALSE,
#   x_var="PALT",
#   # y_var="hh_index", #Name of variable to plot on y-axis
#   # color_var="PlatformPortfolio",       # name of coloration variable, as string
#   facet_var="MinOfSolicitation_Date",        # name of facet variable, as string
#   legend=FALSE, #Include a legend
#   caption=FALSE, #Include a source caption
#   # labels_and_colors=labels_and_colors,
#   # column_key=NULL
# )
```


## DTRA PALT
```{r Palt}
summary(factor(def_palt$ContractingOfficeAgencyID))

DTRA_palt<-def_palt %>% filter(UnmodifiedContractingOfficeAgencyID=="9761")


DTRA_palt_stat<-DTRA_palt %>% group_by(qLowCeiling,StartFiscal_Year) %>%
  dplyr::summarise(Median=median(PALT,na.rm=TRUE),
            Mean=mean(PALT,na.rm=TRUE))%>% pivot_longer(cols=c(Mean,Median),names_to="Statistic")
                
DTRA_palt$Count<-1
  
  PaltCeilLabels<-
      DTRA_palt %>%
      group_by(qLowCeiling,StartFiscal_Year) %>%
      dplyr::summarise(
      FacetCount=paste("#:",prettyNum(sum(Count),big.mark=",")),
      FacetValue=paste("Obl.: $",round(sum(Action_Obligation)/1000000000,1),"B",sep=""),
      FacetMedian=paste(FacetValue,"\nMed.: ",round(median(PALT,na.rm=TRUE),1),
                        ifelse(round(median(PALT,na.rm=TRUE),1)==1," Day"," Days"),sep=""),
      FacetMean=paste(FacetMedian,"\nAvg.: ",round(mean(PALT,na.rm=TRUE),1),
                        ifelse(round(mean(PALT,na.rm=TRUE),1)==1," Day"," Days"),sep=""),
      YPos=5#max(hist(log10(ifelse(nrow(PALT)==0,1,PALT)), breaks=25, plot=FALSE)$counts)
      #) %>% group_by(qLowCeiling,Veh.SIDC)%>%
    # dplyr::mutate(YPos=max(YPos)
           )


# (counthigh<-ggplot(DTRA_palt, aes(x=PALT))+geom_histogram()+scale_x_log10()+facet_wrap(~qHighCeiling,scales="free_y"))
# (countlow<-ggplot(DTRA_palt, aes(x=PALT))+geom_histogram()+scale_x_log10()+facet_wrap(~qLowCeiling,scales="free_y"))
# 
# (countlow<-ggplot(DTRA_palt, aes(x=PALT))+geom_histogram()+scale_x_log10()+facet_grid(qLowCeiling~Veh,scales="free_y"))
# dollar<-ggplot(DTRA_palt, aes(x=PALT,y=Action_Obligation))+geom_point()+scale_x_log10()+scale_y_log10()
# # dollar<-ggplot(DTRA_palt, aes(x=PALT,y=Action_Obligation))+geom_histogram()+scale_x_log10()

(countlow<-ggplot(DTRA_palt %>% filter( StartFiscal_Year>=2019),
                      aes(x=PALT))+geom_histogram()+
    geom_vline(data=DTRA_palt_stat%>% filter(StartFiscal_Year>=2019),
               aes(xintercept=value, color=Statistic))+

    # geom_text(data=PaltCeilLabels %>% filter(StartFiscal_Year>=2019),
    # aes(x=400,y=YPos, label=FacetMean),#,y=Ypos),
    # parse=TRUE,
    # hjust=0,
    # vjust=1,
    # color="black",
    # size=0.9)+
    scale_x_log10()+facet_grid(qLowCeiling~StartFiscal_Year,scales="free_y")+labs(
      y="Number of Awards and Task Orders (Variable Scale)", x="Procurement Award Lead Time in Days\n(Logarithmic Scale)"
    ))

ggsave600dpi(width=6.5, height=6, size=11, lineheight=1.2,file=file.path("..","output","DTRA_PALT.png"),
             countlow)
ggsave600dpi(width=6.5, height=6, size=11, lineheight=1.2, file=file.path("..","output","DTRA_PALT.emf"),
             countlow)

write.csv(
  PaltCeilLabels %>% group_by(qLowCeiling,StartFiscal_Year) %>%
    filter(StartFiscal_Year>=2018) %>%
    pivot_wider(id_cols=c(qLowCeiling),
                        names_from=c(StartFiscal_Year),values_from=FacetMean) %>%
    arrange(qLowCeiling),row.names = FALSE, na = "",
  file=file.path("..","output","PALT.csv")
)



    #https://stackoverflow.com/questions/14584093/ggplot2-find-number-of-counts-in-histogram-maximum

#   geom_vline(data=pChgCeilAverage,aes(xintercept=mean),color="red")

# 
# palt_hist<-build_plot(
#   data=DTRA_palt,
#   chart_geom = "Histogram",
#   share = FALSE,
#   x_var="PALT",
#   # y_var="hh_index", #Name of variable to plot on y-axis
#   # color_var="PlatformPortfolio",       # name of coloration variable, as string
#   facet_var="MinOfSolicitation_Date",        # name of facet variable, as string
#   legend=FALSE, #Include a legend
#   caption=FALSE, #Include a source caption
#   # labels_and_colors=labels_and_colors,
#   # column_key=NULL
# )
```



## DTRA PALT no ceil
```{r Palt}
summary(factor(def_palt$ContractingOfficeAgencyID))

DTRA_palt<-def_palt %>% filter(UnmodifiedContractingOfficeAgencyID=="9761")


DTRA_palt_stat<-DTRA_palt %>% group_by(StartFiscal_Year) %>%
  dplyr::summarise(Median=median(PALT,na.rm=TRUE),
            Mean=mean(PALT,na.rm=TRUE))%>% pivot_longer(cols=c(Mean,Median),names_to="Statistic")
                
DTRA_palt$Count<-1
  
  PaltCeilLabels<-
      DTRA_palt %>%
      group_by(StartFiscal_Year) %>%
      dplyr::summarise(
      FacetCount=paste("#:",prettyNum(sum(Count),big.mark=",")),
      FacetValue=paste("Obl.: $",round(sum(Action_Obligation)/1000000000,1),"B",sep=""),
      FacetMedian=paste(FacetValue,"\nMed.: ",round(median(PALT,na.rm=TRUE),1),
                        ifelse(round(median(PALT,na.rm=TRUE),1)==1," Day"," Days"),sep=""),
      FacetMean=paste(FacetMedian,"\nAvg.: ",round(mean(PALT,na.rm=TRUE),1),
                        ifelse(round(mean(PALT,na.rm=TRUE),1)==1," Day"," Days"),sep=""),
      YPos=5#max(hist(log10(ifelse(nrow(PALT)==0,1,PALT)), breaks=25, plot=FALSE)$counts)
      #) %>% group_by(qLowCeiling,Veh.SIDC)%>%
    # dplyr::mutate(YPos=max(YPos)
           )


# (counthigh<-ggplot(DTRA_palt, aes(x=PALT))+geom_histogram()+scale_x_log10()+facet_wrap(~qHighCeiling,scales="free_y"))
# (countlow<-ggplot(DTRA_palt, aes(x=PALT))+geom_histogram()+scale_x_log10()+facet_wrap(~qLowCeiling,scales="free_y"))
# 
# (countlow<-ggplot(DTRA_palt, aes(x=PALT))+geom_histogram()+scale_x_log10()+facet_grid(qLowCeiling~Veh,scales="free_y"))
# dollar<-ggplot(DTRA_palt, aes(x=PALT,y=Action_Obligation))+geom_point()+scale_x_log10()+scale_y_log10()
# # dollar<-ggplot(DTRA_palt, aes(x=PALT,y=Action_Obligation))+geom_histogram()+scale_x_log10()

(DTRA<-ggplot(DTRA_palt %>% filter( StartFiscal_Year>=2019),
                      aes(x=PALT))+geom_histogram()+
    geom_vline(data=DTRA_palt_stat%>% filter(StartFiscal_Year>=2019),
               aes(xintercept=value, color=Statistic))+

    # geom_text(data=PaltCeilLabels %>% filter(StartFiscal_Year>=2019),
    # aes(x=400,y=YPos, label=FacetMean),#,y=Ypos),
    # parse=TRUE,
    # hjust=0,
    # vjust=1,
    # color="black",
    # size=0.9)+
    scale_x_log10()+facet_grid(StartFiscal_Year~.,scales="free_y")+labs(
      y="Number of Awards and Task Orders", x="Procurement Award\n Lead Time in Days\n(Logarithmic Scale)"
    ))

ggsave600dpi(width=3, height=6, size=11, lineheight=1.2,file=file.path("..","output","DTRA_PALT.png"),
             DTRA)
ggsave600dpi(width=3, height=6, size=11, lineheight=1.2, file=file.path("..","output","DTRA_PALT.emf"),
             DTRA)

write.csv(PaltCeilLabels, file=file.path("..","output","PALT.csv"))
  PaltCeilLabels %>% group_by(qLowCeiling,StartFiscal_Year) %>%
    filter(StartFiscal_Year>=2018) %>%
    pivot_wider(names_from=c(StartFiscal_Year),values_from=FacetMean) %>%
  row.names = FALSE, na = "",
  file=file.path("..","output","PALT.csv")
)



    #https://stackoverflow.com/questions/14584093/ggplot2-find-number-of-counts-in-histogram-maximum

#   geom_vline(data=pChgCeilAverage,aes(xintercept=mean),color="red")

# 
# palt_hist<-build_plot(
#   data=DTRA_palt,
#   chart_geom = "Histogram",
#   share = FALSE,
#   x_var="PALT",
#   # y_var="hh_index", #Name of variable to plot on y-axis
#   # color_var="PlatformPortfolio",       # name of coloration variable, as string
#   facet_var="MinOfSolicitation_Date",        # name of facet variable, as string
#   legend=FALSE, #Include a legend
#   caption=FALSE, #Include a source caption
#   # labels_and_colors=labels_and_colors,
#   # column_key=NULL
# )
```